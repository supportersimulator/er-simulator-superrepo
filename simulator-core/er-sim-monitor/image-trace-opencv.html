<!DOCTYPE html>
<html>
<head>
  <title>Auto-Trace AFib from Image</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #000;
      font-family: monospace;
      color: #0f0;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    canvas {
      background: #000;
      display: block;
      margin: 20px auto;
      border: 2px solid #0f0;
    }
    .info {
      text-align: center;
      margin: 20px 0;
      font-size: 16px;
    }
    .controls {
      text-align: center;
      margin: 20px 0;
    }
    button {
      background: #0f0;
      color: #000;
      border: none;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 5px;
      margin: 5px;
    }
    button:hover {
      background: #0c0;
    }
    input[type="file"] {
      color: #0f0;
      background: #1a1a1a;
      padding: 10px;
      border: 1px solid #0f0;
      border-radius: 5px;
    }
    .output {
      background: #1a1a1a;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .method {
      background: #1a1a1a;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #0f0;
    }
    .method h3 {
      margin-top: 0;
      color: #ff0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 style="text-align: center;">ðŸŽ¯ Ultra-Accurate AFib Tracing Methods</h1>

    <div class="method">
      <h3>Method 1: Upload & Auto-Trace Image (Canvas API)</h3>
      <p>Upload your ResusMonitor screenshot and automatically extract the green waveform pixels.</p>
      <div class="controls">
        <input type="file" id="imageUpload" accept="image/*">
        <button onclick="autoTrace()">Auto-Trace Waveform</button>
      </div>
      <canvas id="sourceCanvas" width="800" height="200"></canvas>
      <canvas id="tracedCanvas" width="1200" height="200"></canvas>
      <div class="output" id="output"></div>
    </div>

    <div class="method">
      <h3>Method 2: SVG Path (Vector Perfect)</h3>
      <p>The most accurate method - use vector graphics tools to trace, then convert to code:</p>
      <ol style="color: #ccc;">
        <li>Open ResusMonitor image in <strong>Inkscape</strong> (free) or Adobe Illustrator</li>
        <li>Use "Trace Bitmap" â†’ "Centerline tracing"</li>
        <li>Gets exact SVG path data: <code>M 10 50 L 20 45 C 30 40, 40 35, 50 30...</code></li>
        <li>We convert SVG path to JavaScript coordinates</li>
      </ol>
      <button onclick="showSVGDemo()">Show SVG Path Demo</button>
      <canvas id="svgCanvas" width="1200" height="200" style="display:none;"></canvas>
    </div>

    <div class="method">
      <h3>Method 3: Manual High-Density Tracing Tool</h3>
      <p>Click precisely on the waveform every 2-5 pixels for ultra-smooth interpolation.</p>
      <button onclick="openTracingTool()">Open Interactive Tracer</button>
    </div>

    <div class="method">
      <h3>Method 4: Python + OpenCV (Most Professional)</h3>
      <p>Industrial-grade image processing for medical waveforms:</p>
      <pre style="color: #0f0; background: #000; padding: 10px; border-radius: 5px;">
import cv2
import numpy as np

# Load image
img = cv2.imread('resusmonitor_afib.png')

# Extract green channel (ECG waveform)
green = img[:,:,1]

# Threshold to isolate waveform
_, binary = cv2.threshold(green, 100, 255, cv2.THRESH_BINARY)

# Find skeleton (centerline of waveform)
skeleton = cv2.ximgproc.thinning(binary)

# Extract coordinates
coords = np.argwhere(skeleton > 0)

# Export as JSON
import json
with open('afib_traced.json', 'w') as f:
    json.dump(coords.tolist(), f)
      </pre>
    </div>
  </div>

  <script>
    let imageData = null;

    document.getElementById('imageUpload').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.getElementById('sourceCanvas');
          canvas.width = img.width;
          canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          imageData = ctx.getImageData(0, 0, img.width, img.height);
          document.getElementById('output').textContent = 'Image loaded! Click "Auto-Trace Waveform" to extract coordinates.';
        };
        img.src = event.target.result;
      };
      reader.readAsDataURL(file);
    });

    function autoTrace() {
      if (!imageData) {
        alert('Please upload an image first!');
        return;
      }

      const width = imageData.width;
      const height = imageData.height;
      const data = imageData.data;

      // Find green pixels (ECG waveform)
      const points = [];

      for (let x = 0; x < width; x++) {
        let maxGreen = 0;
        let maxY = 0;

        // For each column, find the brightest green pixel
        for (let y = 0; y < height; y++) {
          const idx = (y * width + x) * 4;
          const r = data[idx];
          const g = data[idx + 1];
          const b = data[idx + 2];

          // Check if this is a green pixel (ECG waveform)
          if (g > 150 && g > r * 1.5 && g > b * 1.5) {
            if (g > maxGreen) {
              maxGreen = g;
              maxY = y;
            }
          }
        }

        if (maxGreen > 0) {
          points.push({
            x: x / width,
            y: (height / 2 - maxY) / (height / 2)
          });
        }
      }

      // Draw traced waveform
      const canvas = document.getElementById('tracedCanvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.strokeStyle = '#0f0';
      ctx.lineWidth = 2;
      ctx.beginPath();

      points.forEach((pt, i) => {
        const x = pt.x * canvas.width;
        const y = canvas.height / 2 - pt.y * (canvas.height / 3);
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      });
      ctx.stroke();

      // Export coordinates
      let output = `// Auto-traced ${points.length} points from image\n`;
      output += `const AFIB_TRACED_COORDS = [\n`;

      // Downsample to reasonable number of points (every 5px)
      for (let i = 0; i < points.length; i += 5) {
        output += `  { x: ${points[i].x.toFixed(4)}, y: ${points[i].y.toFixed(4)} },\n`;
      }
      output += `];\n`;

      document.getElementById('output').textContent = output;
    }

    function showSVGDemo() {
      const canvas = document.getElementById('svgCanvas');
      canvas.style.display = 'block';
      const ctx = canvas.getContext('2d');

      // Example SVG path converted to canvas commands
      // This would come from Inkscape's "Trace Bitmap" feature
      ctx.strokeStyle = '#0f0';
      ctx.lineWidth = 2;

      // SVG: M 0,100 L 50,100 Q 60,50 70,20 L 80,100
      // Converted to canvas:
      ctx.beginPath();
      ctx.moveTo(0, 100);
      ctx.lineTo(50, 100);
      ctx.quadraticCurveTo(60, 50, 70, 20);
      ctx.lineTo(80, 100);
      ctx.stroke();

      alert('This shows how SVG paths create perfect smooth curves!\nUse Inkscape â†’ Trace Bitmap â†’ Centerline for best results.');
    }

    function openTracingTool() {
      window.open('/Users/aarontjomsland/er-sim-monitor/trace-afib-coordinates.html', '_blank');
    }
  </script>
</body>
</html>
