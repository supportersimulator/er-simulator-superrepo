{
  "scriptId": "1NXjFvH2Wo117saCyqmNDfCqZ1iQ9vykxa0-kHUhFAYDuhthgql5Ru_P6",
  "files": [
    {
      "name": "Code",
      "type": "SERVER_JS",
      "source": "\n\n/**\n * Safe UI helper - only calls getUi() if in UI context\n * Added for web app compatibility\n */\nfunction getSafeUi_() {\n  try {\n    return SpreadsheetApp.getUi();\n  } catch (e) {\n    return null;\n  }\n}\n\n\n/******************************************************\n * ER_Simulator_Builder.gs ‚Äî FULL UNIFIED MASTER FILE\n * v3.7 (Dark UI)\n * \n * Includes:\n *  ‚Ä¢ Batch Engine (Run All / 25 Rows / Specific Rows) with live log\n *  ‚Ä¢ Single Case Generator (2-tier aware)\n *  ‚Ä¢ ATSR Title Generator (Keep & Regenerate, deselect, memory tracker)\n *  ‚Ä¢ Case Summary Enhancer (auto-bold Dx/Intervention/Takeaway)\n *  ‚Ä¢ Image Sync Defaults Manager (refresh + editable)\n *  ‚Ä¢ Settings (API key from Script Properties or Settings sheet, model/prices, header cache)\n *  ‚Ä¢ Check API Status\n *  ‚Ä¢ Batch Reports (popup + writes to Batch_Reports sheet)\n *  ‚Ä¢ Duplicate check (content hash signature)\n *  ‚Ä¢ Inputs per row: Column A=Formal_Info, B=HTML, C=DOC, D=Extra (any may be blank)\n * \n * Safe to paste as a full replacement.\n ******************************************************/\n\n// ========== 1) ICONS, KEYS, DEFAULTS ==========\n\nconst ICONS = {\n  rocket: 'üöÄ', bolt: '‚ö°', wand: '‚ú®', frame: 'üñº', puzzle: 'üß©',\n  gear: '‚öôÔ∏è', brain: 'üß†', clipboard: 'üìã', stop: '‚èπÔ∏è', shield: 'üõ°Ô∏è'\n};\n\nconst SP_KEYS = {\n  USED_MEMORY_ANCHORS: 'used_memory_anchors',\n  API_KEY: 'OPENAI_API_KEY',\n  MODEL: 'OPENAI_MODEL',\n  PRICE_INPUT: 'PRICE_INPUT_PER_1K',\n  PRICE_OUTPUT: 'PRICE_OUTPUT_PER_1K',\n  USED_MOTIFS: 'USED_CHARACTER_MOTIFS',\n  HEADER_CACHE: 'HEADER_CACHE_JSON',\n  IMG_SYNC_DEFAULTS: 'IMG_SYNC_DEFAULTS_JSON',\n  LAST_INPUT_SHEET: 'LAST_INPUT_SHEET',\n  LAST_OUTPUT_SHEET: 'LAST_OUTPUT_SHEET'\n};\n\nconst DEFAULT_MODEL = 'gpt-4o';\nconst DEFAULT_PRICE = { input: 0.15, output: 0.60 }; // USD / 1k tokens\nconst DEFAULT_TEMP_SINGLE = 0.7;\nconst DEFAULT_TEMP_BATCH  = 0.5; // more schema-sticky\nconst MAX_TOKENS = 16000; // Premium: Allow comprehensive, detailed scenarios\n\n// Two-tier vitals fields to compactify if needed\nconst VITAL_KEYS = [\n  'Monitor_Vital_Signs:Initial_Vitals',\n  'Monitor_Vital_Signs:State1_Vitals',\n  'Monitor_Vital_Signs:State2_Vitals',\n  'Monitor_Vital_Signs:State3_Vitals',\n  'Monitor_Vital_Signs:State4_Vitals',\n  'Monitor_Vital_Signs:State5_Vitals'\n];\n\n\n// ========== 2) CORE UTILS ==========\n\n/******************************************************\n * QUALITY ENGINE ‚Äî scoring, suggestions, audit & cleanup\n * - Auto-ensures columns:\n *   Developer_and_QA_Metadata:Simulation_Quality_Score\n *   Developer_and_QA_Metadata:Simulation_Enhancement_Suggestions\n * - Scores each row using weighted rubric\n * - Generates targeted improvement suggestions\n * - Audit tools for existing rows\n * - Cleanup tool for low-value rows (highlight or delete)\n ******************************************************/\n\n// -- Settings (tweak without changing call sites) --\nconst QUALITY = {\n  // If a row's filled ratio is below this, it‚Äôs considered low value\n  LOW_VALUE_THRESHOLD: 0.30, // 30%\n\n  // If score below this during audit, row gets highlighted (soft warning)\n  HIGHLIGHT_SCORE_LT: 60,\n\n  // Weights for rubric (sum does not need to be 100, we normalize)\n  WEIGHTS: {\n    coreIdentity: 10,     // Case_ID, Spark_Title, Reveal_Title\n    patientBasics: 10,    // Age, Sex, Setting, HPI summary\n    vitals: 20,           // Initial + state vitals\n    branching: 18,        // Progression states, decision rules\n    education: 15,        // Objectives + MCQ\n    ordersData: 12,       // Labs/Imaging/ECG presence\n    environmentAV: 8,     // Scene/time/ambience/media prompts (URLs can be N/A)\n    metaCompleteness: 7   // Reflection + misc developer metadata\n  },\n\n  // Targeted suggestions (key regex ‚Üí human message)\n  SUGGESTIONS: [\n    { re: /Case_Organization:Reveal_Title/i, msg: 'Add a clear Reveal Title with Dx (Age Sex) and a concise learning focus.' },\n    { re: /Case_Organization:Spark_Title/i,  msg: 'Add a Spark Title: ‚Äú<Symptom> (<Age Sex>): <Spark phrase>‚Äù.' },\n    { re: /Monitor_Vital_Signs:Initial_Vitals/i, msg: 'Provide Initial Vitals in compact JSON: {\"HR\":..,\"BP\":\"..\",\"RR\":..,\"Temp\":..,\"SpO2\":..}.' },\n    { re: /Progression_States|Decision_Nodes_JSON/i, msg: 'Add explicit state flow and at least 3 decision rules (branch conditions).' },\n    { re: /CME_and_Educational_Content:Learning_Objective/i, msg: 'Write 1‚Äì3 focused learning objectives.' },\n    { re: /CME_and_Educational_Content:Quiz_Q1/i, msg: 'Include 1 MCQ with 4 options and mark the correct one.' },\n    { re: /Labs|Imaging|ECG|Ultrasound/i, msg: 'Add at least one key data artifact (Labs/Imaging/ECG/US) with brief interpretation.' },\n    { re: /Scene|Ambient|Time_of_Day|Audio/i, msg: 'Enrich the scene: time, lighting, ambient audio to deepen immersion.' },\n    { re: /Developer_and_QA_Metadata:AI_Reflection_and_Suggestions/i, msg: 'Add a 3-part internal reflection (experience, sim improvements, system ideas).' }\n  ],\n\n  // Image_Sync columns can be N/A, but penalize if *all* are N/A\n  PENALIZE_ALL_IMAGE_SYNC_EMPTY: true\n};\n\n// Ensure the two quality columns exist; if missing, append them.\nfunction ensureQualityColumns_(sheet, header1, header2) {\n  const mk = (t1, t2) => `${t1}:${t2}`;\n  const qTier = 'Developer_and_QA_Metadata';\n  const scoreKey = mk(qTier, 'Simulation_Quality_Score');\n  const suggKey  = mk(qTier, 'Simulation_Enhancement_Suggestions');\n\n  const mergedNow = header1.map((t1,i)=>mk(t1, header2[i]));\n  const hasScore = mergedNow.includes(scoreKey);\n  const hasSugg  = mergedNow.includes(suggKey);\n\n  if (hasScore && hasSugg) return { scoreKey, suggKey };\n\n  // Append missing columns at the end with Tier1/Tier2\n  const lastCol = sheet.getLastColumn();\n  let toAppend = [];\n  if (!hasScore) toAppend.push({ t1:qTier, t2:'Simulation_Quality_Score' });\n  if (!hasSugg)  toAppend.push({ t1:qTier, t2:'Simulation_Enhancement_Suggestions' });\n\n  if (toAppend.length) {\n    sheet.insertColumnsAfter(lastCol, toAppend.length);\n    // Row 1 = Tier1, Row 2 = Tier2\n    toAppend.forEach((c, k) => {\n      sheet.getRange(1, lastCol + k + 1).setValue(c.t1);\n      sheet.getRange(2, lastCol + k + 1).setValue(c.t2);\n    });\n  }\n\n  // Re-read headers to return accurate keys\n  const h1 = sheet.getRange(1,1,1,sheet.getLastColumn()).getValues()[0];\n  const h2 = sheet.getRange(2,1,1,sheet.getLastColumn()).getValues()[0];\n  const merged = h1.map((t1,i)=>mk(t1, h2[i]));\n  return {\n    scoreKey: mk(qTier, 'Simulation_Quality_Score'),\n    suggKey:  mk(qTier, 'Simulation_Enhancement_Suggestions'),\n    header1: h1,\n    header2: h2,\n    mergedKeys: merged\n  };\n}\n\n// Return {score, suggestions[]} using a weighted rubric\nfunction evaluateSimulationQuality(rowValues, mergedKeys) {\n  const v = (key) => {\n    const idx = mergedKeys.indexOf(key);\n    if (idx < 0) return '';\n    return String(rowValues[idx] || '').trim();\n  };\n  const has = (re) => mergedKeys.some((k, i) => re.test(k) && String(rowValues[i]||'').trim() && String(rowValues[i]).trim()!=='N/A');\n\n  // 1) Filled ratio\n  const filled = rowValues.filter(x => String(x||'').trim() && String(x).trim()!=='N/A').length;\n  const filledRatio = filled / Math.max(1, rowValues.length);\n\n  // 2) Critical presence\n  const coreIdentityOk   = has(/Case_Organization:Case_ID/i) && has(/Case_Organization:Spark_Title/i) && has(/Case_Organization:Reveal_Title/i);\n  const patientBasicsOk  = has(/Patient_(Age|Sex)|Case_Organization:Spark_Title|Setting/i);\n  const vitalsOk         = has(/Monitor_Vital_Signs:Initial_Vitals/i);\n  const branchingOk      = has(/Progression_States|Decision_Nodes_JSON/i);\n  const educationOk      = has(/CME_and_Educational_Content:(Learning_Objective|Quiz_Q1)/i);\n  const ordersDataOk     = has(/Labs|Imaging|ECG|Ultrasound|CT|X[- ]?Ray/i);\n  const environmentOk    = has(/Scene|Time_of_Day|Ambient|Audio|Image_Prompt/i);\n  const metaOk           = has(/Developer_and_QA_Metadata:AI_Reflection_and_Suggestions/i);\n\n  // 3) Image_Sync penalty if all empty\n  let imgSyncPenalty = 0;\n  if (QUALITY.PENALIZE_ALL_IMAGE_SYNC_EMPTY) {\n    const imgKeys = mergedKeys.filter(k=>/^Image_Sync:/i.test(k));\n    const anyFilled = imgKeys.some(k=>{\n      const val = rowValues[mergedKeys.indexOf(k)];\n      return String(val||'').trim() && String(val).trim()!=='N/A';\n    });\n    if (!anyFilled && imgKeys.length) imgSyncPenalty = 0.05; // subtract 5%\n  }\n\n  // 4) Weighted score\n  const w = QUALITY.WEIGHTS;\n  const sumW = Object.values(w).reduce((a,b)=>a+b,0);\n  let score =\n    (coreIdentityOk   ? w.coreIdentity   : 0) +\n    (patientBasicsOk  ? w.patientBasics  : 0) +\n    (vitalsOk         ? w.vitals         : 0) +\n    (branchingOk      ? w.branching      : 0) +\n    (educationOk      ? w.education      : 0) +\n    (ordersDataOk     ? w.ordersData     : 0) +\n    (environmentOk    ? w.environmentAV  : 0) +\n    (metaOk           ? w.metaCompleteness:0);\n\n  // Blend in filled ratio (up to +10% bonus scaled by completeness)\n  const blendBonus = Math.round(10 * filledRatio);\n  score = ((score / sumW) * 100);\n  score = Math.min(100, Math.max(0, score + blendBonus - (imgSyncPenalty*100)));\n\n  // 5) Suggestions\n  const missingMsgs = [];\n  QUALITY.SUGGESTIONS.forEach(sugg => {\n    const satisfied = mergedKeys.some((k,i)=>sugg.re.test(k) && String(rowValues[i]||'').trim() && String(rowValues[i]).trim()!=='N/A');\n    if (!satisfied) missingMsgs.push(sugg.msg);\n  });\n\n  // Vitals sanity (compact JSON)\n  const ivKey = mergedKeys.find(k=>/Monitor_Vital_Signs:Initial_Vitals/i.test(k));\n  if (ivKey) {\n    const raw = v(ivKey);\n    if (raw && raw !== 'N/A') {\n      try {\n        const obj = JSON.parse(raw);\n        if (!('HR' in obj) || !('BP' in obj)) {\n          missingMsgs.push('Initial Vitals should include HR and BP at minimum.');\n        }\n      } catch(_) {\n        missingMsgs.push('Initial Vitals must be compact JSON (one line).');\n      }\n    } else {\n      missingMsgs.push('Provide Initial Vitals in compact JSON.');\n    }\n  }\n\n  // Keep suggestions tight\n  const suggestionsText = missingMsgs.length ? [...new Set(missingMsgs)].slice(0, 10).join('; ') : 'Excellent completeness.';\n  return { score: Math.round(score), suggestionsText };\n}\n\n// Write quality fields into rowValues array in-place. If columns missing, they‚Äôre created.\nfunction attachQualityToRow_(sheet, rowValues, header1, header2, mergedKeys) {\n  const ensured = ensureQualityColumns_(sheet, header1, header2);\n  const mk = (t1,t2)=>`${t1}:${t2}`;\n\n  // If ensureQualityColumns_ re-read headers, prefer them\n  const mkNow = ensured.mergedKeys || mergedKeys;\n  const scoreKey = ensured.scoreKey;\n  const suggKey  = ensured.suggKey;\n\n  const quality = evaluateSimulationQuality(rowValues, mkNow);\n\n  const scoreIdx = mkNow.indexOf(scoreKey);\n  const suggIdx  = mkNow.indexOf(suggKey);\n\n  // If columns were appended (after we built rowValues), extend rowValues to those columns\n  while (rowValues.length < mkNow.length) rowValues.push(''); // pad\n\n  if (scoreIdx >= 0) rowValues[scoreIdx] = quality.score;\n  if (suggIdx  >= 0) rowValues[suggIdx]  = quality.suggestionsText;\n\n  return quality; // return in case caller wants to log or use it\n}\n\n// ===== Public tools =====\n\n// Re-score all existing rows (or specific list). Adds/updates columns as needed.\nfunction runQualityAudit_AllOrRows() {\n  const ss = SpreadsheetApp.getActive();\n  const sheet = pickMasterSheet_();\n  if (!sheet) { getSafeUi_().alert('‚ùå Could not find your Master Scenario CSV sheet.'); return; }\n\n  const ui = getSafeUi_();\n  const resp = ui.prompt(\n    'Quality Audit',\n    'Leave blank to audit ALL rows, or enter rows like \"4,7,9-12\".',\n    ui.ButtonSet.OK_CANCEL\n  );\n  if (resp.getSelectedButton() !== ui.Button.OK) return;\n\n  const spec = resp.getResponseText().trim();\n  const rows = spec ? parseRowSpec_(spec) : null;\n\n  const { header1, header2 } = getCachedHeadersOrRead(sheet);\n  const mergedKeys = header1.map((t1,i)=>`${t1}:${header2[i]}`);\n  const ensured = ensureQualityColumns_(sheet, header1, header2);\n  const mkNow = ensured.mergedKeys || mergedKeys;\n\n  const last = sheet.getLastRow();\n  const startRow = 3; // data starts at row 3\n  let updated = 0;\n\n  for (let r = startRow; r <= last; r++) {\n    if (rows && !rows.includes(r)) continue;\n\n    const rowVals = sheet.getRange(r, 1, 1, sheet.getLastColumn()).getValues()[0];\n    // Skip empty lines\n    const nonEmpty = rowVals.some(x=>String(x||'').trim());\n    if (!nonEmpty) continue;\n\n    const q = evaluateSimulationQuality(rowVals, mkNow);\n\n    // write back\n    const scoreIdx = mkNow.indexOf(ensured.scoreKey) + 1;\n    const suggIdx  = mkNow.indexOf(ensured.suggKey)  + 1;\n    if (scoreIdx > 0) sheet.getRange(r, scoreIdx).setValue(q.score);\n    if (suggIdx  > 0) sheet.getRange(r, suggIdx).setValue(q.suggestionsText);\n\n    // Highlight very low scores\n    if (q.score < QUALITY.HIGHLIGHT_SCORE_LT) {\n      sheet.getRange(r, 1, 1, sheet.getLastColumn()).setBackground('#2b1d1d'); // subtle dark red\n    } else {\n      sheet.getRange(r, 1, 1, sheet.getLastColumn()).setBackground(null);\n    }\n    updated++;\n  }\n\n  if (ui) { ui.alert(`‚úÖ Quality Audit complete. Updated ${updated} row(s).`); }\n}\n\n// Clean up N/A-heavy rows: choose Highlight or Delete\nfunction cleanUpLowValueRows() {\n  const ss = SpreadsheetApp.getActive();\n  const sheet = pickMasterSheet_();\n  if (!sheet) { getSafeUi_().alert('‚ùå Could not find your Master Scenario CSV sheet.'); return; }\n\n  const last = sheet.getLastRow();\n  const startRow = 3;\n  const lowRows = [];\n\n  for (let r = startRow; r <= last; r++) {\n    const row = sheet.getRange(r,1,1,sheet.getLastColumn()).getValues()[0];\n    const nonNA = row.filter(x => String(x||'').trim() && String(x).trim()!=='N/A').length;\n    const ratio = nonNA / row.length;\n    if (ratio < QUALITY.LOW_VALUE_THRESHOLD) lowRows.push(r);\n  }\n\n  if (!lowRows.length) {\n    if (getSafeUi_()) { getSafeUi_().alert('‚úÖ No low-value rows found.'); }\n    return;\n  }\n\n  const ui = getSafeUi_();\n  const choice = ui.prompt(\n    `Found ${lowRows.length} low-value rows. Type \"H\" to highlight or \"D\" to delete them.`,\n    ui.ButtonSet.OK_CANCEL\n  );\n  if (choice.getSelectedButton() !== ui.Button.OK) return;\n  const opt = (choice.getResponseText()||'').trim().toUpperCase();\n\n  if (opt === 'D') {\n    // Delete bottom-up\n    lowRows.reverse().forEach(r => sheet.deleteRow(r));\n    if (ui) { ui.alert(`üßπ Deleted ${lowRows.length} row(s).`); }\n  } else {\n    // Highlight only\n    lowRows.forEach(r => sheet.getRange(r,1,1,sheet.getLastColumn()).setBackground('#2b1d1d'));\n    if (ui) { ui.alert(`üüß Highlighted ${lowRows.length} row(s).`); }\n  }\n}\n\n\nfunction getProp(key, fallback) {\n  const v = PropertiesService.getDocumentProperties().getProperty(key);\n  return (v === null || v === undefined) ? fallback : v;\n}\nfunction setProp(key, val) {\n  PropertiesService.getDocumentProperties().setProperty(key, val);\n}\n\nfunction estimateTokens(str) {\n  if (!str) return 0;\n  return Math.max(1, Math.round(String(str).length / 4));\n}\nfunction estimateCostUSD(inputText, outputText) {\n  const priceIn = parseFloat(getProp(SP_KEYS.PRICE_INPUT, DEFAULT_PRICE.input));\n  const priceOut = parseFloat(getProp(SP_KEYS.PRICE_OUTPUT, DEFAULT_PRICE.output));\n  const inTok = estimateTokens(inputText);\n  const outTok = estimateTokens(outputText);\n  return ((inTok / 1000) * priceIn) + ((outTok / 1000) * priceOut);\n}\n\nfunction hashText(text) {\n  if (!text) return '';\n  let hash = 0;\n  for (let i=0; i<text.length; i++) {\n    hash = (hash*31 + text.charCodeAt(i)) | 0;\n  }\n  return ('00000000' + (hash >>> 0).toString(16)).slice(-8);\n}\n\nfunction cleanDuplicateLines(text) {\n  if (!text) return text;\n  const lines = text.split('\\n');\n  const out = [];\n  let last = '', count = 0;\n  for (const l of lines) {\n    const t = l.trim();\n    if (t === last) {\n      count++;\n      if (count < 3) out.push(t);\n    } else {\n      out.push(t);\n      last = t; count = 0;\n    }\n  }\n  return out.join('\\n').trim();\n}\n\nfunction tryParseJSON(text) {\n  try { return JSON.parse(text); } catch(e) {\n    const m = text && text.match(/\\{[\\s\\S]*\\}/);\n    if (m) { try { return JSON.parse(m[0]); } catch(_) {} }\n    return null;\n  }\n}\n\n// ATSR-specific JSON parser that handles markdown code fences\nfunction parseATSRResponse_(text) {\n  if (!text) return null;\n\n  // Strip markdown code fences if present\n  let cleaned = text.trim();\n  if (cleaned.startsWith('```')) {\n    cleaned = cleaned.replace(/^```(?:json)?\\s*\\n?/i, '').replace(/\\n?```\\s*$/,'');\n  }\n\n  try { return JSON.parse(cleaned); } catch(e) {\n    const m = cleaned.match(/\\{[\\s\\S]*\\}/);\n    if (m) { try { return JSON.parse(m[0]); } catch(_) {} }\n    return null;\n  }\n}\n\n\n/**\n * Validate and normalize any \"Vitals\" or \"Monitor\" JSON fields.\n * Used after the AI JSON response is parsed.\n */\nfunction validateVitalsFields_(parsedOutput, headers) {\n  if (!parsedOutput || typeof parsedOutput !== 'object') return { valid: false, warnings: [] };\n\n  const warnings = [];\n  headers.forEach(h => {\n    const headerName = h.toLowerCase();\n    if (headerName.includes('vitals') || headerName.includes('monitor')) {\n      const value = parsedOutput[h] || parsedOutput[headerName];\n      if (value) {\n        // If it's a string, try to parse it as JSON\n        if (typeof value === 'string') {\n          const parsed = tryParseJSON(value);\n          if (parsed) parsedOutput[h] = parsed;\n          else warnings.push(`‚ö†Ô∏è ${h} field not valid JSON.`);\n        }\n        // If it's not an object after parse, warn\n        else if (typeof value !== 'object') {\n          warnings.push(`‚ö†Ô∏è ${h} field expected JSON object, got ${typeof value}.`);\n        }\n      } else {\n        warnings.push(`‚ö†Ô∏è Missing ${h} field.`);\n      }\n    }\n  });\n\n  return { valid: warnings.length === 0, warnings, data: parsedOutput };\n}\n\n/**\n * Calls OpenAI with enforced JSON output (for Convert/Batch mode only)\n */\nfunction callOpenAiJson(model, userPrompt) {\n  const apiKey = readApiKey_();\n  if (!apiKey) throw new Error('Missing API key.');\n\n  const url = 'https://api.openai.com/v1/chat/completions';\n  const payload = {\n    model: model,\n    messages: [\n      {\n        role: \"system\",\n        content: \"You are a structured data generator. ALWAYS respond with strict valid JSON ‚Äî no commentary, markdown, or text outside JSON.\"\n      },\n      { role: \"user\", content: userPrompt }\n    ],\n    temperature: 0\n  };\n\n  const options = {\n    method: \"post\",\n    headers: {\n      Authorization: \"Bearer \" + apiKey,\n      \"Content-Type\": \"application/json\"\n    },\n    payload: JSON.stringify(payload),\n    muteHttpExceptions: true\n  };\n\n  const response = UrlFetchApp.fetch(url, options);\n  const raw = response.getContentText();\n\n  Logger.log('üîç DEBUG: Raw OpenAI API response: ' + raw.slice(0, 300));\n\n  try {\n    // Parse the full API response\n    const apiResponse = JSON.parse(raw);\n\n    // Check for API-level errors\n    if (apiResponse.error) {\n      Logger.log('‚ùå OpenAI API Error: ' + JSON.stringify(apiResponse.error));\n      throw new Error('OpenAI API Error: ' + (apiResponse.error.message || JSON.stringify(apiResponse.error)));\n    }\n\n    // Extract the actual content from choices array\n    if (!apiResponse.choices || !apiResponse.choices.length) {\n      Logger.log('‚ùå No choices in API response');\n      throw new Error('OpenAI returned no choices');\n    }\n\n    const content = apiResponse.choices[0].message.content;\n    Logger.log('üìù Extracted content length: ' + content.length + ' characters');\n    Logger.log('üìù Content preview: ' + content.slice(0, 200));\n\n    // NOW parse the content as JSON (this is the simulation data)\n    const parsed = JSON.parse(content);\n    Logger.log('‚úÖ Successfully parsed simulation JSON with ' + Object.keys(parsed).length + ' keys');\n\n    return parsed;\n\n  } catch (err) {\n    Logger.log(\"‚ö†Ô∏è JSON parse error: \" + err.message);\n    Logger.log(\"Raw response: \" + raw.slice(0, 500));\n    throw new Error(\"AI response parse failed: \" + err.message);\n  }\n}\n\n/**\n * Extracts a value from AI JSON output, tolerant of tiered keys.\n * Handles formats like \"Tier1:Tier2\" or just \"Tier2\".\n */\nfunction extractValueFromParsed_(parsed, mergedKey) {\n  if (!parsed || typeof parsed !== 'object') return 'N/A';\n\n  // Try exact full key match\n  if (parsed.hasOwnProperty(mergedKey)) return parsed[mergedKey];\n\n  // Try after colon (Tier 2 only)\n  const parts = mergedKey.split(':');\n  const shortKey = parts[1] || parts[0];\n  if (parsed.hasOwnProperty(shortKey)) return parsed[shortKey];\n\n  // Try case-insensitive match\n  const lowerKey = shortKey.toLowerCase();\n  for (const k in parsed) {\n    if (k.toLowerCase() === lowerKey) return parsed[k];\n  }\n\n  // Try to find nested objects like { \"Case_Organization\": { \"Spark_Title\": \"...\" } }\n  if (parts.length === 2 && parsed[parts[0]] && typeof parsed[parts[0]] === 'object') {\n    const nested = parsed[parts[0]][parts[1]];\n    if (nested !== undefined) return nested;\n  }\n\n  // If all else fails, return N/A\n  return 'N/A';\n}\n\n// Settings sheet integration: read API key from a Settings sheet\n// Supports either:\n//  ‚Ä¢ A two-column key/value table where first column contains \"OPENAI_API_KEY\"\n//  ‚Ä¢ Or cell B2 under header \"API Key\" (fallback)\nfunction syncApiKeyFromSettingsSheet_() {\n  const ss = SpreadsheetApp.getActive();\n  const sheet = ss.getSheetByName('Settings');\n  if (!sheet) return null;\n\n  try {\n    const range = sheet.getDataRange().getValues();\n    // Try KV pairs\n    for (let r=0; r<range.length; r++) {\n      const k = String(range[r][0]||'').trim().toUpperCase();\n      const v = String(range[r][1]||'').trim();\n      if (k === 'OPENAI_API_KEY' && v) {\n        Logger.log('‚úÖ Found OPENAI_API_KEY in Settings sheet');\n        return v;\n      }\n    }\n    // Fallback: B2 if row2 has \"API Key\" label\n    const labelB2 = String(sheet.getRange(2,1).getValue()||'').toLowerCase();\n    if (labelB2.includes('api')) {\n      const apiKey = String(sheet.getRange(2,2).getValue()||'').trim();\n      if (apiKey) {\n        Logger.log('‚úÖ Found API key in Settings!B2');\n        return apiKey;\n      }\n    }\n  } catch(e) {\n    Logger.log('‚ö†Ô∏è Error reading Settings sheet: ' + e.message);\n  }\n  return null;\n}\n\n// Reads API key priority:\n// 1) Script Properties (saved via Settings panel / sidebar)\n// 2) Settings sheet (if present)\n// 3) Error\nfunction readApiKey_() {\n  // DELETE the cached key to force fresh read\n  try {\n    PropertiesService.getDocumentProperties().deleteProperty('OPENAI_API_KEY');\n    Logger.log('üóëÔ∏è Deleted cached API key');\n  } catch (e) {\n    Logger.log('‚ö†Ô∏è Could not delete cache: ' + e.message);\n  }\n\n  // Read fresh from Settings sheet\n  const fromSheet = syncApiKeyFromSettingsSheet_();\n  if (fromSheet) {\n    Logger.log('‚úÖ Read fresh API key from Settings sheet');\n    // DON'T cache it - keep reading fresh\n    return fromSheet;\n  }\n\n  Logger.log('‚ùå No API key found in Settings sheet');\n  return '';\n}\n\nfunction callOpenAI(promptText, temperature) {\n  const apiKey = readApiKey_();\n  if (!apiKey) throw new Error('‚ùå Missing API key. Open Settings and save your key (or add it to the Settings sheet).');\n  const model = getProp(SP_KEYS.MODEL, DEFAULT_MODEL);\n\n  const url = 'https://api.openai.com/v1/chat/completions';\n  const payload = {\n    model,\n    temperature: temperature ?? DEFAULT_TEMP_SINGLE,\n    max_tokens: MAX_TOKENS,\n    messages: [\n      { role: 'system', content: 'You are a world-class simulation scenario writer and exacting data formatter.' },\n      { role: 'user', content: promptText }\n    ]\n  };\n  const options = {\n    method: 'post',\n    headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type':'application/json' },\n    payload: JSON.stringify(payload),\n    muteHttpExceptions: true\n  };\n\n  const response = UrlFetchApp.fetch(url, options);\n  const body = response.getContentText();\n  const json = JSON.parse(body);\n  if (!json.choices || !json.choices.length) {\n    throw new Error('‚ö†Ô∏è OpenAI returned no choices:\\n' + body);\n  }\n  return json.choices[0].message.content.trim();\n}\n\n// Quick API status check\nfunction checkApiStatus() {\n  try {\n    const out = callOpenAI('Reply exactly with \"OK\".', 0.0);\n    const ok = /^OK$/i.test(out.trim());\n    if (getSafeUi_()) { getSafeUi_().alert(ok ? 'üõ°Ô∏è API is reachable.' : '‚ö†Ô∏è API replied unexpectedly: ' + out); }\n  } catch (e) {\n    if (getSafeUi_()) { getSafeUi_().alert('‚ùå API error: ' + e.message); }\n  }\n}\n\n// Header cache helpers (two-tier)\nfunction readTwoTierHeaders_(sheet) {\n  const header1 = sheet.getRange(1,1,1,sheet.getLastColumn()).getValues()[0];\n  const header2 = sheet.getRange(2,1,1,sheet.getLastColumn()).getValues()[0];\n  return { header1, header2 };\n}\nfunction mergedKeysFromTwoTiers_(header1, header2) {\n  return header1.map((t1,i)=>`${t1}:${header2[i]}`);\n}\nfunction cacheHeaders(sheet) {\n  const {header1, header2} = readTwoTierHeaders_(sheet);\n  setProp(SP_KEYS.HEADER_CACHE, JSON.stringify({header1, header2}));\n}\nfunction getCachedHeadersOrRead(sheet) {\n  let cached = getProp(SP_KEYS.HEADER_CACHE, '');\n  if (cached) try { return JSON.parse(cached); } catch(_){}\n  const hh = readTwoTierHeaders_(sheet);\n  setProp(SP_KEYS.HEADER_CACHE, JSON.stringify(hh));\n  return hh;\n}\nfunction clearHeaderCache() {\n  PropertiesService.getDocumentProperties().deleteProperty(SP_KEYS.HEADER_CACHE);\n  SpreadsheetApp.getActive().toast('üßπ Header cache cleared.');\n}\n\n// Ensure Batch_Reports tab exists\nfunction ensureBatchReportsSheet_() {\n  const ss = SpreadsheetApp.getActive();\n  let s = ss.getSheetByName('Batch_Reports');\n  if (!s) s = ss.insertSheet('Batch_Reports');\n  // minimal header\n  if (s.getLastRow() === 0) {\n    s.appendRow(['Timestamp','Mode','Created','Skipped','Duplicates','Errors','Estimated Cost (USD)','Elapsed']);\n  }\n  return s;\n}\n\n\n// ========== 3) SIDEBAR (Dark) ==========\n\nfunction openSimSidebar() {\n  const ss = SpreadsheetApp.getActive();\n  const allSheets = ss.getSheets().map(s=>s.getName());\n\n  // ‚≠ê Auto-refresh: ensure Settings!A1 points to a valid Convert sheet\n  try {\n    const settingsSheet = ss.getSheetByName('Settings');\n    const storedOut = settingsSheet ? settingsSheet.getRange('A1').getValue() : '';\n    const exists = allSheets.includes(storedOut);\n    if (!exists && allSheets.length) {\n      const fallback = allSheets.find(n => /convert/i.test(n))\n                  || allSheets.find(n => /master scenario csv/i.test(n))\n                  || allSheets[0];\n      if (settingsSheet) settingsSheet.getRange('A1').setValue(fallback);\n    }\n  } catch(err) {\n    Logger.log('Settings auto-refresh error: ' + err);\n  }\n\n  const lastInput  = getProp(SP_KEYS.LAST_INPUT_SHEET, '');\n  const lastOutput = getProp(SP_KEYS.LAST_OUTPUT_SHEET, '');\n  const savedModel = getProp(SP_KEYS.MODEL, DEFAULT_MODEL);\n  const savedApi   = getProp(SP_KEYS.API_KEY, '');\n\n  // ‚≠ê Dynamic output preference from Settings!A1\n  const settingsSheet = ss.getSheetByName('Settings');\n  const settingsOut = settingsSheet ? settingsSheet.getRange('A1').getValue() : '';\n\n  // Input = any with \"input\"; Output = only those with \"convert\"\n  const inputCandidates = allSheets.filter(n => /input/i.test(n));\n  const outputCandidates = allSheets.filter(n => /convert/i.test(n));\n\n  // Defaults\n  const defaultIn = inputCandidates.includes(lastInput)\n    ? lastInput\n    : (inputCandidates[0] || allSheets[0]);\n\n  const defaultOut =\n    outputCandidates.includes(settingsOut) ? settingsOut :\n    outputCandidates.includes(lastOutput) ? lastOutput :\n    (outputCandidates[0] || allSheets[0]);\n\n  const modelList = ['gpt-4o-mini','gpt-4o','o4-mini','o3-mini'];\n  const modelOptions = modelList.map(m=>`<option value=\"${m}\" ${m===savedModel?'selected':''}>${m}</option>`).join('');\n  const inOpts  = inputCandidates.map(n=>`<option value=\"${n}\" ${n===defaultIn?'selected':''}>${n}</option>`).join('');\n  const outOpts = outputCandidates.map(n=>`<option value=\"${n}\" ${n===defaultOut?'selected':''}>${n}</option>`).join('');\n\n  const html = HtmlService.createHtmlOutput(`\n  <style>\n    body{font-family:Arial;margin:0;background:#f5f7fa;color:#2c3e50}\n    .bar{padding:14px 16px;background:#1b1f2a;border-bottom:1px solid #dfe3e8}\n    h2{margin:0;font-size:16px;letter-spacing:.3px}\n    .wrap{padding:16px}\n    .card{background:#ffffff;border:1px solid #dfe3e8;border-radius:10px;padding:14px;margin-bottom:12px}\n    label{font-size:12px;color:#9aa3b2}\n    select,input,textarea{width:100%;background:#f5f7fa;border:1px solid #30384b;color:#2c3e50;border-radius:8px;padding:8px}\n    .row{display:flex;gap:10px}\n    .col{flex:1}\n    button{background:#2357ff;border:0;color:#fff;padding:10px 12px;border-radius:8px;cursor:pointer}\n    button.sec{background:#dfe3e8}\n    .pill{display:inline-block;background:#dfe3e8;padding:6px 8px;border-radius:999px;font-size:12px}\n    .hint{color:#9aa3b2;font-size:12px}\n    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}\n    .log{height:180px}\n  </style>\n\n  <div class=\"bar\"><h2>${ICONS.rocket} Sim Mastery ‚Äî Batch & Single</h2></div>\n  <div class=\"wrap\">\n    <div class=\"card\">\n      <div class=\"grid2\">\n        <div>\n          <label>Input Sheet</label>\n          <select id=\"inputSheet\">${inOpts}</select>\n        </div>\n        <div>\n          <label>Output Sheet</label>\n          <select id=\"outputSheet\">${outOpts}</select>\n        </div>\n      </div>\n      <div class=\"grid2\" style=\"margin-top:10px;\">\n        <div>\n          <label>Model</label>\n          <select id=\"model\">${modelOptions}</select>\n        </div>\n        <div>\n          <label>API Key</label>\n          <input id=\"apiKey\" type=\"password\" value=\"${savedApi ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : ''}\" placeholder=\"sk-...\" />\n        </div>\n      </div>\n    </div>\n\n    <div class=\"card\">\n      <div class=\"row\">\n        <div class=\"col\">\n          <label>Run mode</label>\n          <select id=\"runMode\">\n            <option value=\"one\">Single Case</option>\n            <option value=\"next25\">Next 25 unprocessed</option>\n            <option value=\"specific\">Specific (e.g. 4,7,9-12)</option>\n            <option value=\"all\">All rows</option>\n          </select>\n        </div>\n        <div class=\"col\">\n          <label>Specific rows</label>\n          <input id=\"rowsSpec\" placeholder=\"4,7,9-12\" />\n        </div>\n      </div>\n      <div style=\"margin-top:10px;\">\n        <label style=\"display:flex;align-items:center;gap:8px;cursor:pointer;\">\n          <input type=\"checkbox\" id=\"forceReprocess\" style=\"width:auto;\" />\n          <span style=\"color:#ff6b6b;\">üîÑ Force Reprocess (ignore duplicates)</span>\n        </label>\n        <div class=\"hint\" style=\"margin-top:4px;\">\n          ‚ö†Ô∏è When enabled, will regenerate cases even if they already exist in output\n        </div>\n      </div>\n    </div>\n\n        <div class=\"card\">\n      <div class=\"row\">\n        <button onclick=\"start()\">üöÄ Launch Batch Engine</button>\n        <button class=\"sec\" onclick=\"stop()\">‚èπÔ∏è Stop</button>\n        <button class=\"sec\" onclick=\"check()\">üõ°Ô∏è Check API</button>\n      </div>\n      <div style=\"margin-top:10px;\">\n        <span class=\"pill\" id=\"statusPill\">Idle</span>\n      </div>\n      <div style=\"margin-top:10px;\">\n        <textarea id=\"log\" class=\"log\" placeholder=\"Live log...\" readonly></textarea>\n      </div>\n    </div>\n\n    <div class=\"card\">\n      <div class=\"row\" style=\"justify-content: space-between;\">\n        <button class=\"sec\" onclick=\"imgSync()\">üñºÔ∏è Image Sync Defaults</button>\n        <button class=\"sec\" onclick=\"openSettings()\">‚öôÔ∏è Settings</button>\n      </div>\n      <div class=\"hint\" style=\"margin-top:8px;\">\n        üí° Use ‚ÄúRun mode‚Äù to choose between Single Case, First 25, or All Rows.  \n        Then click <strong>Launch Batch Engine</strong>.\n      </div>\n    </div>\n  </div>\n    <!-- ü™µ Live Logs Panel (NEW) -->\n    <div class=\"card\" style=\"margin-top:12px;\">\n      <div class=\"row\" style=\"justify-content: space-between; align-items:center;\">\n        <strong style=\"color:#ff82a9;\">ü™µ Live Logs</strong>\n        <div>\n          <button id=\"copyLogsBtn\" class=\"log-btn copy\">Copy Logs</button>\n          <button id=\"refreshLogsBtn\" class=\"log-btn\">Refresh</button>\n          <button id=\"clearLogsBtn\" class=\"log-btn danger\">Clear</button>\n        </div>\n      </div>\n      <pre id=\"logOutput\" class=\"log-output\">No logs yet.</pre>\n    </div>\n\n    <style>\n      .log-btn {\n        background: #1a1a1a;\n        color: #0f0;\n        border: 1px solid #0f0;\n        padding: 2px 8px;\n        margin-left: 4px;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: 11px;\n        transition: all 0.2s ease;\n      }\n      .log-btn:hover {\n        background: #0f0;\n        color: #000;\n      }\n      .log-btn.copy {\n        color: #58a6ff;\n        border-color: #58a6ff;\n      }\n      .log-btn.copy:hover {\n        background: #58a6ff;\n        color: #000;\n      }\n      .log-btn.danger {\n        color: #f55;\n        border-color: #f55;\n      }\n      .log-btn.danger:hover {\n        background: #f55;\n        color: #000;\n      }\n      .log-output {\n        white-space: pre-wrap;\n        background: #000;\n        color: #0f0;\n        padding: 8px;\n        border-radius: 6px;\n        margin-top: 4px;\n        max-height: 300px;\n        overflow-y: auto;\n        border: 1px solid #222;\n      }\n      .new-log-line {\n        animation: fadeInNew 0.6s ease-out;\n      }\n      @keyframes fadeInNew {\n        from { color: #9aff9a; background-color: rgba(0,255,0,0.05); }\n        to { color: #0f0; background-color: transparent; }\n      }\n    </style>\n\n    <script>\n      // === LOG VIEWER HANDLERS ===\n      let lastLogs = '';\n\n      function refreshLogs() {\n        google.script.run\n          .withSuccessHandler((logs) => {\n            const output = document.getElementById('logOutput');\n            if (logs && logs !== lastLogs) {\n              const diff = logs.replace(lastLogs, '').trim();\n              if (diff) {\n                const newLine = document.createElement('div');\n                newLine.textContent = diff;\n                newLine.classList.add('new-log-line');\n                output.appendChild(newLine);\n              } else {\n                output.textContent = logs;\n              }\n              output.scrollTop = output.scrollHeight;\n              lastLogs = logs;\n            }\n            if (!logs) output.textContent = 'No logs yet.';\n          })\n          .getSidebarLogs();\n      }\n\n      function clearLogs() {\n        google.script.run\n          .withSuccessHandler((msg) => {\n            document.getElementById('logOutput').textContent = msg;\n            lastLogs = '';\n          })\n          .clearSidebarLogs();\n      }\n\n      function copyLogs() {\n        const logText = document.getElementById('logOutput').textContent;\n        if (!logText || logText === 'No logs yet.') {\n          alert('No logs to copy!');\n          return;\n        }\n\n        // Copy to clipboard\n        navigator.clipboard.writeText(logText).then(() => {\n          const btn = document.getElementById('copyLogsBtn');\n          const originalText = btn.textContent;\n          btn.textContent = '‚úì Copied!';\n          btn.style.color = '#0f0';\n          btn.style.borderColor = '#0f0';\n          setTimeout(() => {\n            btn.textContent = originalText;\n            btn.style.color = '#58a6ff';\n            btn.style.borderColor = '#58a6ff';\n          }, 2000);\n        }).catch(err => {\n          alert('Failed to copy logs: ' + err);\n        });\n      }\n\n      document.getElementById('copyLogsBtn').addEventListener('click', copyLogs);\n      document.getElementById('refreshLogsBtn').addEventListener('click', refreshLogs);\n      document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);\n\n      // Auto-refresh every 5 seconds\n      setInterval(refreshLogs, 5000);\n    </script>\n  <script>\n    document.addEventListener('DOMContentLoaded', () => {\n      console.log('‚úÖ Sidebar loaded');\n    });\n\n    function appendLog(t){ const ta=document.getElementById('log'); ta.value += t + \"\\\\n\"; ta.scrollTop = ta.scrollHeight; }\n    function setStatus(s){ document.getElementById('statusPill').textContent = s; }\n\n    function persistBasics(){\n      const apiRaw = document.getElementById('apiKey').value.trim();\n      const outVal = document.getElementById('outputSheet').value;\n      google.script.run.saveSidebarBasics(\n        document.getElementById('model').value,\n        (apiRaw && apiRaw!=='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') ? apiRaw : '',\n        '', '',\n        document.getElementById('inputSheet').value,\n        outVal\n      );\n      google.script.run.setOutputSheet(outVal);\n    }\n\n    function loopStep(){\n      // Get next row number from queue\n      google.script.run\n          .withSuccessHandler(function(report){\n            if (report.done){\n              setStatus('‚úÖ Complete');\n              appendLog(report.msg || '‚úÖ Batch complete!');\n              return;\n            }\n\n            // ‚≠ê Call the EXACT same function single mode uses!\n            appendLog('üìä Processing row ' + report.row + ' (' + report.remaining + ' remaining)...');\n\n            google.script.run\n              .withSuccessHandler(function(result){\n                appendLog('‚úÖ Row ' + report.row + ' complete');\n                setTimeout(loopStep, 1500); // Next row after 1.5s\n              })\n              .withFailureHandler(function(e){\n                const errorMsg = e && e.message ? e.message : (e ? String(e) : 'Unknown error');\n                appendLog('‚ùå Row ' + report.row + ' error: ' + errorMsg);\n                setTimeout(loopStep, 1500); // Continue despite error\n              })\n              .runSingleCaseFromSidebar(report.inputSheetName, report.outputSheetName, report.row);\n          })\n          .withFailureHandler(function(e){\n            const errorMsg = e && e.message ? e.message : (e ? String(e) : 'Unknown error');\n            appendLog('‚ùå Batch error: ' + errorMsg);\n            setStatus('Error');\n          })\n          .runSingleStepBatch();\n    }\n    function start(){\n  persistBasics();\n  setStatus('Running...');\n  const mode = document.getElementById('runMode').value;\n  const spec = document.getElementById('rowsSpec').value.trim();\n  const inputSheet = document.getElementById('inputSheet').value;\n  const outputSheet = document.getElementById('outputSheet').value;\n  const forceReprocess = document.getElementById('forceReprocess').checked;\n\n  // Log if force reprocess is enabled\n  if (forceReprocess) {\n    appendLog('‚ö†Ô∏è Force Reprocess enabled - will ignore duplicates');\n  }\n\n  // Store force flag in properties for processOneInputRow_ to access\n  google.script.run.setProp('FORCE_REPROCESS', forceReprocess ? '1' : '0');\n\n  // Handle single-case mode directly\n  if (mode === 'one' || mode === 'single' || mode === 'Single Case') {\n    const rowNum = parseInt(spec || prompt('Enter row number to process (>=4):'), 10);\n    if (!rowNum) {\n      appendLog('‚ö†Ô∏è No row selected, cancelling.');\n      setStatus('Idle');\n      return;\n    }\n\n    google.script.run\n      .withSuccessHandler(m => {\n        appendLog(m || '‚úÖ Done.');\n        setStatus('Idle');\n        if (m && m.includes('Error')) alert(m);\n      })\n      .withFailureHandler(e => {\n        appendLog('‚ùå Single-case error: ' + e.message);\n        alert('‚ùå Single-case error: ' + e.message);\n        setStatus('Idle');\n      })\n      .runSingleCaseFromSidebar(inputSheet, outputSheet, rowNum);\n\n    return; // stop here, no batch loop\n  }\n\n  // Otherwise run normal batch flow\n  google.script.run\n    .withSuccessHandler(msg => {\n      appendLog(msg || '‚úÖ Batch started.');\n      loopStep(); // begin step loop\n    })\n    .withFailureHandler(e => {\n      appendLog('‚ùå Batch start error: ' + e.message);\n      setStatus('Idle');\n    })\n    .startBatchFromSidebar(inputSheet, outputSheet, mode, spec);\n}\n\nfunction stop(){\n  google.script.run.stopBatch();\n  setStatus('Stopping...');\n  appendLog('Stop requested.');\n}\n\nfunction imgSync(){ google.script.run.openImageSyncDefaults(); }\nfunction openSettings(){ google.script.run.openSettingsPanel(); }\nfunction check(){ google.script.run.checkApiStatus(); }\n  </script>\n  `)\n  .setWidth(540)\n  .setHeight(720)\n  .setSandboxMode(HtmlService.SandboxMode.IFRAME);\n\n  getSafeUi_().showSidebar(html);\n}\n\n// ‚≠ê UPDATED HELPERS\nfunction saveSidebarBasics(model, apiKeyMaybe, priceIn, priceOut, inputSheet, outputSheet) {\n  if (model) setProp(SP_KEYS.MODEL, model);\n  if (apiKeyMaybe) setProp(SP_KEYS.API_KEY, apiKeyMaybe);\n  if (inputSheet) setProp(SP_KEYS.LAST_INPUT_SHEET, inputSheet);\n  if (outputSheet) {\n    setProp(SP_KEYS.LAST_OUTPUT_SHEET, outputSheet);\n    setOutputSheet(outputSheet);\n  }\n}\n\n\n\nfunction logLong(label, text) {\n  try {\n    const chunkSize = 8000; // safe for Apps Script logs\n    if (!text) {\n      appendLogSafe(`(no text to log for ${label})`);\n      return;\n    }\n    for (let i = 0; i < text.length; i += chunkSize) {\n      const chunk = text.substring(i, i + chunkSize);\n      appendLogSafe(`${label} [${i / chunkSize + 1}]:\\n${chunk}`);\n    }\n  } catch (err) {\n    appendLogSafe(`logLong error: ${err}`);\n  }\n}\n\n// ‚≠ê Debug helper: safely log very long AI outputs in chunks\nfunction logLong(label, text) {\n  try {\n    const chunkSize = 8000; // safe for Apps Script logs\n    if (!text) {\n      appendLogSafe(`(no text to log for ${label})`);\n      return;\n    }\n    for (let i = 0; i < text.length; i += chunkSize) {\n      const chunk = text.substring(i, i + chunkSize);\n      appendLogSafe(`${label} [${i / chunkSize + 1}]:\\n${chunk}`);\n    }\n  } catch (err) {\n    appendLogSafe(`logLong error: ${err}`);\n  }\n}\n\nfunction getSidebarLogs() {\n  try {\n    const logs = PropertiesService.getDocumentProperties().getProperty('Sidebar_Logs') || '';\n    return logs;\n  } catch (err) {\n    return 'Error retrieving logs: ' + err;\n  }\n}\n\nfunction clearSidebarLogs() {\n  try {\n    PropertiesService.getDocumentProperties().deleteProperty('Sidebar_Logs');\n    return 'üßπ Logs cleared.';\n  } catch (err) {\n    return 'Error clearing logs: ' + err;\n  }\n}\n\n// ‚≠ê NEW: Writes chosen output sheet to Settings!A1\nfunction setOutputSheet(sheetName) {\n  const s = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Settings');\n  if (!s) throw new Error('Settings sheet not found.');\n  s.getRange('A1').setValue(sheetName);\n}\n\n// ‚≠ê Helper for saving property values\nfunction setProp(key, value) {\n  PropertiesService.getDocumentProperties().setProperty(key, value);\n}\n\n// ========== 4) BATCH QUEUE & ENGINE ==========\n\nfunction stopBatch() { setProp('BATCH_STOP','1'); }\n\nfunction parseRowSpec_(spec) {\n  const out = new Set();\n  if (!spec) return [];\n  spec.split(',').map(s=>s.trim()).forEach(token=>{\n    if (/^\\d+$/.test(token)) out.add(parseInt(token,10));\n    else if (/^\\d+\\-\\d+$/.test(token)) {\n      const [a,b] = token.split('-').map(n=>parseInt(n,10));\n      const lo = Math.min(a,b), hi = Math.max(a,b);\n      for (let r=lo; r<=hi; r++) out.add(r);\n    }\n  });\n  return Array.from(out).sort((a,b)=>a-b);\n}\n\n\n\n\n\n\n\n// === SMART BATCH: Calculate next 25 rows based on output sheet progress ===\nfunction getNext25InputRows_(inputSheet, outputSheet) {\n  appendLogSafe('üîç Starting robust row detection (Case_ID comparison method)...');\n\n  const inputLast = inputSheet.getLastRow();\n  const outputLast = outputSheet.getLastRow();\n\n  appendLogSafe(`üìä Input sheet last row: ${inputLast}`);\n  appendLogSafe(`üìä Output sheet last row: ${outputLast}`);\n\n  // Read all Case_IDs from Output sheet (Column A, rows 3+)\n  const processedCaseIds = new Set();\n  if (outputLast >= 3) {\n    const outputCaseIds = outputSheet.getRange(3, 1, outputLast - 2, 1).getValues();\n    outputCaseIds.forEach(row => {\n      const caseId = String(row[0] || '').trim();\n      if (caseId) {\n        processedCaseIds.add(caseId);\n      }\n    });\n  }\n\n  appendLogSafe(`‚úÖ Found ${processedCaseIds.size} processed Case_IDs in Output`);\n\n  // IMPORTANT: Input sheet structure\n  // Row 1: Tier 1 headers\n  // Row 2: Tier 2 headers\n  // Row 3+: Data\n  //\n  // The Input sheet does NOT have Case_ID pre-filled.\n  // Case_ID is GENERATED during processing.\n  //\n  // Strategy: Since we can't predict Case_ID from Input data,\n  // we use row position correlation:\n  // - Input row 3 ‚Üí Output row 3 (first data row)\n  // - Input row 4 ‚Üí Output row 4 (second data row)\n  // - etc.\n  //\n  // If Output has N data rows (rows 3 through 3+N-1),\n  // then Input rows 3 through 3+N-1 have been processed.\n  // Next unprocessed Input row = 3 + N\n\n  const outputDataRows = Math.max(0, outputLast - 2);\n  const nextInputRow = 3 + outputDataRows;\n\n  appendLogSafe(`üìä Output has ${outputDataRows} data rows`);\n  appendLogSafe(`üìä Next unprocessed Input row: ${nextInputRow}`);\n\n  // Build array of next 25 rows to process\n  const availableRows = [];\n  for (let r = nextInputRow; r <= inputLast && availableRows.length < 25; r++) {\n    availableRows.push(r);\n  }\n\n  appendLogSafe(`‚úÖ Found ${availableRows.length} unprocessed rows`);\n  if (availableRows.length > 0) {\n    appendLogSafe(`üìã Rows to process: [${availableRows.slice(0, 5).join(', ')}${availableRows.length > 5 ? '...' : ''}]`);\n  }\n\n  return availableRows;\n}\nfunction getAllInputRows_(inputSheet, outputSheet) {\n  appendLogSafe('üîç Starting detection for ALL remaining rows...');\n\n  const inputLast = inputSheet.getLastRow();\n  const outputLast = outputSheet.getLastRow();\n\n  appendLogSafe(`üìä Input sheet last row: ${inputLast}`);\n  appendLogSafe(`üìä Output sheet last row: ${outputLast}`);\n\n  // Count processed rows\n  const outputDataRows = Math.max(0, outputLast - 2);\n  const nextInputRow = 3 + outputDataRows;\n\n  appendLogSafe(`üìä Output has ${outputDataRows} processed rows`);\n  appendLogSafe(`üìä Next unprocessed Input row: ${nextInputRow}`);\n\n  // Build array of ALL remaining rows\n  const availableRows = [];\n  for (let r = nextInputRow; r <= inputLast; r++) {\n    availableRows.push(r);\n  }\n\n  appendLogSafe(`‚úÖ Found ${availableRows.length} unprocessed rows (all remaining)`);\n  if (availableRows.length > 0) {\n    appendLogSafe(`üìã Will process rows ${availableRows[0]} through ${availableRows[availableRows.length-1]}`);\n  }\n\n  return availableRows;\n}\nfunction getSpecificInputRows_(inputSheet, outputSheet, spec) {\n  appendLogSafe(`üîç Starting detection for SPECIFIC rows: ${spec}`);\n\n  const outputLast = outputSheet.getLastRow();\n\n  // Build set of already-processed row numbers\n  // Since Input row N ‚Üí Output row N, rows 3 through (outputLast) are processed\n  const processedRows = new Set();\n  const outputDataRows = Math.max(0, outputLast - 2);\n\n  for (let r = 3; r < 3 + outputDataRows; r++) {\n    processedRows.add(r);\n  }\n\n  appendLogSafe(`üìä Already processed rows: 3 through ${2 + outputDataRows} (${processedRows.size} total)`);\n\n  // Parse the spec (supports \"5,10,15\" or \"5-10\" or mixed \"5-10,15,20-25\")\n  const requestedRows = parseRowSpec(spec);\n\n  appendLogSafe(`üìã Requested rows: [${requestedRows.join(', ')}]`);\n\n  // Filter out already-processed rows\n  const availableRows = requestedRows.filter(r => !processedRows.has(r));\n\n  if (availableRows.length < requestedRows.length) {\n    const skipped = requestedRows.filter(r => processedRows.has(r));\n    appendLogSafe(`‚ö†Ô∏è  Skipping already-processed rows: [${skipped.join(', ')}]`);\n  }\n\n  appendLogSafe(`‚úÖ Will process ${availableRows.length} rows: [${availableRows.join(', ')}]`);\n\n  return availableRows;\n}\n\nfunction parseRowSpec(spec) {\n  const rows = [];\n  const parts = spec.split(',');\n\n  parts.forEach(part => {\n    part = part.trim();\n    if (part.includes('-')) {\n      // Range: \"5-10\"\n      const range = part.split('-');\n      const start = parseInt(range[0].trim(), 10);\n      const end = parseInt(range[1].trim(), 10);\n      for (let r = start; r <= end; r++) {\n        if (!rows.includes(r)) {\n          rows.push(r);\n        }\n      }\n    } else {\n      // Single row: \"5\"\n      const r = parseInt(part, 10);\n      if (!rows.includes(r)) {\n        rows.push(r);\n      }\n    }\n  });\n\n  // Sort numerically\n  return rows.sort((a, b) => a - b);\n}\n\n\n\nfunction startBatchFromSidebar(inputSheetName, outputSheetName, mode, spec) {\n  const ss = SpreadsheetApp.getActive();\n  const inSheet = ss.getSheetByName(inputSheetName);\n  let outSheet = ss.getSheetByName(outputSheetName);\n\n  // Dynamic output sheet detection (check Settings)\n  const settingsSheet = ss.getSheetByName('Settings');\n  const settingsOut = settingsSheet ? settingsSheet.getRange('A1').getValue() : '';\n  if (settingsOut) {\n    outSheet = ss.getSheetByName(settingsOut) || outSheet;\n  }\n\n  if (!inSheet || !outSheet) {\n    throw new Error('‚ùå Could not find selected sheets.');\n  }\n\n  cacheHeaders(outSheet);\n\n  appendLogSafe('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');\n  appendLogSafe(`üìã Starting batch mode: ${mode}`);\n  appendLogSafe('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');\n\n  let rows;\n\n  if (mode === 'next25') {\n    rows = getNext25InputRows_(inSheet, outSheet);\n  } else if (mode === 'all') {\n    rows = getAllInputRows_(inSheet, outSheet);\n  } else if (mode === 'specific') {\n    rows = getSpecificInputRows_(inSheet, outSheet, spec);\n  } else {\n    throw new Error('Unknown batch mode: ' + mode);\n  }\n\n  if (!rows || rows.length === 0) {\n    appendLogSafe('‚ö†Ô∏è  No rows to process.');\n    return { success: false, message: 'No unprocessed rows found.' };\n  }\n\n  // Save queue to DocumentProperties (separate properties for reliability)\n  setProp('BATCH_ROWS', JSON.stringify(rows));\n  setProp('BATCH_INPUT_SHEET', inputSheetName);\n  setProp('BATCH_OUTPUT_SHEET', outputSheetName);\n  setProp('BATCH_MODE', mode);\n  setProp('BATCH_SPEC', spec);\n  setProp('BATCH_STOP', ''); // Clear stop flag\n\n  // Also save as single queue object for backwards compatibility\n  const q = {\n    rows: rows,\n    inputSheetName: inputSheetName,\n    outputSheetName: outputSheetName,\n    mode: mode,\n    spec: spec\n  };\n  setProp('BATCH_QUEUE', JSON.stringify(q));\n\n  appendLogSafe(`‚úÖ Batch queued with ${rows.length} row(s)`);\n  appendLogSafe(`üìã Rows: [${rows.slice(0, 10).join(', ')}${rows.length > 10 ? '...' : ''}]`);\n  appendLogSafe('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');\n\n  return { success: true, count: rows.length, rows: rows };\n}\n\nfunction runSingleStepBatch() {\n  // Try reading from separate properties first (more reliable)\n  const rowsJson = getProp('BATCH_ROWS', '[]');\n  const rows = JSON.parse(rowsJson);\n\n  // Build queue object from separate properties\n  const q = {\n    rows: rows,\n    inputSheetName: getProp('BATCH_INPUT_SHEET', ''),\n    outputSheetName: getProp('BATCH_OUTPUT_SHEET', ''),\n    mode: getProp('BATCH_MODE', ''),\n    spec: getProp('BATCH_SPEC', '')\n  }\n\n  // Check if we have rows left\n  if (!q.rows || q.rows.length === 0) {\n    return { done: true, msg: '‚úÖ All rows processed!' };\n  }\n\n  if (getProp('BATCH_STOP','')) {\n    return { done: true, msg: 'Stopped by user.' };\n  }\n\n  // ‚≠ê Just pop and return the row number - don't process it here!\n  const nextRow = q.rows.shift();\n\n  // Save updated queue\n  // Update the rows property\n  setProp('BATCH_ROWS', JSON.stringify(q.rows));\n  // Also update full queue for backward compatibility\n  setProp('BATCH_QUEUE', JSON.stringify(q));\n\n  // Return the row number and queue data so loopStep can call runSingleCaseFromSidebar\n  return {\n    done: false,\n    row: nextRow,\n    remaining: q.rows.length,\n    inputSheetName: q.inputSheetName,\n    outputSheetName: q.outputSheetName\n  };\n}\nfunction finishBatchAndReport() {\n  const log = JSON.parse(getProp('BATCH_LOG','{}'));\n  const elapsedMs = Date.now() - (log.started||Date.now());\n  const minutes = (elapsedMs/60000).toFixed(1);\n  const report = `\n${ICONS.clipboard} Batch Summary Report\nCreated: ${log.created||0}\nSkipped: ${log.skipped||0}\nDuplicates: ${log.dupes||0}\nErrors: ${log.errors||0}\nElapsed: ${minutes} min\n  `.trim();\n\n  const s = ensureBatchReportsSheet_();\n  s.appendRow([new Date(), 'Batch', log.created||0, log.skipped||0, log.dupes||0, log.errors||0, '', `${minutes} min`]);\n\n  // Clear force reprocess flag after batch completes\n  setProp('FORCE_REPROCESS', '0');\n\n  if (getSafeUi_()) { getSafeUi_().alert(report); }\n  return report;\n}\n\n// ========== 5) SINGLE CASE GENERATOR (also used by batch) ==========\n\nfunction runSingleCaseFromSidebar(inputSheetName, outputSheetName, row) {\n  const ss = SpreadsheetApp.getActive();\n\n  // Define the input and output sheets first\n  const inSheet = ss.getSheetByName(inputSheetName);\n  let outSheet = ss.getSheetByName(outputSheetName);\n\n  // ‚≠ê Dynamic output sheet detection\n  const settingsSheet = ss.getSheetByName('Settings');\n  const settingsOut = settingsSheet ? settingsSheet.getRange('A1').getValue() : '';\n  if (settingsOut) outSheet = ss.getSheetByName(settingsOut) || outSheet;\n\n  // Validate\n  if (!inSheet || !outSheet) throw new Error('‚ùå Could not find selected sheets.');\n\n  cacheHeaders(outSheet);\n  const result = processOneInputRow_(inSheet, outSheet, row, /*batchMode*/ false);\n\n  // Note: Toast disabled for sidebar operations - sidebar logs provide feedback\n  // if (result.message) {\n  //   showToast(result.message, 3);\n  // }\n\n  return result.message;\n}\n\n\n\n\n// === CLINICAL DEFAULTS: Fill missing vitals with medically realistic values ===\n/**\n * Applies clinical defaults to any missing Monitor_Vital_Signs fields.\n * Called during batch processing to ensure every scenario has complete vitals.\n *\n * Strategy:\n * - Baseline vitals: HR 75, BP 120/80, RR 16, Temp 37.0, SpO2 98, EtCO2 35\n * - Critical scenarios (detected by keywords): Elevated baseline\n * - State progression: Gradual improvement from State1 ‚Üí State5\n * - Metadata: Standard monitoring setup\n */\nfunction applyClinicalDefaults_(parsed, mergedKeys) {\n  Logger.log('ü©∫ Applying clinical defaults for missing vitals...');\n\n  // Baseline vitals (stable adult)\n  const BASELINE = {\n    HR: 75,\n    BP: '120/80',\n    RR: 16,\n    Temp: 37.0,\n    SpO2: 98,\n    EtCO2: 35\n  };\n\n  // Critical scenario baseline (elevated)\n  const CRITICAL_BASELINE = {\n    HR: 110,\n    BP: '90/60',\n    RR: 24,\n    Temp: 37.0,\n    SpO2: 92,\n    EtCO2: 32\n  };\n\n  // Check if this is a critical scenario\n  const title = (parsed['Case_Organization:Spark_Title'] || '').toLowerCase();\n  const category = (parsed['Case_Organization:Category'] || '').toLowerCase();\n  const desc = (parsed['Case_Organization:Formal_Description'] || '').toLowerCase();\n  const context = title + ' ' + category + ' ' + desc;\n\n  const isCritical = /cardiac|arrest|shock|trauma|sepsis|stroke|critical|emergency|unstable/i.test(context);\n\n  const baseVitals = isCritical ? CRITICAL_BASELINE : BASELINE;\n\n  if (isCritical) {\n    Logger.log('  üìä Critical scenario detected - using elevated baseline');\n  }\n\n  // Metadata fields (always fill if missing)\n  const metadata = {\n    'Monitor_Vital_Signs:Vitals_Format': 'Compact JSON (HR, BP, RR, Temp, SpO2, EtCO2)',\n    'Monitor_Vital_Signs:Vitals_API_Target': 'resusmonitor.com/api/vitals',\n    'Monitor_Vital_Signs:Vitals_Update_Frequency': '5 seconds',\n    'Situation_and_Environment_Details:Initial_Monitoring_Status': 'Standard 5-lead ECG, pulse oximetry, NIBP'\n  };\n\n  Object.keys(metadata).forEach(function(key) {\n    if (!parsed[key] || parsed[key] === 'N/A' || parsed[key] === '') {\n      parsed[key] = metadata[key];\n      Logger.log('  ‚úÖ Set ' + key);\n    }\n  });\n\n  // Vitals states with progression\n  const vitalsStates = [\n    { key: 'Monitor_Vital_Signs:Initial_Vitals', multiplier: 1.0, desc: 'Initial' },\n    { key: 'Monitor_Vital_Signs:State1_Vitals', multiplier: 1.1, desc: 'State 1 (worsening)' },\n    { key: 'Monitor_Vital_Signs:State2_Vitals', multiplier: 1.05, desc: 'State 2 (stabilizing)' },\n    { key: 'Monitor_Vital_Signs:State3_Vitals', multiplier: 0.95, desc: 'State 3 (improving)' },\n    { key: 'Monitor_Vital_Signs:State4_Vitals', multiplier: 0.9, desc: 'State 4 (responding)' },\n    { key: 'Monitor_Vital_Signs:State5_Vitals', multiplier: 0.85, desc: 'State 5 (resolving)' }\n  ];\n\n  vitalsStates.forEach(function(state) {\n    if (!parsed[state.key] || parsed[state.key] === 'N/A' || parsed[state.key] === '') {\n      // Create vitals object with progression\n      var vitals = {\n        HR: Math.round(baseVitals.HR * state.multiplier),\n        BP: baseVitals.BP,\n        RR: baseVitals.RR,\n        Temp: baseVitals.Temp,\n        SpO2: baseVitals.SpO2,\n        EtCO2: baseVitals.EtCO2\n      };\n\n      // Adjust other vitals based on HR change\n      if (state.multiplier > 1.0) {\n        // Worsening: Lower SpO2, higher RR\n        vitals.SpO2 = Math.max(88, baseVitals.SpO2 - Math.round((state.multiplier - 1) * 100));\n        vitals.RR = baseVitals.RR + Math.round((state.multiplier - 1) * 20);\n      } else if (state.multiplier < 1.0) {\n        // Improving: Return to baseline\n        vitals.SpO2 = Math.min(98, baseVitals.SpO2 + Math.round((1 - state.multiplier) * 20));\n        vitals.BP = BASELINE.BP; // Return to normal BP\n      }\n\n      // Final state returns to true baseline\n      if (state.key.includes('State5')) {\n        vitals = {\n          HR: BASELINE.HR,\n          BP: BASELINE.BP,\n          RR: BASELINE.RR,\n          Temp: BASELINE.Temp,\n          SpO2: BASELINE.SpO2,\n          EtCO2: BASELINE.EtCO2\n        };\n      }\n\n      parsed[state.key] = JSON.stringify(vitals);\n      Logger.log('  ‚úÖ Generated ' + state.desc + ': ' + parsed[state.key]);\n    }\n  });\n\n  Logger.log('‚úÖ Clinical defaults complete');\n  return parsed;\n}\n\nfunction processOneInputRow_(inputSheet, outputSheet, inputRow, batchMode) {\n  try {\n    // --- Read inputs per row: A=Formal_Info, B=HTML, C=DOC, D=Extra (any may be blank) ---\n    const formal = String(inputSheet.getRange(inputRow, 1).getValue() || '');\n    const html   = String(inputSheet.getRange(inputRow, 2).getValue() || '');\n    const docRaw = String(inputSheet.getRange(inputRow, 3).getValue() || '');\n    const extra  = String(inputSheet.getRange(inputRow, 4).getValue() || '');\n\n    if (!formal && !html && !docRaw && !extra) {\n      return { skipped: true, message: `Row ${inputRow}: no input.` };\n    }\n\n    appendLogSafe(`‚ñ∂Ô∏è Starting conversion for Row ${inputRow} (batchMode=${batchMode})`);\n\n    // --- Calculate content signature (always needed for writing) ---\n    const sniff = (formal + '\\n' + html + '\\n' + docRaw + '\\n' + extra).slice(0, 1000);\n    const sig = hashText(sniff);\n\n    // --- Duplicate check against output content signature (unless force reprocess enabled) ---\n    const forceReprocess = getProp('FORCE_REPROCESS', '0') === '1';\n    if (!forceReprocess) {\n      const allOut = outputSheet.getDataRange().getValues().flat().join('\\n');\n      if (allOut.indexOf(sig) !== -1) {\n        return { skipped: true, duplicate: true, message: `Row ${inputRow}: duplicate (hash match).` };\n      }\n    } else {\n      appendLogSafe(`üîÑ Force reprocess enabled - skipping duplicate check for Row ${inputRow}`);\n    }\n\n    // --- Clean + setup ---\n    const cleanedDoc = cleanDuplicateLines(docRaw);\n    const { header1, header2 } = getCachedHeadersOrRead(outputSheet);\n    const mergedKeys = mergedKeysFromTwoTiers_(header1, header2);\n    const exampleRow = outputSheet.getRange(3, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n\n    const hardReq = `Hard requirement: You must include every key exactly as listed in the header pairs. Use \"N/A\" only when truly unknown or not applicable. Avoid inventing URLs.`;\n        // --- Build AI example context from Rows 3 & 4 (distinct complete simulations) ---\n    function buildExampleJSON(rowValues) {\n      const obj = {};\n      mergedKeys.forEach((key, i) => {\n        const val = rowValues[i];\n        if (val && val !== 'N/A' && String(val).trim() !== '') {\n          obj[key] = val;\n        }\n      });\n      return obj;\n    }\n\n    let exampleJson1 = '{}';\n    let exampleJson2 = '{}';\n\n    try {\n      const exampleRow1 = outputSheet.getRange(3, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n      const exampleRow2 = outputSheet.getRange(4, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n\n      const data1 = buildExampleJSON(exampleRow1);\n      const data2 = buildExampleJSON(exampleRow2);\n\n      // --- Fallback demo if both are nearly empty ---\n      const isEmpty = (obj) => Object.keys(obj).length < 5;\n      const demoCase = {\n        \"Case_Organization:Case_ID\": \"DEMO001\",\n        \"Case_Organization:Spark_Title\": \"Chest Pain (45 M): Sudden Tightness\",\n        \"Monitor_Vital_Signs:Initial_Vitals\": {\"HR\":118,\"BP\":\"92/58\",\"RR\":28,\"Temp\":37.9,\"SpO2\":93},\n        \"Progression_States\": [\"Arrival\",\"Oxygen\",\"Stabilization\"],\n        \"Decision_Nodes_JSON\": [\n          {\n            \"at_state\": \"Arrival\",\n            \"decision\": \"Administer oxygen?\",\n            \"options\": [\n              {\"choice\":\"Yes\",\"next_state\":\"Oxygen\",\"rationale\":\"Improves hypoxia\"},\n              {\"choice\":\"No\",\"next_state\":\"Worsening\",\"rationale\":\"SpO2 continues to drop\"}\n            ]\n          }\n        ]\n      };\n\n      if (isEmpty(data1)) exampleJson1 = JSON.stringify(demoCase, null, 2);\n      else exampleJson1 = JSON.stringify(data1, null, 2);\n\n      if (isEmpty(data2)) exampleJson2 = JSON.stringify(demoCase, null, 2);\n      else exampleJson2 = JSON.stringify(data2, null, 2);\n\n    } catch (err) {\n      Logger.log('‚ö†Ô∏è Example-row build error: ' + err);\n      exampleJson1 = JSON.stringify({\n        \"Case_Organization:Case_ID\": \"DEMO_FALLBACK\",\n        \"Monitor_Vital_Signs:Initial_Vitals\": {\"HR\":100,\"BP\":\"110/70\",\"RR\":18,\"Temp\":36.8,\"SpO2\":98}\n      }, null, 2);\n      exampleJson2 = exampleJson1;\n    }\n    const systemPrompt = `\nüìò **Sim Mastery AI Prompt for Google Sheet CSV Row Generation**\n\nYou are an expert simulation designer helping build **Sim Mastery** ‚Äî an emotionally resonant, AI-facilitated, high-fidelity emergency-medicine simulation platform.  \nThis tool is used by clinicians to sharpen real-time decision-making and learn through immersive, branching, lifelike emergencies.\n\n---\n\nüí° **Objective**\nCreate a **one-row Google Sheet simulation case** that is:\n‚Ä¢ Unique to the given content  \n‚Ä¢ Clinically sound  \n‚Ä¢ Narratively immersive  \n‚Ä¢ Technically compatible with the Sim Mastery CSV  \n‚Ä¢ Valuable to the learner both intellectually and emotionally  \n\n---\n\nüß† **Philosophy**\n‚Ä¢ Help the learner *feel* what it‚Äôs like to manage chaos  \n‚Ä¢ Give just enough guidance ‚Äî do not spoon-feed  \n‚Ä¢ Reflect real-world uncertainty and triumph  \n‚Ä¢ Be emotionally anchored, educationally sound, and uplifting  \n\n---\n\nü©∫ **Vitals Format (Compact JSON)**\n\\`{\"HR\":120, \"BP\":\"95/60\", \"RR\":28, \"Temp\":39.2, \"SpO2\":94}\\`\n\n---\n\nü™Ñ **Tone & Style**\n‚Ä¢ Professional but warm  \n‚Ä¢ Support learner growth through tension and curiosity  \n‚Ä¢ Fun yet respectful of medicine‚Äôs seriousness  \n‚Ä¢ Use best practices of professional simulation facilitators  \n\n---\n\nüß™ **You Will Output**\n‚Ä¢ A single JSON object mapping directly to columns of the Google Sheet  \n‚Ä¢ Use the header1 and header2 context to align structure  \n‚Ä¢ If a cell value is missing, use \"N/A\" (especially for any Media_URL field)  \n‚Ä¢ Do **not** copy prior case content  \nGenerate a completely new simulation inspired by the HTML and DOC input  \n\n---\n\n‚ú® **Inputs Provided**\n‚Ä¢ header1 (Tier-1 categories)  \n‚Ä¢ header2 (Tier-2 column labels)  \n‚Ä¢ Example rows for structure only (Rows 3 and 4)  \n‚Ä¢ New HTML & DOC text as inspiration  \n\n---\n\nüî≠ **Simulation Semantics & Branching (Read Carefully)**\n\n1Ô∏è‚É£ **Row-level semantics**  \n- Treat this row as ONE complete simulation case.  \n- Each row is independent and self-contained (**rows = semantics**).  \n- Columns define structure (**headers = schema**).  \n- All content must form a single, coherent story for this row.  \n\n2Ô∏è‚É£ **Branching model (state machine)**  \n- Define ordered Progression_States and Decision_Nodes_JSON with clinician decisions and outcomes.  \n- Each state updates the clinical picture and **vitals** (compact JSON).  \n- Example: \\`{\"HR\":110,\"BP\":\"112/68\",\"RR\":24,\"Temp\":38.2,\"SpO2\":93}\\`  \n\n3Ô∏è‚É£ **Coherence & consequences**  \n- Decisions must have meaningful effects.  \n- Ensure logical paths and realistic values.  \n\n4Ô∏è‚É£ **Data discipline**  \n- Use exact merged keys \\`Tier1:Tier2\\`.  \n- Use \"N/A\" only when truly not applicable.  \n- Never invent URLs.  \n- Prefer structured JSON for vitals/monitor/decision fields.  \n\n5Ô∏è‚É£ **Inputs to respect**  \n- Use only FORMAL INFO, HTML, DOC, and EXTRA NOTES.  \n- Anchor physiology and logic to those inputs.  \n\n6Ô∏è‚É£ **Quality guardrails**  \n- Pre-diagnosis: exploratory, hypothesis-driven.  \n- Post-diagnosis: clear, educational, learning-point focused.  \n- Quiz/education columns must align with decision logic and outcomes.  \n\n---\n\n### üß© **Example Completed Cases**\n\nBelow are two example cases showing the complete structure and style of finished simulations.  \nEach is unique and represents its own independent case.\n\n**Example Case 1 (Row 3):**  \n${exampleJson1}\n\n**Example Case 2 (Row 4):**  \n${exampleJson2}\n\n---\n\n### ü§ñ **FUTURE USE CONTEXT (VERY IMPORTANT)**\n\nThe data you generate will be consumed by two systems working together:\n\n1. **Sim Mastery Engine**  \n   - The core platform that converts this CSV into an interactive, voice-responsive simulation.  \n   - It interprets each field as part of a larger, branching clinical scenario.  \n   - Clinicians will interact via mobile or desktop, speaking or selecting real-time decisions (e.g., \"push epi\", \"order CT\", \"intubate\").  \n   - The system will narrate, animate, and respond dynamically based on your structured output.\n\n2. **ResusVitals API**  \n   - A specialized vitals engine that dynamically updates the patient‚Äôs physiological parameters during simulation.  \n   - It reads from any field containing ‚ÄúVitals‚Äù or ‚ÄúMonitor‚Äù and interprets your compact nested JSON (e.g., {\"HR\":120,\"BP\":\"95/60\",\"RR\":28,\"Temp\":39.2,\"SpO2\":94}).  \n   - Vitals change as states and decisions progress (State0 ‚Üí State1 ‚Üí State2, etc.).\n\nYour role:  \n‚Ä¢ Treat this output as a **modular simulation blueprint**.  \n‚Ä¢ Each ‚Äúrow‚Äù is a self-contained scenario that future AI systems can reconstruct and run dynamically.  \n‚Ä¢ Each column is a structured data node used for narration, decision trees, vitals, scoring, and learning objectives.  \n‚Ä¢ Prioritize **machine-readability**, **coherence**, and **educational realism**.  \n\n---\nReturn your response **strictly as valid JSON** following this structure.  \nDo not include commentary, markdown, or text outside the JSON object.  \n`.trim();\n\n// --- Generate (force-JSON) & validate ---\nconst model = getProp(SP_KEYS.MODEL, DEFAULT_MODEL);\nappendLogSafe('ü§ñ Calling OpenAI to generate scenario...');\nconst aiResp = batchMode\n  ? callOpenAiJson(model, systemPrompt)\n  : callOpenAI(systemPrompt, DEFAULT_TEMP_SINGLE);\nappendLogSafe('‚úÖ Received OpenAI response, processing...');\n\n// --- Extract and sanitize JSON text ---\nlet aiText = '';\n\nif (batchMode) {\n  aiText = JSON.stringify(aiResp);\n} else {\n  // callOpenAI() returns raw text\n  aiText = typeof aiResp === 'string'\n    ? aiResp.trim()\n    : aiResp?.choices?.[0]?.message?.content?.trim() || '';\n}\n\n// Remove markdown fences or stray text before/after JSON\naiText = aiText\n  .replace(/^```(?:json)?/i, '')  // remove ```json or ```\n  .replace(/```$/i, '')           // remove trailing ```\n  .replace(/^[^{[]+/, '')         // remove anything before { or [\n  .replace(/[^}\\]]+$/, '');       // remove anything after } or ]\n\nconst parsed = tryParseJSON(aiText);\nappendLogSafe('üìù Parsing AI response and extracting fields...');\n\n// --- Debug helper: split long AI responses safely for logging ---\nfunction logLong_(label, text) {\n  const chunkSize = 9000; // avoid truncation in Apps Script logs\n  for (let i = 0; i < text.length; i += chunkSize) {\n    Logger.log(`${label} [${i / chunkSize + 1}]:\\n` + text.slice(i, i + chunkSize));\n  }\n}\n\nif (!parsed || typeof parsed !== 'object') {\n  logLong(`‚ùå Row ${inputRow} ‚Äî AI raw output`, typeof aiResp === 'string' ? aiResp : JSON.stringify(aiResp, null, 2));\n  appendLogSafe(`‚ùå Row ${inputRow}: AI JSON parse fail. See full output above.`);\n  return { error: true, message: `Row ${inputRow}: AI JSON parse fail.` };\n}\n\nappendLogSafe(`ü§ñ AI response parsed successfully for Row ${inputRow}`);\n\n// --- Validate/normalize vitals across any key containing 'vitals' or 'monitor' ---\nconst vitalsCheck = validateVitalsFields_(parsed, mergedKeys);\nif (!vitalsCheck.valid) {\n  const warnText = vitalsCheck.warnings.join(' | ');\n  Logger.log('‚ö†Ô∏è Vitals/Monitor validation: ' + warnText);\n  appendLogSafe('‚ö†Ô∏è ' + warnText);\n}\n\n// Log parsed field count for transparency\nLogger.log(`‚úÖ Parsed ${Object.keys(parsed).length} keys for Row ${inputRow}`);\n\n  // --- Apply clinical defaults for missing vitals ---\n  applyClinicalDefaults_(parsed, mergedKeys);\n\n  // --- Compact vitals if needed (object -> one-line JSON) ---\nmergedKeys.forEach(k => {\n  if (/vitals|monitor/i.test(k)) {\n    if (parsed[k] && typeof parsed[k] === 'object') parsed[k] = JSON.stringify(parsed[k]);\n    if (typeof parsed[k] === 'string') parsed[k] = parsed[k].trim();\n  }\n});\n    // --- Inject Image Sync defaults if empty ---\n    const imgDefaults = JSON.parse(getProp(SP_KEYS.IMG_SYNC_DEFAULTS, '{}') || '{}');\n    Object.keys(parsed).forEach(k => {\n      if (/^Image_Sync:/i.test(k)) {\n        const v = parsed[k];\n        if (v === undefined || v === null || v === '') {\n          if (imgDefaults[k] !== undefined) parsed[k] = imgDefaults[k];\n        }\n      }\n    });\n\n// --- Build output row (intelligent tiered matching) ---\nconst rowValues = mergedKeys.map(k => {\n  const val = extractValueFromParsed_(parsed, k);\n  return (val !== undefined && val !== null && String(val).trim() !== '') ? val : 'N/A';\n});\n\n// --- Store signature in meta column (if Conversion_Status exists) ---\nconst metaIdx = header2.indexOf('Conversion_Status');\nif (metaIdx > -1) {\n  const k = `${header1[metaIdx]}:${header2[metaIdx]}`;\n  const idx = mergedKeys.indexOf(k);\n  if (idx > -1) {\n    rowValues[idx] = (rowValues[idx] && rowValues[idx] !== 'N/A') ? `${rowValues[idx]} | ${sig}` : sig;\n  }\n}\n\n\n\n\n\n// --- Append row ---\nappendLogSafe(`üì§ Writing results for Row ${inputRow} to \"${outputSheet.getName()}\"`);\nappendLogSafe('üíæ Writing scenario to Master Scenario Convert...');\noutputSheet.appendRow(rowValues);\nappendLogSafe('‚úÖ Row created successfully');\nappendLogSafe(`‚úÖ Row ${inputRow} successfully written to sheet.`);\n// --- Always log parsed keys to sidebar for transparency ---\ntry {\n  const keys = Object.keys(parsed || {});\n  const naCount = rowValues.filter(v => v === 'N/A').length;\n  const naRatio = naCount / (rowValues.length || 1);\n  const missingKeys = mergedKeys.filter(k => !keys.includes(k));\n  const preview = JSON.stringify(parsed, null, 2).slice(0, 400); // short snippet\n\n  let message = `üìÑ Row ${inputRow} summary:\\n`;\n  message += `Detected keys: ${keys.join(', ') || 'none'}\\n`;\n  message += missingKeys.length ? `Missing keys: ${missingKeys.join(', ')}\\n` : '';\n  message += `N/A ratio: ${(naRatio * 100).toFixed(0)}%\\n`;\n  message += `Preview:\\n${preview}`;\n\n  if (typeof appendLog === 'function') appendLog(message);\n  Logger.log(message);\n} catch (debugErr) {\n  Logger.log('Debug logging failed: ' + debugErr);\n}\n\n// --- Skip quality scoring if row is empty or all N/A ---\nif (!rowValues || rowValues.every(v => v === 'N/A')) {\n  Logger.log(`‚ö†Ô∏è Skipping quality scoring for Row ${inputRow}: all N/A`);\n  return { created: true, message: `Row ${inputRow}: Created (all N/A)` };\n}\n\n    // --- Quality scoring + suggestions ---\n    try {\n      const { header1, header2 } = getCachedHeadersOrRead(outputSheet);\n      const mergedKeys = mergedKeysFromTwoTiers_(header1, header2);\n      const newRowIndex = outputSheet.getLastRow();\n      const quality = evaluateSimulationQuality(rowValues, mergedKeys);\n      attachQualityToRow_(outputSheet, newRowIndex, mergedKeys, rowValues, quality);\n    } catch (_) {\n      // Non-fatal: quality write is best-effort\n    }\n\n    // --- Cost estimate ---\n    const cost = estimateCostUSD(systemPrompt, aiText);\n    return { created: true, message: `Row ${inputRow}: Created. (~$${cost.toFixed(2)})`, cost };\n\n  } catch (e) {\n    return { error: true, message: `Row ${inputRow}: Error ‚Äî ${e.message}` };\n  }\n} // closes processOneInputRow_()\n\n\n// ========== 6) ATSR ‚Äî Titles & Summary (Keep & Regenerate, Deselect, Memory) ==========\n\nfunction runATSRTitleGenerator(continueRow, keepSelections) {\n  const ss = SpreadsheetApp.getActive();\n  const sheet = pickMasterSheet_();\n  if (!sheet) { getSafeUi_().alert('‚ùå Master Scenario CSV not found.'); return; }\n\n  let row = continueRow;\n  const ui = getSafeUi_();\n  if (!row) {\n    const resp = ui.prompt('Enter the row number for ATSR:', ui.ButtonSet.OK_CANCEL);\n    if (resp.getSelectedButton() !== ui.Button.OK) return;\n    row = parseInt(resp.getResponseText(),10);\n  }\n  if (isNaN(row) || row < 3) { ui.alert('Row must be ‚â• 3.'); return; }\n\n  const headers = sheet.getRange(2,1,1,sheet.getLastColumn()).getValues()[0];\n  const values  = sheet.getRange(row,1,1,sheet.getLastColumn()).getValues()[0];\n  const data = Object.fromEntries(headers.map((h,i)=>[h, values[i]]));\n\n  // Limit context to avoid token overflow\n  const usedMemory = getProp(SP_KEYS.USED_MOTIFS,'').substring(0, 300);\n\n  // Extract only essential fields for ATSR generation\n  const age = data['Patient_Demographics_and_Clinical_Data_Age'] || '';\n  const gender = data['Patient_Demographics_and_Clinical_Data_Gender'] || '';\n  const presenting = data['Patient_Demographics_and_Clinical_Data_Presenting_Complaint'] || '';\n  const vignette = data['Set_the_Stage_Context_Clinical_Vignette'] || '';\n  const why = data['Set_the_Stage_Context_Why_It_Matters'] || '';\n  const goal = data['Set_the_Stage_Context_Educational_Goal'] || '';\n\n  const caseDataFormatted = `\nAge: ${age}\nGender: ${gender}\nChief Complaint: ${presenting}\nClinical Vignette: ${vignette}\nEducational Goal: ${goal}\nWhy It Matters: ${why}`.trim();\n\n  // ========== ENHANCED RICH PROMPT WITH SIM MASTERY PHILOSOPHY ==========\n  const prompt = `\nüìò **Sim Mastery ATSR ‚Äî Automated Titles, Summary & Review Generator**\n\nYou are an expert simulation designer and marketing genius helping build **Sim Mastery** ‚Äî an emotionally resonant, AI-facilitated, high-fidelity emergency-medicine simulation platform.\n\nYour task is to create compelling, clinically accurate, and emotionally engaging titles and summaries for a medical simulation case that will be used by emergency medicine clinicians to sharpen their real-time decision-making skills.\n\n---\n\n## üß† **Core Philosophy: Sim Mastery Values**\n\n‚Ä¢ **Emotionally Resonant**: Help learners *feel* what it's like to manage chaos and experience triumph\n‚Ä¢ **Clinically Sound**: Every detail must be medically accurate and educationally valuable\n‚Ä¢ **Narratively Immersive**: Create intrigue, tension, and curiosity\n‚Ä¢ **Human-Centered**: Focus on the person behind the patient, not just the diagnosis\n‚Ä¢ **Growth-Oriented**: Support learner development through challenge and success\n‚Ä¢ **Professionally Warm**: Fun yet respectful of medicine's seriousness\n\n---\n\n## üéØ **Your Task: Create 4 Components**\n\n### 1. **Spark Titles** (5 variations)\n**Purpose**: Pre-sim mystery teaser that sells the learning experience WITHOUT spoiling the diagnosis\n\n**Format**:\n\\`\"<Chief Complaint> (<Age Sex>): <Emotionally Urgent Spark Phrase>\"\\`\n\n**Examples**:\n‚úÖ \"Chest Pain (47 M): Dizzy, Sweaty, and Terrified\"\n‚úÖ \"Shortness of Breath (5 F): Gasping After Birthday Cake\"\n‚úÖ \"Abdominal Pain (28 F): Pregnant and Worsening Fast\"\n\n**Rules**:\n- NO diagnosis mentioned (no \"MI\", \"anaphylaxis\", \"appendicitis\")\n- Observable symptoms only (what you see/hear)\n- Emotionally urgent language (\"terrified\", \"gasping\", \"worsening\")\n- Human details (age, gender, context clues)\n- Create intrigue without spoiling the mystery\n\n**Quality Criteria**:\n- Would an EM clinician FEEL the urgency?\n- Does it create curiosity without revealing the answer?\n- Is it specific enough to paint a vivid picture?\n- Does it respect the patient's humanity?\n\n---\n\n### 2. **Reveal Titles** (5 variations)\n**Purpose**: Post-sim reinforcement that celebrates the diagnosis and learning objective\n\n**Format**:\n\\`\"<Diagnosis> (<Age Sex>): <Key Learning Objective or Clinical Pearl>\"\\`\n\n**Examples**:\n‚úÖ \"Acute MI (55 M): Recognizing Atypical Presentations\"\n‚úÖ \"Anaphylaxis (8 M): Epinephrine Technique Saves Lives\"\n‚úÖ \"Ectopic Pregnancy (28 F): The One Test You Can't Skip\"\n\n**Rules**:\n- Diagnosis IS revealed (this is post-sim)\n- Focus on the KEY teaching point or clinical pearl\n- Emphasize what the learner will MASTER\n- Clinical accuracy is critical\n- Actionable takeaway (not just knowledge, but skill)\n\n**Quality Criteria**:\n- Does it reinforce the critical learning objective?\n- Would the learner feel PROUD to have mastered this?\n- Is the clinical pearl specific and actionable?\n- Does it emphasize competence and growth?\n\n---\n\n\n\n### 3. **Memory Anchors** (10 unique, unforgettable patient identifiers)\n\n**Purpose**: Help clinicians remember patients the way ED doctors naturally do - by distinctive, memorable details.\n\n**Philosophy**: ED doctors don't remember patients by medical details. They remember:\n- \"The tall skinny guy in overalls\"\n- \"Lady who doesn't like to shave her legs\"\n- \"SVT patient who's actually the sleep medicine doctor at our hospital\"\n- \"Methadone patient with facial tattoos\"\n- \"Kind lady holding a book\"\n- \"Pleasant spouse who stood when I came in\"\n\n**Memory Anchor Categories & Examples**:\n\n**A) Visual Appearance**:\n- Very sweaty face, pale complexion\n- Faded grey shirt with coffee stain\n- Unkempt appearance with bag of clothes\n- Unusual hair color/style\n- Distinctive facial features\n- Visible tattoos (location/theme)\n- Piercings or jewelry\n\n**B) Apparel & Accessories**:\n- AC/DC \"Thunderstruck\" concert t-shirt\n- BYU baseball cap (clearly a die-hard fan)\n- Sports team jersey (Lakers, Yankees, etc.)\n- Medical scrubs (works in healthcare)\n- Business suit (professional)\n- Vintage band t-shirt\n- Designer purse/bag\n- Small dog in carrier\n\n**C) Olfactory (Smell)**:\n- Pungent body odor\n- Heavy perfume/cologne\n- Cigarette smoke smell\n- Alcohol on breath\n- Fresh coffee smell\n\n**D) Behavioral/Personality**:\n- Annoyingly loud 3-year-old screaming in corner\n- Quiet and withdrawn, avoiding eye contact\n- Extremely talkative\n- Constantly on phone\n- Reading a specific book\n- Doing crossword puzzle\n- Nervous hand-wringing\n\n**E) Family/Social Context**:\n- Twin kids with patient\n- Huge family of 8 in the room\n- Daughter is an ER nurse (specify specialty)\n- Son translating (language barrier)\n- Service dog present\n- Worried spouse holding hand\n- Teenager rolling eyes\n\n**F) Occupation Clues**:\n- Carpenter (sawdust on clothes)\n- Teacher (grading papers)\n- Chef (kitchen burns on hands)\n- Nurse (works at same hospital)\n- Construction worker (hard hat)\n\n**G) Contextual/Situational**:\n- Came directly from gym\n- Still in pajamas at 3pm\n- Wearing hiking gear\n- Wedding ring tan line (divorced)\n- Military uniform/veteran\n\n**Rules for Memory Anchors**:\n1. **Highly specific**: \"BYU baseball cap\" not \"wearing a hat\"\n2. **Memorable**: Strong visual/sensory detail\n3. **Diverse**: Mix categories (visual, smell, behavior, context)\n4. **Stereotype-aware**: Use stereotypes clinicians naturally use (tall, unkempt, loud, etc.)\n5. **Personality-focused**: Adds human dimension to medical encounter\n6. **Personality-rich**: Kind, pleasant, annoying, withdrawn, talkative\n7. **Unique per patient**: NO reuse of anchors across cases\n8. **Culturally varied**: Different ethnicities, backgrounds, professions\n9. **Medically neutral**: NOT about the diagnosis itself\n10. **Unforgettable**: Would make you say \"Oh yeah, I remember that patient!\"\n\n**Examples of STRONG Memory Anchors**:\n‚úÖ \"Very sweaty face, pale complexion, looks terrified\"\n‚úÖ \"Wearing AC/DC 'Thunderstruck' concert t-shirt, vintage 1990\"\n‚úÖ \"Annoyingly loud 3-year-old screaming in corner (mom looks exhausted)\"\n‚úÖ \"Pleasant elderly man who stood up to shake my hand with firm grip\"\n‚úÖ \"Strong smell of cigarette smoke, yellow-stained fingers, smoker's voice\"\n‚úÖ \"Daughter is an ICU nurse at University Hospital (asking detailed questions)\"\n‚úÖ \"Huge family of 8 people crowding tiny room (all talking at once)\"\n‚úÖ \"Small yappy Chihuahua in designer Louis Vuitton purse (won't stop barking)\"\n‚úÖ \"Wearing faded grey 'World's Best Grandpa' shirt with coffee stain\"\n‚úÖ \"BYU baseball cap (clearly die-hard fan, keeps talking about last game)\"\n\n**Examples of WEAK Memory Anchors** (avoid these):\n‚ùå \"Middle-aged male\"\n‚ùå \"Overweight\"\n‚ùå \"Has diabetes\"\n‚ùå \"Chest pain patient\"\n‚ùå \"Anxious\"\n\n**Output Format**:\nProvide 10 Memory Anchors that:\n- Are ALL different categories/types\n- Are ALL unforgettable\n- Are ALL specific and vivid\n- Avoid reusing any motifs from: ${usedMemory}\n- Create unique, case-appropriate memory anchors based on the case data above\n\n**Quality Check**:\n- Would an ED doctor remember this patient by this detail? ‚úÖ\n- Is it vivid enough to picture in your mind? ‚úÖ\n- Is it different from the other 9 anchors? ‚úÖ\n- Does it add personality to the encounter? ‚úÖ\n\n---\n### 4. **Case Summary** (Structured narrative)\n**Purpose**: Concise, compelling summary that sells the value and humanizes the patient\n\n**Components**:\n\n**A) Patient_Summary** (3 sentences - CLINICAL HANDOFF STYLE):\n- Write like an ED doctor admitting to a hospitalist\n- GET TO THE POINT - diagnosis, presentation, key findings, disposition\n- NO mystery, NO drama - just the clinical facts\n- Include: chief complaint, vitals/exam findings, workup/diagnosis, management/disposition\n\n**Examples**:\n‚úÖ \"55M presents with acute substernal chest pain while shoveling snow. EKG shows STEMI, troponin elevated. Cath lab activated, given aspirin/heparin, admitted to CCU.\"\n‚úÖ \"8M with anaphylaxis after peanut exposure at birthday party. Presented with facial swelling, stridor, hypotension. IM epi given x2, improved, admitted for observation.\"\n‚úÖ \"72F fell at home, hip pain, unable to bear weight. X-ray confirms femoral neck fracture. Orthopedics consulted, scheduled for ORIF in AM.\"\n\n**B) Key_Intervention** (Short phrase):\n- The ONE action that changes the outcome\n- Specific, actionable, memorable\n- Focus on WHAT to do, not just WHY\n\n**Examples**:\n‚úÖ \"Immediate epinephrine (correct IM technique)\"\n‚úÖ \"Early aspirin + cath lab activation\"\n‚úÖ \"Surgical consult within 2 hours\"\n\n**C) Core_Takeaway** (Short phrase):\n- The clinical pearl they'll remember forever\n- Specific to THIS case\n- Actionable and confidence-building\n\n**Examples**:\n‚úÖ \"Atypical presentations kill‚Äîalways consider cardiac\"\n‚úÖ \"Epi first, questions later‚Äîtiming saves lives\"\n‚úÖ \"Beta-hCG in all women of childbearing age\"\n\n**D) Defining_Characteristic_Options** (5 unique, humanizing details):\n- Patient descriptors that add humanity and memorability\n- Avoid clich√©s and overused motifs\n- Make each case feel REAL and distinct\n- Mix physical, emotional, and contextual details\n\n**Examples**:\n‚úÖ \"Retired firefighter who's 'never been sick a day in his life'\"\n‚úÖ \"Soccer mom rushing from practice still in her coaching gear\"\n‚úÖ \"College student studying for finals, chugging energy drinks\"\n‚úÖ \"Grandmother who walked 3 blocks to the ED because she 'didn't want to bother anyone'\"\n‚úÖ \"Construction worker who delayed coming in because he 'thought it was just heartburn'\"\n\n**Rules for Defining Characteristics**:\n- Avoid motifs already used: ${usedMemory}\n- Each one should paint a distinct picture\n- Balance vulnerability with strength\n- Include context clues (occupation, activity, mindset)\n- Make the learner CARE about the patient\n\n---\n\n## üìã **Context from This Case**\n\n**Case Data** (Header: Value pairs from Google Sheet):\n${caseDataFormatted}\n\n**Motifs Already Used** (avoid these):\n${usedMemory || 'None yet'}\n\n---\n\n## üé® **Tone & Style Guidelines**\n\n**DO**:\n‚úÖ Use emotionally urgent language (\"terrified\", \"gasping\", \"worsening fast\")\n‚úÖ Focus on observable symptoms and human context\n‚úÖ Create intrigue and tension in Spark Titles\n‚úÖ Emphasize mastery and clinical pearls in Reveal Titles\n‚úÖ Make every detail clinically accurate and educationally sound\n‚úÖ Humanize the patient with specific, memorable details\n‚úÖ Paint vivid pictures that make the learner FEEL the scenario\n‚úÖ Use professional medical terminology appropriately\n\n**DON'T**:\n‚ùå Spoil the diagnosis in Spark Titles\n‚ùå Use clich√©s or overused phrases\n‚ùå Include medical jargon that obscures the human story\n‚ùå Create generic, forgettable descriptions\n‚ùå Duplicate existing motifs or patterns\n‚ùå Sacrifice clinical accuracy for drama\n‚ùå Make light of serious medical situations\n\n---\n\n## üß™ **Quality Checklist**\n\nBefore finalizing your output, verify:\n\n**Spark Titles**:\n- [ ] NO diagnosis revealed\n- [ ] Emotionally urgent and engaging\n- [ ] Observable symptoms only\n- [ ] Creates curiosity and tension\n- [ ] Human context included\n\n**Reveal Titles**:\n- [ ] Diagnosis clearly stated\n- [ ] Key learning objective emphasized\n- [ ] Actionable clinical pearl\n- [ ] Reinforces competence and mastery\n- [ ] Clinically accurate\n\n**Case IDs**:\n- [ ] Correct format (7-8 chars)\n- [ ] System prefix matches case\n- [ ] Uppercase letters + digits\n- [ ] Unique and memorable\n- [ ] No duplication\n\n**Case Summary**:\n- [ ] Patient_Summary paints vivid picture\n- [ ] Key_Intervention is specific and actionable\n- [ ] Core_Takeaway is memorable and valuable\n- [ ] Defining_Characteristics are unique and humanizing\n- [ ] No clich√©s or overused motifs\n- [ ] Emotionally resonant and clinically sound\n\n---\n\n## üì§ **Output Format (JSON)**\n\n{\n  \"Spark_Titles\": [\n    \"<Symptom> (<Age Sex>): <Spark Phrase>\",\n    \"<Symptom> (<Age Sex>): <Spark Phrase>\",\n    \"<Symptom> (<Age Sex>): <Spark Phrase>\",\n    \"<Symptom> (<Age Sex>): <Spark Phrase>\",\n    \"<Symptom> (<Age Sex>): <Spark Phrase>\"\n  ],\n  \"Reveal_Titles\": [\n    \"<Diagnosis> (<Age Sex>): <Learning Objective>\",\n    \"<Diagnosis> (<Age Sex>): <Learning Objective>\",\n    \"<Diagnosis> (<Age Sex>): <Learning Objective>\",\n    \"<Diagnosis> (<Age Sex>): <Learning Objective>\",\n    \"<Diagnosis> (<Age Sex>): <Learning Objective>\"\n  ],\n  \"Memory_Anchors\": [\n    \"Unforgettable patient detail #1\",\n    \"Unforgettable patient detail #2\",\n    \"Unforgettable patient detail #3\",\n    \"Unforgettable patient detail #4\",\n    \"Unforgettable patient detail #5\",\n    \"Unforgettable patient detail #6\",\n    \"Unforgettable patient detail #7\",\n    \"Unforgettable patient detail #8\",\n    \"Unforgettable patient detail #9\",\n    \"Unforgettable patient detail #10\"\n  ],\n  \"Case_Summary\": {\n    \"Patient_Summary\": \"A vivid 1-2 sentence description combining clinical urgency with human context, painting a clear picture of the scenario.\",\n    \"Key_Intervention\": \"The ONE specific action that changes the outcome\",\n    \"Core_Takeaway\": \"The clinical pearl they'll remember forever\",\n    \"Defining_Characteristic_Options\": [\n      \"Unique humanizing detail #1\",\n      \"Unique humanizing detail #2\",\n      \"Unique humanizing detail #3\",\n      \"Unique humanizing detail #4\",\n      \"Unique humanizing detail #5\"\n    ]\n  }\n}\n\n---\n\n## üéØ **Final Reminder: The Sim Mastery Standard**\n\nYou're not just creating titles and summaries‚Äîyou're crafting learning experiences that will stay with clinicians throughout their careers. Every word matters. Every detail should serve both the educational objective AND the emotional resonance.\n\nMake this case:\n‚Ä¢ Unforgettable\n‚Ä¢ Clinically impeccable\n‚Ä¢ Emotionally powerful\n‚Ä¢ Educationally transformative\n\nNow create your output. Make it AMAZING. üöÄ\n`;\n\n  // ========== END OF ENHANCED PROMPT ==========\n\n  Logger.log('üìä Prompt length: ' + prompt.length + ' characters');\n  Logger.log('üìä Case data length: ' + caseDataFormatted.length + ' characters');\n\n  const ai = callOpenAI(prompt, 0.7); // Temperature 0.7 for creative but consistent output\n  Logger.log('üìù AI response length: ' + ai.length + ' characters');\n  Logger.log('üìù AI response preview: ' + ai.substring(0, 500));\n\n  const parsed = parseATSRResponse_(ai);\n  if (!parsed) {\n    Logger.log('‚ùå Failed to parse AI response');\n    ui.alert('‚ö†Ô∏è ATSR parse error:\\n'+ai.substring(0, 1000));\n    return;\n  }\n\n  Logger.log('‚úÖ Parsed keys: ' + Object.keys(parsed).join(', '));\n\n  const html = buildATSRUltimateUI_(row, parsed, keepSelections, data);\n  ui.showModalDialog(HtmlService.createHtmlOutput(html).setWidth(1400).setHeight(900), ' ');\n}\n\n\n\nfunction buildATSRUltimateUI_(row, parsed, keepSelections, data) {\n  // Helper: Create editable radio options with text input\n  const makeEditable = (vals, name, label) => `\n    <div class=\"section\">\n      <h3>${label}</h3>\n      <div class=\"options\">\n        ${vals.map((v,i)=>`\n          <div class=\"option-row\">\n            <input type=\"radio\" name=\"${name}\" value=\"${i}\" id=\"${name}_${i}\" ${(keepSelections && i===0)?'checked':''}>\n            <input type=\"text\" id=\"${name}_text_${i}\" value=\"${String(v).replace(/\"/g,'&quot;')}\" class=\"edit-field\">\n          </div>\n        `).join('')}\n        <div class=\"option-row no-change\">\n          <input type=\"radio\" name=\"${name}\" value=\"nochange\" id=\"${name}_nochange\">\n          <label for=\"${name}_nochange\">üü¶ No Change (keep current)</label>\n        </div>\n      </div>\n    </div>\n  `;\n\n  const ps = parsed.Case_Summary?.Patient_Summary || 'A patient was evaluated and managed for an acute condition requiring urgent care.';\n  const ki = parsed.Case_Summary?.Key_Intervention || 'N/A';\n  const ct = parsed.Case_Summary?.Core_Takeaway || 'N/A';\n\n  // Extract diagnosis from Reveal_Title (before the colon)\n  let diagnosis = 'Diagnosis Unknown';\n  const revealTitle = data['Case_Organization_Reveal_Title'];\n  if (revealTitle) {\n    // Format: \"Severe Asthma Exacerbation (8 M): Swift Action Required\"\n    // Extract: \"Severe Asthma Exacerbation\"\n    const match = revealTitle.match(/^([^(]+)/);\n    if (match) {\n      diagnosis = match[1].trim();\n    }\n  }\n\n  return `\n  <!DOCTYPE html>\n  <html>\n  <head>\n    <style>\n      * { box-sizing: border-box; }\n      body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;\n        margin: 0;\n        background: #f5f7fa;\n        color: #2c3e50;\n        font-size: 14px;\n      }\n      .container {\n        padding: 8px 20px 16px 20px;\n        max-width: 1400px;\n        margin: 0 auto;\n      }\n      .summary-card {\n        background: #ffffff;\n        border: 1px solid #cbd5e0;\n        border-radius: 8px;\n        padding: 20px;\n        margin-bottom: 20px;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n        max-width: 700px;\n      }\n      .summary-card h2 {\n        margin: 0 0 12px 0;\n        font-size: 18px;\n        color: #1a202c;\n        font-weight: 600;\n      }\n      .summary-text {\n        font-size: 15px;\n        line-height: 1.6;\n        color: #2d3748;\n        margin-bottom: 16px;\n      }\n      .summary-details {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 16px;\n        padding: 16px;\n        background: #f7fafc;\n        border-radius: 6px;\n        border-left: 4px solid #3b82f6;\n      }\n      .detail-item {\n        font-size: 14px;\n      }\n      .detail-item strong {\n        color: #1a202c;\n        display: block;\n        margin-bottom: 4px;\n      }\n      .grid-3 {\n        display: grid;\n        grid-template-columns: repeat(3, 1fr);\n        gap: 20px;\n        margin-bottom: 20px;\n      }\n      .section {\n        background: #ffffff;\n        border: 1px solid #cbd5e0;\n        border-radius: 8px;\n        padding: 16px;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n      }\n      .section h3 {\n        margin: 0 0 14px 0;\n        font-size: 15px;\n        font-weight: 600;\n        color: #1a202c;\n        padding-bottom: 10px;\n        border-bottom: 2px solid #e2e8f0;\n      }\n      .options {\n        display: flex;\n        flex-direction: column;\n        gap: 10px;\n      }\n      .option-row {\n        display: flex;\n        align-items: center;\n        gap: 8px;\n        padding: 4px 6px;\n        border-radius: 4px;\n        transition: background 0.2s;\n      }\n      .option-row:hover {\n        background: #f7fafc;\n      }\n      .option-row.no-change {\n        margin-top: 8px;\n        padding-top: 12px;\n        border-top: 1px solid #e2e8f0;\n      }\n      .option-row input[type=\"radio\"] {\n        flex-shrink: 0;\n        width: 18px;\n        height: 18px;\n        cursor: pointer;\n      }\n      .edit-field {\n        flex: 1;\n        padding: 6px 10px;\n        border: 1px solid #cbd5e0;\n        border-radius: 6px;\n        font-size: 13px;\n        background: #ffffff;\n        color: #2c3e50;\n        transition: border-color 0.2s, box-shadow 0.2s;\n      }\n      .edit-field:focus {\n        outline: none;\n        border-color: #3b82f6;\n        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);\n      }\n      .actions {\n        background: #ffffff;\n        border: 1px solid #cbd5e0;\n        border-radius: 8px;\n        padding: 20px;\n        display: flex;\n        gap: 12px;\n        justify-content: center;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n      }\n      button {\n        padding: 12px 24px;\n        border: none;\n        border-radius: 6px;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n      .btn-primary {\n        background: #3b82f6;\n        color: white;\n      }\n      .btn-primary:hover {\n        background: #2563eb;\n        transform: translateY(-1px);\n        box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n      }\n      .btn-secondary {\n        background: #10b981;\n        color: white;\n      }\n      .btn-secondary:hover {\n        background: #059669;\n        transform: translateY(-1px);\n        box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n      }\n      .btn-tertiary {\n        background: #6366f1;\n        color: white;\n      }\n      .btn-tertiary:hover {\n        background: #4f46e5;\n        transform: translateY(-1px);\n        box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n      }\n      .btn-close {\n        background: #e2e8f0;\n        color: #475569;\n      }\n      .btn-close:hover {\n        background: #cbd5e0;\n      }\n    </style>\n  </head>\n  <body>\n    <div class=\"container\">\n      <div class=\"summary-card\">\n        <div style=\"margin-bottom: 4px; font-size: 13px; color: #64748b; font-weight: 500;\">Case Summary:</div>\n        <div style=\"font-size: 26px; font-weight: 700; color: #1a202c; margin-bottom: 16px; line-height: 1.2;\">${diagnosis}</div>\n        <ul style=\"list-style-type: disc; margin: 0; padding-left: 20px; line-height: 1.7;\">\n          <li style=\"margin-bottom: 10px; color: #2d3748; font-size: 14px;\">${ps}</li>\n          <li style=\"color: #2d3748; font-size: 14px;\">${ct}</li>\n        </ul>\n      </div>\n\n      <div class=\"grid-3\">\n        ${makeEditable(parsed.Spark_Titles||[], 'spark', 'üî• Spark Titles (Pre-Sim Mystery)')}\n        ${makeEditable(parsed.Reveal_Titles||[], 'reveal', 'üíé Reveal Titles (Post-Sim Learning)')}\n        ${makeEditable(parsed.Memory_Anchors||[], 'anchor', 'üé≠ Memory Anchors (Unforgettable Patient Details)')}\n      </div>\n\n      <div class=\"actions\">\n        <button class=\"btn-primary\" onclick=\"apply(false)\">‚úÖ Save & Close</button>\n        <button class=\"btn-secondary\" onclick=\"apply(true)\">‚è≠Ô∏è Save & Continue</button>\n        <button class=\"btn-tertiary\" onclick=\"keepRegen()\">üîÅ Keep & Regenerate</button>\n        <button class=\"btn-close\" onclick=\"google.script.host.close()\">‚ùå Close</button>\n      </div>\n    </div>\n\n    <script>\n      function getTxt(name) {\n        const selected = document.querySelector('input[name=\"'+name+'\"]:checked');\n        if (!selected || selected.value === 'nochange') return 'nochange';\n        const idx = selected.value;\n        const textField = document.getElementById(name+'_text_'+idx);\n        return textField ? textField.value : 'nochange';\n      }\n\n      function apply(continueNext) {\n        const data = {\n          spark: getTxt('spark'),\n          reveal: getTxt('reveal'),\n          anchor: getTxt('anchor'),\n          continueNext: continueNext\n        };\n        google.script.run\n          .withSuccessHandler(()=>{\n            if(continueNext) {\n              google.script.run.runATSRTitleGenerator(${row+1}, true);\n            } else {\n              google.script.host.close();\n            }\n          })\n          .saveATSRData(${row}, data);\n      }\n\n      function keepRegen() {\n        google.script.host.close();\n        google.script.run.runATSRTitleGenerator(${row}, true);\n      }\n    </script>\n  </body>\n  </html>\n  `;\n}\n\nfunction applyATSRSelectionsWithDefiningAndMemory(row, spark, reveal, caseID, define) {\n  const s = pickMasterSheet_();\n  const headers = s.getRange(2,1,1,s.getLastColumn()).getValues()[0];\n\n  const setVal = (key, val, append=false) => {\n    if (!val || val==='nochange') return;\n    const idx = headers.indexOf(key);\n    if (idx<0) return;\n    const r = s.getRange(row, idx+1);\n    if (append) {\n      const ex = r.getValue();\n      r.setValue(ex ? (ex + ' ' + val) : val);\n    } else r.setValue(val);\n  };\n\n  setVal('Spark_Title',   spark);\n  setVal('Reveal_Title',  reveal);\n  setVal('Patient_Descriptor', define, true);\n\n  if (define && define!=='nochange') {\n    const memKey = SP_KEYS.USED_MOTIFS;\n    const prev = getProp(memKey,'');\n    const motif = define.toLowerCase().split(' ').slice(0,3).join(' ');\n    if (!prev.includes(motif)) setProp(memKey, prev ? (prev+', '+motif) : motif);\n  }\n\n  SpreadsheetApp.getActive().toast('‚úÖ ATSR saved.');\n}\n\nfunction pickMasterSheet_() {\n  const ss = SpreadsheetApp.getActive();\n  // Prefer last used output\n  const last = getProp(SP_KEYS.LAST_OUTPUT_SHEET, '');\n  if (last) {\n    const s = ss.getSheetByName(last);\n    if (s) return s;\n  }\n  // Else prefer sheet named like Master Scenario CSV\n  const m = ss.getSheets().find(sh=>/master scenario csv/i.test(sh.getName()));\n  return m || ss.getActiveSheet();\n}\n\n// Auto-bold key phrases in summary lines\nfunction autoBoldSummary_(summary, key, take) {\n  function boldPhrase(s) {\n    if (!s) return 'N/A';\n    // Bold up to the colon if present; else first 2‚Äì3 words\n    const parts = s.split(':');\n    if (parts.length>1) return `<strong>${parts[0]}</strong>:` + parts.slice(1).join(':');\n    const words = s.split(' ');\n    const head = words.slice(0,3).join(' ');\n    return `<strong>${head}</strong> ${words.slice(3).join(' ')}`.trim();\n  }\n  return { summary, key: boldPhrase(key), take: boldPhrase(take) };\n}\n\n\n// ========== 7) IMAGE SYNC DEFAULTS MANAGER ==========\n\nfunction openImageSyncDefaults() {\n  const s = pickMasterSheet_();\n  const {header1, header2} = getCachedHeadersOrRead(s);\n  const keys = header1.map((t1,i)=>`${t1}:${header2[i]}`).filter(k=>/^Image_Sync:/i.test(k));\n\n  const current = JSON.parse(getProp(SP_KEYS.IMG_SYNC_DEFAULTS, '{}') || '{}');\n  const rows = keys.map(k=>{\n    const v = (current[k]!==undefined) ? current[k] : '';\n    return `<tr><td>${k}</td><td><input data-k=\"${k}\" value=\"${String(v).replace(/\"/g,'&quot;')}\" style=\"width:100%\"></td></tr>`;\n  }).join('');\n\n  const html = HtmlService.createHtmlOutput(`\n  <style>\n    body{font-family:Arial;background:#f5f7fa;color:#2c3e50}\n    table{width:100%;border-collapse:collapse}\n    td,th{border:1px solid #dfe3e8;padding:8px}\n    .bar{padding:14px 16px;background:#1b1f2a;border-bottom:1px solid #dfe3e8}\n    button{background:#2357ff;border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}\n  </style>\n  <div class=\"bar\"><h3>${ICONS.frame} Image Sync Defaults</h3></div>\n  <div style=\"padding:12px;\">\n    <p class=\"hint\">Edit defaults per <code>Image_Sync:*</code> column. Click Save to persist.</p>\n    <table>\n      <tr><th>Column</th><th>Default Value</th></tr>\n      ${rows || '<tr><td colspan=\"2\"><em>No Image_Sync columns detected.</em></td></tr>'}\n    </table>\n    <div style=\"margin-top:12px;\">\n      <button onclick=\"save()\">Save</button>\n      <button style=\"background:#dfe3e8\" onclick=\"refresh()\">Refresh Columns</button>\n    </div>\n  </div>\n  <script>\n    function save(){\n      const obj = {};\n      document.querySelectorAll('input[data-k]').forEach(inp=>{\n        obj[inp.getAttribute('data-k')] = inp.value;\n      });\n      google.script.run\n        .withSuccessHandler(()=>google.script.host.close())\n        .saveImageSyncDefaults(JSON.stringify(obj));\n    }\n    function refresh(){\n      google.script.run\n        .withSuccessHandler(()=>location.reload())\n        .refreshImageSyncHeaderCache();\n    }\n  </script>\n  `).setWidth(720).setHeight(560);\n\n  getSafeUi_().showModalDialog(html, 'üñº Image Sync Defaults');\n}\nfunction saveImageSyncDefaults(json) {\n  setProp(SP_KEYS.IMG_SYNC_DEFAULTS, json||'{}');\n  SpreadsheetApp.getActive().toast('‚úÖ Image Sync defaults saved.');\n}\nfunction refreshImageSyncHeaderCache() {\n  const s = pickMasterSheet_();\n  cacheHeaders(s);\n  SpreadsheetApp.getActive().toast('üîÅ Header cache refreshed.');\n}\n\n\n// ========== 8) MEMORY TRACKER ==========\n\nfunction openMemoryTracker() {\n  const mem = (getProp(SP_KEYS.USED_MOTIFS,'')||'').split(',').map(m=>m.trim()).filter(Boolean);\n  const list = mem.map((m,i)=>`<div><input type=\"checkbox\" id=\"m${i}\" checked> ${m}</div>`).join('');\n  const html = HtmlService.createHtmlOutput(`\n  <style>body{font-family:Arial;background:#f5f7fa;color:#2c3e50} button{background:#2357ff;border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}</style>\n  <div style=\"padding:16px;\">\n    <h3>${ICONS.puzzle} Memory Tracker</h3>\n    ${list || '<p><em>No motifs stored.</em></p>'}\n    <div style=\"margin-top:12px;\">\n      <button onclick=\"clearAll()\">üßπ Clear All</button>\n      <button style=\"background:#dfe3e8\" onclick=\"markReusable()\">‚ôªÔ∏è Mark Selected as Reusable</button>\n    </div>\n  </div>\n  <script>\n    function clearAll(){ google.script.run.withSuccessHandler(()=>google.script.host.close()).clearMotifMemory(); }\n    function markReusable(){\n      const unchecked=[];\n      document.querySelectorAll('input[type=checkbox]').forEach(c=>{ if(!c.checked) unchecked.push(c.nextSibling.textContent.trim()); });\n      google.script.run.withSuccessHandler(()=>google.script.host.close()).markMotifsReusable(unchecked);\n    }\n  </script>`).setWidth(520).setHeight(420);\n  getSafeUi_().showModalDialog(html, 'üß© Memory Tracker');\n}\nfunction clearMotifMemory(){ PropertiesService.getDocumentProperties().deleteProperty(SP_KEYS.USED_MOTIFS); SpreadsheetApp.getActive().toast('üßπ Memory cleared.'); }\nfunction markMotifsReusable(unchecked){ \n  const key = SP_KEYS.USED_MOTIFS;\n  const motifs = (getProp(key,'')||'').split(',').map(m=>m.trim()).filter(Boolean);\n  const kept = motifs.filter(m => unchecked.includes(m)===false);\n  setProp(key, kept.join(', '));\n  SpreadsheetApp.getActive().toast('‚ôªÔ∏è Selected motifs marked reusable.');\n}\n\n// ======================================================\n// HEADER MANAGEMENT + AUTO-RETRAIN MODULE (Sim Mastery)\n// ======================================================\n\n\n// ========== 1) REFRESH HEADERS (TRAIN STRUCTURE) ==========\nfunction refreshHeaders() {\n  const ui = getSafeUi_();\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const outputSheet = ss.getSheetByName(getProp('LAST_OUTPUT_SHEET') || 'Output');\n  if (!outputSheet) {\n    if (ui) { ui.alert('‚ùå Output sheet not found.'); }\n    return;\n  }\n\n  const header1 = outputSheet.getRange(1, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n  const header2 = outputSheet.getRange(2, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n  const mergedKeys = header1.map((t1, i) => `${t1}:${header2[i]}`.replace(/\\s+/g, '_'));\n\n  // Cache headers for future access\n  setProp('CACHED_HEADER1', JSON.stringify(header1));\n  setProp('CACHED_HEADER2', JSON.stringify(header2));\n  setProp('CACHED_MERGED_KEYS', JSON.stringify(mergedKeys));\n\n  if (getSafeUi_()) { getSafeUi_().alert(`‚úÖ Headers refreshed!\\n\\n${mergedKeys.length} merged keys cached.`); }\n}\n\n// ========== 2) AUTO-RETRAIN PROMPT STRUCTURE ==========\nfunction retrainPromptStructure() {\n  const ui = getSafeUi_();\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const outputSheet = ss.getSheetByName(getProp('LAST_OUTPUT_SHEET') || 'Output');\n  if (!outputSheet) {\n    if (ui) { ui.alert('‚ùå Output sheet not found.'); }\n    return;\n  }\n\n  const header1 = outputSheet.getRange(1, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n  const header2 = outputSheet.getRange(2, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n  const mergedKeys = header1.map((t1, i) => `${t1}:${header2[i]}`.replace(/\\s+/g, '_'));\n\n  // Cache structure\n  setProp('CACHED_HEADER1', JSON.stringify(header1));\n  setProp('CACHED_HEADER2', JSON.stringify(header2));\n  setProp('CACHED_MERGED_KEYS', JSON.stringify(mergedKeys));\n\n  // Build prompt training text\n  const promptIntro = `\nüìò Sim Mastery ‚Äî Auto-Trained Output Schema\nThis defines your authoritative JSON schema for all generated content.\n\nEach key must exactly match the merged Tier1:Tier2 form, using underscores (_) instead of spaces.\nWhen a value cannot be filled, output \"N/A\".\n\nTier1 Headers:\n${header1.join(', ')}\n\nTier2 Headers:\n${header2.join(', ')}\n\nMerged Keys (exact JSON keys required):\n${mergedKeys.join(', ')}\n`.trim();\n\n  setProp('CACHED_PROMPT_STRUCTURE', promptIntro);\n\n  if (ui) { ui.alert(`‚úÖ Prompt structure retrained!\\n\\n${mergedKeys.length} merged keys cached.\\nPrompt fragment stored for AI calls.`); }\n}\n\n// ========== 3) OPTIONAL: AUTO-CHECK BEFORE RUN ==========\nfunction ensureHeadersCached() {\n  const h = getProp('CACHED_HEADER1');\n  if (!h) {\n    refreshHeaders();\n    retrainPromptStructure();\n  }\n}\n\n\n\n\n\n\n\n// ========== 9) SETTINGS PANEL (Properties + Cache) ==========\n\nfunction openSettingsPanel() {\n  const api = getProp(SP_KEYS.API_KEY,'');\n  const model = getProp(SP_KEYS.MODEL, DEFAULT_MODEL);\n  const pIn = getProp(SP_KEYS.PRICE_INPUT, DEFAULT_PRICE.input);\n  const pOut= getProp(SP_KEYS.PRICE_OUTPUT, DEFAULT_PRICE.output);\n  const html = HtmlService.createHtmlOutput(`\n  <style>body{font-family:Arial;background:#f5f7fa;color:#2c3e50}\n  label{font-size:12px;color:#9aa3b2}\n  input,select{width:100%;background:#f5f7fa;border:1px solid #30384b;color:#2c3e50;border-radius:8px;padding:8px}\n  button{background:#2357ff;border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}\n  .card{background:#ffffff;border:1px solid #dfe3e8;border-radius:10px;padding:14px;margin:12px}\n  </style>\n  <div class=\"card\">\n    <h3>${ICONS.gear} Settings</h3>\n    <label>Model</label>\n    <input id=\"m\" value=\"${model}\">\n    <label style=\"margin-top:8px;\">API Key</label>\n    <input id=\"k\" value=\"${api ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : ''}\" placeholder=\"sk-...\">\n    <label style=\"margin-top:8px;\">Price Input per 1k</label>\n    <input id=\"pi\" value=\"${pIn}\">\n    <label style=\"margin-top:8px;\">Price Output per 1k</label>\n    <input id=\"po\" value=\"${pOut}\">\n    <div style=\"margin-top:10px;\">\n      <button onclick=\"save()\">Save</button>\n      <button style=\"background:#dfe3e8\" onclick=\"clearCache()\">Clear Header Cache</button>\n      <button style=\"background:#dfe3e8\" onclick=\"pull()\">Sync API from Settings sheet</button>\n    </div>\n  </div>\n  <script>\n    function save(){\n      const key = document.getElementById('k').value.trim();\n      google.script.run.saveSidebarBasics(\n        document.getElementById('m').value,\n        (key && key!=='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') ? key : '',\n        document.getElementById('pi').value.trim(),\n        document.getElementById('po').value.trim(),\n        '', ''\n      );\n      google.script.host.close();\n    }\n    function clearCache(){ google.script.run.withSuccessHandler(()=>alert('Cache cleared')).clearHeaderCache(); }\n    function pull(){ google.script.run.withSuccessHandler(()=>alert('API key synced from Settings sheet (if found).')).pullApiFromSettingsSheet(); }\n  </script>`).setWidth(520).setHeight(420);\n  getSafeUi_().showModalDialog(html, '‚öôÔ∏è Settings');\n}\n\nfunction pullApiFromSettingsSheet() {\n  const key = syncApiKeyFromSettingsSheet_();\n  if (key) setProp(SP_KEYS.API_KEY, key);\n}\n\n\n// ========== 10) MENU ==========\n\n\n\n/**\n * Categories & Pathways Panel - Light Theme (Classic Google Sheets Style)\n *\n * Clean, easy-to-read interface for managing categories and pathways\n * Light grey theme optimized for data manipulation\n */\n\n// ========== MAIN LAUNCHER ==========\n\nfunction openCategoriesPathwaysPanel() {\n  const ui = getSafeUi_();\n  if (!ui) return;\n\n  const html = buildCategoriesPathwaysMainMenu_();\n  ui.showSidebar(HtmlService.createHtmlOutput(html).setTitle('üìÇ Categories & Pathways').setWidth(320));\n}\n\n// ========== MAIN MENU ==========\n\nfunction buildCategoriesPathwaysMainMenu_() {\n  const sheet = pickMasterSheet_();\n  const data = sheet.getDataRange().getValues();\n  const headers = data[1]; // Row 2\n\n  // Get column indices\n  const categoryIdx = headers.indexOf('Case_Organization:Category');\n  const pathwayIdx = headers.indexOf('Case_Organization:Pathway_Name');\n  const sparkIdx = headers.indexOf('Case_Organization:Spark_Title');\n\n  // Count categories and pathways\n  const categoryCounts = {};\n  const pathwayCounts = {};\n\n  for (let i = 2; i < data.length; i++) {\n    const category = data[i][categoryIdx] || 'Uncategorized';\n    const pathway = data[i][pathwayIdx] || 'Unassigned';\n\n    categoryCounts[category] = (categoryCounts[category] || 0) + 1;\n    pathwayCounts[pathway] = (pathwayCounts[pathway] || 0) + 1;\n  }\n\n  const totalCases = data.length - 2;\n\n  // Build category list\n  const categoryList = Object.entries(categoryCounts)\n    .sort((a, b) => b[1] - a[1])\n    .map(([cat, count]) => `\n      <div class=\"list-item\" onclick=\"viewCategory('${cat.replace(/'/g, \"\\\\'\")}')\">\n        <span class=\"item-label\">${cat}</span>\n        <span class=\"item-count\">${count}</span>\n      </div>\n    `).join('');\n\n  // Build pathway list (top 10)\n  const pathwayList = Object.entries(pathwayCounts)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 10)\n    .map(([path, count]) => `\n      <div class=\"list-item\" onclick=\"viewPathway('${path.replace(/'/g, \"\\\\'\")}')\">\n        <span class=\"item-label\">${path}</span>\n        <span class=\"item-count\">${count}</span>\n      </div>\n    `).join('');\n\n  return `\n<!DOCTYPE html>\n<html>\n<head>\n  <base target=\"_top\">\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n\n    body {\n      font-family: Arial, sans-serif;\n      background: #f5f7fa;\n      color: #2c3e50;\n      font-size: 13px;\n    }\n\n    .header {\n      background: #fff;\n      padding: 16px;\n      border-bottom: 1px solid #dfe3e8;\n    }\n\n    .header h1 {\n      font-size: 16px;\n      font-weight: 600;\n      color: #2c3e50;\n      margin-bottom: 4px;\n    }\n\n    .header .subtitle {\n      font-size: 12px;\n      color: #7f8c9d;\n    }\n\n    .stats {\n      background: #fff;\n      padding: 12px 16px;\n      border-bottom: 1px solid #dfe3e8;\n      display: flex;\n      justify-content: space-around;\n    }\n\n    .stat {\n      text-align: center;\n    }\n\n    .stat .num {\n      font-size: 20px;\n      font-weight: 700;\n      color: #3b7ddd;\n      display: block;\n    }\n\n    .stat .label {\n      font-size: 11px;\n      color: #7f8c9d;\n      text-transform: uppercase;\n    }\n\n    .section {\n      background: #fff;\n      margin: 12px;\n      padding: 14px;\n      border-radius: 6px;\n      border: 1px solid #dfe3e8;\n    }\n\n    .section-title {\n      font-size: 13px;\n      font-weight: 600;\n      color: #2c3e50;\n      margin-bottom: 10px;\n      padding-bottom: 8px;\n      border-bottom: 1px solid #f0f2f5;\n    }\n\n    .btn {\n      display: block;\n      width: 100%;\n      background: #fff;\n      border: 1px solid #d1d7de;\n      color: #2c3e50;\n      padding: 10px 12px;\n      margin-bottom: 8px;\n      border-radius: 4px;\n      cursor: pointer;\n      text-align: left;\n      font-size: 13px;\n      transition: all 0.2s;\n    }\n\n    .btn:hover {\n      background: #f5f7fa;\n      border-color: #3b7ddd;\n    }\n\n    .btn-primary {\n      background: #3b7ddd;\n      color: #fff;\n      border-color: #3b7ddd;\n      font-weight: 600;\n    }\n\n    .btn-primary:hover {\n      background: #2d6bc6;\n    }\n\n    .list-item {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding: 8px 10px;\n      margin-bottom: 4px;\n      background: #f8f9fa;\n      border-radius: 4px;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n\n    .list-item:hover {\n      background: #e9ecef;\n    }\n\n    .item-label {\n      font-size: 13px;\n      color: #2c3e50;\n    }\n\n    .item-count {\n      font-size: 12px;\n      color: #7f8c9d;\n      background: #fff;\n      padding: 2px 8px;\n      border-radius: 10px;\n    }\n\n    .scrollable {\n      max-height: 200px;\n      overflow-y: auto;\n    }\n\n    .scrollable::-webkit-scrollbar {\n      width: 6px;\n    }\n\n    .scrollable::-webkit-scrollbar-track {\n      background: #f0f2f5;\n    }\n\n    .scrollable::-webkit-scrollbar-thumb {\n      background: #d1d7de;\n      border-radius: 3px;\n    }\n\n    .info {\n      background: #e8f4fd;\n      border: 1px solid #bee5eb;\n      padding: 10px 12px;\n      border-radius: 4px;\n      font-size: 12px;\n      color: #31708f;\n      margin-top: 12px;\n    }\n  </style>\n</head>\n<body>\n  <div class=\"header\">\n    <h1>üìÇ Categories & Pathways</h1>\n    <div class=\"subtitle\">Organize cases by system and learning path</div>\n  </div>\n\n  <div class=\"stats\">\n    <div class=\"stat\">\n      <span class=\"num\">${totalCases}</span>\n      <span class=\"label\">Cases</span>\n    </div>\n    <div class=\"stat\">\n      <span class=\"num\">${Object.keys(categoryCounts).length}</span>\n      <span class=\"label\">Categories</span>\n    </div>\n    <div class=\"stat\">\n      <span class=\"num\">${Object.keys(pathwayCounts).length}</span>\n      <span class=\"label\">Pathways</span>\n    </div>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Quick Actions</div>\n    <button class=\"btn\" onclick=\"viewAllCategories()\">üìä View All Categories</button>\n    <button class=\"btn\" onclick=\"viewAllPathways()\">üß© View All Pathways</button>\n    <button class=\"btn\" onclick=\"assignCase()\">üîó Assign Case to Category/Pathway</button>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Medical System Categories</div>\n    <div class=\"scrollable\">\n      ${categoryList || '<div class=\"info\">No categories found</div>'}\n    </div>\n  </div>\n\n  <div class=\"section\">\n    <div class=\"section-title\">Learning Pathways (Top 10)</div>\n    <div class=\"scrollable\">\n      ${pathwayList || '<div class=\"info\">No pathways found</div>'}\n    </div>\n    <button class=\"btn-primary btn\" onclick=\"viewAllPathways()\" style=\"margin-top:10px;\">View All Pathways</button>\n  </div>\n\n  <div class=\"info\">\n    üí° Click any category or pathway to view and edit cases\n  </div>\n\n  <script>\n    function viewCategory(category) {\n      google.script.run\n        .withSuccessHandler(updateContent)\n        .getCategoryView(category);\n    }\n\n    function viewPathway(pathway) {\n      google.script.run\n        .withSuccessHandler(updateContent)\n        .getPathwayView(pathway);\n    }\n\n    function viewAllCategories() {\n      google.script.run\n        .withSuccessHandler(updateContent)\n        .getAllCategoriesView();\n    }\n\n    function viewAllPathways() {\n      google.script.run\n        .withSuccessHandler(updateContent)\n        .getAllPathwaysView();\n    }\n\n    function assignCase() {\n      const row = prompt('Enter row number:');\n      if (row) {\n        google.script.run\n          .withSuccessHandler(updateContent)\n          .getCaseAssignmentView(parseInt(row));\n      }\n    }\n\n    function updateContent(html) {\n      document.body.innerHTML = html;\n    }\n\n    function goBack() {\n      google.script.run\n        .withSuccessHandler(updateContent)\n        .buildCategoriesPathwaysMainMenu_();\n    }\n  </script>\n</body>\n</html>\n  `;\n}\n\n// ========== VIEW FUNCTIONS ==========\n\nfunction getCategoryView(category) {\n  const sheet = pickMasterSheet_();\n  const data = sheet.getDataRange().getValues();\n  const headers = data[1];\n\n  const categoryIdx = headers.indexOf('Case_Organization:Category');\n  const sparkIdx = headers.indexOf('Case_Organization:Spark_Title');\n  const pathwayIdx = headers.indexOf('Case_Organization:Pathway_Name');\n\n  const cases = [];\n  for (let i = 2; i < data.length; i++) {\n    if (data[i][categoryIdx] === category) {\n      cases.push({\n        row: i + 1,\n        spark: data[i][sparkIdx] || 'Untitled',\n        pathway: data[i][pathwayIdx] || 'Unassigned'\n      });\n    }\n  }\n\n  const casesList = cases.map(c => `\n    <div class=\"list-item\">\n      <div>\n        <div style=\"font-weight:500;\">${c.spark}</div>\n        <div style=\"font-size:11px;color:#7f8c9d;margin-top:2px;\">Row ${c.row} ‚Ä¢ ${c.pathway}</div>\n      </div>\n    </div>\n  `).join('');\n\n  return `\n<!DOCTYPE html>\n<html>\n<head><base target=\"_top\">\n<style>\n  * { margin: 0; padding: 0; box-sizing: border-box; }\n  body { font-family: Arial, sans-serif; background: #f5f7fa; color: #2c3e50; font-size: 13px; }\n  .header { background: #fff; padding: 16px; border-bottom: 1px solid #dfe3e8; }\n  .header h1 { font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 4px; }\n  .header .subtitle { font-size: 12px; color: #7f8c9d; }\n  .section { background: #fff; margin: 12px; padding: 14px; border-radius: 6px; border: 1px solid #dfe3e8; }\n  .list-item { padding: 10px 12px; margin-bottom: 6px; background: #f8f9fa; border-radius: 4px; }\n  .btn { display: inline-block; background: #fff; border: 1px solid #d1d7de; color: #2c3e50; padding: 8px 14px; margin: 8px 4px; border-radius: 4px; cursor: pointer; font-size: 12px; text-decoration: none; }\n  .btn:hover { background: #f5f7fa; }\n  .scrollable { max-height: 400px; overflow-y: auto; }\n</style>\n</head>\n<body>\n  <div class=\"header\">\n    <h1>üìÇ ${category}</h1>\n    <div class=\"subtitle\">${cases.length} cases</div>\n  </div>\n  <div class=\"section\">\n    <div class=\"scrollable\">${casesList}</div>\n  </div>\n  <div style=\"padding:12px;\">\n    <button class=\"btn\" onclick=\"goBack()\">‚Üê Back to Menu</button>\n  </div>\n  <script>\n    function goBack() {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .buildCategoriesPathwaysMainMenu_();\n    }\n  </script>\n</body>\n</html>\n  `;\n}\n\nfunction getPathwayView(pathway) {\n  // Similar to category view\n  return getCategoryView(pathway); // Simplified for now\n}\n\nfunction getAllCategoriesView() {\n  // Grid of all categories\n  return buildCategoriesPathwaysMainMenu_();\n}\n\nfunction getAllPathwaysView() {\n  // Grid of all pathways\n  return buildCategoriesPathwaysMainMenu_();\n}\n\nfunction getCaseAssignmentView(row) {\n  // Assignment interface\n  return buildCategoriesPathwaysMainMenu_();\n}\n\n\n\n\nfunction saveATSRData(row, data) {\n  const ss = SpreadsheetApp.getActive();\n  const sheet = pickMasterSheet_();\n  if (!sheet) return;\n\n  const headers = sheet.getRange(2,1,1,sheet.getLastColumn()).getValues()[0];\n\n  const setCell = (colName, value) => {\n    const colIdx = headers.indexOf(colName);\n    if (colIdx === -1) return;\n    if (value !== 'nochange') {\n      sheet.getRange(row, colIdx + 1).setValue(value);\n    }\n  };\n\n  // Save selected values\n  setCell('Case_Organization:Spark_Title', data.spark);\n  setCell('Case_Organization:Reveal_Title', data.reveal);\n  setCell('Case_Organization:Memory_Anchor', data.anchor);\n\n  // Track used memory anchors for uniqueness\n  if (data.anchor !== 'nochange') {\n    const usedMemory = getProp(SP_KEYS.USED_MEMORY_ANCHORS, '');\n    const newUsed = usedMemory + ' | ' + data.anchor;\n    setProp(SP_KEYS.USED_MEMORY_ANCHORS, newUsed.substring(0, 5000)); // Keep last 5000 chars\n  }\n}\n\nfunction onOpen() {\n  const ui = getSafeUi_();\n  ui.createMenu('üß† Sim Builder')\n    .addItem(`${ICONS.rocket} Launch Batch / Single (Sidebar)`, 'openSimSidebar')\n    .addSeparator()\n    .addItem(`${ICONS.wand} ATSR ‚Äî Titles & Summary`, 'runATSRTitleGenerator')\n    .addItem('üìÇ Categories & Pathways', 'openCategoriesPathwaysPanel')\n    .addItem(`${ICONS.frame} Image Sync Defaults`, 'openImageSyncDefaults')\n    .addItem(`${ICONS.puzzle} Memory Tracker`, 'openMemoryTracker')\n    .addItem('üß™ Run Quality Audit (All / Specific Rows)', 'runQualityAudit_AllOrRows')\n    .addItem('üßπ Clean Up Low-Value Rows', 'cleanUpLowValueRows')\n    .addSeparator()\n    .addItem('üîÅ Refresh Headers', 'refreshHeaders')\n    .addItem('üß† Retrain Prompt Structure', 'retrainPromptStructure')\n    .addSeparator()\n    .addItem(`${ICONS.shield} Check API Status`, 'checkApiStatus')\n    .addItem(`${ICONS.gear} Settings`, 'openSettingsPanel')\n    .addToUi();\n  SpreadsheetApp.getActive().toast('‚úÖ Sim Builder menu loaded');\n}\n\n\n\n\n// ‚≠ê Sidebar Log Helpers\nfunction appendLogSafe(message) {\n  try {\n    const docProps = PropertiesService.getDocumentProperties();\n    const oldLog = docProps.getProperty('Sidebar_Logs') || '';\n    const newLog = `${oldLog}\\n${new Date().toLocaleTimeString()} ${message}`.trim();\n    docProps.setProperty('Sidebar_Logs', newLog);\n  } catch (err) {\n    Logger.log('appendLogSafe error: ' + err);\n  }\n}\n\n/******************************************************\n * ER Simulator ‚Äì Intelligent Waveform Mapper Extension\n * (adds a second menu: ‚ÄúER Simulator‚Äù)\n ******************************************************/\n\n// Canonical waveform definitions\nconst WAVEFORMS = {\n  'sinus_ecg': 'Normal Sinus Rhythm',\n  'afib_ecg': 'Atrial Fibrillation',\n  'aflutter_ecg': 'Atrial Flutter',\n  'svt_ecg': 'Supraventricular Tachycardia',\n  'vtach_ecg': 'Ventricular Tachycardia',\n  'vfib_ecg': 'Ventricular Fibrillation',\n  'asystole_ecg': 'Asystole (Flatline)',\n  'paced_ecg': 'Paced Rhythm',\n  'junctional_ecg': 'Junctional Rhythm',\n  'bigeminy_ecg': 'Ventricular Bigeminy',\n  'trigeminy_ecg': 'Ventricular Trigeminy',\n  'idioventricular_ecg': 'Idioventricular Rhythm',\n  'torsades_ecg': 'Torsades de Pointes',\n  'peapulseless_ecg': 'Pulseless Electrical Activity',\n  'artifact_ecg': 'Artifact / Noise'\n};\n\n// === 1. Extend onOpen() safely ===\n(function extendMenu_() {\n  const ui = getSafeUi_();\n  if (!ui) { Logger.log(\"Web app context - skipping UI\"); }\n  try {\n    ui.createMenu('ER Simulator')\n      .addItem('ü©∫ Suggest Waveform Mapping', 'suggestWaveformMapping')\n      .addItem('üîÑ Auto-Map All Waveforms', 'autoMapAllWaveforms')\n      .addSeparator()\n      .addItem('üìä Analyze Current Mappings', 'analyzeCurrentMappings')\n      .addItem('‚ùå Clear All Waveforms', 'clearAllWaveforms')\n      .addToUi();\n  } catch (e) {\n    Logger.log('Menu extension error: ' + e);\n  }\n})();\n\n// === 2. Mapping logic ===\nfunction detectWaveformForState_(caseTitle, initialRhythm, dispositionPlan, stateName) {\n  const txt = `${caseTitle} ${initialRhythm} ${dispositionPlan}`.toLowerCase();\n  const isArrest = /arrest|critical/i.test(stateName);\n  const isWorsening = /worsening|deterior/i.test(stateName);\n\n  if (isArrest) {\n    if (txt.includes('pea')) return 'peapulseless_ecg';\n    if (txt.includes('asystole') || txt.includes('flatline')) return 'asystole_ecg';\n    if (txt.includes('vfib')) return 'vfib_ecg';\n    if (txt.includes('vtach')) return 'vtach_ecg';\n    if (txt.includes('torsades')) return 'torsades_ecg';\n    return 'asystole_ecg';\n  }\n  if (isWorsening) {\n    if (txt.includes('vtach')) return 'vtach_ecg';\n    if (txt.includes('svt')) return 'svt_ecg';\n    if (txt.includes('aflutter')) return 'aflutter_ecg';\n  }\n  if (txt.includes('afib')) return 'afib_ecg';\n  if (txt.includes('aflutter')) return 'aflutter_ecg';\n  if (txt.includes('paced') || txt.includes('pacemaker')) return 'paced_ecg';\n  if (txt.includes('junctional')) return 'junctional_ecg';\n  if (txt.includes('bigeminy')) return 'bigeminy_ecg';\n  if (txt.includes('trigeminy')) return 'trigeminy_ecg';\n  return 'sinus_ecg';\n}\n\n// === 3. Helpers ===\nfunction getHeaders_(sheet) {\n  const t1 = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];\n  const t2 = sheet.getRange(2, 1, 1, sheet.getLastColumn()).getValues()[0];\n  return t1.map((a, i) => `${a}:${t2[i]}`);\n}\nfunction buildCase_(headers, row) {\n  const o = {};\n  headers.forEach((h, i) => (o[h] = row[i]));\n  return o;\n}\n\n// === 4. Suggest mapping for active row ===\nfunction suggestWaveformMapping() {\n  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Master Scenario Convert');\n  const ui = getSafeUi_();\n  if (!sheet) return ui.alert('‚ùå Sheet \"Master Scenario Convert\" not found');\n  const r = sheet.getActiveCell().getRow();\n  if (r < 3) return ui.alert('Select a data row (‚â• 3)');\n\n  const headers = getHeaders_(sheet);\n  const vals = sheet.getRange(r, 1, 1, headers.length).getValues()[0];\n  const data = buildCase_(headers, vals);\n  const title = data['Case_Organization:Reveal_Title'] || data['Case_Organization:Spark_Title'] || '';\n  const rhythm = data['Patient_Demographics_and_Clinical_Data:Initial_Rhythm'] || '';\n  const plan = data['Situation_and_Environment_Details:Disposition_Plan'] || '';\n  const states = (data['image sync:Default_Patient_States'] || 'Baseline,Worsening,Arrest,Recovery').split(',');\n\n  let msg = `üìã ${title}\\n\\nü©∫ Suggested Waveforms:\\n`;\n  ['Initial_Vitals','State1_Vitals','State2_Vitals','State3_Vitals','State4_Vitals','State5_Vitals'].forEach((f,i)=>{\n    const sName = states[i] || f;\n    const w = detectWaveformForState_(title, rhythm, plan, sName);\n    msg += `‚Ä¢ ${sName}: ${WAVEFORMS[w]}\\n`;\n  });\n  if (ui) { ui.alert('Waveform Suggestions', msg, ui.ButtonSet.OK); }\n}\n\n// === 5. Auto-map all waveforms ===\nfunction autoMapAllWaveforms() {\n  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Master Scenario Convert');\n  const ui = getSafeUi_();\n  if (!sheet) return ui.alert('‚ùå Sheet \"Master Scenario Convert\" not found');\n  if (ui.alert('Auto-Map Waveforms','Map all cases intelligently?',ui.ButtonSet.YES_NO)!==ui.Button.YES) return;\n\n  const headers = getHeaders_(sheet);\n  const dataR = sheet.getRange(3,1,sheet.getLastRow()-2,headers.length);\n  const data = dataR.getValues();\n  let count=0;\n\n  data.forEach(row=>{\n    const d=buildCase_(headers,row);\n    const title=d['Case_Organization:Reveal_Title']||'';\n    const rhythm=d['Patient_Demographics_and_Clinical_Data:Initial_Rhythm']||'';\n    const plan=d['Situation_and_Environment_Details:Disposition_Plan']||'';\n    const states=(d['image sync:Default_Patient_States']||'Baseline,Worsening,Arrest,Recovery').split(',');\n    ['Initial_Vitals','State1_Vitals','State2_Vitals','State3_Vitals','State4_Vitals','State5_Vitals'].forEach((f,i)=>{\n      const col=headers.indexOf(`Monitor_Vital_Signs:${f}`);\n      if(col===-1)return;\n      try{\n        const v=JSON.parse(row[col]);\n        const w=detectWaveformForState_(title,rhythm,plan,states[i]||f);\n        v.waveform=w; row[col]=JSON.stringify(v); count++;\n      }catch(e){}\n    });\n  });\n  dataR.setValues(data);\n  if (ui) { ui.alert('‚úÖ Auto-mapping complete',`Updated ${count} waveforms`,ui.ButtonSet.OK); }\n}\n\n// === 6. Analyze distribution ===\nfunction analyzeCurrentMappings() {\n  const sheet=SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Master Scenario Convert');\n  const ui=getSafeUi_();\n  if(!sheet)return ui.alert('‚ùå Sheet not found');\n  const h=getHeaders_(sheet);\n  const dr=sheet.getRange(3,1,sheet.getLastRow()-2,h.length);\n  const d=dr.getValues();\n  const stats={};let tot=0,withWF=0;\n  d.forEach(r=>{\n    ['Initial_Vitals','State1_Vitals','State2_Vitals','State3_Vitals','State4_Vitals','State5_Vitals'].forEach(f=>{\n      const c=h.indexOf(`Monitor_Vital_Signs:${f}`);\n      if(c===-1)return;\n      try{const v=JSON.parse(r[c]);tot++;if(v.waveform){withWF++;stats[v.waveform]=(stats[v.waveform]||0)+1;}}catch(e){}\n    });\n  });\n  let msg=`Total Vitals: ${tot}\\nWith Waveforms: ${withWF}\\nMissing: ${tot-withWF}\\n\\n`;\n  Object.keys(stats).sort((a,b)=>stats[b]-stats[a]).forEach(k=>msg+=`${WAVEFORMS[k]||k}: ${stats[k]}\\n`);\n  if (ui) { ui.alert('Waveform Analysis',msg,ui.ButtonSet.OK); }\n}\n\n// === 7. Clear all waveforms ===\nfunction clearAllWaveforms() {\n  const sheet=SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Master Scenario Convert');\n  const ui=getSafeUi_();\n  if(!sheet)return ui.alert('‚ùå Sheet not found');\n  if(ui.alert('Clear All Waveforms','‚ö†Ô∏è Remove all waveforms?',ui.ButtonSet.YES_NO)!==ui.Button.YES)return;\n  const h=getHeaders_(sheet);\n  const dr=sheet.getRange(3,1,sheet.getLastRow()-2,h.length);\n  const d=dr.getValues();let n=0;\n  d.forEach(r=>{\n    ['Initial_Vitals','State1_Vitals','State2_Vitals','State3_Vitals','State4_Vitals','State5_Vitals'].forEach(f=>{\n      const c=h.indexOf(`Monitor_Vital_Signs:${f}`);if(c===-1)return;\n      try{const v=JSON.parse(r[c]);if(v.waveform){delete v.waveform;r[c]=JSON.stringify(v);n++;}}catch(e){}\n    });\n  });\n  dr.setValues(d);\n  if (ui) { ui.alert('‚ùå Cleared',`Removed ${n} waveforms`,ui.ButtonSet.OK); }\n}\n\n\n/******************************************************\n * üîó Live Sync Webhook Trigger (Google ‚Üí Local)\n ******************************************************/\nconst LIVE_SYNC_URL = \"https://overlate-nontemporizingly-edris.ngrok-free.dev/vitals-update\"; // ngrok tunnel\n\nfunction onEdit(e) {\n  try {\n    // If run manually (no event), bail early\n    if (!e || !e.range) {\n      Logger.log(\"‚ö†Ô∏è onEdit called manually - skipping live sync\");\n      return;\n    }\n\n    const sheet = e.range.getSheet();\n    if (sheet.getName() !== \"Master Scenario Convert\" || e.range.getRow() < 3) {\n      Logger.log(\"‚ö†Ô∏è Edit ignored: not in Master Scenario Convert or header row\");\n      return;\n    }\n\n    const row = e.range.getRow();\n    const dataRange = sheet.getRange(row, 1, 1, sheet.getLastColumn());\n    const headers1 = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];\n    const headers2 = sheet.getRange(2, 1, 1, sheet.getLastColumn()).getValues()[0];\n    const rowValues = dataRange.getValues()[0];\n    const mergedKeys = headers1.map((t1, i) => `${t1}:${headers2[i]}`);\n\n    const entry = {};\n    mergedKeys.forEach((key, i) => {\n      const val = rowValues[i];\n      if (val && val !== \"N/A\") entry[key] = tryParseJSON(val);\n    });\n\n    // Post update to your local LiveSync server\n    const options = {\n      method: \"post\",\n      contentType: \"application/json\",\n      payload: JSON.stringify(entry),\n      muteHttpExceptions: true,\n    };\n\n    const response = UrlFetchApp.fetch(LIVE_SYNC_URL, options);\n    Logger.log(`üì° Sent live update for row ${row}: ${response.getResponseCode()}`);\n  } catch (err) {\n    Logger.log(\"‚ùå Live Sync error: \" + err);\n  }\n}\n\nfunction tryParseJSON(v) {\n  try {\n    return JSON.parse(v);\n  } catch {\n    return v;\n  }\n}\n\n// === TEST FUNCTION: Manually trigger batch processing ===\nfunction testBatchProcessRow3() {\n  try {\n    const ss = SpreadsheetApp.getActive();\n    const inSheet = ss.getSheetByName('Input');\n    const outSheet = ss.getSheetByName('Master Scenario Convert');\n\n    Logger.log('üìã Starting test batch for Input row 3...');\n\n    const summary = processOneInputRow_(inSheet, outSheet, 3, true);\n\n    Logger.log('‚úÖ Result: ' + JSON.stringify(summary));\n\n    return {\n      success: true,\n      summary: summary,\n      message: summary.message || 'Completed'\n    };\n\n  } catch (err) {\n    Logger.log('‚ùå ERROR: ' + err.message);\n    Logger.log('Stack: ' + err.stack);\n\n    return {\n      success: false,\n      error: err.message,\n      stack: err.stack,\n      errorDetails: err.toString()\n    };\n  }\n}\n\n\n\n// === DIAGNOSTIC FUNCTION: Test Live Logging System ===\nfunction testLiveLogging() {\n  try {\n    Logger.log('üîç Starting Live Logging Diagnostic Test');\n\n    // Test 1: Can we write to Document Properties?\n    Logger.log('Test 1: Writing to Document Properties...');\n    appendLogSafe('üß™ TEST LOG 1: appendLogSafe() is working!');\n    Logger.log('‚úÖ Test 1 passed');\n\n    // Test 2: Can we read back what we wrote?\n    Logger.log('Test 2: Reading from Document Properties...');\n    const logs = getSidebarLogs();\n    Logger.log('Retrieved logs: ' + logs);\n    Logger.log('‚úÖ Test 2 passed');\n\n    // Test 3: Add more logs\n    Logger.log('Test 3: Adding multiple log entries...');\n    appendLogSafe('üß™ TEST LOG 2: Second entry');\n    appendLogSafe('üß™ TEST LOG 3: Third entry with timestamp');\n    Logger.log('‚úÖ Test 3 passed');\n\n    // Test 4: Read final result\n    const finalLogs = getSidebarLogs();\n    Logger.log('Final logs content:');\n    Logger.log(finalLogs);\n\n    return {\n      success: true,\n      message: 'All tests passed! Check execution logs for details.',\n      logsLength: finalLogs.length,\n      logsPreview: finalLogs.substring(0, 200)\n    };\n\n  } catch (err) {\n    Logger.log('‚ùå ERROR: ' + err.message);\n    Logger.log('Stack: ' + err.stack);\n    return {\n      success: false,\n      error: err.message,\n      stack: err.stack\n    };\n  }\n}\n\n// === DIAGNOSTIC FUNCTION: Check if batch mode flag is set ===\nfunction testBatchModeFlag() {\n  try {\n    const inSheet = SpreadsheetApp.getActive().getSheetByName('Input');\n    const outSheet = SpreadsheetApp.getActive().getSheetByName('Master Scenario Convert');\n\n    Logger.log('üîç Testing batch mode flag...');\n    Logger.log('');\n\n    // Call processOneInputRow_ with batchMode=true\n    Logger.log('Calling processOneInputRow_ with batchMode=true on row 3...');\n    const result = processOneInputRow_(inSheet, outSheet, 3, true);\n\n    Logger.log('Result: ' + JSON.stringify(result));\n    Logger.log('');\n    Logger.log('Now check Document Properties:');\n\n    const logs = getSidebarLogs();\n    Logger.log('Sidebar_Logs content:');\n    Logger.log(logs || '(empty)');\n\n    return {\n      success: true,\n      result: result,\n      logsFound: logs && logs.length > 0,\n      logsLength: (logs || '').length,\n      logsPreview: (logs || '').substring(0, 300)\n    };\n\n  } catch (err) {\n    Logger.log('‚ùå ERROR: ' + err.message);\n    return {\n      success: false,\n      error: err.message\n    };\n  }\n\nfunction clearApiKeyCache() {\n  PropertiesService.getDocumentProperties().deleteProperty('OPENAI_API_KEY');\n  Logger.log('‚úÖ Cleared API key cache');\n  return 'API key cache cleared. Will re-read from Settings sheet on next use.';\n}\n\n/**\n * Show a temporary toast notification\n * Auto-closes after 3 seconds\n */\nfunction showToast(message, duration) {\n  try {\n    SpreadsheetApp.getActiveSpreadsheet().toast(message, '‚úÖ Success', duration || 3);\n  } catch (e) {\n    Logger.log('Toast: ' + message);\n  }\n}\n\n\nfunction analyzeOutputSheetStructure() {\n  const ss = SpreadsheetApp.getActive();\n\n  // Get output sheet name from Settings\n  const settingsSheet = ss.getSheetByName('Settings');\n  let outputSheetName = 'Master Scenario Convert';\n  if (settingsSheet) {\n    const settingsOut = settingsSheet.getRange('A1').getValue();\n    if (settingsOut) outputSheetName = settingsOut;\n  }\n\n  const outSheet = ss.getSheetByName(outputSheetName);\n  if (!outSheet) return { error: 'Output sheet not found: ' + outputSheetName };\n\n  const lastRow = outSheet.getLastRow();\n  const lastCol = outSheet.getLastColumn();\n\n  // Get headers (row 1 and row 2)\n  const tier1Headers = outSheet.getRange(1, 1, 1, lastCol).getValues()[0];\n  const tier2Headers = outSheet.getRange(2, 1, 1, lastCol).getValues()[0];\n\n  // Get a few sample data rows\n  const sampleRows = [];\n  const sampleStart = Math.max(3, lastRow - 2); // Last 3 data rows\n  if (lastRow >= 3) {\n    const sampleData = outSheet.getRange(sampleStart, 1, lastRow - sampleStart + 1, lastCol).getValues();\n    sampleRows.push(...sampleData);\n  }\n\n  return {\n    sheetName: outputSheetName,\n    lastRow: lastRow,\n    lastCol: lastCol,\n    tier1Headers: tier1Headers,\n    tier2Headers: tier2Headers,\n    sampleRows: sampleRows,\n    sampleStartRow: sampleStart\n  };\n}\n\nfunction clearAllBatchProperties() {\n  const props = PropertiesService.getDocumentProperties();\n\n  // Clear all batch-related properties\n  const keysToDelete = [\n    'BATCH_QUEUE',\n    'BATCH_ROWS',\n    'BATCH_INPUT_SHEET',\n    'BATCH_OUTPUT_SHEET',\n    'BATCH_MODE',\n    'BATCH_SPEC',\n    'BATCH_STOP',\n    'BATCH_RUNNING',\n    'BATCH_CURRENT_ROW'\n  ];\n\n  keysToDelete.forEach(key => {\n    try {\n      props.deleteProperty(key);\n    } catch(e) {\n      // Ignore if property doesn't exist\n    }\n  });\n\n  Logger.log('‚úÖ Cleared all batch properties');\n  return 'Batch queue cleared. Ready to start fresh from row 15.';\n}\n}\n",
      "lastModifyUser": {
        "domain": "ersimulator.com",
        "email": "support@ersimulator.com",
        "name": "Aaron Tjomsland",
        "photoUrl": "https://lh3.googleusercontent.com/a-/ALV-UjUs5INVApvCqMmXXPFTkdPWm5nll9bfdSAzL2d6615pJq0tvcf-s4xwSFqzmncSCOugx-4wCXVWJFzfljTZARHqVnS5a2RSOozcO8zb3-VKq6Wb5rHN49mXIlGUWNjTZmjoZtxor42faQQwSIQgLJV2nLjdHiAFMV88bqFgDs9dmA2bkemvts21F0-3Swl1b5WptdbXqzIZoV3-_pUgfhGgXqo_18NSj4D3qQtm0AKFdYX0CU1-N9B1GJ6LUnxbZJmdXJZYM4rleky0YM7ARF5czOCghFizy-rM1Wh5cI2CJUjHL5yjbeC4kqejHwPRQNkj81ZdtlLfbuHlZ4Y0YhZ_UPveDEqmQ7qw09dgaPUpDI-jCzeNfs0fcyfGXVESxfGi2fC6URMo0fFV2b3sUbpsk5jqYKIj5GJOhMDP_Bs8IBqyFakhDwCGPeS_TA9jPe0LE9q5x7UjsiBA7Joazs_Wp3xRk-lzWzIhU1R3Zgy3BSnu-Tc7mIuR9ns21PjKSL4ixSjwbuxAxXLbgNn3poTf6qC0y0cVAV4xuhZ-BR0ld1iU0Us1yaiUd3XVUjFUQz3ulqYNOxPthjXSwhJ4Qm-Eu7Yd-QSYFywa5p9TZLCAl0WlMijX9kKEZ0EC1oHxyLz02qeK2QCLKJF1-40wCG1U_KeTiET1roeRetMiRaki41cuATD8E0iRk5LkcVn6DZzgDKzyhY2G2J1yinItqNRbU9lu72zi14JZYwu7713qnq6tJHnm8Cd1vfgwyqyX68b5abLTsniRDVw9GrpjstO_268dydxYlAPqDmI5SkMpnPAmLpv4BSylgYSoFFOoafFWlYhEHTOQ1uPuGiY8jmuqj6hjBh2-OuefmjcJaCtDtoBg3EMndJs4AB5k1oYaTm_zL8G-6GckZrFNUX3e9KGqFEFW2eHqyAwtW1W-b7j4w9336gUA1016MkUaO8e32uqAnDGU5DcMuoPcGSD90M6QohNSROTzm_Fd5Ot0VVMfRZKvQ6MpU6hWD9LUB5XgaAz-0OGs7081UUcI2SBhsxsAw8YsJg8P3QlpbP_l1_XtIxRAOT1c33A=h128"
      },
      "createTime": "2025-10-10T03:29:02.931Z",
      "updateTime": "2025-11-03T17:00:11.812Z",
      "functionSet": {
        "values": [
          {
            "name": "getSafeUi_"
          },
          {
            "name": "ensureQualityColumns_",
            "parameters": [
              "sheet",
              "header1",
              "header2"
            ]
          },
          {
            "name": "evaluateSimulationQuality",
            "parameters": [
              "rowValues",
              "mergedKeys"
            ]
          },
          {
            "name": "attachQualityToRow_",
            "parameters": [
              "sheet",
              "rowValues",
              "header1",
              "header2",
              "mergedKeys"
            ]
          },
          {
            "name": "runQualityAudit_AllOrRows"
          },
          {
            "name": "cleanUpLowValueRows"
          },
          {
            "name": "getProp",
            "parameters": [
              "key",
              "fallback"
            ]
          },
          {
            "name": "estimateTokens",
            "parameters": [
              "str"
            ]
          },
          {
            "name": "estimateCostUSD",
            "parameters": [
              "inputText",
              "outputText"
            ]
          },
          {
            "name": "hashText",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "cleanDuplicateLines",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "parseATSRResponse_",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "validateVitalsFields_",
            "parameters": [
              "parsedOutput",
              "headers"
            ]
          },
          {
            "name": "callOpenAiJson",
            "parameters": [
              "model",
              "userPrompt"
            ]
          },
          {
            "name": "extractValueFromParsed_",
            "parameters": [
              "parsed",
              "mergedKey"
            ]
          },
          {
            "name": "syncApiKeyFromSettingsSheet_"
          },
          {
            "name": "readApiKey_"
          },
          {
            "name": "callOpenAI",
            "parameters": [
              "promptText",
              "temperature"
            ]
          },
          {
            "name": "checkApiStatus"
          },
          {
            "name": "readTwoTierHeaders_",
            "parameters": [
              "sheet"
            ]
          },
          {
            "name": "mergedKeysFromTwoTiers_",
            "parameters": [
              "header1",
              "header2"
            ]
          },
          {
            "name": "cacheHeaders",
            "parameters": [
              "sheet"
            ]
          },
          {
            "name": "getCachedHeadersOrRead",
            "parameters": [
              "sheet"
            ]
          },
          {
            "name": "clearHeaderCache"
          },
          {
            "name": "ensureBatchReportsSheet_"
          },
          {
            "name": "openSimSidebar"
          },
          {
            "name": "saveSidebarBasics",
            "parameters": [
              "model",
              "apiKeyMaybe",
              "priceIn",
              "priceOut",
              "inputSheet",
              "outputSheet"
            ]
          },
          {
            "name": "logLong",
            "parameters": [
              "label",
              "text"
            ]
          },
          {
            "name": "getSidebarLogs"
          },
          {
            "name": "clearSidebarLogs"
          },
          {
            "name": "setOutputSheet",
            "parameters": [
              "sheetName"
            ]
          },
          {
            "name": "setProp",
            "parameters": [
              "key",
              "value"
            ]
          },
          {
            "name": "stopBatch"
          },
          {
            "name": "parseRowSpec_",
            "parameters": [
              "spec"
            ]
          },
          {
            "name": "getNext25InputRows_",
            "parameters": [
              "inputSheet",
              "outputSheet"
            ]
          },
          {
            "name": "getAllInputRows_",
            "parameters": [
              "inputSheet",
              "outputSheet"
            ]
          },
          {
            "name": "getSpecificInputRows_",
            "parameters": [
              "inputSheet",
              "outputSheet",
              "spec"
            ]
          },
          {
            "name": "parseRowSpec",
            "parameters": [
              "spec"
            ]
          },
          {
            "name": "startBatchFromSidebar",
            "parameters": [
              "inputSheetName",
              "outputSheetName",
              "mode",
              "spec"
            ]
          },
          {
            "name": "runSingleStepBatch"
          },
          {
            "name": "finishBatchAndReport"
          },
          {
            "name": "runSingleCaseFromSidebar",
            "parameters": [
              "inputSheetName",
              "outputSheetName",
              "row"
            ]
          },
          {
            "name": "applyClinicalDefaults_",
            "parameters": [
              "parsed",
              "mergedKeys"
            ]
          },
          {
            "name": "processOneInputRow_",
            "parameters": [
              "inputSheet",
              "outputSheet",
              "inputRow",
              "batchMode"
            ]
          },
          {
            "name": "runATSRTitleGenerator",
            "parameters": [
              "continueRow",
              "keepSelections"
            ]
          },
          {
            "name": "buildATSRUltimateUI_",
            "parameters": [
              "row",
              "parsed",
              "keepSelections",
              "data"
            ]
          },
          {
            "name": "applyATSRSelectionsWithDefiningAndMemory",
            "parameters": [
              "row",
              "spark",
              "reveal",
              "caseID",
              "define"
            ]
          },
          {
            "name": "pickMasterSheet_"
          },
          {
            "name": "autoBoldSummary_",
            "parameters": [
              "summary",
              "key",
              "take"
            ]
          },
          {
            "name": "openImageSyncDefaults"
          },
          {
            "name": "saveImageSyncDefaults",
            "parameters": [
              "json"
            ]
          },
          {
            "name": "refreshImageSyncHeaderCache"
          },
          {
            "name": "openMemoryTracker"
          },
          {
            "name": "clearMotifMemory"
          },
          {
            "name": "markMotifsReusable",
            "parameters": [
              "unchecked"
            ]
          },
          {
            "name": "refreshHeaders"
          },
          {
            "name": "retrainPromptStructure"
          },
          {
            "name": "ensureHeadersCached"
          },
          {
            "name": "openSettingsPanel"
          },
          {
            "name": "pullApiFromSettingsSheet"
          },
          {
            "name": "openCategoriesPathwaysPanel"
          },
          {
            "name": "buildCategoriesPathwaysMainMenu_"
          },
          {
            "name": "getCategoryView",
            "parameters": [
              "category"
            ]
          },
          {
            "name": "getPathwayView",
            "parameters": [
              "pathway"
            ]
          },
          {
            "name": "getAllCategoriesView"
          },
          {
            "name": "getAllPathwaysView"
          },
          {
            "name": "getCaseAssignmentView",
            "parameters": [
              "row"
            ]
          },
          {
            "name": "saveATSRData",
            "parameters": [
              "row",
              "data"
            ]
          },
          {
            "name": "onOpen"
          },
          {
            "name": "appendLogSafe",
            "parameters": [
              "message"
            ]
          },
          {
            "name": "detectWaveformForState_",
            "parameters": [
              "caseTitle",
              "initialRhythm",
              "dispositionPlan",
              "stateName"
            ]
          },
          {
            "name": "getHeaders_",
            "parameters": [
              "sheet"
            ]
          },
          {
            "name": "buildCase_",
            "parameters": [
              "headers",
              "row"
            ]
          },
          {
            "name": "suggestWaveformMapping"
          },
          {
            "name": "autoMapAllWaveforms"
          },
          {
            "name": "analyzeCurrentMappings"
          },
          {
            "name": "clearAllWaveforms"
          },
          {
            "name": "onEdit",
            "parameters": [
              "e"
            ]
          },
          {
            "name": "tryParseJSON",
            "parameters": [
              "v"
            ]
          },
          {
            "name": "testBatchProcessRow3"
          },
          {
            "name": "testLiveLogging"
          },
          {
            "name": "testBatchModeFlag"
          }
        ]
      }
    },
    {
      "name": "appsscript",
      "type": "JSON",
      "source": "{\n  \"timeZone\": \"America/Denver\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\",\n  \"webapp\": {\n    \"executeAs\": \"USER_DEPLOYING\",\n    \"access\": \"ANYONE_ANONYMOUS\"\n  }\n}",
      "lastModifyUser": {
        "domain": "ersimulator.com",
        "email": "support@ersimulator.com",
        "name": "Aaron Tjomsland",
        "photoUrl": "https://lh3.googleusercontent.com/a-/ALV-UjUs5INVApvCqMmXXPFTkdPWm5nll9bfdSAzL2d6615pJq0tvcf-s4xwSFqzmncSCOugx-4wCXVWJFzfljTZARHqVnS5a2RSOozcO8zb3-VKq6Wb5rHN49mXIlGUWNjTZmjoZtxor42faQQwSIQgLJV2nLjdHiAFMV88bqFgDs9dmA2bkemvts21F0-3Swl1b5WptdbXqzIZoV3-_pUgfhGgXqo_18NSj4D3qQtm0AKFdYX0CU1-N9B1GJ6LUnxbZJmdXJZYM4rleky0YM7ARF5czOCghFizy-rM1Wh5cI2CJUjHL5yjbeC4kqejHwPRQNkj81ZdtlLfbuHlZ4Y0YhZ_UPveDEqmQ7qw09dgaPUpDI-jCzeNfs0fcyfGXVESxfGi2fC6URMo0fFV2b3sUbpsk5jqYKIj5GJOhMDP_Bs8IBqyFakhDwCGPeS_TA9jPe0LE9q5x7UjsiBA7Joazs_Wp3xRk-lzWzIhU1R3Zgy3BSnu-Tc7mIuR9ns21PjKSL4ixSjwbuxAxXLbgNn3poTf6qC0y0cVAV4xuhZ-BR0ld1iU0Us1yaiUd3XVUjFUQz3ulqYNOxPthjXSwhJ4Qm-Eu7Yd-QSYFywa5p9TZLCAl0WlMijX9kKEZ0EC1oHxyLz02qeK2QCLKJF1-40wCG1U_KeTiET1roeRetMiRaki41cuATD8E0iRk5LkcVn6DZzgDKzyhY2G2J1yinItqNRbU9lu72zi14JZYwu7713qnq6tJHnm8Cd1vfgwyqyX68b5abLTsniRDVw9GrpjstO_268dydxYlAPqDmI5SkMpnPAmLpv4BSylgYSoFFOoafFWlYhEHTOQ1uPuGiY8jmuqj6hjBh2-OuefmjcJaCtDtoBg3EMndJs4AB5k1oYaTm_zL8G-6GckZrFNUX3e9KGqFEFW2eHqyAwtW1W-b7j4w9336gUA1016MkUaO8e32uqAnDGU5DcMuoPcGSD90M6QohNSROTzm_Fd5Ot0VVMfRZKvQ6MpU6hWD9LUB5XgaAz-0OGs7081UUcI2SBhsxsAw8YsJg8P3QlpbP_l1_XtIxRAOT1c33A=h128"
      },
      "createTime": "2025-10-10T03:29:02.932Z",
      "updateTime": "2025-11-03T17:00:11.812Z",
      "functionSet": {}
    }
  ]
}