{
  "timestamp": "2025-11-11T05:00:22.794Z",
  "scriptId": "12NihbVaaAIyRMCtzZ-aGjJ71CdL-HDjhmjxiD_S_EgIOuDOtrUH6M1l2",
  "files": [
    {
      "name": "Code",
      "type": "SERVER_JS",
      "source": "// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// MENU INITIALIZATION\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nfunction restore35Defaults() {\n  var defaults = [\n    'Case_Organization_Case_ID',\n    'Case_Organization_Spark_Title',\n    'Case_Organization_Reveal_Title',\n    'Case_Organization_Pathway_or_Course_Name',\n    'Case_Organization_Difficulty_Level',\n    'Case_Organization_Medical_Category',\n    'Patient_Demographics_and_Clinical_Data_Age',\n    'Patient_Demographics_and_Clinical_Data_Gender',\n    'Patient_Demographics_and_Clinical_Data_Presenting_Complaint',\n    'Patient_Demographics_and_Clinical_Data_Past_Medical_History',\n    'Patient_Demographics_and_Clinical_Data_Exam_Positive_Findings',\n    'Monitor_Vital_Signs_Initial_Vitals',\n    'Scenario_Progression_States_Decision_Nodes_JSON',\n    'Set_the_Stage_Context_Case_Summary_Concise',\n    'CME_and_Educational_Content_CME_Learning_Objective',\n    'Set_the_Stage_Context_Educational_Goal',\n    'Set_the_Stage_Context_Why_It_Matters',\n    'Developer_and_QA_Metadata_Simulation_Quality_Score',\n    'Case_Organization_Original_Title',\n    'Set_the_Stage_Context_Environment_Type',\n    'Set_the_Stage_Context_Environment_Description_for_AI_Image',\n    'Situation_and_Environment_Details_Triage_or_SBAR_Note',\n    'Situation_and_Environment_Details_Disposition_Plan',\n    'Scenario_Progression_States_Branching_Notes',\n    'Staff_and_AI_Interaction_Config_Patient_Script',\n    'Monitor_Vital_Signs_State1_Vitals',\n    'Monitor_Vital_Signs_State2_Vitals',\n    'Monitor_Vital_Signs_State3_Vitals',\n    'Monitor_Vital_Signs_State4_Vitals',\n    'Monitor_Vital_Signs_State5_Vitals',\n    'Monitor_Vital_Signs_Vitals_Format',\n    'Developer_and_QA_Metadata_AI_Reflection_and_Suggestions',\n    'Version_and_Attribution_Full_Attribution_Details',\n    'Case_Organization_Pre_Sim_Overview',\n    'Case_Organization_Post_Sim_Overview'\n  ];\n  \n  PropertiesService.getDocumentProperties().setProperty('SELECTED_CACHE_FIELDS', JSON.stringify(defaults));\n  Logger.log('‚úÖ Restored 35 defaults');\n  Browser.msgBox('Success!', '‚úÖ Restored 35 default fields to SELECTED_CACHE_FIELDS property', Browser.Buttons.OK);\n}\n\n/**\n * Show currently saved field selection\n */\nfunction showSavedFieldSelection() {\n  const ui = getSafeUi_();\n  if (!ui) return;\n\n  const docProps = PropertiesService.getDocumentProperties();\n  const saved = docProps.getProperty('SELECTED_CACHE_FIELDS');\n\n  if (!saved) {\n    ui.alert('No Saved Fields', 'No saved field selection found.\\n\\nYou can save fields by opening Categories & Pathways and selecting which fields to cache.', ui.ButtonSet.OK);\n    return;\n  }\n\n  try {\n    const fields = JSON.parse(saved);\n    const message = 'Found ' + fields.length + ' saved fields:\\n\\n' + fields.join('\\n');\n    ui.alert('Saved Field Selection', message, ui.ButtonSet.OK);\n  } catch (e) {\n    ui.alert('Error', 'Error parsing saved fields: ' + e.message, ui.ButtonSet.OK);\n  }\n}\n\n\n\n/**\n * Clear the Field_Cache_Incremental sheet to start fresh\n */\nfunction clearCacheSheet() {\n  Logger.log('üóëÔ∏è Clearing Field_Cache_Incremental sheet');\n  \n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var cacheSheet = ss.getSheetByName('Field_Cache_Incremental');\n  \n  if (cacheSheet) {\n    ss.deleteSheet(cacheSheet);\n    Logger.log('‚úÖ Cache sheet deleted');\n  }\n  \n  PropertiesService.getDocumentProperties().deleteProperty('LAST_CACHED_ROW');\n  Logger.log('‚úÖ Progress counter reset');\n  \n  return { success: true };\n}\n\n/**\n * Cache next 25 rows with selected fields using perfect headers cache\n */\nfunction cacheNext25RowsWithFields() {\n  Logger.log('üîÑ START cacheNext25RowsWithFields');\n\n  var docProps = PropertiesService.getDocumentProperties();\n  var selectedFieldsJson = docProps.getProperty('SELECTED_CACHE_FIELDS');\n\n  Logger.log('üìã Selected fields property: ' + (selectedFieldsJson ? 'EXISTS' : 'NULL'));\n\n  if (!selectedFieldsJson) {\n    Logger.log('‚ùå ERROR: No SELECTED_CACHE_FIELDS property found!');\n    throw new Error('No fields selected in SELECTED_CACHE_FIELDS');\n  }\n\n  var selectedFields = JSON.parse(selectedFieldsJson);\n  Logger.log('‚úÖ Parsed ' + selectedFields.length + ' selected fields');\n\n  var lastCachedRow = parseInt(docProps.getProperty('LAST_CACHED_ROW') || '2', 10);\n  Logger.log('üìç Last cached row: ' + lastCachedRow);\n\n  var nextRow = lastCachedRow + 1;\n  Logger.log('üìç Next row to cache: ' + nextRow);\n\n  var sheet = pickMasterSheet_();\n  var data = sheet.getDataRange().getValues();\n  Logger.log('üìä Total data rows (including headers): ' + data.length);\n\n  var cachedMergedKeys = docProps.getProperty('CACHED_MERGED_KEYS');\n  if (!cachedMergedKeys) {\n    Logger.log('‚ùå ERROR: Headers not cached!');\n    throw new Error('Headers not cached');\n  }\n\n  var headers = JSON.parse(cachedMergedKeys);\n  Logger.log('‚úÖ Loaded ' + headers.length + ' header columns');\n\n  var totalRows = data.length - 2;\n  Logger.log('üìä Total data rows (excluding 2 headers): ' + totalRows);\n\n  var endRow = Math.min(nextRow + 24, data.length - 1);\n  Logger.log('üìç End row for this batch: ' + endRow);\n  Logger.log('üìç Rows in this batch: ' + (endRow - nextRow + 1));\n\n  if (nextRow >= data.length) {\n    Logger.log('‚úÖ ALL COMPLETE - nextRow (' + nextRow + ') >= data.length (' + data.length + ')');\n    return { complete: true, totalCached: totalRows, totalRows: totalRows, percentComplete: 100 };\n  }\n\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var cacheSheet = ss.getSheetByName('Field_Cache_Incremental');\n\n  if (!cacheSheet) {\n    Logger.log('üìù Creating new Field_Cache_Incremental sheet');\n    cacheSheet = ss.insertSheet('Field_Cache_Incremental');\n    cacheSheet.appendRow(['Row', 'Timestamp'].concat(selectedFields));\n    Logger.log('‚úÖ Sheet created with headers');\n\n    // Switch back to Master sheet so modal doesn't lose context\n    sheet.activate();\n    Logger.log('‚úÖ Switched back to Master sheet');\n  } else {\n    Logger.log('‚úÖ Using existing Field_Cache_Incremental sheet');\n  }\n\n  var timestamp = new Date().toISOString();\n  Logger.log('‚è∞ Timestamp: ' + timestamp);\n  Logger.log('üîÑ Writing rows ' + nextRow + ' to ' + endRow + '...');\n\n  for (var i = nextRow; i <= endRow; i++) {\n    var rowArray = [i, timestamp];\n\n    for (var j = 0; j < selectedFields.length; j++) {\n      var colIdx = headers.indexOf(selectedFields[j]);\n      rowArray.push(colIdx !== -1 ? data[i][colIdx] : 'N/A');\n    }\n\n    cacheSheet.appendRow(rowArray);\n  }\n\n  Logger.log('‚úÖ Wrote ' + (endRow - nextRow + 1) + ' rows to cache sheet');\n\n  docProps.setProperty('LAST_CACHED_ROW', endRow.toString());\n  Logger.log('‚úÖ Updated LAST_CACHED_ROW to ' + endRow);\n\n  var cachedCount = endRow - 2;\n  var percentComplete = Math.round((cachedCount / totalRows) * 100);\n\n  var isComplete = endRow >= data.length - 1;\n  Logger.log('üèÅ Completion check: endRow=' + endRow + ', data.length-1=' + (data.length - 1) + ', complete=' + isComplete);\n\n  var result = {\n    complete: isComplete,\n    startRow: nextRow,\n    endRow: endRow,\n    totalCached: cachedCount,\n    totalRows: totalRows,\n    percentComplete: percentComplete,\n    rowsInBatch: endRow - nextRow + 1\n  };\n\n  Logger.log('üìä Returning: ' + JSON.stringify(result));\n  Logger.log('‚úÖ END cacheNext25RowsWithFields');\n\n  return result;\n}\n\nfunction resetCacheProgress() {\n  PropertiesService.getDocumentProperties().deleteProperty('LAST_CACHED_ROW');\n  return { success: true };\n}\n\nfunction showFieldSelector() {\n  Logger.log('üéØ Field Selector with AI Recommendations');\n\n  try {\n    var roughDraft = getFieldSelectorRoughDraft();\n    var allFields = roughDraft.allFields;\n    var selected = roughDraft.selected;\n\n    Logger.log('‚úÖ Got ' + allFields.length + ' fields, ' + selected.length + ' selected');\n\n    var allFieldsJson = JSON.stringify(allFields);\n    var selectedJson = JSON.stringify(selected);\n\n    var html = '<!DOCTYPE html><html><head><title>Field Selector</title>';\n\n    html += '<style>';\n    html += 'body { font-family: Arial, sans-serif; margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh; }';\n    html += '.live-log-header { background: #1a1a1a; color: #0f0; padding: 5px 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }';\n    html += '.live-log { background: #000; color: #0f0; font-family: monospace; font-size: 12px; padding: 10px; height: 100px; overflow-y: auto; border-bottom: 3px solid #0f0; }';\n    html += '.copy-btn { background: #0f0; color: #000; border: none; padding: 4px 12px; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 11px; }';\n    html += '.copy-btn:hover { background: #0c0; }';\n    html += '.main-content { flex: 1; overflow-y: auto; padding: 20px; }';\n    html += 'h1 { color: #1a73e8; margin: 0 0 20px 0; }';\n    html += '.section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }';\n    html += '.section-header { font-size: 16px; font-weight: bold; padding: 8px; margin-bottom: 10px; border-radius: 3px; display: flex; justify-content: space-between; align-items: center; }';\n    html += '.section-header.default { background: #0d652d; color: white; }';\n    html += '.section-header.recommended { background: #ea8600; color: white; }';\n    html += '.section-header.other { background: #5f6368; color: white; }';\n    html += '.field-list { max-height: 200px; overflow-y: auto; }';\n    html += '.field-item { padding: 8px; margin: 4px 0; background: #f8f9fa; border-radius: 3px; cursor: pointer; }';\n    html += '.field-item:hover { background: #e8f0fe; }';\n    html += '.field-item input { margin-right: 10px; cursor: pointer; }';\n    html += '.field-item label { cursor: pointer; }';\n    html += '.field-item.recommended { background: #fff3e0; border-left: 3px solid #ea8600; }';\n    html += '.field-item.ai-approved { background: #e8f5e9; border-left: 3px solid #4caf50; }';\n    html += '.ai-badge { display: inline-block; background: #4caf50; color: white; font-size: 10px; padding: 2px 6px; border-radius: 3px; margin-left: 8px; font-weight: bold; }';\n    html += '.rationale { font-size: 11px; color: #666; margin-left: 30px; font-style: italic; }';\n    html += '.footer { padding: 15px; background: #f8f9fa; border-top: 2px solid #ddd; }';\n    html += '.btn { padding: 10px 20px; margin-right: 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold; }';\n    html += '.btn-primary { background: #1a73e8; color: white; }';\n    html += '.btn-primary:hover { background: #1557b0; }';\n    html += '.btn-secondary { background: #5f6368; color: white; }';\n    html += '.btn-secondary:hover { background: #3c4043; }';\n    html += '.btn-ai { background: #ea8600; color: white; padding: 4px 10px; font-size: 12px; }';\n    html += '.btn-ai:hover { background: #c77100; }';\n    html += '.btn-ai:disabled { background: #ccc; cursor: not-allowed; }';\n    html += '.loading { color: #666; font-style: italic; }';\n    html += '</style>';\n\n    html += '<script>';\n    html += 'var ALL_FIELDS = ' + allFieldsJson + ';';\n    html += 'var SELECTED_FIELDS = ' + selectedJson + ';';\n    html += 'var currentSelection = {};';\n    html += 'var recommendedFields = [];';\n    html += '';\n    html += 'function log(msg) {';\n    html += '  var logDiv = document.getElementById(\"live-log\");';\n    html += '  var timestamp = new Date().toLocaleTimeString();';\n    html += '  logDiv.innerHTML += \"[\" + timestamp + \"] \" + msg + \"<br>\";';\n    html += '  logDiv.scrollTop = logDiv.scrollHeight;';\n    html += '}';\n    html += '';\n    html += 'function copyLog() {';\n    html += '  var logDiv = document.getElementById(\"live-log\");';\n    html += '  var text = logDiv.innerText;';\n    html += '  navigator.clipboard.writeText(text).then(function() {';\n    html += '    log(\"üìã Log copied to clipboard!\");';\n    html += '  });';\n    html += '}';\n    html += '';\n    html += 'function initSelection() {';\n    html += '  for (var i = 0; i < SELECTED_FIELDS.length; i++) {';\n    html += '    currentSelection[SELECTED_FIELDS[i]] = true;';\n    html += '  }';\n    html += '  log(\"‚úÖ Loaded \" + SELECTED_FIELDS.length + \" default fields\");';\n    html += '}';\n    html += '';\n    html += 'function handleCheckboxChange(event) {';\n    html += '  var fieldName = event.target.getAttribute(\"data-field\");';\n    html += '  currentSelection[fieldName] = event.target.checked;';\n    html += '  updateCounts();';\n    html += '}';\n    html += '';\n    html += 'function updateCounts() {';\n    html += '  var count = 0;';\n    html += '  for (var field in currentSelection) {';\n    html += '    if (currentSelection[field]) count++;';\n    html += '  }';\n    html += '  document.getElementById(\"selected-count\").textContent = count;';\n    html += '}';\n    html += '';\n    html += 'function getAIRecommendations() {';\n    html += '  log(\"ü§ñ Requesting AI field recommendations...\");';\n    html += '  var btn = document.getElementById(\"ai-btn\");';\n    html += '  btn.disabled = true;';\n    html += '  btn.textContent = \"‚è≥ Loading...\";';\n    html += '  var section = document.getElementById(\"recommended-section\");';\n    html += '  section.innerHTML = \"<div class=\\\\\"loading\\\\\">ü§ñ AI is analyzing your field selection...</div>\";';\n    html += '';\n    html += '  google.script.run';\n    html += '    .withSuccessHandler(function(result) {';\n    html += '      log(\"‚úÖ Received \" + result.length + \" AI recommendations\");';\n    html += '      recommendedFields = result;';\n    html += '      renderRecommendedSection();';\n    html += '      btn.textContent = \"üîÑ Refresh AI\";';\n    html += '      btn.disabled = false;';\n    html += '    })';\n    html += '    .withFailureHandler(function(error) {';\n    html += '      log(\"‚ùå AI request failed: \" + error.message);';\n    html += '      section.innerHTML = \"<div class=\\\\\"loading\\\\\">‚ùå Error: \" + error.message + \"</div>\";';\n    html += '      btn.disabled = false;';\n    html += '      btn.textContent = \"ü§ñ Try Again\";';\n    html += '    })';\n    html += '    .getRecommendedFields(ALL_FIELDS, SELECTED_FIELDS);';\n    html += '}';\n    html += '';\n    html += 'function renderRecommendedSection() {';\n    html += '  var section = document.getElementById(\"recommended-section\");';\n    html += '  if (recommendedFields.length === 0) {';\n    html += '    section.innerHTML = \"<em>No additional recommendations at this time.</em>\";';\n    html += '    return;';\n    html += '  }';\n    html += '';\n    html += '  var aiApproved = [];';\n    html += '  var newRecommendations = [];';\n    html += '';\n    html += '  for (var i = 0; i < recommendedFields.length; i++) {';\n    html += '    var rec = recommendedFields[i];';\n    html += '    var fieldName = rec.field || rec.name || rec;';\n    html += '    if (SELECTED_FIELDS.indexOf(fieldName) > -1) {';\n    html += '      aiApproved.push({ field: fieldName, rationale: rec.rationale });';\n    html += '    } else {';\n    html += '      newRecommendations.push(rec);';\n    html += '    }';\n    html += '  }';\n    html += '';\n    html += '  log(\"‚ú® \" + aiApproved.length + \" defaults confirmed by AI, \" + newRecommendations.length + \" new suggestions\");';\n    html += '';\n    html += '  if (aiApproved.length > 0) {';\n    html += '    var defaultSection = document.querySelector(\".section-header.default\");';\n    html += '    defaultSection.innerHTML = \"‚úÖ DEFAULT (\" + SELECTED_FIELDS.length + \") <span class=\\\\\"ai-badge\\\\\">‚ú® \" + aiApproved.length + \" AI APPROVED</span>\";';\n    html += '';\n    html += '    for (var i = 0; i < aiApproved.length; i++) {';\n    html += '      var fieldName = aiApproved[i].field;';\n    html += '      var items = document.querySelectorAll(\"[data-field=\\\\\"\" + fieldName + \"\\\\\"]\");';\n    html += '      for (var j = 0; j < items.length; j++) {';\n    html += '        var item = items[j].parentElement;';\n    html += '        if (item.classList.contains(\"field-item\")) {';\n    html += '          item.classList.add(\"ai-approved\");';\n    html += '          var label = item.querySelector(\"label\");';\n    html += '          if (!label.querySelector(\".ai-badge\")) {';\n    html += '            label.innerHTML += \" <span class=\\\\\"ai-badge\\\\\">‚ú® AI</span>\";';\n    html += '          }';\n    html += '        }';\n    html += '      }';\n    html += '    }';\n    html += '  }';\n    html += '';\n    html += '  var html = \"\";';\n    html += '  if (newRecommendations.length === 0) {';\n    html += '    html = \"<em>No new field recommendations. AI confirms your current selection!</em>\";';\n    html += '  } else {';\n    html += '    for (var i = 0; i < newRecommendations.length; i++) {';\n    html += '      var rec = newRecommendations[i];';\n    html += '      var fieldName = rec.field || rec.name || rec;';\n    html += '      var rationale = rec.rationale || \"\";';\n    html += '      html += \"<div class=\\\\\"field-item recommended\\\\\">\";';\n    html += '      html += \"<input type=\\\\\"checkbox\\\\\" data-field=\\\\\"\" + fieldName + \"\\\\\" class=\\\\\"field-checkbox ai-checkbox\\\\\">\";';\n    html += '      html += \"<label>\" + fieldName + \"</label>\";';\n    html += '      if (rationale) {';\n    html += '        html += \"<div class=\\\\\"rationale\\\\\">üí° \" + rationale + \"</div>\";';\n    html += '      }';\n    html += '      html += \"</div>\";';\n    html += '    }';\n    html += '  }';\n    html += '';\n    html += '  section.innerHTML = html;';\n    html += '  document.querySelector(\".section-header.recommended span\").textContent = \"üéØ RECOMMENDED (\" + newRecommendations.length + \")\";';\n    html += '';\n    html += '  var checkboxes = section.querySelectorAll(\".ai-checkbox\");';\n    html += '  for (var i = 0; i < checkboxes.length; i++) {';\n    html += '    checkboxes[i].addEventListener(\"change\", handleCheckboxChange);';\n    html += '  }';\n    html += '}';\n    html += '';\n    html += 'function loadDefaults() {';\n    html += '  log(\"üîÑ Loading 35 default fields...\");';\n    html += '  document.getElementById(\"load-defaults-btn\").disabled = true;';\n    html += '  google.script.run';\n    html += '    .withSuccessHandler(function() {';\n    html += '      log(\"‚úÖ Defaults loaded successfully!\");';\n    html += '      log(\"‚úÖ Close this window and reopen field selector to see them\");';\n    html += '      setTimeout(function() { google.script.host.close(); }, 2000);';\n    html += '    })';\n    html += '    .withFailureHandler(function(e) {';\n    html += '      log(\"‚ùå Error loading defaults: \" + e.message);';\n    html += '      document.getElementById(\"load-defaults-btn\").disabled = false;';\n    html += '    })';\n    html += '    .restore35Defaults();';\n    html += '}';\n    html += '';\n    html += 'function saveSelection() {';\n    html += '  var selected = [];';\n    html += '  for (var field in currentSelection) {';\n    html += '    if (currentSelection[field]) selected.push(field);';\n    html += '  }';\n    html += '  log(\"üíæ Saving \" + selected.length + \" fields to properties...\");';\n    html += '  google.script.run';\n    html += '    .withSuccessHandler(function() {';\n    html += '      log(\"‚úÖ Selection saved successfully!\");';\n    html += '      log(\"üöÄ Ready to cache data for these fields\");';\n    html += '      setTimeout(function() { google.script.host.close(); }, 1500);';\n    html += '    })';\n    html += '    .withFailureHandler(function(error) {';\n    html += '      log(\"‚ùå Error saving: \" + error.message);';\n    html += '    })';\n    html += '    .saveFieldSelection(selected);';\n    html += '}';\n    html += '';\n    html += 'var cachingInProgress = false;';\n    html += '';\n    html += 'function startCaching() {';\n    html += '  if (cachingInProgress) return;';\n    html += '  cachingInProgress = true;';\n    html += '  document.getElementById(\"cache-btn\").disabled = true;';\n    html += '  log(\"Clearing previous cache...\");';\n    html += '  google.script.run';\n    html += '    .withSuccessHandler(function() {';\n    html += '      log(\"Cache cleared\");';\n    html += '      log(\"Starting batch cache\");';\n    html += '      saveFieldsAndCache();';\n    html += '    })';\n    html += '    .withFailureHandler(function(e) {';\n    html += '      log(\"Error clearing cache: \" + e.message);';\n    html += '      cachingInProgress = false;';\n    html += '      document.getElementById(\"cache-btn\").disabled = false;';\n    html += '    })';\n    html += '    .clearCacheSheet();';\n    html += '}';\n    html += '';\n    html += 'function saveFieldsAndCache() {';\n    html += '  var selected = [];';\n    html += '  for (var field in currentSelection) {';\n    html += '    if (currentSelection[field]) selected.push(field);';\n    html += '  }';\n    html += '  google.script.run';\n    html += '    .withSuccessHandler(function() {';\n    html += '      log(\"Fields saved\");';\n    html += '      cacheNext25();';\n    html += '    })';\n    html += '    .withFailureHandler(function(e) {';\n    html += '      log(\"Error: \" + e.message);';\n    html += '      cachingInProgress = false;';\n    html += '      document.getElementById(\"cache-btn\").disabled = false;';\n    html += '    })';\n    html += '    .saveFieldSelection(selected);';\n    html += '}';\n    html += '';\n    html += 'function cacheNext25() {';\n    html += '  log(\"Caching next 25 rows\");';\n    html += '  google.script.run';\n    html += '    .withSuccessHandler(function(r) {';\n    html += '      log(\"Batch complete: rows \" + r.startRow + \"-\" + r.endRow);';\n    html += '      log(\"Cached \" + r.totalCached + \" / \" + r.totalRows + \" rows (\" + r.percentComplete + \"%)\");';\n    html += '      log(\"Complete flag: \" + r.complete);';\n    html += '      if (r.complete) {';\n    html += '        log(\"ALL ROWS CACHED!\");';\n    html += '        cachingInProgress = false;';\n    html += '        document.getElementById(\"cache-btn\").textContent = \"Done!\";';\n    html += '        document.getElementById(\"cache-btn\").style.background = \"#0d652d\";';\n    html += '      } else {';\n    html += '        setTimeout(cacheNext25, 1500);';\n    html += '      }';\n    html += '    })';\n    html += '    .withFailureHandler(function(e) {';\n    html += '      log(\"Error: \" + e.message);';\n    html += '      cachingInProgress = false;';\n    html += '      document.getElementById(\"cache-btn\").disabled = false;';\n    html += '    })';\n    html += '    .cacheNext25RowsWithFields();';\n    html += '}';\n    html += '';\n    html += 'window.addEventListener(\"DOMContentLoaded\", function() {';\n    html += '  log(\"üéØ Field Selector initialized\");';\n    html += '  initSelection();';\n    html += '';\n    html += '  var otherFields = ALL_FIELDS.filter(function(f) {';\n    html += '    return SELECTED_FIELDS.indexOf(f) === -1 && recommendedFields.indexOf(f) === -1;';\n    html += '  });';\n    html += '';\n    html += '  var sectionsDiv = document.getElementById(\"sections\");';\n    html += '  var html = \"\";';\n    html += '';\n    html += '  html += \"<div class=\\\\\"section\\\\\">\";';\n    html += '  html += \"<div class=\\\\\"section-header default\\\\\">‚úÖ DEFAULT (\" + SELECTED_FIELDS.length + \")</div>\";';\n    html += '  html += \"<div class=\\\\\"field-list\\\\\">\";';\n    html += '  for (var i = 0; i < SELECTED_FIELDS.length; i++) {';\n    html += '    var fieldName = SELECTED_FIELDS[i];';\n    html += '    html += \"<div class=\\\\\"field-item\\\\\">\";';\n    html += '    html += \"<input type=\\\\\"checkbox\\\\\" checked data-field=\\\\\"\" + fieldName + \"\\\\\" class=\\\\\"field-checkbox\\\\\">\";';\n    html += '    html += \"<label>\" + fieldName + \"</label>\";';\n    html += '    html += \"</div>\";';\n    html += '  }';\n    html += '  html += \"</div></div>\";';\n    html += '';\n    html += '  html += \"<div class=\\\\\"section\\\\\">\";';\n    html += '  html += \"<div class=\\\\\"section-header recommended\\\\\">\";';\n    html += '  html += \"<span>üéØ RECOMMENDED (0)</span>\";';\n    html += '  html += \"<button class=\\\\\"btn-ai\\\\\" id=\\\\\"ai-btn\\\\\" onclick=\\\\\"getAIRecommendations()\\\\\">ü§ñ Get AI Recommendations</button>\";';\n    html += '  html += \"</div>\";';\n    html += '  html += \"<div class=\\\\\"field-list\\\\\" id=\\\\\"recommended-section\\\\\">\";';\n    html += '  html += \"<em>Click button above to get AI-powered field recommendations</em>\";';\n    html += '  html += \"</div></div>\";';\n    html += '';\n    html += '  html += \"<div class=\\\\\"section\\\\\">\";';\n    html += '  html += \"<div class=\\\\\"section-header other\\\\\">üìã OTHER (\" + otherFields.length + \")</div>\";';\n    html += '  html += \"<div class=\\\\\"field-list\\\\\">\";';\n    html += '  for (var i = 0; i < Math.min(otherFields.length, 30); i++) {';\n    html += '    var fieldName = otherFields[i];';\n    html += '    html += \"<div class=\\\\\"field-item\\\\\">\";';\n    html += '    html += \"<input type=\\\\\"checkbox\\\\\" data-field=\\\\\"\" + fieldName + \"\\\\\" class=\\\\\"field-checkbox\\\\\">\";';\n    html += '    html += \"<label>\" + fieldName + \"</label>\";';\n    html += '    html += \"</div>\";';\n    html += '  }';\n    html += '  if (otherFields.length > 30) {';\n    html += '    html += \"<div style=\\\\\"padding: 8px; font-style: italic;\\\\\">... and \" + (otherFields.length - 30) + \" more</div>\";';\n    html += '  }';\n    html += '  html += \"</div></div>\";';\n    html += '';\n    html += '  sectionsDiv.innerHTML = html;';\n    html += '';\n    html += '  var checkboxes = document.querySelectorAll(\".field-checkbox\");';\n    html += '  for (var i = 0; i < checkboxes.length; i++) {';\n    html += '    checkboxes[i].addEventListener(\"change\", handleCheckboxChange);';\n    html += '  }';\n    html += '';\n    html += '  updateCounts();';\n    html += '  log(\"üìä Displaying \" + ALL_FIELDS.length + \" total fields\");';\n    html += '});';\n    html += '</script>';\n\n    html += '</head><body>';\n    html += '<div class=\"live-log-header\">';\n    html += '<span>üì° LIVE LOG</span>';\n    html += '<button class=\"copy-btn\" onclick=\"copyLog()\">üìã COPY</button>';\n    html += '</div>';\n    html += '<div class=\"live-log\" id=\"live-log\"></div>';\n    html += '<div class=\"main-content\">';\n    html += '<h1>üéØ Select Fields to Cache</h1>';\n    html += '<div id=\"sections\"></div>';\n    html += '</div>';\n    html += '<div class=\"footer\">';\n    html += '<div style=\"margin-bottom: 10px;\">Selected: <strong><span id=\"selected-count\">0</span></strong> fields</div>';\n    html += '<button class=\"btn btn-primary\" id=\"load-defaults-btn\" onclick=\"loadDefaults()\" style=\"background: #34a853;\">üîÑ Load Defaults</button>';\n    html += '<button class=\"btn btn-primary\" onclick=\"saveSelection()\" style=\"margin-left: 10px;\">üíæ Save Selection</button>';\n    html += '<button class=\"btn btn-primary\" id=\"cache-btn\" onclick=\"startCaching()\" style=\"background: #ea8600; margin-left: 10px;\">üîÑ Cache Selected Fields</button>';\n    html += '<button class=\"btn btn-secondary\" onclick=\"google.script.host.close()\">Cancel</button>';\n    html += '</div>';\n    html += '</body></html>';\n\n    var htmlOutput = HtmlService.createHtmlOutput(html)\n      .setWidth(800)\n      .setHeight(700);\n\n    SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'üéØ Select Fields to Cache');\n    Logger.log('‚úÖ Field selector with AI displayed');\n\n  } catch (error) {\n    Logger.log('‚ùå Error: ' + error.message);\n    SpreadsheetApp.getUi().alert('Error', error.message, SpreadsheetApp.getUi().ButtonSet.OK);\n  }\n}\n\nfunction saveFieldSelection(selectedFields) {\n  try {\n    Logger.log('üíæ Saving ' + selectedFields.length + ' fields to SELECTED_CACHE_FIELDS');\n\n    var docProps = PropertiesService.getDocumentProperties();\n    docProps.setProperty('SELECTED_CACHE_FIELDS', JSON.stringify(selectedFields));\n\n    Logger.log('‚úÖ Field selection saved to SELECTED_CACHE_FIELDS');\n    return { success: true };\n  } catch (error) {\n    Logger.log('‚ùå Error saving: ' + error.message);\n    throw error;\n  }\n}\n\n\n\nfunction onOpen() {\n  const ui = SpreadsheetApp.getUi();\n  const menu = ui.createMenu('üß† Sim Builder');\n\n  // Core Tools\n  menu.addItem('üé® ATSR Titles Optimizer', 'runATSRTitleGenerator');\n  menu.addItem('üß© Categories & Pathways', 'runPathwayChainBuilder');\n  menu.addItem('‚ú® Enhanced Categories', 'openEnhancedVisualPanel');\n  menu.addSeparator();\n  menu.addItem('üöÄ Batch Processing', 'openSimSidebar');\n  menu.addSeparator();\n\n  // Cache Management Submenu\n  menu.addSubMenu(ui.createMenu('üóÑÔ∏è Cache Management')\n    .addItem('üì¶ Cache All Layers', 'showCacheAllLayersModal')\n    .addSeparator()\n    .addItem('üìä Cache Layer 1: BASIC', 'cacheLayer_basic')\n    .addItem('üìö Cache Layer 2: LEARNING', 'cacheLayer_learning')\n    .addItem('üè∑Ô∏è Cache Layer 3: METADATA', 'cacheLayer_metadata')\n    .addItem('üë§ Cache Layer 4: DEMOGRAPHICS', 'cacheLayer_demographics')\n    .addItem('üíì Cache Layer 5: VITALS', 'cacheLayer_vitals')\n    .addItem('ü©∫ Cache Layer 6: CLINICAL', 'cacheLayer_clinical')\n    .addItem('üåç Cache Layer 7: ENVIRONMENT', 'cacheLayer_environment')\n    .addSeparator()\n    .addItem('üìä View Cache Status', 'showCacheStatus')\n    .addItem('üîÑ Refresh Headers', 'refreshHeaders')\n    .addItem('üßπ Clear All Cache Layers', 'clearAllCacheLayers')\n    .addSeparator()\n    .addItem('üëÅÔ∏è View Saved Field Selection', 'showSavedFieldSelection')\n  );\n\n  menu.addToUi();\n}\n\n\n/**\n * MONOLITHIC TEST ENVIRONMENT\n *\n * Combined from:\n * - Production GPT Formatter (all core batch processing)\n * - Title Optimizer (ATSR features)\n * - Categories/Pathways Phase 2 (27 default headers, Field Selector)\n * - Advanced Cache System (Pathway Chain Builder, 7-layer cache)\n *\n * Generated: 2025-11-06T20:28:08.322Z\n *\n * De-duplicated: Removed duplicate function and const declarations\n * This is a COMPLETE test environment with ALL features working together.\n */\n\n// ==================== PRODUCTION BASELINE ====================\n// All core batch processing, quality scoring, and utilities\n\n\n\n/**\n * Safe UI helper - only calls getUi() if in UI context\n * Added for web app compatibility\n */\nfunction getSafeUi_() {\n  try {\n    return SpreadsheetApp.getUi();\n  } catch (e) {\n    return null;\n  }\n}\n\n\n/******************************************************\n * ER_Simulator_Builder.gs ‚Äî FULL UNIFIED MASTER FILE\n * v3.7 (Dark UI)\n * \n * Includes:\n *  ‚Ä¢ Batch Engine (Run All / 25 Rows / Specific Rows) with live log\n *  ‚Ä¢ Single Case Generator (2-tier aware)\n *  ‚Ä¢ ATSR Title Generator (Keep & Regenerate, deselect, memory tracker)\n *  ‚Ä¢ Case Summary Enhancer (auto-bold Dx/Intervention/Takeaway)\n *  ‚Ä¢ Image Sync Defaults Manager (refresh + editable)\n *  ‚Ä¢ Settings (API key from Script Properties or Settings sheet, model/prices, header cache)\n *  ‚Ä¢ Check API Status\n *  ‚Ä¢ Batch Reports (popup + writes to Batch_Reports sheet)\n *  ‚Ä¢ Duplicate check (content hash signature)\n *  ‚Ä¢ Inputs per row: Column A=Formal_Info, B=HTML, C=DOC, D=Extra (any may be blank)\n * \n * Safe to paste as a full replacement.\n ******************************************************/\n\n// ========== 1) ICONS, KEYS, DEFAULTS ==========\n\nconst ICONS = {\n  rocket: 'üöÄ', bolt: '‚ö°', wand: '‚ú®', frame: 'üñº', puzzle: 'üß©',\n  gear: '‚öôÔ∏è', brain: 'üß†', clipboard: 'üìã', stop: '‚èπÔ∏è', shield: 'üõ°Ô∏è'\n};\n\nconst SP_KEYS = {\n  USED_MEMORY_ANCHORS: 'used_memory_anchors',\n  API_KEY: 'OPENAI_API_KEY',\n  MODEL: 'OPENAI_MODEL',\n  PRICE_INPUT: 'PRICE_INPUT_PER_1K',\n  PRICE_OUTPUT: 'PRICE_OUTPUT_PER_1K',\n  USED_MOTIFS: 'USED_CHARACTER_MOTIFS',\n  HEADER_CACHE: 'HEADER_CACHE_JSON',\n  IMG_SYNC_DEFAULTS: 'IMG_SYNC_DEFAULTS_JSON',\n  LAST_INPUT_SHEET: 'LAST_INPUT_SHEET',\n  LAST_OUTPUT_SHEET: 'LAST_OUTPUT_SHEET'\n};\n\nconst DEFAULT_MODEL = 'gpt-4o';\nconst DEFAULT_PRICE = { input: 0.15, output: 0.60 }; // USD / 1k tokens\nconst DEFAULT_TEMP_SINGLE = 0.7;\nconst DEFAULT_TEMP_BATCH  = 0.5; // more schema-sticky\nconst MAX_TOKENS = 16000; // Premium: Allow comprehensive, detailed scenarios\n\n// Two-tier vitals fields to compactify if needed\nconst VITAL_KEYS = [\n  'Monitor_Vital_Signs:Initial_Vitals',\n  'Monitor_Vital_Signs:State1_Vitals',\n  'Monitor_Vital_Signs:State2_Vitals',\n  'Monitor_Vital_Signs:State3_Vitals',\n  'Monitor_Vital_Signs:State4_Vitals',\n  'Monitor_Vital_Signs:State5_Vitals'\n];\n\n\n// ========== 2) CORE UTILS ==========\n\n/******************************************************\n * QUALITY ENGINE ‚Äî scoring, suggestions, audit & cleanup\n * - Auto-ensures columns:\n *   Developer_and_QA_Metadata:Simulation_Quality_Score\n *   Developer_and_QA_Metadata:Simulation_Enhancement_Suggestions\n * - Scores each row using weighted rubric\n * - Generates targeted improvement suggestions\n * - Audit tools for existing rows\n * - Cleanup tool for low-value rows (highlight or delete)\n ******************************************************/\n\n// -- Settings (tweak without changing call sites) --\nconst QUALITY = {\n  // If a row's filled ratio is below this, it‚Äôs considered low value\n  LOW_VALUE_THRESHOLD: 0.30, // 30%\n\n  // If score below this during audit, row gets highlighted (soft warning)\n  HIGHLIGHT_SCORE_LT: 60,\n\n  // Weights for rubric (sum does not need to be 100, we normalize)\n  WEIGHTS: {\n    coreIdentity: 10,     // Case_ID, Spark_Title, Reveal_Title\n    patientBasics: 10,    // Age, Sex, Setting, HPI summary\n    vitals: 20,           // Initial + state vitals\n    branching: 18,        // Progression states, decision rules\n    education: 15,        // Objectives + MCQ\n    ordersData: 12,       // Labs/Imaging/ECG presence\n    environmentAV: 8,     // Scene/time/ambience/media prompts (URLs can be N/A)\n    metaCompleteness: 7   // Reflection + misc developer metadata\n  },\n\n  // Targeted suggestions (key regex ‚Üí human message)\n  SUGGESTIONS: [\n    { re: /Case_Organization:Reveal_Title/i, msg: 'Add a clear Reveal Title with Dx (Age Sex) and a concise learning focus.' },\n    { re: /Case_Organization:Spark_Title/i,  msg: 'Add a Spark Title: ‚Äú<Symptom> (<Age Sex>): <Spark phrase>‚Äù.' },\n    { re: /Monitor_Vital_Signs:Initial_Vitals/i, msg: 'Provide Initial Vitals in compact JSON: {\"HR\":..,\"BP\":\"..\",\"RR\":..,\"Temp\":..,\"SpO2\":..}.' },\n    { re: /Progression_States|Decision_Nodes_JSON/i, msg: 'Add explicit state flow and at least 3 decision rules (branch conditions).' },\n    { re: /CME_and_Educational_Content:Learning_Objective/i, msg: 'Write 1‚Äì3 focused learning objectives.' },\n    { re: /CME_and_Educational_Content:Quiz_Q1/i, msg: 'Include 1 MCQ with 4 options and mark the correct one.' },\n    { re: /Labs|Imaging|ECG|Ultrasound/i, msg: 'Add at least one key data artifact (Labs/Imaging/ECG/US) with brief interpretation.' },\n    { re: /Scene|Ambient|Time_of_Day|Audio/i, msg: 'Enrich the scene: time, lighting, ambient audio to deepen immersion.' },\n    { re: /Developer_and_QA_Metadata:AI_Reflection_and_Suggestions/i, msg: 'Add a 3-part internal reflection (experience, sim improvements, system ideas).' }\n  ],\n\n  // Image_Sync columns can be N/A, but penalize if *all* are N/A\n  PENALIZE_ALL_IMAGE_SYNC_EMPTY: true\n};\n\n// Ensure the two quality columns exist; if missing, append them.\nfunction ensureQualityColumns_(sheet, header1, header2) {\n  const mk = (t1, t2) => `${t1}:${t2}`;\n  const qTier = 'Developer_and_QA_Metadata';\n  const scoreKey = mk(qTier, 'Simulation_Quality_Score');\n  const suggKey  = mk(qTier, 'Simulation_Enhancement_Suggestions');\n\n  const mergedNow = header1.map((t1,i)=>mk(t1, header2[i]));\n  const hasScore = mergedNow.includes(scoreKey);\n  const hasSugg  = mergedNow.includes(suggKey);\n\n  if (hasScore && hasSugg) return { scoreKey, suggKey };\n\n  // Append missing columns at the end with Tier1/Tier2\n  const lastCol = sheet.getLastColumn();\n  let toAppend = [];\n  if (!hasScore) toAppend.push({ t1:qTier, t2:'Simulation_Quality_Score' });\n  if (!hasSugg)  toAppend.push({ t1:qTier, t2:'Simulation_Enhancement_Suggestions' });\n\n  if (toAppend.length) {\n    sheet.insertColumnsAfter(lastCol, toAppend.length);\n    // Row 1 = Tier1, Row 2 = Tier2\n    toAppend.forEach((c, k) => {\n      sheet.getRange(1, lastCol + k + 1).setValue(c.t1);\n      sheet.getRange(2, lastCol + k + 1).setValue(c.t2);\n    });\n  }\n\n  // Re-read headers to return accurate keys\n  const h1 = sheet.getRange(1,1,1,sheet.getLastColumn()).getValues()[0];\n  const h2 = sheet.getRange(2,1,1,sheet.getLastColumn()).getValues()[0];\n  const merged = h1.map((t1,i)=>mk(t1, h2[i]));\n  return {\n    scoreKey: mk(qTier, 'Simulation_Quality_Score'),\n    suggKey:  mk(qTier, 'Simulation_Enhancement_Suggestions'),\n    header1: h1,\n    header2: h2,\n    mergedKeys: merged\n  };\n}\n\n// Return {score, suggestions[]} using a weighted rubric\nfunction evaluateSimulationQuality(rowValues, mergedKeys) {\n  const v = (key) => {\n    const idx = mergedKeys.indexOf(key);\n    if (idx < 0) return '';\n    return String(rowValues[idx] || '').trim();\n  };\n  const has = (re) => mergedKeys.some((k, i) => re.test(k) && String(rowValues[i]||'').trim() && String(rowValues[i]).trim()!=='N/A');\n\n  // 1) Filled ratio\n  const filled = rowValues.filter(x => String(x||'').trim() && String(x).trim()!=='N/A').length;\n  const filledRatio = filled / Math.max(1, rowValues.length);\n\n  // 2) Critical presence\n  const coreIdentityOk   = has(/Case_Organization:Case_ID/i) && has(/Case_Organization:Spark_Title/i) && has(/Case_Organization:Reveal_Title/i);\n  const patientBasicsOk  = has(/Patient_(Age|Sex)|Case_Organization:Spark_Title|Setting/i);\n  const vitalsOk         = has(/Monitor_Vital_Signs:Initial_Vitals/i);\n  const branchingOk      = has(/Progression_States|Decision_Nodes_JSON/i);\n  const educationOk      = has(/CME_and_Educational_Content:(Learning_Objective|Quiz_Q1)/i);\n  const ordersDataOk     = has(/Labs|Imaging|ECG|Ultrasound|CT|X[- ]?Ray/i);\n  const environmentOk    = has(/Scene|Time_of_Day|Ambient|Audio|Image_Prompt/i);\n  const metaOk           = has(/Developer_and_QA_Metadata:AI_Reflection_and_Suggestions/i);\n\n  // 3) Image_Sync penalty if all empty\n  let imgSyncPenalty = 0;\n  if (QUALITY.PENALIZE_ALL_IMAGE_SYNC_EMPTY) {\n    const imgKeys = mergedKeys.filter(k=>/^Image_Sync:/i.test(k));\n    const anyFilled = imgKeys.some(k=>{\n      const val = rowValues[mergedKeys.indexOf(k)];\n      return String(val||'').trim() && String(val).trim()!=='N/A';\n    });\n    if (!anyFilled && imgKeys.length) imgSyncPenalty = 0.05; // subtract 5%\n  }\n\n  // 4) Weighted score\n  const w = QUALITY.WEIGHTS;\n  const sumW = Object.values(w).reduce((a,b)=>a+b,0);\n  let score =\n    (coreIdentityOk   ? w.coreIdentity   : 0) +\n    (patientBasicsOk  ? w.patientBasics  : 0) +\n    (vitalsOk         ? w.vitals         : 0) +\n    (branchingOk      ? w.branching      : 0) +\n    (educationOk      ? w.education      : 0) +\n    (ordersDataOk     ? w.ordersData     : 0) +\n    (environmentOk    ? w.environmentAV  : 0) +\n    (metaOk           ? w.metaCompleteness:0);\n\n  // Blend in filled ratio (up to +10% bonus scaled by completeness)\n  const blendBonus = Math.round(10 * filledRatio);\n  score = ((score / sumW) * 100);\n  score = Math.min(100, Math.max(0, score + blendBonus - (imgSyncPenalty*100)));\n\n  // 5) Suggestions\n  const missingMsgs = [];\n  QUALITY.SUGGESTIONS.forEach(sugg => {\n    const satisfied = mergedKeys.some((k,i)=>sugg.re.test(k) && String(rowValues[i]||'').trim() && String(rowValues[i]).trim()!=='N/A');\n    if (!satisfied) missingMsgs.push(sugg.msg);\n  });\n\n  // Vitals sanity (compact JSON)\n  const ivKey = mergedKeys.find(k=>/Monitor_Vital_Signs:Initial_Vitals/i.test(k));\n  if (ivKey) {\n    const raw = v(ivKey);\n    if (raw && raw !== 'N/A') {\n      try {\n        const obj = JSON.parse(raw);\n        if (!('HR' in obj) || !('BP' in obj)) {\n          missingMsgs.push('Initial Vitals should include HR and BP at minimum.');\n        }\n      } catch(_) {\n        missingMsgs.push('Initial Vitals must be compact JSON (one line).');\n      }\n    } else {\n      missingMsgs.push('Provide Initial Vitals in compact JSON.');\n    }\n  }\n\n  // Keep suggestions tight\n  const suggestionsText = missingMsgs.length ? [...new Set(missingMsgs)].slice(0, 10).join('; ') : 'Excellent completeness.';\n  return { score: Math.round(score), suggestionsText };\n}\n\n// Write quality fields into rowValues array in-place. If columns missing, they‚Äôre created.\nfunction attachQualityToRow_(sheet, rowValues, header1, header2, mergedKeys) {\n  const ensured = ensureQualityColumns_(sheet, header1, header2);\n  const mk = (t1,t2)=>`${t1}:${t2}`;\n\n  // If ensureQualityColumns_ re-read headers, prefer them\n  const mkNow = ensured.mergedKeys || mergedKeys;\n  const scoreKey = ensured.scoreKey;\n  const suggKey  = ensured.suggKey;\n\n  const quality = evaluateSimulationQuality(rowValues, mkNow);\n\n  const scoreIdx = mkNow.indexOf(scoreKey);\n  const suggIdx  = mkNow.indexOf(suggKey);\n\n  // If columns were appended (after we built rowValues), extend rowValues to those columns\n  while (rowValues.length < mkNow.length) rowValues.push(''); // pad\n\n  if (scoreIdx >= 0) rowValues[scoreIdx] = quality.score;\n  if (suggIdx  >= 0) rowValues[suggIdx]  = quality.suggestionsText;\n\n  return quality; // return in case caller wants to log or use it\n}\n\n// ===== Public tools =====\n\n// Re-score all existing rows (or specific list). Adds/updates columns as needed.\nfunction runQualityAudit_AllOrRows() {\n  const ss = SpreadsheetApp.getActive();\n  const sheet = pickMasterSheet_();\n  if (!sheet) { getSafeUi_().alert('‚ùå Could not find your Master Scenario CSV sheet.'); return; }\n\n  const ui = getSafeUi_();\n  const resp = ui.prompt(\n    'Quality Audit',\n    'Leave blank to audit ALL rows, or enter rows like \"4,7,9-12\".',\n    ui.ButtonSet.OK_CANCEL\n  );\n  if (resp.getSelectedButton() !== ui.Button.OK) return;\n\n  const spec = resp.getResponseText().trim();\n  const rows = spec ? parseRowSpec_(spec) : null;\n\n  const { header1, header2 } = getCachedHeadersOrRead(sheet);\n  const mergedKeys = header1.map((t1,i)=>`${t1}:${header2[i]}`);\n  const ensured = ensureQualityColumns_(sheet, header1, header2);\n  const mkNow = ensured.mergedKeys || mergedKeys;\n\n  const last = sheet.getLastRow();\n  const startRow = 3; // data starts at row 3\n  let updated = 0;\n\n  for (let r = startRow; r <= last; r++) {\n    if (rows && !rows.includes(r)) continue;\n\n    const rowVals = sheet.getRange(r, 1, 1, sheet.getLastColumn()).getValues()[0];\n    // Skip empty lines\n    const nonEmpty = rowVals.some(x=>String(x||'').trim());\n    if (!nonEmpty) continue;\n\n    const q = evaluateSimulationQuality(rowVals, mkNow);\n\n    // write back\n    const scoreIdx = mkNow.indexOf(ensured.scoreKey) + 1;\n    const suggIdx  = mkNow.indexOf(ensured.suggKey)  + 1;\n    if (scoreIdx > 0) sheet.getRange(r, scoreIdx).setValue(q.score);\n    if (suggIdx  > 0) sheet.getRange(r, suggIdx).setValue(q.suggestionsText);\n\n    // Highlight very low scores\n    if (q.score < QUALITY.HIGHLIGHT_SCORE_LT) {\n      sheet.getRange(r, 1, 1, sheet.getLastColumn()).setBackground('#2b1d1d'); // subtle dark red\n    } else {\n      sheet.getRange(r, 1, 1, sheet.getLastColumn()).setBackground(null);\n    }\n    updated++;\n  }\n\n  if (ui) { ui.alert(`‚úÖ Quality Audit complete. Updated ${updated} row(s).`); }\n}\n\n// Clean up N/A-heavy rows: choose Highlight or Delete\nfunction cleanUpLowValueRows() {\n  const ss = SpreadsheetApp.getActive();\n  const sheet = pickMasterSheet_();\n  if (!sheet) { getSafeUi_().alert('‚ùå Could not find your Master Scenario CSV sheet.'); return; }\n\n  const last = sheet.getLastRow();\n  const startRow = 3;\n  const lowRows = [];\n\n  for (let r = startRow; r <= last; r++) {\n    const row = sheet.getRange(r,1,1,sheet.getLastColumn()).getValues()[0];\n    const nonNA = row.filter(x => String(x||'').trim() && String(x).trim()!=='N/A').length;\n    const ratio = nonNA / row.length;\n    if (ratio < QUALITY.LOW_VALUE_THRESHOLD) lowRows.push(r);\n  }\n\n  if (!lowRows.length) {\n    if (getSafeUi_()) { getSafeUi_().alert('‚úÖ No low-value rows found.'); }\n    return;\n  }\n\n  const ui = getSafeUi_();\n  const choice = ui.prompt(\n    `Found ${lowRows.length} low-value rows. Type \"H\" to highlight or \"D\" to delete them.`,\n    ui.ButtonSet.OK_CANCEL\n  );\n  if (choice.getSelectedButton() !== ui.Button.OK) return;\n  const opt = (choice.getResponseText()||'').trim().toUpperCase();\n\n  if (opt === 'D') {\n    // Delete bottom-up\n    lowRows.reverse().forEach(r => sheet.deleteRow(r));\n    if (ui) { ui.alert(`üßπ Deleted ${lowRows.length} row(s).`); }\n  } else {\n    // Highlight only\n    lowRows.forEach(r => sheet.getRange(r,1,1,sheet.getLastColumn()).setBackground('#2b1d1d'));\n    if (ui) { ui.alert(`üüß Highlighted ${lowRows.length} row(s).`); }\n  }\n}\n\n\nfunction getProp(key, fallback) {\n  const v = PropertiesService.getDocumentProperties().getProperty(key);\n  return (v === null || v === undefined) ? fallback : v;\n}\nfunction setProp(key, val) {\n  PropertiesService.getDocumentProperties().setProperty(key, val);\n}\n\nfunction estimateTokens(str) {\n  if (!str) return 0;\n  return Math.max(1, Math.round(String(str).length / 4));\n}\nfunction estimateCostUSD(inputText, outputText) {\n  const priceIn = parseFloat(getProp(SP_KEYS.PRICE_INPUT, DEFAULT_PRICE.input));\n  const priceOut = parseFloat(getProp(SP_KEYS.PRICE_OUTPUT, DEFAULT_PRICE.output));\n  const inTok = estimateTokens(inputText);\n  const outTok = estimateTokens(outputText);\n  return ((inTok / 1000) * priceIn) + ((outTok / 1000) * priceOut);\n}\n\nfunction hashText(text) {\n  if (!text) return '';\n  let hash = 0;\n  for (let i=0; i<text.length; i++) {\n    hash = (hash*31 + text.charCodeAt(i)) | 0;\n  }\n  return ('00000000' + (hash >>> 0).toString(16)).slice(-8);\n}\n\nfunction cleanDuplicateLines(text) {\n  if (!text) return text;\n  const lines = text.split('\\n');\n  const out = [];\n  let last = '', count = 0;\n  for (const l of lines) {\n    const t = l.trim();\n    if (t === last) {\n      count++;\n      if (count < 3) out.push(t);\n    } else {\n      out.push(t);\n      last = t; count = 0;\n    }\n  }\n  return out.join('\\n').trim();\n}\n\nfunction tryParseJSON(text) {\n  try { return JSON.parse(text); } catch(e) {\n    const m = text && text.match(/\\{[\\s\\S]*\\}/);\n    if (m) { try { return JSON.parse(m[0]); } catch(_) {} }\n    return null;\n  }\n}\n\n// ATSR-specific JSON parser that handles markdown code fences\nfunction parseATSRResponse_(text) {\n  if (!text) return null;\n\n  // Strip markdown code fences if present\n  let cleaned = text.trim();\n  if (cleaned.startsWith('```')) {\n    cleaned = cleaned.replace(/^```(?:json)?\\s*\\n?/i, '').replace(/\\n?```\\s*$/,'');\n  }\n\n  try { return JSON.parse(cleaned); } catch(e) {\n    const m = cleaned.match(/\\{[\\s\\S]*\\}/);\n    if (m) { try { return JSON.parse(m[0]); } catch(_) {} }\n    return null;\n  }\n}\n\n\n/**\n * Validate and normalize any \"Vitals\" or \"Monitor\" JSON fields.\n * Used after the AI JSON response is parsed.\n */\nfunction validateVitalsFields_(parsedOutput, headers) {\n  if (!parsedOutput || typeof parsedOutput !== 'object') return { valid: false, warnings: [] };\n\n  const warnings = [];\n  headers.forEach(h => {\n    const headerName = h.toLowerCase();\n    if (headerName.includes('vitals') || headerName.includes('monitor')) {\n      const value = parsedOutput[h] || parsedOutput[headerName];\n      if (value) {\n        // If it's a string, try to parse it as JSON\n        if (typeof value === 'string') {\n          const parsed = tryParseJSON(value);\n          if (parsed) parsedOutput[h] = parsed;\n          else warnings.push(`‚ö†Ô∏è ${h} field not valid JSON.`);\n        }\n        // If it's not an object after parse, warn\n        else if (typeof value !== 'object') {\n          warnings.push(`‚ö†Ô∏è ${h} field expected JSON object, got ${typeof value}.`);\n        }\n      } else {\n        warnings.push(`‚ö†Ô∏è Missing ${h} field.`);\n      }\n    }\n  });\n\n  return { valid: warnings.length === 0, warnings, data: parsedOutput };\n}\n\n/**\n * Calls OpenAI with enforced JSON output (for Convert/Batch mode only)\n */\nfunction callOpenAiJson(model, userPrompt) {\n  const apiKey = readApiKey_();\n  if (!apiKey) throw new Error('Missing API key.');\n\n  const url = 'https://api.openai.com/v1/chat/completions';\n  const payload = {\n    model: model,\n    messages: [\n      {\n        role: \"system\",\n        content: \"You are a structured data generator. ALWAYS respond with strict valid JSON ‚Äî no commentary, markdown, or text outside JSON.\"\n      },\n      { role: \"user\", content: userPrompt }\n    ],\n    temperature: 0\n  };\n\n  const options = {\n    method: \"post\",\n    headers: {\n      Authorization: \"Bearer \" + apiKey,\n      \"Content-Type\": \"application/json\"\n    },\n    payload: JSON.stringify(payload),\n    muteHttpExceptions: true\n  };\n\n  const response = UrlFetchApp.fetch(url, options);\n  const raw = response.getContentText();\n\n  Logger.log('üîç DEBUG: Raw OpenAI API response: ' + raw.slice(0, 300));\n\n  try {\n    // Parse the full API response\n    const apiResponse = JSON.parse(raw);\n\n    // Check for API-level errors\n    if (apiResponse.error) {\n      Logger.log('‚ùå OpenAI API Error: ' + JSON.stringify(apiResponse.error));\n      throw new Error('OpenAI API Error: ' + (apiResponse.error.message || JSON.stringify(apiResponse.error)));\n    }\n\n    // Extract the actual content from choices array\n    if (!apiResponse.choices || !apiResponse.choices.length) {\n      Logger.log('‚ùå No choices in API response');\n      throw new Error('OpenAI returned no choices');\n    }\n\n    const content = apiResponse.choices[0].message.content;\n    Logger.log('üìù Extracted content length: ' + content.length + ' characters');\n    Logger.log('üìù Content preview: ' + content.slice(0, 200));\n\n    // NOW parse the content as JSON (this is the simulation data)\n    const parsed = JSON.parse(content);\n    Logger.log('‚úÖ Successfully parsed simulation JSON with ' + Object.keys(parsed).length + ' keys');\n\n    return parsed;\n\n  } catch (err) {\n    Logger.log(\"‚ö†Ô∏è JSON parse error: \" + err.message);\n    Logger.log(\"Raw response: \" + raw.slice(0, 500));\n    throw new Error(\"AI response parse failed: \" + err.message);\n  }\n}\n\n/**\n * Extracts a value from AI JSON output, tolerant of tiered keys.\n * Handles formats like \"Tier1:Tier2\" or just \"Tier2\".\n */\nfunction extractValueFromParsed_(parsed, mergedKey) {\n  if (!parsed || typeof parsed !== 'object') return 'N/A';\n\n  // Try exact full key match\n  if (parsed.hasOwnProperty(mergedKey)) return parsed[mergedKey];\n\n  // Try after colon (Tier 2 only)\n  const parts = mergedKey.split(':');\n  const shortKey = parts[1] || parts[0];\n  if (parsed.hasOwnProperty(shortKey)) return parsed[shortKey];\n\n  // Try case-insensitive match\n  const lowerKey = shortKey.toLowerCase();\n  for (const k in parsed) {\n    if (k.toLowerCase() === lowerKey) return parsed[k];\n  }\n\n  // Try to find nested objects like { \"Case_Organization\": { \"Spark_Title\": \"...\" } }\n  if (parts.length === 2 && parsed[parts[0]] && typeof parsed[parts[0]] === 'object') {\n    const nested = parsed[parts[0]][parts[1]];\n    if (nested !== undefined) return nested;\n  }\n\n  // If all else fails, return N/A\n  return 'N/A';\n}\n\n// Settings sheet integration: read API key from a Settings sheet\n// Supports either:\n//  ‚Ä¢ A two-column key/value table where first column contains \"OPENAI_API_KEY\"\n//  ‚Ä¢ Or cell B2 under header \"API Key\" (fallback)\nfunction syncApiKeyFromSettingsSheet_() {\n  const ss = SpreadsheetApp.getActive();\n  const sheet = ss.getSheetByName('Settings');\n  if (!sheet) return null;\n\n  try {\n    const range = sheet.getDataRange().getValues();\n    // Try KV pairs\n    for (let r=0; r<range.length; r++) {\n      const k = String(range[r][0]||'').trim().toUpperCase();\n      const v = String(range[r][1]||'').trim();\n      if (k === 'OPENAI_API_KEY' && v) {\n        Logger.log('‚úÖ Found OPENAI_API_KEY in Settings sheet');\n        return v;\n      }\n    }\n    // Fallback: B2 if row2 has \"API Key\" label\n    const labelB2 = String(sheet.getRange(2,1).getValue()||'').toLowerCase();\n    if (labelB2.includes('api')) {\n      const apiKey = String(sheet.getRange(2,2).getValue()||'').trim();\n      if (apiKey) {\n        Logger.log('‚úÖ Found API key in Settings!B2');\n        return apiKey;\n      }\n    }\n  } catch(e) {\n    Logger.log('‚ö†Ô∏è Error reading Settings sheet: ' + e.message);\n  }\n  return null;\n}\n\n// Reads API key priority:\n// 1) Script Properties (saved via Settings panel / sidebar)\n// 2) Settings sheet (if present)\n// 3) Error\nfunction readApiKey_() {\n  // DELETE the cached key to force fresh read\n  try {\n    PropertiesService.getDocumentProperties().deleteProperty('OPENAI_API_KEY');\n    Logger.log('üóëÔ∏è Deleted cached API key');\n  } catch (e) {\n    Logger.log('‚ö†Ô∏è Could not delete cache: ' + e.message);\n  }\n\n  // Read fresh from Settings sheet\n  const fromSheet = syncApiKeyFromSettingsSheet_();\n  if (fromSheet) {\n    Logger.log('‚úÖ Read fresh API key from Settings sheet');\n    // DON'T cache it - keep reading fresh\n    return fromSheet;\n  }\n\n  Logger.log('‚ùå No API key found in Settings sheet');\n  return '';\n}\n\nfunction callOpenAI(promptText, temperature) {\n  const apiKey = readApiKey_();\n  if (!apiKey) throw new Error('‚ùå Missing API key. Open Settings and save your key (or add it to the Settings sheet).');\n  const model = getProp(SP_KEYS.MODEL, DEFAULT_MODEL);\n\n  const url = 'https://api.openai.com/v1/chat/completions';\n  const payload = {\n    model,\n    temperature: temperature ?? DEFAULT_TEMP_SINGLE,\n    max_tokens: MAX_TOKENS,\n    messages: [\n      { role: 'system', content: 'You are a world-class simulation scenario writer and exacting data formatter.' },\n      { role: 'user', content: promptText }\n    ]\n  };\n  const options = {\n    method: 'post',\n    headers: { 'Authorization': 'Bearer ' + apiKey, 'Content-Type':'application/json' },\n    payload: JSON.stringify(payload),\n    muteHttpExceptions: true\n  };\n\n  const response = UrlFetchApp.fetch(url, options);\n  const body = response.getContentText();\n  const json = JSON.parse(body);\n  if (!json.choices || !json.choices.length) {\n    throw new Error('‚ö†Ô∏è OpenAI returned no choices:\\n' + body);\n  }\n  return json.choices[0].message.content.trim();\n}\n\n// Quick API status check\nfunction checkApiStatus() {\n  try {\n    const out = callOpenAI('Reply exactly with \"OK\".', 0.0);\n    const ok = /^OK$/i.test(out.trim());\n    if (getSafeUi_()) { getSafeUi_().alert(ok ? 'üõ°Ô∏è API is reachable.' : '‚ö†Ô∏è API replied unexpectedly: ' + out); }\n  } catch (e) {\n    if (getSafeUi_()) { getSafeUi_().alert('‚ùå API error: ' + e.message); }\n  }\n}\n\n// Header cache helpers (two-tier)\nfunction readTwoTierHeaders_(sheet) {\n  const header1 = sheet.getRange(1,1,1,sheet.getLastColumn()).getValues()[0];\n  const header2 = sheet.getRange(2,1,1,sheet.getLastColumn()).getValues()[0];\n  return { header1, header2 };\n}\nfunction mergedKeysFromTwoTiers_(header1, header2) {\n  return header1.map((t1,i)=>`${t1}:${header2[i]}`);\n}\nfunction cacheHeaders(sheet) {\n  const {header1, header2} = readTwoTierHeaders_(sheet);\n  setProp(SP_KEYS.HEADER_CACHE, JSON.stringify({header1, header2}));\n}\nfunction getCachedHeadersOrRead(sheet) {\n  let cached = getProp(SP_KEYS.HEADER_CACHE, '');\n  if (cached) try { return JSON.parse(cached); } catch(_){}\n  const hh = readTwoTierHeaders_(sheet);\n  setProp(SP_KEYS.HEADER_CACHE, JSON.stringify(hh));\n  return hh;\n}\nfunction clearHeaderCache() {\n  PropertiesService.getDocumentProperties().deleteProperty(SP_KEYS.HEADER_CACHE);\n  SpreadsheetApp.getActive().toast('üßπ Header cache cleared.');\n}\n\n// Ensure Batch_Reports tab exists\nfunction ensureBatchReportsSheet_() {\n  const ss = SpreadsheetApp.getActive();\n  let s = ss.getSheetByName('Batch_Reports');\n  if (!s) s = ss.insertSheet('Batch_Reports');\n  // minimal header\n  if (s.getLastRow() === 0) {\n    s.appendRow(['Timestamp','Mode','Created','Skipped','Duplicates','Errors','Estimated Cost (USD)','Elapsed']);\n  }\n  return s;\n}\n\n\n// ========== 3) SIDEBAR (Dark) ==========\n\nfunction openSimSidebar() {\n  const ss = SpreadsheetApp.getActive();\n  const allSheets = ss.getSheets().map(s=>s.getName());\n\n  // ‚≠ê Auto-refresh: ensure Settings!A1 points to a valid Convert sheet\n  try {\n    const settingsSheet = ss.getSheetByName('Settings');\n    const storedOut = settingsSheet ? settingsSheet.getRange('A1').getValue() : '';\n    const exists = allSheets.includes(storedOut);\n    if (!exists && allSheets.length) {\n      const fallback = allSheets.find(n => /convert/i.test(n))\n                  || allSheets.find(n => /master scenario csv/i.test(n))\n                  || allSheets[0];\n      if (settingsSheet) settingsSheet.getRange('A1').setValue(fallback);\n    }\n  } catch(err) {\n    Logger.log('Settings auto-refresh error: ' + err);\n  }\n\n  const lastInput  = getProp(SP_KEYS.LAST_INPUT_SHEET, '');\n  const lastOutput = getProp(SP_KEYS.LAST_OUTPUT_SHEET, '');\n  const savedModel = getProp(SP_KEYS.MODEL, DEFAULT_MODEL);\n  const savedApi   = getProp(SP_KEYS.API_KEY, '');\n\n  // ‚≠ê Dynamic output preference from Settings!A1\n  const settingsSheet = ss.getSheetByName('Settings');\n  const settingsOut = settingsSheet ? settingsSheet.getRange('A1').getValue() : '';\n\n  // Input = any with \"input\"; Output = only those with \"convert\"\n  const inputCandidates = allSheets.filter(n => /input/i.test(n));\n  const outputCandidates = allSheets.filter(n => /convert/i.test(n));\n\n  // Defaults\n  const defaultIn = inputCandidates.includes(lastInput)\n    ? lastInput\n    : (inputCandidates[0] || allSheets[0]);\n\n  const defaultOut =\n    outputCandidates.includes(settingsOut) ? settingsOut :\n    outputCandidates.includes(lastOutput) ? lastOutput :\n    (outputCandidates[0] || allSheets[0]);\n\n  const modelList = ['gpt-4o','gpt-4o','o4-mini','o3-mini'];\n  const modelOptions = modelList.map(m=>`<option value=\"${m}\" ${m===savedModel?'selected':''}>${m}</option>`).join('');\n  const inOpts  = inputCandidates.map(n=>`<option value=\"${n}\" ${n===defaultIn?'selected':''}>${n}</option>`).join('');\n  const outOpts = outputCandidates.map(n=>`<option value=\"${n}\" ${n===defaultOut?'selected':''}>${n}</option>`).join('');\n\n  const html = HtmlService.createHtmlOutput(`\n  <style>\n    body{font-family:Arial;margin:0;background:#f5f7fa;color:#2c3e50}\n    .bar{padding:14px 16px;background:#1b1f2a;border-bottom:1px solid #dfe3e8}\n    h2{margin:0;font-size:16px;letter-spacing:.3px}\n    .wrap{padding:16px}\n    .card{background:#ffffff;border:1px solid #dfe3e8;border-radius:10px;padding:14px;margin-bottom:12px}\n    label{font-size:12px;color:#9aa3b2}\n    select,input,textarea{width:100%;background:#f5f7fa;border:1px solid #30384b;color:#2c3e50;border-radius:8px;padding:8px}\n    .row{display:flex;gap:10px}\n    .col{flex:1}\n    button{background:#2357ff;border:0;color:#fff;padding:10px 12px;border-radius:8px;cursor:pointer}\n    button.sec{background:#dfe3e8}\n    .pill{display:inline-block;background:#dfe3e8;padding:6px 8px;border-radius:999px;font-size:12px}\n    .hint{color:#9aa3b2;font-size:12px}\n    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}\n    .log{height:180px}\n  </style>\n\n  <div class=\"bar\"><h2>${ICONS.rocket} Sim Mastery ‚Äî Batch & Single</h2></div>\n  <div class=\"wrap\">\n    <div class=\"card\">\n      <div class=\"grid2\">\n        <div>\n          <label>Input Sheet</label>\n          <select id=\"inputSheet\">${inOpts}</select>\n        </div>\n        <div>\n          <label>Output Sheet</label>\n          <select id=\"outputSheet\">${outOpts}</select>\n        </div>\n      </div>\n      <div class=\"grid2\" style=\"margin-top:10px;\">\n        <div>\n          <label>Model</label>\n          <select id=\"model\">${modelOptions}</select>\n        </div>\n        <div>\n          <label>API Key</label>\n          <input id=\"apiKey\" type=\"password\" value=\"${savedApi ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : ''}\" placeholder=\"sk-...\" />\n        </div>\n      </div>\n    </div>\n\n    <div class=\"card\">\n      <div class=\"row\">\n        <div class=\"col\">\n          <label>Run mode</label>\n          <select id=\"runMode\">\n            <option value=\"one\">Single Case</option>\n            <option value=\"next25\">Next 25 unprocessed</option>\n            <option value=\"specific\">Specific (e.g. 4,7,9-12)</option>\n            <option value=\"all\">All rows</option>\n          </select>\n        </div>\n        <div class=\"col\">\n          <label>Specific rows</label>\n          <input id=\"rowsSpec\" placeholder=\"4,7,9-12\" />\n        </div>\n      </div>\n      <div style=\"margin-top:10px;\">\n        <label style=\"display:flex;align-items:center;gap:8px;cursor:pointer;\">\n          <input type=\"checkbox\" id=\"forceReprocess\" style=\"width:auto;\" />\n          <span style=\"color:#ff6b6b;\">üîÑ Force Reprocess (ignore duplicates)</span>\n        </label>\n        <div class=\"hint\" style=\"margin-top:4px;\">\n          ‚ö†Ô∏è When enabled, will regenerate cases even if they already exist in output\n        </div>\n      </div>\n    </div>\n\n        <div class=\"card\">\n      <div class=\"row\">\n        <button onclick=\"start()\">üöÄ Launch Batch Engine</button>\n        <button class=\"sec\" onclick=\"stop()\">‚èπÔ∏è Stop</button>\n        <button class=\"sec\" onclick=\"check()\">üõ°Ô∏è Check API</button>\n      </div>\n      <div style=\"margin-top:10px;\">\n        <span class=\"pill\" id=\"statusPill\">Idle</span>\n      </div>\n      <div style=\"margin-top:10px;\">\n        <textarea id=\"log\" class=\"log\" placeholder=\"Live log...\" readonly></textarea>\n      </div>\n    </div>\n\n    <div class=\"card\">\n      <div class=\"row\" style=\"justify-content: space-between;\">\n        <button class=\"sec\" onclick=\"imgSync()\">üñºÔ∏è Image Sync Defaults</button>\n        <button class=\"sec\" onclick=\"openSettings()\">‚öôÔ∏è Settings</button>\n      </div>\n      <div class=\"hint\" style=\"margin-top:8px;\">\n        üí° Use ‚ÄúRun mode‚Äù to choose between Single Case, First 25, or All Rows.  \n        Then click <strong>Launch Batch Engine</strong>.\n      </div>\n    </div>\n  </div>\n    <!-- ü™µ Live Logs Panel (NEW) -->\n    <div class=\"card\" style=\"margin-top:12px;\">\n      <div class=\"row\" style=\"justify-content: space-between; align-items:center;\">\n        <strong style=\"color:#ff82a9;\">ü™µ Live Logs</strong>\n        <div>\n          <button id=\"copyLogsBtn\" class=\"log-btn copy\">Copy Logs</button>\n          <button id=\"refreshLogsBtn\" class=\"log-btn\">Refresh</button>\n          <button id=\"clearLogsBtn\" class=\"log-btn danger\">Clear</button>\n        </div>\n      </div>\n      <pre id=\"logOutput\" class=\"log-output\">No logs yet.</pre>\n    </div>\n\n    <style>\n      .log-btn {\n        background: #1a1a1a;\n        color: #0f0;\n        border: 1px solid #0f0;\n        padding: 2px 8px;\n        margin-left: 4px;\n        border-radius: 4px;\n        cursor: pointer;\n        font-size: 11px;\n        transition: all 0.2s ease;\n      }\n      .log-btn:hover {\n        background: #0f0;\n        color: #000;\n      }\n      .log-btn.copy {\n        color: #58a6ff;\n        border-color: #58a6ff;\n      }\n      .log-btn.copy:hover {\n        background: #58a6ff;\n        color: #000;\n      }\n      .log-btn.danger {\n        color: #f55;\n        border-color: #f55;\n      }\n      .log-btn.danger:hover {\n        background: #f55;\n        color: #000;\n      }\n      .log-output {\n        white-space: pre-wrap;\n        background: #000;\n        color: #0f0;\n        padding: 8px;\n        border-radius: 6px;\n        margin-top: 4px;\n        max-height: 300px;\n        overflow-y: auto;\n        border: 1px solid #222;\n      }\n      .new-log-line {\n        animation: fadeInNew 0.6s ease-out;\n      }\n      @keyframes fadeInNew {\n        from { color: #9aff9a; background-color: rgba(0,255,0,0.05); }\n        to { color: #0f0; background-color: transparent; }\n      }\n    </style>\n\n    <script>\n      // === LOG VIEWER HANDLERS ===\n      let lastLogs = '';\n\n      function refreshLogs() {\n        google.script.run\n          .withSuccessHandler((logs) => {\n            const output = document.getElementById('logOutput');\n            if (logs && logs !== lastLogs) {\n              const diff = logs.replace(lastLogs, '').trim();\n              if (diff) {\n                const newLine = document.createElement('div');\n                newLine.textContent = diff;\n                newLine.classList.add('new-log-line');\n                output.appendChild(newLine);\n              } else {\n                output.textContent = logs;\n              }\n              output.scrollTop = output.scrollHeight;\n              lastLogs = logs;\n            }\n            if (!logs) output.textContent = 'No logs yet.';\n          })\n          .getSidebarLogs();\n      }\n\n      function clearLogs() {\n        google.script.run\n          .withSuccessHandler((msg) => {\n            document.getElementById('logOutput').textContent = msg;\n            lastLogs = '';\n          })\n          .clearSidebarLogs();\n      }\n\n      function copyLogs() {\n        const logText = document.getElementById('logOutput').textContent;\n        if (!logText || logText === 'No logs yet.') {\n          alert('No logs to copy!');\n          return;\n        }\n\n        // Copy to clipboard\n        navigator.clipboard.writeText(logText).then(() => {\n          const btn = document.getElementById('copyLogsBtn');\n          const originalText = btn.textContent;\n          btn.textContent = '‚úì Copied!';\n          btn.style.color = '#0f0';\n          btn.style.borderColor = '#0f0';\n          setTimeout(() => {\n            btn.textContent = originalText;\n            btn.style.color = '#58a6ff';\n            btn.style.borderColor = '#58a6ff';\n          }, 2000);\n        }).catch(err => {\n          alert('Failed to copy logs: ' + err);\n        });\n      }\n\n      document.getElementById('copyLogsBtn').addEventListener('click', copyLogs);\n      document.getElementById('refreshLogsBtn').addEventListener('click', refreshLogs);\n      document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);\n\n      // Auto-refresh every 5 seconds\n      setInterval(refreshLogs, 5000);\n    </script>\n  <script>\n    document.addEventListener('DOMContentLoaded', () => {\n      console.log('‚úÖ Sidebar loaded');\n    });\n\n    function appendLog(t){ const ta=document.getElementById('log'); ta.value += t + \"\\\\n\"; ta.scrollTop = ta.scrollHeight; }\n    function setStatus(s){ document.getElementById('statusPill').textContent = s; }\n\n    function persistBasics(){\n      const apiRaw = document.getElementById('apiKey').value.trim();\n      const outVal = document.getElementById('outputSheet').value;\n      google.script.run.saveSidebarBasics(\n        document.getElementById('model').value,\n        (apiRaw && apiRaw!=='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') ? apiRaw : '',\n        '', '',\n        document.getElementById('inputSheet').value,\n        outVal\n      );\n      google.script.run.setOutputSheet(outVal);\n    }\n\n    function loopStep(){\n      // Get next row number from queue\n      google.script.run\n          .withSuccessHandler(function(report){\n            if (report.done){\n              setStatus('‚úÖ Complete');\n              appendLog(report.msg || '‚úÖ Batch complete!');\n              return;\n            }\n\n            // ‚≠ê Call the EXACT same function single mode uses!\n            appendLog('üìä Processing row ' + report.row + ' (' + report.remaining + ' remaining)...');\n\n            google.script.run\n              .withSuccessHandler(function(result){\n                appendLog('‚úÖ Row ' + report.row + ' complete');\n                setTimeout(loopStep, 1500); // Next row after 1.5s\n              })\n              .withFailureHandler(function(e){\n                const errorMsg = e && e.message ? e.message : (e ? String(e) : 'Unknown error');\n                appendLog('‚ùå Row ' + report.row + ' error: ' + errorMsg);\n                setTimeout(loopStep, 1500); // Continue despite error\n              })\n              .runSingleCaseFromSidebar(report.inputSheetName, report.outputSheetName, report.row);\n          })\n          .withFailureHandler(function(e){\n            const errorMsg = e && e.message ? e.message : (e ? String(e) : 'Unknown error');\n            appendLog('‚ùå Batch error: ' + errorMsg);\n            setStatus('Error');\n          })\n          .runSingleStepBatch();\n    }\n    function start(){\n  persistBasics();\n  setStatus('Running...');\n  const mode = document.getElementById('runMode').value;\n  const spec = document.getElementById('rowsSpec').value.trim();\n  const inputSheet = document.getElementById('inputSheet').value;\n  const outputSheet = document.getElementById('outputSheet').value;\n  const forceReprocess = document.getElementById('forceReprocess').checked;\n\n  // Log if force reprocess is enabled\n  if (forceReprocess) {\n    appendLog('‚ö†Ô∏è Force Reprocess enabled - will ignore duplicates');\n  }\n\n  // Store force flag in properties for processOneInputRow_ to access\n  google.script.run.setProp('FORCE_REPROCESS', forceReprocess ? '1' : '0');\n\n  // Handle single-case mode directly\n  if (mode === 'one' || mode === 'single' || mode === 'Single Case') {\n    const rowNum = parseInt(spec || prompt('Enter row number to process (>=4):'), 10);\n    if (!rowNum) {\n      appendLog('‚ö†Ô∏è No row selected, cancelling.');\n      setStatus('Idle');\n      return;\n    }\n\n    google.script.run\n      .withSuccessHandler(m => {\n        appendLog(m || '‚úÖ Done.');\n        setStatus('Idle');\n        if (m && m.includes('Error')) alert(m);\n      })\n      .withFailureHandler(e => {\n        appendLog('‚ùå Single-case error: ' + e.message);\n        alert('‚ùå Single-case error: ' + e.message);\n        setStatus('Idle');\n      })\n      .runSingleCaseFromSidebar(inputSheet, outputSheet, rowNum);\n\n    return; // stop here, no batch loop\n  }\n\n  // Otherwise run normal batch flow\n  google.script.run\n    .withSuccessHandler(msg => {\n      appendLog(msg || '‚úÖ Batch started.');\n      loopStep(); // begin step loop\n    })\n    .withFailureHandler(e => {\n      appendLog('‚ùå Batch start error: ' + e.message);\n      setStatus('Idle');\n    })\n    .startBatchFromSidebar(inputSheet, outputSheet, mode, spec);\n}\n\nfunction stop(){\n  google.script.run.stopBatch();\n  setStatus('Stopping...');\n  appendLog('Stop requested.');\n}\n\nfunction imgSync(){ google.script.run.openImageSyncDefaults(); }\nfunction openSettings(){ google.script.run.openSettingsPanel(); }\nfunction check(){ google.script.run.checkApiStatus(); }\n  </script>\n  `)\n  .setWidth(540)\n  .setHeight(720)\n  .setSandboxMode(HtmlService.SandboxMode.IFRAME);\n\n  getSafeUi_().showSidebar(html);\n}\n\n// ‚≠ê UPDATED HELPERS\nfunction saveSidebarBasics(model, apiKeyMaybe, priceIn, priceOut, inputSheet, outputSheet) {\n  if (model) setProp(SP_KEYS.MODEL, model);\n  if (apiKeyMaybe) setProp(SP_KEYS.API_KEY, apiKeyMaybe);\n  if (inputSheet) setProp(SP_KEYS.LAST_INPUT_SHEET, inputSheet);\n  if (outputSheet) {\n    setProp(SP_KEYS.LAST_OUTPUT_SHEET, outputSheet);\n    setOutputSheet(outputSheet);\n  }\n}\n\n\n\nfunction logLong(label, text) {\n  try {\n    const chunkSize = 8000; // safe for Apps Script logs\n    if (!text) {\n      appendLogSafe(`(no text to log for ${label})`);\n      return;\n    }\n    for (let i = 0; i < text.length; i += chunkSize) {\n      const chunk = text.substring(i, i + chunkSize);\n      appendLogSafe(`${label} [${i / chunkSize + 1}]:\\n${chunk}`);\n    }\n  } catch (err) {\n    appendLogSafe(`logLong error: ${err}`);\n  }\n}\n\n// ‚≠ê Debug helper: safely log very long AI outputs in chunks\n\nfunction getSidebarLogs() {\n  try {\n    const logs = PropertiesService.getDocumentProperties().getProperty('Sidebar_Logs') || '';\n    return logs;\n  } catch (err) {\n    return 'Error retrieving logs: ' + err;\n  }\n}\n\nfunction clearSidebarLogs() {\n  try {\n    PropertiesService.getDocumentProperties().deleteProperty('Sidebar_Logs');\n    return 'üßπ Logs cleared.';\n  } catch (err) {\n    return 'Error clearing logs: ' + err;\n  }\n}\n\n// ‚≠ê NEW: Writes chosen output sheet to Settings!A1\nfunction setOutputSheet(sheetName) {\n  const s = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Settings');\n  if (!s) throw new Error('Settings sheet not found.');\n  s.getRange('A1').setValue(sheetName);\n}\n\n// ‚≠ê Helper for saving property values\n\n// ========== 4) BATCH QUEUE & ENGINE ==========\n\nfunction stopBatch() { setProp('BATCH_STOP','1'); }\n\nfunction parseRowSpec_(spec) {\n  const out = new Set();\n  if (!spec) return [];\n  spec.split(',').map(s=>s.trim()).forEach(token=>{\n    if (/^\\d+$/.test(token)) out.add(parseInt(token,10));\n    else if (/^\\d+\\-\\d+$/.test(token)) {\n      const [a,b] = token.split('-').map(n=>parseInt(n,10));\n      const lo = Math.min(a,b), hi = Math.max(a,b);\n      for (let r=lo; r<=hi; r++) out.add(r);\n    }\n  });\n  return Array.from(out).sort((a,b)=>a-b);\n}\n\n\n\n\n\n\n\n// === SMART BATCH: Calculate next 25 rows based on output sheet progress ===\nfunction getNext25InputRows_(inputSheet, outputSheet) {\n  appendLogSafe('üîç Starting robust row detection (Case_ID comparison method)...');\n\n  const inputLast = inputSheet.getLastRow();\n  const outputLast = outputSheet.getLastRow();\n\n  appendLogSafe(`üìä Input sheet last row: ${inputLast}`);\n  appendLogSafe(`üìä Output sheet last row: ${outputLast}`);\n\n  // Read all Case_IDs from Output sheet (Column A, rows 3+)\n  const processedCaseIds = new Set();\n  if (outputLast >= 3) {\n    const outputCaseIds = outputSheet.getRange(3, 1, outputLast - 2, 1).getValues();\n    outputCaseIds.forEach(row => {\n      const caseId = String(row[0] || '').trim();\n      if (caseId) {\n        processedCaseIds.add(caseId);\n      }\n    });\n  }\n\n  appendLogSafe(`‚úÖ Found ${processedCaseIds.size} processed Case_IDs in Output`);\n\n  // IMPORTANT: Input sheet structure\n  // Row 1: Tier 1 headers\n  // Row 2: Tier 2 headers\n  // Row 3+: Data\n  //\n  // The Input sheet does NOT have Case_ID pre-filled.\n  // Case_ID is GENERATED during processing.\n  //\n  // Strategy: Since we can't predict Case_ID from Input data,\n  // we use row position correlation:\n  // - Input row 3 ‚Üí Output row 3 (first data row)\n  // - Input row 4 ‚Üí Output row 4 (second data row)\n  // - etc.\n  //\n  // If Output has N data rows (rows 3 through 3+N-1),\n  // then Input rows 3 through 3+N-1 have been processed.\n  // Next unprocessed Input row = 3 + N\n\n  const outputDataRows = Math.max(0, outputLast - 2);\n  const nextInputRow = 3 + outputDataRows;\n\n  appendLogSafe(`üìä Output has ${outputDataRows} data rows`);\n  appendLogSafe(`üìä Next unprocessed Input row: ${nextInputRow}`);\n\n  // Build array of next 25 rows to process\n  const availableRows = [];\n  for (let r = nextInputRow; r <= inputLast && availableRows.length < 25; r++) {\n    availableRows.push(r);\n  }\n\n  appendLogSafe(`‚úÖ Found ${availableRows.length} unprocessed rows`);\n  if (availableRows.length > 0) {\n    appendLogSafe(`üìã Rows to process: [${availableRows.slice(0, 5).join(', ')}${availableRows.length > 5 ? '...' : ''}]`);\n  }\n\n  return availableRows;\n}\nfunction getAllInputRows_(inputSheet, outputSheet) {\n  appendLogSafe('üîç Starting detection for ALL remaining rows...');\n\n  const inputLast = inputSheet.getLastRow();\n  const outputLast = outputSheet.getLastRow();\n\n  appendLogSafe(`üìä Input sheet last row: ${inputLast}`);\n  appendLogSafe(`üìä Output sheet last row: ${outputLast}`);\n\n  // Count processed rows\n  const outputDataRows = Math.max(0, outputLast - 2);\n  const nextInputRow = 3 + outputDataRows;\n\n  appendLogSafe(`üìä Output has ${outputDataRows} processed rows`);\n  appendLogSafe(`üìä Next unprocessed Input row: ${nextInputRow}`);\n\n  // Build array of ALL remaining rows\n  const availableRows = [];\n  for (let r = nextInputRow; r <= inputLast; r++) {\n    availableRows.push(r);\n  }\n\n  appendLogSafe(`‚úÖ Found ${availableRows.length} unprocessed rows (all remaining)`);\n  if (availableRows.length > 0) {\n    appendLogSafe(`üìã Will process rows ${availableRows[0]} through ${availableRows[availableRows.length-1]}`);\n  }\n\n  return availableRows;\n}\nfunction getSpecificInputRows_(inputSheet, outputSheet, spec) {\n  appendLogSafe(`üîç Starting detection for SPECIFIC rows: ${spec}`);\n\n  const outputLast = outputSheet.getLastRow();\n\n  // Build set of already-processed row numbers\n  // Since Input row N ‚Üí Output row N, rows 3 through (outputLast) are processed\n  const processedRows = new Set();\n  const outputDataRows = Math.max(0, outputLast - 2);\n\n  for (let r = 3; r < 3 + outputDataRows; r++) {\n    processedRows.add(r);\n  }\n\n  appendLogSafe(`üìä Already processed rows: 3 through ${2 + outputDataRows} (${processedRows.size} total)`);\n\n  // Parse the spec (supports \"5,10,15\" or \"5-10\" or mixed \"5-10,15,20-25\")\n  const requestedRows = parseRowSpec(spec);\n\n  appendLogSafe(`üìã Requested rows: [${requestedRows.join(', ')}]`);\n\n  // Filter out already-processed rows\n  const availableRows = requestedRows.filter(r => !processedRows.has(r));\n\n  if (availableRows.length < requestedRows.length) {\n    const skipped = requestedRows.filter(r => processedRows.has(r));\n    appendLogSafe(`‚ö†Ô∏è  Skipping already-processed rows: [${skipped.join(', ')}]`);\n  }\n\n  appendLogSafe(`‚úÖ Will process ${availableRows.length} rows: [${availableRows.join(', ')}]`);\n\n  return availableRows;\n}\n\nfunction parseRowSpec(spec) {\n  const rows = [];\n  const parts = spec.split(',');\n\n  parts.forEach(part => {\n    part = part.trim();\n    if (part.includes('-')) {\n      // Range: \"5-10\"\n      const range = part.split('-');\n      const start = parseInt(range[0].trim(), 10);\n      const end = parseInt(range[1].trim(), 10);\n      for (let r = start; r <= end; r++) {\n        if (!rows.includes(r)) {\n          rows.push(r);\n        }\n      }\n    } else {\n      // Single row: \"5\"\n      const r = parseInt(part, 10);\n      if (!rows.includes(r)) {\n        rows.push(r);\n      }\n    }\n  });\n\n  // Sort numerically\n  return rows.sort((a, b) => a - b);\n}\n\n\n\nfunction startBatchFromSidebar(inputSheetName, outputSheetName, mode, spec) {\n  const ss = SpreadsheetApp.getActive();\n  const inSheet = ss.getSheetByName(inputSheetName);\n  let outSheet = ss.getSheetByName(outputSheetName);\n\n  // Dynamic output sheet detection (check Settings)\n  const settingsSheet = ss.getSheetByName('Settings');\n  const settingsOut = settingsSheet ? settingsSheet.getRange('A1').getValue() : '';\n  if (settingsOut) {\n    outSheet = ss.getSheetByName(settingsOut) || outSheet;\n  }\n\n  if (!inSheet || !outSheet) {\n    throw new Error('‚ùå Could not find selected sheets.');\n  }\n\n  cacheHeaders(outSheet);\n\n  appendLogSafe('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');\n  appendLogSafe(`üìã Starting batch mode: ${mode}`);\n  appendLogSafe('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');\n\n  let rows;\n\n  if (mode === 'next25') {\n    rows = getNext25InputRows_(inSheet, outSheet);\n  } else if (mode === 'all') {\n    rows = getAllInputRows_(inSheet, outSheet);\n  } else if (mode === 'specific') {\n    rows = getSpecificInputRows_(inSheet, outSheet, spec);\n  } else {\n    throw new Error('Unknown batch mode: ' + mode);\n  }\n\n  if (!rows || rows.length === 0) {\n    appendLogSafe('‚ö†Ô∏è  No rows to process.');\n    return { success: false, message: 'No unprocessed rows found.' };\n  }\n\n  // Save queue to DocumentProperties (separate properties for reliability)\n  setProp('BATCH_ROWS', JSON.stringify(rows));\n  setProp('BATCH_INPUT_SHEET', inputSheetName);\n  setProp('BATCH_OUTPUT_SHEET', outputSheetName);\n  setProp('BATCH_MODE', mode);\n  setProp('BATCH_SPEC', spec);\n  setProp('BATCH_STOP', ''); // Clear stop flag\n\n  // Also save as single queue object for backwards compatibility\n  const q = {\n    rows: rows,\n    inputSheetName: inputSheetName,\n    outputSheetName: outputSheetName,\n    mode: mode,\n    spec: spec\n  };\n  setProp('BATCH_QUEUE', JSON.stringify(q));\n\n  appendLogSafe(`‚úÖ Batch queued with ${rows.length} row(s)`);\n  appendLogSafe(`üìã Rows: [${rows.slice(0, 10).join(', ')}${rows.length > 10 ? '...' : ''}]`);\n  appendLogSafe('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');\n\n  return { success: true, count: rows.length, rows: rows };\n}\n\nfunction runSingleStepBatch() {\n  // Try reading from separate properties first (more reliable)\n  const rowsJson = getProp('BATCH_ROWS', '[]');\n  const rows = JSON.parse(rowsJson);\n\n  // Build queue object from separate properties\n  const q = {\n    rows: rows,\n    inputSheetName: getProp('BATCH_INPUT_SHEET', ''),\n    outputSheetName: getProp('BATCH_OUTPUT_SHEET', ''),\n    mode: getProp('BATCH_MODE', ''),\n    spec: getProp('BATCH_SPEC', '')\n  }\n\n  // Check if we have rows left\n  if (!q.rows || q.rows.length === 0) {\n    return { done: true, msg: '‚úÖ All rows processed!' };\n  }\n\n  if (getProp('BATCH_STOP','')) {\n    return { done: true, msg: 'Stopped by user.' };\n  }\n\n  // ‚≠ê Just pop and return the row number - don't process it here!\n  const nextRow = q.rows.shift();\n\n  // Save updated queue\n  // Update the rows property\n  setProp('BATCH_ROWS', JSON.stringify(q.rows));\n  // Also update full queue for backward compatibility\n  setProp('BATCH_QUEUE', JSON.stringify(q));\n\n  // Return the row number and queue data so loopStep can call runSingleCaseFromSidebar\n  return {\n    done: false,\n    row: nextRow,\n    remaining: q.rows.length,\n    inputSheetName: q.inputSheetName,\n    outputSheetName: q.outputSheetName\n  };\n}\nfunction finishBatchAndReport() {\n  const log = JSON.parse(getProp('BATCH_LOG','{}'));\n  const elapsedMs = Date.now() - (log.started||Date.now());\n  const minutes = (elapsedMs/60000).toFixed(1);\n  const report = `\n${ICONS.clipboard} Batch Summary Report\nCreated: ${log.created||0}\nSkipped: ${log.skipped||0}\nDuplicates: ${log.dupes||0}\nErrors: ${log.errors||0}\nElapsed: ${minutes} min\n  `.trim();\n\n  const s = ensureBatchReportsSheet_();\n  s.appendRow([new Date(), 'Batch', log.created||0, log.skipped||0, log.dupes||0, log.errors||0, '', `${minutes} min`]);\n\n  // Clear force reprocess flag after batch completes\n  setProp('FORCE_REPROCESS', '0');\n\n  if (getSafeUi_()) { getSafeUi_().alert(report); }\n  return report;\n}\n\n// ========== 5) SINGLE CASE GENERATOR (also used by batch) ==========\n\nfunction runSingleCaseFromSidebar(inputSheetName, outputSheetName, row) {\n  const ss = SpreadsheetApp.getActive();\n\n  // Define the input and output sheets first\n  const inSheet = ss.getSheetByName(inputSheetName);\n  let outSheet = ss.getSheetByName(outputSheetName);\n\n  // ‚≠ê Dynamic output sheet detection\n  const settingsSheet = ss.getSheetByName('Settings');\n  const settingsOut = settingsSheet ? settingsSheet.getRange('A1').getValue() : '';\n  if (settingsOut) outSheet = ss.getSheetByName(settingsOut) || outSheet;\n\n  // Validate\n  if (!inSheet || !outSheet) throw new Error('‚ùå Could not find selected sheets.');\n\n  cacheHeaders(outSheet);\n  const result = processOneInputRow_(inSheet, outSheet, row, /*batchMode*/ false);\n\n  // Note: Toast disabled for sidebar operations - sidebar logs provide feedback\n  // if (result.message) {\n  //   showToast(result.message, 3);\n  // }\n\n  return result.message;\n}\n\n\n\n\n// === CLINICAL DEFAULTS: Fill missing vitals with medically realistic values ===\n/**\n * Applies clinical defaults to any missing Monitor_Vital_Signs fields.\n * Called during batch processing to ensure every scenario has complete vitals.\n *\n * Strategy:\n * - Baseline vitals: HR 75, BP 120/80, RR 16, Temp 37.0, SpO2 98, EtCO2 35\n * - Critical scenarios (detected by keywords): Elevated baseline\n * - State progression: Gradual improvement from State1 ‚Üí State5\n * - Metadata: Standard monitoring setup\n */\nfunction applyClinicalDefaults_(parsed, mergedKeys) {\n  Logger.log('ü©∫ Applying clinical defaults for missing vitals...');\n\n  // Baseline vitals (stable adult)\n  const BASELINE = {\n    HR: 75,\n    BP: '120/80',\n    RR: 16,\n    Temp: 37.0,\n    SpO2: 98,\n    EtCO2: 35\n  };\n\n  // Critical scenario baseline (elevated)\n  const CRITICAL_BASELINE = {\n    HR: 110,\n    BP: '90/60',\n    RR: 24,\n    Temp: 37.0,\n    SpO2: 92,\n    EtCO2: 32\n  };\n\n  // Check if this is a critical scenario\n  const title = (parsed['Case_Organization:Spark_Title'] || '').toLowerCase();\n  const category = (parsed['Case_Organization:Category'] || '').toLowerCase();\n  const desc = (parsed['Case_Organization:Formal_Description'] || '').toLowerCase();\n  const context = title + ' ' + category + ' ' + desc;\n\n  const isCritical = /cardiac|arrest|shock|trauma|sepsis|stroke|critical|emergency|unstable/i.test(context);\n\n  const baseVitals = isCritical ? CRITICAL_BASELINE : BASELINE;\n\n  if (isCritical) {\n    Logger.log('  üìä Critical scenario detected - using elevated baseline');\n  }\n\n  // Metadata fields (always fill if missing)\n  const metadata = {\n    'Monitor_Vital_Signs:Vitals_Format': 'Compact JSON (HR, BP, RR, Temp, SpO2, EtCO2)',\n    'Monitor_Vital_Signs:Vitals_API_Target': 'resusmonitor.com/api/vitals',\n    'Monitor_Vital_Signs:Vitals_Update_Frequency': '5 seconds',\n    'Situation_and_Environment_Details:Initial_Monitoring_Status': 'Standard 5-lead ECG, pulse oximetry, NIBP'\n  };\n\n  Object.keys(metadata).forEach(function(key) {\n    if (!parsed[key] || parsed[key] === 'N/A' || parsed[key] === '') {\n      parsed[key] = metadata[key];\n      Logger.log('  ‚úÖ Set ' + key);\n    }\n  });\n\n  // Vitals states with progression\n  const vitalsStates = [\n    { key: 'Monitor_Vital_Signs:Initial_Vitals', multiplier: 1.0, desc: 'Initial' },\n    { key: 'Monitor_Vital_Signs:State1_Vitals', multiplier: 1.1, desc: 'State 1 (worsening)' },\n    { key: 'Monitor_Vital_Signs:State2_Vitals', multiplier: 1.05, desc: 'State 2 (stabilizing)' },\n    { key: 'Monitor_Vital_Signs:State3_Vitals', multiplier: 0.95, desc: 'State 3 (improving)' },\n    { key: 'Monitor_Vital_Signs:State4_Vitals', multiplier: 0.9, desc: 'State 4 (responding)' },\n    { key: 'Monitor_Vital_Signs:State5_Vitals', multiplier: 0.85, desc: 'State 5 (resolving)' }\n  ];\n\n  vitalsStates.forEach(function(state) {\n    if (!parsed[state.key] || parsed[state.key] === 'N/A' || parsed[state.key] === '') {\n      // Create vitals object with progression\n      var vitals = {\n        HR: Math.round(baseVitals.HR * state.multiplier),\n        BP: baseVitals.BP,\n        RR: baseVitals.RR,\n        Temp: baseVitals.Temp,\n        SpO2: baseVitals.SpO2,\n        EtCO2: baseVitals.EtCO2\n      };\n\n      // Adjust other vitals based on HR change\n      if (state.multiplier > 1.0) {\n        // Worsening: Lower SpO2, higher RR\n        vitals.SpO2 = Math.max(88, baseVitals.SpO2 - Math.round((state.multiplier - 1) * 100));\n        vitals.RR = baseVitals.RR + Math.round((state.multiplier - 1) * 20);\n      } else if (state.multiplier < 1.0) {\n        // Improving: Return to baseline\n        vitals.SpO2 = Math.min(98, baseVitals.SpO2 + Math.round((1 - state.multiplier) * 20));\n        vitals.BP = BASELINE.BP; // Return to normal BP\n      }\n\n      // Final state returns to true baseline\n      if (state.key.includes('State5')) {\n        vitals = {\n          HR: BASELINE.HR,\n          BP: BASELINE.BP,\n          RR: BASELINE.RR,\n          Temp: BASELINE.Temp,\n          SpO2: BASELINE.SpO2,\n          EtCO2: BASELINE.EtCO2\n        };\n      }\n\n      parsed[state.key] = JSON.stringify(vitals);\n      Logger.log('  ‚úÖ Generated ' + state.desc + ': ' + parsed[state.key]);\n    }\n  });\n\n  Logger.log('‚úÖ Clinical defaults complete');\n  return parsed;\n}\n\nfunction processOneInputRow_(inputSheet, outputSheet, inputRow, batchMode) {\n  try {\n    // --- Read inputs per row: A=Formal_Info, B=HTML, C=DOC, D=Extra (any may be blank) ---\n    const formal = String(inputSheet.getRange(inputRow, 1).getValue() || '');\n    const html   = String(inputSheet.getRange(inputRow, 2).getValue() || '');\n    const docRaw = String(inputSheet.getRange(inputRow, 3).getValue() || '');\n    const extra  = String(inputSheet.getRange(inputRow, 4).getValue() || '');\n\n    if (!formal && !html && !docRaw && !extra) {\n      return { skipped: true, message: `Row ${inputRow}: no input.` };\n    }\n\n    appendLogSafe(`‚ñ∂Ô∏è Starting conversion for Row ${inputRow} (batchMode=${batchMode})`);\n\n    // --- Calculate content signature (always needed for writing) ---\n    const sniff = (formal + '\\n' + html + '\\n' + docRaw + '\\n' + extra).slice(0, 1000);\n    const sig = hashText(sniff);\n\n    // --- Duplicate check against output content signature (unless force reprocess enabled) ---\n    const forceReprocess = getProp('FORCE_REPROCESS', '0') === '1';\n    if (!forceReprocess) {\n      const allOut = outputSheet.getDataRange().getValues().flat().join('\\n');\n      if (allOut.indexOf(sig) !== -1) {\n        return { skipped: true, duplicate: true, message: `Row ${inputRow}: duplicate (hash match).` };\n      }\n    } else {\n      appendLogSafe(`üîÑ Force reprocess enabled - skipping duplicate check for Row ${inputRow}`);\n    }\n\n    // --- Clean + setup ---\n    const cleanedDoc = cleanDuplicateLines(docRaw);\n    const { header1, header2 } = getCachedHeadersOrRead(outputSheet);\n    const mergedKeys = mergedKeysFromTwoTiers_(header1, header2);\n    const exampleRow = outputSheet.getRange(3, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n\n    const hardReq = `Hard requirement: You must include every key exactly as listed in the header pairs. Use \"N/A\" only when truly unknown or not applicable. Avoid inventing URLs.`;\n        // --- Build AI example context from Rows 3 & 4 (distinct complete simulations) ---\n    function buildExampleJSON(rowValues) {\n      const obj = {};\n      mergedKeys.forEach((key, i) => {\n        const val = rowValues[i];\n        if (val && val !== 'N/A' && String(val).trim() !== '') {\n          obj[key] = val;\n        }\n      });\n      return obj;\n    }\n\n    let exampleJson1 = '{}';\n    let exampleJson2 = '{}';\n\n    try {\n      const exampleRow1 = outputSheet.getRange(3, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n      const exampleRow2 = outputSheet.getRange(4, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n\n      const data1 = buildExampleJSON(exampleRow1);\n      const data2 = buildExampleJSON(exampleRow2);\n\n      // --- Fallback demo if both are nearly empty ---\n      const isEmpty = (obj) => Object.keys(obj).length < 5;\n      const demoCase = {\n        \"Case_Organization:Case_ID\": \"DEMO001\",\n        \"Case_Organization:Spark_Title\": \"Chest Pain (45 M): Sudden Tightness\",\n        \"Monitor_Vital_Signs:Initial_Vitals\": {\"HR\":118,\"BP\":\"92/58\",\"RR\":28,\"Temp\":37.9,\"SpO2\":93},\n        \"Progression_States\": [\"Arrival\",\"Oxygen\",\"Stabilization\"],\n        \"Decision_Nodes_JSON\": [\n          {\n            \"at_state\": \"Arrival\",\n            \"decision\": \"Administer oxygen?\",\n            \"options\": [\n              {\"choice\":\"Yes\",\"next_state\":\"Oxygen\",\"rationale\":\"Improves hypoxia\"},\n              {\"choice\":\"No\",\"next_state\":\"Worsening\",\"rationale\":\"SpO2 continues to drop\"}\n            ]\n          }\n        ]\n      };\n\n      if (isEmpty(data1)) exampleJson1 = JSON.stringify(demoCase, null, 2);\n      else exampleJson1 = JSON.stringify(data1, null, 2);\n\n      if (isEmpty(data2)) exampleJson2 = JSON.stringify(demoCase, null, 2);\n      else exampleJson2 = JSON.stringify(data2, null, 2);\n\n    } catch (err) {\n      Logger.log('‚ö†Ô∏è Example-row build error: ' + err);\n      exampleJson1 = JSON.stringify({\n        \"Case_Organization:Case_ID\": \"DEMO_FALLBACK\",\n        \"Monitor_Vital_Signs:Initial_Vitals\": {\"HR\":100,\"BP\":\"110/70\",\"RR\":18,\"Temp\":36.8,\"SpO2\":98}\n      }, null, 2);\n      exampleJson2 = exampleJson1;\n    }\n    const systemPrompt = `\nüìò **Sim Mastery AI Prompt for Google Sheet CSV Row Generation**\n\nYou are an expert simulation designer helping build **Sim Mastery** ‚Äî an emotionally resonant, AI-facilitated, high-fidelity emergency-medicine simulation platform.  \nThis tool is used by clinicians to sharpen real-time decision-making and learn through immersive, branching, lifelike emergencies.\n\n---\n\nüí° **Objective**\nCreate a **one-row Google Sheet simulation case** that is:\n‚Ä¢ Unique to the given content  \n‚Ä¢ Clinically sound  \n‚Ä¢ Narratively immersive  \n‚Ä¢ Technically compatible with the Sim Mastery CSV  \n‚Ä¢ Valuable to the learner both intellectually and emotionally  \n\n---\n\nüß† **Philosophy**\n‚Ä¢ Help the learner *feel* what it‚Äôs like to manage chaos  \n‚Ä¢ Give just enough guidance ‚Äî do not spoon-feed  \n‚Ä¢ Reflect real-world uncertainty and triumph  \n‚Ä¢ Be emotionally anchored, educationally sound, and uplifting  \n\n---\n\nü©∫ **Vitals Format (Compact JSON)**\n\\`{\"HR\":120, \"BP\":\"95/60\", \"RR\":28, \"Temp\":39.2, \"SpO2\":94}\\`\n\n---\n\nü™Ñ **Tone & Style**\n‚Ä¢ Professional but warm  \n‚Ä¢ Support learner growth through tension and curiosity  \n‚Ä¢ Fun yet respectful of medicine‚Äôs seriousness  \n‚Ä¢ Use best practices of professional simulation facilitators  \n\n---\n\nüß™ **You Will Output**\n‚Ä¢ A single JSON object mapping directly to columns of the Google Sheet  \n‚Ä¢ Use the header1 and header2 context to align structure  \n‚Ä¢ If a cell value is missing, use \"N/A\" (especially for any Media_URL field)  \n‚Ä¢ Do **not** copy prior case content  \nGenerate a completely new simulation inspired by the HTML and DOC input  \n\n---\n\n‚ú® **Inputs Provided**\n‚Ä¢ header1 (Tier-1 categories)  \n‚Ä¢ header2 (Tier-2 column labels)  \n‚Ä¢ Example rows for structure only (Rows 3 and 4)  \n‚Ä¢ New HTML & DOC text as inspiration  \n\n---\n\nüî≠ **Simulation Semantics & Branching (Read Carefully)**\n\n1Ô∏è‚É£ **Row-level semantics**  \n- Treat this row as ONE complete simulation case.  \n- Each row is independent and self-contained (**rows = semantics**).  \n- Columns define structure (**headers = schema**).  \n- All content must form a single, coherent story for this row.  \n\n2Ô∏è‚É£ **Branching model (state machine)**  \n- Define ordered Progression_States and Decision_Nodes_JSON with clinician decisions and outcomes.  \n- Each state updates the clinical picture and **vitals** (compact JSON).  \n- Example: \\`{\"HR\":110,\"BP\":\"112/68\",\"RR\":24,\"Temp\":38.2,\"SpO2\":93}\\`  \n\n3Ô∏è‚É£ **Coherence & consequences**  \n- Decisions must have meaningful effects.  \n- Ensure logical paths and realistic values.  \n\n4Ô∏è‚É£ **Data discipline**  \n- Use exact merged keys \\`Tier1:Tier2\\`.  \n- Use \"N/A\" only when truly not applicable.  \n- Never invent URLs.  \n- Prefer structured JSON for vitals/monitor/decision fields.  \n\n5Ô∏è‚É£ **Inputs to respect**  \n- Use only FORMAL INFO, HTML, DOC, and EXTRA NOTES.  \n- Anchor physiology and logic to those inputs.  \n\n6Ô∏è‚É£ **Quality guardrails**  \n- Pre-diagnosis: exploratory, hypothesis-driven.  \n- Post-diagnosis: clear, educational, learning-point focused.  \n- Quiz/education columns must align with decision logic and outcomes.  \n\n---\n\n### üß© **Example Completed Cases**\n\nBelow are two example cases showing the complete structure and style of finished simulations.  \nEach is unique and represents its own independent case.\n\n**Example Case 1 (Row 3):**  \n${exampleJson1}\n\n**Example Case 2 (Row 4):**  \n${exampleJson2}\n\n---\n\n### ü§ñ **FUTURE USE CONTEXT (VERY IMPORTANT)**\n\nThe data you generate will be consumed by two systems working together:\n\n1. **Sim Mastery Engine**  \n   - The core platform that converts this CSV into an interactive, voice-responsive simulation.  \n   - It interprets each field as part of a larger, branching clinical scenario.  \n   - Clinicians will interact via mobile or desktop, speaking or selecting real-time decisions (e.g., \"push epi\", \"order CT\", \"intubate\").  \n   - The system will narrate, animate, and respond dynamically based on your structured output.\n\n2. **ResusVitals API**  \n   - A specialized vitals engine that dynamically updates the patient‚Äôs physiological parameters during simulation.  \n   - It reads from any field containing ‚ÄúVitals‚Äù or ‚ÄúMonitor‚Äù and interprets your compact nested JSON (e.g., {\"HR\":120,\"BP\":\"95/60\",\"RR\":28,\"Temp\":39.2,\"SpO2\":94}).  \n   - Vitals change as states and decisions progress (State0 ‚Üí State1 ‚Üí State2, etc.).\n\nYour role:  \n‚Ä¢ Treat this output as a **modular simulation blueprint**.  \n‚Ä¢ Each ‚Äúrow‚Äù is a self-contained scenario that future AI systems can reconstruct and run dynamically.  \n‚Ä¢ Each column is a structured data node used for narration, decision trees, vitals, scoring, and learning objectives.  \n‚Ä¢ Prioritize **machine-readability**, **coherence**, and **educational realism**.  \n\n---\nReturn your response **strictly as valid JSON** following this structure.  \nDo not include commentary, markdown, or text outside the JSON object.  \n`.trim();\n\n// --- Generate (force-JSON) & validate ---\nconst model = getProp(SP_KEYS.MODEL, DEFAULT_MODEL);\nappendLogSafe('ü§ñ Calling OpenAI to generate scenario...');\nconst aiResp = batchMode\n  ? callOpenAiJson(model, systemPrompt)\n  : callOpenAI(systemPrompt, DEFAULT_TEMP_SINGLE);\nappendLogSafe('‚úÖ Received OpenAI response, processing...');\n\n// --- Extract and sanitize JSON text ---\nlet aiText = '';\n\nif (batchMode) {\n  aiText = JSON.stringify(aiResp);\n} else {\n  // callOpenAI() returns raw text\n  aiText = typeof aiResp === 'string'\n    ? aiResp.trim()\n    : aiResp?.choices?.[0]?.message?.content?.trim() || '';\n}\n\n// Remove markdown fences or stray text before/after JSON\naiText = aiText\n  .replace(/^```(?:json)?/i, '')  // remove ```json or ```\n  .replace(/```$/i, '')           // remove trailing ```\n  .replace(/^[^{[]+/, '')         // remove anything before { or [\n  .replace(/[^}\\]]+$/, '');       // remove anything after } or ]\n\nconst parsed = tryParseJSON(aiText);\nappendLogSafe('üìù Parsing AI response and extracting fields...');\n\n// --- Debug helper: split long AI responses safely for logging ---\nfunction logLong_(label, text) {\n  const chunkSize = 9000; // avoid truncation in Apps Script logs\n  for (let i = 0; i < text.length; i += chunkSize) {\n    Logger.log(`${label} [${i / chunkSize + 1}]:\\n` + text.slice(i, i + chunkSize));\n  }\n}\n\nif (!parsed || typeof parsed !== 'object') {\n  logLong(`‚ùå Row ${inputRow} ‚Äî AI raw output`, typeof aiResp === 'string' ? aiResp : JSON.stringify(aiResp, null, 2));\n  appendLogSafe(`‚ùå Row ${inputRow}: AI JSON parse fail. See full output above.`);\n  return { error: true, message: `Row ${inputRow}: AI JSON parse fail.` };\n}\n\nappendLogSafe(`ü§ñ AI response parsed successfully for Row ${inputRow}`);\n\n// --- Validate/normalize vitals across any key containing 'vitals' or 'monitor' ---\nconst vitalsCheck = validateVitalsFields_(parsed, mergedKeys);\nif (!vitalsCheck.valid) {\n  const warnText = vitalsCheck.warnings.join(' | ');\n  Logger.log('‚ö†Ô∏è Vitals/Monitor validation: ' + warnText);\n  appendLogSafe('‚ö†Ô∏è ' + warnText);\n}\n\n// Log parsed field count for transparency\nLogger.log(`‚úÖ Parsed ${Object.keys(parsed).length} keys for Row ${inputRow}`);\n\n  // --- Apply clinical defaults for missing vitals ---\n  applyClinicalDefaults_(parsed, mergedKeys);\n\n  // --- Compact vitals if needed (object -> one-line JSON) ---\nmergedKeys.forEach(k => {\n  if (/vitals|monitor/i.test(k)) {\n    if (parsed[k] && typeof parsed[k] === 'object') parsed[k] = JSON.stringify(parsed[k]);\n    if (typeof parsed[k] === 'string') parsed[k] = parsed[k].trim();\n  }\n});\n    // --- Inject Image Sync defaults if empty ---\n    const imgDefaults = JSON.parse(getProp(SP_KEYS.IMG_SYNC_DEFAULTS, '{}') || '{}');\n    Object.keys(parsed).forEach(k => {\n      if (/^Image_Sync:/i.test(k)) {\n        const v = parsed[k];\n        if (v === undefined || v === null || v === '') {\n          if (imgDefaults[k] !== undefined) parsed[k] = imgDefaults[k];\n        }\n      }\n    });\n\n// --- Build output row (intelligent tiered matching) ---\nconst rowValues = mergedKeys.map(k => {\n  const val = extractValueFromParsed_(parsed, k);\n  return (val !== undefined && val !== null && String(val).trim() !== '') ? val : 'N/A';\n});\n\n// --- Store signature in meta column (if Conversion_Status exists) ---\nconst metaIdx = header2.indexOf('Conversion_Status');\nif (metaIdx > -1) {\n  const k = `${header1[metaIdx]}:${header2[metaIdx]}`;\n  const idx = mergedKeys.indexOf(k);\n  if (idx > -1) {\n    rowValues[idx] = (rowValues[idx] && rowValues[idx] !== 'N/A') ? `${rowValues[idx]} | ${sig}` : sig;\n  }\n}\n\n\n\n\n\n// --- Append row ---\nappendLogSafe(`üì§ Writing results for Row ${inputRow} to \"${outputSheet.getName()}\"`);\nappendLogSafe('üíæ Writing scenario to Master Scenario Convert...');\noutputSheet.appendRow(rowValues);\nappendLogSafe('‚úÖ Row created successfully');\nappendLogSafe(`‚úÖ Row ${inputRow} successfully written to sheet.`);\n// --- Always log parsed keys to sidebar for transparency ---\ntry {\n  const keys = Object.keys(parsed || {});\n  const naCount = rowValues.filter(v => v === 'N/A').length;\n  const naRatio = naCount / (rowValues.length || 1);\n  const missingKeys = mergedKeys.filter(k => !keys.includes(k));\n  const preview = JSON.stringify(parsed, null, 2).slice(0, 400); // short snippet\n\n  let message = `üìÑ Row ${inputRow} summary:\\n`;\n  message += `Detected keys: ${keys.join(', ') || 'none'}\\n`;\n  message += missingKeys.length ? `Missing keys: ${missingKeys.join(', ')}\\n` : '';\n  message += `N/A ratio: ${(naRatio * 100).toFixed(0)}%\\n`;\n  message += `Preview:\\n${preview}`;\n\n  if (typeof appendLog === 'function') appendLog(message);\n  Logger.log(message);\n} catch (debugErr) {\n  Logger.log('Debug logging failed: ' + debugErr);\n}\n\n// --- Skip quality scoring if row is empty or all N/A ---\nif (!rowValues || rowValues.every(v => v === 'N/A')) {\n  Logger.log(`‚ö†Ô∏è Skipping quality scoring for Row ${inputRow}: all N/A`);\n  return { created: true, message: `Row ${inputRow}: Created (all N/A)` };\n}\n\n    // --- Quality scoring + suggestions ---\n    try {\n      const { header1, header2 } = getCachedHeadersOrRead(outputSheet);\n      const mergedKeys = mergedKeysFromTwoTiers_(header1, header2);\n      const newRowIndex = outputSheet.getLastRow();\n      const quality = evaluateSimulationQuality(rowValues, mergedKeys);\n      attachQualityToRow_(outputSheet, newRowIndex, mergedKeys, rowValues, quality);\n    } catch (_) {\n      // Non-fatal: quality write is best-effort\n    }\n\n    // --- Cost estimate ---\n    const cost = estimateCostUSD(systemPrompt, aiText);\n    return { created: true, message: `Row ${inputRow}: Created. (~$${cost.toFixed(2)})`, cost };\n\n  } catch (e) {\n    return { error: true, message: `Row ${inputRow}: Error ‚Äî ${e.message}` };\n  }\n} // closes processOneInputRow_()\n\n\n// ========== 6) ATSR ‚Äî Titles & Summary (Keep & Regenerate, Deselect, Memory) ==========\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// ATSR TITLE OPTIMIZER v2 - COMPLETE IMPLEMENTATION\n// Mystery Button Feature + Progressive Title Obscuration\n// Updated: 2025-11-06T21:41:37.871Z\n// Features: 11/11 (Memory Anchors, Mystery Button, Sim Mastery, Quality Criteria)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// ========== 6) ATSR ‚Äî Titles & Summary (Keep & Regenerate, Deselect, Memory) ==========\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// ATSR TITLE OPTIMIZER v2 - COMPLETE IMPLEMENTATION\n// Mystery Button Feature + Progressive Title Obscuration\n// Updated: 2025-11-06T21:48:40.008Z\n// Features: 11/11 (Memory Anchors, Mystery Button, Sim Mastery, Quality Criteria)\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n// ========== 6) ATSR ‚Äî Titles & Summary (Keep & Regenerate, Deselect, Memory) ==========\n\nfunction runATSRTitleGenerator(continueRow, keepSelections) {\n  const ss = SpreadsheetApp.getActive();\n  const sheet = pickMasterSheet_();\n  if (!sheet) { getSafeUi_().alert('‚ùå Master Scenario CSV not found.'); return; }\n\n  let row = continueRow;\n  const ui = getSafeUi_();\n  if (!row) {\n    const resp = ui.prompt('Enter the row number for ATSR:', ui.ButtonSet.OK_CANCEL);\n    if (resp.getSelectedButton() !== ui.Button.OK) return;\n    row = parseInt(resp.getResponseText(),10);\n  }\n  if (isNaN(row) || row < 3) { ui.alert('Row must be ‚â• 3.'); return; }\n\n  const headers = sheet.getRange(2,1,1,sheet.getLastColumn()).getValues()[0];\n  const values  = sheet.getRange(row,1,1,sheet.getLastColumn()).getValues()[0];\n  const data = Object.fromEntries(headers.map((h,i)=>[h, values[i]]));\n\n  // Limit context to avoid token overflow\n  const usedMemory = getProp(SP_KEYS.USED_MOTIFS,'').substring(0, 300);\n\n  // Extract only essential fields for ATSR generation\n  const age = data['Patient_Demographics_and_Clinical_Data_Age'] || '';\n  const gender = data['Patient_Demographics_and_Clinical_Data_Gender'] || '';\n  const presenting = data['Patient_Demographics_and_Clinical_Data_Presenting_Complaint'] || '';\n  const vignette = data['Set_the_Stage_Context_Clinical_Vignette'] || '';\n  const why = data['Set_the_Stage_Context_Why_It_Matters'] || '';\n  const goal = data['Set_the_Stage_Context_Educational_Goal'] || '';\n\n  const caseDataFormatted = `\nAge: ${age}\nGender: ${gender}\nChief Complaint: ${presenting}\nClinical Vignette: ${vignette}\nEducational Goal: ${goal}\nWhy It Matters: ${why}`.trim();\n\n  // ========== ENHANCED RICH PROMPT WITH SIM MASTERY PHILOSOPHY ==========\n  const prompt = `\nüìò **Sim Mastery ATSR ‚Äî Automated Titles, Summary & Review Generator**\n\nYou are an expert simulation designer and marketing genius helping build **Sim Mastery** ‚Äî an emotionally resonant, AI-facilitated, high-fidelity emergency-medicine simulation platform.\n\nYour task is to create compelling, clinically accurate, and emotionally engaging titles and summaries for a medical simulation case that will be used by emergency medicine clinicians to sharpen their real-time decision-making skills.\n\n---\n\n## üß† **Core Philosophy: Sim Mastery Values**\n\n‚Ä¢ **Emotionally Resonant**: Help learners *feel* what it's like to manage chaos and experience triumph\n‚Ä¢ **Clinically Sound**: Every detail must be medically accurate and educationally valuable\n‚Ä¢ **Narratively Immersive**: Create intrigue, tension, and curiosity\n‚Ä¢ **Human-Centered**: Focus on the person behind the patient, not just the diagnosis\n‚Ä¢ **Growth-Oriented**: Support learner development through challenge and success\n‚Ä¢ **Professionally Warm**: Fun yet respectful of medicine's seriousness\n\n---\n\n## üéØ **Your Task: Create 4 Components**\n\n### 1. **Spark Titles** (5 variations)\n**Purpose**: Pre-sim mystery teaser that sells the learning experience WITHOUT spoiling the diagnosis\n\n**Format**:\n\\`\"<Chief Complaint> (<Age Sex>): <Emotionally Urgent Spark Phrase>\"\\`\n\n**Examples**:\n‚úÖ \"Chest Pain (47 M): Dizzy, Sweaty, and Terrified\"\n‚úÖ \"Shortness of Breath (5 F): Gasping After Birthday Cake\"\n‚úÖ \"Abdominal Pain (28 F): Pregnant and Worsening Fast\"\n\n**Rules**:\n- NO diagnosis mentioned (no \"MI\", \"anaphylaxis\", \"appendicitis\")\n- Observable symptoms only (what you see/hear)\n- Emotionally urgent language (\"terrified\", \"gasping\", \"worsening\")\n- Human details (age, gender, context clues)\n- Create intrigue without spoiling the mystery\n\n**Quality Criteria**:\n- Would an EM clinician FEEL the urgency?\n- Does it create curiosity without revealing the answer?\n- Is it specific enough to paint a vivid picture?\n- Does it respect the patient's humanity?\n\n---\n\n### 2. **Reveal Titles** (5 variations)\n**Purpose**: Post-sim reinforcement that celebrates the diagnosis and learning objective\n\n**Format**:\n\\`\"<Diagnosis> (<Age Sex>): <Key Learning Objective or Clinical Pearl>\"\\`\n\n**Examples**:\n‚úÖ \"Acute MI (55 M): Recognizing Atypical Presentations\"\n‚úÖ \"Anaphylaxis (8 M): Epinephrine Technique Saves Lives\"\n‚úÖ \"Ectopic Pregnancy (28 F): The One Test You Can't Skip\"\n\n**Rules**:\n- Diagnosis IS revealed (this is post-sim)\n- Focus on the KEY teaching point or clinical pearl\n- Emphasize what the learner will MASTER\n- Clinical accuracy is critical\n- Actionable takeaway (not just knowledge, but skill)\n\n**Quality Criteria**:\n- Does it reinforce the critical learning objective?\n- Would the learner feel PROUD to have mastered this?\n- Is the clinical pearl specific and actionable?\n- Does it emphasize competence and growth?\n\n---\n\n\n\n### 3. **Memory Anchors** (10 unique, unforgettable patient identifiers)\n\n**Purpose**: Help clinicians remember patients the way ED doctors naturally do - by distinctive, memorable details.\n\n**Philosophy**: ED doctors don't remember patients by medical details. They remember:\n- \"The tall skinny guy in overalls\"\n- \"Lady who doesn't like to shave her legs\"\n- \"SVT patient who's actually the sleep medicine doctor at our hospital\"\n- \"Methadone patient with facial tattoos\"\n- \"Kind lady holding a book\"\n- \"Pleasant spouse who stood when I came in\"\n\n**Memory Anchor Categories & Examples**:\n\n**A) Visual Appearance**:\n- Very sweaty face, pale complexion\n- Faded grey shirt with coffee stain\n- Unkempt appearance with bag of clothes\n- Unusual hair color/style\n- Distinctive facial features\n- Visible tattoos (location/theme)\n- Piercings or jewelry\n\n**B) Apparel & Accessories**:\n- AC/DC \"Thunderstruck\" concert t-shirt\n- BYU baseball cap (clearly a die-hard fan)\n- Sports team jersey (Lakers, Yankees, etc.)\n- Medical scrubs (works in healthcare)\n- Business suit (professional)\n- Vintage band t-shirt\n- Designer purse/bag\n- Small dog in carrier\n\n**C) Olfactory (Smell)**:\n- Pungent body odor\n- Heavy perfume/cologne\n- Cigarette smoke smell\n- Alcohol on breath\n- Fresh coffee smell\n\n**D) Behavioral/Personality**:\n- Annoyingly loud 3-year-old screaming in corner\n- Quiet and withdrawn, avoiding eye contact\n- Extremely talkative\n- Constantly on phone\n- Reading a specific book\n- Doing crossword puzzle\n- Nervous hand-wringing\n\n**E) Family/Social Context**:\n- Twin kids with patient\n- Huge family of 8 in the room\n- Daughter is an ER nurse (specify specialty)\n- Son translating (language barrier)\n- Service dog present\n- Worried spouse holding hand\n- Teenager rolling eyes\n\n**F) Occupation Clues**:\n- Carpenter (sawdust on clothes)\n- Teacher (grading papers)\n- Chef (kitchen burns on hands)\n- Nurse (works at same hospital)\n- Construction worker (hard hat)\n\n**G) Contextual/Situational**:\n- Came directly from gym\n- Still in pajamas at 3pm\n- Wearing hiking gear\n- Wedding ring tan line (divorced)\n- Military uniform/veteran\n\n**Rules for Memory Anchors**:\n1. **Highly specific**: \"BYU baseball cap\" not \"wearing a hat\"\n2. **Memorable**: Strong visual/sensory detail\n3. **Diverse**: Mix categories (visual, smell, behavior, context)\n4. **Stereotype-aware**: Use stereotypes clinicians naturally use (tall, unkempt, loud, etc.)\n5. **Personality-focused**: Adds human dimension to medical encounter\n6. **Personality-rich**: Kind, pleasant, annoying, withdrawn, talkative\n7. **Unique per patient**: NO reuse of anchors across cases\n8. **Culturally varied**: Different ethnicities, backgrounds, professions\n9. **Medically neutral**: NOT about the diagnosis itself\n10. **Unforgettable**: Would make you say \"Oh yeah, I remember that patient!\"\n\n**Examples of STRONG Memory Anchors**:\n‚úÖ \"Very sweaty face, pale complexion, looks terrified\"\n‚úÖ \"Wearing AC/DC 'Thunderstruck' concert t-shirt, vintage 1990\"\n‚úÖ \"Annoyingly loud 3-year-old screaming in corner (mom looks exhausted)\"\n‚úÖ \"Pleasant elderly man who stood up to shake my hand with firm grip\"\n‚úÖ \"Strong smell of cigarette smoke, yellow-stained fingers, smoker's voice\"\n‚úÖ \"Daughter is an ICU nurse at University Hospital (asking detailed questions)\"\n‚úÖ \"Huge family of 8 people crowding tiny room (all talking at once)\"\n‚úÖ \"Small yappy Chihuahua in designer Louis Vuitton purse (won't stop barking)\"\n‚úÖ \"Wearing faded grey 'World's Best Grandpa' shirt with coffee stain\"\n‚úÖ \"BYU baseball cap (clearly die-hard fan, keeps talking about last game)\"\n\n**Examples of WEAK Memory Anchors** (avoid these):\n‚ùå \"Middle-aged male\"\n‚ùå \"Overweight\"\n‚ùå \"Has diabetes\"\n‚ùå \"Chest pain patient\"\n‚ùå \"Anxious\"\n\n**Output Format**:\nProvide 10 Memory Anchors that:\n- Are ALL different categories/types\n- Are ALL unforgettable\n- Are ALL specific and vivid\n- Avoid reusing any motifs from: ${usedMemory}\n- Create unique, case-appropriate memory anchors based on the case data above\n\n**Quality Check**:\n- Would an ED doctor remember this patient by this detail? ‚úÖ\n- Is it vivid enough to picture in your mind? ‚úÖ\n- Is it different from the other 9 anchors? ‚úÖ\n- Does it add personality to the encounter? ‚úÖ\n\n---\n### 4. **Case Summary** (Structured narrative)\n**Purpose**: Concise, compelling summary that sells the value and humanizes the patient\n\n**Components**:\n\n**A) Patient_Summary** (3 sentences - CLINICAL HANDOFF STYLE):\n- Write like an ED doctor admitting to a hospitalist\n- GET TO THE POINT - diagnosis, presentation, key findings, disposition\n- NO mystery, NO drama - just the clinical facts\n- Include: chief complaint, vitals/exam findings, workup/diagnosis, management/disposition\n\n**Examples**:\n‚úÖ \"55M presents with acute substernal chest pain while shoveling snow. EKG shows STEMI, troponin elevated. Cath lab activated, given aspirin/heparin, admitted to CCU.\"\n‚úÖ \"8M with anaphylaxis after peanut exposure at birthday party. Presented with facial swelling, stridor, hypotension. IM epi given x2, improved, admitted for observation.\"\n‚úÖ \"72F fell at home, hip pain, unable to bear weight. X-ray confirms femoral neck fracture. Orthopedics consulted, scheduled for ORIF in AM.\"\n\n**B) Key_Intervention** (Short phrase):\n- The ONE action that changes the outcome\n- Specific, actionable, memorable\n- Focus on WHAT to do, not just WHY\n\n**Examples**:\n‚úÖ \"Immediate epinephrine (correct IM technique)\"\n‚úÖ \"Early aspirin + cath lab activation\"\n‚úÖ \"Surgical consult within 2 hours\"\n\n**C) Core_Takeaway** (Short phrase):\n- The clinical pearl they'll remember forever\n- Specific to THIS case\n- Actionable and confidence-building\n\n**Examples**:\n‚úÖ \"Atypical presentations kill‚Äîalways consider cardiac\"\n‚úÖ \"Epi first, questions later‚Äîtiming saves lives\"\n‚úÖ \"Beta-hCG in all women of childbearing age\"\n\n**D) Defining_Characteristic_Options** (5 unique, humanizing details):\n- Patient descriptors that add humanity and memorability\n- Avoid clich√©s and overused motifs\n- Make each case feel REAL and distinct\n- Mix physical, emotional, and contextual details\n\n**Examples**:\n‚úÖ \"Retired firefighter who's 'never been sick a day in his life'\"\n‚úÖ \"Soccer mom rushing from practice still in her coaching gear\"\n‚úÖ \"College student studying for finals, chugging energy drinks\"\n‚úÖ \"Grandmother who walked 3 blocks to the ED because she 'didn't want to bother anyone'\"\n‚úÖ \"Construction worker who delayed coming in because he 'thought it was just heartburn'\"\n\n**Rules for Defining Characteristics**:\n- Avoid motifs already used: ${usedMemory}\n- Each one should paint a distinct picture\n- Balance vulnerability with strength\n- Include context clues (occupation, activity, mindset)\n- Make the learner CARE about the patient\n\n---\n\n## üìã **Context from This Case**\n\n**Case Data** (Header: Value pairs from Google Sheet):\n${caseDataFormatted}\n\n**Motifs Already Used** (avoid these):\n${usedMemory || 'None yet'}\n\n---\n\n## üé® **Tone & Style Guidelines**\n\n**DO**:\n‚úÖ Use emotionally urgent language (\"terrified\", \"gasping\", \"worsening fast\")\n‚úÖ Focus on observable symptoms and human context\n‚úÖ Create intrigue and tension in Spark Titles\n‚úÖ Emphasize mastery and clinical pearls in Reveal Titles\n‚úÖ Make every detail clinically accurate and educationally sound\n‚úÖ Humanize the patient with specific, memorable details\n‚úÖ Paint vivid pictures that make the learner FEEL the scenario\n‚úÖ Use professional medical terminology appropriately\n\n**DON'T**:\n‚ùå Spoil the diagnosis in Spark Titles\n‚ùå Use clich√©s or overused phrases\n‚ùå Include medical jargon that obscures the human story\n‚ùå Create generic, forgettable descriptions\n‚ùå Duplicate existing motifs or patterns\n‚ùå Sacrifice clinical accuracy for drama\n‚ùå Make light of serious medical situations\n\n---\n\n## üß™ **Quality Checklist**\n\nBefore finalizing your output, verify:\n\n**Spark Titles**:\n- [ ] NO diagnosis revealed\n- [ ] Emotionally urgent and engaging\n- [ ] Observable symptoms only\n- [ ] Creates curiosity and tension\n- [ ] Human context included\n\n**Reveal Titles**:\n- [ ] Diagnosis clearly stated\n- [ ] Key learning objective emphasized\n- [ ] Actionable clinical pearl\n- [ ] Reinforces competence and mastery\n- [ ] Clinically accurate\n\n**Case IDs**:\n- [ ] Correct format (7-8 chars)\n- [ ] System prefix matches case\n- [ ] Uppercase letters + digits\n- [ ] Unique and memorable\n- [ ] No duplication\n\n**Case Summary**:\n- [ ] Patient_Summary paints vivid picture\n- [ ] Key_Intervention is specific and actionable\n- [ ] Core_Takeaway is memorable and valuable\n- [ ] Defining_Characteristics are unique and humanizing\n- [ ] No clich√©s or overused motifs\n- [ ] Emotionally resonant and clinically sound\n\n---\n\n## üì§ **Output Format (JSON)**\n\n{\n  \"Spark_Titles\": [\n    \"<Symptom> (<Age Sex>): <Spark Phrase>\",\n    \"<Symptom> (<Age Sex>): <Spark Phrase>\",\n    \"<Symptom> (<Age Sex>): <Spark Phrase>\",\n    \"<Symptom> (<Age Sex>): <Spark Phrase>\",\n    \"<Symptom> (<Age Sex>): <Spark Phrase>\"\n  ],\n  \"Reveal_Titles\": [\n    \"<Diagnosis> (<Age Sex>): <Learning Objective>\",\n    \"<Diagnosis> (<Age Sex>): <Learning Objective>\",\n    \"<Diagnosis> (<Age Sex>): <Learning Objective>\",\n    \"<Diagnosis> (<Age Sex>): <Learning Objective>\",\n    \"<Diagnosis> (<Age Sex>): <Learning Objective>\"\n  ],\n  \"Memory_Anchors\": [\n    \"Unforgettable patient detail #1\",\n    \"Unforgettable patient detail #2\",\n    \"Unforgettable patient detail #3\",\n    \"Unforgettable patient detail #4\",\n    \"Unforgettable patient detail #5\",\n    \"Unforgettable patient detail #6\",\n    \"Unforgettable patient detail #7\",\n    \"Unforgettable patient detail #8\",\n    \"Unforgettable patient detail #9\",\n    \"Unforgettable patient detail #10\"\n  ],\n  \"Case_Summary\": {\n    \"Patient_Summary\": \"A vivid 1-2 sentence description combining clinical urgency with human context, painting a clear picture of the scenario.\",\n    \"Key_Intervention\": \"The ONE specific action that changes the outcome\",\n    \"Core_Takeaway\": \"The clinical pearl they'll remember forever\",\n    \"Defining_Characteristic_Options\": [\n      \"Unique humanizing detail #1\",\n      \"Unique humanizing detail #2\",\n      \"Unique humanizing detail #3\",\n      \"Unique humanizing detail #4\",\n      \"Unique humanizing detail #5\"\n    ]\n  }\n}\n\n---\n\n## üéØ **Final Reminder: The Sim Mastery Standard**\n\nYou're not just creating titles and summaries‚Äîyou're crafting learning experiences that will stay with clinicians throughout their careers. Every word matters. Every detail should serve both the educational objective AND the emotional resonance.\n\nMake this case:\n‚Ä¢ Unforgettable\n‚Ä¢ Clinically impeccable\n‚Ä¢ Emotionally powerful\n‚Ä¢ Educationally transformative\n\nNow create your output. Make it AMAZING. üöÄ\n`;\n\n  // ========== END OF ENHANCED PROMPT ==========\n\n  Logger.log('üìä Prompt length: ' + prompt.length + ' characters');\n  Logger.log('üìä Case data length: ' + caseDataFormatted.length + ' characters');\n\n  const ai = callOpenAI(prompt, 0.7); // Temperature 0.7 for creative but consistent output\n  Logger.log('üìù AI response length: ' + ai.length + ' characters');\n  Logger.log('üìù AI response preview: ' + ai.substring(0, 500));\n\n  const parsed = parseATSRResponse_(ai);\n  if (!parsed) {\n    Logger.log('‚ùå Failed to parse AI response');\n    ui.alert('‚ö†Ô∏è ATSR parse error:\\n'+ai.substring(0, 1000));\n    return;\n  }\n\n  Logger.log('‚úÖ Parsed keys: ' + Object.keys(parsed).join(', '));\n\n// ===== ATSR ULTIMATE UI BUILDER =====\nfunction buildATSRUltimateUI_(row, parsed, keepSelections, data) {\n  // Helper: Create editable radio options with text input + show current value first\n  const makeEditable = (vals, name, label, currentValue, showMysteryButton = false) => `\n    <div class=\"section\">\n      <div class=\"section-header\">\n        <h3>${label}</h3>\n        ${showMysteryButton ? `\n        <button class=\"btn-mystery\" onclick=\"regenerateMoreMysterious()\" title=\"Generate even more mysterious titles that hide the diagnosis\">\n          üé≠ Make More Mysterious\n        </button>\n        ` : ''}\n      </div>\n      <div class=\"options\">\n        ${currentValue ? `\n        <div class=\"option-row\">\n          <input type=\"radio\" name=\"${name}\" value=\"current\" id=\"${name}_current\" checked>\n          <input type=\"text\" id=\"${name}_text_current\" value=\"${String(currentValue).replace(/\"/g,'&quot;')}\" class=\"edit-field\">\n        </div>\n        <div class=\"current-label\">\n          <em>No change, keep current version</em>\n        </div>\n        ` : ''}\n        ${vals.map((v,i)=>`\n          <div class=\"option-row\">\n            <input type=\"radio\" name=\"${name}\" value=\"${i}\" id=\"${name}_${i}\">\n            <input type=\"text\" id=\"${name}_text_${i}\" value=\"${String(v).replace(/\"/g,'&quot;')}\" class=\"edit-field\">\n          </div>\n        `).join('')}\n      </div>\n    </div>\n  `;\n\n  const ps = parsed.Case_Summary?.Patient_Summary || 'A patient was evaluated and managed for an acute condition requiring urgent care.';\n  const ki = parsed.Case_Summary?.Key_Intervention || 'N/A';\n  const ct = parsed.Case_Summary?.Core_Takeaway || 'N/A';\n\n  // Extract diagnosis from Reveal_Title (before the colon)\n  let diagnosis = 'Diagnosis Unknown';\n  const revealTitle = data['Case_Organization_Reveal_Title'];\n  if (revealTitle) {\n    // Format: \"Severe Asthma Exacerbation (8 M): Swift Action Required\"\n    // Extract: \"Severe Asthma Exacerbation\"\n    const match = revealTitle.match(/^([^(]+)/);\n    if (match) {\n      diagnosis = match[1].trim();\n    }\n  }\n\n  // Create specific learning outcome from diagnosis and key intervention\n  const learningOutcome = ki !== 'N/A'\n    ? `Master ${ki.toLowerCase()} as critical decision for ${diagnosis.toLowerCase()}`\n    : `Master rapid recognition and treatment of ${diagnosis.toLowerCase()}`;\n\n  return `\n  <!DOCTYPE html>\n  <html>\n  <head>\n    <!-- Cache bust: v7_demographic_format_${Date.now()} -->\n    <style>\n      * { box-sizing: border-box; }\n      body {\n        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;\n        margin: 0;\n        background: #f5f7fa;\n        color: #2c3e50;\n        font-size: 14px;\n      }\n      .container {\n        padding: 6px 16px 10px 16px;\n        max-width: 1900px;\n        margin: 0 auto;\n      }\n      .summary-card {\n        background: #ffffff;\n        border: 1px solid #cbd5e0;\n        border-radius: 6px;\n        padding: 8px 12px;\n        margin-bottom: 6px;\n        box-shadow: none;\n        max-width: 700px;\n      }\n      .summary-card h2 {\n        margin: 0 0 4px 0;\n        font-size: 15px;\n        color: #1a202c;\n        font-weight: 600;\n      }\n      .summary-text {\n        font-size: 13px;\n        line-height: 1.4;\n        color: #2d3748;\n        margin-bottom: 6px;\n      }\n      .summary-details {\n        display: grid;\n        grid-template-columns: 1fr 1fr;\n        gap: 8px;\n        padding: 6px 8px;\n        background: #f7fafc;\n        border-radius: 4px;\n        border-left: 3px solid #3b82f6;\n      }\n      .detail-item {\n        font-size: 11px;\n      }\n      .detail-item strong {\n        color: #1a202c;\n        display: block;\n        margin-bottom: 2px;\n      }\n      .grid-3 {\n        display: grid;\n        grid-template-columns: repeat(3, 1fr);\n        gap: 8px;\n        margin-bottom: 8px;\n        align-items: start;\n      }\n      .section {\n        background: #ffffff;\n        border: 1px solid #e2e8f0;\n        border-radius: 4px;\n        padding: 6px;\n        height: 100%;\n      }\n      .section-header {\n        display: flex;\n        justify-content: space-between;\n        align-items: center;\n        margin-bottom: 4px;\n        padding-bottom: 3px;\n        border-bottom: 1px solid #e2e8f0;\n      }\n      .section h3 {\n        margin: 0;\n        font-size: 13px;\n        font-weight: 600;\n        color: #1a202c;\n      }\n      .btn-mystery {\n        padding: 4px 8px;\n        font-size: 10px;\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        color: white;\n        border: none;\n        border-radius: 4px;\n        cursor: pointer;\n        font-weight: 600;\n        transition: all 0.2s;\n        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);\n      }\n      .btn-mystery:hover {\n        transform: translateY(-1px);\n        box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);\n        background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);\n      }\n      .btn-mystery:active {\n        transform: translateY(0);\n      }\n      .options {\n        display: flex;\n        flex-direction: column;\n        gap: 2px;\n      }\n      .option-row {\n        display: flex;\n        align-items: center;\n        gap: 4px;\n        padding: 1px 2px;\n        border-radius: 2px;\n        transition: background 0.2s;\n      }\n      .option-row:hover {\n        background: #f7fafc;\n      }\n      .option-row.no-change {\n        margin-top: 2px;\n        padding-top: 3px;\n        border-top: 1px solid #e2e8f0;\n      }\n      .option-row input[type=\"radio\"] {\n        flex-shrink: 0;\n        width: 14px;\n        height: 14px;\n        cursor: pointer;\n      }\n      .edit-field {\n        flex: 1;\n        padding: 4px 6px;\n        border: 1px solid #e2e8f0;\n        border-radius: 3px;\n        font-size: 13px;\n        background: #ffffff;\n        color: #2c3e50;\n        transition: border-color 0.2s;\n        word-wrap: break-word;\n        white-space: normal;\n        overflow-wrap: break-word;\n        min-height: 24px;\n        line-height: 1.3;\n      }\n      .edit-field:focus {\n        outline: none;\n        border-color: #3b82f6;\n      }\n      .current-label {\n        padding: 2px 0 4px 18px;\n        font-size: 11px;\n        color: #64748b;\n        font-style: italic;\n      }\n      .actions {\n        background: #ffffff;\n        border: 1px solid #cbd5e0;\n        border-radius: 8px;\n        padding: 20px;\n        display: flex;\n        gap: 12px;\n        justify-content: center;\n        box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n      }\n      button {\n        padding: 12px 24px;\n        border: none;\n        border-radius: 6px;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n      .btn-primary {\n        background: #3b82f6;\n        color: white;\n      }\n      .btn-primary:hover {\n        background: #2563eb;\n        transform: translateY(-1px);\n        box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n      }\n      .btn-secondary {\n        background: #10b981;\n        color: white;\n      }\n      .btn-secondary:hover {\n        background: #059669;\n        transform: translateY(-1px);\n        box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n      }\n      .btn-tertiary {\n        background: #6366f1;\n        color: white;\n      }\n      .btn-tertiary:hover {\n        background: #4f46e5;\n        transform: translateY(-1px);\n        box-shadow: 0 4px 6px rgba(0,0,0,0.1);\n      }\n      .btn-close {\n        background: #e2e8f0;\n        color: #475569;\n      }\n      .btn-close:hover {\n        background: #cbd5e0;\n      }\n    </style>\n  </head>\n  <body>\n    <div class=\"container\">\n      <div class=\"summary-card\">\n        <div style=\"margin-bottom: 4px; font-size: 13px; color: #64748b; font-weight: 500;\">Case Summary:</div>\n        <div style=\"font-size: 26px; font-weight: 700; color: #1a202c; margin-bottom: 16px; line-height: 1.2;\">${diagnosis}</div>\n        <ul style=\"list-style-type: disc; margin: 0; padding-left: 20px; line-height: 1.7;\">\n          <li style=\"margin-bottom: 10px; color: #2d3748; font-size: 14px;\">${ps}</li>\n          <li style=\"color: #2d3748; font-size: 14px; font-weight: 600;\"><strong>Learning Objective:</strong> ${learningOutcome}</li>\n        </ul>\n      </div>\n\n      <div class=\"grid-3\">\n        ${makeEditable(parsed.Spark_Titles||[], 'spark', 'üî• Spark Titles (Pre-Sim Mystery)', data['Case_Organization_Spark_Title'], true)}\n        ${makeEditable(parsed.Reveal_Titles||[], 'reveal', 'üíé Reveal Titles (Post-Sim Learning)', data['Case_Organization_Reveal_Title'])}\n        ${makeEditable(parsed.Memory_Anchors||[], 'anchor', 'üé≠ Memory Anchors (Unforgettable Patient Details)', data['Case_Organization_Memory_Anchor'])}\n      </div>\n\n      <div class=\"actions\">\n        <button class=\"btn-primary\" onclick=\"apply(false)\">‚úÖ Save & Close</button>\n        <button class=\"btn-secondary\" onclick=\"apply(true)\">‚è≠Ô∏è Save & Continue</button>\n        <button class=\"btn-tertiary\" onclick=\"keepRegen()\">üîÅ Keep & Regenerate</button>\n        <button class=\"btn-close\" onclick=\"google.script.host.close()\">‚ùå Close</button>\n      </div>\n    </div>\n\n    <script>\n      function getTxt(name) {\n        const selected = document.querySelector('input[name=\"'+name+'\"]:checked');\n        if (!selected || selected.value === 'nochange') return 'nochange';\n        const idx = selected.value;\n        const textField = document.getElementById(name+'_text_'+idx);\n        return textField ? textField.value : 'nochange';\n      }\n\n      function apply(continueNext) {\n        const data = {\n          spark: getTxt('spark'),\n          reveal: getTxt('reveal'),\n          anchor: getTxt('anchor'),\n          continueNext: continueNext\n        };\n        google.script.run\n          .withSuccessHandler(()=>{\n            if(continueNext) {\n              google.script.run.runATSRTitleGenerator(${row+1}, true);\n            } else {\n              google.script.host.close();\n            }\n          })\n          .saveATSRData(${row}, data);\n      }\n\n      function keepRegen() {\n        google.script.host.close();\n        google.script.run.runATSRTitleGenerator(${row}, true);\n      }\n\n      let mysteryLevel = 1; // Track how mysterious we're getting\n\n      function regenerateMoreMysterious() {\n        // Show loading state\n        const btn = event.target;\n        const originalText = btn.innerHTML;\n        btn.disabled = true;\n        btn.innerHTML = 'üîÑ Level ' + mysteryLevel + '...';\n\n        // Collect current titles from the text inputs\n        const sparkContainer = document.querySelector('[name=\"spark\"]').closest('.section').querySelector('.options');\n        const textInputs = sparkContainer.querySelectorAll('.edit-field');\n        const currentTitles = Array.from(textInputs).map(input => input.value);\n\n        google.script.run\n          .withSuccessHandler((newTitles) => {\n            // Replace the Spark Titles options with new ultra-mysterious ones\n            const sparkContainer = document.querySelector('[name=\"spark\"]').closest('.section').querySelector('.options');\n\n            // Keep the current value option if it exists\n            const currentOption = sparkContainer.querySelector('.option-row:first-child');\n            const hasCurrentValue = currentOption && currentOption.querySelector('[id$=\"_current\"]');\n\n            // Build new options HTML\n            let newHTML = '';\n            if (hasCurrentValue) {\n              newHTML += currentOption.outerHTML;\n              newHTML += sparkContainer.querySelector('.current-label').outerHTML;\n            }\n\n            // Add new mysterious titles\n            newTitles.forEach((title, i) => {\n              newHTML += '<div class=\"option-row\">' +\n                '<input type=\"radio\" name=\"spark\" value=\"' + i + '\" id=\"spark_' + i + '\">' +\n                '<input type=\"text\" id=\"spark_text_' + i + '\" value=\"' + title.replace(/\"/g,'&quot;') + '\" class=\"edit-field\">' +\n                '</div>';\n            });\n\n            sparkContainer.innerHTML = newHTML;\n\n            // Increment mystery level for next click\n            mysteryLevel++;\n\n            // Update button text to show we're going deeper\n            const levelEmojis = ['üé≠', 'üïµÔ∏è', '‚ùì', 'üå´Ô∏è', 'üëª'];\n            const emoji = levelEmojis[Math.min(mysteryLevel - 1, levelEmojis.length - 1)];\n            btn.innerHTML = emoji + ' Even More Mysterious';\n            btn.disabled = false;\n          })\n          .withFailureHandler((error) => {\n            alert('Error generating mysterious titles: ' + error);\n            btn.disabled = false;\n            btn.innerHTML = originalText;\n          })\n          .generateMysteriousSparkTitles(${row}, mysteryLevel, currentTitles);\n      }\n    </script>\n  </body>\n  </html>\n  `;\n}\n\n\n  const html = buildATSRUltimateUI_(row, parsed, keepSelections, data);\n  ui.showModalDialog(HtmlService.createHtmlOutput(html).setWidth(1920).setHeight(1000), 'üé® ATSR Titles Optimizer (v2 - TEST)');\n}\n\n\n\n// ATSR-specific JSON parser that handles markdown code fences\nfunction parseATSRResponse_(text) {\n  if (!text) return null;\n\n  // Strip markdown code fences if present\n  let cleaned = text.trim();\n  if (cleaned.startsWith('```')) {\n    cleaned = cleaned.replace(/^```(?:json)?\\s*\\n?/i, '').replace(/\\n?```\\s*$/,'');\n  }\n\n  try { return JSON.parse(cleaned); } catch(e) {\n    const m = cleaned.match(/\\{[\\s\\S]*\\}/);\n    if (m) { try { return JSON.parse(m[0]); } catch(_) {} }\n    return null;\n  }\n}\n\n\n\n\n\n\nfunction generateMysteriousSparkTitles(row, mysteryLevel, currentTitles) {\n  const s = pickMasterSheet_();\n  const headers = s.getRange(2,1,1,s.getLastColumn()).getValues()[0];\n  const rowData = s.getRange(row, 1, 1, headers.length).getValues()[0];\n\n  // Build data object\n  const data = {};\n  headers.forEach((h,i) => { data[h] = rowData[i]; });\n\n  // Extract the diagnosis from Reveal Title\n  const revealTitle = data['Case_Organization_Reveal_Title'] || '';\n  const diagnosisMatch = revealTitle.match(/^([^(]+)/);\n  const diagnosis = diagnosisMatch ? diagnosisMatch[1].trim() : 'Unknown';\n\n  // Extract age/gender from current Spark Title (e.g., \"Title (58 M): Description\")\n  const currentSparkTitle = data['Case_Organization_Spark_Title'] || '';\n  const demographicMatch = currentSparkTitle.match(/\\((\\d+\\s+[MF])\\)/);\n  const demographic = demographicMatch ? demographicMatch[1] : null;\n\n  // Get patient summary\n  const patientSummary = data['Case_Summary_Patient_Summary'] || 'A patient presents with concerning symptoms.';\n\n  // Adjust mystery level instructions\n  const level = mysteryLevel || 1;\n  let mysteryInstructions = '';\n\n  if (level === 1) {\n    mysteryInstructions = '**MYSTERY LEVEL 1 (Moderate Mystery):**\\n' +\n      '- Use vague family observations\\n' +\n      '- Avoid medical terms but can hint at general concern\\n' +\n      '- Example: \"Grandpa\\'s Not Acting Right\"\\n\\n';\n  } else if (level === 2) {\n    mysteryInstructions = '**MYSTERY LEVEL 2 (High Mystery):**\\n' +\n      '- Even more vague and indirect\\n' +\n      '- Focus on pure behavioral changes\\n' +\n      '- Example: \"Something\\'s Different Today\"\\n\\n';\n  } else if (level === 3) {\n    mysteryInstructions = '**MYSTERY LEVEL 3 (Maximum Mystery):**\\n' +\n      '- Extremely vague, almost cryptic\\n' +\n      '- Pure emotion and concern only\\n' +\n      '- Example: \"I\\'m Worried\"\\n\\n';\n  } else {\n    mysteryInstructions = '**MYSTERY LEVEL ' + level + ' (ULTRA Maximum):**\\n' +\n      '- Absolutely NO specifics whatsoever\\n' +\n      '- Pure gut feeling and unease\\n' +\n      '- Example: \"Something\\'s Not Right\"\\n\\n';\n  }\n\n  // Build the prompt based on whether we have current titles to iterate on\n  let prompt = '';\n\n  if (currentTitles && currentTitles.length > 0) {\n    // ITERATIVE MODE: Make existing titles MORE mysterious\n    const formatInstruction = demographic\n      ? '**FORMAT REQUIREMENT:**\\nEach title MUST follow this exact format:\\n\"Title (' + demographic + '): Brief description\"\\n\\nExample: \"Grandpa\\'s Not Acting Right (' + demographic + '): Family Concerned\"\\n\\n'\n      : '';\n\n    prompt = 'You are making existing pre-simulation titles EVEN MORE MYSTERIOUS to completely hide the diagnosis.\\n\\n' +\n      mysteryInstructions +\n      '**YOUR TASK:**\\n' +\n      'Take each of these titles and make them MORE vague, MORE mysterious, and LESS revealing.\\n' +\n      'Remove any remaining hints about the condition. Make them more cryptic and indirect.\\n' +\n      'Keep the human context and emotional tone, but be even more subtle.\\n\\n' +\n      '**Current Titles to Make More Mysterious:**\\n' +\n      JSON.stringify(currentTitles, null, 2) + '\\n\\n' +\n      formatInstruction +\n      '**Patient Context (to maintain relevance):**\\n' +\n      patientSummary + '\\n\\n' +\n      '**Actual Diagnosis (HIDE THIS COMPLETELY):**\\n' +\n      diagnosis + '\\n\\n' +\n      '**CRITICAL RULES:**\\n' +\n      '- NEVER mention the diagnosis (' + diagnosis + ')\\n' +\n      '- NEVER use medical terminology\\n' +\n      '- Remove any remaining clinical hints\\n' +\n      '- Make each title LESS specific than before\\n' +\n      '- Use even vaguer language\\n' +\n      '- Focus on pure emotion and concern\\n' +\n      '- Keep titles grounded in the patient context (age, setting, etc.)\\n' +\n      '- Maintain human perspective (family member, concerned observer)\\n' +\n      (demographic ? '- ALWAYS include (' + demographic + ') in each title\\n' : '') +\n      '\\n' +\n      'Return ONLY a JSON array of the same number of titles, now more mysterious:\\n' +\n      '[\"More mysterious version of title 1\", \"More mysterious version of title 2\", ...]';\n  } else {\n    // INITIAL MODE: Generate from scratch\n    const formatInstruction = demographic\n      ? '**FORMAT REQUIREMENT:**\\nEach title MUST follow this exact format:\\n\"Title (' + demographic + '): Brief description\"\\n\\nExample: \"Grandpa\\'s Not Acting Right (' + demographic + '): Family Concerned\"\\n\\n'\n      : '';\n\n    const exampleSuffix = demographic ? ' (' + demographic + ')' : '';\n\n    prompt = 'You are creating ULTRA-MYSTERIOUS pre-simulation titles that COMPLETELY HIDE the diagnosis from learners.\\n\\n' +\n      mysteryInstructions +\n      formatInstruction +\n      '**CRITICAL RULES:**\\n' +\n      '- NEVER mention the diagnosis (' + diagnosis + ')\\n' +\n      '- NEVER use medical terminology that reveals the condition\\n' +\n      '- NEVER hint at the organ system or pathophysiology\\n' +\n      '- Focus on vague, concerning observations\\n' +\n      '- Use layperson language and indirect descriptions\\n' +\n      '- Create curiosity and mystery without clinical clues\\n' +\n      (demographic ? '- ALWAYS include (' + demographic + ') in each title\\n' : '') +\n      '\\n' +\n      '**Patient Context:**\\n' +\n      patientSummary + '\\n\\n' +\n      '**Actual Diagnosis (HIDE THIS COMPLETELY):**\\n' +\n      diagnosis + '\\n\\n' +\n      '**Examples of Ultra-Mysterious Titles:**\\n' +\n      '- \"Grandpa\\'s Not Acting Right' + exampleSuffix + ': Family Concerned\"\\n' +\n      '- \"She Just Doesn\\'t Look Right' + exampleSuffix + ': Something\\'s Wrong\"\\n' +\n      '- \"Something\\'s Off with Dad Today' + exampleSuffix + ': Can\\'t Put My Finger on It\"\\n' +\n      '- \"The Kid Who Won\\'t Stop Crying' + exampleSuffix + ': Parents Worried\"\\n' +\n      '- \"Mom Says He\\'s Not Himself' + exampleSuffix + ': Acting Strange\"\\n\\n' +\n      '**Generate 5 ultra-mysterious Spark Titles that:**\\n' +\n      '1. Use concerned family member observations\\n' +\n      '2. Describe behavioral/emotional changes only\\n' +\n      '3. Avoid ANY medical symptoms or terms\\n' +\n      '4. Create urgency through human context\\n' +\n      '5. Make learners think \"I need to assess this\"\\n' +\n      (demographic ? '6. Include (' + demographic + ') in EVERY title\\n' : '') +\n      '\\n' +\n      'Return ONLY a JSON array of 5 title strings, no explanation:\\n' +\n      '[\"Title 1\", \"Title 2\", \"Title 3\", \"Title 4\", \"Title 5\"]';\n  }\n\n  Logger.log('üé≠ Generating ultra-mysterious Spark Titles (Level ' + level + ')');\n  Logger.log('   For diagnosis: ' + diagnosis);\n  if (currentTitles && currentTitles.length > 0) {\n    Logger.log('   Iterating on ' + currentTitles.length + ' existing titles');\n  } else {\n    Logger.log('   Generating fresh titles from scratch');\n  }\n\n  const response = callOpenAI(prompt, 0.9); // High temperature for creativity\n  Logger.log('üìù OpenAI response: ' + response);\n\n  // Parse the JSON array\n  const cleanResponse = response.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  const titles = JSON.parse(cleanResponse);\n\n  Logger.log('‚úÖ Generated ' + titles.length + ' mysterious titles');\n  return titles;\n}\n\n// New save function that handles data from the UI\nfunction saveATSRData(row, data) {\n  const s = pickMasterSheet_();\n  const headers = s.getRange(2,1,1,s.getLastColumn()).getValues()[0];\n\n  const setVal = (key, val) => {\n    if (!val || val==='nochange') return;\n    const idx = headers.indexOf(key);\n    if (idx<0) {\n      Logger.log('‚ö†Ô∏è Column not found: ' + key);\n      return;\n    }\n    const r = s.getRange(row, idx+1);\n    r.setValue(val);\n  };\n\n  Logger.log('üíæ Saving ATSR data for row ' + row);\n  Logger.log('   Spark: ' + data.spark);\n  Logger.log('   Reveal: ' + data.reveal);\n  Logger.log('   Anchor: ' + data.anchor);\n\n  setVal('Case_Organization_Spark_Title', data.spark);\n  setVal('Case_Organization_Reveal_Title', data.reveal);\n  setVal('Case_Organization_Memory_Anchor', data.anchor);\n\n  SpreadsheetApp.getActive().toast('‚úÖ ATSR saved successfully!');\n}\n\n// Legacy function kept for compatibility\nfunction applyATSRSelectionsWithDefiningAndMemory(row, spark, reveal, caseID, define) {\n  const s = pickMasterSheet_();\n  const headers = s.getRange(2,1,1,s.getLastColumn()).getValues()[0];\n\n  const setVal = (key, val, append=false) => {\n    if (!val || val==='nochange') return;\n    const idx = headers.indexOf(key);\n    if (idx<0) return;\n    const r = s.getRange(row, idx+1);\n    if (append) {\n      const ex = r.getValue();\n      r.setValue(ex ? (ex + ' ' + val) : val);\n    } else r.setValue(val);\n  };\n\n  setVal('Spark_Title',   spark);\n  setVal('Reveal_Title',  reveal);\n  setVal('Patient_Descriptor', define, true);\n\n  if (define && define!=='nochange') {\n    const memKey = SP_KEYS.USED_MOTIFS;\n    const prev = getProp(memKey,'');\n    const motif = define.toLowerCase().split(' ').slice(0,3).join(' ');\n    if (!prev.includes(motif)) setProp(memKey, prev ? (prev+', '+motif) : motif);\n  }\n\n  SpreadsheetApp.getActive().toast('‚úÖ ATSR saved.');\n}\n\n\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n// END OF ATSR IMPLEMENTATION\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\nfunction pickMasterSheet_() {\n  const ss = SpreadsheetApp.getActive();\n  // Prefer last used output\n  const last = getProp(SP_KEYS.LAST_OUTPUT_SHEET, '');\n  if (last) {\n    const s = ss.getSheetByName(last);\n    if (s) return s;\n  }\n  // Else prefer sheet named like Master Scenario CSV\n  const m = ss.getSheets().find(sh=>/master scenario csv/i.test(sh.getName()));\n  return m || ss.getActiveSheet();\n}\n\n// Auto-bold key phrases in summary lines\nfunction autoBoldSummary_(summary, key, take) {\n  function boldPhrase(s) {\n    if (!s) return 'N/A';\n    // Bold up to the colon if present; else first 2‚Äì3 words\n    const parts = s.split(':');\n    if (parts.length>1) return `<strong>${parts[0]}</strong>:` + parts.slice(1).join(':');\n    const words = s.split(' ');\n    const head = words.slice(0,3).join(' ');\n    return `<strong>${head}</strong> ${words.slice(3).join(' ')}`.trim();\n  }\n  return { summary, key: boldPhrase(key), take: boldPhrase(take) };\n}\n\n\n// ========== 7) IMAGE SYNC DEFAULTS MANAGER ==========\n\nfunction openImageSyncDefaults() {\n  const s = pickMasterSheet_();\n  const {header1, header2} = getCachedHeadersOrRead(s);\n  const keys = header1.map((t1,i)=>`${t1}:${header2[i]}`).filter(k=>/^Image_Sync:/i.test(k));\n\n  const current = JSON.parse(getProp(SP_KEYS.IMG_SYNC_DEFAULTS, '{}') || '{}');\n  const rows = keys.map(k=>{\n    const v = (current[k]!==undefined) ? current[k] : '';\n    return `<tr><td>${k}</td><td><input data-k=\"${k}\" value=\"${String(v).replace(/\"/g,'&quot;')}\" style=\"width:100%\"></td></tr>`;\n  }).join('');\n\n  const html = HtmlService.createHtmlOutput(`\n  <style>\n    body{font-family:Arial;background:#f5f7fa;color:#2c3e50}\n    table{width:100%;border-collapse:collapse}\n    td,th{border:1px solid #dfe3e8;padding:8px}\n    .bar{padding:14px 16px;background:#1b1f2a;border-bottom:1px solid #dfe3e8}\n    button{background:#2357ff;border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}\n  </style>\n  <div class=\"bar\"><h3>${ICONS.frame} Image Sync Defaults</h3></div>\n  <div style=\"padding:12px;\">\n    <p class=\"hint\">Edit defaults per <code>Image_Sync:*</code> column. Click Save to persist.</p>\n    <table>\n      <tr><th>Column</th><th>Default Value</th></tr>\n      ${rows || '<tr><td colspan=\"2\"><em>No Image_Sync columns detected.</em></td></tr>'}\n    </table>\n    <div style=\"margin-top:12px;\">\n      <button onclick=\"save()\">Save</button>\n      <button style=\"background:#dfe3e8\" onclick=\"refresh()\">Refresh Columns</button>\n    </div>\n  </div>\n  <script>\n    function save(){\n      const obj = {};\n      document.querySelectorAll('input[data-k]').forEach(inp=>{\n        obj[inp.getAttribute('data-k')] = inp.value;\n      });\n      google.script.run\n        .withSuccessHandler(()=>google.script.host.close())\n        .saveImageSyncDefaults(JSON.stringify(obj));\n    }\n    function refresh(){\n      google.script.run\n        .withSuccessHandler(()=>location.reload())\n        .refreshImageSyncHeaderCache();\n    }\n  </script>\n  `).setWidth(720).setHeight(560);\n\n  getSafeUi_().showModalDialog(html, 'üñº Image Sync Defaults');\n}\nfunction saveImageSyncDefaults(json) {\n  setProp(SP_KEYS.IMG_SYNC_DEFAULTS, json||'{}');\n  SpreadsheetApp.getActive().toast('‚úÖ Image Sync defaults saved.');\n}\nfunction refreshImageSyncHeaderCache() {\n  const s = pickMasterSheet_();\n  cacheHeaders(s);\n  SpreadsheetApp.getActive().toast('üîÅ Header cache refreshed.');\n}\n\n\n// ========== 8) MEMORY TRACKER ==========\n\nfunction openMemoryTracker() {\n  const mem = (getProp(SP_KEYS.USED_MOTIFS,'')||'').split(',').map(m=>m.trim()).filter(Boolean);\n  const list = mem.map((m,i)=>`<div><input type=\"checkbox\" id=\"m${i}\" checked> ${m}</div>`).join('');\n  const html = HtmlService.createHtmlOutput(`\n  <style>body{font-family:Arial;background:#f5f7fa;color:#2c3e50} button{background:#2357ff;border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}</style>\n  <div style=\"padding:16px;\">\n    <h3>${ICONS.puzzle} Memory Tracker</h3>\n    ${list || '<p><em>No motifs stored.</em></p>'}\n    <div style=\"margin-top:12px;\">\n      <button onclick=\"clearAll()\">üßπ Clear All</button>\n      <button style=\"background:#dfe3e8\" onclick=\"markReusable()\">‚ôªÔ∏è Mark Selected as Reusable</button>\n    </div>\n  </div>\n  <script>\n    function clearAll(){ google.script.run.withSuccessHandler(()=>google.script.host.close()).clearMotifMemory(); }\n    function markReusable(){\n      const unchecked=[];\n      document.querySelectorAll('input[type=checkbox]').forEach(c=>{ if(!c.checked) unchecked.push(c.nextSibling.textContent.trim()); });\n      google.script.run.withSuccessHandler(()=>google.script.host.close()).markMotifsReusable(unchecked);\n    }\n  </script>`).setWidth(520).setHeight(420);\n  getSafeUi_().showModalDialog(html, 'üß© Memory Tracker');\n}\nfunction clearMotifMemory(){ PropertiesService.getDocumentProperties().deleteProperty(SP_KEYS.USED_MOTIFS); SpreadsheetApp.getActive().toast('üßπ Memory cleared.'); }\nfunction markMotifsReusable(unchecked){ \n  const key = SP_KEYS.USED_MOTIFS;\n  const motifs = (getProp(key,'')||'').split(',').map(m=>m.trim()).filter(Boolean);\n  const kept = motifs.filter(m => unchecked.includes(m)===false);\n  setProp(key, kept.join(', '));\n  SpreadsheetApp.getActive().toast('‚ôªÔ∏è Selected motifs marked reusable.');\n}\n\n// ======================================================\n// HEADER MANAGEMENT + AUTO-RETRAIN MODULE (Sim Mastery)\n// ======================================================\n\n\n// ========== 1) REFRESH HEADERS (TRAIN STRUCTURE) ==========\nfunction refreshHeaders() {\n  const ui = getSafeUi_();\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const outputSheet = pickMasterSheet_();\n  if (!outputSheet) {\n    if (ui) { ui.alert('‚ùå Master sheet not found.'); }\n    return;\n  }\n\n  // Read Row 2 which contains the FULL flattened headers\n  // Row 1: Short names (Case_ID, Spark_Title)\n  // Row 2: Full flattened (Case_Organization_Case_ID, Case_Organization_Spark_Title)\n  const flattenedHeaders = outputSheet.getRange(2, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n\n  // Clean and filter headers\n  const mergedKeys = flattenedHeaders\n    .map(h => String(h || '').trim())\n    .filter(h => h !== '');\n\n  // Remove duplicates from mergedKeys\n  const uniqueKeys = [];\n  const seen = {};\n  for (let i = 0; i < mergedKeys.length; i++) {\n    if (!seen[mergedKeys[i]]) {\n      uniqueKeys.push(mergedKeys[i]);\n      seen[mergedKeys[i]] = true;\n    }\n  }\n  if (uniqueKeys.length < mergedKeys.length) {\n    Logger.log('‚ö†Ô∏è Removed ' + (mergedKeys.length - uniqueKeys.length) + ' duplicate headers');\n  }\n  const finalKeys = uniqueKeys;\n\n\n  // Cache the flattened headers\n  setProp('CACHED_MERGED_KEYS', JSON.stringify(finalKeys));\n\n  // For backward compatibility, also cache as header1/header2\n  // Parse tier1 and tier2 from flattened names\n  const header1 = [];\n  const header2 = [];\n\n  mergedKeys.forEach(merged => {\n    const parts = merged.split('_');\n    if (parts.length >= 3) {\n      header1.push(parts.slice(0, -1).join('_'));\n      header2.push(parts[parts.length - 1]);\n    } else if (parts.length === 2) {\n      header1.push(parts[0]);\n      header2.push(parts[1]);\n    } else {\n      header1.push('General');\n      header2.push(merged);\n    }\n  });\n\n  setProp('CACHED_HEADER1', JSON.stringify(header1));\n  setProp('CACHED_HEADER2', JSON.stringify(header2));\n\n  // Silent mode - no alert (will be shown by field selector if needed)\n  Logger.log('‚úÖ Headers refreshed: ' + mergedKeys.length + ' merged keys cached');\n}\n\n// ========== 2) AUTO-RETRAIN PROMPT STRUCTURE ==========\nfunction retrainPromptStructure() {\n  const ui = getSafeUi_();\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  // Use pickMasterSheet_() instead of hardcoded fallback\n  const outputSheet = pickMasterSheet_();\n  if (!outputSheet) {\n    if (ui) { ui.alert('‚ùå Master sheet not found.'); }\n    return;\n  }\n\n  const header1 = outputSheet.getRange(1, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n  const header2 = outputSheet.getRange(2, 1, 1, outputSheet.getLastColumn()).getValues()[0];\n  const mergedKeys = header1.map((t1, i) => `${t1}:${header2[i]}`.replace(/\\s+/g, '_'));\n\n  // Cache structure\n  setProp('CACHED_HEADER1', JSON.stringify(header1));\n  setProp('CACHED_HEADER2', JSON.stringify(header2));\n  setProp('CACHED_MERGED_KEYS', JSON.stringify(mergedKeys));\n\n  // Build prompt training text\n  const promptIntro = `\nüìò Sim Mastery ‚Äî Auto-Trained Output Schema\nThis defines your authoritative JSON schema for all generated content.\n\nEach key must exactly match the merged Tier1:Tier2 form, using underscores (_) instead of spaces.\nWhen a value cannot be filled, output \"N/A\".\n\nTier1 Headers:\n${header1.join(', ')}\n\nTier2 Headers:\n${header2.join(', ')}\n\nMerged Keys (exact JSON keys required):\n${mergedKeys.join(', ')}\n`.trim();\n\n  setProp('CACHED_PROMPT_STRUCTURE', promptIntro);\n\n  if (ui) { ui.alert(`‚úÖ Prompt structure retrained!\\n\\n${mergedKeys.length} merged keys cached.\\nPrompt fragment stored for AI calls.`); }\n}\n\n// ========== 3) OPTIONAL: AUTO-CHECK BEFORE RUN ==========\nfunction ensureHeadersCached() {\n  const h = getProp('CACHED_HEADER1');\n  if (!h) {\n    refreshHeaders();\n    retrainPromptStructure();\n  }\n}\n\n\n\n\n\n\n\n// ========== 9) SETTINGS PANEL (Properties + Cache) ==========\n\nfunction openSettingsPanel() {\n  const api = getProp(SP_KEYS.API_KEY,'');\n  const model = getProp(SP_KEYS.MODEL, DEFAULT_MODEL);\n  const pIn = getProp(SP_KEYS.PRICE_INPUT, DEFAULT_PRICE.input);\n  const pOut= getProp(SP_KEYS.PRICE_OUTPUT, DEFAULT_PRICE.output);\n  const html = HtmlService.createHtmlOutput(`\n  <style>body{font-family:Arial;background:#f5f7fa;color:#2c3e50}\n  label{font-size:12px;color:#9aa3b2}\n  input,select{width:100%;background:#f5f7fa;border:1px solid #30384b;color:#2c3e50;border-radius:8px;padding:8px}\n  button{background:#2357ff;border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}\n  .card{background:#ffffff;border:1px solid #dfe3e8;border-radius:10px;padding:14px;margin:12px}\n  </style>\n  <div class=\"card\">\n    <h3>${ICONS.gear} Settings</h3>\n    <label>Model</label>\n    <input id=\"m\" value=\"${model}\">\n    <label style=\"margin-top:8px;\">API Key</label>\n    <input id=\"k\" value=\"${api ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : ''}\" placeholder=\"sk-...\">\n    <label style=\"margin-top:8px;\">Price Input per 1k</label>\n    <input id=\"pi\" value=\"${pIn}\">\n    <label style=\"margin-top:8px;\">Price Output per 1k</label>\n    <input id=\"po\" value=\"${pOut}\">\n    <div style=\"margin-top:10px;\">\n      <button onclick=\"save()\">Save</button>\n      <button style=\"background:#dfe3e8\" onclick=\"clearCache()\">Clear Header Cache</button>\n      <button style=\"background:#dfe3e8\" onclick=\"pull()\">Sync API from Settings sheet</button>\n    </div>\n  </div>\n  <script>\n    function save(){\n      const key = document.getElementById('k').value.trim();\n      google.script.run.saveSidebarBasics(\n        document.getElementById('m').value,\n        (key && key!=='‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') ? key : '',\n        document.getElementById('pi').value.trim(),\n        document.getElementById('po').value.trim(),\n        '', ''\n      );\n      google.script.host.close();\n    }\n    function clearCache(){ google.script.run.withSuccessHandler(()=>alert('Cache cleared')).clearHeaderCache(); }\n    function pull(){ google.script.run.withSuccessHandler(()=>alert('API key synced from Settings sheet (if found).')).pullApiFromSettingsSheet(); }\n  </script>`).setWidth(520).setHeight(420);\n  getSafeUi_().showModalDialog(html, '‚öôÔ∏è Settings');\n}\n\nfunction pullApiFromSettingsSheet() {\n  const key = syncApiKeyFromSettingsSheet_();\n  if (key) setProp(SP_KEYS.API_KEY, key);\n}\n\n\n// ========== 10) MENU ==========\n\n\n\n/**\n * Categories & Pathways Panel - Light Theme (Classic Google Sheets Style)\n *\n * Clean, easy-to-read interface for managing categories and pathways\n * Light grey theme optimized for data manipulation\n */\n\n// ========== MAIN LAUNCHER ==========\n\n// REPLACED BY Phase2_Enhanced_Categories_Pathways_Panel.gs\n/*\n\n\n*/\n\n// ========== VIEW FUNCTIONS ==========\n\nfunction getCategoryView(category) {\n  const sheet = pickMasterSheet_();\n  const data = sheet.getDataRange().getValues();\n  const headers = data[1];\n\n  const categoryIdx = headers.indexOf('Case_Organization:Category');\n  const sparkIdx = headers.indexOf('Case_Organization:Spark_Title');\n  const pathwayIdx = headers.indexOf('Case_Organization:Pathway_Name');\n\n  const cases = [];\n  for (let i = 2; i < data.length; i++) {\n    if (data[i][categoryIdx] === category) {\n      cases.push({\n        row: i + 1,\n        spark: data[i][sparkIdx] || 'Untitled',\n        pathway: data[i][pathwayIdx] || 'Unassigned'\n      });\n    }\n  }\n\n  const casesList = cases.map(c => `\n    <div class=\"list-item\">\n      <div>\n        <div style=\"font-weight:500;\">${c.spark}</div>\n        <div style=\"font-size:11px;color:#7f8c9d;margin-top:2px;\">Row ${c.row} ‚Ä¢ ${c.pathway}</div>\n      </div>\n    </div>\n  `).join('');\n\n  return `\n<!DOCTYPE html>\n<html>\n<head><base target=\"_top\">\n<style>\n  * { margin: 0; padding: 0; box-sizing: border-box; }\n  body { font-family: Arial, sans-serif; background: #f5f7fa; color: #2c3e50; font-size: 13px; }\n  .header { background: #fff; padding: 16px; border-bottom: 1px solid #dfe3e8; }\n  .header h1 { font-size: 16px; font-weight: 600; color: #2c3e50; margin-bottom: 4px; }\n  .header .subtitle { font-size: 12px; color: #7f8c9d; }\n  .section { background: #fff; margin: 12px; padding: 14px; border-radius: 6px; border: 1px solid #dfe3e8; }\n  .list-item { padding: 10px 12px; margin-bottom: 6px; background: #f8f9fa; border-radius: 4px; }\n  .btn { display: inline-block; background: #fff; border: 1px solid #d1d7de; color: #2c3e50; padding: 8px 14px; margin: 8px 4px; border-radius: 4px; cursor: pointer; font-size: 12px; text-decoration: none; }\n  .btn:hover { background: #f5f7fa; }\n  .scrollable { max-height: 400px; overflow-y: auto; }\n</style>\n</head>\n<body>\n  <div class=\"header\">\n    <h1>üìÇ ${category}</h1>\n    <div class=\"subtitle\">${cases.length} cases</div>\n  </div>\n  <div class=\"section\">\n    <div class=\"scrollable\">${casesList}</div>\n  </div>\n  <div style=\"padding:12px;\">\n    <button class=\"btn\" onclick=\"goBack()\">‚Üê Back to Menu</button>\n  </div>\n  <script>\n    function goBack() {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .buildCategoriesPathwaysMainMenu_();\n    }\n  </script>\n</body>\n</html>\n  `;\n}\n\nfunction getPathwayView(pathway) {\n  // Similar to category view\n  return getCategoryView(pathway); // Simplified for now\n}\n\nfunction getAllCategoriesView() {\n  // Grid of all categories\n  return buildCategoriesPathwaysMainMenu_();\n}\n\nfunction getAllPathwaysView() {\n  // Grid of all pathways\n  return buildCategoriesPathwaysMainMenu_();\n}\n\nfunction getCaseAssignmentView(row) {\n  // Assignment interface\n  return buildCategoriesPathwaysMainMenu_();\n}\n\n\n\n\nfunction saveATSRData(row, data) {\n  const ss = SpreadsheetApp.getActive();\n  const sheet = pickMasterSheet_();\n  if (!sheet) return;\n\n  const headers = sheet.getRange(2,1,1,sheet.getLastColumn()).getValues()[0];\n\n  const setCell = (colName, value) => {\n    const colIdx = headers.indexOf(colName);\n    if (colIdx === -1) return;\n    if (value !== 'nochange') {\n      sheet.getRange(row, colIdx + 1).setValue(value);\n    }\n  };\n\n  // Save selected values\n  setCell('Case_Organization:Spark_Title', data.spark);\n  setCell('Case_Organization:Reveal_Title', data.reveal);\n  setCell('Case_Organization:Memory_Anchor', data.anchor);\n\n  // Track used memory anchors for uniqueness\n  if (data.anchor !== 'nochange') {\n    const usedMemory = getProp(SP_KEYS.USED_MEMORY_ANCHORS, '');\n    const newUsed = usedMemory + ' | ' + data.anchor;\n    setProp(SP_KEYS.USED_MEMORY_ANCHORS, newUsed.substring(0, 5000)); // Keep last 5000 chars\n  }\n}\n\n\n\n\n\n// ‚≠ê Sidebar Log Helpers\nfunction appendLogSafe(message) {\n  try {\n    const docProps = PropertiesService.getDocumentProperties();\n    const oldLog = docProps.getProperty('Sidebar_Logs') || '';\n    const newLog = `${oldLog}\\n${new Date().toLocaleTimeString()} ${message}`.trim();\n    docProps.setProperty('Sidebar_Logs', newLog);\n  } catch (err) {\n    Logger.log('appendLogSafe error: ' + err);\n  }\n}\n\n/******************************************************\n * ER Simulator ‚Äì Intelligent Waveform Mapper Extension\n * (adds a second menu: ‚ÄúER Simulator‚Äù)\n ******************************************************/\n\n// Canonical waveform definitions\nconst WAVEFORMS = {\n  'sinus_ecg': 'Normal Sinus Rhythm',\n  'afib_ecg': 'Atrial Fibrillation',\n  'aflutter_ecg': 'Atrial Flutter',\n  'svt_ecg': 'Supraventricular Tachycardia',\n  'vtach_ecg': 'Ventricular Tachycardia',\n  'vfib_ecg': 'Ventricular Fibrillation',\n  'asystole_ecg': 'Asystole (Flatline)',\n  'paced_ecg': 'Paced Rhythm',\n  'junctional_ecg': 'Junctional Rhythm',\n  'bigeminy_ecg': 'Ventricular Bigeminy',\n  'trigeminy_ecg': 'Ventricular Trigeminy',\n  'idioventricular_ecg': 'Idioventricular Rhythm',\n  'torsades_ecg': 'Torsades de Pointes',\n  'peapulseless_ecg': 'Pulseless Electrical Activity',\n  'artifact_ecg': 'Artifact / Noise'\n};\n\n// === 1. Extend onOpen() safely ===\n(function extendMenu_() {\n  const ui = getSafeUi_();\n  if (!ui) { Logger.log(\"Web app context - skipping UI\"); }\n  try {\n    ui.createMenu('üß† Sim Builder')\n      .addItem('ü©∫ Suggest Waveform Mapping', 'suggestWaveformMapping')\n      .addItem('üîÑ Auto-Map All Waveforms', 'autoMapAllWaveforms')\n      .addSeparator()\n      .addItem('üìä Analyze Current Mappings', 'analyzeCurrentMappings')\n      .addItem('‚ùå Clear All Waveforms', 'clearAllWaveforms')\n      .addToUi();\n  } catch (e) {\n    Logger.log('Menu extension error: ' + e);\n  }\n})();\n\n// === 2. Mapping logic ===\nfunction detectWaveformForState_(caseTitle, initialRhythm, dispositionPlan, stateName) {\n  const txt = `${caseTitle} ${initialRhythm} ${dispositionPlan}`.toLowerCase();\n  const isArrest = /arrest|critical/i.test(stateName);\n  const isWorsening = /worsening|deterior/i.test(stateName);\n\n  if (isArrest) {\n    if (txt.includes('pea')) return 'peapulseless_ecg';\n    if (txt.includes('asystole') || txt.includes('flatline')) return 'asystole_ecg';\n    if (txt.includes('vfib')) return 'vfib_ecg';\n    if (txt.includes('vtach')) return 'vtach_ecg';\n    if (txt.includes('torsades')) return 'torsades_ecg';\n    return 'asystole_ecg';\n  }\n  if (isWorsening) {\n    if (txt.includes('vtach')) return 'vtach_ecg';\n    if (txt.includes('svt')) return 'svt_ecg';\n    if (txt.includes('aflutter')) return 'aflutter_ecg';\n  }\n  if (txt.includes('afib')) return 'afib_ecg';\n  if (txt.includes('aflutter')) return 'aflutter_ecg';\n  if (txt.includes('paced') || txt.includes('pacemaker')) return 'paced_ecg';\n  if (txt.includes('junctional')) return 'junctional_ecg';\n  if (txt.includes('bigeminy')) return 'bigeminy_ecg';\n  if (txt.includes('trigeminy')) return 'trigeminy_ecg';\n  return 'sinus_ecg';\n}\n\n// === 3. Helpers ===\nfunction getHeaders_(sheet) {\n  const t1 = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];\n  const t2 = sheet.getRange(2, 1, 1, sheet.getLastColumn()).getValues()[0];\n  return t1.map((a, i) => `${a}:${t2[i]}`);\n}\nfunction buildCase_(headers, row) {\n  const o = {};\n  headers.forEach((h, i) => (o[h] = row[i]));\n  return o;\n}\n\n// === 4. Suggest mapping for active row ===\nfunction suggestWaveformMapping() {\n  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Master Scenario Convert');\n  const ui = getSafeUi_();\n  if (!sheet) return ui.alert('‚ùå Sheet \"Master Scenario Convert\" not found');\n  const r = sheet.getActiveCell().getRow();\n  if (r < 3) return ui.alert('Select a data row (‚â• 3)');\n\n  const headers = getHeaders_(sheet);\n  const vals = sheet.getRange(r, 1, 1, headers.length).getValues()[0];\n  const data = buildCase_(headers, vals);\n  const title = data['Case_Organization:Reveal_Title'] || data['Case_Organization:Spark_Title'] || '';\n  const rhythm = data['Patient_Demographics_and_Clinical_Data:Initial_Rhythm'] || '';\n  const plan = data['Situation_and_Environment_Details:Disposition_Plan'] || '';\n  const states = (data['image sync:Default_Patient_States'] || 'Baseline,Worsening,Arrest,Recovery').split(',');\n\n  let msg = `üìã ${title}\\n\\nü©∫ Suggested Waveforms:\\n`;\n  ['Initial_Vitals','State1_Vitals','State2_Vitals','State3_Vitals','State4_Vitals','State5_Vitals'].forEach((f,i)=>{\n    const sName = states[i] || f;\n    const w = detectWaveformForState_(title, rhythm, plan, sName);\n    msg += `‚Ä¢ ${sName}: ${WAVEFORMS[w]}\\n`;\n  });\n  if (ui) { ui.alert('Waveform Suggestions', msg, ui.ButtonSet.OK); }\n}\n\n// === 5. Auto-map all waveforms ===\nfunction autoMapAllWaveforms() {\n  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Master Scenario Convert');\n  const ui = getSafeUi_();\n  if (!sheet) return ui.alert('‚ùå Sheet \"Master Scenario Convert\" not found');\n  if (ui.alert('Auto-Map Waveforms','Map all cases intelligently?',ui.ButtonSet.YES_NO)!==ui.Button.YES) return;\n\n  const headers = getHeaders_(sheet);\n  const dataR = sheet.getRange(3,1,sheet.getLastRow()-2,headers.length);\n  const data = dataR.getValues();\n  let count=0;\n\n  data.forEach(row=>{\n    const d=buildCase_(headers,row);\n    const title=d['Case_Organization:Reveal_Title']||'';\n    const rhythm=d['Patient_Demographics_and_Clinical_Data:Initial_Rhythm']||'';\n    const plan=d['Situation_and_Environment_Details:Disposition_Plan']||'';\n    const states=(d['image sync:Default_Patient_States']||'Baseline,Worsening,Arrest,Recovery').split(',');\n    ['Initial_Vitals','State1_Vitals','State2_Vitals','State3_Vitals','State4_Vitals','State5_Vitals'].forEach((f,i)=>{\n      const col=headers.indexOf(`Monitor_Vital_Signs:${f}`);\n      if(col===-1)return;\n      try{\n        const v=JSON.parse(row[col]);\n        const w=detectWaveformForState_(title,rhythm,plan,states[i]||f);\n        v.waveform=w; row[col]=JSON.stringify(v); count++;\n      }catch(e){}\n    });\n  });\n  dataR.setValues(data);\n  if (ui) { ui.alert('‚úÖ Auto-mapping complete',`Updated ${count} waveforms`,ui.ButtonSet.OK); }\n}\n\n// === 6. Analyze distribution ===\nfunction analyzeCurrentMappings() {\n  const sheet=SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Master Scenario Convert');\n  const ui=getSafeUi_();\n  if(!sheet)return ui.alert('‚ùå Sheet not found');\n  const h=getHeaders_(sheet);\n  const dr=sheet.getRange(3,1,sheet.getLastRow()-2,h.length);\n  const d=dr.getValues();\n  const stats={};let tot=0,withWF=0;\n  d.forEach(r=>{\n    ['Initial_Vitals','State1_Vitals','State2_Vitals','State3_Vitals','State4_Vitals','State5_Vitals'].forEach(f=>{\n      const c=h.indexOf(`Monitor_Vital_Signs:${f}`);\n      if(c===-1)return;\n      try{const v=JSON.parse(r[c]);tot++;if(v.waveform){withWF++;stats[v.waveform]=(stats[v.waveform]||0)+1;}}catch(e){}\n    });\n  });\n  let msg=`Total Vitals: ${tot}\\nWith Waveforms: ${withWF}\\nMissing: ${tot-withWF}\\n\\n`;\n  Object.keys(stats).sort((a,b)=>stats[b]-stats[a]).forEach(k=>msg+=`${WAVEFORMS[k]||k}: ${stats[k]}\\n`);\n  if (ui) { ui.alert('Waveform Analysis',msg,ui.ButtonSet.OK); }\n}\n\n// === 7. Clear all waveforms ===\nfunction clearAllWaveforms() {\n  const sheet=SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Master Scenario Convert');\n  const ui=getSafeUi_();\n  if(!sheet)return ui.alert('‚ùå Sheet not found');\n  if(ui.alert('Clear All Waveforms','‚ö†Ô∏è Remove all waveforms?',ui.ButtonSet.YES_NO)!==ui.Button.YES)return;\n  const h=getHeaders_(sheet);\n  const dr=sheet.getRange(3,1,sheet.getLastRow()-2,h.length);\n  const d=dr.getValues();let n=0;\n  d.forEach(r=>{\n    ['Initial_Vitals','State1_Vitals','State2_Vitals','State3_Vitals','State4_Vitals','State5_Vitals'].forEach(f=>{\n      const c=h.indexOf(`Monitor_Vital_Signs:${f}`);if(c===-1)return;\n      try{const v=JSON.parse(r[c]);if(v.waveform){delete v.waveform;r[c]=JSON.stringify(v);n++;}}catch(e){}\n    });\n  });\n  dr.setValues(d);\n  if (ui) { ui.alert('‚ùå Cleared',`Removed ${n} waveforms`,ui.ButtonSet.OK); }\n}\n\n\n/******************************************************\n * üîó Live Sync Webhook Trigger (Google ‚Üí Local)\n ******************************************************/\nconst LIVE_SYNC_URL = \"https://overlate-nontemporizingly-edris.ngrok-free.dev/vitals-update\"; // ngrok tunnel\n\nfunction onEdit(e) {\n  try {\n    // If run manually (no event), bail early\n    if (!e || !e.range) {\n      Logger.log(\"‚ö†Ô∏è onEdit called manually - skipping live sync\");\n      return;\n    }\n\n    const sheet = e.range.getSheet();\n    if (sheet.getName() !== \"Master Scenario Convert\" || e.range.getRow() < 3) {\n      Logger.log(\"‚ö†Ô∏è Edit ignored: not in Master Scenario Convert or header row\");\n      return;\n    }\n\n    const row = e.range.getRow();\n    const dataRange = sheet.getRange(row, 1, 1, sheet.getLastColumn());\n    const headers1 = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];\n    const headers2 = sheet.getRange(2, 1, 1, sheet.getLastColumn()).getValues()[0];\n    const rowValues = dataRange.getValues()[0];\n    const mergedKeys = headers1.map((t1, i) => `${t1}:${headers2[i]}`);\n\n    const entry = {};\n    mergedKeys.forEach((key, i) => {\n      const val = rowValues[i];\n      if (val && val !== \"N/A\") entry[key] = tryParseJSON(val);\n    });\n\n    // Post update to your local LiveSync server\n    const options = {\n      method: \"post\",\n      contentType: \"application/json\",\n      payload: JSON.stringify(entry),\n      muteHttpExceptions: true,\n    };\n\n    const response = UrlFetchApp.fetch(LIVE_SYNC_URL, options);\n    Logger.log(`üì° Sent live update for row ${row}: ${response.getResponseCode()}`);\n  } catch (err) {\n    Logger.log(\"‚ùå Live Sync error: \" + err);\n  }\n}\n\n\n// === TEST FUNCTION: Manually trigger batch processing ===\nfunction testBatchProcessRow3() {\n  try {\n    const ss = SpreadsheetApp.getActive();\n    const inSheet = ss.getSheetByName('Input');\n    const outSheet = ss.getSheetByName('Master Scenario Convert');\n\n    Logger.log('üìã Starting test batch for Input row 3...');\n\n    const summary = processOneInputRow_(inSheet, outSheet, 3, true);\n\n    Logger.log('‚úÖ Result: ' + JSON.stringify(summary));\n\n    return {\n      success: true,\n      summary: summary,\n      message: summary.message || 'Completed'\n    };\n\n  } catch (err) {\n    Logger.log('‚ùå ERROR: ' + err.message);\n    Logger.log('Stack: ' + err.stack);\n\n    return {\n      success: false,\n      error: err.message,\n      stack: err.stack,\n      errorDetails: err.toString()\n    };\n  }\n}\n\n\n\n// === DIAGNOSTIC FUNCTION: Test Live Logging System ===\nfunction testLiveLogging() {\n  try {\n    Logger.log('üîç Starting Live Logging Diagnostic Test');\n\n    // Test 1: Can we write to Document Properties?\n    Logger.log('Test 1: Writing to Document Properties...');\n    appendLogSafe('üß™ TEST LOG 1: appendLogSafe() is working!');\n    Logger.log('‚úÖ Test 1 passed');\n\n    // Test 2: Can we read back what we wrote?\n    Logger.log('Test 2: Reading from Document Properties...');\n    const logs = getSidebarLogs();\n    Logger.log('Retrieved logs: ' + logs);\n    Logger.log('‚úÖ Test 2 passed');\n\n    // Test 3: Add more logs\n    Logger.log('Test 3: Adding multiple log entries...');\n    appendLogSafe('üß™ TEST LOG 2: Second entry');\n    appendLogSafe('üß™ TEST LOG 3: Third entry with timestamp');\n    Logger.log('‚úÖ Test 3 passed');\n\n    // Test 4: Read final result\n    const finalLogs = getSidebarLogs();\n    Logger.log('Final logs content:');\n    Logger.log(finalLogs);\n\n    return {\n      success: true,\n      message: 'All tests passed! Check execution logs for details.',\n      logsLength: finalLogs.length,\n      logsPreview: finalLogs.substring(0, 200)\n    };\n\n  } catch (err) {\n    Logger.log('‚ùå ERROR: ' + err.message);\n    Logger.log('Stack: ' + err.stack);\n    return {\n      success: false,\n      error: err.message,\n      stack: err.stack\n    };\n  }\n}\n\n// === DIAGNOSTIC FUNCTION: Check if batch mode flag is set ===\nfunction testBatchModeFlag() {\n  try {\n    const inSheet = SpreadsheetApp.getActive().getSheetByName('Input');\n    const outSheet = SpreadsheetApp.getActive().getSheetByName('Master Scenario Convert');\n\n    Logger.log('üîç Testing batch mode flag...');\n    Logger.log('');\n\n    // Call processOneInputRow_ with batchMode=true\n    Logger.log('Calling processOneInputRow_ with batchMode=true on row 3...');\n    const result = processOneInputRow_(inSheet, outSheet, 3, true);\n\n    Logger.log('Result: ' + JSON.stringify(result));\n    Logger.log('');\n    Logger.log('Now check Document Properties:');\n\n    const logs = getSidebarLogs();\n    Logger.log('Sidebar_Logs content:');\n    Logger.log(logs || '(empty)');\n\n    return {\n      success: true,\n      result: result,\n      logsFound: logs && logs.length > 0,\n      logsLength: (logs || '').length,\n      logsPreview: (logs || '').substring(0, 300)\n    };\n\n  } catch (err) {\n    Logger.log('‚ùå ERROR: ' + err.message);\n    return {\n      success: false,\n      error: err.message\n    };\n  }\n\nfunction clearApiKeyCache() {\n  PropertiesService.getDocumentProperties().deleteProperty('OPENAI_API_KEY');\n  Logger.log('‚úÖ Cleared API key cache');\n  return 'API key cache cleared. Will re-read from Settings sheet on next use.';\n}\n\n/**\n * Show a temporary toast notification\n * Auto-closes after 3 seconds\n */\nfunction showToast(message, duration) {\n  try {\n    SpreadsheetApp.getActiveSpreadsheet().toast(message, '‚úÖ Success', duration || 3);\n  } catch (e) {\n    Logger.log('Toast: ' + message);\n  }\n}\n\n\nfunction analyzeOutputSheetStructure() {\n  const ss = SpreadsheetApp.getActive();\n\n  // Get output sheet name from Settings\n  const settingsSheet = ss.getSheetByName('Settings');\n  let outputSheetName = 'Master Scenario Convert';\n  if (settingsSheet) {\n    const settingsOut = settingsSheet.getRange('A1').getValue();\n    if (settingsOut) outputSheetName = settingsOut;\n  }\n\n  const outSheet = ss.getSheetByName(outputSheetName);\n  if (!outSheet) return { error: 'Output sheet not found: ' + outputSheetName };\n\n  const lastRow = outSheet.getLastRow();\n  const lastCol = outSheet.getLastColumn();\n\n  // Get headers (row 1 and row 2)\n  const tier1Headers = outSheet.getRange(1, 1, 1, lastCol).getValues()[0];\n  const tier2Headers = outSheet.getRange(2, 1, 1, lastCol).getValues()[0];\n\n  // Get a few sample data rows\n  const sampleRows = [];\n  const sampleStart = Math.max(3, lastRow - 2); // Last 3 data rows\n  if (lastRow >= 3) {\n    const sampleData = outSheet.getRange(sampleStart, 1, lastRow - sampleStart + 1, lastCol).getValues();\n    sampleRows.push(...sampleData);\n  }\n\n  return {\n    sheetName: outputSheetName,\n    lastRow: lastRow,\n    lastCol: lastCol,\n    tier1Headers: tier1Headers,\n    tier2Headers: tier2Headers,\n    sampleRows: sampleRows,\n    sampleStartRow: sampleStart\n  };\n}\n\nfunction clearAllBatchProperties() {\n  const props = PropertiesService.getDocumentProperties();\n\n  // Clear all batch-related properties\n  const keysToDelete = [\n    'BATCH_QUEUE',\n    'BATCH_ROWS',\n    'BATCH_INPUT_SHEET',\n    'BATCH_OUTPUT_SHEET',\n    'BATCH_MODE',\n    'BATCH_SPEC',\n    'BATCH_STOP',\n    'BATCH_RUNNING',\n    'BATCH_CURRENT_ROW'\n  ];\n\n  keysToDelete.forEach(key => {\n    try {\n      props.deleteProperty(key);\n    } catch(e) {\n      // Ignore if property doesn't exist\n    }\n  });\n\n  Logger.log('‚úÖ Cleared all batch properties');\n  return 'Batch queue cleared. Ready to start fresh from row 15.';\n}\n}\n\n\n// ==================== TITLE OPTIMIZER (ATSR) ====================\n// Complete ATSR system with Spark/Reveal titles and mystery regeneration\n\n/**\n * ATSR Title Generator Feature - Complete\n *\n * Everything for ATSR (Automated Titles, Summary & Review Generator):\n * - Complete ATSR UI with selection interface\n * - ALL GOLDEN PROMPTS PRESERVED CHARACTER-FOR-CHARACTER\n * - OpenAI API integration\n * - Response parsing and validation\n * - User selection and memory tracking\n *\n * Common Utility Goal: Adjust all ATSR features\n *\n * External Dependencies:\n * - Core_Processing_Engine.gs (for tryParseJSON)\n *\n * Generated: 2025-11-04T18:48:41.621Z\n * Source: Code_ULTIMATE_ATSR.gs (complete feature extraction)\n */\n\n// ==================== ATSR FEATURE ====================\n\n// Custom menu for test environment\n\n// ========== ATSR HELPER FUNCTIONS & CONSTANTS ==========\n\n\n\n\n\n\n// Constants for OpenAI API\n\n// API Key Management\n\n\n// OpenAI API Calls\n\n// ========== 6) ATSR ‚Äî Titles & Summary (Keep & Regenerate, Deselect, Memory) ==========\n\n\n\n\n// ATSR-specific JSON parser that handles markdown code fences\n\n\n\n\n\n\n\n\n// Generate ultra-mysterious Spark Titles that completely hide the diagnosis\nfunction generateMysteriousSparkTitles(row, mysteryLevel, currentTitles) {\n  const s = pickMasterSheet_();\n  const headers = s.getRange(2,1,1,s.getLastColumn()).getValues()[0];\n  const rowData = s.getRange(row, 1, 1, headers.length).getValues()[0];\n\n  // Build data object\n  const data = {};\n  headers.forEach((h,i) => { data[h] = rowData[i]; });\n\n  // Extract the diagnosis from Reveal Title\n  const revealTitle = data['Case_Organization_Reveal_Title'] || '';\n  const diagnosisMatch = revealTitle.match(/^([^(]+)/);\n  const diagnosis = diagnosisMatch ? diagnosisMatch[1].trim() : 'Unknown';\n\n  // Extract age/gender from current Spark Title (e.g., \"Title (58 M): Description\")\n  const currentSparkTitle = data['Case_Organization_Spark_Title'] || '';\n  const demographicMatch = currentSparkTitle.match(/\\((\\d+\\s+[MF])\\)/);\n  const demographic = demographicMatch ? demographicMatch[1] : null;\n\n  // Get patient summary\n  const patientSummary = data['Case_Summary_Patient_Summary'] || 'A patient presents with concerning symptoms.';\n\n  // Adjust mystery level instructions\n  const level = mysteryLevel || 1;\n  let mysteryInstructions = '';\n\n  if (level === 1) {\n    mysteryInstructions = '**MYSTERY LEVEL 1 (Moderate Mystery):**\\n' +\n      '- Use vague family observations\\n' +\n      '- Avoid medical terms but can hint at general concern\\n' +\n      '- Example: \"Grandpa\\'s Not Acting Right\"\\n\\n';\n  } else if (level === 2) {\n    mysteryInstructions = '**MYSTERY LEVEL 2 (High Mystery):**\\n' +\n      '- Even more vague and indirect\\n' +\n      '- Focus on pure behavioral changes\\n' +\n      '- Example: \"Something\\'s Different Today\"\\n\\n';\n  } else if (level === 3) {\n    mysteryInstructions = '**MYSTERY LEVEL 3 (Maximum Mystery):**\\n' +\n      '- Extremely vague, almost cryptic\\n' +\n      '- Pure emotion and concern only\\n' +\n      '- Example: \"I\\'m Worried\"\\n\\n';\n  } else {\n    mysteryInstructions = '**MYSTERY LEVEL ' + level + ' (ULTRA Maximum):**\\n' +\n      '- Absolutely NO specifics whatsoever\\n' +\n      '- Pure gut feeling and unease\\n' +\n      '- Example: \"Something\\'s Not Right\"\\n\\n';\n  }\n\n  // Build the prompt based on whether we have current titles to iterate on\n  let prompt = '';\n\n  if (currentTitles && currentTitles.length > 0) {\n    // ITERATIVE MODE: Make existing titles MORE mysterious\n    const formatInstruction = demographic\n      ? '**FORMAT REQUIREMENT:**\\nEach title MUST follow this exact format:\\n\"Title (' + demographic + '): Brief description\"\\n\\nExample: \"Grandpa\\'s Not Acting Right (' + demographic + '): Family Concerned\"\\n\\n'\n      : '';\n\n    prompt = 'You are making existing pre-simulation titles EVEN MORE MYSTERIOUS to completely hide the diagnosis.\\n\\n' +\n      mysteryInstructions +\n      '**YOUR TASK:**\\n' +\n      'Take each of these titles and make them MORE vague, MORE mysterious, and LESS revealing.\\n' +\n      'Remove any remaining hints about the condition. Make them more cryptic and indirect.\\n' +\n      'Keep the human context and emotional tone, but be even more subtle.\\n\\n' +\n      '**Current Titles to Make More Mysterious:**\\n' +\n      JSON.stringify(currentTitles, null, 2) + '\\n\\n' +\n      formatInstruction +\n      '**Patient Context (to maintain relevance):**\\n' +\n      patientSummary + '\\n\\n' +\n      '**Actual Diagnosis (HIDE THIS COMPLETELY):**\\n' +\n      diagnosis + '\\n\\n' +\n      '**CRITICAL RULES:**\\n' +\n      '- NEVER mention the diagnosis (' + diagnosis + ')\\n' +\n      '- NEVER use medical terminology\\n' +\n      '- Remove any remaining clinical hints\\n' +\n      '- Make each title LESS specific than before\\n' +\n      '- Use even vaguer language\\n' +\n      '- Focus on pure emotion and concern\\n' +\n      '- Keep titles grounded in the patient context (age, setting, etc.)\\n' +\n      '- Maintain human perspective (family member, concerned observer)\\n' +\n      (demographic ? '- ALWAYS include (' + demographic + ') in each title\\n' : '') +\n      '\\n' +\n      'Return ONLY a JSON array of the same number of titles, now more mysterious:\\n' +\n      '[\"More mysterious version of title 1\", \"More mysterious version of title 2\", ...]';\n  } else {\n    // INITIAL MODE: Generate from scratch\n    const formatInstruction = demographic\n      ? '**FORMAT REQUIREMENT:**\\nEach title MUST follow this exact format:\\n\"Title (' + demographic + '): Brief description\"\\n\\nExample: \"Grandpa\\'s Not Acting Right (' + demographic + '): Family Concerned\"\\n\\n'\n      : '';\n\n    const exampleSuffix = demographic ? ' (' + demographic + ')' : '';\n\n    prompt = 'You are creating ULTRA-MYSTERIOUS pre-simulation titles that COMPLETELY HIDE the diagnosis from learners.\\n\\n' +\n      mysteryInstructions +\n      formatInstruction +\n      '**CRITICAL RULES:**\\n' +\n      '- NEVER mention the diagnosis (' + diagnosis + ')\\n' +\n      '- NEVER use medical terminology that reveals the condition\\n' +\n      '- NEVER hint at the organ system or pathophysiology\\n' +\n      '- Focus on vague, concerning observations\\n' +\n      '- Use layperson language and indirect descriptions\\n' +\n      '- Create curiosity and mystery without clinical clues\\n' +\n      (demographic ? '- ALWAYS include (' + demographic + ') in each title\\n' : '') +\n      '\\n' +\n      '**Patient Context:**\\n' +\n      patientSummary + '\\n\\n' +\n      '**Actual Diagnosis (HIDE THIS COMPLETELY):**\\n' +\n      diagnosis + '\\n\\n' +\n      '**Examples of Ultra-Mysterious Titles:**\\n' +\n      '- \"Grandpa\\'s Not Acting Right' + exampleSuffix + ': Family Concerned\"\\n' +\n      '- \"She Just Doesn\\'t Look Right' + exampleSuffix + ': Something\\'s Wrong\"\\n' +\n      '- \"Something\\'s Off with Dad Today' + exampleSuffix + ': Can\\'t Put My Finger on It\"\\n' +\n      '- \"The Kid Who Won\\'t Stop Crying' + exampleSuffix + ': Parents Worried\"\\n' +\n      '- \"Mom Says He\\'s Not Himself' + exampleSuffix + ': Acting Strange\"\\n\\n' +\n      '**Generate 5 ultra-mysterious Spark Titles that:**\\n' +\n      '1. Use concerned family member observations\\n' +\n      '2. Describe behavioral/emotional changes only\\n' +\n      '3. Avoid ANY medical symptoms or terms\\n' +\n      '4. Create urgency through human context\\n' +\n      '5. Make learners think \"I need to assess this\"\\n' +\n      (demographic ? '6. Include (' + demographic + ') in EVERY title\\n' : '') +\n      '\\n' +\n      'Return ONLY a JSON array of 5 title strings, no explanation:\\n' +\n      '[\"Title 1\", \"Title 2\", \"Title 3\", \"Title 4\", \"Title 5\"]';\n  }\n\n  Logger.log('üé≠ Generating ultra-mysterious Spark Titles (Level ' + level + ')');\n  Logger.log('   For diagnosis: ' + diagnosis);\n  if (currentTitles && currentTitles.length > 0) {\n    Logger.log('   Iterating on ' + currentTitles.length + ' existing titles');\n  } else {\n    Logger.log('   Generating fresh titles from scratch');\n  }\n\n  const response = callOpenAI(prompt, 0.9); // High temperature for creativity\n  Logger.log('üìù OpenAI response: ' + response);\n\n  // Parse the JSON array\n  const cleanResponse = response.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  const titles = JSON.parse(cleanResponse);\n\n  Logger.log('‚úÖ Generated ' + titles.length + ' mysterious titles');\n  return titles;\n}\n\n// New save function that handles data from the UI\n\n// Legacy function kept for compatibility\n\n\n\n// ==================== CATEGORIES & PATHWAYS PHASE 2 ====================\n// Field Selector with 27 default headers and AI recommendations\n\n\n/**\n * Get AI-recommended fields based on pathway discovery potential\n * Asks OpenAI which fields would maximize clinical reasoning pathways\n * Only recommends from unselected fields (excludes currently selected)\n */\n\n/**\n * Static fallback recommendations (used when API unavailable)\n */\n\n\n\n/**\n * Get static recommended fields using ACTUAL flattened header names\n * Returns 8-12 fields that are valuable but not in the default 27\n */\nfunction getStaticRecommendedFields_() {\n  Logger.log('üîç getStaticRecommendedFields_() - using dynamic header cache');\n\n  try {\n    const docProps = PropertiesService.getDocumentProperties();\n    const cachedMergedKeys = docProps.getProperty('CACHED_MERGED_KEYS');\n    \n    if (!cachedMergedKeys) {\n      Logger.log('‚ö†Ô∏è No cached headers - returning empty array');\n      return [];\n    }\n\n    const allFields = JSON.parse(cachedMergedKeys);\n    Logger.log('‚úÖ Read ' + allFields.length + ' fields from CACHED_MERGED_KEYS');\n\n    // Get currently selected fields to avoid duplicates\n    const savedSelection = docProps.getProperty('SELECTED_CACHE_FIELDS');\n    const selected = savedSelection ? JSON.parse(savedSelection) : [];\n\n    // Intelligent selection based on tier2 patterns\n    // These patterns identify clinically useful fields\n    const valuableTier2Patterns = [\n      'Presenting_Complaint',\n      'Chief_Complaint', \n      'Medical_History',\n      'Past_Medical_History',\n      'Medications',\n      'Current_Medications',\n      'Allergies',\n      'Social_History',\n      'Teaching_Points',\n      'Key_Teaching_Points',\n      'Common_Pitfalls',\n      'Common_Errors',\n      'Critical_Actions',\n      'Critical_Action_Checklist',\n      'Expected_Actions',\n      'Common_Pitfalls_Discussion',\n      'Differential_Diagnosis',\n      'Key_Clinical_Features'\n    ];\n\n    const recommended = [];\n\n    allFields.forEach(function(fieldName) {\n      // Skip if already selected\n      if (selected.indexOf(fieldName) !== -1) {\n        return;\n      }\n\n      // Parse field name: \"Patient_Demographics_and_Clinical_Data_Age\" ‚Üí tier2: \"Age\"\n      const parts = fieldName.split('_');\n      const tier2 = parts[parts.length - 1];\n\n      // Check if tier2 matches any valuable pattern\n      const isValuable = valuableTier2Patterns.some(function(pattern) {\n        return tier2 === pattern || fieldName.indexOf(pattern) !== -1;\n      });\n\n      if (isValuable && recommended.length < 12) {\n        recommended.push(fieldName);\n      }\n    });\n\n    Logger.log('‚úÖ Selected ' + recommended.length + ' recommended fields dynamically');\n    if (recommended.length > 0) {\n      Logger.log('   Fields: ' + recommended.slice(0, 5).join(', ') + (recommended.length > 5 ? '...' : ''));\n    }\n\n    return recommended;\n\n  } catch (e) {\n    Logger.log('‚ö†Ô∏è Error in getStaticRecommendedFields_: ' + e.message);\n    return [];\n  }\n}\n\n/**\n * Get default 27 field names for cache system\n * These are the core fields needed for pathway analysis\n */\nfunction getDefaultFieldNames_() {\n  // Try to use these specific 27 fields if they exist\n  const preferred = [\n    'Case_Organization_Case_ID',\n    'Case_Organization_Spark_Title',\n    'Case_Organization_Reveal_Title',\n    'Case_Organization_Pathway_or_Course_Name',\n    'Case_Organization_Difficulty_Level',\n    'Case_Organization_Medical_Category',\n    'Case_Patient_Demographics_Age',\n    'Case_Patient_Demographics_Gender',\n    'Case_Patient_Demographics_Chief_Complaint',\n    'Monitor_Vital_Signs_Initial_Vitals',\n    'Monitor_Vital_Signs_State1_Vitals',\n    'Monitor_Vital_Signs_State2_Vitals',\n    'Monitor_Vital_Signs_State3_Vitals',\n    'Monitor_Vital_Signs_State4_Vitals',\n    'Monitor_Vital_Signs_Final_Vitals',\n    'Case_Orientation_Chief_Diagnosis',\n    'Case_Orientation_Key_Clinical_Features',\n    'Case_Orientation_Differential_Diagnosis',\n    'Case_Orientation_Critical_Actions',\n    'Case_Orientation_Time_Sensitive_Factors',\n    'Case_Orientation_Actual_Learning_Outcomes',\n    'Case_Orientation_Teaching_Points',\n    'Case_Orientation_Common_Pitfalls',\n    'Scoring_Criteria_Performance_Benchmarks',\n    'Case_Organization_Pre_Sim_Overview',\n    'Case_Organization_Post_Sim_Overview',\n    'Version_and_Attribution_Full_Attribution_Details'\n  ];\n\n  // Fallback: If we can't verify these exist, just return the list\n  // getAvailableFields() will filter out non-existent ones anyway\n  return preferred;\n}\n\n/**\n * Load saved field selection from DocumentProperties\n * Returns saved array or defaults if none saved\n */\nfunction loadFieldSelection() {\n  const docProps = PropertiesService.getDocumentProperties();\n  const saved = docProps.getProperty('SELECTED_CACHE_FIELDS');\n\n  if (saved) {\n    try {\n      return JSON.parse(saved);\n    } catch (e) {\n      Logger.log('‚ö†Ô∏è Error parsing saved field selection: ' + e.message);\n    }\n  }\n\n  // Return default 27 fields\n  return getDefaultFieldNames_();\n}\n\n\n/**\n * Get all available fields from cached flattened headers\n * Returns array of field objects: { name, tier1, tier2, header }\n * Handles flattened format: Row 2 has \"Case_Organization_Case_ID\"\n */\nfunction getAvailableFields() {\n  const docProps = PropertiesService.getDocumentProperties();\n\n  // Read cached merged keys (flattened headers from Row 2)\n  const mergedKeysJson = docProps.getProperty('CACHED_MERGED_KEYS');\n\n  if (!mergedKeysJson) {\n    throw new Error('Headers not cached. Please run refreshHeaders() first.');\n  }\n\n  const mergedKeys = JSON.parse(mergedKeysJson);\n\n  // Build array of field objects by parsing flattened names\n  const fields = [];\n  for (let i = 0; i < mergedKeys.length; i++) {\n    const merged = String(mergedKeys[i] || '').trim();\n    if (!merged) continue;\n\n    // Parse flattened name: \"Case_Organization_Case_ID\" ‚Üí tier1:\"Case_Organization\", tier2:\"Case_ID\"\n    // OR simpler: \"Case_ID\" ‚Üí tier1:\"Case\", tier2:\"ID\"\n    const parts = merged.split('_');\n\n    let tier1, tier2;\n    if (parts.length >= 3) {\n      // Format: Tier1_Tier1Part2_Tier2 (e.g., \"Case_Organization_Case_ID\")\n      // Take first part(s) as tier1, last part as tier2\n      tier2 = parts[parts.length - 1];\n      tier1 = parts.slice(0, -1).join('_');\n    } else if (parts.length === 2) {\n      // Format: Tier1_Tier2 (e.g., \"Case_ID\")\n      tier1 = parts[0];\n      tier2 = parts[1];\n    } else {\n      // Single part, no underscore\n      tier1 = 'General';\n      tier2 = merged;\n    }\n\n    fields.push({\n      name: merged,        // Use full flattened name as-is\n      tier1: tier1,\n      tier2: tier2,\n      header: merged       // Display flattened name\n    });\n  }\n\n  Logger.log('üìä Found ' + fields.length + ' available fields from flattened headers');\n  return fields;\n}\n\n/**\n * Show dynamic field selector modal\n * Reads all available columns and lets user select which to cache\n */\n\n/**\n * Get rough draft data (immediate, no AI call)\n */\nfunction getFieldSelectorRoughDraft() {\n  Logger.log('üéØ getFieldSelectorRoughDraft() START');\n\n  var docProps = PropertiesService.getDocumentProperties();\n\n  // STEP 1: Get all valid field names from cached headers (Row 2)\n  var cachedMergedKeys = docProps.getProperty('CACHED_MERGED_KEYS');\n  if (!cachedMergedKeys) {\n    Logger.log('‚ö†Ô∏è Headers not cached - refreshing...');\n    refreshHeaders();\n    cachedMergedKeys = docProps.getProperty('CACHED_MERGED_KEYS');\n  }\n\n  var allFields = JSON.parse(cachedMergedKeys);\n  Logger.log('‚úÖ Got ' + allFields.length + ' valid fields from Row 2');\n\n  // STEP 2: Get selected fields (PREFERENCE: last saved, FALLBACK: 35 defaults)\n  var savedSelection = docProps.getProperty('SELECTED_CACHE_FIELDS');\n  var selected;\n\n  if (savedSelection) {\n    // Use last saved selection\n    var savedFields = JSON.parse(savedSelection);\n    Logger.log('üìÇ Found last saved selection: ' + savedFields.length + ' fields');\n\n    // VALIDATE: Remove duplicates\n    var uniqueFields = [];\n    var seen = {};\n    for (var i = 0; i < savedFields.length; i++) {\n      var fieldName = savedFields[i];\n      if (!seen[fieldName]) {\n        uniqueFields.push(fieldName);\n        seen[fieldName] = true;\n      }\n    }\n\n    if (uniqueFields.length < savedFields.length) {\n      Logger.log('‚ö†Ô∏è Removed ' + (savedFields.length - uniqueFields.length) + ' duplicates from saved selection');\n    }\n\n    // VALIDATE: Ensure all fields still exist in current headers\n    var validFields = [];\n    for (var i = 0; i < uniqueFields.length; i++) {\n      if (allFields.indexOf(uniqueFields[i]) !== -1) {\n        validFields.push(uniqueFields[i]);\n      } else {\n        Logger.log('‚ö†Ô∏è Removed invalid field (no longer in CSV): ' + uniqueFields[i]);\n      }\n    }\n\n    selected = validFields;\n    Logger.log('‚úÖ Using ' + selected.length + ' validated fields from last saved selection');\n\n    // Save cleaned version back\n    if (selected.length !== savedFields.length) {\n      docProps.setProperty('SELECTED_CACHE_FIELDS', JSON.stringify(selected));\n      Logger.log('‚úÖ Saved cleaned selection (removed ' + (savedFields.length - selected.length) + ' invalid entries)');\n    }\n\n  } else {\n    // No saved selection - use 35 intelligent defaults\n    Logger.log('‚ö†Ô∏è No saved selection - initializing 35 intelligent defaults');\n\n    var defaultFields = [\n            'Case_Organization_Case_ID',\n      'Case_Organization_Spark_Title',\n      'Case_Organization_Reveal_Title',\n      'Case_Organization_Pathway_or_Course_Name',\n      'Case_Organization_Difficulty_Level',\n      'Case_Organization_Medical_Category',\n\n            'Patient_Demographics_and_Clinical_Data_Age',\n      'Patient_Demographics_and_Clinical_Data_Gender',\n      'Patient_Demographics_and_Clinical_Data_Presenting_Complaint',\n      'Patient_Demographics_and_Clinical_Data_Past_Medical_History',\n      'Patient_Demographics_and_Clinical_Data_Exam_Positive_Findings',\n      'Monitor_Vital_Signs_Initial_Vitals',\n      'Scenario_Progression_States_Decision_Nodes_JSON',\n      'Set_the_Stage_Context_Case_Summary_Concise',\n\n            'CME_and_Educational_Content_CME_Learning_Objective',\n      'Set_the_Stage_Context_Educational_Goal',\n      'Set_the_Stage_Context_Why_It_Matters',\n      'Developer_and_QA_Metadata_Simulation_Quality_Score',\n      'Case_Organization_Original_Title',\n\n            'Set_the_Stage_Context_Environment_Type',\n      'Set_the_Stage_Context_Environment_Description_for_AI_Image',\n      'Situation_and_Environment_Details_Triage_or_SBAR_Note',\n      'Situation_and_Environment_Details_Disposition_Plan',\n      'Scenario_Progression_States_Branching_Notes',\n      'Staff_and_AI_Interaction_Config_Patient_Script',\n\n            'Monitor_Vital_Signs_State1_Vitals',\n      'Monitor_Vital_Signs_State2_Vitals',\n      'Monitor_Vital_Signs_State3_Vitals',\n      'Monitor_Vital_Signs_State4_Vitals',\n      'Monitor_Vital_Signs_State5_Vitals',\n      'Monitor_Vital_Signs_Vitals_Format',\n\n            'Developer_and_QA_Metadata_AI_Reflection_and_Suggestions',\n      'Version_and_Attribution_Full_Attribution_Details',\n      'Case_Organization_Pre_Sim_Overview',\n      'Case_Organization_Post_Sim_Overview'\n    ];\n\n    // VALIDATE: Ensure defaults exist in current headers\n    var validDefaults = [];\n    for (var i = 0; i < defaultFields.length; i++) {\n      if (allFields.indexOf(defaultFields[i]) !== -1) {\n        validDefaults.push(defaultFields[i]);\n      } else {\n        Logger.log('‚ö†Ô∏è Default field not in current CSV: ' + defaultFields[i]);\n      }\n    }\n\n    selected = validDefaults;\n    Logger.log('‚úÖ Using ' + selected.length + ' validated defaults (from 35 originals)');\n\n    // Save validated defaults\n    docProps.setProperty('SELECTED_CACHE_FIELDS', JSON.stringify(selected));\n    Logger.log('‚úÖ Saved validated defaults');\n  }\n\n  Logger.log('‚úÖ getFieldSelectorRoughDraft() COMPLETE');\n  Logger.log('   ‚Üí ' + allFields.length + ' total fields available');\n  Logger.log('   ‚Üí ' + selected.length + ' fields selected (DEFAULT section)');\n  Logger.log('   ‚Üí ' + (allFields.length - selected.length) + ' fields unselected (OTHER section)');\n\n  return {\n    allFields: allFields,\n    selected: selected\n  };\n}\n\n/**\n * Get AI recommendations (async, called after rough draft loads)\n */\nfunction getAIRecommendations(currentlySelected, availableFields) {\n  Logger.log('ü§ñ getAIRecommendations() START');\n  Logger.log('   Current selection: ' + currentlySelected.length + ' fields');\n  Logger.log('   Available fields: ' + availableFields.length);\n\n  try {\n    // Check for cached recommendations first\n    var docProps = PropertiesService.getDocumentProperties();\n    var cachedRecs = docProps.getProperty('AI_RECOMMENDED_FIELDS');\n    var cachedTime = docProps.getProperty('AI_RECOMMENDATIONS_TIMESTAMP');\n\n    if (cachedRecs && cachedTime) {\n      var age = (new Date() - new Date(cachedTime)) / 1000;\n      if (age < 3600) { // 1 hour cache\n        Logger.log('‚úÖ Using cached AI recommendations (age: ' + Math.round(age) + 's)');\n        return JSON.parse(cachedRecs);\n      }\n    }\n\n    // Call getRecommendedFields (which calls OpenAI)\n    Logger.log('üìû Calling OpenAI API...');\n    var availableFieldObjects = availableFields.map(function(name) {\n      return { name: name };\n    });\n\n    var recommendations = getRecommendedFields(availableFieldObjects, currentlySelected);\n\n    // Cache for next time\n    docProps.setProperty('AI_RECOMMENDED_FIELDS', JSON.stringify(recommendations));\n    docProps.setProperty('AI_RECOMMENDATIONS_TIMESTAMP', new Date().toISOString());\n\n    Logger.log('‚úÖ Got ' + recommendations.length + ' AI recommendations');\n\n    return recommendations;\n\n  } catch (error) {\n    Logger.log('‚ö†Ô∏è AI recommendation error: ' + error.toString());\n    return []; // Return empty array on error\n  }\n}\n\n\n\n\nfunction getRecommendedFields(availableFields, selectedFields) {\n  // Try to get AI recommendations, fall back to static if API unavailable\n  try {\n    const apiKey = readApiKey_();\n    if (!apiKey) {\n      Logger.log('‚ö†Ô∏è No API key - using static recommendations');\n      return getStaticRecommendedFields_();\n    }\n\n    // availableFields passed as parameter\n    const currentlySelected = selectedFields; // Get saved or default fields\n\n    // Filter to only unselected fields\n    const unselectedFields = availableFields.filter(function(f) {\n      return currentlySelected.indexOf(f.name) === -1;\n    });\n\n    const fieldDescriptions = unselectedFields.map(function(f) {\n      return {\n        name: f.name,\n        header: f.header,\n        category: f.tier1\n      };\n    });\n\n    const prompt = 'You are a medical education expert analyzing which data fields would be most valuable for AI pathway discovery in emergency medicine simulation cases.\\n\\n' +\n      'CURRENTLY SELECTED FIELDS (already chosen, DO NOT recommend these):\\n' +\n      JSON.stringify(currentlySelected, null, 2) + '\\n\\n' +\n      'AVAILABLE UNSELECTED FIELDS (choose from these ONLY):\\n' +\n      JSON.stringify(fieldDescriptions, null, 2) + '\\n\\n' +\n      'PATHWAY DISCOVERY GOALS:\\n' +\n      '- Clinical reasoning pathways (differential diagnosis, pattern recognition)\\n' +\n      '- Risk stratification pathways (high-risk ‚Üí low-risk)\\n' +\n      '- Time-critical decision pathways (STEMI, stroke, sepsis)\\n' +\n      '- Cognitive bias awareness pathways (anchoring, premature closure)\\n' +\n      '- Skill progression pathways (novice ‚Üí expert)\\n' +\n      '- Patient complexity pathways (single-system ‚Üí multi-system)\\n\\n' +\n      'TASK: From the UNSELECTED fields only, recommend fields that would maximize (as many or few as make sense) pathway discovery potential.\\n\\n' +\n      'PRIORITIZE fields that:\\n' +\n      '- Enable differential diagnosis logic\\n' +\n      '- Support risk stratification\\n' +\n      '- Reveal clinical reasoning patterns\\n' +\n      '- Identify time-critical cases\\n' +\n      '- Show patient complexity\\n\\n' +\n      'IMPORTANT: Only recommend from UNSELECTED fields. Do NOT include any currently selected fields.\\n\\n' +\n      'Return ONLY a JSON array of field names: [\"fieldName1\", \"fieldName2\", ...]';\n\n    const url = 'https://api.openai.com/v1/chat/completions';\n    const payload = {\n      model: 'gpt-4o',  // Project standard\n      messages: [\n        {\n          role: 'system',\n          content: 'You are an expert in medical education and clinical reasoning. Respond ONLY with valid JSON. NEVER recommend fields that are already selected.'\n        },\n        {\n          role: 'user',\n          content: prompt\n        }\n      ],\n      temperature: 0.3,  // Low temperature for consistent recommendations\n      max_tokens: 4000  // Increased to prevent JSON truncation\n    };\n\n    const response = UrlFetchApp.fetch(url, {\n      method: 'post',\n      headers: {\n        'Authorization': 'Bearer ' + apiKey,\n        'Content-Type': 'application/json'\n      },\n      payload: JSON.stringify(payload),\n      muteHttpExceptions: true\n    });\n\n    const responseCode = response.getResponseCode();\n    if (responseCode !== 200) {\n      Logger.log('‚ö†Ô∏è OpenAI API error: ' + responseCode + ' - using static recommendations');\n      return getStaticRecommendedFields_();\n    }\n\n    const data = JSON.parse(response.getContentText());\n    const aiResponse = data.choices[0].message.content.trim();\n\n    // Extract JSON array from response\n    const jsonMatch = aiResponse.match(/\\[[\\\"\\w\\s,]+\\]/);\n    if (!jsonMatch) {\n      Logger.log('‚ö†Ô∏è Could not parse AI response - using static recommendations');\n      return getStaticRecommendedFields_();\n    }\n\n    const recommendedFields = JSON.parse(jsonMatch[0]);\n\n    // Extra safety: Filter out any selected fields AI might have included\n    const filteredRecommendations = recommendedFields.filter(function(field) {\n      return currentlySelected.indexOf(field) === -1;\n    });\n\n    Logger.log('‚úÖ AI recommended ' + filteredRecommendations.length + ' fields from unselected pool');\n    Logger.log('   Fields: ' + filteredRecommendations.join(', '));\n\n    return filteredRecommendations;\n  } catch (e) {\n    Logger.log('‚ö†Ô∏è Error getting AI recommendations: ' + e.message);\n    return getStaticRecommendedFields_();\n  }\n}\n\n/**\n * Static fallback recommendations (used when API unavailable)\n */\nfunction getRecommendedFields(availableFields, selectedFields) {\n  // Try to get AI recommendations, fall back to static if API unavailable\n  try {\n    const apiKey = readApiKey_();\n    if (!apiKey) {\n      Logger.log('‚ö†Ô∏è No API key - using static recommendations');\n      return getStaticRecommendedFields_();\n    }\n\n    // availableFields passed as parameter\n    const currentlySelected = selectedFields; // Get saved or default fields\n\n    // Filter to only unselected fields\n    const unselectedFields = availableFields.filter(function(f) {\n      return currentlySelected.indexOf(f.name) === -1;\n    });\n\n    const fieldDescriptions = unselectedFields.map(function(f) {\n      return {\n        name: f.name,\n        header: f.header,\n        category: f.tier1\n      };\n    });\n\n    const prompt = 'You are a medical education expert analyzing which data fields would be most valuable for AI pathway discovery in emergency medicine simulation cases.\\n\\n' +\n      'CURRENTLY SELECTED FIELDS (already chosen, DO NOT recommend these):\\n' +\n      JSON.stringify(currentlySelected, null, 2) + '\\n\\n' +\n      'AVAILABLE UNSELECTED FIELDS (choose from these ONLY):\\n' +\n      JSON.stringify(fieldDescriptions, null, 2) + '\\n\\n' +\n      'PATHWAY DISCOVERY GOALS:\\n' +\n      '- Clinical reasoning pathways (differential diagnosis, pattern recognition)\\n' +\n      '- Risk stratification pathways (high-risk ‚Üí low-risk)\\n' +\n      '- Time-critical decision pathways (STEMI, stroke, sepsis)\\n' +\n      '- Cognitive bias awareness pathways (anchoring, premature closure)\\n' +\n      '- Skill progression pathways (novice ‚Üí expert)\\n' +\n      '- Patient complexity pathways (single-system ‚Üí multi-system)\\n\\n' +\n      'TASK: From the UNSELECTED fields only, select 8-12 that would maximize pathway discovery potential.\\n\\n' +\n      'PRIORITIZE fields that:\\n' +\n      '- Enable differential diagnosis logic\\n' +\n      '- Support risk stratification\\n' +\n      '- Reveal clinical reasoning patterns\\n' +\n      '- Identify time-critical cases\\n' +\n      '- Show patient complexity\\n\\n' +\n      'IMPORTANT: Only recommend from UNSELECTED fields. Do NOT include any currently selected fields.\\n\\n' +\n      'Return ONLY a JSON array of field names: [\"fieldName1\", \"fieldName2\", ...]';\n\n    const url = 'https://api.openai.com/v1/chat/completions';\n    const payload = {\n      model: 'gpt-4o-mini',  // Fast and cheap for recommendations\n      messages: [\n        {\n          role: 'system',\n          content: 'You are an expert in medical education and clinical reasoning. Respond ONLY with valid JSON. NEVER recommend fields that are already selected.'\n        },\n        {\n          role: 'user',\n          content: prompt\n        }\n      ],\n      temperature: 0.3,  // Low temperature for consistent recommendations\n      max_tokens: 500\n    };\n\n    const response = UrlFetchApp.fetch(url, {\n      method: 'post',\n      headers: {\n        'Authorization': 'Bearer ' + apiKey,\n        'Content-Type': 'application/json'\n      },\n      payload: JSON.stringify(payload),\n      muteHttpExceptions: true\n    });\n\n    const responseCode = response.getResponseCode();\n    if (responseCode !== 200) {\n      Logger.log('‚ö†Ô∏è OpenAI API error: ' + responseCode + ' - using static recommendations');\n      return getStaticRecommendedFields_();\n    }\n\n    const data = JSON.parse(response.getContentText());\n    const aiResponse = data.choices[0].message.content.trim();\n\n    // Extract JSON array from response\n    const jsonMatch = aiResponse.match(/\\[[\\\"\\w\\s,]+\\]/);\n    if (!jsonMatch) {\n      Logger.log('‚ö†Ô∏è Could not parse AI response - using static recommendations');\n      return getStaticRecommendedFields_();\n    }\n\n    const recommendedFields = JSON.parse(jsonMatch[0]);\n\n    // Extra safety: Filter out any selected fields AI might have included\n    const filteredRecommendations = recommendedFields.filter(function(field) {\n      return currentlySelected.indexOf(field) === -1;\n    });\n\n    Logger.log('‚úÖ AI recommended ' + filteredRecommendations.length + ' fields from unselected pool');\n    Logger.log('   Fields: ' + filteredRecommendations.join(', '));\n\n    return filteredRecommendations;\n  } catch (e) {\n    Logger.log('‚ö†Ô∏è Error getting AI recommendations: ' + e.message);\n    return getStaticRecommendedFields_();\n  }\n}\n\n/**\n * Static fallback recommendations (used when API unavailable)\n */\nfunction getRecommendedFields(availableFields, selectedFields) {\n  try {\n    const apiKey = readApiKey_();\n    if (!apiKey) {\n      Logger.log('‚ö†Ô∏è No API key - using static recommendations');\n      return getStaticRecommendedFields_();\n    }\n\n    const currentlySelected = selectedFields;\n\n    // Build list of ALL valid field names from availableFields\n    const allValidFieldNames = availableFields.map(function(f) {\n      return typeof f === 'string' ? f : f.name;\n    });\n\n    // Filter to only unselected fields\n    const unselectedFields = availableFields.filter(function(f) {\n      const fieldName = typeof f === 'string' ? f : f.name;\n      return currentlySelected.indexOf(fieldName) === -1;\n    });\n\n    // Extract tier1/tier2 for AI context\n    const fieldDescriptions = unselectedFields.map(function(f) {\n      const fieldName = typeof f === 'string' ? f : f.name;\n      const parts = fieldName.split('_');\n      const tier2 = parts[parts.length - 1];\n      const tier1 = parts.slice(0, -1).join('_');\n\n      return {\n        name: fieldName,\n        tier1: tier1,\n        tier2: tier2\n      };\n    });\n\n    const prompt = 'You are a medical education expert analyzing which data fields would be most valuable for AI pathway discovery in emergency medicine simulation cases.\\n\\n' +\n      'CURRENTLY SELECTED FIELDS (already chosen, DO NOT recommend these):\\n' +\n      JSON.stringify(currentlySelected, null, 2) + '\\n\\n' +\n      'AVAILABLE UNSELECTED FIELDS (choose from these ONLY):\\n' +\n      JSON.stringify(fieldDescriptions, null, 2) + '\\n\\n' +\n      'PATHWAY DISCOVERY GOALS:\\n' +\n      '- Clinical reasoning pathways (differential diagnosis, pattern recognition)\\n' +\n      '- Risk stratification pathways (high-risk ‚Üí low-risk)\\n' +\n      '- Time-critical decision pathways (STEMI, stroke, sepsis)\\n' +\n      '- Cognitive bias awareness pathways (anchoring, premature closure)\\n' +\n      '- Skill progression pathways (novice ‚Üí expert)\\n' +\n      '- Patient complexity pathways (single-system ‚Üí multi-system)\\n\\n' +\n      'TASK: From the UNSELECTED fields only, select 8-12 that would maximize pathway discovery potential.\\n\\n' +\n      'PRIORITIZE fields that:\\n' +\n      '- Enable differential diagnosis logic\\n' +\n      '- Support risk stratification\\n' +\n      '- Reveal clinical reasoning patterns\\n' +\n      '- Identify time-critical cases\\n' +\n      '- Show patient complexity\\n\\n' +\n      'IMPORTANT: Return field names EXACTLY as shown in the \"name\" property. Do NOT modify them.\\n' +\n      'Only recommend from UNSELECTED fields. Do NOT include any currently selected fields.\\n\\n' +\n      'Return ONLY a JSON array of exact field names from the list above: [\"exact_name_1\", \"exact_name_2\", ...]';\n\n    const url = 'https://api.openai.com/v1/chat/completions';\n    const payload = {\n      model: 'gpt-4o-mini',\n      messages: [\n        {\n          role: 'system',\n          content: 'You are an expert in medical education and clinical reasoning. Respond ONLY with valid JSON array of exact field names. NEVER modify field names or recommend already selected fields.'\n        },\n        {\n          role: 'user',\n          content: prompt\n        }\n      ],\n      temperature: 0.3,\n      max_tokens: 500\n    };\n\n    const response = UrlFetchApp.fetch(url, {\n      method: 'post',\n      headers: {\n        'Authorization': 'Bearer ' + apiKey,\n        'Content-Type': 'application/json'\n      },\n      payload: JSON.stringify(payload),\n      muteHttpExceptions: true\n    });\n\n    const responseCode = response.getResponseCode();\n    if (responseCode !== 200) {\n      Logger.log('‚ö†Ô∏è OpenAI API error: ' + responseCode + ' - using static recommendations');\n      return getStaticRecommendedFields_();\n    }\n\n    const data = JSON.parse(response.getContentText());\n    const aiResponse = data.choices[0].message.content.trim();\n\n    // ROBUST PARSING: Try multiple methods\n    let recommendedFields = [];\n    \n    // Method 1: Try direct JSON parse\n    try {\n      recommendedFields = JSON.parse(aiResponse);\n    } catch (e1) {\n      // Method 2: Extract JSON array with flexible regex\n      try {\n        const jsonMatch = aiResponse.match(/\\[([\\s\\S]*?)\\]/);\n        if (jsonMatch) {\n          recommendedFields = JSON.parse(jsonMatch[0]);\n        }\n      } catch (e2) {\n        Logger.log('‚ö†Ô∏è Could not parse AI response - using static recommendations');\n        Logger.log('   AI response: ' + aiResponse.substring(0, 200));\n        return getStaticRecommendedFields_();\n      }\n    }\n\n    if (!Array.isArray(recommendedFields)) {\n      Logger.log('‚ö†Ô∏è AI response not an array - using static recommendations');\n      return getStaticRecommendedFields_();\n    }\n\n    // REDUNDANCY: Force exact format match\n    // For each AI recommendation, find exact match in our valid field list\n    const validatedRecommendations = [];\n    \n    recommendedFields.forEach(function(aiField) {\n      // Normalize: trim whitespace, handle various formats\n      const normalized = String(aiField).trim();\n      \n      // Find exact match in our valid field names\n      const exactMatch = allValidFieldNames.find(function(validName) {\n        return validName === normalized;\n      });\n      \n      if (exactMatch) {\n        // Only add if not already selected AND not duplicate in recommendations\n        if (currentlySelected.indexOf(exactMatch) === -1 && validatedRecommendations.indexOf(exactMatch) === -1) {\n          validatedRecommendations.push(exactMatch);\n        }\n      } else {\n        // Log mismatches for debugging\n        Logger.log('‚ö†Ô∏è AI returned unrecognized field: \"' + normalized + '\" - skipping');\n      }\n    });\n\n    if (validatedRecommendations.length === 0) {\n      Logger.log('‚ö†Ô∏è No valid AI recommendations after filtering - using static fallback');\n      return getStaticRecommendedFields_();\n    }\n\n    Logger.log('‚úÖ AI recommended ' + validatedRecommendations.length + ' valid fields');\n    Logger.log('   Fields: ' + validatedRecommendations.join(', '));\n\n    return validatedRecommendations;\n    \n  } catch (e) {\n    Logger.log('‚ö†Ô∏è Error getting AI recommendations: ' + e.message);\n    return getStaticRecommendedFields_();\n  }\n}\n\n/**\n * Static fallback recommendations (used when API unavailable)\n */\n\n\n/**\n * Save field selection and start cache\n * Called from field selector modal when user clicks Continue\n */\nfunction saveFieldSelectionAndStartCache(selectedFields) {\n  const docProps = PropertiesService.getDocumentProperties();\n  docProps.setProperty('SELECTED_CACHE_FIELDS', JSON.stringify(selectedFields));\n\n  Logger.log('‚úÖ Saved field selection: ' + selectedFields.length + ' fields');\n  Logger.log('Fields: ' + selectedFields.join(', '));\n\n  // Start the cache process with selected fields\n  preCacheRichDataAfterSelection();\n}\n\n// END DYNAMIC FIELD SELECTOR SYSTEM\n// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n\n/**\n * Pre-Cache Rich Data - Entry Point\n * Shows field selector modal FIRST, then starts cache with selected fields\n */\nfunction preCacheRichData() {\n  try {\n    Logger.log('üöÄ preCacheRichData() called - starting field selector');\n    showFieldSelector();\n  } catch (error) {\n    Logger.log('‚ùå preCacheRichData ERROR: ' + error.toString());\n    SpreadsheetApp.getUi().alert('Field Selector Error: ' + error.message + '\\n\\nCheck Execution Log for details.');\n  }\n}\n\n/**\n * TEST: Simple field selector to verify flow works\n */\nfunction testSimpleFieldSelector() {\n  try {\n    Logger.log('üéØ TEST: Simple field selector started');\n\n    const html =\n      '<!DOCTYPE html>' +\n      '<html>' +\n      '<head><style>' +\n      'body { font-family: Arial; padding: 20px; }' +\n      'h2 { color: #667eea; }' +\n      '</style></head>' +\n      '<body>' +\n      '<h2>üéØ Field Selector Test</h2>' +\n      '<p>If you can see this modal, the flow is working!</p>' +\n      '<p>Now we need to debug why the real field selector fails.</p>' +\n      '<button onclick=\"google.script.host.close()\">Close</button>' +\n      '<div id=\"log\" style=\"' +\n      'position: fixed;' +\n      'bottom: 0;' +\n      'left: 0;' +\n      'right: 0;' +\n      'background: #1e1e1e;' +\n      'color: #00ff00;' +\n      'padding: 15px;' +\n      'max-height: 200px;' +\n      'overflow-y: auto;' +\n      'border-top: 3px solid #00ff00;' +\n      'font-family: \\\"Courier New\\\", monospace;' +\n      'font-size: 12px;' +\n      'white-space: pre-wrap;' +\n      'z-index: 9999;' +\n      '\"></div>' +\n      '</body>' +\n      '</html>';\n\n    const htmlOutput = HtmlService.createHtmlOutput(html)\n      .setWidth(600)\n      .setHeight(400);\n\n    SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'Test Modal');\n    Logger.log('‚úÖ TEST: Modal displayed successfully');\n\n  } catch (error) {\n    Logger.log('‚ùå TEST ERROR: ' + error.toString());\n    SpreadsheetApp.getUi().alert('Test Error: ' + error.message);\n  }\n}\n\n\nfunction preCacheRichDataAfterSelection() {\n  const html =\n    '<!DOCTYPE html>' +\n    '<html>' +\n    '<head>' +\n    '<style>' +\n    'body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #00ff00; }' +\n    'button { padding: 10px 20px; margin: 10px; font-size: 16px; cursor: pointer; }' +\n    '#status { margin: 20px 0; padding: 10px; background: #000; border: 1px solid #00ff00; }' +\n    '</style>' +\n    '</head>' +\n    '<body>' +\n    '<h3>üß™ Test Modal</h3>' +\n    '<div id=\"status\">Ready to test...</div>' +\n    '<button onclick=\"testHello()\">Test Hello</button>' +\n    '<button onclick=\"startCache()\">Start Cache</button>' +\n    '<script>' +\n    'function testHello() {' +\n    '  document.getElementById(\"status\").textContent = \"Calling testHello()...\";' +\n    '  google.script.run' +\n    '    .withSuccessHandler(function(r) {' +\n    '      document.getElementById(\"status\").textContent = \"SUCCESS: \" + r.message + \" at \" + r.timestamp;' +\n    '    })' +\n    '    .withFailureHandler(function(e) {' +\n    '      document.getElementById(\"status\").textContent = \"FAILED: \" + e.message;' +\n    '    })' +\n    '    .testHello();' +\n    '}' +\n    'function startCache() {' +\n    '  document.getElementById(\"status\").textContent = \"Starting cache...\";' +\n    '  google.script.run' +\n    '    .withSuccessHandler(function(r) {' +\n    '      if (r.success) {' +\n    '        document.getElementById(\"status\").textContent = \"CACHE SUCCESS: \" + r.casesProcessed + \" cases ‚úì | \" + r.fieldsPerCase + \" fields cached ‚úì | \" + r.elapsed + \"s\";' +\n    '      } else {' +\n    '        document.getElementById(\"status\").textContent = \"CACHE FAILED: \" + r.error;' +\n    '      }' +\n    '    })' +\n    '    .withFailureHandler(function(e) {' +\n    '      document.getElementById(\"status\").textContent = \"CACHE FAILED: \" + e.message;' +\n    '    })' +\n    '    .performCacheWithProgress();' +\n    '}' +\n    '</script>' +\n    '</body>' +\n    '</html>';\n\n  const htmlOutput = HtmlService.createHtmlOutput(html)\n    .setWidth(400)\n    .setHeight(200);\n  SpreadsheetApp.getUi().showModelessDialog(htmlOutput, 'üß™ Simple Cache Test');\n}\n\n/**\n * Backend function to perform caching with progress updates\n */\nfunction performCacheWithProgress() {\n  try {\n    Logger.log('üöÄ STEP 1: Starting cache process...');\n    const startTime = new Date().getTime();\n\n    Logger.log('üîÑ STEP 2: Calling refreshHeaders() to map column indices...');\n    refreshHeaders(); // Explicitly call to ensure headers are cached\n    Logger.log('‚úÖ STEP 2 COMPLETE: Headers refreshed');\n\n    Logger.log('üîÑ STEP 3: Starting holistic analysis (getOrCreateHolisticAnalysis_)...');\n    // Force fresh analysis (forceRefresh = true)\n    const analysis = getOrCreateHolisticAnalysis_(true);\n    Logger.log('‚úÖ STEP 3 COMPLETE: Analysis finished');\n\n    const elapsed = ((new Date().getTime() - startTime) / 1000).toFixed(1);\n    const casesProcessed = analysis.totalCases || 0;\n\n    Logger.log('‚úÖ Analysis complete in ' + elapsed + 's - ' + casesProcessed + ' cases processed');\n\n    return {\n      success: true,\n      casesProcessed: casesProcessed,\n      elapsed: elapsed,\n      fieldsPerCase: loadFieldSelection().length\n    };\n  } catch (e) {\n    Logger.log('‚ùå Error in performCacheWithProgress: ' + e.message);\n    return {\n      success: false,\n      error: e.message\n    };\n  }\n}\n\n/**\n * SIMPLE TEST: Returns immediately to test if google.script.run works\n */\n/**\n * ULTRA SIMPLE TEST: Returns immediately with timestamp\n */\nfunction testHello() {\n  Logger.log('üëã testHello() called');\n  return {\n    success: true,\n    message: 'Hello from backend!',\n    timestamp: new Date().toISOString()\n  };\n}\n\nfunction testCacheSimple() {\n  Logger.log('üß™ testCacheSimple() called');\n\n  try {\n    const sheet = pickMasterSheet_();\n    const data = sheet.getDataRange().getValues();\n\n    Logger.log('‚úÖ Got data: ' + data.length + ' rows');\n\n    return {\n      success: true,\n      message: 'Communication works!',\n      rowCount: data.length,\n      sheetName: sheet.getName()\n    };\n  } catch (e) {\n    Logger.log('‚ùå Error: ' + e.message);\n    return {\n      success: false,\n      error: e.message\n    };\n  }\n}\n\n\n/**\n * Get cache status for UI indicator\n * Returns: { status: 'valid'|'stale'|'missing', hoursOld, expiresIn, cases }\n */\nfunction getCacheStatus() {\n  try {\n    const ss = SpreadsheetApp.openById(TEST_SPREADSHEET_ID);\n    const cacheSheet = ss.getSheetByName('Pathway_Analysis_Cache');\n\n    if (!cacheSheet) {\n      return {\n        status: 'missing',\n        message: 'Not cached',\n        icon: '‚ùå'\n      };\n    }\n\n    const data = cacheSheet.getDataRange().getValues();\n    if (data.length < 2) {\n      return {\n        status: 'missing',\n        message: 'Cache empty',\n        icon: '‚ö†Ô∏è'\n      };\n    }\n\n    const cachedTimestamp = new Date(data[1][0]);\n    const now = new Date();\n    const hoursDiff = (now - cachedTimestamp) / (1000 * 60 * 60);\n    const hoursRemaining = 24 - hoursDiff;\n\n    // Parse JSON to get case count\n    let caseCount = 0;\n    try {\n      const parsed = JSON.parse(data[1][1]);\n      caseCount = parsed.allCases ? parsed.allCases.length : 0;\n    } catch (e) {\n      // Ignore parse errors\n    }\n\n    if (hoursDiff < 24) {\n      return {\n        status: 'valid',\n        hoursOld: hoursDiff.toFixed(1),\n        expiresIn: hoursRemaining.toFixed(1),\n        cases: caseCount,\n        message: 'Cached ' + hoursDiff.toFixed(0) + 'h ago',\n        icon: '‚úÖ'\n      };\n    } else {\n      return {\n        status: 'stale',\n        hoursOld: hoursDiff.toFixed(1),\n        cases: caseCount,\n        message: 'Cache expired',\n        icon: '‚ö†Ô∏è'\n      };\n    }\n  } catch (e) {\n    return {\n      status: 'error',\n      message: 'Error checking cache',\n      icon: '‚ùå'\n    };\n  }\n}\n\n/**\n * Show live log window that polls for updates\n */\nfunction showAIDiscoveryWithStreamingLogs_(creativityMode) {\n  AI_DISCOVERY_LOGS = []; // Reset\n\n  const modeLabel = creativityMode === 'radical' ? 'üî• RADICAL MODE' : 'ü§ñ STANDARD MODE';\n\n  const html = '<style>' +\n    'body{font-family:monospace;background:#0a0b0e;color:#0f0;padding:20px;margin:0}' +\n    '.header{color:#0ff;font-size:18px;font-weight:bold;margin-bottom:20px;border-bottom:2px solid #0ff;padding-bottom:10px}' +\n    '.log-container{background:#000;border:1px solid #0f0;padding:15px;border-radius:8px;max-height:500px;overflow-y:auto;font-size:13px;line-height:1.6}' +\n    '.log-line{margin:5px 0;padding:5px;border-left:3px solid #0f0}' +\n    '.log-line.info{border-left-color:#0ff;color:#0ff}' +\n    '.log-line.success{border-left-color:#0f0;color:#0f0}' +\n    '.log-line.warning{border-left-color:#ff0;color:#ff0}' +\n    '.log-line.error{border-left-color:#f00;color:#f00}' +\n    '.timestamp{color:#666;margin-right:10px;font-size:11px}' +\n    '.status{margin-top:15px;padding:10px;background:#1a1a1a;border-radius:6px;text-align:center;color:#0ff}' +\n    '</style>' +\n    '<div class=\"header\">ü§ñ AI PATHWAY DISCOVERY - LIVE LOGS (' + modeLabel + ')</div>' +\n    '<div class=\"status\" id=\"status\">‚ñ∂Ô∏è Starting discovery...</div>' +\n    '<div class=\"log-container\" id=\"logs\"></div>' +\n    '<script>' +\n    'var mode = \"' + creativityMode + '\";' +\n    'var logIndex = 0;' +\n    'var pollInterval = null;' +\n    'var startTime = Date.now();' +\n    'function addLog(message, type) {' +\n    '  var logs = document.getElementById(\"logs\");' +\n    '  var elapsed = Math.floor((Date.now() - startTime) / 1000);' +\n    '  var mins = Math.floor(elapsed / 60);' +\n    '  var secs = elapsed % 60;' +\n    '  var timestamp = mins.toString().padStart(2, \"0\") + \":\" + secs.toString().padStart(2, \"0\");' +\n    '  var line = document.createElement(\"div\");' +\n    '  line.className = \"log-line \" + type;' +\n    '  line.innerHTML = \"<span class=\\\\\"timestamp\\\\\">[\" + timestamp + \"]</span>\" + message;' +\n    '  logs.appendChild(line);' +\n    '  logs.scrollTop = logs.scrollHeight;' +\n    '}' +\n    'function updateStatus(text) {' +\n    '  document.getElementById(\"status\").textContent = text;' +\n    '}' +\n    'function pollLogs() {' +\n    '  google.script.run' +\n    '    .withSuccessHandler(function(result) {' +\n    '      if (result.logs && result.logs.length > logIndex) {' +\n    '        for (var i = logIndex; i < result.logs.length; i++) {' +\n    '          addLog(result.logs[i].message, result.logs[i].type);' +\n    '        }' +\n    '        logIndex = result.logs.length;' +\n    '      }' +\n    '      if (result.status) {' +\n    '        updateStatus(result.status);' +\n    '      }' +\n    '      if (result.complete) {' +\n    '        clearInterval(pollInterval);' +\n    '        updateStatus(\"‚úÖ Complete! Showing results...\");' +\n    '        if (result.pathways && result.pathways.length > 0) {' +\n    '          setTimeout(function() {' +\n    '            google.script.host.close();' +\n    '            google.script.run.showAIPathwayResults(result.pathways, mode);' +\n    '          }, 2000);' +\n    '        }' +\n    '      }' +\n    '    })' +\n    '    .withFailureHandler(function(error) {' +\n    '      addLog(\"‚ùå ERROR: \" + error.message, \"error\");' +\n    '      clearInterval(pollInterval);' +\n    '      updateStatus(\"‚ùå Failed\");' +\n    '    })' +\n    '    .getAIDiscoveryStatus();' +\n    '}' +\n    'addLog(\"üöÄ Initializing AI discovery in \" + mode + \" mode...\", \"info\");' +\n    'updateStatus(\"‚è≥ Calling OpenAI API...\");' +\n    'pollInterval = setInterval(pollLogs, 300);' +\n    'google.script.run' +\n    '  .withSuccessHandler(function() { addLog(\"‚úÖ Discovery started\", \"success\"); })' +\n    '  .withFailureHandler(function(error) { addLog(\"‚ùå Start failed: \" + error.message, \"error\"); })' +\n    '  .startAIDiscovery(mode);' +\n    '</script>';\n\n  const htmlOutput = HtmlService.createHtmlOutput(html).setWidth(900).setHeight(600);\n  SpreadsheetApp.getUi().showModalDialog(htmlOutput, 'AI Pathway Discovery - Live Progress');\n}\n\n/**\n * Start AI discovery (called from client)\n */\nfunction startAIDiscovery(creativityMode) {\n  AI_DISCOVERY_LOGS = [];\n  AI_DISCOVERY_LOGS.push({ message: 'üîß Server-side execution started', type: 'info', timestamp: new Date().toISOString() });\n\n  // Run discovery synchronously\n  discoverPathwaysSync_(creativityMode);\n}\n\n/**\n * Get current status (called by polling)\n */\nfunction getAIDiscoveryStatus() {\n  return {\n    logs: AI_DISCOVERY_LOGS,\n    status: AI_DISCOVERY_LOGS.length > 0 ? AI_DISCOVERY_LOGS[AI_DISCOVERY_LOGS.length - 1].message : 'Starting...',\n    complete: AI_DISCOVERY_LOGS.some(function(log) { return log.message.indexOf('üéâ COMPLETE') !== -1; }),\n    pathways: PropertiesService.getScriptProperties().getProperty('AI_PATHWAYS') ? JSON.parse(PropertiesService.getScriptProperties().getProperty('AI_PATHWAYS')) : []\n  };\n}\n\n/**\n * Analyze case catalog - SMART CACHING VERSION\n *\n * Three-tier strategy for maximum reliability + rich data:\n * 1. CACHE HIT (instant): Use cached holistic analysis if < 24 hours old\n * 2. FRESH ANALYSIS (slow but rich): Try performHolisticAnalysis_() with 4min timeout\n * 3. LIGHTWEIGHT FALLBACK (fast but basic): Direct sheet read if timeout\n *\n * This preserves all rich clinical context (demographics, vitals, exam findings, etc.)\n */\nfunction analyzeCatalog_() {\n  const ss = SpreadsheetApp.openById(TEST_SPREADSHEET_ID);\n\n    let cacheSheet = ss.getSheetByName('Pathway_Analysis_Cache');\n\n  if (cacheSheet) {\n    const data = cacheSheet.getDataRange().getValues();\n    if (data.length > 1) {\n      const cachedTimestamp = new Date(data[1][0]);\n      const now = new Date();\n      const hoursDiff = (now - cachedTimestamp) / (1000 * 60 * 60);\n\n      if (hoursDiff < 24) {\n        // Cache hit! Return full rich data instantly\n        Logger.log('‚úÖ Using cached holistic analysis (' + hoursDiff.toFixed(1) + ' hours old)');\n        return JSON.parse(data[1][1]);\n      }\n    }\n  }\n\n    Logger.log('üìä Cache miss or stale - attempting fresh holistic analysis');\n  const startTime = new Date().getTime();\n  const MAX_TIME = 4 * 60 * 1000; // 4 minutes (leave 2min buffer for 6min timeout)\n\n  try {\n    const analysis = performHolisticAnalysis_();\n    const elapsed = new Date().getTime() - startTime;\n\n    Logger.log('‚úÖ Fresh analysis completed in ' + (elapsed / 1000).toFixed(1) + 's');\n\n    if (elapsed < MAX_TIME) {\n      return analysis; // Success! Got all the rich data + auto-cached for next time\n    } else {\n      Logger.log('‚ö†Ô∏è  Analysis took too long, falling back to lightweight mode');\n    }\n  } catch (e) {\n    Logger.log('‚ö†Ô∏è  Error in performHolisticAnalysis_(): ' + e.message);\n  }\n\n    Logger.log('üìâ Using lightweight analysis fallback');\n  const sheet = ss.getSheets().find(function(sh) {\n    return /master scenario csv/i.test(sh.getName());\n  }) || ss.getActiveSheet();\n\n  const data = sheet.getDataRange().getValues();\n  const headers = data[1];\n\n  // Use dynamic header resolution for lightweight fallback\n  const fieldMap = {\n    caseId: { header: 'Case_Organization_Case_ID', fallback: 0 },\n    spark: { header: 'Case_Organization_Spark_Title', fallback: 1 },\n    diagnosis: { header: 'Case_Orientation_Chief_Diagnosis', fallback: 7 },\n    learning: { header: 'Case_Orientation_Actual_Learning_Outcomes', fallback: 8 },\n    category: { header: 'Case_Organization_Category', fallback: 11 },\n    pathway: { header: 'Case_Organization_Pathway_or_Course_Name', fallback: 5 }\n  };\n\n  const indices = resolveColumnIndices_(fieldMap);\n  const caseIdIdx = indices.caseId;\n  const sparkIdx = indices.spark;\n  const diagnosisIdx = indices.diagnosis;\n  const learningIdx = indices.learning;\n  const categoryIdx = indices.category;\n  const pathwayIdx = indices.pathway;\n\n  const allCases = [];\n  for (let i = 2; i < data.length; i++) {\n    allCases.push({\n      caseId: data[i][caseIdIdx] || '',\n      sparkTitle: data[i][sparkIdx] || '',\n      diagnosis: data[i][diagnosisIdx] || '',\n      learningOutcomes: data[i][learningIdx] || '',\n      category: data[i][categoryIdx] || '',\n      pathway: data[i][pathwayIdx] || ''\n    });\n  }\n\n  return { allCases: allCases };\n}\n\n/**\n * Helper: Extract vital value from vitals JSON string\n */\nfunction extractVital_(vitalsStr, field) {\n  if (!vitalsStr) return '';\n  try {\n    const vitals = typeof vitalsStr === 'string' ? JSON.parse(vitalsStr) : vitalsStr;\n    if (field === 'bp' && vitals.bp) {\n      return vitals.bp.sys + '/' + vitals.bp.dia;\n    }\n    return vitals[field] || '';\n  } catch (e) {\n    return '';\n  }\n}\n\n/**\n * Synchronous discovery with logging\n */\nfunction discoverPathwaysSync_(creativityMode) {\n  function log(msg, type) {\n    AI_DISCOVERY_LOGS.push({ message: msg, type: type || 'info', timestamp: new Date().toISOString() });\n  }\n\n  try {\n    log('Step 1/6: Getting API key', 'info');\n    const ss = SpreadsheetApp.openById(TEST_SPREADSHEET_ID);\n    const settingsSheet = ss.getSheetByName('Settings');\n\n    if (!settingsSheet) {\n      log('‚ùå Settings sheet not found', 'error');\n      return;\n    }\n\n    const apiKey = settingsSheet.getRange('B2').getValue();\n    if (!apiKey) {\n      log('‚ùå No API key in Settings!B2', 'error');\n      return;\n    }\n\n    log('‚úÖ API key found', 'success');\n\n    log('Step 1.5/6: Refreshing header mappings', 'info');\n    try {\n      refreshHeaders();\n      log('‚úÖ Headers refreshed', 'success');\n    } catch (e) {\n      log('‚ö†Ô∏è  Could not refresh headers: ' + e.message, 'warning');\n    }\n\n    log('Step 2/6: Analyzing case catalog', 'info');\n    const analysis = analyzeCatalog_();\n    const cases = analysis.allCases;\n    log('‚úÖ Found ' + cases.length + ' cases', 'success');\n\n    log('Step 3/6: Building rich case summaries with clinical context', 'info');\n    // Send ALL cases with maximum context for AI pattern discovery\n    const summaries = cases.map(function(c) {\n      return {\n        // Core identification\n        id: c.caseId,\n        title: c.sparkTitle || '',\n        diagnosis: c.diagnosis || '',\n\n        // Learning context\n        preSim: (c.preSimOverview || '').substring(0, 300),\n        postSim: (c.postSimOverview || '').substring(0, 300),\n        learning: c.learningOutcomes || '',\n        objectives: c.learningObjectives || '',\n\n        // Case metadata\n        category: c.category || '',\n        difficulty: c.difficulty || '',\n        duration: c.estimatedDuration || '',\n        setting: c.setting || '',\n        presentation: c.chiefComplaint || '',\n\n        // ENHANCED: Patient demographics (unlocks age/gender pathways)\n        age: c.age || c.patientAge || '',\n        gender: c.gender || c.patientGender || '',\n\n        // ENHANCED: Initial vitals (pattern recognition goldmine)\n        initialHR: extractVital_(c.initialVitals || c.Initial_Vitals, 'hr'),\n        initialBP: extractVital_(c.initialVitals || c.Initial_Vitals, 'bp'),\n        initialRR: extractVital_(c.initialVitals || c.Initial_Vitals, 'rr'),\n        initialSpO2: extractVital_(c.initialVitals || c.Initial_Vitals, 'spo2'),\n\n        // ENHANCED: Clinical findings (physical exam pathways)\n        examFindings: (c.examFindings || '').substring(0, 200),\n\n        // ENHANCED: Medical context (complexity pathways)\n        medications: (c.medications || c.pastMedications || '').substring(0, 150),\n        pmh: (c.pastMedicalHistory || c.pmh || '').substring(0, 200),\n        allergies: c.allergies || '',\n\n        // ENHANCED: Environment (situational training)\n        environment: c.environmentType || c.setting || '',\n        disposition: c.dispositionPlan || c.disposition || ''\n      };\n    });\n    log('‚úÖ Prepared ' + summaries.length + ' enhanced case summaries (demographics + vitals + clinical context)', 'success');\n\n    log('Step 4/6: Building prompt', 'info');\n    const temp = creativityMode === 'radical' ? 1.0 : 0.7;\n    const prompt = creativityMode === 'radical'\n      ? 'ANALYZE ALL ' + summaries.length + ' EMERGENCY MEDICINE CASES. TARGET AUDIENCE: Emergency physicians, EM residents, simulation educators. PRIORITY: Clinical value > novelty. Create 5-8 RADICALLY CREATIVE pathways that address REAL EM physician pain points. PRIORITIZE by clinical impact: (1) High-stakes/time-critical scenarios, (2) Diagnostic pitfalls/misses, (3) Disease mimics - TWO TYPES: (a) Cross-category mimics: similar symptoms but dramatically different pathophysiology (MI vs panic, meningitis vs migraine), (b) Within-category mimics: related diseases where subtle distinctions matter (STEMI vs Wellens, bacterial vs viral meningitis, DKA vs HHS), (4) Procedural mastery, (5) Complex decision-making, (6) Communication under pressure. Push boundaries with psychological, narrative, game-design approaches but ALWAYS tie to clinical outcomes. PATHWAY NAMES MUST BE IRRESISTIBLY CLICK-WORTHY: Make ED clinicians think \"I NEED this!\" Use emotionally resonant language (trigger curiosity, urgency, fear-of-missing-out), action-oriented promises (transformation, not just info), Netflix series vibes (make them want to binge). Examples: \"The 3am Nightmare Cases\", \"Death By Anchoring\", \"The Great Pretenders\", \"The Deadly Doppelgangers\", \"When Experts Get Fooled\". Avoid generic academic titles. SORT results by clinical_value_score (1-10). Return ONLY a JSON array with pathway_name (CLICK-WORTHY, emotionally compelling), pathway_icon, grouping_logic_type, why_this_matters (emphasize EM physician value + make them feel this is unmissable), learning_outcomes (EM-specific), best_for (EM audience), unique_value (clinical impact - why THIS pathway vs any other), case_ids (array of at least 3), novelty_score (8-10), clinical_value_score (1-10, rate clinical utility), estimated_learning_time, difficulty_curve, scientific_rationale. NO markdown, NO explanation.'\n      : 'ANALYZE ALL ' + summaries.length + ' EMERGENCY MEDICINE CASES. TARGET AUDIENCE: Emergency physicians, EM residents, simulation educators. PRIORITY: Clinical value > novelty. Create 5-8 CREATIVE pathways that solve REAL EM training needs. PRIORITIZE by clinical impact: (1) Can\\'t-miss diagnoses, (2) Time-sensitive interventions, (3) Disease mimics - TWO TYPES: (a) Cross-category mimics: similar symptoms, dramatically different diseases (MI vs dissection vs esophageal rupture, PE vs pneumonia vs pneumothorax), (b) Within-category mimics: closely related diseases where subtle distinctions are essential (STEMI vs Wellens vs Takotsubo, bacterial vs viral vs fungal meningitis, DKA vs HHS vs euglycemic DKA), (4) High-risk populations (peds/geriatrics), (5) Undifferentiated patients, (6) Cognitive errors/biases. Discover patterns in clinical reasoning, diagnostic challenges, or critical actions. PATHWAY NAMES MUST BE IRRESISTIBLY CLICK-WORTHY: Make ED clinicians think \"I NEED this!\" Use emotionally resonant language (trigger curiosity, urgency, professional pride), action-oriented promises (mastery, confidence), specific enough to visualize. Examples: \"The Great Pretenders\", \"The Deadly Doppelgangers\", \"When Similar Kills Different\", \"The Subtle Distinction Series\", \"Evil Twins: Life-or-Death Differences\". Avoid boring academic titles like \"Cardiovascular Pathology Module\". SORT results by clinical_value_score (1-10). Return ONLY a JSON array with pathway_name (CLICK-WORTHY, emotionally compelling), pathway_icon, grouping_logic_type, why_this_matters (emphasize EM physician value + make them feel this is unmissable), learning_outcomes (EM-specific), best_for (EM audience), unique_value (clinical impact - why THIS pathway vs any other), case_ids (array of at least 3), novelty_score (7+), clinical_value_score (1-10, rate clinical utility), estimated_learning_time, difficulty_curve. NO markdown, NO explanation.';\n\n    log('‚úÖ Prompt ready (' + temp + ' temp, ' + summaries.length + ' cases)', 'success');\n\n    log('Step 5/6: Calling OpenAI GPT-4', 'info');\n    log('‚è≥ Analyzing ' + summaries.length + ' cases - may take 15-45 seconds...', 'warning');\n\n    const start = new Date().getTime();\n    const response = UrlFetchApp.fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'post',\n      headers: {\n        'Authorization': 'Bearer ' + apiKey,\n        'Content-Type': 'application/json'\n      },\n      payload: JSON.stringify({\n        model: 'gpt-4',\n        messages: [\n          { role: 'system', content: creativityMode === 'radical' ? 'You are an experimental medical educator applying cognitive science and game design to create revolutionary learning pathways.' : 'You are an expert medical educator discovering novel patterns across medical cases to create innovative learning pathways.' },\n          { role: 'user', content: prompt + '\\n\\nCASES:\\n' + JSON.stringify(summaries) }\n        ],\n        temperature: temp,\n        max_tokens: 2500\n      }),\n      muteHttpExceptions: true\n    });\n\n    const elapsed = ((new Date().getTime() - start) / 1000).toFixed(1);\n    const code = response.getResponseCode();\n\n    log('‚úÖ OpenAI responded in ' + elapsed + 's', 'success');\n    log('üìä Status: ' + code, 'info');\n\n    if (code !== 200) {\n      log('‚ùå API error: ' + response.getContentText(), 'error');\n      return;\n    }\n\n    log('Step 6/6: Parsing response', 'info');\n    const data = JSON.parse(response.getContentText());\n    const aiText = data.choices[0].message.content;\n\n    let pathways = [];\n    const match = aiText.match(/\\[[\\s\\S]*\\]/);\n    pathways = match ? JSON.parse(match[0]) : JSON.parse(aiText);\n\n    log('‚úÖ Parsed ' + pathways.length + ' pathways', 'success');\n\n    pathways.forEach(function(pw, i) {\n      log((i+1) + '. ' + (pw.pathway_icon || 'ü§ñ') + ' ' + (pw.pathway_name || 'Unnamed'), 'info');\n    });\n\n    log('üéâ COMPLETE! Discovery finished', 'success');\n\n    // Store pathways for retrieval\n    PropertiesService.getScriptProperties().setProperty('AI_PATHWAYS', JSON.stringify(pathways));\n    PropertiesService.getScriptProperties().setProperty('AI_MODE', creativityMode);\n\n  } catch (e) {\n    log('‚ùå EXCEPTION: ' + e.message, 'error');\n  }\n}\n\n/**\n * Show results (called after discovery completes)\n */\nfunction showAIPathwayResults(pathways, creativityMode) {\n  const modeLabel = creativityMode === 'radical' ? 'üî• RADICAL' : 'ü§ñ CREATIVE';\n\n  let html = '<style>body{font-family:Arial;background:#0a0b0e;color:#fff;padding:24px}.pathway{background:#1a1f2e;padding:20px;margin:15px 0;border-radius:12px;border-left:4px solid ' + (creativityMode === 'radical' ? '#ff6b00' : '#2357ff') + '}.name{font-size:20px;font-weight:bold;margin-bottom:10px}.pitch{color:#ccc;line-height:1.6}</style>';\n\n  html += '<h1>' + modeLabel + ' AI-Discovered Pathways</h1>';\n  html += '<p>Found ' + pathways.length + ' novel groupings</p>';\n\n  pathways.forEach(function(pw) {\n    html += '<div class=\"pathway\">';\n    html += '<div class=\"name\">' + (pw.pathway_icon || 'ü§ñ') + ' ' + (pw.pathway_name || 'Unnamed') + '</div>';\n    html += '<div class=\"pitch\">' + (pw.why_this_matters || 'No description') + '</div>';\n    html += '</div>';\n  });\n\n  const htmlOutput = HtmlService.createHtmlOutput(html).setWidth(800).setHeight(600);\n  SpreadsheetApp.getUi().showModalDialog(htmlOutput, modeLabel + ' Pathways');\n}\n\n\n/**\n * COMPREHENSIVE CACHE DIAGNOSTIC\n * Tests each step of the cache process with detailed logging\n */\nfunction testCacheDiagnostic() {\n  const startTime = new Date().getTime();\n  Logger.log('');\n  Logger.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');\n  Logger.log('‚ïë           üß™ CACHE DIAGNOSTIC TEST STARTED                   ‚ïë');\n  Logger.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');\n  Logger.log('');\n\n  try {\n    // STEP 1: Open TEST spreadsheet\n    Logger.log('üß™ STEP 1: Opening TEST spreadsheet by ID...');\n    const ss = SpreadsheetApp.openById('1t3qN8e537ghl38GTsXbVG8ML8OZtK2XyUpDiMQjnGAI');\n    Logger.log('‚úÖ STEP 1: Opened: ' + ss.getName());\n    Logger.log('   Spreadsheet ID: ' + ss.getId());\n    Logger.log('');\n\n    // STEP 2: Get active sheet\n    Logger.log('üß™ STEP 2: Getting active sheet...');\n    const sheet = ss.getActiveSheet();\n    Logger.log('‚úÖ STEP 2: Sheet name: ' + sheet.getName());\n    Logger.log('');\n\n    // STEP 3: Get data\n    Logger.log('üß™ STEP 3: Getting all data...');\n    const data = sheet.getDataRange().getValues();\n    Logger.log('‚úÖ STEP 3: Got ' + data.length + ' total rows');\n    Logger.log('   Data rows (excluding headers): ' + (data.length - 2));\n    Logger.log('');\n\n    // STEP 4: Check headers\n    Logger.log('üß™ STEP 4: Checking headers...');\n    if (data.length < 2) {\n      throw new Error('Sheet does not have enough rows for headers');\n    }\n    const headers = data[1];\n    Logger.log('‚úÖ STEP 4: Headers row has ' + headers.length + ' columns');\n    Logger.log('   First 10 headers: ' + headers.slice(0, 10).join(', '));\n    Logger.log('');\n\n    // STEP 5: Test refreshHeaders()\n    Logger.log('üß™ STEP 5: Testing refreshHeaders()...');\n    const headerResult = refreshHeaders();\n    if (!headerResult) {\n      throw new Error('refreshHeaders() returned null');\n    }\n    Logger.log('‚úÖ STEP 5: refreshHeaders() succeeded');\n    Logger.log('   Mapped columns: ' + Object.keys(headerResult.map).length);\n    Logger.log('');\n\n    // STEP 6: Test holistic analysis (this is the heavy operation)\n    Logger.log('üß™ STEP 6: Testing performHolisticAnalysis_()...');\n    Logger.log('   This processes ALL rows - may take time...');\n    const analysisStart = new Date().getTime();\n    const analysis = performHolisticAnalysis_();\n    const analysisTime = ((new Date().getTime() - analysisStart) / 1000).toFixed(1);\n    Logger.log('‚úÖ STEP 6: performHolisticAnalysis_() completed in ' + analysisTime + 's');\n    Logger.log('   Total cases: ' + analysis.totalCases);\n    Logger.log('   Systems found: ' + Object.keys(analysis.systemDistribution).length);\n    Logger.log('   Pathways found: ' + Object.keys(analysis.pathwayDistribution).length);\n    Logger.log('   Unassigned: ' + analysis.unassignedCount);\n    Logger.log('');\n\n    // STEP 7: Test cache sheet creation/update\n    Logger.log('üß™ STEP 7: Testing cache sheet access...');\n    let cacheSheet = ss.getSheetByName('Pathway_Analysis_Cache');\n    if (!cacheSheet) {\n      Logger.log('   Creating Pathway_Analysis_Cache sheet...');\n      cacheSheet = ss.insertSheet('Pathway_Analysis_Cache');\n      cacheSheet.hideSheet();\n      cacheSheet.appendRow(['timestamp', 'analysis_json']);\n    }\n    Logger.log('‚úÖ STEP 7: Cache sheet ready');\n    Logger.log('');\n\n    const totalTime = ((new Date().getTime() - startTime) / 1000).toFixed(1);\n\n    Logger.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');\n    Logger.log('‚ïë           ‚úÖ ALL DIAGNOSTICS PASSED                          ‚ïë');\n    Logger.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');\n    Logger.log('');\n    Logger.log('üìä SUMMARY:');\n    Logger.log('   ‚Ä¢ Total time: ' + totalTime + 's');\n    Logger.log('   ‚Ä¢ Analysis time: ' + analysisTime + 's');\n    Logger.log('   ‚Ä¢ Data rows: ' + (data.length - 2));\n    Logger.log('   ‚Ä¢ Cases processed: ' + analysis.totalCases);\n    Logger.log('');\n\n    SpreadsheetApp.getUi().alert(\n      '‚úÖ Cache Diagnostic PASSED!\\n\\n' +\n      'Total time: ' + totalTime + 's\\n' +\n      'Analysis time: ' + analysisTime + 's\\n' +\n      'Data rows: ' + (data.length - 2) + '\\n' +\n      'Cases processed: ' + analysis.totalCases + '\\n\\n' +\n      'Check Execution Log (Ctrl+Enter) for full details'\n    );\n\n    return {\n      success: true,\n      totalTime: totalTime,\n      analysisTime: analysisTime,\n      dataRows: data.length - 2,\n      casesProcessed: analysis.totalCases\n    };\n\n  } catch (e) {\n    Logger.log('');\n    Logger.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');\n    Logger.log('‚ïë           ‚ùå DIAGNOSTIC FAILED                               ‚ïë');\n    Logger.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù');\n    Logger.log('');\n    Logger.log('‚ùå Error: ' + e.message);\n    Logger.log('‚ùå Stack trace:');\n    Logger.log(e.stack);\n    Logger.log('');\n\n    SpreadsheetApp.getUi().alert(\n      '‚ùå Cache Diagnostic FAILED\\n\\n' +\n      'Error: ' + e.message + '\\n\\n' +\n      'Check Execution Log (Ctrl+Enter) for full stack trace'\n    );\n\n    return {\n      success: false,\n      error: e.message,\n      stack: e.stack\n    };\n  }\n}\n\n/**\n * Try to parse vitals JSON and extract hr, bp, rr, spo2\n * @param {string} vitalsJson - JSON string from Monitor_Vital_Signs_Initial_Vitals column\n * @return {object|null} - Parsed vitals object with hr, bpSys, bpDia, rr, spo2, or null if parse fails\n */\nfunction tryParseVitals_(vitalsJson) {\n  if (!vitalsJson || typeof vitalsJson !== 'string') return null;\n\n  try {\n    const vitals = JSON.parse(vitalsJson);\n    return {\n      hr: vitals.hr || null,\n      bpSys: vitals.bp && vitals.bp.sys ? vitals.bp.sys : null,\n      bpDia: vitals.bp && vitals.bp.dia ? vitals.bp.dia : null,\n      rr: vitals.rr || null,\n      spo2: vitals.spo2 || null\n    };\n  } catch (e) {\n    return null;\n  }\n}\n\n/**\n * Truncate field to max length to avoid cache bloat\n * @param {string} value - Field value to truncate\n * @param {number} maxLength - Maximum length before truncation\n * @return {string} - Truncated string with '...' appended if truncated\n */\nfunction truncateField_(value, maxLength) {\n  if (!value || typeof value !== 'string') return '';\n  if (value.length <= maxLength) return value;\n  return value.substring(0, maxLength) + '...';\n}\n\n// ==================== ADVANCED CACHE SYSTEM ====================\n// Pathway Chain Builder and 7-layer cache enrichment\n\n/**\n * Categories & Pathways - Phase 2: Interactive Pathway Chain Builder\n *\n * Holistic AI-powered pathway design system with:\n * - Bird's eye view of entire case library\n * - Pre-computed holistic analysis (cached)\n * - Horizontal chain builder UI\n * - Alternative selection with prominence system\n * - AI rationale generation\n * - Drag-and-drop reordering\n * - Pathway persistence\n *\n * Phase 2A: Holistic Analysis Engine + Bird's Eye View\n */\n\n// ========== HELPER FUNCTIONS ==========\n\n\n// ============================================================================\n// DYNAMIC HEADER RESOLUTION\n// ============================================================================\n\n/**\n * Refresh header mappings from spreadsheet and cache in document properties\n * Call this before any operations that use column indices\n */\n\n/**\n * Get column index by Tier2 header name from cached mappings\n * @param {string} tier2Name - The Tier2 header name to find\n * @param {number} fallbackIndex - Fallback column index if not found\n * @returns {number} Column index (0-based)\n */\nfunction getColumnIndexByHeader_(fullFieldName, fallbackIndex) {\n  try {\n    const docProps = PropertiesService.getDocumentProperties();\n    const cachedMergedKeys = docProps.getProperty('CACHED_MERGED_KEYS');\n    \n    if (cachedMergedKeys) {\n      const headers = JSON.parse(cachedMergedKeys);\n      const index = headers.indexOf(fullFieldName);\n      \n      if (index !== -1) {\n        if (index !== fallbackIndex) {\n          Logger.log('üîÑ Header \"' + fullFieldName + '\" moved: ' + fallbackIndex + ' ‚Üí ' + index);\n        }\n        return index;\n      }\n    }\n  } catch (e) {\n    Logger.log('‚ö†Ô∏è  Could not read cached headers: ' + e.message);\n  }\n  \n  return fallbackIndex;\n}\n\n/**\n * Resolve multiple column indices at once\n * @param {Object} fieldMap - Map of field names to {name: tier2Name, fallback: index}\n * @returns {Object} Map of field names to resolved column indices\n */\nfunction resolveColumnIndices_(fieldMap) {\n  const resolved = {};\n  \n  Object.keys(fieldMap).forEach(function(fieldName) {\n    const field = fieldMap[fieldName];\n    resolved[fieldName] = getColumnIndexByHeader_(field.name, field.fallback);\n  });\n  \n  return resolved;\n}\n\n\n\n\n// ========== MAIN PANEL LAUNCHER ==========\n\nfunction runPathwayChainBuilder() {\n  const ui = getSafeUi_();\n  if (!ui) {\n    Logger.log('No UI context available');\n    return;\n  }\n\n  try {\n    // STEP 1: Refresh headers cache (loads Row 2 headers into DocumentProperties)\n    Logger.log('üìÇ Refreshing headers cache...');\n    refreshHeaders();\n    Logger.log('‚úÖ Headers cached');\n\n    // STEP 2: Initialize 35 intelligent defaults if none exist\n    var docProps = PropertiesService.getDocumentProperties();\n    var savedSelection = docProps.getProperty('SELECTED_CACHE_FIELDS');\n\n    if (!savedSelection) {\n      Logger.log('üìÇ No saved field selection - initializing 35 intelligent defaults...');\n\n      var defaultFields = [\n                'Case_Organization_Case_ID',\n        'Case_Organization_Spark_Title',\n        'Case_Organization_Reveal_Title',\n        'Case_Organization_Pathway_or_Course_Name',\n        'Case_Organization_Difficulty_Level',\n        'Case_Organization_Medical_Category',\n\n                'Patient_Demographics_and_Clinical_Data_Age',\n        'Patient_Demographics_and_Clinical_Data_Gender',\n        'Patient_Demographics_and_Clinical_Data_Presenting_Complaint',\n        'Patient_Demographics_and_Clinical_Data_Past_Medical_History',\n        'Patient_Demographics_and_Clinical_Data_Exam_Positive_Findings',\n        'Monitor_Vital_Signs_Initial_Vitals',\n        'Scenario_Progression_States_Decision_Nodes_JSON',\n        'Set_the_Stage_Context_Case_Summary_Concise',\n\n                'CME_and_Educational_Content_CME_Learning_Objective',\n        'Set_the_Stage_Context_Educational_Goal',\n        'Set_the_Stage_Context_Why_It_Matters',\n        'Developer_and_QA_Metadata_Simulation_Quality_Score',\n        'Case_Organization_Original_Title',\n\n                'Set_the_Stage_Context_Environment_Type',\n        'Set_the_Stage_Context_Environment_Description_for_AI_Image',\n        'Situation_and_Environment_Details_Triage_or_SBAR_Note',\n        'Situation_and_Environment_Details_Disposition_Plan',\n        'Scenario_Progression_States_Branching_Notes',\n        'Staff_and_AI_Interaction_Config_Patient_Script',\n\n                'Monitor_Vital_Signs_State1_Vitals',\n        'Monitor_Vital_Signs_State2_Vitals',\n        'Monitor_Vital_Signs_State3_Vitals',\n        'Monitor_Vital_Signs_State4_Vitals',\n        'Monitor_Vital_Signs_State5_Vitals',\n        'Monitor_Vital_Signs_Vitals_Format',\n\n                'Developer_and_QA_Metadata_AI_Reflection_and_Suggestions',\n        'Version_and_Attribution_Full_Attribution_Details',\n        'Case_Organization_Pre_Sim_Overview',\n        'Case_Organization_Post_Sim_Overview'\n      ];\n\n      docProps.setProperty('SELECTED_CACHE_FIELDS', JSON.stringify(defaultFields));\n      Logger.log('‚úÖ Initialized 35 intelligent defaults');\n    } else {\n      Logger.log('‚úÖ Field selection already cached (' + JSON.parse(savedSelection).length + ' fields)');\n    }\n\n    // STEP 2.5: Pre-fetch AI recommendations in background (NON-BLOCKING)\n    Logger.log('ü§ñ Starting AI pre-fetch in background...');\n\n    // Strategy: We trigger the AI call but DON'T wait for it\n    // This way the Pathway UI shows immediately\n    // When user clicks cache button, modal will check if AI result is ready\n    // If not ready, modal shows \"AI processing...\" and tries again\n    // If ready, modal uses cached result instantly\n\n    try {\n      var roughDraft = getFieldSelectorRoughDraft();\n      getRecommendedFields(roughDraft.allFields, roughDraft.selected);\n      Logger.log('‚úÖ AI pre-fetch initiated (processing in background)');\n    } catch (prefetchError) {\n      Logger.log('‚ö†Ô∏è AI pre-fetch failed (non-critical): ' + prefetchError.message);\n      // Don't throw - this is background work, failure is acceptable\n      // Modal will retry AI call when opened\n    }\n\n\n\n\n    // STEP 3: Get or create holistic analysis (cached)\n    const analysis = getOrCreateHolisticAnalysis_();\n\n    const html = buildBirdEyeViewUI_(analysis);\n    const htmlOutput = HtmlService.createHtmlOutput(html)\n      .setWidth(1920)\n      .setHeight(1000);\n\n    ui.showModalDialog(htmlOutput, 'üß© Pathway Chain Builder - AI-Powered Design System');\n  } catch (error) {\n    ui.alert('Error loading Pathway Chain Builder: ' + error.toString());\n    Logger.log('Pathway Chain Builder Error: ' + error.toString());\n  }\n}\n\n// ========== HOLISTIC ANALYSIS ENGINE ==========\n\nfunction getOrCreateHolisticAnalysis_(forceRefresh) {\n\n  // Refresh headers before analysis\n  refreshHeaders();\n\n  const docProps = PropertiesService.getDocumentProperties();\n\n  // Check if we have cached analysis (less than 24 hours old)\n  const cachedTimestamp = docProps.getProperty('HOLISTIC_ANALYSIS_TIMESTAMP');\n  const cachedAnalysis = docProps.getProperty('HOLISTIC_ANALYSIS_JSON');\n\n  if (!forceRefresh && cachedTimestamp && cachedAnalysis) {\n    const cached = new Date(cachedTimestamp);\n    const now = new Date();\n    const hoursDiff = (now - cached) / (1000 * 60 * 60);\n\n    if (hoursDiff < 24) {\n      // Use cached analysis\n      Logger.log('Using cached holistic analysis (' + hoursDiff.toFixed(1) + ' hours old)');\n      try {\n        return JSON.parse(cachedAnalysis);\n      } catch (parseError) {\n        Logger.log('‚ö†Ô∏è Failed to parse cached analysis, regenerating...');\n        // Fall through to regenerate\n      }\n    }\n  }\n\n  // Generate fresh analysis\n  Logger.log('Generating fresh holistic analysis...');\n  const analysis = performHolisticAnalysis_();\n\n  // Cache the results in DocumentProperties\n  try {\n    const analysisJson = JSON.stringify(analysis);\n\n    // Check if it fits in a single property (9KB limit = ~9000 chars)\n    if (analysisJson.length < 9000) {\n      docProps.setProperty('HOLISTIC_ANALYSIS_JSON', analysisJson);\n      docProps.setProperty('HOLISTIC_ANALYSIS_TIMESTAMP', new Date().toISOString());\n      Logger.log('‚úÖ Cached analysis (' + analysisJson.length + ' chars) in DocumentProperties');\n    } else {\n      // Split across multiple properties (chunk into 8KB pieces)\n      const chunkSize = 8000;\n      const chunks = [];\n      for (let i = 0; i < analysisJson.length; i += chunkSize) {\n        chunks.push(analysisJson.substring(i, i + chunkSize));\n      }\n\n      // Save chunks\n      docProps.setProperty('HOLISTIC_ANALYSIS_CHUNKS', chunks.length.toString());\n      for (let i = 0; i < chunks.length; i++) {\n        docProps.setProperty('HOLISTIC_ANALYSIS_CHUNK_' + i, chunks[i]);\n      }\n      docProps.setProperty('HOLISTIC_ANALYSIS_TIMESTAMP', new Date().toISOString());\n\n      Logger.log('‚úÖ Cached analysis (' + analysisJson.length + ' chars) in ' + chunks.length + ' chunks');\n    }\n  } catch (cacheError) {\n    Logger.log('‚ö†Ô∏è Failed to cache analysis: ' + cacheError.toString());\n    // Don't fail if caching fails - just return the analysis\n  }\n\n  return analysis;\n}\n\n\nfunction performHolisticAnalysis_() {\n  const sheet = pickMasterSheet_();\n  const data = sheet.getDataRange().getValues();\n\n  // Defensive: Ensure we have enough rows\n  if (!data || data.length < 3) {\n    throw new Error('Sheet does not have enough data rows');\n  }\n\n  // Row 2 (index 1) contains the flattened merged headers like \"Case_Organization_Case_ID\"\n  const rawHeaders = data[1];\n\n  // Defensive: Ensure headers exist and is an array\n  if (!rawHeaders || !Array.isArray(rawHeaders)) {\n    throw new Error('Could not find valid header row at row 2 (index 1)');\n  }\n\n  // Trim all headers to remove whitespace\n  const headers = rawHeaders.map(function(h) {\n    return typeof h === 'string' ? h.trim() : h;\n  });\n\n  // Dynamic column resolution for holistic analysis\n  const columnIndices = resolveColumnIndices_({\n    caseId: { name: 'Case_Organization_Case_ID', fallback: 0 },\n    sparkTitle: { name: 'Case_Organization_Spark_Title', fallback: 1 },\n    pathway: { name: 'Case_Organization_Pathway_or_Course_Name', fallback: 5 },\n    category: { name: 'Case_Organization_Category', fallback: 4 },\n    diagnosis: { name: 'Case_Orientation_Chief_Diagnosis', fallback: 44 },\n    learningOutcomes: { name: 'Case_Orientation_Actual_Learning_Outcomes', fallback: 45 }\n  });\n\n  const caseIdIdx = columnIndices.caseId;\n  const sparkIdx = columnIndices.sparkTitle;\n  const pathwayIdx = columnIndices.pathway;\n  const categoryIdx = columnIndices.category;\n  const diagnosisIdx = columnIndices.diagnosis;\n  const learningOutcomesIdx = columnIndices.learningOutcomes;\n\n  // Defensive: Check if critical columns were found\n  if (caseIdIdx === -1 || sparkIdx === -1) {\n    throw new Error('Could not find required columns. Looking for Case_Organization_Case_ID, Case_Organization_Spark_Title. CaseID idx: ' + caseIdIdx + ', Spark idx: ' + sparkIdx + ', Category idx: ' + categoryIdx);\n  }\n\n  // Collect all cases with full metadata\n  const allCases = [];\n  const systemDistribution = {};\n  const pathwayDistribution = {};\n  let unassignedCount = 0;\n\n  // Data starts at row 3 (index 2) since row 1 is tier1, row 2 is merged headers\n  for (let i = 2; i < data.length; i++) {\n    const caseItem = {\n      row: i + 1,\n      caseId: data[i][caseIdIdx] || '',\n      sparkTitle: data[i][sparkIdx] || '',\n      category: data[i][categoryIdx] || '',\n      pathway: data[i][pathwayIdx] || '',\n      diagnosis: data[i][diagnosisIdx] || '',\n      learningOutcomes: data[i][learningOutcomesIdx] || ''\n    };\n\n    allCases.push(caseItem);\n\n    // Track system distribution\n    const system = extractPrimarySystem_(caseItem.category);\n    systemDistribution[system] = (systemDistribution[system] || 0) + 1;\n\n    // Track pathway assignment\n    if (caseItem.pathway && caseItem.pathway.trim() !== '') {\n      pathwayDistribution[caseItem.pathway] = (pathwayDistribution[caseItem.pathway] || 0) + 1;\n    } else {\n      unassignedCount++;\n    }\n  }\n\n  // Identify high-value pathway opportunities\n  const pathwayOpportunities = identifyPathwayOpportunities_(allCases, systemDistribution);\n\n  // Generate insights\n  const insights = generateHolisticInsights_(allCases, systemDistribution, pathwayDistribution, unassignedCount);\n\n  return {\n    timestamp: new Date().toISOString(),\n    totalCases: allCases.length,\n    systemDistribution: systemDistribution,\n    pathwayDistribution: pathwayDistribution,\n    unassignedCount: unassignedCount,\n    topPathways: pathwayOpportunities,\n    insights: insights,\n    allCases: allCases // Store for later use\n  };\n}\n\nfunction extractPrimarySystem_(category) {\n  const systems = ['CARD', 'RESP', 'NEUR', 'GI', 'ENDO', 'RENAL', 'ORTHO', 'PSYCH', 'SKIN'];\n  if (!category || typeof category !== 'string') return '';\n  const catUpper = category.toUpperCase();\n\n  for (let i = 0; i < systems.length; i++) {\n    if (catUpper.indexOf(systems[i]) !== -1) {\n      return systems[i];\n    }\n  }\n\n  return 'OTHER';\n}\n\nfunction identifyPathwayOpportunities_(cases, systemDist) {\n  const opportunities = [];\n\n  // ACLS Pathway Opportunity\n  const aclsCases = cases.filter(function(c) {\n    const combined = (c.sparkTitle + ' ' + c.diagnosis + ' ' + c.category).toUpperCase();\n    return combined.indexOf('CARDIAC') !== -1 ||\n           combined.indexOf('ARREST') !== -1 ||\n           combined.indexOf('ARRHYTHMIA') !== -1 ||\n           combined.indexOf('VTACH') !== -1 ||\n           combined.indexOf('VFIB') !== -1 ||\n           combined.indexOf('AFIB') !== -1;\n  });\n\n  if (aclsCases.length >= 5) {\n    opportunities.push({\n      id: 'acls_protocol_001',\n      name: 'ACLS Protocol Series',\n      logicType: 'protocol',\n      icon: 'üíì',\n      confidence: aclsCases.length >= 12 ? 0.95 : 0.75,\n      caseCount: aclsCases.length,\n      rationale: 'Strong concentration of cardiac arrest and arrhythmia cases with clear ACLS protocol applications',\n      suggestedCases: aclsCases.slice(0, 12).map(function(c) { return c.caseId; })\n    });\n  }\n\n  // Cardiovascular System Pathway\n  if (systemDist['CARD'] && systemDist['CARD'] >= 8) {\n    opportunities.push({\n      id: 'card_system_001',\n      name: 'Cardiovascular System Mastery',\n      logicType: 'system',\n      icon: '‚ù§Ô∏è',\n      confidence: 0.90,\n      caseCount: systemDist['CARD'],\n      rationale: 'Sufficient cardiac cases to build comprehensive system-based learning pathway',\n      suggestedCases: cases.filter(function(c) { return (c.category || '').toUpperCase().indexOf('CARD') !== -1; })\n                           .slice(0, 12)\n                           .map(function(c) { return c.caseId; })\n    });\n  }\n\n  // Respiratory System Pathway\n  if (systemDist['RESP'] && systemDist['RESP'] >= 8) {\n    opportunities.push({\n      id: 'resp_system_001',\n      name: 'Respiratory System Mastery',\n      logicType: 'system',\n      icon: 'ü´Å',\n      confidence: 0.88,\n      caseCount: systemDist['RESP'],\n      rationale: 'Strong respiratory case collection for airway management and ventilation training',\n      suggestedCases: cases.filter(function(c) { return (c.category || '').toUpperCase().indexOf('RESP') !== -1; })\n                           .slice(0, 12)\n                           .map(function(c) { return c.caseId; })\n    });\n  }\n\n  // Pediatric Pathway\n  const pedsCases = cases.filter(function(c) {\n    const combined = (c.sparkTitle + ' ' + c.diagnosis + ' ' + c.category).toUpperCase();\n    return combined.indexOf('PEDIATRIC') !== -1 ||\n           combined.indexOf('CHILD') !== -1 ||\n           combined.indexOf('INFANT') !== -1 ||\n           combined.indexOf('PEDS') !== -1;\n  });\n\n  if (pedsCases.length >= 5) {\n    opportunities.push({\n      id: 'peds_specialty_001',\n      name: 'Pediatric Emergency Medicine',\n      logicType: 'specialty',\n      icon: 'üß∏',\n      confidence: pedsCases.length >= 10 ? 0.85 : 0.70,\n      caseCount: pedsCases.length,\n      rationale: 'Pediatric cases suitable for PALS and age-specific emergency training',\n      suggestedCases: pedsCases.slice(0, 12).map(function(c) { return c.caseId; })\n    });\n  }\n\n  // Sort by confidence\n  opportunities.sort(function(a, b) { return b.confidence - a.confidence; });\n\n  return opportunities.slice(0, 6); // Top 6 opportunities\n}\n\nfunction generateHolisticInsights_(cases, systemDist, pathwayDist, unassignedCount) {\n  const insights = [];\n\n  // Insight 1: Top system\n  const topSystem = Object.keys(systemDist).reduce(function(a, b) {\n    return systemDist[a] > systemDist[b] ? a : b;\n  });\n  insights.push(systemDist[topSystem] + ' ' + topSystem + ' cases form largest system group - strong pathway potential');\n\n  // Insight 2: Unassigned cases\n  if (unassignedCount > 0) {\n    const pct = ((unassignedCount / cases.length) * 100).toFixed(0);\n    insights.push(unassignedCount + ' cases unassigned (' + pct + '%) - opportunity to create new pathways');\n  }\n\n  // Insight 3: Protocol opportunities\n  const aclsCount = cases.filter(function(c) {\n    return (c.sparkTitle + c.diagnosis).toUpperCase().indexOf('CARDIAC') !== -1;\n  }).length;\n\n  if (aclsCount >= 8) {\n    insights.push('Strong ACLS pathway opportunity with ' + aclsCount + ' cardiac cases');\n  }\n\n  // Insight 4: Complexity balance\n  const simpleCount = cases.filter(function(c) { return c.diagnosis.length <= 25; }).length;\n  const complexCount = cases.filter(function(c) { return c.diagnosis.length > 50; }).length;\n  const simplePct = ((simpleCount / cases.length) * 100).toFixed(0);\n  const complexPct = ((complexCount / cases.length) * 100).toFixed(0);\n\n  insights.push('Case complexity: ' + simplePct + '% foundational, ' + complexPct + '% advanced - good balance for progression pathways');\n\n  // Insight 5: Multi-system cases\n  const multiSystemCount = cases.filter(function(c) {\n    if (!c.category || typeof c.category !== 'string') return false;\n    return c.category.indexOf(',') !== -1 || c.category.indexOf('/') !== -1;\n  }).length;\n\n  if (multiSystemCount > 5) {\n    insights.push(multiSystemCount + ' multi-system cases identified - consider complexity-based pathway');\n  }\n\n  return insights;\n}\n\n// ========== BIRD'S EYE VIEW UI ==========\n\n// Build Categories tab content\nfunction buildCategoriesTabHTML_(analysis) {\n  const systemCards = Object.keys(analysis.systemDistribution)\n    .sort(function(a, b) { return analysis.systemDistribution[b] - analysis.systemDistribution[a]; })\n    .map(function(sys) {\n      const count = analysis.systemDistribution[sys];\n      const icon = sys === 'CARD' ? 'ü´Ä' :\n                   sys === 'RESP' ? 'ü´Å' :\n                   sys === 'NEUR' ? 'üß†' :\n                   sys === 'GI' ? 'üçΩÔ∏è' :\n                   sys === 'ENDO' ? 'üî¨' :\n                   sys === 'PSYCH' ? 'üßò' :\n                   sys === 'TRAUMA' ? 'üöë' :\n                   sys === 'PEDS' ? 'üë∂' : 'üìÅ';\n\n      return '<div class=\"category-card\" onclick=\"alert(\\'Category view coming soon! Will show all ' + sys + ' cases.\\')\">' +\n             '  <div class=\"category-icon\">' + icon + '</div>' +\n             '  <div class=\"category-name\">' + sys + '</div>' +\n             '  <div class=\"category-count\">' + count + ' cases</div>' +\n             '</div>';\n    }).join('');\n\n  return '<div class=\"tab-content\" id=\"categories-tab\" style=\"display: none;\">' +\n         '  <div class=\"section\">' +\n         '    <div class=\"section-title\">üìÅ System-Based Organization</div>' +\n         '    <div class=\"category-grid\">' + systemCards + '</div>' +\n         '  </div>' +\n         '</div>';\n}\n\n// Build Pathways tab content\nfunction buildPathwaysTabHTML_(analysis) {\n  const pathwayCards = analysis.topPathways.map(function(pw) {\n    const stars = Math.round(pw.confidence * 5);\n    const starStr = Array(stars + 1).join('‚≠ê');\n    const confidencePct = (pw.confidence * 100).toFixed(0);\n\n    return '<div class=\"pathway-card\" style=\"cursor: pointer;\" onclick=\"' +\n           '  document.body.innerHTML = \\'<div style=&quot;text-align:center; padding:100px;&quot;><h2>‚öôÔ∏è Loading chain builder...</h2><p style=&quot;color: #8b92a0;&quot;>Pathway: ' + pw.name + '</p></div>\\';' +\n           '  google.script.run' +\n           '    .withSuccessHandler(function(html) { document.documentElement.innerHTML = html; })' +\n           '    .withFailureHandler(function(error) { document.body.innerHTML = \\'<div style=&quot;text-align:center; padding:100px;&quot;><h2 style=&quot;color: #ff4444;&quot;>‚ùå Error</h2><p>\\' + error.message + \\'</p></div>\\'; })' +\n           '    .buildChainBuilderUI(\\'' + pw.id + '\\', \\'complexity_gradient\\');' +\n           '\">' +\n           '  <div class=\"pathway-header\">' +\n           '    <span class=\"pathway-icon\">' + pw.icon + '</span>' +\n           '    <div class=\"pathway-title\">' + pw.name + '</div>' +\n           '  </div>' +\n           '  <div class=\"pathway-stats\">' +\n           '    <span class=\"pathway-count\">' + pw.caseCount + ' cases</span>' +\n           '    <span class=\"pathway-confidence\">' + starStr + ' ' + confidencePct + '%</span>' +\n           '  </div>' +\n           '  <div class=\"pathway-rationale\">' + pw.rationale + '</div>' +\n           '</div>';\n  }).join('');\n\n  const insightsList = analysis.insights.map(function(insight) {\n    return '<li class=\"insight-item\">üí° ' + insight + '</li>';\n  }).join('');\n\n  // Get cache status\n  const cacheStatus = getCacheStatus();\n  const statusColor = cacheStatus.status === 'valid' ? '#00c853' :\n                      cacheStatus.status === 'stale' ? '#ff9800' : '#f44336';\n  const cacheIndicator = '<span id=\"cache-status\" style=\"font-size: 11px; padding: 4px 8px; background: ' + statusColor + '; color: #fff; border-radius: 4px; font-weight: 600; margin-left: 8px;\">' +\n                        cacheStatus.icon + ' ' + cacheStatus.message +\n                        (cacheStatus.cases ? ' (' + cacheStatus.cases + ' cases)' : '') +\n                        '</span>';\n\n  return '<div class=\"tab-content active\" id=\"pathways-tab\" style=\"display: block;\">' +\n         '  <div class=\"insights-box\">' +\n         '    <h3>üéØ Holistic Insights</h3>' +\n         '    <ul class=\"insights-list\">' + insightsList + '</ul>' +\n         '  </div>' +\n         '  <div class=\"section\">' +\n         '    <div class=\"section-title\" style=\"display: flex; justify-content: space-between; align-items: center;\">' +\n         '      <div><span>üß© Intelligent Pathway Opportunities</span>' + cacheIndicator + '</div>' +\n         '      <div style=\"display: flex; gap: 12px; align-items: center;\">' +\n         '        <button class=\"precache-btn\" onclick=\"google.script.run.preCacheRichData();\" style=\"background: linear-gradient(135deg, #00c853 0%, #00a040 100%); border: none; color: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; box-shadow: 0 0 12px rgba(0, 200, 83, 0.3);\">üíæ Pre-Cache Rich Data</button>' +\n         '        <button class=\"ai-discover-btn\" onclick=\"google.script.run.showAIPathwaysStandardWithLogs();\" style=\"background: linear-gradient(135deg, #2357ff 0%, #1a47cc 100%); border: none; color: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;\">ü§ñ AI: Discover Novel Pathways</button>' +\n         '        <button class=\"ai-radical-btn\" onclick=\"google.script.run.showAIPathwaysRadicalWithLogs();\" style=\"background: linear-gradient(135deg, #ff6b00 0%, #cc5500 100%); border: none; color: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; box-shadow: 0 0 12px rgba(255, 107, 0, 0.3);\">üî• AI: Radical Mode</button>' +\n         '      </div>' +\n         '    </div>' +\n         '    <div class=\"pathway-grid\">' + pathwayCards + '</div>' +\n         '  </div>' +\n         '</div>';\n}\n\n// ========== HOLISTIC ANALYSIS ENGINE ==========\n\n\nfunction buildAIDiscoveryTabHTML_() {\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var logicSheet = ss.getSheetByName('Logic_Type_Library');\n  \n  if (!logicSheet) {\n    return '<div class=\"tab-content\" id=\"discovery-tab\" style=\"display: none;\"><p>Logic_Type_Library sheet not found</p></div>';\n  }\n  \n  var data = logicSheet.getDataRange().getValues();\n  var headers = data[0];\n  \n  var idIdx = headers.indexOf('Logic_Type_ID');\n  var nameIdx = headers.indexOf('Logic_Type_Name');\n  var statusIdx = headers.indexOf('Status');\n  var timesUsedIdx = headers.indexOf('Times_Used');\n  \n  var logicTypes = [];\n  var seenNames = {};\n  \n  for (var i = 1; i < data.length; i++) {\n    var status = data[i][statusIdx];\n    var name = data[i][nameIdx];\n    \n    if (status === 'active' && !seenNames[name]) {\n      seenNames[name] = true;\n      logicTypes.push({\n        id: data[i][idIdx],\n        name: name,\n        timesUsed: parseInt(data[i][timesUsedIdx]) || 0\n      });\n    }\n  }\n  \n  logicTypes.sort(function(a, b) {\n    if (b.timesUsed !== a.timesUsed) {\n      return b.timesUsed - a.timesUsed;\n    }\n    return a.name.localeCompare(b.name);\n  });\n  \n  var logicTypeOptions = logicTypes.map(function(lt) {\n    var usageLabel = lt.timesUsed > 0 ? ' (' + lt.timesUsed + ' uses)' : '';\n    return '<option value=\"' + lt.id + '\">' + lt.name + usageLabel + '</option>';\n  }).join('');\n  \n  return '<div class=\"tab-content\" id=\"discovery-tab\" style=\"display: none;\">' +\n         '  <div style=\"padding: 40px; max-width: 800px; margin: 0 auto;\">' +\n         '    <h2 style=\"margin-bottom: 10px;\">üîç AI-Powered Pathway Discovery</h2>' +\n         '    <p style=\"color: #8b92a0; margin-bottom: 30px;\">Discover high-value learning pathways using AI and multiple intelligence frameworks</p>' +\n         '    ' +\n         '    <div style=\"margin-bottom: 20px;\">' +\n         '      <label style=\"display: block; margin-bottom: 8px; font-weight: 600;\">üß† Discovery Lens (Logic Type)</label>' +\n         '      <select id=\"logic-type-selector\" onchange=\"handleLogicTypeChange()\" style=\"width: 100%; padding: 12px; font-size: 14px; border: 1px solid #2a3040; border-radius: 8px; background: #0f1115; color: #e7eaf0;\">' +\n         '        <option value=\"\">-- Select Logic Type --</option>' +\n         logicTypeOptions +\n         '        <option value=\"\" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>' +\n         '        <option value=\"CREATE_NEW\">üé® Create New Logic Type...</option>' +\n         '      </select>' +\n         '      <p style=\"font-size: 12px; color: #8b92a0; margin-top: 8px;\">üí° Most frequently used logic types appear first</p>' +\n         '    </div>' +\n         '    ' +\n         '    <button id=\"discover-btn\" onclick=\"discoverPathways()\" disabled style=\"width: 100%; padding: 16px; font-size: 16px; font-weight: 700; background: linear-gradient(135deg, #2357ff 0%, #1a42cc 100%); border: none; color: #fff; border-radius: 10px; cursor: pointer; opacity: 0.5;\">' +\n         '      <span style=\"font-size: 20px;\">ü§ñ</span> Discover Pathways' +\n         '    </button>' +\n         '  </div>' +\n         '</div>';\n}function performHolisticAnalysis_() {\n  const sheet = pickMasterSheet_();\n  const data = sheet.getDataRange().getValues();\n\n  // Defensive: Ensure we have enough rows\n  if (!data || data.length < 3) {\n    throw new Error('Sheet does not have enough data rows');\n  }\n\n  // Row 2 (index 1) contains the flattened merged headers like \"Case_Organization_Case_ID\"\n  const rawHeaders = data[1];\n\n  // Defensive: Ensure headers exist and is an array\n  if (!rawHeaders || !Array.isArray(rawHeaders)) {\n    throw new Error('Could not find valid header row at row 2 (index 1)');\n  }\n\n  // Trim all headers to remove whitespace\n  const headers = rawHeaders.map(function(h) {\n    return typeof h === 'string' ? h.trim() : h;\n  });\n\n  // Dynamic column resolution for holistic analysis\n  const columnIndices = resolveColumnIndices_({\n    caseId: { name: 'Case_Organization_Case_ID', fallback: 0 },\n    sparkTitle: { name: 'Case_Organization_Spark_Title', fallback: 1 },\n    pathway: { name: 'Case_Organization_Pathway_or_Course_Name', fallback: 5 },\n    category: { name: 'Case_Organization_Category', fallback: 4 },\n    diagnosis: { name: 'Case_Orientation_Chief_Diagnosis', fallback: 44 },\n    learningOutcomes: { name: 'Case_Orientation_Actual_Learning_Outcomes', fallback: 45 }\n  });\n\n  const caseIdIdx = columnIndices.caseId;\n  const sparkIdx = columnIndices.sparkTitle;\n  const pathwayIdx = columnIndices.pathway;\n  const categoryIdx = columnIndices.category;\n  const diagnosisIdx = columnIndices.diagnosis;\n  const learningOutcomesIdx = columnIndices.learningOutcomes;\n\n  // Defensive: Check if critical columns were found\n  if (caseIdIdx === -1 || sparkIdx === -1) {\n    throw new Error('Could not find required columns. Looking for Case_Organization_Case_ID, Case_Organization_Spark_Title. CaseID idx: ' + caseIdIdx + ', Spark idx: ' + sparkIdx + ', Category idx: ' + categoryIdx);\n  }\n\n  // Collect all cases with full metadata\n  const allCases = [];\n  const systemDistribution = {};\n  const pathwayDistribution = {};\n  let unassignedCount = 0;\n\n  // Data starts at row 3 (index 2) since row 1 is tier1, row 2 is merged headers\n  for (let i = 2; i < data.length; i++) {\n    const caseItem = {\n      row: i + 1,\n      caseId: data[i][caseIdIdx] || '',\n      sparkTitle: data[i][sparkIdx] || '',\n      category: data[i][categoryIdx] || '',\n      pathway: data[i][pathwayIdx] || '',\n      diagnosis: data[i][diagnosisIdx] || '',\n      learningOutcomes: data[i][learningOutcomesIdx] || ''\n    };\n\n    allCases.push(caseItem);\n\n    // Track system distribution\n    const system = extractPrimarySystem_(caseItem.category);\n    systemDistribution[system] = (systemDistribution[system] || 0) + 1;\n\n    // Track pathway assignment\n    if (caseItem.pathway && caseItem.pathway.trim() !== '') {\n      pathwayDistribution[caseItem.pathway] = (pathwayDistribution[caseItem.pathway] || 0) + 1;\n    } else {\n      unassignedCount++;\n    }\n  }\n\n  // Identify high-value pathway opportunities\n  const pathwayOpportunities = identifyPathwayOpportunities_(allCases, systemDistribution);\n\n  // Generate insights\n  const insights = generateHolisticInsights_(allCases, systemDistribution, pathwayDistribution, unassignedCount);\n\n  return {\n    timestamp: new Date().toISOString(),\n    totalCases: allCases.length,\n    systemDistribution: systemDistribution,\n    pathwayDistribution: pathwayDistribution,\n    unassignedCount: unassignedCount,\n    topPathways: pathwayOpportunities,\n    insights: insights,\n    allCases: allCases // Store for later use\n  };\n}\n\nfunction extractPrimarySystem_(category) {\n  const systems = ['CARD', 'RESP', 'NEUR', 'GI', 'ENDO', 'RENAL', 'ORTHO', 'PSYCH', 'SKIN'];\n  if (!category || typeof category !== 'string') return '';\n  const catUpper = category.toUpperCase();\n\n  for (let i = 0; i < systems.length; i++) {\n    if (catUpper.indexOf(systems[i]) !== -1) {\n      return systems[i];\n    }\n  }\n\n  return 'OTHER';\n}\n\nfunction identifyPathwayOpportunities_(cases, systemDist) {\n  const opportunities = [];\n\n  // ACLS Pathway Opportunity\n  const aclsCases = cases.filter(function(c) {\n    const combined = (c.sparkTitle + ' ' + c.diagnosis + ' ' + c.category).toUpperCase();\n    return combined.indexOf('CARDIAC') !== -1 ||\n           combined.indexOf('ARREST') !== -1 ||\n           combined.indexOf('ARRHYTHMIA') !== -1 ||\n           combined.indexOf('VTACH') !== -1 ||\n           combined.indexOf('VFIB') !== -1 ||\n           combined.indexOf('AFIB') !== -1;\n  });\n\n  if (aclsCases.length >= 5) {\n    opportunities.push({\n      id: 'acls_protocol_001',\n      name: 'ACLS Protocol Series',\n      logicType: 'protocol',\n      icon: 'üíì',\n      confidence: aclsCases.length >= 12 ? 0.95 : 0.75,\n      caseCount: aclsCases.length,\n      rationale: 'Strong concentration of cardiac arrest and arrhythmia cases with clear ACLS protocol applications',\n      suggestedCases: aclsCases.slice(0, 12).map(function(c) { return c.caseId; })\n    });\n  }\n\n  // Cardiovascular System Pathway\n  if (systemDist['CARD'] && systemDist['CARD'] >= 8) {\n    opportunities.push({\n      id: 'card_system_001',\n      name: 'Cardiovascular System Mastery',\n      logicType: 'system',\n      icon: '‚ù§Ô∏è',\n      confidence: 0.90,\n      caseCount: systemDist['CARD'],\n      rationale: 'Sufficient cardiac cases to build comprehensive system-based learning pathway',\n      suggestedCases: cases.filter(function(c) { return (c.category || '').toUpperCase().indexOf('CARD') !== -1; })\n                           .slice(0, 12)\n                           .map(function(c) { return c.caseId; })\n    });\n  }\n\n  // Respiratory System Pathway\n  if (systemDist['RESP'] && systemDist['RESP'] >= 8) {\n    opportunities.push({\n      id: 'resp_system_001',\n      name: 'Respiratory System Mastery',\n      logicType: 'system',\n      icon: 'ü´Å',\n      confidence: 0.88,\n      caseCount: systemDist['RESP'],\n      rationale: 'Strong respiratory case collection for airway management and ventilation training',\n      suggestedCases: cases.filter(function(c) { return (c.category || '').toUpperCase().indexOf('RESP') !== -1; })\n                           .slice(0, 12)\n                           .map(function(c) { return c.caseId; })\n    });\n  }\n\n  // Pediatric Pathway\n  const pedsCases = cases.filter(function(c) {\n    const combined = (c.sparkTitle + ' ' + c.diagnosis + ' ' + c.category).toUpperCase();\n    return combined.indexOf('PEDIATRIC') !== -1 ||\n           combined.indexOf('CHILD') !== -1 ||\n           combined.indexOf('INFANT') !== -1 ||\n           combined.indexOf('PEDS') !== -1;\n  });\n\n  if (pedsCases.length >= 5) {\n    opportunities.push({\n      id: 'peds_specialty_001',\n      name: 'Pediatric Emergency Medicine',\n      logicType: 'specialty',\n      icon: 'üß∏',\n      confidence: pedsCases.length >= 10 ? 0.85 : 0.70,\n      caseCount: pedsCases.length,\n      rationale: 'Pediatric cases suitable for PALS and age-specific emergency training',\n      suggestedCases: pedsCases.slice(0, 12).map(function(c) { return c.caseId; })\n    });\n  }\n\n  // Sort by confidence\n  opportunities.sort(function(a, b) { return b.confidence - a.confidence; });\n\n  return opportunities.slice(0, 6); // Top 6 opportunities\n}\n\nfunction generateHolisticInsights_(cases, systemDist, pathwayDist, unassignedCount) {\n  const insights = [];\n\n  // Insight 1: Top system\n  const topSystem = Object.keys(systemDist).reduce(function(a, b) {\n    return systemDist[a] > systemDist[b] ? a : b;\n  });\n  insights.push(systemDist[topSystem] + ' ' + topSystem + ' cases form largest system group - strong pathway potential');\n\n  // Insight 2: Unassigned cases\n  if (unassignedCount > 0) {\n    const pct = ((unassignedCount / cases.length) * 100).toFixed(0);\n    insights.push(unassignedCount + ' cases unassigned (' + pct + '%) - opportunity to create new pathways');\n  }\n\n  // Insight 3: Protocol opportunities\n  const aclsCount = cases.filter(function(c) {\n    return (c.sparkTitle + c.diagnosis).toUpperCase().indexOf('CARDIAC') !== -1;\n  }).length;\n\n  if (aclsCount >= 8) {\n    insights.push('Strong ACLS pathway opportunity with ' + aclsCount + ' cardiac cases');\n  }\n\n  // Insight 4: Complexity balance\n  const simpleCount = cases.filter(function(c) { return c.diagnosis.length <= 25; }).length;\n  const complexCount = cases.filter(function(c) { return c.diagnosis.length > 50; }).length;\n  const simplePct = ((simpleCount / cases.length) * 100).toFixed(0);\n  const complexPct = ((complexCount / cases.length) * 100).toFixed(0);\n\n  insights.push('Case complexity: ' + simplePct + '% foundational, ' + complexPct + '% advanced - good balance for progression pathways');\n\n  // Insight 5: Multi-system cases\n  const multiSystemCount = cases.filter(function(c) {\n    if (!c.category || typeof c.category !== 'string') return false;\n    return c.category.indexOf(',') !== -1 || c.category.indexOf('/') !== -1;\n  }).length;\n\n  if (multiSystemCount > 5) {\n    insights.push(multiSystemCount + ' multi-system cases identified - consider complexity-based pathway');\n  }\n\n  return insights;\n}\n\n// ========== BIRD'S EYE VIEW UI ==========\n\n// Build Categories tab content\nfunction buildCategoriesTabHTML_(analysis) {\n  const systemCards = Object.keys(analysis.systemDistribution)\n    .sort(function(a, b) { return analysis.systemDistribution[b] - analysis.systemDistribution[a]; })\n    .map(function(sys) {\n      const count = analysis.systemDistribution[sys];\n      const icon = sys === 'CARD' ? 'ü´Ä' :\n                   sys === 'RESP' ? 'ü´Å' :\n                   sys === 'NEUR' ? 'üß†' :\n                   sys === 'GI' ? 'üçΩÔ∏è' :\n                   sys === 'ENDO' ? 'üî¨' :\n                   sys === 'PSYCH' ? 'üßò' :\n                   sys === 'TRAUMA' ? 'üöë' :\n                   sys === 'PEDS' ? 'üë∂' : 'üìÅ';\n\n      return '<div class=\"category-card\" onclick=\"alert(\\'Category view coming soon! Will show all ' + sys + ' cases.\\')\">' +\n             '  <div class=\"category-icon\">' + icon + '</div>' +\n             '  <div class=\"category-name\">' + sys + '</div>' +\n             '  <div class=\"category-count\">' + count + ' cases</div>' +\n             '</div>';\n    }).join('');\n\n  return '<div class=\"tab-content\" id=\"categories-tab\" style=\"display: none;\">' +\n         '  <div class=\"section\">' +\n         '    <div class=\"section-title\">üìÅ System-Based Organization</div>' +\n         '    <div class=\"category-grid\">' + systemCards + '</div>' +\n         '  </div>' +\n         '</div>';\n}\n\n// Build Pathways tab content\nfunction buildPathwaysTabHTML_(analysis) {\n  const pathwayCards = analysis.topPathways.map(function(pw) {\n    const stars = Math.round(pw.confidence * 5);\n    const starStr = Array(stars + 1).join('‚≠ê');\n    const confidencePct = (pw.confidence * 100).toFixed(0);\n\n    return '<div class=\"pathway-card\" style=\"cursor: pointer;\" onclick=\"' +\n           '  document.body.innerHTML = \\'<div style=&quot;text-align:center; padding:100px;&quot;><h2>‚öôÔ∏è Loading chain builder...</h2><p style=&quot;color: #8b92a0;&quot;>Pathway: ' + pw.name + '</p></div>\\';' +\n           '  google.script.run' +\n           '    .withSuccessHandler(function(html) { document.documentElement.innerHTML = html; })' +\n           '    .withFailureHandler(function(error) { document.body.innerHTML = \\'<div style=&quot;text-align:center; padding:100px;&quot;><h2 style=&quot;color: #ff4444;&quot;>‚ùå Error</h2><p>\\' + error.message + \\'</p></div>\\'; })' +\n           '    .buildChainBuilderUI(\\'' + pw.id + '\\', \\'complexity_gradient\\');' +\n           '\">' +\n           '  <div class=\"pathway-header\">' +\n           '    <span class=\"pathway-icon\">' + pw.icon + '</span>' +\n           '    <div class=\"pathway-title\">' + pw.name + '</div>' +\n           '  </div>' +\n           '  <div class=\"pathway-stats\">' +\n           '    <span class=\"pathway-count\">' + pw.caseCount + ' cases</span>' +\n           '    <span class=\"pathway-confidence\">' + starStr + ' ' + confidencePct + '%</span>' +\n           '  </div>' +\n           '  <div class=\"pathway-rationale\">' + pw.rationale + '</div>' +\n           '</div>';\n  }).join('');\n\n  const insightsList = analysis.insights.map(function(insight) {\n    return '<li class=\"insight-item\">üí° ' + insight + '</li>';\n  }).join('');\n\n  // Get cache status\n  const cacheStatus = getCacheStatus();\n  const statusColor = cacheStatus.status === 'valid' ? '#00c853' :\n                      cacheStatus.status === 'stale' ? '#ff9800' : '#f44336';\n  const cacheIndicator = '<span id=\"cache-status\" style=\"font-size: 11px; padding: 4px 8px; background: ' + statusColor + '; color: #fff; border-radius: 4px; font-weight: 600; margin-left: 8px;\">' +\n                        cacheStatus.icon + ' ' + cacheStatus.message +\n                        (cacheStatus.cases ? ' (' + cacheStatus.cases + ' cases)' : '') +\n                        '</span>';\n\n  return '<div class=\"tab-content active\" id=\"pathways-tab\" style=\"display: block;\">' +\n         '  <div class=\"insights-box\">' +\n         '    <h3>üéØ Holistic Insights</h3>' +\n         '    <ul class=\"insights-list\">' + insightsList + '</ul>' +\n         '  </div>' +\n         '  <div class=\"section\">' +\n         '    <div class=\"section-title\" style=\"display: flex; justify-content: space-between; align-items: center;\">' +\n         '      <div><span>üß© Intelligent Pathway Opportunities</span>' + cacheIndicator + '</div>' +\n         '      <div style=\"display: flex; gap: 12px; align-items: center;\">' +\n         '        <button class=\"precache-btn\" onclick=\"google.script.run.preCacheRichData();\" style=\"background: linear-gradient(135deg, #00c853 0%, #00a040 100%); border: none; color: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; box-shadow: 0 0 12px rgba(0, 200, 83, 0.3);\">üíæ Pre-Cache Rich Data</button>' +\n         '        <button class=\"ai-discover-btn\" onclick=\"google.script.run.showAIPathwaysStandardWithLogs();\" style=\"background: linear-gradient(135deg, #2357ff 0%, #1a47cc 100%); border: none; color: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px;\">ü§ñ AI: Discover Novel Pathways</button>' +\n         '        <button class=\"ai-radical-btn\" onclick=\"google.script.run.showAIPathwaysRadicalWithLogs();\" style=\"background: linear-gradient(135deg, #ff6b00 0%, #cc5500 100%); border: none; color: #fff; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; gap: 6px; box-shadow: 0 0 12px rgba(255, 107, 0, 0.3);\">üî• AI: Radical Mode</button>' +\n         '      </div>' +\n         '    </div>' +\n         '    <div class=\"pathway-grid\">' + pathwayCards + '</div>' +\n         '  </div>' +\n         '</div>';\n}\n\nfunction buildBirdEyeViewUI_(analysis) {\n  // Build tab content\n  const categoriesTabHTML = buildCategoriesTabHTML_(analysis);\n  const pathwaysTabHTML = buildPathwaysTabHTML_(analysis);\n  const discoveryTabHTML = buildAIDiscoveryTabHTML_();\n\n  return '<!DOCTYPE html>' +\n'<!-- Cache Buster: 2025-11-09T04:03:02.722Z -->' +\n'<html>' +\n'<head>' +\n'  <base target=\"_top\">' +\n'  <style>' +\n'    * { margin: 0; padding: 0; box-sizing: border-box; }' +\n'' +\n'    body {' +\n'      font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Arial, sans-serif;' +\n'      background: linear-gradient(135deg, #0f1115 0%, #1a1d26 100%);' +\n'      color: #e7eaf0;' +\n'      overflow-x: hidden;' +\n'      height: 1000px;' +\n'    }' +\n'' +\n'    .header {' +\n'      background: linear-gradient(135deg, #1b1f2a 0%, #141824 100%);' +\n'      padding: 20px 32px 0 32px;' +\n'      border-bottom: 2px solid #2a3040;' +\n'    }' +\n'' +\n'    .header-top {' +\n'      display: flex;' +\n'      justify-content: space-between;' +\n'      align-items: center;' +\n'      margin-bottom: 16px;' +\n'    }' +\n'' +\n'    .header h1 {' +\n'      font-size: 28px;' +\n'      font-weight: 700;' +\n'    }' +\n'' +\n'    .btn-reanalyze {' +\n'      background: linear-gradient(135deg, #2a3040 0%, #1e2533 100%);' +\n'      border: 1px solid #3a4458;' +\n'      color: #e7eaf0;' +\n'      padding: 10px 18px;' +\n'      border-radius: 8px;' +\n'      cursor: pointer;' +\n'      font-size: 13px;' +\n'      font-weight: 600;' +\n'      transition: all 0.2s;' +\n'    }' +\n'' +\n'    .btn-reanalyze:hover {' +\n'      background: linear-gradient(135deg, #3a4458 0%, #2a3040 100%);' +\n'      border-color: #2357ff;' +\n'    }' +\n'' +\n'    .stats-bar {' +\n'      display: flex;' +\n'      gap: 16px;' +\n'      margin-bottom: 12px;' +\n'    }' +\n'' +\n'    .stat-badge {' +\n'      background: #0f1115;' +\n'      border: 1px solid #2a3040;' +\n'      padding: 6px 14px;' +\n'      border-radius: 8px;' +\n'      font-size: 12px;' +\n'      color: #8b92a0;' +\n'    }' +\n'' +\n'    .stat-badge .value {' +\n'      color: #2357ff;' +\n'      font-weight: 700;' +\n'      margin-right: 4px;' +\n'    }' +\n'' +\n'    /* Browser-style tabs */' +\n'    .tab-switcher {' +\n'      display: flex;' +\n'      gap: 4px;' +\n'      border-bottom: none;' +\n'    }' +\n'' +\n'    .tab {' +\n'      background: #141824;' +\n'      border: 1px solid #2a3040;' +\n'      border-bottom: none;' +\n'      color: #8b92a0;' +\n'      padding: 12px 24px;' +\n'      border-radius: 10px 10px 0 0;' +\n'      cursor: pointer;' +\n'      font-size: 14px;' +\n'      font-weight: 600;' +\n'      transition: all 0.2s;' +\n'      position: relative;' +\n'      bottom: -1px;' +\n'    }' +\n'' +\n'    .tab:hover {' +\n'      background: #1b1f2a;' +\n'      color: #e7eaf0;' +\n'    }' +\n'' +\n'    .tab.active {' +\n'      background: linear-gradient(135deg, #0f1115 0%, #1a1d26 100%);' +\n'      border-color: #2a3040;' +\n'      border-bottom: 2px solid transparent;' +\n'      color: #2357ff;' +\n'      box-shadow: 0 -2px 8px rgba(35, 87, 255, 0.1);' +\n'    }' +\n'' +\n'    /* Tab content */' +\n'    .tab-content {' +\n'      display: none;' +\n'      padding: 32px;' +\n'      overflow-y: auto;' +\n'      height: calc(1000px - 180px);' +\n'    }' +\n'' +\n'    .tab-content.active {' +\n'      display: block;' +\n'    }' +\n'' +\n'    .tab-content::-webkit-scrollbar {' +\n'      width: 10px;' +\n'    }' +\n'' +\n'    .tab-content::-webkit-scrollbar-track {' +\n'      background: #0f1115;' +\n'    }' +\n'' +\n'    .tab-content::-webkit-scrollbar-thumb {' +\n'      background: #2a3040;' +\n'      border-radius: 5px;' +\n'    }' +\n'' +\n'    .section {' +\n'      margin-bottom: 32px;' +\n'    }' +\n'' +\n'    .section-title {' +\n'      font-size: 18px;' +\n'      font-weight: 600;' +\n'      margin-bottom: 20px;' +\n'      color: #e7eaf0;' +\n'      display: flex;' +\n'      align-items: center;' +\n'      gap: 10px;' +\n'    }' +\n'' +\n'    /* Category cards (for Categories tab) */' +\n'    .category-grid {' +\n'      display: grid;' +\n'      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));' +\n'      gap: 20px;' +\n'    }' +\n'' +\n'    .category-card {' +\n'      background: linear-gradient(135deg, #1e2533 0%, #181d28 100%);' +\n'      border: 2px solid #2a3040;' +\n'      border-radius: 16px;' +\n'      padding: 28px 24px;' +\n'      text-align: center;' +\n'      cursor: pointer;' +\n'      transition: all 0.3s ease;' +\n'    }' +\n'' +\n'    .category-card:hover {' +\n'      background: linear-gradient(135deg, #252b3a 0%, #1f2430 100%);' +\n'      border-color: #2357ff;' +\n'      transform: translateY(-6px);' +\n'      box-shadow: 0 12px 32px rgba(35, 87, 255, 0.25);' +\n'    }' +\n'' +\n'    .category-icon {' +\n'      font-size: 52px;' +\n'      margin-bottom: 16px;' +\n'      filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));' +\n'    }' +\n'' +\n'    .category-name {' +\n'      font-size: 20px;' +\n'      font-weight: 700;' +\n'      color: #e7eaf0;' +\n'      margin-bottom: 8px;' +\n'      letter-spacing: 0.5px;' +\n'    }' +\n'' +\n'    .category-count {' +\n'      font-size: 14px;' +\n'      color: #8b92a0;' +\n'      font-weight: 500;' +\n'    }' +\n'' +\n'    /* Insights box */' +\n'    .insights-box {' +\n'      background: linear-gradient(135deg, #1e2533 0%, #181d28 100%);' +\n'      border: 1px solid #2a3040;' +\n'      border-left: 3px solid #2357ff;' +\n'      padding: 20px 24px;' +\n'      border-radius: 10px;' +\n'      margin-bottom: 32px;' +\n'    }' +\n'' +\n'    .insights-box h3 {' +\n'      font-size: 16px;' +\n'      font-weight: 600;' +\n'      margin-bottom: 12px;' +\n'      color: #2357ff;' +\n'    }' +\n'' +\n'    .insights-list {' +\n'      list-style: none;' +\n'      padding: 0;' +\n'    }' +\n'' +\n'    .insight-item {' +\n'      font-size: 14px;' +\n'      color: #8b92a0;' +\n'      line-height: 1.6;' +\n'      margin-bottom: 10px;' +\n'    }' +\n'' +\n'    /* Pathway cards (for Pathways tab) */' +\n'    .pathway-grid {' +\n'      display: grid;' +\n'      grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));' +\n'      gap: 20px;' +\n'    }' +\n'' +\n'    .pathway-card {' +\n'      background: linear-gradient(135deg, #1e2533 0%, #181d28 100%);' +\n'      border: 1px solid #2a3040;' +\n'      padding: 20px;' +\n'      border-radius: 12px;' +\n'      cursor: pointer;' +\n'      transition: all 0.3s;' +\n'    }' +\n'' +\n'    .pathway-card:hover {' +\n'      background: linear-gradient(135deg, #252b3a 0%, #1f2430 100%);' +\n'      border-color: #2357ff;' +\n'      transform: translateY(-3px);' +\n'      box-shadow: 0 8px 24px rgba(35, 87, 255, 0.2);' +\n'    }' +\n'' +\n'    .pathway-header {' +\n'      display: flex;' +\n'      align-items: center;' +\n'      gap: 12px;' +\n'      margin-bottom: 12px;' +\n'    }' +\n'' +\n'    .pathway-icon {' +\n'      font-size: 32px;' +\n'    }' +\n'' +\n'    .pathway-title {' +\n'      font-size: 18px;' +\n'      font-weight: 600;' +\n'      color: #e7eaf0;' +\n'    }' +\n'' +\n'    .pathway-stats {' +\n'      display: flex;' +\n'      justify-content: space-between;' +\n'      align-items: center;' +\n'      margin-bottom: 12px;' +\n'    }' +\n'' +\n'    .pathway-count {' +\n'      font-size: 13px;' +\n'      color: #2357ff;' +\n'      font-weight: 600;' +\n'    }' +\n'' +\n'    .pathway-confidence {' +\n'      font-size: 12px;' +\n'      color: #8b92a0;' +\n'    }' +\n'' +\n'    .pathway-rationale {' +\n'      font-size: 13px;' +\n'      color: #8b92a0;' +\n'      line-height: 1.5;' +\n'      margin-bottom: 16px;' +\n'    }' +\n'' +\n'    .btn-build {' +\n'      width: 100%;' +\n'      background: linear-gradient(135deg, #2357ff 0%, #1a47d9 100%);' +\n'      border: none;' +\n'      color: #fff;' +\n'      padding: 10px 16px;' +\n'      border-radius: 8px;' +\n'      cursor: pointer;' +\n'      font-size: 14px;' +\n'      font-weight: 600;' +\n'      transition: all 0.2s;' +\n'    }' +\n'' +\n'    .btn-build:hover {' +\n'      background: linear-gradient(135deg, #1a47d9 0%, #1538b8 100%);' +\n'      transform: translateY(-1px);' +\n'    }' +\n'  </style>' +\n'' +\n'  <script>' +\n'    function handleLogicTypeChange() {' +\n'      var select = document.getElementById(\"logic-type-selector\");' +\n'      var btn = document.getElementById(\"discover-btn\");' +\n'      if (!btn) return;' +\n'      if (select.value && select.value !== \"CREATE_NEW\") {' +\n'        btn.disabled = false;' +\n'      } else {' +\n'        btn.disabled = true;' +\n'      }' +\n'    }' +\n'    ' +\n'    function discoverPathways() {' +\n'      var logicTypeId = document.getElementById(\"logic-type-selector\").value;' +\n'      if (!logicTypeId || logicTypeId === \"CREATE_NEW\") {' +\n'        alert(\"Please select a logic type first\");' +\n'        return;' +\n'      }' +\n'      var btn = document.getElementById(\"discover-btn\");' +\n'      btn.disabled = true;' +\n'      btn.innerHTML = \"<span class=\\\\\"btn-icon\\\\\">üîÑ</span><span class=\\\\\"btn-text\\\\\">Discovering...</span>\";' +\n'      google.script.run' +\n'        .withSuccessHandler(handleDiscoveryResults)' +\n'        .withFailureHandler(handleDiscoveryError)' +\n'        .discoverPathwaysWithLogicType(logicTypeId);' +\n'    }' +\n'    ' +\n'    function handleDiscoveryResults(result) {' +\n'      var btn = document.getElementById(\"discover-btn\");' +\n'      btn.disabled = false;' +\n'      btn.innerHTML = \"<span class=\\\\\"btn-icon\\\\\">ü§ñ</span><span class=\\\\\"btn-text\\\\\">Discover Pathways</span>\";' +\n'      if (!result.success) {' +\n'        alert(\"Error: \" + result.error);' +\n'        return;' +\n'      }' +\n'      alert(\"‚úÖ Discovery complete! \" + result.pathwaysCount + \" pathways saved to Pathways_Master sheet.\");' +\n'    }' +\n'    ' +\n'    function handleDiscoveryError(error) {' +\n'      var btn = document.getElementById(\"discover-btn\");' +\n'      btn.disabled = false;' +\n'      btn.innerHTML = \"<span class=\\\\\"btn-icon\\\\\">ü§ñ</span><span class=\\\\\"btn-text\\\\\">Discover Pathways</span>\";' +\n'      alert(\"Error: \" + error.message);' +\n'    }' +\n'  </script>' +\n'' +\n'</head>' +\n'<body>' +\n'  <div class=\"header\">' +\n'    <div class=\"header-top\">' +\n'      <h1>üß© Pathway Chain Builder</h1>' +\n'      <button class=\"btn-reanalyze\" onclick=\"reAnalyze()\">üîÑ Re-analyze</button>' +\n'    </div>' +\n'    <div class=\"stats-bar\">' +\n'      <div class=\"stat-badge\"><span class=\"value\">' + analysis.totalCases + '</span> Total Cases</div>' +\n'      <div class=\"stat-badge\"><span class=\"value\">' + Object.keys(analysis.systemDistribution).length + '</span> Systems</div>' +\n'      <div class=\"stat-badge\"><span class=\"value\">' + analysis.topPathways.length + '</span> Opportunities</div>' +\n'      <div class=\"stat-badge\"><span class=\"value\">' + analysis.unassignedCount + '</span> Unassigned</div>' +\n'    </div>' +\n'    <div class=\"tab-switcher\">' +\n'      <button class=\"tab\" id=\"categories-tab-btn\" onclick=\"' +\n'        document.getElementById(\\'categories-tab-btn\\').classList.add(\\'active\\');' +\n'        document.getElementById(\\'pathways-tab-btn\\').classList.remove(\\'active\\');' +\n'        document.getElementById(\\'categories-tab\\').style.display = \\'block\\';' +\n'        document.getElementById(\\'pathways-tab\\').style.display = \\'none\\';' +\n'      \">üìÅ Categories</button>' +\n'      <button class=\"tab active\" id=\"pathways-tab-btn\" onclick=\"' +\n'        document.getElementById(\\'categories-tab-btn\\').classList.remove(\\'active\\');' +\n'        document.getElementById(\\'pathways-tab-btn\\').classList.add(\\'active\\');' +\n'        document.getElementById(\\'categories-tab\\').style.display = \\'none\\';' +\n'        document.getElementById(\\'pathways-tab\\').style.display = \\'block\\';' +\n'      \">üß© Pathways</button>' +\n'      <button class=\"tab\" id=\"discovery-tab-btn\" onclick=\"' +\n'        document.getElementById(\\'categories-tab-btn\\').classList.remove(\\'active\\');' +\n'        document.getElementById(\\'pathways-tab-btn\\').classList.remove(\\'active\\');' +\n'        document.getElementById(\\'discovery-tab-btn\\').classList.add(\\'active\\');' +\n'        document.getElementById(\\'categories-tab\\').style.display = \\'none\\';' +\n'        document.getElementById(\\'pathways-tab\\').style.display = \\'none\\';' +\n'        document.getElementById(\\'discovery-tab\\').style.display = \\'block\\';' +\n'      \">üîç AI Discovery</button>' +\n'    </div>' +\n'  </div>' +\n'' +\n'  ' + categoriesTabHTML +\n'  ' + pathwaysTabHTML +\n'  ' + discoveryTabHTML +\n'' +\n'  <script>' +\n'    console.log(\"üß™ SCRIPT TAG LOADED - buildBirdEyeViewUI_\");' +\n'    function showCategories() {' +\n'      // Update tab buttons' +\n'      var categoriesBtn = document.getElementById(\\'categories-tab-btn\\');' +\n'      var pathwaysBtn = document.getElementById(\\'pathways-tab-btn\\');' +\n'      if (categoriesBtn) categoriesBtn.classList.add(\\'active\\');' +\n'      if (pathwaysBtn) pathwaysBtn.classList.remove(\\'active\\');' +\n'      ' +\n'      // Update tab content' +\n'      var categoriesTab = document.getElementById(\\'categories-tab\\');' +\n'      var pathwaysTab = document.getElementById(\\'pathways-tab\\');' +\n'      if (categoriesTab) categoriesTab.style.display = \\'block\\';' +\n'      if (pathwaysTab) pathwaysTab.style.display = \\'none\\';' +\n'    }' +\n'' +\n'    function showPathways() {' +\n'      // Update tab buttons' +\n'      var categoriesBtn = document.getElementById(\\'categories-tab-btn\\');' +\n'      var pathwaysBtn = document.getElementById(\\'pathways-tab-btn\\');' +\n'      if (categoriesBtn) categoriesBtn.classList.remove(\\'active\\');' +\n'      if (pathwaysBtn) pathwaysBtn.classList.add(\\'active\\');' +\n'      ' +\n'      // Update tab content' +\n'      var categoriesTab = document.getElementById(\\'categories-tab\\');' +\n'      var pathwaysTab = document.getElementById(\\'pathways-tab\\');' +\n'      if (categoriesTab) categoriesTab.style.display = \\'none\\';' +\n'      if (pathwaysTab) pathwaysTab.style.display = \\'block\\';' +\n'    }' +\n'' +\n'    function showDiscovery() {' +\n'      // Update tab buttons' +\n'      var categoriesBtn = document.getElementById(\\'categories-tab-btn\\');' +\n'      var pathwaysBtn = document.getElementById(\\'pathways-tab-btn\\');' +\n'      var discoveryBtn = document.getElementById(\\'discovery-tab-btn\\');' +\n'      if (categoriesBtn) categoriesBtn.classList.remove(\\'active\\');' +\n'      if (pathwaysBtn) pathwaysBtn.classList.remove(\\'active\\');' +\n'      if (discoveryBtn) discoveryBtn.classList.add(\\'active\\');' +\n'      ' +\n'      // Update tab content' +\n'      var categoriesTab = document.getElementById(\\'categories-tab\\');' +\n'      var pathwaysTab = document.getElementById(\\'pathways-tab\\');' +\n'      var discoveryTab = document.getElementById(\\'discovery-tab\\');' +\n'      if (categoriesTab) categoriesTab.style.display = \\'none\\';' +\n'      if (pathwaysTab) pathwaysTab.style.display = \\'none\\';' +\n'      if (discoveryTab) discoveryTab.style.display = \\'block\\';' +\n'    }' +\n'' +\n'    function viewCategory(categoryName) {' +\n'      console.log(\"üóÇÔ∏è View category:\", categoryName);' +\n'      alert(\"Category view coming soon! Will show all \" + categoryName + \" cases.\");' +\n'    }' +\n'' +\n'    function buildPathway(pathwayId) {' +\n'      console.log(\"üéØ buildPathway called with ID:\", pathwayId);' +\n'      try {' +\n'        document.body.innerHTML = \"<div style=\\\\\"text-align:center; padding:100px;\\\\\"><h2>‚öôÔ∏è Loading chain builder...</h2><p style=\\\\\"color: #8b92a0;\\\\\">Pathway ID: \" + pathwayId + \"</p></div>\";' +\n'        console.log(\"üìû Calling google.script.run.buildChainBuilderUI\");' +\n'        google.script.run' +\n'          .withSuccessHandler(function(html) {' +\n'            console.log(\"‚úÖ buildChainBuilderUI returned successfully\");' +\n'            console.log(\"üìÑ HTML length:\", html.length);' +\n'            document.documentElement.innerHTML = html;' +\n'          })' +\n'          .withFailureHandler(function(error) {' +\n'            console.error(\"‚ùå buildChainBuilderUI failed:\", error);' +\n'            document.body.innerHTML = \"<div style=\\\\\"text-align:center; padding:100px;\\\\\"><h2 style=\\\\\"color: #ff4444;\\\\\">‚ùå Error Loading Chain Builder</h2><p style=\\\\\"color: #8b92a0;\\\\\">Error: \" + error.message + \"</p><p style=\\\\\"color: #8b92a0;\\\\\">See console for details (F12)</p></div>\";' +\n'          })' +\n'          .buildChainBuilderUI(pathwayId);' +\n'      } catch (e) {' +\n'        console.error(\"‚ùå Exception in buildPathway:\", e);' +\n'        document.body.innerHTML = \"<div style=\\\\\"text-align:center; padding:100px;\\\\\"><h2 style=\\\\\"color: #ff4444;\\\\\">‚ùå Exception</h2><p style=\\\\\"color: #8b92a0;\\\\\">Exception: \" + e.message + \"</p></div>\";' +\n'      }' +\n'    }' +\n'' +\n'    function reAnalyze() {' +\n'      if (confirm(\"Re-analyze entire case library?\\\\n\\\\nThis will invalidate the cache and take 30-60 seconds.\")) {' +\n'        document.body.innerHTML = \"<div style=\\\\\"text-align:center; padding:100px;\\\\\"><h2>‚öôÔ∏è Re-analyzing...</h2><p>Please wait...</p></div>\";' +\n'        google.script.run' +\n'          .withSuccessHandler(function() {' +\n'            google.script.host.close();' +\n'          })' +\n'          .reAnalyzeLibrary();' +\n'      }' +\n'    }' +\n\n'    ' +\n'    // AI Discovery Tab Functions' +\n'    function handleLogicTypeChange() {' +\n'      var select = document.getElementById(\\'logic-type-selector\\');' +\n'      var btn = document.getElementById(\\'discover-btn\\');' +\n'      ' +\n'      if (select.value === \\'CREATE_NEW\\') {' +\n'        alert(\\'Create New Logic Type feature coming soon!\\');' +\n'        select.value = \\'\\';' +\n'        btn.disabled = true;' +\n'      } else if (select.value) {' +\n'        btn.disabled = false;' +\n'      } else {' +\n'        btn.disabled = true;' +\n'      }' +\n'    }' +\n'    ' +\n'    function discoverPathways() {' +\n'      var logicTypeId = document.getElementById(\\'logic-type-selector\\').value;' +\n'      ' +\n'      if (!logicTypeId || logicTypeId === \\'CREATE_NEW\\') {' +\n'        alert(\\'Please select a logic type first\\');' +\n'        return;' +\n'      }' +\n'      ' +\n'      var btn = document.getElementById(\\'discover-btn\\');' +\n'      btn.disabled = true;' +\n'      btn.innerHTML = \\'<span class=\"btn-icon\">üîÑ</span><span class=\"btn-text\">Discovering...</span>\\';' +\n'      ' +\n'      google.script.run' +\n'        .withSuccessHandler(handleDiscoveryResults)' +\n'        .withFailureHandler(handleDiscoveryError)' +\n'        .discoverPathwaysWithLogicType(logicTypeId);' +\n'    }' +\n'    ' +\n'    function handleDiscoveryResults(result) {' +\n'      var btn = document.getElementById(\\'discover-btn\\');' +\n'      btn.disabled = false;' +\n'      btn.innerHTML = \\'<span class=\"btn-icon\">ü§ñ</span><span class=\"btn-text\">Discover Pathways</span>\\';' +\n'      ' +\n'      if (!result.success) {' +\n'        alert(\\'Error: \\' + result.error);' +\n'        return;' +\n'      }' +\n'      ' +\n'      var html = \\'\\';' +\n'      result.pathways.forEach(function(sp, idx) {' +\n'        var p = sp.pathway;' +\n'        var s = sp.scoring;' +\n'        var tierClass = \\'tier-\\' + s.tier.charAt(0).toLowerCase();' +\n'        ' +\n'        html += \\'<div class=\"pathway-card\">\\';' +\n'        html += \\'  <div class=\"pathway-card-header\">\\';' +\n'        html += \\'    <div class=\"pathway-name\">\\' + (idx + 1) + \\'. \\' + p.name + \\'</div>\\';' +\n'        html += \\'    <span class=\"tier-badge \\' + tierClass + \\'\">\\'  + s.tier + \\'</span>\\';' +\n'        html += \\'  </div>\\';' +\n'        html += \\'  <div class=\"pathway-description\">\\' + p.description + \\'</div>\\';' +\n'        html += \\'  <div class=\"pathway-persuasion\"><p>\"\\' + s.persuasion.persuasion_narrative + \\'\"</p></div>\\';' +\n'        html += \\'  <div class=\"pathway-meta\">\\';' +\n'        html += \\'    <div class=\"meta-item\">üìä Score: <strong>\\' + s.composite_score + \\'/10</strong></div>\\';' +\n'        html += \\'    <div class=\"meta-item\">üìö <strong>\\' + p.caseIds.length + \\'</strong> cases</div>\\';' +\n'        html += \\'    <div class=\"meta-item\">üéØ \\' + p.targetLearner + \\'</div>\\';' +\n'        html += \\'  </div>\\';' +\n'        html += \\'</div>\\';' +\n'      });' +\n'      ' +\n'      document.getElementById(\\'discovery-results-content\\').innerHTML = html;' +\n'      document.getElementById(\\'discovery-results-container\\').style.display = \\'block\\';' +\n'      document.getElementById(\\'results-title\\').textContent = result.pathwaysCount + \\' Pathways Discovered using \"\\' + result.logicType + \\'\"\\';' +\n'      ' +\n'      alert(\\'‚úÖ Discovery complete! \\' + result.pathwaysCount + \\' pathways saved to Pathways_Master sheet.\\');' +\n'    }' +\n'    ' +\n'    function handleDiscoveryError(error) {' +\n'      var btn = document.getElementById(\\'discover-btn\\');' +\n'      btn.disabled = false;' +\n'      btn.innerHTML = \\'<span class=\"btn-icon\">ü§ñ</span><span class=\"btn-text\">Discover Pathways</span>\\';' +\n'      alert(\\'Error during discovery: \\' + error.message);' +\n'    }' +\n'    ' +\n'    function clearDiscoveryResults() {' +\n'      document.getElementById(\\'discovery-results-container\\').style.display = \\'none\\';' +\n'      document.getElementById(\\'discovery-results-content\\').innerHTML = \\'\\';' +\n'    }' +\n'    ' +\n'    function viewLogicTypeLibrary() {' +\n'      google.script.run' +\n'        .withSuccessHandler(function() {' +\n'          alert(\\'Logic Type Library sheet is now active\\');' +\n'        })' +\n'        .manageLogicTypes();' +\n'    }' +\n'    ' +\n'    function viewPathwaysMaster() {' +\n'      google.script.run' +\n'        .withSuccessHandler(function() {' +\n'          alert(\\'Pathways_Master sheet is now active\\');' +\n'        })' +\n'        .viewPathwaysMaster();' +\n'    }' +\n'    ' +\n'    // Attach Discovery tab event listeners immediately (HTML already loaded)' +\n'    (function() {' +\n'      console.log(\\'üîç Attaching Discovery tab event listeners (immediate)\\');' +\n'      ' +\n'      var selector = document.getElementById(\\'logic-type-selector\\');' +\n'      if (selector) {' +\n'        console.log(\\'‚úÖ Found logic-type-selector, attaching change listener\\');' +\n'        selector.addEventListener(\\'change\\', handleLogicTypeChange);' +\n'      } else {' +\n'        console.warn(\\'‚ùå logic-type-selector not found\\');' +\n'      }' +\n'      ' +\n'      var btn = document.getElementById(\\'discover-btn\\');' +\n'      if (btn) {' +\n'        console.log(\\'‚úÖ Found discover-btn, attaching click listener\\');' +\n'        btn.addEventListener(\\'click\\', discoverPathways);' +\n'      } else {' +\n'        console.warn(\\'‚ùå discover-btn not found\\');' +\n'      }' +\n'    })();' +\n'    ' +\n'  </script>' +\n'</body>' +\n'</html>';\n}\n\n// ========== RE-ANALYZE FUNCTION ==========\n\nfunction reAnalyzeLibrary() {\n  // Force refresh of holistic analysis\n  getOrCreateHolisticAnalysis_(true);\n}\n\n// ========== LOGIC TYPE REGISTRY ==========\n\nfunction getAllLogicTypes_() {\n  return [\n    {\n      id: 'complexity_gradient',\n      name: 'Complexity Gradient',\n      icon: 'üìä',\n      description: 'Simple ‚Üí Complex progression based on diagnosis length and symptom count',\n      explanation: 'This logic type orders cases from simplest to most complex, allowing learners to build confidence with straightforward presentations before tackling multi-system cases.',\n      targetAudience: 'Medical students, new residents, general learners',\n      whenToUse: 'When building foundational knowledge and pattern recognition skills'\n    },\n    {\n      id: 'acuity_escalation',\n      name: 'Acuity Escalation',\n      icon: 'üö®',\n      description: 'Stable ‚Üí Critical based on vital signs severity and time-sensitivity',\n      explanation: 'Orders cases from stable presentations to life-threatening emergencies, teaching triage prioritization and escalation recognition.',\n      targetAudience: 'ER residents, triage nurses, emergency responders',\n      whenToUse: 'When teaching emergency prioritization and critical decision-making under pressure'\n    },\n    {\n      id: 'diagnostic_mimicry',\n      name: 'Diagnostic Mimicry',\n      icon: 'üé≠',\n      description: 'Similar presentations with different diagnoses - teaches differential reasoning',\n      explanation: 'Groups cases with similar chief complaints but different underlying diagnoses, forcing learners to differentiate between look-alike conditions.',\n      targetAudience: 'Advanced students, residents preparing for boards, diagnosticians',\n      whenToUse: 'When teaching differential diagnosis and avoiding cognitive anchoring bias'\n    },\n    {\n      id: 'protocol_mastery',\n      name: 'Protocol Mastery',\n      icon: 'üìã',\n      description: 'Algorithm-driven sequence (ACLS, ATLS, PALS protocols)',\n      explanation: 'Follows established clinical protocols step-by-step, reinforcing algorithmic decision trees and standardized care pathways.',\n      targetAudience: 'Certification candidates (ACLS/ATLS/PALS), protocol-driven teams',\n      whenToUse: 'When preparing for certification exams or standardizing team responses'\n    },\n    {\n      id: 'organ_system_journey',\n      name: 'Organ System Journey',\n      icon: 'ü´Ä',\n      description: 'Deep dive into single system (Cardiology, Neurology, etc.)',\n      explanation: 'Focuses exclusively on one organ system, progressing through all severity levels and subtypes within that specialty.',\n      targetAudience: 'Specialty residents, fellows, focused learners',\n      whenToUse: 'When developing deep expertise in a specific medical specialty'\n    },\n    {\n      id: 'age_spectrum',\n      name: 'Age Spectrum',\n      icon: 'üë∂üë¥',\n      description: 'Pediatric ‚Üí Geriatric presentations of similar conditions',\n      explanation: 'Shows how the same condition presents differently across age groups, teaching age-specific assessment and treatment modifications.',\n      targetAudience: 'Family medicine, pediatricians, geriatricians',\n      whenToUse: 'When teaching lifespan considerations and age-adapted care'\n    },\n    {\n      id: 'rare_zebras',\n      name: 'Rare Zebras',\n      icon: 'ü¶ì',\n      description: 'Uncommon diagnoses that mimic common conditions',\n      explanation: 'Highlights rare but important diagnoses that can be missed, teaching \"when to think zebra not horse.\"',\n      targetAudience: 'Experienced clinicians, academic medicine, diagnosticians',\n      whenToUse: 'When teaching pattern interruption and avoiding premature closure'\n    },\n    {\n      id: 'comorbidity_complexity',\n      name: 'Comorbidity Complexity',\n      icon: 'üß©',\n      description: 'Single-system ‚Üí Multi-system with medication interactions',\n      explanation: 'Progressively adds comorbidities and polypharmacy, teaching complex patient management and interaction awareness.',\n      targetAudience: 'Internists, hospitalists, chronic disease managers',\n      whenToUse: 'When teaching management of medically complex patients'\n    },\n    {\n      id: 'time_pressure',\n      name: 'Time-Pressure Triage',\n      icon: '‚è±Ô∏è',\n      description: 'Door-to-decision time constraints (minutes ‚Üí hours)',\n      explanation: 'Orders cases by acceptable decision timeframe, teaching when rapid action is critical versus when observation is safe.',\n      targetAudience: 'ER physicians, trauma teams, acute care providers',\n      whenToUse: 'When teaching time-critical decision making and triage skills'\n    },\n    {\n      id: 'cognitive_traps',\n      name: 'Cognitive Trap Awareness',\n      icon: 'üß†',\n      description: 'Cases designed to expose common diagnostic biases',\n      explanation: 'Presents cases that trigger anchoring, availability, confirmation bias - then reveals the correct diagnosis to teach metacognition.',\n      targetAudience: 'All levels - teaches self-awareness and bias recognition',\n      whenToUse: 'When teaching clinical reasoning and diagnostic error prevention'\n    },\n    {\n      id: 'resource_constrained',\n      name: 'Resource-Constrained Care',\n      icon: 'üèïÔ∏è',\n      description: 'Full-resource ‚Üí Limited-resource management',\n      explanation: 'Shows how to adapt diagnosis and treatment when advanced imaging, labs, or specialists are unavailable.',\n      targetAudience: 'Rural providers, austere medicine, international health workers',\n      whenToUse: 'When teaching clinical reasoning without high-tech dependencies'\n    },\n    {\n      id: 'handoff_continuity',\n      name: 'Handoff & Continuity',\n      icon: 'üîÑ',\n      description: 'Cases that span multiple shifts and care transitions',\n      explanation: 'Teaches safe handoffs, information synthesis across time, and recognizing evolving presentations.',\n      targetAudience: 'Hospitalists, shift workers, care coordinators',\n      whenToUse: 'When teaching communication and longitudinal thinking'\n    }\n  ];\n}\n\nfunction getLogicTypeById_(logicTypeId) {\n  const allTypes = getAllLogicTypes_();\n  for (let i = 0; i < allTypes.length; i++) {\n    if (allTypes[i].id === logicTypeId) {\n      return allTypes[i];\n    }\n  }\n  return allTypes[0]; // Default to complexity_gradient\n}\n\nfunction sortByLogicType_(cases, logicTypeId) {\n  switch(logicTypeId) {\n    case 'complexity_gradient':\n      // Simple ‚Üí Complex (by diagnosis length)\n      cases.sort(function(a, b) {\n        return a.diagnosis.length - b.diagnosis.length;\n      });\n      break;\n\n    case 'acuity_escalation':\n      // Stable ‚Üí Critical (by diagnosis severity keywords)\n      cases.sort(function(a, b) {\n        const acuityA = getAcuityScore_(a.diagnosis + ' ' + a.sparkTitle);\n        const acuityB = getAcuityScore_(b.diagnosis + ' ' + b.sparkTitle);\n        return acuityA - acuityB;\n      });\n      break;\n\n    case 'diagnostic_mimicry':\n      // Group by similar chief complaints (first word of spark title)\n      cases.sort(function(a, b) {\n        const chiefA = a.sparkTitle.split(' ')[0].toUpperCase();\n        const chiefB = b.sparkTitle.split(' ')[0].toUpperCase();\n        if (chiefA === chiefB) {\n          return a.diagnosis.length - b.diagnosis.length; // Within group, simple ‚Üí complex\n        }\n        return chiefA.localeCompare(chiefB);\n      });\n      break;\n\n    case 'protocol_mastery':\n      // Protocol order (ACLS: VFib ‚Üí VTach ‚Üí Asystole ‚Üí PEA)\n      cases.sort(function(a, b) {\n        const protocolA = getProtocolPriority_(a.diagnosis);\n        const protocolB = getProtocolPriority_(b.diagnosis);\n        return protocolA - protocolB;\n      });\n      break;\n\n    case 'organ_system_journey':\n      // Group by system, then severity within system\n      cases.sort(function(a, b) {\n        if (a.category === b.category) {\n          return a.diagnosis.length - b.diagnosis.length;\n        }\n        return a.category.localeCompare(b.category);\n      });\n      break;\n\n    case 'age_spectrum':\n      // Pediatric ‚Üí Adult ‚Üí Geriatric (by age keywords in diagnosis/spark)\n      cases.sort(function(a, b) {\n        const ageA = getAgeCategory_(a.diagnosis + ' ' + a.sparkTitle);\n        const ageB = getAgeCategory_(b.diagnosis + ' ' + b.sparkTitle);\n        return ageA - ageB;\n      });\n      break;\n\n    case 'rare_zebras':\n      // Rare/uncommon diagnoses first (by rarity keywords)\n      cases.sort(function(a, b) {\n        const rarityA = getRarityScore_(a.diagnosis);\n        const rarityB = getRarityScore_(b.diagnosis);\n        return rarityB - rarityA; // Descending (rare first)\n      });\n      break;\n\n    case 'comorbidity_complexity':\n      // Single-system ‚Üí Multi-system (count commas, \"and\", \"&\")\n      cases.sort(function(a, b) {\n        const comorbidA = getComorbidityCount_(a.diagnosis);\n        const comorbidB = getComorbidityCount_(b.diagnosis);\n        return comorbidA - comorbidB;\n      });\n      break;\n\n    case 'time_pressure':\n      // By urgency (minutes ‚Üí hours ‚Üí days)\n      cases.sort(function(a, b) {\n        const urgencyA = getTimeUrgency_(a.diagnosis + ' ' + a.sparkTitle);\n        const urgencyB = getTimeUrgency_(b.diagnosis + ' ' + a.sparkTitle);\n        return urgencyB - urgencyA; // Descending (most urgent first)\n      });\n      break;\n\n    case 'cognitive_traps':\n      // Cases likely to trigger bias (by keywords like \"classic\", \"typical\")\n      cases.sort(function(a, b) {\n        const trapA = getCognitiveTrapScore_(a.diagnosis + ' ' + a.sparkTitle);\n        const trapB = getCognitiveTrapScore_(b.diagnosis + ' ' + b.sparkTitle);\n        return trapB - trapA;\n      });\n      break;\n\n    case 'resource_constrained':\n      // Full resource ‚Üí Limited resource (by diagnostic dependency)\n      cases.sort(function(a, b) {\n        const resourceA = getResourceDependency_(a.diagnosis);\n        const resourceB = getResourceDependency_(b.diagnosis);\n        return resourceB - resourceA; // High-resource first, then low-resource\n      });\n      break;\n\n    case 'handoff_continuity':\n      // Cases that evolve over time (keywords: \"progressive\", \"evolving\")\n      cases.sort(function(a, b) {\n        const evolutionA = getEvolutionScore_(a.diagnosis + ' ' + a.sparkTitle);\n        const evolutionB = getEvolutionScore_(b.diagnosis + ' ' + b.sparkTitle);\n        return evolutionB - evolutionA;\n      });\n      break;\n\n    default:\n      // Fallback to complexity gradient\n      cases.sort(function(a, b) {\n        return a.diagnosis.length - b.diagnosis.length;\n      });\n  }\n}\n\n// Helper scoring functions for logic types\nfunction getAcuityScore_(text) {\n  const criticalWords = ['arrest', 'shock', 'hemorrhage', 'stroke', 'mi', 'infarction', 'critical', 'severe'];\n  const urgentWords = ['acute', 'emergency', 'unstable', 'crisis'];\n  let score = 0;\n  const upper = text.toUpperCase();\n  for (let i = 0; i < criticalWords.length; i++) {\n    if (upper.indexOf(criticalWords[i].toUpperCase()) !== -1) score += 3;\n  }\n  for (let i = 0; i < urgentWords.length; i++) {\n    if (upper.indexOf(urgentWords[i].toUpperCase()) !== -1) score += 1;\n  }\n  return score;\n}\n\nfunction getProtocolPriority_(diagnosis) {\n  const upper = diagnosis.toUpperCase();\n  if (upper.indexOf('VFIB') !== -1 || upper.indexOf('V FIB') !== -1) return 1;\n  if (upper.indexOf('VTACH') !== -1 || upper.indexOf('V TACH') !== -1) return 2;\n  if (upper.indexOf('ASYSTOLE') !== -1) return 3;\n  if (upper.indexOf('PEA') !== -1) return 4;\n  if (upper.indexOf('BRADYCARD') !== -1) return 5;\n  if (upper.indexOf('SVT') !== -1 || upper.indexOf('TACHYCARD') !== -1) return 6;\n  return 7;\n}\n\nfunction getAgeCategory_(text) {\n  const upper = text.toUpperCase();\n  if (upper.indexOf('PEDIATRIC') !== -1 || upper.indexOf('CHILD') !== -1 || upper.indexOf('INFANT') !== -1) return 1;\n  if (upper.indexOf('ADOLESCENT') !== -1 || upper.indexOf('TEEN') !== -1) return 2;\n  if (upper.indexOf('GERIATRIC') !== -1 || upper.indexOf('ELDERLY') !== -1 || upper.indexOf('SENIOR') !== -1) return 4;\n  return 3; // Adult default\n}\n\nfunction getRarityScore_(diagnosis) {\n  const rareWords = ['rare', 'uncommon', 'unusual', 'atypical', 'zebra'];\n  let score = 0;\n  const upper = diagnosis.toUpperCase();\n  for (let i = 0; i < rareWords.length; i++) {\n    if (upper.indexOf(rareWords[i].toUpperCase()) !== -1) score += 2;\n  }\n  return score;\n}\n\nfunction getComorbidityCount_(diagnosis) {\n  let count = 0;\n  count += (diagnosis.match(/,/g) || []).length;\n  count += (diagnosis.match(/\\band\\b/gi) || []).length;\n  count += (diagnosis.match(/\\bwith\\b/gi) || []).length;\n  count += (diagnosis.match(/&/g) || []).length;\n  return count;\n}\n\nfunction getTimeUrgency_(text) {\n  const immediateWords = ['emergent', 'stat', 'immediate', 'critical', 'arrest'];\n  const urgentWords = ['urgent', 'acute', 'minutes'];\n  let score = 0;\n  const upper = text.toUpperCase();\n  for (let i = 0; i < immediateWords.length; i++) {\n    if (upper.indexOf(immediateWords[i].toUpperCase()) !== -1) score += 3;\n  }\n  for (let i = 0; i < urgentWords.length; i++) {\n    if (upper.indexOf(urgentWords[i].toUpperCase()) !== -1) score += 1;\n  }\n  return score;\n}\n\nfunction getCognitiveTrapScore_(text) {\n  const trapWords = ['classic', 'typical', 'textbook', 'obvious', 'clear'];\n  let score = 0;\n  const upper = text.toUpperCase();\n  for (let i = 0; i < trapWords.length; i++) {\n    if (upper.indexOf(trapWords[i].toUpperCase()) !== -1) score += 1;\n  }\n  return score;\n}\n\nfunction getResourceDependency_(diagnosis) {\n  const highResourceWords = ['ct', 'mri', 'angiography', 'catheterization', 'specialist'];\n  let score = 0;\n  const upper = diagnosis.toUpperCase();\n  for (let i = 0; i < highResourceWords.length; i++) {\n    if (upper.indexOf(highResourceWords[i].toUpperCase()) !== -1) score += 1;\n  }\n  return score;\n}\n\nfunction getEvolutionScore_(text) {\n  const evolutionWords = ['progressive', 'evolving', 'worsening', 'deteriorating', 'chronic'];\n  let score = 0;\n  const upper = text.toUpperCase();\n  for (let i = 0; i < evolutionWords.length; i++) {\n    if (upper.indexOf(evolutionWords[i].toUpperCase()) !== -1) score += 1;\n  }\n  return score;\n}\n\n// ========== AI-POWERED LOGIC TYPE GENERATION ==========\n\nfunction generateLogicTypeWithAI(pathwayId) {\n  Logger.log('ü§ñ AI generating new logic type for pathway: ' + pathwayId);\n\n  try {\n    const analysis = getOrCreateHolisticAnalysis_();\n\n    // Find the pathway\n    let pathway = null;\n    for (let i = 0; i < analysis.topPathways.length; i++) {\n      if (analysis.topPathways[i].id === pathwayId) {\n        pathway = analysis.topPathways[i];\n        break;\n      }\n    }\n\n    if (!pathway) {\n      throw new Error('Pathway not found: ' + pathwayId);\n    }\n\n    // Get cases for this pathway\n    const pathwayCases = [];\n    for (let i = 0; i < analysis.allCases.length; i++) {\n      for (let j = 0; j < pathway.suggestedCases.length; j++) {\n        if (analysis.allCases[i].caseId === pathway.suggestedCases[j]) {\n          pathwayCases.push(analysis.allCases[i]);\n          break;\n        }\n      }\n    }\n\n    // Create context for ChatGPT\n    const casesSummary = pathwayCases.map(function(c) {\n      return c.caseId + ': ' + c.sparkTitle + ' | ' + c.diagnosis;\n    }).join('\\\\n');\n\n    const existingLogicTypes = getAllLogicTypes_().map(function(lt) {\n      return lt.name + ': ' + lt.description;\n    }).join('\\\\n');\n\n    const prompt = 'You are an expert medical educator analyzing a case library for pathway building.\\\\n\\\\n' +\n      'PATHWAY: ' + pathway.name + '\\\\n' +\n      'CASES (' + pathwayCases.length + ' total):\\\\n' + casesSummary + '\\\\n\\\\n' +\n      'EXISTING LOGIC TYPES:\\\\n' + existingLogicTypes + '\\\\n\\\\n' +\n      'Task: Analyze these cases and suggest ONE innovative logic type for ordering them that is DIFFERENT from the existing types. ' +\n      'Consider unique pedagogical approaches, clinical reasoning patterns, or educational objectives that aren\\'t covered yet.\\\\n\\\\n' +\n      'Respond ONLY with valid JSON in this exact format:\\\\n' +\n      '{\\\\n' +\n      '  \"id\": \"ai_generated_[unique_slug]\",\\\\n' +\n      '  \"name\": \"Your Logic Type Name\",\\\\n' +\n      '  \"icon\": \"üìå\",\\\\n' +\n      '  \"description\": \"Brief one-line description\",\\\\n' +\n      '  \"explanation\": \"Detailed explanation of how this orders cases and why it\\'s valuable\",\\\\n' +\n      '  \"targetAudience\": \"Who should use this approach\",\\\\n' +\n      '  \"whenToUse\": \"When this approach is most appropriate\",\\\\n' +\n      '  \"sortingCriteria\": \"Detailed instructions for how to sort cases (e.g., analyze X, then prioritize by Y)\"\\\\n' +\n      '}';\n\n    // Get OpenAI API key from Settings sheet cell B2\n    const ss = SpreadsheetApp.getActiveSpreadsheet();\n    const settingsSheet = ss.getSheetByName('Settings');\n    let apiKey = '';\n\n    if (settingsSheet) {\n      apiKey = settingsSheet.getRange('B2').getValue();\n      Logger.log('üîë Retrieved API key from Settings!B2');\n    }\n\n    if (!apiKey) {\n      // Return demo logic type if no API key\n      Logger.log('‚ö†Ô∏è No OpenAI API key found in Settings!B2, returning demo logic type');\n      return {\n        id: 'ai_demo_' + new Date().getTime(),\n        name: 'Misdiagnosis Risk Gradient',\n        icon: '‚ö†Ô∏è',\n        description: 'Orders cases by likelihood of misdiagnosis - from commonly missed to obvious',\n        explanation: 'This AI-generated logic type analyzes cases for cognitive bias triggers, atypical presentations, and diagnostic pitfalls. Cases with high misdiagnosis risk come first to train pattern interruption, while clear-cut cases come last.',\n        targetAudience: 'Advanced practitioners, quality improvement teams, patient safety officers',\n        whenToUse: 'When teaching diagnostic error prevention and developing meta-cognitive awareness',\n        sortingCriteria: 'Analyze diagnosis complexity, symptom overlap with common conditions, and presence of red herrings'\n      };\n    }\n\n    const response = UrlFetchApp.fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'post',\n      contentType: 'application/json',\n      headers: {\n        'Authorization': 'Bearer ' + apiKey\n      },\n      payload: JSON.stringify({\n        model: 'gpt-4',\n        messages: [\n          { role: 'system', content: 'You are an expert medical educator who designs innovative case sequencing logic.' },\n          { role: 'user', content: prompt }\n        ],\n        temperature: 0.8,\n        max_tokens: 500\n      })\n    });\n\n    const result = JSON.parse(response.getContentText());\n    const aiResponse = result.choices[0].message.content;\n\n    // Parse JSON from AI response\n    const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n    if (!jsonMatch) {\n      throw new Error('AI did not return valid JSON');\n    }\n\n    const newLogicType = JSON.parse(jsonMatch[0]);\n    Logger.log('‚úÖ AI generated logic type: ' + newLogicType.name);\n\n    return newLogicType;\n\n  } catch (error) {\n    Logger.log('‚ùå Error generating logic type with AI: ' + error.toString());\n    throw error;\n  }\n}\n\nfunction interpretCustomLogicDescription(description, pathwayId) {\n  Logger.log('‚ú® Interpreting custom logic description: ' + description);\n\n  try {\n    const analysis = getOrCreateHolisticAnalysis_();\n\n    // Find the pathway\n    let pathway = null;\n    for (let i = 0; i < analysis.topPathways.length; i++) {\n      if (analysis.topPathways[i].id === pathwayId) {\n        pathway = analysis.topPathways[i];\n        break;\n      }\n    }\n\n    const prompt = 'Convert this user\\'s logic type idea into a structured logic type definition:\\\\n\\\\n' +\n      'User Input: \"' + description + '\"\\\\n\\\\n' +\n      'Respond ONLY with valid JSON in this exact format:\\\\n' +\n      '{\\\\n' +\n      '  \"id\": \"custom_[unique_slug_based_on_description]\",\\\\n' +\n      '  \"name\": \"Clear Name for This Logic\",\\\\n' +\n      '  \"icon\": \"üìå\",\\\\n' +\n      '  \"description\": \"Brief one-line description\",\\\\n' +\n      '  \"explanation\": \"How this orders cases and why\",\\\\n' +\n      '  \"targetAudience\": \"Who should use this\",\\\\n' +\n      '  \"whenToUse\": \"When to use this approach\",\\\\n' +\n      '  \"sortingCriteria\": \"Detailed sorting instructions\"\\\\n' +\n      '}';\n\n    // Get OpenAI API key from Settings sheet cell B2\n    const ss = SpreadsheetApp.getActiveSpreadsheet();\n    const settingsSheet = ss.getSheetByName('Settings');\n    let apiKey = '';\n\n    if (settingsSheet) {\n      apiKey = settingsSheet.getRange('B2').getValue();\n      Logger.log('üîë Retrieved API key from Settings!B2');\n    }\n\n    if (!apiKey) {\n      // Create basic custom logic type without AI\n      Logger.log('‚ö†Ô∏è No OpenAI API key found in Settings!B2, creating basic custom logic type');\n      const slug = description.toLowerCase().replace(/[^a-z0-9]+/g, '_').substring(0, 30);\n      return {\n        id: 'custom_' + slug + '_' + new Date().getTime(),\n        name: description.substring(0, 50),\n        icon: '‚ú®',\n        description: description,\n        explanation: 'Custom ordering logic: ' + description,\n        targetAudience: 'Custom use case',\n        whenToUse: 'When ' + description.toLowerCase(),\n        sortingCriteria: 'Cases ordered according to: ' + description\n      };\n    }\n\n    const response = UrlFetchApp.fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'post',\n      contentType: 'application/json',\n      headers: {\n        'Authorization': 'Bearer ' + apiKey\n      },\n      payload: JSON.stringify({\n        model: 'gpt-4',\n        messages: [\n          { role: 'system', content: 'You convert user ideas into structured logic type definitions.' },\n          { role: 'user', content: prompt }\n        ],\n        temperature: 0.7,\n        max_tokens: 400\n      })\n    });\n\n    const result = JSON.parse(response.getContentText());\n    const aiResponse = result.choices[0].message.content;\n\n    const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n    const customLogicType = JSON.parse(jsonMatch[0]);\n\n    Logger.log('‚úÖ Custom logic type created: ' + customLogicType.name);\n    return customLogicType;\n\n  } catch (error) {\n    Logger.log('‚ùå Error interpreting custom logic: ' + error.toString());\n    throw error;\n  }\n}\n\nfunction applyDynamicLogicType(pathwayId, logicType) {\n  Logger.log('üîÑ Applying dynamic logic type: ' + logicType.name + ' to pathway: ' + pathwayId);\n\n  // This function will use the sortingCriteria from the logic type\n  // For now, we'll use complexity gradient as fallback, but you can extend this\n  // to interpret the sorting Criteria using AI or custom rules\n\n  return buildChainBuilderUI(pathwayId, 'complexity_gradient');\n}\n\nfunction saveCustomLogicType(logicType) {\n  Logger.log('üíæ Saving custom logic type: ' + logicType.name);\n\n  try {\n    const ss = SpreadsheetApp.getActiveSpreadsheet();\n    let customLogicSheet = ss.getSheetByName('Custom_Logic_Types');\n\n    // Create sheet if it doesn't exist\n    if (!customLogicSheet) {\n      customLogicSheet = ss.insertSheet('Custom_Logic_Types');\n      customLogicSheet.appendRow(['ID', 'Name', 'Icon', 'Description', 'Explanation', 'Target Audience', 'When To Use', 'Sorting Criteria', 'Created']);\n    }\n\n    // Add the custom logic type\n    customLogicSheet.appendRow([\n      logicType.id,\n      logicType.name,\n      logicType.icon,\n      logicType.description,\n      logicType.explanation,\n      logicType.targetAudience,\n      logicType.whenToUse,\n      logicType.sortingCriteria || '',\n      new Date().toISOString()\n    ]);\n\n    Logger.log('‚úÖ Custom logic type saved to sheet');\n\n  } catch (error) {\n    Logger.log('‚ùå Error saving custom logic type: ' + error.toString());\n    throw error;\n  }\n}\n\n// ========== PHASE 2B: HORIZONTAL CHAIN BUILDER ==========\n\nfunction buildChainBuilderUI(pathwayId, logicTypeId) {\n  // Default to complexity_gradient if not specified\n  if (!logicTypeId) {\n    logicTypeId = 'complexity_gradient';\n  }\n  Logger.log('üéØ buildChainBuilderUI called with pathwayId: ' + pathwayId);\n\n  try {\n    const analysis = getOrCreateHolisticAnalysis_();\n    Logger.log('üìä Got analysis with ' + analysis.topPathways.length + ' pathways');\n\n    // Find the pathway from analysis\n    let pathway = null;\n    for (let i = 0; i < analysis.topPathways.length; i++) {\n      Logger.log('  Checking pathway: ' + analysis.topPathways[i].id + ' (looking for: ' + pathwayId + ')');\n      if (analysis.topPathways[i].id === pathwayId) {\n        pathway = analysis.topPathways[i];\n        Logger.log('  ‚úÖ Found matching pathway: ' + pathway.name);\n        break;\n      }\n    }\n\n    if (!pathway) {\n      Logger.log('‚ùå Pathway not found: ' + pathwayId);\n      Logger.log('Available pathway IDs: ' + analysis.topPathways.map(function(p) { return p.id; }).join(', '));\n      return '<html><body style=\"font-family: system-ui; padding: 40px; text-align: center;\"><h2>Pathway not found</h2><p>ID: ' + pathwayId + '</p><p>Available IDs: ' + analysis.topPathways.map(function(p) { return p.id; }).join(', ') + '</p></body></html>';\n    }\n\n    Logger.log('üî® Building initial chain with logic type: ' + logicTypeId);\n    // Build initial chain with suggested cases using selected logic type\n    const logicType = getLogicTypeById_(logicTypeId);\n    const initialChain = buildInitialChain_(pathway, analysis.allCases, logicTypeId);\n    Logger.log('‚úÖ Built chain with ' + initialChain.length + ' positions');\n\n    Logger.log('üé® Building HTML...');\n    const html = buildChainBuilderHTML_(pathway, initialChain, logicType);\n    Logger.log('‚úÖ HTML built, length: ' + html.length + ' chars');\n\n    return html;\n  } catch (e) {\n    Logger.log('‚ùå Exception in buildChainBuilderUI: ' + e.message);\n    Logger.log('Stack trace: ' + e.stack);\n    return '<html><body style=\"font-family: system-ui; padding: 40px; text-align: center;\"><h2 style=\"color: #ff4444;\">Error</h2><p>' + e.message + '</p><pre style=\"text-align: left; background: #f5f5f5; padding: 20px; border-radius: 8px;\">' + e.stack + '</pre></body></html>';\n  }\n}\n\nfunction buildInitialChain_(pathway, allCases, logicTypeId) {\n  // Get cases for this pathway\n  const pathwayCases = [];\n  for (let i = 0; i < allCases.length; i++) {\n    for (let j = 0; j < pathway.suggestedCases.length; j++) {\n      if (allCases[i].caseId === pathway.suggestedCases[j]) {\n        pathwayCases.push(allCases[i]);\n        break;\n      }\n    }\n  }\n\n  // Sort based on logic type\n  sortByLogicType_(pathwayCases, logicTypeId || 'complexity_gradient');\n\n  // Build chain: first 10 cases as positions, rest as alternatives\n  const chain = [];\n  const maxPositions = Math.min(10, pathwayCases.length);\n\n  for (let i = 0; i < maxPositions; i++) {\n    const caseData = pathwayCases[i];\n    const position = {\n      position: i + 1,\n      primary: caseData,\n      alternatives: [],\n      rationale: generatePositionRationale_(i + 1, caseData, pathwayCases, pathway)\n    };\n\n    // Add 3 alternatives (or fewer if not enough cases)\n    const alternativeStartIndex = maxPositions;\n    for (let j = 0; j < 3 && (alternativeStartIndex + j) < pathwayCases.length; j++) {\n      position.alternatives.push(pathwayCases[alternativeStartIndex + j]);\n    }\n\n    chain.push(position);\n  }\n\n  return chain;\n}\n\nfunction generatePositionRationale_(position, caseData, allCases, pathway) {\n  const totalPositions = Math.min(10, allCases.length);\n  const diagnosisLength = caseData.diagnosis.length;\n  const sparkTitle = caseData.sparkTitle;\n\n  // Position-based pedagogical reasoning\n  if (position === 1) {\n    return 'üéØ Foundation: Clear presentation with straightforward diagnosis - builds confidence and establishes pattern recognition baseline';\n  } else if (position === 2) {\n    return 'üìö Early Learning: Slightly more complex than opener - introduces key concepts while maintaining accessibility';\n  } else if (position === 3) {\n    return 'üîÑ Pattern Building: Familiar symptoms with subtle variation - reinforces recognition while adding nuance';\n  } else if (position <= Math.ceil(totalPositions * 0.4)) {\n    return 'üß© Skill Development: Moderate complexity - challenges learner to apply foundational knowledge in new contexts';\n  } else if (position <= Math.ceil(totalPositions * 0.6)) {\n    return '‚ö° Critical Thinking: Intermediate difficulty - requires synthesis of multiple concepts and differential diagnosis';\n  } else if (position <= Math.ceil(totalPositions * 0.8)) {\n    return 'üéì Advanced Application: Complex presentation - tests mastery through atypical symptoms or comorbidities';\n  } else if (position === totalPositions) {\n    return 'üèÜ Mastery Challenge: Most complex case - demonstrates full competency through comprehensive clinical reasoning';\n  } else {\n    return 'üí° Advanced Integration: High complexity - requires expert-level pattern recognition and multi-system thinking';\n  }\n}\n\nfunction buildChainBuilderHTML_(pathway, chain, logicType) {\n  // Build logic type dropdown options\n  const allLogicTypes = getAllLogicTypes_();\n  const logicTypeOptionsHTML = allLogicTypes.map(function(lt) {\n    const selected = lt.id === logicType.id ? 'selected' : '';\n    return '<option value=\"' + lt.id + '\" ' + selected + '>' + lt.icon + ' ' + lt.name + '</option>';\n  }).join('');\n\n  const chainPositionsHTML = chain.map(function(pos) {\n    const primaryHTML =\n      '<div class=\"case-primary\" data-case-id=\"' + pos.primary.caseId + '\" data-position=\"' + pos.position + '\" data-rationale=\"' + pos.rationale.replace(/\"/g, '&quot;') + '\">' +\n      '  <div class=\"case-header\">' +\n      '    <span class=\"case-id\">' + pos.primary.caseId + '</span>' +\n      '    <span class=\"case-row\">Row ' + pos.primary.row + '</span>' +\n      '  </div>' +\n      '  <div class=\"case-title\">' + pos.primary.sparkTitle + '</div>' +\n      '  <div class=\"case-diagnosis\">Dx: ' + ((pos.primary.diagnosis || '').substring(0, 30) + ((pos.primary.diagnosis || '').length > 30 ? '...' : '')) + '</div>' +\n      '  <div class=\"case-learning\">Learning: ' + ((pos.primary.learningOutcomes || '').substring(0, 40) + ((pos.primary.learningOutcomes || '').length > 40 ? '...' : '')) + '</div>' +\n      '  <div class=\"case-rationale\">' + pos.rationale + '</div>' +\n      '</div>';\n\n    const alternativesHTML = pos.alternatives.map(function(alt) {\n      return '<div class=\"case-alternative\" data-case-id=\"' + alt.caseId + '\" onclick=\"swapCase(' + pos.position + ', \\'' + alt.caseId + '\\')\">' +\n             '  <div class=\"alt-title\">' + alt.sparkTitle.substring(0, 40) + (alt.sparkTitle.length > 40 ? '...' : '') + '</div>' +\n             '  <div class=\"alt-id\">' + alt.caseId + '</div>' +\n             '</div>';\n    }).join('');\n\n    return '<div class=\"chain-position\" data-position=\"' + pos.position + '\">' +\n           primaryHTML +\n           '  <div class=\"case-alternatives\">' +\n           alternativesHTML +\n           '  </div>' +\n           '</div>';\n  }).join('<div class=\"chain-arrow\">‚Üí</div>');\n\n  return '<!DOCTYPE html>' +\n'<html>' +\n'<head>' +\n'  <base target=\"_top\">' +\n'  <style>' +\n'    * { margin: 0; padding: 0; box-sizing: border-box; }' +\n'' +\n'    body {' +\n'      font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Arial, sans-serif;' +\n'      background: linear-gradient(135deg, #0f1115 0%, #1a1d26 100%);' +\n'      color: #e7eaf0;' +\n'      overflow-x: hidden;' +\n'      height: 1000px;' +\n'    }' +\n'' +\n'    .header {' +\n'      background: linear-gradient(135deg, #1b1f2a 0%, #141824 100%);' +\n'      padding: 20px 32px;' +\n'      border-bottom: 2px solid #2a3040;' +\n'      display: flex;' +\n'      justify-content: space-between;' +\n'      align-items: center;' +\n'    }' +\n'' +\n'    .header-left {' +\n'      display: flex;' +\n'      align-items: center;' +\n'      gap: 16px;' +\n'    }' +\n'' +\n'    .btn-back {' +\n'      background: #141824;' +\n'      border: 1px solid #2a3040;' +\n'      color: #e7eaf0;' +\n'      padding: 10px 16px;' +\n'      border-radius: 8px;' +\n'      cursor: pointer;' +\n'      font-size: 14px;' +\n'      font-weight: 600;' +\n'      transition: all 0.2s;' +\n'    }' +\n'' +\n'    .btn-back:hover {' +\n'      background: #1b1f2a;' +\n'      border-color: #3a4458;' +\n'    }' +\n'' +\n'    .pathway-info h1 {' +\n'      font-size: 24px;' +\n'      font-weight: 700;' +\n'      margin-bottom: 4px;' +\n'    }' +\n'' +\n'    .pathway-info .meta {' +\n'      font-size: 13px;' +\n'      color: #8b92a0;' +\n'    }' +\n'' +\n'    .header-right {' +\n'      display: flex;' +\n'      gap: 12px;' +\n'    }' +\n'' +\n'    .btn-save {' +\n'      background: linear-gradient(135deg, #2357ff 0%, #1a47d9 100%);' +\n'      border: none;' +\n'      color: #fff;' +\n'      padding: 10px 20px;' +\n'      border-radius: 8px;' +\n'      cursor: pointer;' +\n'      font-size: 14px;' +\n'      font-weight: 600;' +\n'      transition: all 0.2s;' +\n'    }' +\n'' +\n'    .btn-save:hover {' +\n'      background: linear-gradient(135deg, #1a47d9 0%, #1538b8 100%);' +\n'      transform: translateY(-1px);' +\n'    }' +\n'' +\n'    /* Logic Type Selector */' +\n'    .logic-type-bar {' +\n'      background: #0f1115;' +\n'      border-bottom: 1px solid #2a3040;' +\n'      padding: 16px 32px;' +\n'      display: flex;' +\n'      gap: 20px;' +\n'      align-items: flex-start;' +\n'    }' +\n'' +\n'    .logic-type-selector {' +\n'      display: flex;' +\n'      flex-direction: column;' +\n'      gap: 8px;' +\n'      min-width: 320px;' +\n'    }' +\n'' +\n'    .logic-type-label {' +\n'      font-size: 12px;' +\n'      font-weight: 600;' +\n'      color: #8b92a0;' +\n'      text-transform: uppercase;' +\n'      letter-spacing: 0.5px;' +\n'    }' +\n'' +\n'    .logic-type-dropdown {' +\n'      background: #141824;' +\n'      border: 1px solid #2a3040;' +\n'      color: #e7eaf0;' +\n'      padding: 10px 14px;' +\n'      border-radius: 8px;' +\n'      font-size: 14px;' +\n'      font-weight: 600;' +\n'      cursor: pointer;' +\n'      transition: all 0.2s;' +\n'      appearance: none;' +\n'      background-image: url(\"data:image/svg+xml,%3Csvg width=\\'12\\' height=\\'8\\' viewBox=\\'0 0 12 8\\' fill=\\'none\\' xmlns=\\'http://www.w3.org/2000/svg\\'%3E%3Cpath d=\\'M1 1L6 6L11 1\\' stroke=\\'%238b92a0\\' stroke-width=\\'2\\' stroke-linecap=\\'round\\'/%3E%3C/svg%3E\");' +\n'      background-repeat: no-repeat;' +\n'      background-position: right 12px center;' +\n'      padding-right: 36px;' +\n'    }' +\n'' +\n'    .logic-type-dropdown:hover {' +\n'      background: #1b1f2a;' +\n'      border-color: #3a4458;' +\n'    }' +\n'' +\n'    .logic-type-dropdown:focus {' +\n'      outline: none;' +\n'      border-color: #2357ff;' +\n'      box-shadow: 0 0 0 3px rgba(35, 87, 255, 0.1);' +\n'    }' +\n'' +\n'    .logic-type-explanation {' +\n'      flex: 1;' +\n'      background: linear-gradient(135deg, #1e2533 0%, #181d28 100%);' +\n'      border: 1px solid #2a3040;' +\n'      border-left: 3px solid #2357ff;' +\n'      padding: 12px 16px;' +\n'      border-radius: 8px;' +\n'    }' +\n'' +\n'    .logic-type-explanation h4 {' +\n'      font-size: 13px;' +\n'      font-weight: 700;' +\n'      color: #2357ff;' +\n'      margin-bottom: 6px;' +\n'    }' +\n'' +\n'    .logic-type-explanation p {' +\n'      font-size: 12px;' +\n'      color: #8b92a0;' +\n'      line-height: 1.5;' +\n'      margin: 0;' +\n'    }' +\n'' +\n'    .logic-type-meta {' +\n'      display: flex;' +\n'      gap: 16px;' +\n'      margin-top: 8px;' +\n'      font-size: 11px;' +\n'    }' +\n'' +\n'    .logic-type-meta span {' +\n'      color: #6b7280;' +\n'    }' +\n'' +\n'    .logic-type-meta .audience {' +\n'      color: #2357ff;' +\n'    }' +\n'' +\n'    /* AI Generator and Custom Input */' +\n'    .logic-type-actions {' +\n'      display: flex;' +\n'      gap: 12px;' +\n'      margin-top: 12px;' +\n'      padding-top: 12px;' +\n'      border-top: 1px solid #2a3040;' +\n'    }' +\n'' +\n'    .btn-generate-logic {' +\n'      background: linear-gradient(135deg, #10b981 0%, #059669 100%);' +\n'      border: none;' +\n'      color: #fff;' +\n'      padding: 8px 16px;' +\n'      border-radius: 6px;' +\n'      cursor: pointer;' +\n'      font-size: 12px;' +\n'      font-weight: 600;' +\n'      transition: all 0.2s;' +\n'      display: flex;' +\n'      align-items: center;' +\n'      gap: 6px;' +\n'    }' +\n'' +\n'    .btn-generate-logic:hover {' +\n'      background: linear-gradient(135deg, #059669 0%, #047857 100%);' +\n'      transform: translateY(-1px);' +\n'    }' +\n'' +\n'    .custom-logic-input {' +\n'      flex: 1;' +\n'      background: #141824;' +\n'      border: 1px solid #2a3040;' +\n'      color: #e7eaf0;' +\n'      padding: 8px 12px;' +\n'      border-radius: 6px;' +\n'      font-size: 12px;' +\n'      transition: all 0.2s;' +\n'    }' +\n'' +\n'    .custom-logic-input::placeholder {' +\n'      color: #6b7280;' +\n'      font-style: italic;' +\n'    }' +\n'' +\n'    .custom-logic-input:focus {' +\n'      outline: none;' +\n'      border-color: #2357ff;' +\n'      box-shadow: 0 0 0 3px rgba(35, 87, 255, 0.1);' +\n'    }' +\n'' +\n'    .btn-apply-custom {' +\n'      background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);' +\n'      border: none;' +\n'      color: #fff;' +\n'      padding: 8px 16px;' +\n'      border-radius: 6px;' +\n'      cursor: pointer;' +\n'      font-size: 12px;' +\n'      font-weight: 600;' +\n'      transition: all 0.2s;' +\n'    }' +\n'' +\n'    .btn-apply-custom:hover {' +\n'      background: linear-gradient(135deg, #7c3aed 0%, #6d28d9 100%);' +\n'      transform: translateY(-1px);' +\n'    }' +\n'' +\n'    .btn-save-logic {' +\n'      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);' +\n'      border: none;' +\n'      color: #fff;' +\n'      padding: 8px 16px;' +\n'      border-radius: 6px;' +\n'      cursor: pointer;' +\n'      font-size: 12px;' +\n'      font-weight: 600;' +\n'      transition: all 0.2s;' +\n'    }' +\n'' +\n'    .btn-save-logic:hover {' +\n'      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);' +\n'      transform: translateY(-1px);' +\n'    }' +\n'' +\n'    .chain-container {' +\n'      display: flex;' +\n'      flex-direction: row;' +\n'      gap: 6px;' +\n'      padding: 12px 4px;' +\n'      overflow-x: auto;' +\n'      overflow-y: hidden;' +\n'      height: calc(1000px - 120px);' +\n'      align-items: flex-start;' +\n'    }' +\n'' +\n'    .chain-container::-webkit-scrollbar {' +\n'      height: 10px;' +\n'    }' +\n'' +\n'    .chain-container::-webkit-scrollbar-track {' +\n'      background: #0f1115;' +\n'    }' +\n'' +\n'    .chain-container::-webkit-scrollbar-thumb {' +\n'      background: #2a3040;' +\n'      border-radius: 5px;' +\n'    }' +\n'' +\n'    .chain-position {' +\n'      display: flex;' +\n'      flex-direction: column;' +\n'      align-items: center;' +\n'      min-width: 140px;' +\n'      flex-shrink: 0;' +\n'    }' +\n'' +\n'    .case-primary {' +\n'      width: 140px;' +\n'      min-height: 90px;' +\n'      background: linear-gradient(135deg, #1e2533 0%, #181d28 100%);' +\n'      border: 2px solid #2357ff;' +\n'      border-radius: 8px;' +\n'      padding: 8px;' +\n'      cursor: grab;' +\n'      transition: all 0.3s ease;' +\n'      box-shadow: 0 4px 16px rgba(35, 87, 255, 0.4);' +\n'      opacity: 1.0;' +\n'      transform: scale(1.0);' +\n'      position: relative;' +\n'      font-size: 11px;' +\n'    }' +\n'' +\n'    .case-primary:active {' +\n'      cursor: grabbing;' +\n'      transform: scale(1.05);' +\n'    }' +\n'' +\n'    .case-header {' +\n'      display: flex;' +\n'      justify-content: space-between;' +\n'      align-items: center;' +\n'      margin-bottom: 12px;' +\n'    }' +\n'' +\n'    .case-id {' +\n'      font-size: 12px;' +\n'      font-weight: 700;' +\n'      color: #2357ff;' +\n'      background: #0f1115;' +\n'      padding: 4px 10px;' +\n'      border-radius: 6px;' +\n'    }' +\n'' +\n'    .case-row {' +\n'      font-size: 11px;' +\n'      color: #8b92a0;' +\n'    }' +\n'' +\n'    .case-title {' +\n'      font-size: 14px;' +\n'      font-weight: 600;' +\n'      color: #e7eaf0;' +\n'      margin-bottom: 8px;' +\n'      line-height: 1.4;' +\n'    }' +\n'' +\n'    .case-diagnosis {' +\n'      font-size: 9px;' +\n'      color: #ff9500;' +\n'      margin-top: 2px;' +\n'      font-weight: 600;' +\n'    }' +\n'' +\n'    .case-learning {' +\n'      font-size: 8px;' +\n'      color: #00d4ff;' +\n'      margin-top: 2px;' +\n'      line-height: 1.2;' +\n'    }' +\n'' +\n'    .case-rationale {' +\n'      display: none;' +\n'    }' +\n'' +\n'    .case-primary {' +\n'      position: relative;' +\n'    }' +\n'' +\n'    .case-primary:hover::after {' +\n'      content: attr(data-rationale);' +\n'      position: absolute;' +\n'      bottom: 100%;' +\n'      left: 50%;' +\n'      transform: translateX(-50%);' +\n'      background: rgba(35, 87, 255, 0.95);' +\n'      color: #ffffff;' +\n'      padding: 8px 12px;' +\n'      border-radius: 6px;' +\n'      font-size: 11px;' +\n'      line-height: 1.3;' +\n'      white-space: normal;' +\n'      max-width: 280px;' +\n'      width: max-content;' +\n'      z-index: 1000;' +\n'      margin-bottom: 8px;' +\n'      box-shadow: 0 4px 12px rgba(0,0,0,0.3);' +\n'      pointer-events: none;' +\n'    }' +\n'' +\n'    .case-alternatives {' +\n'      display: flex;' +\n'      flex-direction: column;' +\n'      gap: 8px;' +\n'      margin-top: 16px;' +\n'      width: 280px;' +\n'    }' +\n'' +\n'    .case-alternative {' +\n'      width: 100%;' +\n'      min-height: 60px;' +\n'      background: #0f1115;' +\n'      border: 1px solid #2a3040;' +\n'      border-radius: 8px;' +\n'      padding: 10px 12px;' +\n'      cursor: pointer;' +\n'      transition: all 0.3s ease;' +\n'      opacity: 0.5;' +\n'      transform: scale(0.92);' +\n'    }' +\n'' +\n'    .case-alternative:hover {' +\n'      opacity: 0.85;' +\n'      transform: scale(0.96);' +\n'      border-color: #2357ff;' +\n'      background: #141824;' +\n'    }' +\n'' +\n'    .alt-title {' +\n'      font-size: 13px;' +\n'      color: #e7eaf0;' +\n'      margin-bottom: 4px;' +\n'      font-weight: 500;' +\n'    }' +\n'' +\n'    .alt-id {' +\n'      font-size: 11px;' +\n'      color: #8b92a0;' +\n'    }' +\n'' +\n'    .chain-arrow {' +\n'      font-size: 32px;' +\n'      color: #2357ff;' +\n'      align-self: center;' +\n'      margin-top: 60px;' +\n'      flex-shrink: 0;' +\n'    }' +\n'' +\n'    .btn-add-case {' +\n'      width: 280px;' +\n'      height: 180px;' +\n'      background: #141824;' +\n'      border: 2px dashed #2a3040;' +\n'      border-radius: 12px;' +\n'      display: flex;' +\n'      flex-direction: column;' +\n'      align-items: center;' +\n'      justify-content: center;' +\n'      cursor: pointer;' +\n'      transition: all 0.3s;' +\n'      flex-shrink: 0;' +\n'      margin-top: 0;' +\n'      align-self: flex-start;' +\n'    }' +\n'' +\n'    .btn-add-case:hover {' +\n'      background: #1b1f2a;' +\n'      border-color: #2357ff;' +\n'    }' +\n'' +\n'    .btn-add-case .icon {' +\n'      font-size: 48px;' +\n'      margin-bottom: 12px;' +\n'      opacity: 0.5;' +\n'    }' +\n'' +\n'    .btn-add-case .text {' +\n'      font-size: 14px;' +\n'      color: #8b92a0;' +\n'      font-weight: 600;' +\n'    }' +\n'  </style>' +\n'  <script>' +\n'    function handleLogicTypeChange() {' +\n'      var select = document.getElementById(\"logic-type-selector\");' +\n'      var btn = document.getElementById(\"discover-btn\");' +\n'      if (!btn) return;' +\n'      if (select.value && select.value !== \"CREATE_NEW\") {' +\n'        btn.disabled = false;' +\n'      } else {' +\n'        btn.disabled = true;' +\n'      }' +\n'    }' +\n'    ' +\n'    function discoverPathways() {' +\n'      var logicTypeId = document.getElementById(\"logic-type-selector\").value;' +\n'      if (!logicTypeId || logicTypeId === \"CREATE_NEW\") {' +\n'        alert(\"Please select a logic type first\");' +\n'        return;' +\n'      }' +\n'      var btn = document.getElementById(\"discover-btn\");' +\n'      btn.disabled = true;' +\n'      btn.innerHTML = \"<span class=\\\\\"btn-icon\\\\\">üîÑ</span><span class=\\\\\"btn-text\\\\\">Discovering...</span>\";' +\n'      google.script.run' +\n'        .withSuccessHandler(handleDiscoveryResults)' +\n'        .withFailureHandler(handleDiscoveryError)' +\n'        .discoverPathwaysWithLogicType(logicTypeId);' +\n'    }' +\n'    ' +\n'    function handleDiscoveryResults(result) {' +\n'      var btn = document.getElementById(\"discover-btn\");' +\n'      btn.disabled = false;' +\n'      btn.innerHTML = \"<span class=\\\\\"btn-icon\\\\\">ü§ñ</span><span class=\\\\\"btn-text\\\\\">Discover Pathways</span>\";' +\n'      if (!result.success) {' +\n'        alert(\"Error: \" + result.error);' +\n'        return;' +\n'      }' +\n'      alert(\"‚úÖ Discovery complete! \" + result.pathwaysCount + \" pathways saved to Pathways_Master sheet.\");' +\n'    }' +\n'    ' +\n'    function handleDiscoveryError(error) {' +\n'      var btn = document.getElementById(\"discover-btn\");' +\n'      btn.disabled = false;' +\n'      btn.innerHTML = \"<span class=\\\\\"btn-icon\\\\\">ü§ñ</span><span class=\\\\\"btn-text\\\\\">Discover Pathways</span>\";' +\n'      alert(\"Error: \" + error.message);' +\n'    }' +\n'  </script>' +\n'</head>' +\n'<body>' +\n'  <div class=\"header\">' +\n'    <div class=\"header-left\">' +\n'      <button class=\"btn-back\" onclick=\"goBack()\">‚Üê Back</button>' +\n'      <div class=\"pathway-info\">' +\n'        <h1>' + pathway.icon + ' ' + pathway.name + '</h1>' +\n'        <div class=\"meta\">' + chain.length + ' cases in sequence ‚Ä¢ ' + pathway.logicType + ' pathway</div>' +\n'      </div>' +\n'    </div>' +\n'    <div class=\"header-right\">' +\n'      <button class=\"btn-save\" onclick=\"savePathway()\">üíæ Save Pathway</button>' +\n'    </div>' +\n'  </div>' +\n'' +\n'  <div class=\"logic-type-bar\">' +\n'    <div class=\"logic-type-selector\">' +\n'      <div class=\"logic-type-label\">üß† Intelligent Ordering Logic</div>' +\n'      <select class=\"logic-type-dropdown\" id=\"logicTypeSelector\" onchange=\"changeLogicType()\">' +\n'        ' + logicTypeOptionsHTML +\n'      </select>' +\n'    </div>' +\n'    <div class=\"logic-type-explanation\" id=\"logicTypeExplanation\">' +\n'      <h4>' + logicType.icon + ' ' + logicType.name + '</h4>' +\n'      <p>' + logicType.explanation + '</p>' +\n'      <div class=\"logic-type-meta\">' +\n'        <span>üë• <span class=\"audience\">' + logicType.targetAudience + '</span></span>' +\n'        <span>‚Ä¢ ' + logicType.whenToUse + '</span>' +\n'      </div>' +\n'      <div class=\"logic-type-actions\">' +\n'        <button class=\"btn-generate-logic\" onclick=\"generateNewLogicType()\">' +\n'          <span>ü§ñ</span>' +\n'          <span>AI: Generate New Logic Type</span>' +\n'        </button>' +\n'        <input type=\"text\" class=\"custom-logic-input\" id=\"customLogicInput\" ' +\n'          placeholder=\"‚ú® Or describe your own logic type (e.g., \\'Order by likelihood of misdiagnosis\\')...\" />' +\n'        <button class=\"btn-apply-custom\" onclick=\"applyCustomLogic()\">Apply</button>' +\n'        <button class=\"btn-save-logic\" onclick=\"saveCurrentLogic()\" title=\"Save this logic type for future use\">' +\n'          üíæ Save' +\n'        </button>' +\n'      </div>' +\n'    </div>' +\n'  </div>' +\n'' +\n'  <div class=\"chain-container\" id=\"chainContainer\">' +\n'    ' + chainPositionsHTML +\n'    <div class=\"chain-arrow\">‚Üí</div>' +\n'    <button class=\"btn-add-case\" onclick=\"addCase()\">' +\n'      <div class=\"icon\">+</div>' +\n'      <div class=\"text\">Add Case</div>' +\n'    </button>' +\n'  </div>' +\n'' +\n'  <script>' +\n'    let pathwayData = ' + JSON.stringify({id: pathway.id, name: pathway.name, chain: chain, logicType: logicType}) + ';' +\n'    let allLogicTypes = ' + JSON.stringify(allLogicTypes) + ';' +\n'' +\n'    function changeLogicType() {' +\n'      const newLogicTypeId = document.getElementById(\"logicTypeSelector\").value;' +\n'      console.log(\"üîÑ Changing logic type to:\", newLogicTypeId);' +\n'      ' +\n'      // Show loading state' +\n'      document.getElementById(\"chainContainer\").innerHTML = ' +\n'        \\'<div style=\"text-align:center; padding:100px; width:100%;\"><h2>‚öôÔ∏è Reordering chain...</h2><p style=\"color: #8b92a0;\">Applying new logic type</p></div>\\';' +\n'      ' +\n'      // Reload with new logic type' +\n'      google.script.run' +\n'        .withSuccessHandler(function(html) {' +\n'          document.documentElement.innerHTML = html;' +\n'        })' +\n'        .withFailureHandler(function(error) {' +\n'          alert(\"Error changing logic type: \" + error.message);' +\n'          location.reload();' +\n'        })' +\n'        .buildChainBuilderUI(\\'' + pathway.id + '\\', newLogicTypeId);' +\n'    }' +\n'' +\n'    function generateNewLogicType() {' +\n'      console.log(\"ü§ñ Generating new logic type using AI...\");' +\n'      ' +\n'      // Show loading state' +\n'      const btn = event.target.closest(\".btn-generate-logic\");' +\n'      const originalHTML = btn.innerHTML;' +\n'      btn.innerHTML = \"<span>‚è≥</span><span>AI is analyzing cases...</span>\";' +\n'      btn.disabled = true;' +\n'      ' +\n'      // Call server-side ChatGPT integration' +\n'      google.script.run' +\n'        .withSuccessHandler(function(newLogicType) {' +\n'          console.log(\"‚úÖ AI generated new logic type:\", newLogicType);' +\n'          ' +\n'          // Show preview dialog' +\n'          const useIt = confirm(' +\n'            \"ü§ñ AI GENERATED NEW LOGIC TYPE\\\\n\\\\n\" +' +\n'            \"Name: \" + newLogicType.name + \"\\\\n\" +' +\n'            \"Icon: \" + newLogicType.icon + \"\\\\n\\\\n\" +' +\n'            \"Description: \" + newLogicType.description + \"\\\\n\\\\n\" +' +\n'            \"Explanation: \" + newLogicType.explanation + \"\\\\n\\\\n\" +' +\n'            \"Target Audience: \" + newLogicType.targetAudience + \"\\\\n\\\\n\" +' +\n'            \"Would you like to apply this logic type to your chain?\"' +\n'          );' +\n'          ' +\n'          btn.innerHTML = originalHTML;' +\n'          btn.disabled = false;' +\n'          ' +\n'          if (useIt) {' +\n'            // Add to temporary logic types and apply' +\n'            allLogicTypes.push(newLogicType);' +\n'            applyDynamicLogic(newLogicType);' +\n'          }' +\n'        })' +\n'        .withFailureHandler(function(error) {' +\n'          console.error(\"‚ùå AI logic generation failed:\", error);' +\n'          alert(\"Error generating logic type: \" + error.message);' +\n'          btn.innerHTML = originalHTML;' +\n'          btn.disabled = false;' +\n'        })' +\n'        .generateLogicTypeWithAI(\\'' + pathway.id + '\\');' +\n'    }' +\n'' +\n'    function applyCustomLogic() {' +\n'      const customDescription = document.getElementById(\"customLogicInput\").value.trim();' +\n'      if (!customDescription) {' +\n'        alert(\"Please describe your desired logic type first!\");' +\n'        return;' +\n'      }' +\n'      ' +\n'      console.log(\"‚ú® Applying custom logic:\", customDescription);' +\n'      ' +\n'      // Show loading' +\n'      const btn = event.target;' +\n'      btn.innerHTML = \"‚è≥ Analyzing...\";' +\n'      btn.disabled = true;' +\n'      ' +\n'      // Have AI interpret the custom description and create logic type' +\n'      google.script.run' +\n'        .withSuccessHandler(function(customLogicType) {' +\n'          console.log(\"‚úÖ Custom logic type created:\", customLogicType);' +\n'          ' +\n'          // Add to temporary logic types and apply' +\n'          allLogicTypes.push(customLogicType);' +\n'          applyDynamicLogic(customLogicType);' +\n'          ' +\n'          btn.innerHTML = \"Apply\";' +\n'          btn.disabled = false;' +\n'          document.getElementById(\"customLogicInput\").value = \"\";' +\n'        })' +\n'        .withFailureHandler(function(error) {' +\n'          alert(\"Error creating custom logic: \" + error.message);' +\n'          btn.innerHTML = \"Apply\";' +\n'          btn.disabled = false;' +\n'        })' +\n'        .interpretCustomLogicDescription(customDescription, \\'' + pathway.id + '\\');' +\n'    }' +\n'' +\n'    function applyDynamicLogic(logicType) {' +\n'      console.log(\"üîÑ Applying dynamic logic type:\", logicType.id);' +\n'      ' +\n'      // Show loading state' +\n'      document.getElementById(\"chainContainer\").innerHTML = ' +\n'        \\'<div style=\"text-align:center; padding:100px; width:100%;\"><h2>‚öôÔ∏è Reordering with custom logic...</h2><p style=\"color: #8b92a0;\">Applying: \\' + logicType.name + \\'</p></div>\\';' +\n'      ' +\n'      // Apply the dynamic logic type' +\n'      google.script.run' +\n'        .withSuccessHandler(function(html) {' +\n'          document.documentElement.innerHTML = html;' +\n'        })' +\n'        .withFailureHandler(function(error) {' +\n'          alert(\"Error applying dynamic logic: \" + error.message);' +\n'          location.reload();' +\n'        })' +\n'        .applyDynamicLogicType(\\'' + pathway.id + '\\', logicType);' +\n'    }' +\n'' +\n'    function saveCurrentLogic() {' +\n'      const currentLogicTypeId = document.getElementById(\"logicTypeSelector\").value;' +\n'      const currentLogic = allLogicTypes.find(function(lt) { return lt.id === currentLogicTypeId; });' +\n'      ' +\n'      if (!currentLogic) {' +\n'        alert(\"No logic type selected!\");' +\n'        return;' +\n'      }' +\n'      ' +\n'      // Check if it\\'s a custom/dynamic logic type (not in the original 12)' +\n'      const isCustom = currentLogic.id.startsWith(\"custom_\") || currentLogic.id.startsWith(\"ai_\");' +\n'      ' +\n'      if (!isCustom) {' +\n'        alert(\"This is a built-in logic type - already saved!\");' +\n'        return;' +\n'      }' +\n'      ' +\n'      const logicName = prompt(\"Save this logic type as:\", currentLogic.name);' +\n'      if (!logicName) return;' +\n'      ' +\n'      console.log(\"üíæ Saving custom logic type:\", logicName);' +\n'      ' +\n'      google.script.run' +\n'        .withSuccessHandler(function() {' +\n'          alert(\"‚úÖ Logic type \\\\\"\" + logicName + \"\\\\\" saved successfully!\\\\n\\\\nIt will now appear in the dropdown for all future sessions.\");' +\n'        })' +\n'        .withFailureHandler(function(error) {' +\n'          alert(\"Error saving logic type: \" + error.message);' +\n'        })' +\n'        .saveCustomLogicType(Object.assign({}, currentLogic, { name: logicName }));' +\n'    }' +\n'' +\n'    function goBack() {' +\n'      google.script.host.close();' +\n'      google.script.run.runPathwayChainBuilder();' +\n'    }' +\n'' +\n'    function swapCase(position, newCaseId) {' +\n'      console.log(\"Swapping position \" + position + \" with case \" + newCaseId);' +\n'      ' +\n'      // Find current primary and alternative' +\n'      const positionData = pathwayData.chain[position - 1];' +\n'      const currentPrimary = positionData.primary;' +\n'      ' +\n'      // Find the alternative being clicked' +\n'      let clickedAlt = null;' +\n'      let altIndex = -1;' +\n'      for (let i = 0; i < positionData.alternatives.length; i++) {' +\n'        if (positionData.alternatives[i].caseId === newCaseId) {' +\n'          clickedAlt = positionData.alternatives[i];' +\n'          altIndex = i;' +\n'          break;' +\n'        }' +\n'      }' +\n'      ' +\n'      if (!clickedAlt) return;' +\n'      ' +\n'      // Swap' +\n'      pathwayData.chain[position - 1].primary = clickedAlt;' +\n'      pathwayData.chain[position - 1].alternatives[altIndex] = currentPrimary;' +\n'      ' +\n'      // Re-render (for now, just reload)' +\n'      alert(\"Swapped! Full re-render coming in Phase 2C...\");' +\n'    }' +\n'' +\n'    function savePathway() {' +\n'      alert(\"Save functionality coming in Phase 2F (Persistence)!\");' +\n'    }' +\n'' +\n'    function addCase() {' +\n'      alert(\"Add case functionality coming in Phase 2C!\");' +\n'    }' +\n'  </script>' +\n'</body>' +\n'</html>';\n}\n\n// ========== AI PATHWAY DISCOVERY SYSTEM (DUAL MODE) ==========\n\n/**\n * Generate AI-discovered pathways with two creativity levels\n * creativityMode: 'standard' or 'radical'\n */\nfunction discoverNovelPathwaysWithAI_(creativityMode) {\n  // Refresh headers before analysis\n  refreshHeaders();\n  \n  creativityMode = creativityMode || 'standard';\n\n  // Get API key from Settings sheet\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const settingsSheet = ss.getSheetByName('Settings');\n  let apiKey = '';\n\n  if (settingsSheet) {\n    apiKey = settingsSheet.getRange('B2').getValue();\n    Logger.log('API key retrieved for ' + creativityMode + ' mode pathway discovery');\n  }\n\n  if (!apiKey) {\n    return {\n      success: false,\n      error: 'No OpenAI API key found in Settings!B2',\n      pathways: []\n    };\n  }\n\n  const analysis = analyzeCatalogWithMultiLayerCache_();\n  const cases = analysis.allCases;\n\n  const caseSummaries = cases.map(function(c) {\n    return {\n      id: c.caseId,\n      title: c.sparkTitle,\n      diagnosis: c.diagnosis || 'Not specified',\n      learning: (c.learningOutcomes || 'Not specified').substring(0, 100),\n      category: c.category\n    };\n  });\n\n  let temperature = creativityMode === 'radical' ? 1.0 : 0.7;\n  let prompt = creativityMode === 'radical'\n    ? 'You are Dr. Zara Blackwood, a visionary medical educator. Create pathway groupings so creative they border on experimental. RADICAL CONCEPTS: The Gambler\\'s Fallacy, Method Actor\\'s Toolkit, Butterfly Effect, Jazz Improvisation. Requirements: Novelty 8-10/10, psychological/cognitive science backing. ANALYZE ' + cases.length + ' CASES. INVENT 5-8 RADICALLY CREATIVE PATHWAYS with pathway_name, pathway_icon, grouping_logic_type, why_this_matters, learning_outcomes, best_for, unique_value, case_ids (min 3), novelty_score (8-10), estimated_learning_time, difficulty_curve, scientific_rationale. Return ONLY valid JSON array.'\n    : 'You are Dr. Maria Rodriguez, award-winning medical educator. Create novel pathways beyond traditional categories. FORBIDDEN: Body systems, simple age/acuity. ENCOURAGED: Cognitive biases, emotional journeys, narrative arcs, skill scaffolding, pattern interrupts. EXAMPLES: The Imposter Syndrome Destroyer, The Puzzle Master Series, The 90-Second Saves. ANALYZE ' + cases.length + ' CASES. INVENT 5-8 PATHWAYS with pathway_name, pathway_icon, grouping_logic_type, why_this_matters, learning_outcomes, best_for, unique_value, case_ids (min 3), novelty_score (7+), estimated_learning_time, difficulty_curve. Return ONLY valid JSON array.';\n\n  try {\n    const response = UrlFetchApp.fetch('https://api.openai.com/v1/chat/completions', {\n      method: 'post',\n      headers: {\n        'Authorization': 'Bearer ' + apiKey,\n        'Content-Type': 'application/json'\n      },\n      payload: JSON.stringify({\n        model: 'gpt-4',\n        messages: [\n          {\n            role: 'system',\n            content: creativityMode === 'radical'\n              ? 'You are an experimental medical educator applying cognitive science to education.'\n              : 'You are an expert medical educator specializing in innovative curriculum design.'\n          },\n          {\n            role: 'user',\n            content: prompt + '\\n\\nCASES:\\n' + JSON.stringify(caseSummaries, null, 2)\n          }\n        ],\n        temperature: temperature,\n        max_tokens: 2500\n      }),\n      muteHttpExceptions: true\n    });\n\n    const responseCode = response.getResponseCode();\n    if (responseCode !== 200) {\n      return { success: false, error: 'OpenAI API error: ' + responseCode, pathways: [] };\n    }\n\n    const data = JSON.parse(response.getContentText());\n    const aiResponse = data.choices[0].message.content;\n\n    let pathways = [];\n    const jsonMatch = aiResponse.match(/\\[[\\s\\S]*\\]/);\n    pathways = jsonMatch ? JSON.parse(jsonMatch[0]) : JSON.parse(aiResponse);\n\n    const formattedPathways = pathways.map(function(pw, index) {\n      return {\n        id: 'ai_' + creativityMode + '_' + (index + 1),\n        name: pw.pathway_name || 'Unnamed Pathway',\n        logicType: pw.grouping_logic_type || 'ai_discovered',\n        icon: pw.pathway_icon || 'ü§ñ',\n        confidence: (pw.novelty_score || 5) / 10,\n        caseCount: (pw.case_ids || []).length,\n        pitch: pw.why_this_matters || '',\n        learningOutcomes: pw.learning_outcomes || [],\n        bestFor: pw.best_for || '',\n        uniqueValue: pw.unique_value || '',\n        noveltyScore: pw.novelty_score || 5,\n        estimatedTime: pw.estimated_learning_time || 'Not specified',\n        difficultyCurve: pw.difficulty_curve || 'Unknown',\n        scientificRationale: pw.scientific_rationale || '',\n        creativityMode: creativityMode,\n        suggestedCases: pw.case_ids || []\n      };\n    });\n\n    return { success: true, pathways: formattedPathways };\n  } catch (e) {\n    return { success: false, error: e.message, pathways: [] };\n  }\n}\n\n/**\n * Show AI-discovered pathways\n */\nfunction showAIDiscoveredPathways(creativityMode) {\n  creativityMode = creativityMode || 'standard';\n  const result = discoverNovelPathwaysWithAI_(creativityMode);\n\n  if (!result.success) {\n    SpreadsheetApp.getUi().alert('AI Pathway Discovery Failed', result.error, SpreadsheetApp.getUi().ButtonSet.OK);\n    return;\n  }\n\n  const modeLabel = creativityMode === 'radical' ? 'üî• RADICAL EXPERIMENTAL' : 'ü§ñ CREATIVE';\n  const modeColor = creativityMode === 'radical' ? '#ff6b00' : '#2357ff';\n\n  let html = '<style>body{font-family:Arial;background:#0a0b0e;color:#fff;padding:24px;margin:0}.header{text-align:center;margin-bottom:32px}.header h1{font-size:28px;background:linear-gradient(135deg,' + modeColor + ',#00d4ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.pathway-card{background:linear-gradient(135deg,#1a1f2e,#141824);border:2px solid transparent;border-radius:16px;padding:24px;margin-bottom:24px;position:relative;overflow:hidden;transition:all .3s}.pathway-card:hover{transform:translateY(-4px);box-shadow:0 12px 32px rgba(' + (creativityMode === 'radical' ? '255,107,0' : '35,87,255') + ',.3)}.pathway-icon{font-size:42px}.pathway-name{font-size:22px;font-weight:700}.pitch-title{font-size:13px;font-weight:600;color:#ff9500;text-transform:uppercase;margin:12px 0 8px}.pitch-text{font-size:15px;line-height:1.7;color:#e0e0e0}.stars{color:#ffd700;margin-left:8px}.create-btn{background:linear-gradient(135deg,' + modeColor + ',' + (creativityMode === 'radical' ? '#cc5500' : '#1a47cc') + ');color:#fff;border:none;padding:12px 20px;border-radius:8px;cursor:pointer;font-size:15px;font-weight:600;margin-top:16px}</style>';\n\n  html += '<div class=\"header\"><h1>' + modeLabel + ' AI-Discovered Pathways</h1><p>' +\n    (creativityMode === 'radical' ? 'Experimental groupings pushing educational boundaries' : 'Creative pathways for maximum learning impact') +\n    '</p></div>';\n\n  result.pathways.forEach(function(pw) {\n    const stars = '‚≠ê'.repeat(Math.min(5, Math.round(pw.noveltyScore / 2)));\n    html += '<div class=\"pathway-card\">';\n    html += '<div class=\"pathway-icon\">' + pw.icon + '</div>';\n    html += '<div class=\"pathway-name\">' + pw.name + '<span class=\"stars\">' + stars + '</span></div>';\n    html += '<div class=\"pitch-title\">üéØ Why This Matters</div>';\n    html += '<div class=\"pitch-text\">' + pw.pitch + '</div>';\n    html += '<button class=\"create-btn\" onclick=\"alert(\\'Coming soon!\\')\">üöÄ Build This Pathway Now</button>';\n    html += '</div>';\n  });\n\n  const htmlOutput = HtmlService.createHtmlOutput(html).setWidth(800).setHeight(600);\n  SpreadsheetApp.getUi().showModalDialog(htmlOutput, modeLabel + ' AI-Discovered Pathways');\n}\n\nfunction showAIPathwaysStandard() {\n  showAIDiscoveredPathways('standard');\n}\n\nfunction showAIPathwaysRadical() {\n  showAIDiscoveredPathways('radical');\n}\n/**\n * AI PATHWAY DISCOVERY - STREAMING LOGS (No Background Execution)\n * Uses server-side logging with client polling\n */\n\n// Global log storage\nvar AI_DISCOVERY_LOGS = [];\n\n/**\n * Main entry point - shows log window and triggers discovery\n */\nfunction showAIPathwaysStandardWithLogs() {\n  showAIDiscoveryWithStreamingLogs_('standard');\n}\n\nfunction showAIPathwaysRadicalWithLogs() {\n  showAIDiscoveryWithStreamingLogs_('radical');\n}\n\n/**\n * PRE-CACHE RICH DATA WITH LIVE PROGRESS\n * Shows live progress window as it caches all 210+ cases with 23 fields each\n */\n\n/**\n * Backend function to perform caching with progress updates\n */\n\n/**\n * Get cache status for UI indicator\n * Returns: { status: 'valid'|'stale'|'missing', hoursOld, expiresIn, cases }\n */\n\n/**\n * Show live log window that polls for updates\n */\n\n/**\n * Start AI discovery (called from client)\n */\n\n/**\n * Get current status (called by polling)\n */\n\n/**\n * Analyze case catalog - SMART CACHING VERSION\n *\n * Three-tier strategy for maximum reliability + rich data:\n * 1. CACHE HIT (instant): Use cached holistic analysis if < 24 hours old\n * 2. FRESH ANALYSIS (slow but rich): Try performHolisticAnalysis_() with 4min timeout\n * 3. LIGHTWEIGHT FALLBACK (fast but basic): Direct sheet read if timeout\n *\n * This preserves all rich clinical context (demographics, vitals, exam findings, etc.)\n */\nfunction analyzeCatalogWithMultiLayerCache_() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n\n    let cacheSheet = ss.getSheetByName('Pathway_Analysis_Cache');\n\n  if (cacheSheet) {\n    const data = cacheSheet.getDataRange().getValues();\n    if (data.length > 1) {\n      const cachedTimestamp = new Date(data[1][0]);\n      const now = new Date();\n      const hoursDiff = (now - cachedTimestamp) / (1000 * 60 * 60);\n\n      if (hoursDiff < 24) {\n        // Cache hit! Return full rich data instantly\n        Logger.log('‚úÖ Using cached holistic analysis (' + hoursDiff.toFixed(1) + ' hours old)');\n        return JSON.parse(data[1][1]);\n      }\n    }\n  }\n\n    Logger.log('üìä Cache miss or stale - attempting fresh holistic analysis');\n  const startTime = new Date().getTime();\n  const MAX_TIME = 4 * 60 * 1000; // 4 minutes (leave 2min buffer for 6min timeout)\n\n  try {\n    const analysis = performHolisticAnalysis_();\n    const elapsed = new Date().getTime() - startTime;\n\n    Logger.log('‚úÖ Fresh analysis completed in ' + (elapsed / 1000).toFixed(1) + 's');\n\n    if (elapsed < MAX_TIME) {\n      return analysis; // Success! Got all the rich data + auto-cached for next time\n    } else {\n      Logger.log('‚ö†Ô∏è  Analysis took too long, falling back to lightweight mode');\n    }\n  } catch (e) {\n    Logger.log('‚ö†Ô∏è  Error in performHolisticAnalysis_(): ' + e.message);\n  }\n\n    Logger.log('üìâ Using lightweight analysis fallback');\n  const sheet = ss.getSheets().find(function(sh) {\n    return /master scenario csv/i.test(sh.getName());\n  }) || ss.getActiveSheet();\n\n  const data = sheet.getDataRange().getValues();\n  const headers = data[1];\n\n  // Dynamic column resolution for catalog analysis\n  const columnIndices = resolveColumnIndices_({\n    caseId: { name: 'Case_Organization_Case_ID', fallback: 0 },\n    sparkTitle: { name: 'Case_Organization_Spark_Title', fallback: 1 },\n    pathway: { name: 'Case_Organization_Pathway_or_Course_Name', fallback: 5 },\n    category: { name: 'Case_Organization_Category', fallback: 4 },\n    diagnosis: { name: 'Case_Orientation_Chief_Diagnosis', fallback: 44 },\n    learningOutcomes: { name: 'Case_Orientation_Actual_Learning_Outcomes', fallback: 45 }\n  });\n\n  const caseIdIdx = columnIndices.caseId;\n  const sparkIdx = columnIndices.sparkTitle;\n  const diagnosisIdx = columnIndices.diagnosis;\n  const learningIdx = columnIndices.learningOutcomes;\n  const categoryIdx = columnIndices.category;\n  const pathwayIdx = columnIndices.pathway;\n\n  const allCases = [];\n  for (let i = 2; i < data.length; i++) {\n    allCases.push({\n      caseId: data[i][caseIdIdx] || '',\n      sparkTitle: data[i][sparkIdx] || '',\n      diagnosis: data[i][diagnosisIdx] || '',\n      learningOutcomes: data[i][learningIdx] || '',\n      category: data[i][categoryIdx] || '',\n      pathway: data[i][pathwayIdx] || ''\n    });\n  }\n\n  return { allCases: allCases };\n}\n\n/**\n * Helper: Extract vital value from vitals JSON string\n */\n\n/**\n * Synchronous discovery with logging\n */\n\n/**\n * Show results (called after discovery completes)\n */\n\n\n/**\n * Multi-Step Cache Enrichment System for AI Pathway Discovery\n *\n * Architecture: 7 independent cache layers that can be enriched progressively\n * Each layer caches a subset of the 26 required fields for AI discovery\n * Layers combine during AI discovery via merger logic\n *\n * Benefits:\n * - No execution timeouts (each layer completes quickly)\n * - Progressive enhancement (AI quality improves as layers cache)\n * - Independent scheduling (cache different layers at different times)\n * - Graceful degradation (works even if some layers missing)\n */\n\n// ============================================================================\n// LAYER DEFINITIONS\n// ============================================================================\n\n/**\n * Returns field mapping configuration for all 7 cache layers\n */\nfunction getCacheLayerDefinitions_() {\n  return {\n    basic: {\n      sheetName: 'Pathway_Analysis_Cache_Basic',\n      fields: {\n        caseId: 0,  // Case_Organization_Case_ID\n        sparkTitle: 1,  // Case_Organization_Spark_Title\n        pathway: 5  // Case_Organization_Pathway_or_Course_Name\n      },\n      priority: 1,\n      estimatedTime: '<1s'\n    },\n\n    learning: {\n      sheetName: 'Pathway_Analysis_Cache_Learning',\n      fields: {\n        preSimOverview: 9,  // Case_Organization_Pre_Sim_Overview\n        postSimOverview: 10,  // Case_Organization_Post_Sim_Overview\n        learningOutcomes: 191,  // CME_and_Educational_Content_CME_Learning_Objective\n        learningObjectives: 34  // Set_the_Stage_Context_Educational_Goal\n      },\n      priority: 2,\n      estimatedTime: '~30s',\n      truncate: {\n        preSimOverview: 300,\n        postSimOverview: 300\n      }\n    },\n\n    metadata: {\n      sheetName: 'Pathway_Analysis_Cache_Metadata',\n      fields: {\n        category: 11,  // Case_Organization_Medical_Category\n        difficulty: 6,  // Case_Organization_Difficulty_Level\n        setting: 38,  // Set_the_Stage_Context_Environment_Type\n        chiefComplaint: 66  // Patient_Demographics_and_Clinical_Data_Presenting_Complaint\n      },\n      priority: 3,\n      estimatedTime: '~5s'\n    },\n\n    demographics: {\n      sheetName: 'Pathway_Analysis_Cache_Demographics',\n      fields: {\n        age: 62,  // Patient_Demographics_and_Clinical_Data_Age\n        gender: 63,  // Patient_Demographics_and_Clinical_Data_Gender\n        patientName: 61  // Patient_Demographics_and_Clinical_Data_Patient_Name\n      },\n      priority: 4,\n      estimatedTime: '~3s'\n    },\n\n    vitals: {\n      sheetName: 'Pathway_Analysis_Cache_Vitals',\n      fields: {\n        initialVitals: 55  // Monitor_Vital_Signs_Initial_Vitals (JSON)\n      },\n      priority: 5,\n      estimatedTime: '~15s',\n      parseJSON: ['initialVitals'],\n      extractFromJSON: {\n        initialVitals: ['hr', 'bp.sys', 'bp.dia', 'rr', 'spo2']\n      }\n    },\n\n    clinical: {\n      sheetName: 'Pathway_Analysis_Cache_Clinical',\n      fields: {\n        examFindings: 73,  // Patient_Demographics_and_Clinical_Data_Exam_Positive_Findings\n        medications: 68,  // Patient_Demographics_and_Clinical_Data_Current_Medications\n        pastMedicalHistory: 67,  // Patient_Demographics_and_Clinical_Data_Past_Medical_History\n        allergies: 69  // Patient_Demographics_and_Clinical_Data_Allergies\n      },\n      priority: 6,\n      estimatedTime: '~10s',\n      truncate: {\n        examFindings: 200,\n        medications: 150,\n        pastMedicalHistory: 200\n      }\n    },\n\n    environment: {\n      sheetName: 'Pathway_Analysis_Cache_Environment',\n      fields: {\n        environmentType: 38,  // Set_the_Stage_Context_Environment_Type\n        dispositionPlan: 48,  // Situation_and_Environment_Details_Disposition_Plan\n        context: 36  // Set_the_Stage_Context_Clinical_Vignette\n      },\n      priority: 7,\n      estimatedTime: '~8s',\n      truncate: {\n        context: 300\n      }\n    }\n  };\n}\n\n\n// ============================================================================\n// DYNAMIC HEADER RESOLUTION\n// ============================================================================\n\n/**\n * Get column index by Tier2 header name with fallback to static index\n * Uses CACHED_HEADER2 document property for dynamic column resolution\n *\n * @param {string} tier2Name - The Tier2 header name to search for\n * @param {number} fallbackIndex - Static index to use if header not found\n * @returns {number} Column index\n */\n\n// ============================================================================\n// CORE ENRICHMENT ENGINE\n// ============================================================================\n\n/**\n * Enrich a single cache layer with field data\n *\n * @param {string} layerKey - Key from getCacheLayerDefinitions_() (e.g., 'learning')\n * @returns {Object} Result object with success status and metadata\n */\nfunction enrichCacheLayer_(layerKey) {\n  const layerDef = getCacheLayerDefinitions_()[layerKey];\n\n  if (!layerDef) {\n    throw new Error(`Unknown cache layer: ${layerKey}`);\n  }\n\n  Logger.log(`üóÑÔ∏è  [LAYER ${layerDef.priority}/${Object.keys(getCacheLayerDefinitions_()).length}] Enriching ${layerKey} cache...`);\n  Logger.log(`   Sheet: ${layerDef.sheetName}`);\n  Logger.log(`   Fields: ${Object.keys(layerDef.fields).length}`);\n  Logger.log(`   Estimated time: ${layerDef.estimatedTime}`);\n\n  const startTime = new Date().getTime();\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n\n  // Find master sheet\n  const masterSheet = ss.getSheets().find(function(sh) {\n    return /master.*scenario.*convert/i.test(sh.properties.title);\n  });\n\n  if (!masterSheet) {\n    throw new Error('Master Scenario Convert sheet not found');\n  }\n\n  Logger.log(`   Reading data from: ${masterSheet.getName()}`);\n  const data = masterSheet.getDataRange().getValues();\n  const tier2Headers = data[1];\n\n  // Validate field mappings with dynamic header resolution\n  const validatedIndices = {};\n  Object.keys(layerDef.fields).forEach(function(fieldName) {\n    const fallbackIndex = layerDef.fields[fieldName];\n\n    // Resolve column index dynamically from refreshed headers\n    let columnIndex;\n\n    if (typeof fallbackIndex === 'number' && fallbackIndex >= 0) {\n      // Get the actual tier2 header name for this column\n      const tier2Name = tier2Headers[fallbackIndex];\n\n      if (tier2Name) {\n        // Use dynamic resolution with fallback\n        columnIndex = getColumnIndexByHeader_(tier2Name, fallbackIndex);\n\n        if (columnIndex !== fallbackIndex) {\n          Logger.log(`   üîÑ Field ${fieldName}: Column moved from ${fallbackIndex} to ${columnIndex} (${tier2Name})`);\n        }\n      } else {\n        columnIndex = fallbackIndex;\n      }\n    } else {\n      Logger.log(`   ‚ö†Ô∏è  Invalid column index for field ${fieldName}: ${fallbackIndex}`);\n      return;\n    }\n\n    if (typeof columnIndex !== 'number' || columnIndex < 0) {\n      Logger.log(`   ‚ö†Ô∏è  Could not resolve column for field ${fieldName}`);\n      return;\n    }\n\n    if (columnIndex >= tier2Headers.length) {\n      Logger.log(`   ‚ö†Ô∏è  Field ${fieldName} index ${columnIndex} out of range (max: ${tier2Headers.length - 1})`);\n    } else {\n      validatedIndices[fieldName] = columnIndex;\n      Logger.log(`   ‚úÖ ${fieldName} ‚Üí Column ${columnIndex} (${tier2Headers[columnIndex]})`);\n    }\n  });\n\n  // Extract field data for all cases\n  const enrichedCases = [];\n  const caseIdIndex = 0;  // Case_Organization_Case_ID always at index 0\n\n  for (let i = 2; i < data.length; i++) {\n    const caseId = data[i][caseIdIndex];\n    if (!caseId) continue;  // Skip rows without case ID\n\n    const caseData = { caseId: caseId, row: i + 1 };\n\n    Object.keys(validatedIndices).forEach(function(fieldName) {\n      const columnIndex = validatedIndices[fieldName];\n      let value = data[i][columnIndex] || '';\n\n      // Apply truncation if specified\n      if (layerDef.truncate && layerDef.truncate[fieldName]) {\n        const maxLength = layerDef.truncate[fieldName];\n        if (value.length > maxLength) {\n          value = value.substring(0, maxLength);\n        }\n      }\n\n      // Parse JSON if specified\n      if (layerDef.parseJSON && layerDef.parseJSON.indexOf(fieldName) !== -1) {\n        try {\n          const parsed = JSON.parse(value);\n\n          // Extract nested fields if specified\n          if (layerDef.extractFromJSON && layerDef.extractFromJSON[fieldName]) {\n            const extractFields = layerDef.extractFromJSON[fieldName];\n            extractFields.forEach(function(extractPath) {\n              const parts = extractPath.split('.');\n              let extractedValue = parsed;\n\n              for (let p = 0; p < parts.length; p++) {\n                extractedValue = extractedValue[parts[p]];\n                if (extractedValue === undefined) break;\n              }\n\n              const extractFieldName = 'initial' + extractPath.charAt(0).toUpperCase() + extractPath.slice(1).replace('.', '');\n              caseData[extractFieldName] = extractedValue || '';\n            });\n          } else {\n            caseData[fieldName] = parsed;\n          }\n        } catch (e) {\n          Logger.log(`   ‚ö†Ô∏è  Failed to parse JSON for ${fieldName} in case ${caseId}: ${e.message}`);\n          caseData[fieldName] = value;  // Store raw value as fallback\n        }\n      } else {\n        caseData[fieldName] = value;\n      }\n    });\n\n    enrichedCases.push(caseData);\n  }\n\n  Logger.log(`   ‚úÖ Enriched ${enrichedCases.length} cases`);\n\n  // Create or update cache sheet\n  let cacheSheet = ss.getSheetByName(layerDef.sheetName);\n\n  if (!cacheSheet) {\n    Logger.log(`   üìÑ Creating new cache sheet: ${layerDef.sheetName}`);\n    cacheSheet = ss.insertSheet(layerDef.sheetName);\n    cacheSheet.setHiddenGridlines(true);\n  } else {\n    Logger.log(`   üìÑ Updating existing cache sheet: ${layerDef.sheetName}`);\n    cacheSheet.clear();\n  }\n\n  // Write cache data: [timestamp, jsonData]\n  const cacheData = {\n    timestamp: new Date().toISOString(),\n    layerKey: layerKey,\n    totalCases: enrichedCases.length,\n    fields: Object.keys(layerDef.fields),\n    allCases: enrichedCases\n  };\n\n  cacheSheet.getRange(1, 1).setValue('Timestamp');\n  cacheSheet.getRange(1, 2).setValue('Cache Data (JSON)');\n  cacheSheet.getRange(2, 1).setValue(new Date());\n  cacheSheet.getRange(2, 2).setValue(JSON.stringify(cacheData));\n\n  // Format sheet\n  cacheSheet.getRange(1, 1, 1, 2).setFontWeight('bold').setBackground('#4285f4').setFontColor('#ffffff');\n  cacheSheet.autoResizeColumns(1, 2);\n\n  const elapsed = new Date().getTime() - startTime;\n  Logger.log(`   ‚è±Ô∏è  Completed in ${(elapsed / 1000).toFixed(1)}s`);\n\n  return {\n    success: true,\n    layerKey: layerKey,\n    sheetName: layerDef.sheetName,\n    casesEnriched: enrichedCases.length,\n    fieldsEnriched: Object.keys(layerDef.fields).length,\n    elapsedMs: elapsed\n  };\n}\n\n/**\n * Enrich all cache layers sequentially\n *\n * @returns {Object} Summary of enrichment results\n */\nfunction enrichAllCacheLayers() {\n  const startTime = new Date().getTime();\n\n  // Refresh headers before enrichment (ensures up-to-date column mappings)\n  Logger.log('\\nüîÑ REFRESHING HEADERS\\n');\n  try {\n    if (typeof refreshHeaders === 'function') {\n      refreshHeaders();\n      Logger.log('‚úÖ Headers refreshed successfully\\n');\n    } else {\n      Logger.log('‚ö†Ô∏è  refreshHeaders() function not found, skipping\\n');\n    }\n  } catch (e) {\n    Logger.log(`‚ö†Ô∏è  Could not refresh headers: ${e.message}\\n`);\n  }\n\n  const layers = getCacheLayerDefinitions_();\n  const results = [];\n\n  Logger.log('\\nüöÄ STARTING MULTI-LAYER CACHE ENRICHMENT\\n');\n  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n');\n\n  // Sort layers by priority\n  const layerKeys = Object.keys(layers).sort(function(a, b) {\n    return layers[a].priority - layers[b].priority;\n  });\n\n  layerKeys.forEach(function(layerKey) {\n    try {\n      const result = enrichCacheLayer_(layerKey);\n      results.push(result);\n      Logger.log('');\n    } catch (e) {\n      Logger.log(`   ‚ùå Error enriching ${layerKey}: ${e.message}\\n`);\n      results.push({\n        success: false,\n        layerKey: layerKey,\n        error: e.message\n      });\n    }\n  });\n\n  const totalElapsed = new Date().getTime() - startTime;\n  const successCount = results.filter(function(r) { return r.success; }).length;\n\n  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n  Logger.log(`‚úÖ ENRICHMENT COMPLETE: ${successCount}/${results.length} layers successful`);\n  Logger.log(`‚è±Ô∏è  Total time: ${(totalElapsed / 1000).toFixed(1)}s\\n`);\n\n  return {\n    success: successCount === results.length,\n    totalLayers: results.length,\n    successfulLayers: successCount,\n    totalElapsedMs: totalElapsed,\n    results: results\n  };\n}\n\n// ============================================================================\n// CACHE READER & MERGER\n// ============================================================================\n\n/**\n * Read a single cache layer\n *\n * @param {string} sheetName - Name of cache sheet\n * @returns {Object|null} Cached data or null if not found/stale\n */\nfunction readCacheLayer_(sheetName) {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const cacheSheet = ss.getSheetByName(sheetName);\n\n  if (!cacheSheet) {\n    return null;\n  }\n\n  try {\n    const data = cacheSheet.getDataRange().getValues();\n\n    if (data.length < 2) {\n      return null;\n    }\n\n    const cachedTimestamp = new Date(data[1][0]);\n    const now = new Date();\n    const hoursDiff = (now - cachedTimestamp) / (1000 * 60 * 60);\n\n    // 24-hour expiry\n    if (hoursDiff >= 24) {\n      Logger.log(`‚ö†Ô∏è  Cache layer ${sheetName} is stale (${hoursDiff.toFixed(1)}h old)`);\n      return null;\n    }\n\n    const jsonData = data[1][1];\n    const parsed = JSON.parse(jsonData);\n\n    Logger.log(`‚úÖ Cache layer ${sheetName} is fresh (${hoursDiff.toFixed(1)}h old, ${parsed.allCases.length} cases)`);\n\n    return parsed;\n  } catch (e) {\n    Logger.log(`‚ùå Error reading cache layer ${sheetName}: ${e.message}`);\n    return null;\n  }\n}\n\n/**\n * Merge all available cache layers into single enriched dataset\n *\n * @returns {Object} Merged cache data with all available fields\n */\nfunction mergeAllCacheLayers_() {\n  Logger.log('\\nüîÄ MERGING CACHE LAYERS\\n');\n  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\\n');\n\n  const layers = getCacheLayerDefinitions_();\n  const mergedByCase = {};\n\n  // Sort layers by priority\n  const layerKeys = Object.keys(layers).sort(function(a, b) {\n    return layers[a].priority - layers[b].priority;\n  });\n\n  let totalLayersFound = 0;\n  let totalFieldsAvailable = 0;\n\n  layerKeys.forEach(function(layerKey) {\n    const layerDef = layers[layerKey];\n    const cacheData = readCacheLayer_(layerDef.sheetName);\n\n    if (cacheData && cacheData.allCases) {\n      totalLayersFound++;\n      Logger.log(`üì¶ Layer ${layerDef.priority}: ${layerKey} (${cacheData.allCases.length} cases, ${Object.keys(layerDef.fields).length} fields)`);\n\n      cacheData.allCases.forEach(function(caseData) {\n        if (!mergedByCase[caseData.caseId]) {\n          mergedByCase[caseData.caseId] = {};\n        }\n\n        // Merge fields (later layers override earlier ones if conflict)\n        Object.keys(caseData).forEach(function(key) {\n          mergedByCase[caseData.caseId][key] = caseData[key];\n        });\n      });\n\n      totalFieldsAvailable += Object.keys(layerDef.fields).length;\n    } else {\n      Logger.log(`‚è≠Ô∏è  Layer ${layerDef.priority}: ${layerKey} - not cached or stale`);\n    }\n  });\n\n  const mergedCases = Object.values(mergedByCase);\n  const fieldsPerCase = mergedCases.length > 0 ? Object.keys(mergedCases[0]).length : 0;\n\n  Logger.log('\\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n  Logger.log(`‚úÖ MERGE COMPLETE:`);\n  Logger.log(`   Layers merged: ${totalLayersFound}/${layerKeys.length}`);\n  Logger.log(`   Total cases: ${mergedCases.length}`);\n  Logger.log(`   Fields per case: ${fieldsPerCase}`);\n  Logger.log(`   Field coverage: ${Math.round((fieldsPerCase / 26) * 100)}% of 26 required fields\\n`);\n\n  return {\n    allCases: mergedCases,\n    layersMerged: totalLayersFound,\n    totalCases: mergedCases.length,\n    fieldsPerCase: fieldsPerCase\n  };\n}\n\n// ============================================================================\n// MODIFIED analyzeCatalog_() WITH MULTI-LAYER SUPPORT\n// ============================================================================\n\n/**\n * Get case catalog for AI discovery with multi-layer cache support\n *\n * TIER 1: Try merged multi-layer cache\n * TIER 2: Try basic cache only\n * TIER 3: Fresh lightweight analysis\n */\n\n/**\n * Lightweight analysis fallback (simplified version of original)\n */\nfunction performLightweightAnalysis_() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const sheet = ss.getSheets().find(function(sh) {\n    return /master.*scenario.*convert/i.test(sh.getName());\n  }) || ss.getActiveSheet();\n\n  const data = sheet.getDataRange().getValues();\n  const headers = data[1];\n\n  const caseIdIdx = 0;\n  const sparkIdx = 1;\n  const pathwayIdx = 5;\n\n  const allCases = [];\n  for (let i = 2; i < data.length; i++) {\n    allCases.push({\n      caseId: data[i][caseIdIdx] || '',\n      sparkTitle: data[i][sparkIdx] || '',\n      pathway: data[i][pathwayIdx] || ''\n    });\n  }\n\n  return { allCases: allCases };\n}\n\n\n// ==================== END OF MONOLITHIC CODE ====================\n\n\n\nfunction checkSavedFields() {\n  const docProps = PropertiesService.getDocumentProperties();\n  const saved = docProps.getProperty('SELECTED_CACHE_FIELDS');\n\n  if (!saved) {\n    return { status: 'NO_SAVED_FIELDS', message: 'No saved field selection found' };\n  }\n\n  try {\n    const fields = JSON.parse(saved);\n    return {\n      status: 'FOUND',\n      count: fields.length,\n      fields: fields\n    };\n  } catch (e) {\n    return {\n      status: 'ERROR',\n      message: 'Error parsing saved fields: ' + e.message,\n      raw: saved\n    };\n  }\n\nfunction diagnoseFieldSelection() {\n  const docProps = PropertiesService.getDocumentProperties();\n\n  const selectedJson = docProps.getProperty('SELECTED_CACHE_FIELDS');\n  const cachedKeysJson = docProps.getProperty('CACHED_MERGED_KEYS');\n\n  Logger.log('='.repeat(70));\n  Logger.log('SELECTED_CACHE_FIELDS:');\n  if (selectedJson) {\n    const selected = JSON.parse(selectedJson);\n    Logger.log('Count: ' + selected.length);\n    Logger.log('Fields: ' + JSON.stringify(selected, null, 2));\n  } else {\n    Logger.log('NULL - not set!');\n  }\n\n  Logger.log('='.repeat(70));\n  Logger.log('CACHED_MERGED_KEYS:');\n  if (cachedKeysJson) {\n    const keys = JSON.parse(cachedKeysJson);\n    Logger.log('Count: ' + keys.length);\n    Logger.log('First 10: ' + JSON.stringify(keys.slice(0, 10), null, 2));\n  } else {\n    Logger.log('NULL - not set!');\n  }\n\n  Logger.log('='.repeat(70));\n\n  // Check which selected fields exist in cached keys\n  if (selectedJson && cachedKeysJson) {\n    const selected = JSON.parse(selectedJson);\n    const keys = JSON.parse(cachedKeysJson);\n\n    Logger.log('VALIDATION:');\n    let validCount = 0;\n    let invalidCount = 0;\n\n    for (let i = 0; i < selected.length; i++) {\n      const field = selected[i];\n      if (keys.indexOf(field) !== -1) {\n        validCount++;\n      } else {\n        invalidCount++;\n        Logger.log('‚ùå MISSING: ' + field);\n      }\n    }\n\n    Logger.log('Valid: ' + validCount + ' / ' + selected.length);\n    Logger.log('Invalid: ' + invalidCount);\n  }\n\n  Logger.log('='.repeat(70));\n\n  return { done: true };\n}\n}\n\n\n/**\n * ===========================================================================\n * PATHWAYS REFINEMENT FUNCTIONS - ADD TO EXISTING APPS SCRIPT\n * ===========================================================================\n *\n * SAFE TO ADD: These functions are self-contained and won't disrupt existing code\n *\n * Date: 2025-11-10\n * Purpose: Enable pathway refinement workflow (accronym assignment, categorization)\n *\n * TO DEPLOY:\n * 1. Open your Google Sheet\n * 2. Extensions ‚Üí Apps Script\n * 3. Scroll to bottom of your existing Code.gs file\n * 4. Paste this entire block below existing functions\n * 5. Save (Cmd+S)\n *\n * NOTE: Schema columns (S-AC) already added via Sheets API on 2025-11-10\n * ===========================================================================\n */\n\n\n// ============================================================================\n// ACCRONYM MAPPING FUNCTIONS\n// ============================================================================\n\n/**\n * Get accronym mapping from Aaron's finalized Google Sheet\n * Returns object with symptom and category mappings\n *\n * Used by: Refinement UI to populate category dropdowns\n */\nfunction getAccronymMapping() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const mappingSheet = ss.getSheetByName('accronym_symptom_system_mapping');\n  \n  if (!mappingSheet) {\n    throw new Error('Mapping sheet not found: accronym_symptom_system_mapping');\n  }\n  \n  const data = mappingSheet.getDataRange().getValues();\n  const mapping = {};\n\n  // Skip header row\n  for (let i = 1; i < data.length; i++) {\n    const accronym = data[i][0];\n    if (!accronym) continue; // Skip empty rows\n\n    mapping[accronym] = {\n      symptom: data[i][1] || '',\n      system: data[i][2] || '',\n      description: data[i][3] || ''\n    };\n  }\n\n  Logger.log('üìã Loaded ' + Object.keys(mapping).length + ' accronym mappings from local sheet');\n  return mapping;\n}\n// ============================================================================\n// PATHWAY REFINEMENT FUNCTIONS\n// ============================================================================\n\n/**\n * Populate categories for a pathway based on accronym\n * Auto-fills Pre/Post experience categories when accronym is selected\n *\n * Used by: Refinement UI when user selects accronym dropdown\n *\n * @param {string} pathwayId - Pathway_ID (e.g., \"PATH_001\")\n * @param {string} accronym - Chief complaint accronym (e.g., \"CP\", \"SOB\")\n * @return {object} Success status and populated categories\n */\nfunction populateCategoriesFromAccronym(pathwayId, accronym) {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const pathwaysSheet = ss.getSheetByName('Pathways_Master');\n  const mapping = getAccronymMapping();\n\n  if (!mapping[accronym]) {\n    throw new Error('Invalid accronym: ' + accronym);\n  }\n\n  // Find pathway row\n  const data = pathwaysSheet.getDataRange().getValues();\n  let pathwayRow = -1;\n\n  for (let i = 1; i < data.length; i++) {\n    if (data[i][0] === pathwayId) {\n      pathwayRow = i + 1;\n      break;\n    }\n  }\n\n  if (pathwayRow === -1) {\n    throw new Error('Pathway not found: ' + pathwayId);\n  }\n\n  // Update columns with mapping data\n  const accronymData = mapping[accronym];\n\n  // Column S: Chief_Complaint_Accronym\n  pathwaysSheet.getRange(pathwayRow, 19).setValue(accronym);\n\n  // Column W: Pre_Experience_Category\n  pathwaysSheet.getRange(pathwayRow, 23).setValue(accronymData.preCategory);\n\n  // Column X: Post_Experience_Category\n  pathwaysSheet.getRange(pathwayRow, 24).setValue(accronymData.postCategory);\n\n  // Column Y: Post_Experience_Category_Alt1\n  if (accronymData.postCategoryAlt1) {\n    pathwaysSheet.getRange(pathwayRow, 25).setValue(accronymData.postCategoryAlt1);\n  }\n\n  // Column Z: Post_Experience_Category_Alt2\n  if (accronymData.postCategoryAlt2) {\n    pathwaysSheet.getRange(pathwayRow, 26).setValue(accronymData.postCategoryAlt2);\n  }\n\n  Logger.log('‚úÖ Populated categories for ' + pathwayId + ' with accronym: ' + accronym);\n\n  return {\n    success: true,\n    accronym: accronym,\n    preCategory: accronymData.preCategory,\n    postCategory: accronymData.postCategory\n  };\n}\n\n/**\n * Generate new Case IDs for pathway based on accronym and pathway number\n *\n * Example: accronym=\"CP\", pathwayNumber=1, caseCount=4\n *   ‚Üí [\"CP101\", \"CP102\", \"CP103\", \"CP104\"]\n *\n * Used by: Refinement UI to preview proposed Case IDs\n *\n * @param {string} accronym - Chief complaint accronym (e.g., \"CP\")\n * @param {number} pathwayNumber - Pathway number within symptom (1-9)\n * @param {number} caseCount - Number of cases in pathway\n * @return {Array<string>} Array of new Case IDs\n */\nfunction generateNewCaseIDs(accronym, pathwayNumber, caseCount) {\n  const newCaseIDs = [];\n\n  for (let i = 1; i <= caseCount; i++) {\n    const caseNumber = String(i).padStart(2, '0'); // 01, 02, 03, etc.\n    const caseID = accronym + pathwayNumber + caseNumber;\n    newCaseIDs.push(caseID);\n  }\n\n  return newCaseIDs;\n}\n\n/**\n * Update pathway refinement data\n * Saves all refinement fields for a pathway\n *\n * Used by: Refinement UI \"Save Draft\" button\n *\n * @param {string} pathwayId - Pathway_ID\n * @param {object} refinementData - Object with refinement fields\n * @return {object} Success status\n */\nfunction updatePathwayRefinement(pathwayId, refinementData) {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const pathwaysSheet = ss.getSheetByName('Pathways_Master');\n\n  // Find pathway row\n  const data = pathwaysSheet.getDataRange().getValues();\n  let pathwayRow = -1;\n\n  for (let i = 1; i < data.length; i++) {\n    if (data[i][0] === pathwayId) {\n      pathwayRow = i + 1;\n      break;\n    }\n  }\n\n  if (pathwayRow === -1) {\n    throw new Error('Pathway not found: ' + pathwayId);\n  }\n\n  // Update columns based on provided data\n  if (refinementData.accronym) {\n    pathwaysSheet.getRange(pathwayRow, 19).setValue(refinementData.accronym); // Column S\n  }\n\n  if (refinementData.pathwayNumber) {\n    pathwaysSheet.getRange(pathwayRow, 20).setValue(refinementData.pathwayNumber); // Column T\n  }\n\n  if (refinementData.proposedNewCaseIDs) {\n    const caseIDsJson = JSON.stringify(refinementData.proposedNewCaseIDs);\n    pathwaysSheet.getRange(pathwayRow, 22).setValue(caseIDsJson); // Column V\n  }\n\n  if (refinementData.preCategory) {\n    pathwaysSheet.getRange(pathwayRow, 23).setValue(refinementData.preCategory); // Column W\n  }\n\n  if (refinementData.postCategory) {\n    pathwaysSheet.getRange(pathwayRow, 24).setValue(refinementData.postCategory); // Column X\n  }\n\n  Logger.log('‚úÖ Updated refinement data for ' + pathwayId);\n\n  return { success: true };\n}\n\n/**\n * Finalize pathway - marks as ready to apply to production\n * Sets Finalized=TRUE and timestamps\n *\n * Used by: Refinement UI \"Finalize\" button\n *\n * @param {string} pathwayId - Pathway_ID\n * @param {string} userName - User who finalized (e.g., \"Aaron\")\n * @return {object} Success status\n */\nfunction finalizePathway(pathwayId, userName) {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const pathwaysSheet = ss.getSheetByName('Pathways_Master');\n\n  // Find pathway row\n  const data = pathwaysSheet.getDataRange().getValues();\n  let pathwayRow = -1;\n\n  for (let i = 1; i < data.length; i++) {\n    if (data[i][0] === pathwayId) {\n      pathwayRow = i + 1;\n      break;\n    }\n  }\n\n  if (pathwayRow === -1) {\n    throw new Error('Pathway not found: ' + pathwayId);\n  }\n\n  // Validation: Check required fields\n  const accronym = pathwaysSheet.getRange(pathwayRow, 19).getValue();\n  const pathwayNumber = pathwaysSheet.getRange(pathwayRow, 20).getValue();\n  const proposedCaseIDs = pathwaysSheet.getRange(pathwayRow, 22).getValue();\n\n  if (!accronym) {\n    throw new Error('Cannot finalize: Chief Complaint Accronym is required');\n  }\n\n  if (!pathwayNumber) {\n    throw new Error('Cannot finalize: Pathway Number is required');\n  }\n\n  if (!proposedCaseIDs) {\n    throw new Error('Cannot finalize: Proposed Case IDs are required');\n  }\n\n  // Set finalization fields\n  pathwaysSheet.getRange(pathwayRow, 27).setValue('TRUE'); // Column AA: Finalized\n  pathwaysSheet.getRange(pathwayRow, 28).setValue(new Date()); // Column AB: Applied_Date\n  pathwaysSheet.getRange(pathwayRow, 29).setValue(userName); // Column AC: Applied_By\n\n  Logger.log('‚úÖ Finalized pathway: ' + pathwayId);\n\n  return {\n    success: true,\n    pathwayId: pathwayId,\n    finalizedBy: userName,\n    finalizedAt: new Date()\n  };\n}\n\n\n// ============================================================================\n// SCHEMA VERIFICATION FUNCTIONS\n// ============================================================================\n\n/**\n * Verify Pathways_Master schema is correct\n * Checks that all required columns exist\n *\n * Used by: Manual verification, debugging\n */\nfunction verifyPathwaysSchema() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const pathwaysSheet = ss.getSheetByName('Pathways_Master');\n\n  if (!pathwaysSheet) {\n    Logger.log('‚ùå Pathways_Master sheet not found');\n    return;\n  }\n\n  const headers = pathwaysSheet.getRange(1, 1, 1, pathwaysSheet.getLastColumn()).getValues()[0];\n\n  Logger.log('üìä Pathways_Master Schema Verification:');\n  Logger.log('');\n  Logger.log('Total columns: ' + headers.length);\n  Logger.log('');\n\n  headers.forEach((header, index) => {\n    let col = '';\n    if (index < 26) {\n      col = String.fromCharCode(65 + index);\n    } else {\n      col = 'A' + String.fromCharCode(65 + (index - 26));\n    }\n    Logger.log(col + ': ' + header);\n  });\n\n  Logger.log('');\n\n  // Check for required columns\n  const requiredColumns = [\n    'Chief_Complaint_Accronym',\n    'Pathway_Number',\n    'Original_Case_IDs',\n    'Proposed_New_Case_IDs',\n    'Pre_Experience_Category',\n    'Post_Experience_Category',\n    'Finalized',\n    'Applied_Date',\n    'Applied_By'\n  ];\n\n  Logger.log('Checking required columns:');\n  requiredColumns.forEach(col => {\n    const found = headers.includes(col);\n    Logger.log((found ? '‚úÖ' : '‚ùå') + ' ' + col);\n  });\n}\n\n\n// ============================================================================\n// END OF PATHWAYS REFINEMENT FUNCTIONS\n// ============================================================================\n\n\n// ============================================================================\n// AI AUTO-CATEGORIZATION SYSTEM (Added 2025-11-10)\n// ============================================================================\n\n/**\n * ===========================================================================\n * AI AUTO-CATEGORIZATION BACKEND FUNCTIONS\n * ===========================================================================\n *\n * Purpose: Bulk categorize all 207 scenarios with AI suggestions\n * Method: OpenAI GPT-4 analysis ‚Üí Human review ‚Üí Bulk apply\n *\n * Date: 2025-11-10\n * ===========================================================================\n */\n\n\n// ============================================================================\n// MAIN ORCHESTRATOR\n// ============================================================================\n\n/**\n * Main function to run AI categorization on all cases\n * Called by \"Run AI Categorization\" button in Categories tab\n *\n * @return {object} Results with suggestions for all cases\n */\n\n\n/**\n * Build OpenAI prompt for categorization\n */\nfunction buildCategorizationPrompt(cases, validSymptoms, validSystems) {\n  const caseList = cases.map(c => {\n    return {\n      caseID: c.caseID,\n      chiefComplaint: c.chiefComplaint,\n      presentation: c.presentation,\n      diagnosis: c.diagnosis,\n      currentSymptom: c.currentSymptom,\n      currentSystem: c.currentSystem\n    };\n  });\n\n  const prompt = `You are an expert ER triage nurse categorizing medical simulation cases.\n\n**PURPOSE**: We're organizing 207 simulation cases for easy browsing in a medical education app. Users need to quickly find cases by:\n- What the patient presents with (symptom folders like \"Chest Pain\", \"Shortness of Breath\")\n- What the underlying diagnosis is (system folders like \"Cardiovascular\", \"Pulmonary\")\n\nThis allows instructors to select appropriate cases for training scenarios.\n\nFor each case, suggest:\n1. **Symptom Category** (chief complaint accronym) - What patient says/shows\n2. **System Category** (underlying system/diagnosis) - What's actually wrong\n\n**CRITICAL RULES**:\n- Symptom = What patient PRESENTS with (preserves diagnostic mystery)\n- System = Underlying diagnosis/system (revealed after learning)\n- Focus on the CHIEF COMPLAINT and PRESENTATION, NOT the pathway/course name\n- If patient has chest pain ‚Üí Symptom = CP (even if diagnosis is PE, not MI)\n- If diagnosis is MI ‚Üí System = Cardiovascular\n- Use ONLY symptoms from the valid list below\n\n**ACLS RULE (CRITICALLY IMPORTANT - READ CAREFULLY)**:\n\n‚ö†Ô∏è COMMON MISTAKE: \"Advanced Cardiac Life Support\" is a COURSE NAME, not a patient symptom!\n\nDO NOT be fooled by pathway names containing:\n  - \"Advanced Cardiac Life Support\" (it's a training course)\n  - \"Advanced Life Support\" (it's a protocol name)\n  - \"Advanced Critical Care\" (advanced ‚â† cardiac arrest)\n  - \"Advanced Trauma Life Support\" (ATLS is a course)\n  - Any \"Advanced [something] Support\" (these are course/protocol names!)\n\nACLS symptom = Patient is DEAD/DYING RIGHT NOW (no pulse, not breathing, CPR happening)\n\nONLY use ACLS if patient presentation EXPLICITLY states:\n  ‚úì \"Patient found in cardiac arrest\"\n  ‚úì \"Patient is pulseless\" or \"no pulse detected\"\n  ‚úì \"Code blue called\" or \"code blue in progress\"\n  ‚úì \"Patient is in V-fib\" or \"ventricular fibrillation\"\n  ‚úì \"Patient is in asystole\" or \"flatline\"\n  ‚úì \"Patient is in PEA\" (pulseless electrical activity)\n  ‚úì \"CPR in progress\" or \"resuscitation underway\"\n\nIGNORE pathway/course names, focus on PATIENT STATE:\n  ‚úó \"Advanced Cardiac Life Support pathway\" ‚Üí Look at patient, not course name!\n  ‚úó \"Advanced Life Support scenario\" ‚Üí Look at symptoms, not protocol name!\n  ‚úó \"Chest pain (even if MI, use CP)\n  ‚úó Shortness of breath (even if severe, use SOB)\n  ‚úó Altered mental status (even if unresponsive, use AMS)\n  ‚úó Shock/hypotension (use CP or appropriate symptom)\n  ‚úó Heart attack/MI (use CP - they still have a pulse!)\n  ‚úó Severe asthma (use SOB - they're still breathing!)\n\nSimple test: If patient has vital signs, is conscious, or walked in ‚Üí NOT ACLS!\n\nExamples:\n  ‚ùå \"Advanced Cardiac Life Support pathway for MI\" = CP (pathway name, patient has pulse)\n  ‚ùå \"Acute MI patient\" = CP (not ACLS - patient alive)\n  ‚ùå \"Severe Asthma Attack\" = SOB (not ACLS - patient breathing)\n  ‚ùå \"Advanced Trauma Life Support scenario\" = TR (ATLS course, look at injury)\n  ‚ùå \"Advanced Neurological Care\" = AMS (critical care, not cardiac arrest)\n  ‚úÖ \"Patient found pulseless, CPR in progress\" = ACLS (actual cardiac arrest)\n\n**Valid Symptom Categories** (use accronym only):\n${validSymptoms}\n\n**Valid System Categories** (use exact name):\n${validSystems}\n\n**CUSTOM SYMPTOM FALLBACK (LAST RESORT ONLY)**:\nIf NONE of the valid symptoms above fit the case (and you've truly tried everything):\n1. Use an existing symptom if at all possible (be creative with interpretation)\n2. Only as an ABSOLUTE LAST RESORT, you may suggest a custom symptom\n3. If creating custom symptom, MUST follow these rules:\n   - Use 2-4 letter acronym (like existing ones: CP, SOB, AMS, etc.)\n   - Make it memorable and clear\n   - In your reasoning, suggest 4-5 alternatives from the valid list that could work\n   - Mark confidence as \"low\" to flag for manual review\n\nExample of proper custom symptom reasoning:\n\"No existing symptom fits well. Suggesting custom 'DIZZ' for Dizziness/Vertigo cases. Alternatives considered: AMS (altered mental status - too broad), NEUR (too system-focused), HA (headache - not quite right), SOB (shortness of breath - unrelated), TR (trauma - incorrect). Custom symptom needed.\"\n\n**Cases to categorize**:\n${JSON.stringify(caseList, null, 2)}\n\n**Response format** (valid JSON only, no markdown):\n[\n  {\n    \"caseID\": \"GI01234\",\n    \"suggestedSymptom\": \"CP\",\n    \"suggestedSymptomName\": \"Chest Pain Cases\",\n    \"suggestedSystem\": \"Cardiovascular\",\n    \"reasoning\": \"Patient presents with chest pain (CP) but diagnosis is MI (Cardiovascular)\",\n    \"confidence\": \"high\"\n  }\n]\n\nNotes:\n- Use existing symptoms 95%+ of the time\n- Custom symptoms should be RARE (maybe 5-10 cases max out of 207)\n- Always explain why existing options don't work\n- Always suggest alternatives in reasoning\n\nRespond with ONLY the JSON array, no other text.`;\n\n  return prompt;\n}\n\n/**\n * Determine status based on current vs suggested\n */\nfunction determineStatus(caseData, aiSuggestion) {\n  const hasCurrentSymptom = caseData.currentSymptom && caseData.currentSymptom.length > 0;\n  const hasCurrentSystem = caseData.currentSystem && caseData.currentSystem.length > 0;\n\n  if (!hasCurrentSymptom && !hasCurrentSystem) {\n    return 'new'; // Uncategorized - AI suggests new\n  }\n\n  const symptomMatches = caseData.currentSymptom === aiSuggestion.suggestedSymptom;\n  const systemMatches = caseData.currentSystem === aiSuggestion.suggestedSystem;\n\n  if (symptomMatches && systemMatches) {\n    return 'matches'; // AI agrees with current\n  }\n\n  return 'conflict'; // AI disagrees with current\n}\n\n\n// ============================================================================\n// RESULTS STORAGE\n// ============================================================================\n\n/**\n * Save categorization results to temporary sheet for review\n *\n * @param {Array} results - Array of categorization results\n */\nfunction saveCategorizationResults(results) {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n\n  // Check if results sheet exists\n  let resultsSheet = ss.getSheetByName('AI_Categorization_Results');\n\n  if (resultsSheet) {\n    // Clear existing data instead of deleting sheet\n    resultsSheet.clear();\n    Logger.log('‚úÖ Cleared existing AI_Categorization_Results sheet');\n  } else {\n    // Create new results sheet if it doesn't exist\n    resultsSheet = ss.insertSheet('AI_Categorization_Results');\n    Logger.log('‚úÖ Created new AI_Categorization_Results sheet');\n  }\n\n  // Add headers\n  const headers = [\n    'Case_ID',\n    'Legacy_Case_ID',\n    'Row_Index',\n    'Current_Symptom',\n    'Current_System',\n    'Suggested_Symptom',\n    'Suggested_Symptom_Name',\n    'Suggested_System',\n    'AI_Reasoning',\n    'Confidence',\n    'Status',\n    'User_Decision',\n    'Final_Symptom',\n    'Final_System'\n  ];\n\n  resultsSheet.getRange(1, 1, 1, headers.length).setValues([headers]);\n\n  // Format header row\n  resultsSheet.getRange(1, 1, 1, headers.length)\n    .setBackground('#2a3040')\n    .setFontColor('#e7eaf0')\n    .setFontWeight('bold')\n    .setHorizontalAlignment('center');\n\n  // Add data rows\n  const dataRows = results.map(r => [\n    r.caseID,\n    r.legacyCaseID,\n    r.rowIndex,\n    r.currentSymptom,\n    r.currentSystem,\n    r.suggestedSymptom,\n    r.suggestedSymptomName,\n    r.suggestedSystem,\n    r.reasoning,\n    r.confidence,\n    r.status,\n    '', // User_Decision (empty - to be filled in review)\n    r.suggestedSymptom, // Final_Symptom (default to AI suggestion)\n    r.suggestedSystem   // Final_System (default to AI suggestion)\n  ]);\n\n  if (dataRows.length > 0) {\n    resultsSheet.getRange(2, 1, dataRows.length, headers.length).setValues(dataRows);\n  }\n\n  // Apply conditional formatting for status\n  applyStatusFormatting(resultsSheet, results.length);\n\n  // Freeze header row\n  resultsSheet.setFrozenRows(1);\n\n  // Auto-resize columns\n  resultsSheet.autoResizeColumns(1, headers.length);\n\n  Logger.log('‚úÖ Saved ' + results.length + ' results to sheet');\n}\n\n/**\n * Apply conditional formatting to status column\n */\nfunction applyStatusFormatting(sheet, rowCount) {\n  const statusColumn = 11; // Column K: Status\n\n  if (rowCount === 0) return;\n\n  // Color code based on status\n  for (let row = 2; row <= rowCount + 1; row++) {\n    const status = sheet.getRange(row, statusColumn).getValue();\n    const range = sheet.getRange(row, 1, 1, 14); // Entire row\n\n    if (status === 'new') {\n      range.setBackground('#e8f5e9'); // Light green - uncategorized\n    } else if (status === 'matches') {\n      range.setBackground('#f1f8ff'); // Light blue - AI agrees\n    } else if (status === 'conflict') {\n      range.setBackground('#fff3e0'); // Light orange - AI disagrees\n    } else if (status === 'error') {\n      range.setBackground('#ffebee'); // Light red - error\n    }\n  }\n}\n\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\n/**\n * Get OpenAI API key from Settings sheet\n */\nfunction getOpenAIAPIKey() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const settingsSheet = ss.getSheetByName('Settings');\n\n  if (!settingsSheet) {\n    throw new Error('Settings sheet not found');\n  }\n\n  // API key is in Settings!B2\n  const apiKey = settingsSheet.getRange('B2').getValue();\n\n  if (!apiKey || apiKey.length === 0) {\n    throw new Error('OpenAI API key not found in Settings!B2');\n  }\n\n  return apiKey;\n}\n\n\n// ============================================================================\n// TEST FUNCTION\n// ============================================================================\n\n/**\n * Test AI categorization with a small sample\n * Run this first to verify everything works\n */\nfunction testAICategorization() {\n  Logger.log('üß™ Testing AI Categorization with 5 sample cases...');\n  Logger.log('');\n\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const masterSheet = ss.getSheetByName('Master Scenario Convert');\n\n  // Get first 5 cases (rows 3-7)\n  const data = masterSheet.getRange(3, 1, 5, 646).getValues();\n\n  const testCases = [];\n  for (let i = 0; i < data.length; i++) {\n    const row = data[i];\n    testCases.push({\n      rowIndex: i + 3,\n      caseID: row[0],\n      legacyCaseID: row[8],\n      currentSymptom: row[23] || '',\n      currentSystem: row[24] || '',\n      chiefComplaint: row[4] || '',\n      presentation: row[5] || '',\n      diagnosis: row[6] || ''\n    });\n  }\n\n  Logger.log('üìä Test cases:');\n  testCases.forEach(c => {\n    Logger.log('   ' + c.caseID + ': ' + c.chiefComplaint);\n  });\n  Logger.log('');\n\n  try {\n    const results = categorizeBatchWithAI(testCases);\n\n    Logger.log('‚úÖ AI Categorization successful!');\n    Logger.log('');\n    Logger.log('üìã Results:');\n\n    results.forEach(r => {\n      Logger.log('   ' + r.caseID);\n      Logger.log('      Suggested: ' + r.suggestedSymptom + ' / ' + r.suggestedSystem);\n      Logger.log('      Reasoning: ' + r.reasoning);\n      Logger.log('      Status: ' + r.status);\n      Logger.log('');\n    });\n\n    return results;\n\n  } catch (error) {\n    Logger.log('‚ùå Test failed: ' + error.message);\n    throw error;\n  }\n}\n\n\n/**\n * ===========================================================================\n * AI CATEGORIZATION APPLICATION FUNCTIONS\n * ===========================================================================\n *\n * Purpose: Apply reviewed categorizations to Master Scenario Convert\n * Method: Read from AI_Categorization_Results ‚Üí Validate ‚Üí Update Master\n *\n * Date: 2025-11-10\n * ===========================================================================\n */\n\n\n// ============================================================================\n// MAIN APPLICATION FUNCTION\n// ============================================================================\n\n/**\n * Apply categorizations from results sheet to Master Scenario Convert\n * Called after user reviews and approves suggestions\n *\n * @param {string} applyMode - 'all' | 'selected' | 'conflicts-only'\n * @return {object} Application results\n */\nfunction testApplyLogs() {\n  PropertiesService.getDocumentProperties().deleteProperty('Sidebar_Logs');\n  addAILog('üß™ TEST: Logs are working!');\n  addAILog('   If you can see this, logs are being written correctly.');\n  addAILog('   The issue is elsewhere.');\n  return 'Test complete - check your log viewer';\n}\n\nfunction applyCategorization(applyMode) {\n  applyMode = applyMode || 'all';\n\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const resultsSheet = ss.getSheetByName('AI_Categorization_Results');\n  const masterSheet = ss.getSheetByName('Master Scenario Convert');\n\n  if (!resultsSheet) {\n    throw new Error('AI_Categorization_Results sheet not found. Run AI categorization first.');\n  }\n\n  Logger.log('üöÄ Starting categorization application...');\n  Logger.log('   Mode: ' + applyMode);\n  Logger.log('');\n\n  // Get all results\n  const lastRow = resultsSheet.getLastRow();\n  if (lastRow < 2) {\n    throw new Error('No categorization results found');\n  }\n\n  const data = resultsSheet.getRange(2, 1, lastRow - 1, 14).getValues();\n\n  Logger.log('üìä Loaded ' + data.length + ' categorization results');\n\n  // Parse results\n  const categorizationData = {};\n\n  for (let i = 0; i < data.length; i++) {\n    const row = data[i];\n\n    const caseID = row[0];\n    const legacyCaseID = row[1];\n    const finalSymptom = row[12]; // Column M: Final_Symptom\n    const finalSystem = row[13];  // Column N: Final_System\n    const status = row[10];       // Column K: Status\n\n    // Apply mode filtering\n    if (applyMode === 'conflicts-only' && status !== 'conflict') {\n      continue; // Skip non-conflicts\n    }\n\n    // Only include cases with final values\n    if (finalSymptom && finalSystem) {\n      categorizationData[caseID] = {\n        caseID: caseID,\n        legacyCaseID: legacyCaseID,\n        symptom: finalSymptom,\n        symptomName: row[14] || finalSymptom,  // Column O: Final_Symptom_Name\n        system: finalSystem,\n        status: status\n      };\n    }\n  }\n\n  Logger.log('üìù Filtered to ' + Object.keys(categorizationData).length + ' cases to update');\n  Logger.log('');\n\n  // Run 5-layer validation\n  validateCategorization(categorizationData, masterSheet);\n\n  Logger.log('‚úÖ Validation passed');\n  Logger.log('');\n\n  // Create backup\n  const backupName = createBackup(masterSheet);\n  Logger.log('‚úÖ Backup created: ' + backupName);\n  Logger.log('');\n\n  // User confirmation\n  const ui = SpreadsheetApp.getUi();\n  const confirmMessage = 'Apply categorization to ' + Object.keys(categorizationData).length + ' cases in Master Scenario Convert?\\n\\n' +\n                        'Backup created: ' + backupName + '\\n\\n' +\n                        'This will update Category_Symptom, Category_System, Category_Symptom_Name, and Category_System_Name columns.';\n\n  const response = ui.alert('Confirm Categorization', confirmMessage, ui.ButtonSet.YES_NO);\n\n  if (response !== ui.Button.YES) {\n    Logger.log('‚ùå User cancelled');\n    return {\n      success: false,\n      message: 'User cancelled operation'\n    };\n  }\n\n  Logger.log('‚úÖ User confirmed');\n  Logger.log('');\n\n  // Apply updates\n  const updateResults = applyCategorizationUpdates(categorizationData, masterSheet);\n\n  Logger.log('');\n  Logger.log('üéâ Categorization application complete!');\n  Logger.log('   Cases updated: ' + updateResults.updated);\n  Logger.log('   Errors: ' + updateResults.errors);\n\n  return {\n    success: true,\n    updated: updateResults.updated,\n    errors: updateResults.errors,\n    backup: backupName\n  };\n}\n\n\n// ============================================================================\n// VALIDATION FUNCTIONS\n// ============================================================================\n\n/**\n * 5-Layer validation before applying categorization\n */\nfunction validateCategorization(categorizationData, masterSheet) {\n  Logger.log('üîí Running 5-layer validation...');\n  Logger.log('');\n\n  // Layer 1: Check all cases exist in Master\n  Logger.log('Layer 1: Verifying all cases exist...');\n  for (const caseID in categorizationData) {\n    const cat = categorizationData[caseID];\n    const legacyCaseID = cat.legacyCaseID;\n    \n    // Try Legacy_Case_ID first\n    let row;\n    if (legacyCaseID && legacyCaseID.length > 0) {\n      row = findRowByLegacyCaseID(masterSheet, legacyCaseID);\n    }\n    \n    // Fallback to Case_ID if not found\n    if (!row) {\n      row = findRowByCaseID(masterSheet, caseID);\n    }\n    \n    if (!row) {\n      throw new Error('Layer 1 failed: Case not found - ' + caseID);\n    }\n  }\n  Logger.log('‚úÖ Layer 1 passed: All cases exist');\n\n  // Layer 2: Validate all symptom accronyms\n  Logger.log('Layer 2: Validating symptom accronyms...');\n  const validSymptoms = getAccronymMapping();\n\n  for (const caseID in categorizationData) {\n    const cat = categorizationData[caseID];\n    if (!validSymptoms[cat.symptom]) {\n      throw new Error('Layer 2 failed: Invalid symptom accronym - ' + cat.symptom + ' for case ' + caseID);\n    }\n  }\n  Logger.log('‚úÖ Layer 2 passed: All symptom accronyms valid');\n\n  // Layer 3: Validate all system categories\n  Logger.log('Layer 3: Validating system categories...');\n  const validSystems = getValidSystemCategories();\n\n  for (const caseID in categorizationData) {\n    const cat = categorizationData[caseID];\n    if (!validSystems.includes(cat.system)) {\n      throw new Error('Layer 3 failed: Invalid system category - ' + cat.system + ' for case ' + caseID);\n    }\n  }\n  Logger.log('‚úÖ Layer 3 passed: All system categories valid');\n\n  // Layer 4: Check for data integrity\n  Logger.log('Layer 4: Checking data integrity...');\n  for (const caseID in categorizationData) {\n    const cat = categorizationData[caseID];\n    if (!caseID || caseID.length === 0) {\n      throw new Error('Layer 4 failed: Empty Case_ID found');\n    }\n    if (!cat.symptom || !cat.system) {\n      throw new Error('Layer 4 failed: Missing symptom or system for ' + caseID);\n    }\n  }\n  Logger.log('‚úÖ Layer 4 passed: Data integrity verified');\n\n  // Layer 5: Final check\n  Logger.log('Layer 5: Final validation...');\n  Logger.log('‚úÖ Layer 5 passed: All checks complete');\n\n  Logger.log('');\n  Logger.log('‚úÖ All 5 layers passed - safe to proceed');\n  return true;\n}\nfunction getValidSystemCategories() {\n  return [\n    'Cardiovascular',\n    'Pulmonary',\n    'Gastrointestinal',\n    'Neurologic',\n    'Endocrine/Metabolic',\n    'Renal/Genitourinary',\n    'Hematologic/Oncologic',\n    'Infectious Disease',\n    'Toxicology',\n    'Trauma',\n    'Obstetrics/Gynecology',\n    'Pediatrics',\n    'HEENT',\n    'Musculoskeletal',\n    'Critical Care',\n    'Dermatologic',\n    'Psychiatric',\n    'Environmental'\n  ];\n}\n\n/**\n * Create backup of Master Scenario Convert\n */\nfunction createBackup(masterSheet) {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss');\n  const backupName = 'Master Scenario Convert (Backup ' + timestamp + ')';\n\n  const backup = masterSheet.copyTo(ss);\n  backup.setName(backupName);\n\n  // Move backup to end\n  ss.moveActiveSheet(ss.getNumSheets());\n\n  return backupName;\n}\n\n\n// ============================================================================\n// UPDATE FUNCTIONS\n// ============================================================================\n\n/**\n * Apply categorization updates to Master Scenario Convert\n */\n\nfunction findRowByLegacyCaseID(sheet, legacyCaseID) {\n  addAILog('üîç findRowByLegacyCaseID: Looking for \"' + legacyCaseID + '\"');\n  addAILog('   Sheet: ' + (sheet ? sheet.getName() : 'NULL'));\n  Logger.log('üîç findRowByLegacyCaseID called with legacyCaseID: ' + legacyCaseID);\n  Logger.log('   Sheet name: ' + (sheet ? sheet.getName() : 'NULL'));\n  \n  const legacyColumn = 9; // Column I: Legacy_Case_ID\n  const lastRow = sheet.getLastRow();\n\n  // Get all Legacy_Case_ID values (skip 2 header rows)\n  const data = sheet.getRange(3, legacyColumn, lastRow - 2, 1).getValues();\n\n  for (let i = 0; i < data.length; i++) {\n    if (data[i][0] === legacyCaseID) {\n      return i + 3; // Row number (1-indexed, +2 for headers, +1 for array offset)\n    }\n  }\n\n  addAILog('   ‚ùå NOT FOUND (searched ' + data.length + ' rows)');\n  addAILog('   ‚ùå NOT FOUND (searched ' + data.length + ' rows)');\n  Logger.log('   ‚ùå NOT FOUND in ' + data.length + ' rows searched');\n  return null; // Not found\n}\n\n\n// ============================================================================\n// REVIEW INTERFACE HELPERS\n// ============================================================================\n\n/**\n * Find row in Master sheet by Case_ID\n * Used as fallback when Legacy_Case_ID is empty\n */\nfunction findRowByCaseID(sheet, caseID) {\n  addAILog('üîç findRowByCaseID: Looking for \"' + caseID + '\"');\n  addAILog('   Sheet: ' + (sheet ? sheet.getName() : 'NULL'));\n  Logger.log('üîç findRowByCaseID called with caseID: ' + caseID);\n  Logger.log('   Sheet name: ' + (sheet ? sheet.getName() : 'NULL'));\n  \n  const caseIDColumn = 1; // Column A: Case_ID\n  const lastRow = sheet.getLastRow();\n\n  // Get all Case_ID values (skip 2 header rows)\n  const data = sheet.getRange(3, caseIDColumn, lastRow - 2, 1).getValues();\n\n  for (let i = 0; i < data.length; i++) {\n    if (data[i][0] === caseID) {\n      addAILog('   ‚úÖ FOUND at row ' + (i + 3));\n      Logger.log('   ‚úÖ FOUND at index ' + i + ', returning row ' + (i + 3));\n      return i + 3; // Row number (1-indexed, +2 for headers, +1 for array offset)\n    }\n  }\n\n  Logger.log('   ‚ùå NOT FOUND in ' + data.length + ' rows searched');\n  return null; // Not found\n}\n\n\n\n/**\n * Get categorization statistics for UI display\n */\nfunction getCategorizationStats() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const resultsSheet = ss.getSheetByName('AI_Categorization_Results');\n\n  if (!resultsSheet) {\n    return {\n      total: 0,\n      new: 0,\n      matches: 0,\n      conflicts: 0,\n      errors: 0\n    };\n  }\n\n  const lastRow = resultsSheet.getLastRow();\n  if (lastRow < 2) {\n    return {\n      total: 0,\n      new: 0,\n      matches: 0,\n      conflicts: 0,\n      errors: 0\n    };\n  }\n\n  const statusData = resultsSheet.getRange(2, 11, lastRow - 1, 1).getValues(); // Column K: Status\n\n  const stats = {\n    total: statusData.length,\n    new: 0,\n    matches: 0,\n    conflicts: 0,\n    errors: 0\n  };\n\n  statusData.forEach(row => {\n    const status = row[0];\n    if (status === 'new') stats.new++;\n    else if (status === 'matches') stats.matches++;\n    else if (status === 'conflict') stats.conflicts++;\n    else if (status === 'error') stats.errors++;\n  });\n\n  return stats;\n}\n\n/**\n * Get categorization results for UI display\n * Returns filtered/paginated results\n */\nfunction getCategorizationResults(filter, page, pageSize) {\n  filter = filter || 'all';\n  page = page || 1;\n  pageSize = pageSize || 50;\n\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const resultsSheet = ss.getSheetByName('AI_Categorization_Results');\n\n  if (!resultsSheet) {\n    return { results: [], total: 0 };\n  }\n\n  const lastRow = resultsSheet.getLastRow();\n  if (lastRow < 2) {\n    return { results: [], total: 0 };\n  }\n\n  const data = resultsSheet.getRange(2, 1, lastRow - 1, 14).getValues();\n\n  // Filter results\n  let filtered = data.filter(row => {\n    const status = row[10]; // Column K: Status\n\n    if (filter === 'all') return true;\n    if (filter === 'new') return status === 'new';\n    if (filter === 'matches') return status === 'matches';\n    if (filter === 'conflicts') return status === 'conflict';\n    if (filter === 'errors') return status === 'error';\n\n    return true;\n  });\n\n  // Paginate\n  const start = (page - 1) * pageSize;\n  const end = start + pageSize;\n  const paginated = filtered.slice(start, end);\n\n  // Format for UI\n  const results = paginated.map(row => {\n    return {\n      caseID: row[0],\n      legacyCaseID: row[1],\n      rowIndex: row[2],\n      currentSymptom: row[3],\n      currentSystem: row[4],\n      suggestedSymptom: row[5],\n      suggestedSymptomName: row[6],\n      suggestedSystem: row[7],\n      reasoning: row[8],\n      confidence: row[9],\n      status: row[10],\n      userDecision: row[11],\n      finalSymptom: row[12],\n      finalSystem: row[13]\n    };\n  });\n\n  return {\n    results: results,\n    total: filtered.length,\n    page: page,\n    pageSize: pageSize,\n    totalPages: Math.ceil(filtered.length / pageSize)\n  };\n}\n\n\n// ============================================================================\n// ROLLBACK FUNCTION\n// ============================================================================\n\n/**\n * Rollback to most recent backup\n */\nfunction rollbackCategorization() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const sheets = ss.getSheets();\n\n  // Find most recent backup\n  let latestBackup = null;\n  let latestTimestamp = 0;\n\n  sheets.forEach(sheet => {\n    const name = sheet.getName();\n    if (name.startsWith('Master Scenario Convert (Backup')) {\n      // Extract timestamp from name\n      const match = name.match(/Backup (\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2})/);\n      if (match) {\n        const timestamp = new Date(match[1]).getTime();\n        if (timestamp > latestTimestamp) {\n          latestTimestamp = timestamp;\n          latestBackup = sheet;\n        }\n      }\n    }\n  });\n\n  if (!latestBackup) {\n    throw new Error('No backup found to rollback to');\n  }\n\n  const ui = SpreadsheetApp.getUi();\n  const response = ui.alert(\n    'Confirm Rollback',\n    'Restore Master Scenario Convert from backup: ' + latestBackup.getName() + '?',\n    ui.ButtonSet.YES_NO\n  );\n\n  if (response !== ui.Button.YES) {\n    return { success: false, message: 'User cancelled' };\n  }\n\n  // Delete current Master Scenario Convert\n  const currentMaster = ss.getSheetByName('Master Scenario Convert');\n  if (currentMaster) {\n    ss.deleteSheet(currentMaster);\n  }\n\n  // Rename backup to Master Scenario Convert\n  latestBackup.setName('Master Scenario Convert');\n\n  Logger.log('‚úÖ Rolled back to: ' + latestBackup.getName());\n\n  return {\n    success: true,\n    message: 'Rolled back to backup: ' + latestBackup.getName()\n  };\n}\n\n\n// ============================================================================\n// AI AUTO-CATEGORIZATION SYSTEM (Updated 2025-11-10)\n// Column mappings updated for Case_Organization group\n// ============================================================================\n\n/**\n * ===========================================================================\n * AI AUTO-CATEGORIZATION BACKEND FUNCTIONS\n * ===========================================================================\n *\n * Purpose: Bulk categorize all 207 scenarios with AI suggestions\n * Method: OpenAI GPT-4 analysis ‚Üí Human review ‚Üí Bulk apply\n *\n * Date: 2025-11-10\n * ===========================================================================\n */\n\n\n// ============================================================================\n// MAIN ORCHESTRATOR\n// ============================================================================\n\n/**\n * Main function to run AI categorization on all cases\n * Called by \"Run AI Categorization\" button in Categories tab\n *\n * @return {object} Results with suggestions for all cases\n */\n\n\n\n// ============================================================================\n// AI PROCESSING\n// ============================================================================\n\n/**\n * Send batch of cases to OpenAI for categorization\n *\n * @param {Array} cases - Array of case objects\n * @return {Array} Array of categorization results\n */\n\n\n/**\n * Build OpenAI prompt for categorization\n */\n\n\n/**\n * Determine status based on current vs suggested\n */\nfunction determineStatus(caseData, aiSuggestion) {\n  const hasCurrentSymptom = caseData.currentSymptom && caseData.currentSymptom.length > 0;\n  const hasCurrentSystem = caseData.currentSystem && caseData.currentSystem.length > 0;\n\n  if (!hasCurrentSymptom && !hasCurrentSystem) {\n    return 'new'; // Uncategorized - AI suggests new\n  }\n\n  const symptomMatches = caseData.currentSymptom === aiSuggestion.suggestedSymptom;\n  const systemMatches = caseData.currentSystem === aiSuggestion.suggestedSystem;\n\n  if (symptomMatches && systemMatches) {\n    return 'matches'; // AI agrees with current\n  }\n\n  return 'conflict'; // AI disagrees with current\n}\n\n\n// ============================================================================\n// RESULTS STORAGE\n// ============================================================================\n\n/**\n * Save categorization results to temporary sheet for review\n *\n * @param {Array} results - Array of categorization results\n */\n\n\n/**\n * Apply conditional formatting to status column\n */\nfunction applyStatusFormatting(sheet, rowCount) {\n  const statusColumn = 11; // Column K: Status\n\n  if (rowCount === 0) return;\n\n  // Color code based on status\n  for (let row = 2; row <= rowCount + 1; row++) {\n    const status = sheet.getRange(row, statusColumn).getValue();\n    const range = sheet.getRange(row, 1, 1, 14); // Entire row\n\n    if (status === 'new') {\n      range.setBackground('#e8f5e9'); // Light green - uncategorized\n    } else if (status === 'matches') {\n      range.setBackground('#f1f8ff'); // Light blue - AI agrees\n    } else if (status === 'conflict') {\n      range.setBackground('#fff3e0'); // Light orange - AI disagrees\n    } else if (status === 'error') {\n      range.setBackground('#ffebee'); // Light red - error\n    }\n  }\n}\n\n\n// ============================================================================\n// HELPER FUNCTIONS\n// ============================================================================\n\n/**\n * Get OpenAI API key from Settings sheet\n */\nfunction getOpenAIAPIKey() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const settingsSheet = ss.getSheetByName('Settings');\n\n  if (!settingsSheet) {\n    throw new Error('Settings sheet not found');\n  }\n\n  // API key is in Settings!B2\n  const apiKey = settingsSheet.getRange('B2').getValue();\n\n  if (!apiKey || apiKey.length === 0) {\n    throw new Error('OpenAI API key not found in Settings!B2');\n  }\n\n  return apiKey;\n}\n\n\n// ============================================================================\n// TEST FUNCTION\n// ============================================================================\n\n/**\n * Test AI categorization with a small sample\n * Run this first to verify everything works\n */\nfunction testAICategorization() {\n  Logger.log('üß™ Testing AI Categorization with 5 sample cases...');\n  Logger.log('');\n\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const masterSheet = ss.getSheetByName('Master Scenario Convert');\n\n  // Get first 5 cases (rows 3-7)\n  const data = masterSheet.getRange(3, 1, 5, 646).getValues();\n\n  const testCases = [];\n  for (let i = 0; i < data.length; i++) {\n    const row = data[i];\n    testCases.push({\n      rowIndex: i + 3,\n      caseID: row[0],\n      legacyCaseID: row[8],\n      currentSymptom: row[17] || '',      // Column R: Case_Organization_Category_Symptom\n      currentSystem: row[18] || '',       // Column S: Case_Organization_Category_System\n      chiefComplaint: row[4] || '',\n      presentation: row[5] || '',\n      diagnosis: row[6] || ''\n    });\n  }\n\n  Logger.log('üìä Test cases:');\n  testCases.forEach(c => {\n    Logger.log('   ' + c.caseID + ': ' + c.chiefComplaint);\n  });\n  Logger.log('');\n\n  try {\n    const results = categorizeBatchWithAI(testCases);\n\n    Logger.log('‚úÖ AI Categorization successful!');\n    Logger.log('');\n    Logger.log('üìã Results:');\n\n    results.forEach(r => {\n      Logger.log('   ' + r.caseID);\n      Logger.log('      Suggested: ' + r.suggestedSymptom + ' / ' + r.suggestedSystem);\n      Logger.log('      Reasoning: ' + r.reasoning);\n      Logger.log('      Status: ' + r.status);\n      Logger.log('');\n    });\n\n    return results;\n\n  } catch (error) {\n    Logger.log('‚ùå Test failed: ' + error.message);\n    throw error;\n  }\n}\n\n\n/**\n * ===========================================================================\n * AI CATEGORIZATION APPLICATION FUNCTIONS\n * ===========================================================================\n *\n * Purpose: Apply reviewed categorizations to Master Scenario Convert\n * Method: Read from AI_Categorization_Results ‚Üí Validate ‚Üí Update Master\n *\n * Date: 2025-11-10\n * ===========================================================================\n */\n\n\n// ============================================================================\n// MAIN APPLICATION FUNCTION\n// ============================================================================\n\n/**\n * Apply categorizations from results sheet to Master Scenario Convert\n * Called after user reviews and approves suggestions\n *\n * @param {string} applyMode - 'all' | 'selected' | 'conflicts-only'\n * @return {object} Application results\n */\nfunction applyCategorization(applyMode) {\n  applyMode = applyMode || 'all';\n\n  // Clear old logs and start fresh\n  PropertiesService.getDocumentProperties().deleteProperty('Sidebar_Logs');\n  addAILog('üöÄ Starting Apply Categorizations...');\n  addAILog('   Mode: ' + applyMode);\n  addAILog('');\n\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const resultsSheet = ss.getSheetByName('AI_Categorization_Results');\n  const masterSheet = ss.getSheetByName('Master Scenario Convert');\n\n  if (!resultsSheet) {\n    throw new Error('AI_Categorization_Results sheet not found. Run AI categorization first.');\n  }\n\n  Logger.log('üöÄ Starting categorization application...');\n  Logger.log('   Mode: ' + applyMode);\n  Logger.log('');\n\n  // Get all results\n  const lastRow = resultsSheet.getLastRow();\n  if (lastRow < 2) {\n    throw new Error('No categorization results found');\n  }\n\n  const data = resultsSheet.getRange(2, 1, lastRow - 1, 14).getValues();\n\n  Logger.log('üìä Loaded ' + data.length + ' categorization results');\n  addAILog('üìä Loaded ' + data.length + ' categorization results');\n  addAILog('');\n\n  // Parse results\n  const categorizationData = {};\n\n  addAILog('üîç Parsing categorization results...');\n  addAILog('');\n\n  for (let i = 0; i < data.length; i++) {\n    const row = data[i];\n\n    const caseID = row[0];\n    const legacyCaseID = row[1];\n    const finalSymptom = row[12]; // Column M: Final_Symptom\n    const finalSystem = row[13];  // Column N: Final_System\n    const status = row[10];       // Column K: Status\n\n    // Apply mode filtering\n    if (applyMode === 'conflicts-only' && status !== 'conflict') {\n      continue; // Skip non-conflicts\n    }\n\n    // Only include cases with final values\n    if (finalSymptom && finalSystem) {\n      categorizationData[caseID] = {\n        caseID: caseID,\n        legacyCaseID: legacyCaseID,\n        symptom: finalSymptom,\n        system: finalSystem,\n        status: status\n      };\n    }\n  }\n\n  Logger.log('üìù Filtered to ' + Object.keys(categorizationData).length + ' cases to update');\n  Logger.log('');\n\n  // Run 5-layer validation\n  validateCategorization(categorizationData, masterSheet);\n\n  Logger.log('‚úÖ Validation passed');\n  Logger.log('');\n\n  // Create backup\n  const backupName = createBackup(masterSheet);\n  Logger.log('‚úÖ Backup created: ' + backupName);\n  Logger.log('');\n\n  // User confirmation\n  const ui = SpreadsheetApp.getUi();\n  const confirmMessage = 'Apply categorization to ' + Object.keys(categorizationData).length + ' cases in Master Scenario Convert?\\n\\n' +\n                        'Backup created: ' + backupName + '\\n\\n' +\n                        'This will update 4 columns in the Case_Organization group:\\n' +\n                        '- Case_Organization_Category_Symptom (Column R)\\n' +\n                        '- Case_Organization_Category_System (Column S)\\n' +\n                        '- Case_Organization_Category_Symptom_Name (Column P)\\n' +\n                        '- Case_Organization_Category_System_Name (Column Q)';\n\n  const response = ui.alert('Confirm Categorization', confirmMessage, ui.ButtonSet.YES_NO);\n\n  if (response !== ui.Button.YES) {\n    Logger.log('‚ùå User cancelled');\n    return {\n      success: false,\n      message: 'User cancelled operation'\n    };\n  }\n\n  Logger.log('‚úÖ User confirmed');\n  Logger.log('');\n\n  // Apply updates\n  const updateResults = applyCategorizationUpdates(categorizationData, masterSheet);\n\n  Logger.log('');\n  Logger.log('üéâ Categorization application complete!');\n  Logger.log('   Cases updated: ' + updateResults.updated);\n  Logger.log('   Errors: ' + updateResults.errors);\n\n  return {\n    success: true,\n    updated: updateResults.updated,\n    errors: updateResults.errors,\n    backup: backupName\n  };\n}\n\n\n// ============================================================================\n// VALIDATION FUNCTIONS\n// ============================================================================\n\n/**\n * 5-Layer validation before applying categorization\n */\n\nfunction getValidSystemCategories() {\n  return [\n    'Cardiovascular',\n    'Pulmonary',\n    'Gastrointestinal',\n    'Neurologic',\n    'Endocrine/Metabolic',\n    'Renal/Genitourinary',\n    'Hematologic/Oncologic',\n    'Infectious Disease',\n    'Toxicology',\n    'Trauma',\n    'Obstetrics/Gynecology',\n    'Pediatrics',\n    'HEENT',\n    'Musculoskeletal',\n    'Critical Care',\n    'Dermatologic',\n    'Psychiatric',\n    'Environmental'\n  ];\n}\n\n/**\n * Create backup of Master Scenario Convert\n */\nfunction createBackup(masterSheet) {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss');\n  const backupName = 'Master Scenario Convert (Backup ' + timestamp + ')';\n\n  const backup = masterSheet.copyTo(ss);\n  backup.setName(backupName);\n\n  // Move backup to end\n  ss.moveActiveSheet(ss.getNumSheets());\n\n  return backupName;\n}\n\n\n// ============================================================================\n// UPDATE FUNCTIONS\n// ============================================================================\n\n/**\n * Apply categorization updates to Master Scenario Convert\n */\nfunction applyCategorizationUpdates(categorizationData, masterSheet) {\n  Logger.log('üîß Applying categorization updates...');\n  Logger.log('');\n\n  let updated = 0;\n  let errors = 0;\n\n  for (const caseID in categorizationData) {\n    try {\n      const cat = categorizationData[caseID];\n      const legacyCaseID = cat.legacyCaseID;\n\n      // Find row by Legacy_Case_ID first, then fallback to Case_ID\n      let row;\n      if (legacyCaseID && legacyCaseID.length > 0) {\n        row = findRowByLegacyCaseID(masterSheet, legacyCaseID);\n      }\n\n      // Universal fallback: If not found by Legacy, try Case_ID\n      // This works for both:\n      // - Retry cases (legacyCaseID empty, uses Case_ID from start)\n      // - Regular cases (if Legacy lookup fails, auto-retry with Case_ID)\n      if (!row) {\n        row = findRowByCaseID(masterSheet, cat.caseID);\n      }\n\n      addAILog('   Searching for: ' + (legacyCaseID || cat.caseID + ' (via Case_ID)') + ' (' + cat.caseID + ')');\n\n      if (!row) {\n        Logger.log('‚ùå Case not found: ' + legacyCaseID);\n        addAILog('      ‚ùå NOT FOUND in Master sheet');\n        errors++;\n        continue;\n      }\n\n      // Use symptomName from categorization data (already from column O)\n      const symptomName = cat.symptomName || cat.symptom;\n\n      // Column R (18): Case_Organization_Category_Symptom (accronym)\n      masterSheet.getRange(row, 18).setValue(cat.symptom);\n\n      // Column S (19): Case_Organization_Category_System (system name)\n      masterSheet.getRange(row, 19).setValue(cat.system);\n\n      // Column P (16): Case_Organization_Category_Symptom_Name (full symptom name)\n      masterSheet.getRange(row, 16).setValue(symptomName);\n\n      // Column Q (17): Case_Organization_Category_System_Name (system name - same as Column S)\n      masterSheet.getRange(row, 17).setValue(cat.system);\n\n      Logger.log('‚úÖ Updated ' + cat.caseID + ': ' + cat.symptom + ' / ' + cat.system);\n      addAILog('      ‚úÖ Found at row ' + row + ': ' + cat.symptom + ' / ' + cat.system);\n      updated++;\n\n    } catch (error) {\n      Logger.log('‚ùå Error updating ' + legacyCaseID + ': ' + error.message);\n      errors++;\n    }\n  }\n\n  addAILog('');\n  addAILog('üìä Apply Summary:');\n  addAILog('   ‚úÖ Successfully updated: ' + updated);\n  addAILog('   ‚ùå Errors / Not found: ' + errors);\n  addAILog('');\n  addAILog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n\n  return {\n    updated: updated,\n    errors: errors\n  };\n}\n\n/**\n * Find row by Legacy_Case_ID\n * (Helper function - may already exist in other files)\n */\nfunction findRowByLegacyCaseID(sheet, legacyCaseID) {\n  const legacyColumn = 9; // Column I: Legacy_Case_ID\n  const lastRow = sheet.getLastRow();\n\n  // Get all Legacy_Case_ID values (skip 2 header rows)\n  const data = sheet.getRange(3, legacyColumn, lastRow - 2, 1).getValues();\n\n  for (let i = 0; i < data.length; i++) {\n    if (data[i][0] === legacyCaseID) {\n      return i + 3; // Row number (1-indexed, +2 for headers, +1 for array offset)\n    }\n  }\n\n  Logger.log('   ‚ùå NOT FOUND in ' + data.length + ' rows searched');\n  return null; // Not found\n}\n\n\n// ============================================================================\n// REVIEW INTERFACE HELPERS\n// ============================================================================\n\n/**\n * Get categorization statistics for UI display\n */\nfunction getCategorizationStats() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const resultsSheet = ss.getSheetByName('AI_Categorization_Results');\n\n  if (!resultsSheet) {\n    return {\n      total: 0,\n      new: 0,\n      matches: 0,\n      conflicts: 0,\n      errors: 0\n    };\n  }\n\n  const lastRow = resultsSheet.getLastRow();\n  if (lastRow < 2) {\n    return {\n      total: 0,\n      new: 0,\n      matches: 0,\n      conflicts: 0,\n      errors: 0\n    };\n  }\n\n  const statusData = resultsSheet.getRange(2, 11, lastRow - 1, 1).getValues(); // Column K: Status\n\n  const stats = {\n    total: statusData.length,\n    new: 0,\n    matches: 0,\n    conflicts: 0,\n    errors: 0\n  };\n\n  statusData.forEach(row => {\n    const status = row[0];\n    if (status === 'new') stats.new++;\n    else if (status === 'matches') stats.matches++;\n    else if (status === 'conflict') stats.conflicts++;\n    else if (status === 'error') stats.errors++;\n  });\n\n  return stats;\n}\n\n/**\n * Get categorization results for UI display\n * Returns filtered/paginated results\n */\nfunction getCategorizationResults(filter, page, pageSize) {\n  filter = filter || 'all';\n  page = page || 1;\n  pageSize = pageSize || 50;\n\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const resultsSheet = ss.getSheetByName('AI_Categorization_Results');\n\n  if (!resultsSheet) {\n    return { results: [], total: 0 };\n  }\n\n  const lastRow = resultsSheet.getLastRow();\n  if (lastRow < 2) {\n    return { results: [], total: 0 };\n  }\n\n  const data = resultsSheet.getRange(2, 1, lastRow - 1, 14).getValues();\n\n  // Filter results\n  let filtered = data.filter(row => {\n    const status = row[10]; // Column K: Status\n\n    if (filter === 'all') return true;\n    if (filter === 'new') return status === 'new';\n    if (filter === 'matches') return status === 'matches';\n    if (filter === 'conflicts') return status === 'conflict';\n    if (filter === 'errors') return status === 'error';\n\n    return true;\n  });\n\n  // Paginate\n  const start = (page - 1) * pageSize;\n  const end = start + pageSize;\n  const paginated = filtered.slice(start, end);\n\n  // Format for UI\n  const results = paginated.map(row => {\n    return {\n      caseID: row[0],\n      legacyCaseID: row[1],\n      rowIndex: row[2],\n      currentSymptom: row[3],\n      currentSystem: row[4],\n      suggestedSymptom: row[5],\n      suggestedSymptomName: row[6],\n      suggestedSystem: row[7],\n      reasoning: row[8],\n      confidence: row[9],\n      status: row[10],\n      userDecision: row[11],\n      finalSymptom: row[12],\n      finalSystem: row[13]\n    };\n  });\n\n  return {\n    results: results,\n    total: filtered.length,\n    page: page,\n    pageSize: pageSize,\n    totalPages: Math.ceil(filtered.length / pageSize)\n  };\n}\n\n\n// ============================================================================\n// ROLLBACK FUNCTION\n// ============================================================================\n\n/**\n * Rollback to most recent backup\n */\nfunction rollbackCategorization() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const sheets = ss.getSheets();\n\n  // Find most recent backup\n  let latestBackup = null;\n  let latestTimestamp = 0;\n\n  sheets.forEach(sheet => {\n    const name = sheet.getName();\n    if (name.startsWith('Master Scenario Convert (Backup')) {\n      // Extract timestamp from name\n      const match = name.match(/Backup (\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2})/);\n      if (match) {\n        const timestamp = new Date(match[1]).getTime();\n        if (timestamp > latestTimestamp) {\n          latestTimestamp = timestamp;\n          latestBackup = sheet;\n        }\n      }\n    }\n  });\n\n  if (!latestBackup) {\n    throw new Error('No backup found to rollback to');\n  }\n\n  const ui = SpreadsheetApp.getUi();\n  const response = ui.alert(\n    'Confirm Rollback',\n    'Restore Master Scenario Convert from backup: ' + latestBackup.getName() + '?',\n    ui.ButtonSet.YES_NO\n  );\n\n  if (response !== ui.Button.YES) {\n    return { success: false, message: 'User cancelled' };\n  }\n\n  // Delete current Master Scenario Convert\n  const currentMaster = ss.getSheetByName('Master Scenario Convert');\n  if (currentMaster) {\n    ss.deleteSheet(currentMaster);\n  }\n\n  // Rename backup to Master Scenario Convert\n  latestBackup.setName('Master Scenario Convert');\n\n  Logger.log('‚úÖ Rolled back to: ' + latestBackup.getName());\n\n  return {\n    success: true,\n    message: 'Rolled back to backup: ' + latestBackup.getName()\n  };\n}\n\n\n// ============================================================================\n// END AI AUTO-CATEGORIZATION SYSTEM\n// ============================================================================\n\n\n/**\n * Open AI-Powered Categorization Tools\n * Full AI categorization system with review interface\n */\nfunction openAICategorization() {\n  const ui = getSafeUi_();\n  if (!ui) return;\n\n  const html = buildCategoriesPathwaysMainMenu_();\n  ui.showSidebar(HtmlService.createHtmlOutput(html).setTitle('ü§ñ AI Categorization').setWidth(400));\n}\n\n\n/**\n * Open Enhanced Visual Panel with Symptom/System Toggle\n * Shows visual folder organization with toggle between:\n * - Symptom categories (CP, SOB, ABD, etc.)\n * - System categories (Cardiovascular, Pulmonary, etc.)\n */\nfunction openEnhancedVisualPanel() {\n  const ui = getSafeUi_();\n  if (ui === null) return;\n\n  const html = buildEnhancedCategoriesTab();\n  ui.showSidebar(HtmlService.createHtmlOutput(html).setTitle('üìÇ Categories (Enhanced)').setWidth(450));\n}\n\nfunction openCategoriesPathwaysPanel() {\n  const ui = getSafeUi_();\n  if (!ui) return;\n\n  const html = buildCategoriesPathwaysMainMenu_();\n  ui.showSidebar(HtmlService.createHtmlOutput(html).setTitle('üìÇ Categories & Pathways').setWidth(400));\n}\n\n\nfunction clearAICategorizationResults() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const resultsSheet = ss.getSheetByName('AI_Categorization_Results');\n\n  if (!resultsSheet) {\n    Logger.log('‚ö†Ô∏è  AI_Categorization_Results sheet does not exist');\n    return {\n      success: true,\n      message: 'Sheet does not exist (nothing to clear)'\n    };\n  }\n\n  try {\n    // Clear all content from the sheet\n    resultsSheet.clear();\n    Logger.log('‚úÖ Cleared AI_Categorization_Results sheet');\n\n    return {\n      success: true,\n      message: 'Results cleared successfully'\n    };\n\n  } catch (error) {\n    Logger.log('‚ùå Error clearing results: ' + error.message);\n    throw new Error('Failed to clear results: ' + error.message);\n  }\n}\n\nfunction runAICategorization() {\n  // Clear old logs and start fresh\n  PropertiesService.getDocumentProperties().deleteProperty('Sidebar_Logs');\n  addAILog('üöÄ Starting AI Categorization for All Cases...');\n  addAILog('');\n\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const masterSheet = ss.getSheetByName('Master Scenario Convert');\n\n  if (!masterSheet) {\n    throw new Error('Master Scenario Convert sheet not found!');\n  }\n\n  Logger.log('ü§ñ Starting AI Categorization...');\n  Logger.log('');\n\n  // Clear old results sheet immediately to prevent conflicts\n  const existingResults = ss.getSheetByName('AI_Categorization_Results');\n  if (existingResults) {\n    existingResults.clear();\n    Logger.log('‚úÖ Cleared old results sheet');\n    Logger.log('');\n  }\n\n  // Get all case data (skip 2 header rows)\n  const lastRow = masterSheet.getLastRow();\n  const data = masterSheet.getRange(3, 1, lastRow - 2, 646).getValues();\n\n  Logger.log('üìä Loaded ' + data.length + ' cases');\n\n  // Extract relevant fields for each case\n  const cases = [];\n  for (let i = 0; i < data.length; i++) {\n    const row = data[i];\n\n    cases.push({\n      rowIndex: i + 3,                    // Actual row number in sheet\n      caseID: row[0],                     // Column A: Case_ID\n      legacyCaseID: row[8],               // Column I: Legacy_Case_ID\n      currentSymptom: row[17] || '',      // Column R: Case_Organization_Category_Symptom\n      currentSystem: row[18] || '',       // Column S: Case_Organization_Category_System\n      chiefComplaint: row[4] || '',       // Column E: Chief_Complaint (approximate)\n      presentation: row[5] || '',         // Column F: Presentation (approximate)\n      diagnosis: row[6] || ''             // Column G: Diagnosis (approximate)\n    });\n  }\n\n  Logger.log('‚úÖ Extracted case data');\n  Logger.log('');\n\n  // Process in batches of 25\n  const batchSize = 25;\n\n  addAILog('   Total cases found: ' + cases.length);\n  addAILog('   Batch size: ' + batchSize);\n  addAILog('   Total batches: ' + Math.ceil(cases.length / batchSize));\n  addAILog('');\n  const allResults = [];\n\n  for (let i = 0; i < cases.length; i += batchSize) {\n    const batch = cases.slice(i, Math.min(i + batchSize, cases.length));\n    const batchNum = Math.floor(i / batchSize) + 1;\n    const totalBatches = Math.ceil(cases.length / batchSize);\n\n    Logger.log('üì¶ Processing batch ' + batchNum + '/' + totalBatches + ' (' + batch.length + ' cases)...');\n\n    try {\n      const batchResults = categorizeBatchWithAI(batch);\n      addAILog('   ‚úÖ API responded with ' + batchResults.length + ' results');\n\n      // Log sample result\n      if (batchResults.length > 0) {\n        const sample = batchResults[0];\n        addAILog('   Sample: ' + sample.caseID + ' ‚Üí ' + (sample.suggestedSymptom || '(empty)') + ' / ' + (sample.suggestedSystem || '(empty)'));\n        if (sample.reasoning) {\n          addAILog('   Reasoning: ' + sample.reasoning.substring(0, 80) + '...');\n        }\n      }\n\n      // Log any empty results\n      const emptyResults = batchResults.filter(r => !r.suggestedSymptom || r.suggestedSymptom.length === 0);\n      if (emptyResults.length > 0) {\n        addAILog('   ‚ö†Ô∏è  WARNING: ' + emptyResults.length + ' results still empty!');\n        emptyResults.forEach(er => {\n          addAILog('      - ' + er.caseID + ': ' + (er.reasoning || 'no reasoning'));\n        });\n      }\n      allResults.push(...batchResults);\n\n      Logger.log('‚úÖ Batch ' + batchNum + ' complete');\n\n      // Small delay to avoid rate limits\n      Utilities.sleep(1000);\n\n    } catch (error) {\n      Logger.log('‚ùå Batch ' + batchNum + ' failed: ' + error.message);\n\n      // Add placeholder results for failed batch\n      batch.forEach(caseData => {\n        allResults.push({\n          caseID: caseData.caseID,\n          rowIndex: caseData.rowIndex,\n          currentSymptom: caseData.currentSymptom,\n          currentSystem: caseData.currentSystem,\n          suggestedSymptom: '',\n          suggestedSymptomName: '',\n          suggestedSystem: '',\n          reasoning: 'AI processing failed: ' + error.message,\n          status: 'error'\n        });\n      });\n    }\n  }\n\n  Logger.log('');\n  Logger.log('üéâ AI Categorization complete!');\n  Logger.log('   Total cases processed: ' + allResults.length);\n\n  // Save results to temporary sheet for review\n  saveCategorizationResults(allResults);\n\n  Logger.log('‚úÖ Results saved to AI_Categorization_Results sheet');\n\n  return {\n    success: true,\n    totalCases: allResults.length,\n    resultsSheetName: 'AI_Categorization_Results'\n  };\n}\n\nfunction retryFailedCategorization() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const masterSheet = ss.getSheetByName('Master Scenario Convert');\n  const resultsSheet = ss.getSheetByName('AI_Categorization_Results');\n\n  if (!resultsSheet) {\n    throw new Error('AI_Categorization_Results sheet not found. Run full categorization first.');\n  }\n\n  PropertiesService.getDocumentProperties().deleteProperty('Sidebar_Logs');  // Clear old logs\n  addAILog('üîÑ Starting Retry for Failed Cases...');\n  addAILog('');\n  Logger.log('');\n\n  // Get all results data\n  const resultsData = resultsSheet.getDataRange().getValues();\n\n  if (resultsData.length < 2) {\n    throw new Error('No results found. Run full categorization first.');\n  }\n\n  // Find failed cases (rows where Suggested_Symptom is empty)\n  const failedCases = [];\n  const failedRowIndices = []; // Track which result rows to update\n\n  for (let i = 1; i < resultsData.length; i++) {  // Skip header row\n    const row = resultsData[i];\n    const suggestedSymptom = row[5];  // Column F: Suggested_Symptom\n    const rowIndex = row[2];          // Column C: Row_Index (in Master sheet)\n    const caseID = row[0];            // Column A: Case_ID\n\n    // Empty Suggested_Symptom = failed case\n    if (!suggestedSymptom || suggestedSymptom.length === 0) {\n      failedRowIndices.push(i + 1);  // +1 for sheet row number\n\n      // Validate and convert rowIndex to number (might be string from sheet)\n      const rowNum = parseInt(rowIndex, 10);\n      if (!rowIndex || isNaN(rowNum) || rowNum < 1) {\n        Logger.log('‚ö†Ô∏è  Skipping case ' + caseID + ' - invalid rowIndex: ' + rowIndex + ' (parsed: ' + rowNum + ')');\n        continue;\n      }\n\n      // Fetch case data from Master sheet (use parsed number)\n      const masterRow = masterSheet.getRange(rowNum, 1, 1, 646).getValues()[0];\n\n      failedCases.push({\n        rowIndex: rowNum,  // Store the parsed NUMBER, not the string\n        resultRowIndex: i + 1,  // Row in results sheet\n        caseID: masterRow[0],\n        legacyCaseID: masterRow[8],\n        currentSymptom: masterRow[17] || '',\n        currentSystem: masterRow[18] || '',\n        chiefComplaint: masterRow[4] || '',\n        presentation: masterRow[5] || '',\n        diagnosis: masterRow[6] || ''\n      });\n    }\n  }\n\n  if (failedCases.length === 0) {\n    Logger.log('‚úÖ No failed cases found! All cases processed successfully.');\n    return {\n      success: true,\n      failedCount: 0,\n      message: 'No failed cases to retry'\n    };\n  }\n\n  addAILog('üìä Found ' + failedCases.length + ' failed cases to retry');\n  addAILog('   Case IDs: ' + failedCases.map(fc => fc.caseID).slice(0, 10).join(', ') + (failedCases.length > 10 ? '...' : ''));\n  addAILog('');\n  Logger.log('');\n\n  // Clear the failed rows first (fresh start for retry)\n  addAILog('üßπ Clearing ' + failedCases.length + ' failed rows in results sheet...');\n  failedCases.forEach(failedCase => {\n    const resultRow = failedCase.resultRowIndex;\n\n    // Validate resultRow before clearing\n    if (!resultRow || isNaN(resultRow) || resultRow < 2) {\n      Logger.log('‚ö†Ô∏è  Skipping clear for invalid resultRow: ' + resultRow);\n      return;\n    }\n\n    // Clear columns F-K (Suggested_Symptom through Status)\n    resultsSheet.getRange(resultRow, 6, 1, 6).clearContent();\n    // Also clear Final columns (M-N)\n    resultsSheet.getRange(resultRow, 13, 1, 2).clearContent();\n  });\n  addAILog('‚úÖ Cleared successfully');\n  addAILog('');\n  Logger.log('');\n\n  // Process failed cases in batches of 10 (smaller batches for retry)\n  const batchSize = 10;\n  const retryResults = [];\n\n  for (let i = 0; i < failedCases.length; i += batchSize) {\n    const batch = failedCases.slice(i, Math.min(i + batchSize, failedCases.length));\n    const batchNum = Math.floor(i / batchSize) + 1;\n    const totalBatches = Math.ceil(failedCases.length / batchSize);\n\n    addAILog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  addAILog('üì¶ Batch ' + batchNum + '/' + totalBatches + ' (' + batch.length + ' cases)');\n  addAILog('   Case IDs: ' + batch.map(c => c.caseID).join(', '));\n  addAILog('   Calling OpenAI API...');\n\n    try {\n      const batchResults = categorizeBatchWithAI(batch);\n      addAILog('   ‚úÖ API responded with ' + batchResults.length + ' results');\n\n      // Log sample result\n      if (batchResults.length > 0) {\n        const sample = batchResults[0];\n        addAILog('   Sample: ' + sample.caseID + ' ‚Üí ' + (sample.suggestedSymptom || '(empty)') + ' / ' + (sample.suggestedSystem || '(empty)'));\n        if (sample.reasoning) {\n          addAILog('   Reasoning: ' + sample.reasoning.substring(0, 80) + '...');\n        }\n      }\n\n      // Log any empty results\n      const emptyResults = batchResults.filter(r => !r.suggestedSymptom || r.suggestedSymptom.length === 0);\n      if (emptyResults.length > 0) {\n        addAILog('   ‚ö†Ô∏è  WARNING: ' + emptyResults.length + ' results still empty!');\n        emptyResults.forEach(er => {\n          addAILog('      - ' + er.caseID + ': ' + (er.reasoning || 'no reasoning'));\n        });\n      }\n\n      retryResults.push(...batchResults);\n\n      addAILog('   ‚úÖ Batch ' + batchNum + ' complete');\n  addAILog('');\n\n      // Small delay to avoid rate limits\n      Utilities.sleep(1000);\n\n    } catch (error) {\n      addAILog('   ‚ùå Batch ' + batchNum + ' FAILED: ' + error.message);\n      addAILog('   Creating placeholder results for ' + batch.length + ' cases');\n      addAILog('');\n\n      // Add placeholder results for failed retry\n      batch.forEach(caseData => {\n        retryResults.push({\n          caseID: caseData.caseID,\n          legacyCaseID: caseData.legacyCaseID,\n          rowIndex: caseData.rowIndex,\n          resultRowIndex: caseData.resultRowIndex,\n          currentSymptom: caseData.currentSymptom,\n          currentSystem: caseData.currentSystem,\n          suggestedSymptom: '',\n          suggestedSymptomName: '',\n          suggestedSystem: '',\n          reasoning: 'Retry failed: ' + error.message,\n          status: 'error'\n        });\n      });\n    }\n  }\n\n  Logger.log('');\n  addAILog('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');\n  addAILog('üìù Writing Results Back to Sheet...');\n  addAILog('   Sheet name: ' + resultsSheet.getName());\n  addAILog('   Total results: ' + retryResults.length);\n  addAILog('');\n\n  // Log first few row indices to verify\n  const sampleIndices = retryResults.slice(0, 5).map(r => r.caseID + '‚Üírow ' + r.resultRowIndex).join(', ');\n  addAILog('   Sample row indices: ' + sampleIndices);\n  addAILog('');\n\n  // Update results sheet with retry results\n  let writeCount = 0;\n  let skipCount = 0;\n\n  retryResults.forEach(result => {\n    const resultRow = parseInt(result.resultRowIndex, 10);\n\n    // Validate resultRow before updating\n    if (!resultRow || isNaN(resultRow) || resultRow < 2) {\n      addAILog('   ‚ö†Ô∏è  SKIPPED ' + result.caseID + ': invalid resultRowIndex = ' + result.resultRowIndex);\n      skipCount++;\n      Logger.log('‚ö†Ô∏è  Skipping update for invalid resultRow: ' + result.resultRowIndex);\n      return;\n    }\n\n    // Log the write operation\n    addAILog('   ‚úçÔ∏è  Row ' + resultRow + ': ' + result.caseID + ' ‚Üí ' + (result.suggestedSymptom || '(empty)'));\n    writeCount++;\n\n    // Update columns F-K (Suggested_Symptom through Status)\n    resultsSheet.getRange(resultRow, 6, 1, 6).setValues([[\n      result.suggestedSymptom,\n      result.suggestedSymptomName,\n      result.suggestedSystem,\n      result.reasoning,\n      result.confidence || 'medium',\n      result.status\n    ]]);\n\n    // Also update Final columns (M-N) if successful\n    if (result.suggestedSymptom && result.suggestedSymptom.length > 0) {\n      resultsSheet.getRange(resultRow, 13, 1, 2).setValues([[\n        result.suggestedSymptom,\n        result.suggestedSystem\n      ]]);\n    }\n  });\n\n  addAILog('');\n  addAILog('üìä Write Summary:');\n  addAILog('   ‚úÖ Rows written: ' + writeCount);\n  addAILog('   ‚ö†Ô∏è  Rows skipped: ' + skipCount);\n  addAILog('');\n\n  // Re-apply status formatting\n  const totalRows = resultsSheet.getLastRow() - 1;\n  applyStatusFormatting(resultsSheet, totalRows);\n\n  // Count successes vs failures FIRST (before logging)\n  const successCount = retryResults.filter(r => r.suggestedSymptom && r.suggestedSymptom.length > 0).length;\n  const stillFailedCount = retryResults.length - successCount;\n\n  addAILog('‚úÖ Write-back complete');\n  addAILog('');\n  addAILog('üéâ Retry Complete!');\n  addAILog('   Cases retried: ' + retryResults.length);\n  addAILog('   Successfully fixed: ' + successCount);\n  addAILog('   Still failed: ' + stillFailedCount);\n  addAILog('');\n  addAILog('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n\n  return {\n    success: true,\n    totalRetried: retryResults.length,\n    successCount: successCount,\n    stillFailedCount: stillFailedCount,\n    message: 'Retry complete: ' + successCount + ' fixed, ' + stillFailedCount + ' still failed'\n  };\n}\n\n\n\n\n\n\n// ============================================================================\n// AI PROCESSING\n// ============================================================================\n\n/**\n * Send batch of cases to OpenAI for categorization\n *\n * @param {Array} cases - Array of case objects\n * @return {Array} Array of categorization results\n */\nfunction categorizeBatchWithAI(cases) {\n  // Get OpenAI API key from Settings sheet\n  const apiKey = getOpenAIAPIKey();\n\n  if (!apiKey) {\n    throw new Error('OpenAI API key not found in Settings!B2');\n  }\n\n  // Get accronym mapping for reference\n  const accronymMapping = getAccronymMapping();\n\n  // Keep ACLS in list but prompt will restrict its use heavily\n  const validSymptoms = Object.keys(accronymMapping).join(', ');\n\n  // Get valid system categories\n  const validSystems = [\n    'Cardiovascular',\n    'Pulmonary',\n    'Gastrointestinal',\n    'Neurologic',\n    'Endocrine/Metabolic',\n    'Renal/Genitourinary',\n    'Hematologic/Oncologic',\n    'Infectious Disease',\n    'Toxicology',\n    'Trauma',\n    'Obstetrics/Gynecology',\n    'Pediatrics',\n    'HEENT',\n    'Musculoskeletal',\n    'Critical Care',\n    'Dermatologic',\n    'Psychiatric',\n    'Environmental'\n  ].join(', ');\n\n  // Build prompt\n  const prompt = buildCategorizationPrompt(cases, validSymptoms, validSystems);\n\n  // Call OpenAI API\n  const requestBody = {\n    model: 'gpt-4',\n    messages: [\n      {\n        role: 'system',\n        content: 'You are an expert ER triage nurse categorizing medical simulation cases. Respond ONLY with valid JSON.'\n      },\n      {\n        role: 'user',\n        content: prompt\n      }\n    ],\n    temperature: 0.3,\n    max_tokens: 4000  // Increased from 3000 to prevent JSON truncation\n  };\n\n  const options = {\n    method: 'post',\n    headers: {\n      'Authorization': 'Bearer ' + apiKey,\n      'Content-Type': 'application/json'\n    },\n    payload: JSON.stringify(requestBody),\n    muteHttpExceptions: true\n  };\n\n  const response = UrlFetchApp.fetch('https://api.openai.com/v1/chat/completions', options);\n  const responseCode = response.getResponseCode();\n\n  if (responseCode !== 200) {\n    throw new Error('OpenAI API error: ' + responseCode + ' - ' + response.getContentText());\n  }\n\n  const result = JSON.parse(response.getContentText());\n\n  if (!result.choices || !result.choices[0] || !result.choices[0].message) {\n    throw new Error('Invalid OpenAI response format');\n  }\n\n  const aiResponseText = result.choices[0].message.content;\n\n  // Parse JSON response\n  let suggestions;\n  try {\n    // Remove markdown code blocks if present\n    const jsonText = aiResponseText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '');\n    suggestions = JSON.parse(jsonText);\n  } catch (parseError) {\n    Logger.log('‚ùå Failed to parse AI response: ' + aiResponseText);\n    throw new Error('Failed to parse AI response as JSON: ' + parseError.message);\n  }\n\n  // Merge AI suggestions with original case data\n  const results = [];\n  for (let i = 0; i < cases.length; i++) {\n    const caseData = cases[i];\n    const aiSuggestion = suggestions[i] || {};\n\n    results.push({\n      caseID: caseData.caseID,\n      legacyCaseID: caseData.legacyCaseID,\n      rowIndex: caseData.rowIndex,\n      resultRowIndex: caseData.resultRowIndex,  // üîß PRESERVE this for retry write-back!\n      currentSymptom: caseData.currentSymptom,\n      currentSystem: caseData.currentSystem,\n      suggestedSymptom: aiSuggestion.suggestedSymptom || '',\n      suggestedSymptomName: aiSuggestion.suggestedSymptomName || '',\n      suggestedSystem: aiSuggestion.suggestedSystem || '',\n      reasoning: aiSuggestion.reasoning || '',\n      confidence: aiSuggestion.confidence || 'medium',\n      status: determineStatus(caseData, aiSuggestion)\n    });\n  }\n\n  return results;\n}\n\n/**\n * Helper function to add timestamped logs to Sidebar_Logs property\n */\nfunction addAILog(message) {\n  try {\n    const props = PropertiesService.getDocumentProperties();\n    const existingLogs = props.getProperty('Sidebar_Logs') || '';\n    const timestamp = Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'HH:mm:ss');\n    const newLog = '[' + timestamp + '] ' + message;\n    props.setProperty('Sidebar_Logs', existingLogs + newLog + '\\n');\n    Logger.log(newLog);  // Also log to execution log\n  } catch (err) {\n    Logger.log('Error writing to sidebar log: ' + err.message);\n  }\n}\n\n/**\n * Retry AI categorization for ONLY the failed cases\n * Identifies rows with empty Suggested_Symptom (failed cases) and re-processes them\n *\n * @return {object} Results with retry statistics\n */\n\n\n\n",
      "lastModifyUser": {
        "domain": "ersimulator.com",
        "email": "support@ersimulator.com",
        "name": "Aaron Tjomsland",
        "photoUrl": "https://lh3.googleusercontent.com/a-/ALV-UjWqjAHY15ugT_65GCYyIOdya8IsaYpRoXhg8zPNCFOZli7OIZef57v0vfPVHgdIc17nrKQX8RvFMotOWdiAJBi2Z8EvBsAdh5GHMLT6VwUDxulPbACn039MZEDMjGvEQ6Ps2GbhAuuwKxgy_KN_q1Rq9upQd2UNjYnz_Uspr2GepdVdVNsljJ-DDAv-42pz7IOGDYkiIg-J7reiSUsTtGi6L1Gc_plMbGLqao0qberaqBqQ2uV20xfvaHILx12hTMouOqHUdF_kv3I9T7Tz95zpYo1S4_vLbnngaUlYehv_FW2UnkUXww7-cWmsr2DLJdfjSUT_R0Vwb7WnzCdrEc7I6QY3OePHi_nk2TKc2e722qLboOGKpBc-8NvjS2mi20-NvCF-QwQvZrAJWpnx9nvkNCV3ovYvGCwvCnWaGHfV_GILlkHFY63s2LzwAF7kuIISeoxuuKxjfpLesHXRNhKHQlYv3Ecpwl9VyNoL6VxA17hJE83iwlgPSrbAnfVBYBS3DDmkWNqeTj5yooNm41Gix9m1iSuWhqS1xbU9NVlxEnjfX_9XUYD1yYvm-mpJqTWDQSuJo4ffmLVtbrarNe5mxR-xUBwD7kbbiDxlZ5BfcGUV-2DD3RSzNDbgxZbU-8I93D28EpIPbXvoWrKgqvz8JxqWScrhMN9kyuU_SgxH-rVrD6jn_EeTiQYXwGxbCNzcW7S2wxI8Y_uv1EHwio6lAIetzZbAmTTUyxwBF1mlQP-lPUHpvKRAs-wUz7pw5DI8uSCu-8GZCz3xa0fqevlMghcm-YUOzMW4c8vLf3wGNQoLpyvIVHmByXymbGJ1-trNCuQTYtzs3PHmME3i8s-Ogll54Nprg0QGNiGaFKOmnmc1zoniPZa_QNABkOOQivGdwuhPO4b2q685m0uwxv1sJ7pC8vB8SQXWqIW9maHvOVauNsAldadssZpGGCwGfjwPkJvjGY8RF1JqRAKI6ImFB9OwPHJ47Mfy5JHpBvXZcL75LpxdHTXlyjMMosuw_E23Og_NMvk0kKoY4J1ydWt3Jkpdf1I-PmcdoApGnAGaNnL7WyEbcYM=h128"
      },
      "createTime": "2025-11-07T02:11:30.395Z",
      "updateTime": "2025-11-11T04:42:39.376Z",
      "functionSet": {
        "values": [
          {
            "name": "restore35Defaults"
          },
          {
            "name": "showSavedFieldSelection"
          },
          {
            "name": "clearCacheSheet"
          },
          {
            "name": "cacheNext25RowsWithFields"
          },
          {
            "name": "resetCacheProgress"
          },
          {
            "name": "showFieldSelector"
          },
          {
            "name": "saveFieldSelection",
            "parameters": [
              "selectedFields"
            ]
          },
          {
            "name": "onOpen"
          },
          {
            "name": "getSafeUi_"
          },
          {
            "name": "ensureQualityColumns_",
            "parameters": [
              "sheet",
              "header1",
              "header2"
            ]
          },
          {
            "name": "evaluateSimulationQuality",
            "parameters": [
              "rowValues",
              "mergedKeys"
            ]
          },
          {
            "name": "attachQualityToRow_",
            "parameters": [
              "sheet",
              "rowValues",
              "header1",
              "header2",
              "mergedKeys"
            ]
          },
          {
            "name": "runQualityAudit_AllOrRows"
          },
          {
            "name": "cleanUpLowValueRows"
          },
          {
            "name": "getProp",
            "parameters": [
              "key",
              "fallback"
            ]
          },
          {
            "name": "setProp",
            "parameters": [
              "key",
              "val"
            ]
          },
          {
            "name": "estimateTokens",
            "parameters": [
              "str"
            ]
          },
          {
            "name": "estimateCostUSD",
            "parameters": [
              "inputText",
              "outputText"
            ]
          },
          {
            "name": "hashText",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "cleanDuplicateLines",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "tryParseJSON",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "validateVitalsFields_",
            "parameters": [
              "parsedOutput",
              "headers"
            ]
          },
          {
            "name": "callOpenAiJson",
            "parameters": [
              "model",
              "userPrompt"
            ]
          },
          {
            "name": "extractValueFromParsed_",
            "parameters": [
              "parsed",
              "mergedKey"
            ]
          },
          {
            "name": "syncApiKeyFromSettingsSheet_"
          },
          {
            "name": "readApiKey_"
          },
          {
            "name": "callOpenAI",
            "parameters": [
              "promptText",
              "temperature"
            ]
          },
          {
            "name": "checkApiStatus"
          },
          {
            "name": "readTwoTierHeaders_",
            "parameters": [
              "sheet"
            ]
          },
          {
            "name": "mergedKeysFromTwoTiers_",
            "parameters": [
              "header1",
              "header2"
            ]
          },
          {
            "name": "cacheHeaders",
            "parameters": [
              "sheet"
            ]
          },
          {
            "name": "getCachedHeadersOrRead",
            "parameters": [
              "sheet"
            ]
          },
          {
            "name": "clearHeaderCache"
          },
          {
            "name": "ensureBatchReportsSheet_"
          },
          {
            "name": "openSimSidebar"
          },
          {
            "name": "saveSidebarBasics",
            "parameters": [
              "model",
              "apiKeyMaybe",
              "priceIn",
              "priceOut",
              "inputSheet",
              "outputSheet"
            ]
          },
          {
            "name": "logLong",
            "parameters": [
              "label",
              "text"
            ]
          },
          {
            "name": "getSidebarLogs"
          },
          {
            "name": "clearSidebarLogs"
          },
          {
            "name": "setOutputSheet",
            "parameters": [
              "sheetName"
            ]
          },
          {
            "name": "stopBatch"
          },
          {
            "name": "parseRowSpec_",
            "parameters": [
              "spec"
            ]
          },
          {
            "name": "getNext25InputRows_",
            "parameters": [
              "inputSheet",
              "outputSheet"
            ]
          },
          {
            "name": "getAllInputRows_",
            "parameters": [
              "inputSheet",
              "outputSheet"
            ]
          },
          {
            "name": "getSpecificInputRows_",
            "parameters": [
              "inputSheet",
              "outputSheet",
              "spec"
            ]
          },
          {
            "name": "parseRowSpec",
            "parameters": [
              "spec"
            ]
          },
          {
            "name": "startBatchFromSidebar",
            "parameters": [
              "inputSheetName",
              "outputSheetName",
              "mode",
              "spec"
            ]
          },
          {
            "name": "runSingleStepBatch"
          },
          {
            "name": "finishBatchAndReport"
          },
          {
            "name": "runSingleCaseFromSidebar",
            "parameters": [
              "inputSheetName",
              "outputSheetName",
              "row"
            ]
          },
          {
            "name": "applyClinicalDefaults_",
            "parameters": [
              "parsed",
              "mergedKeys"
            ]
          },
          {
            "name": "processOneInputRow_",
            "parameters": [
              "inputSheet",
              "outputSheet",
              "inputRow",
              "batchMode"
            ]
          },
          {
            "name": "runATSRTitleGenerator",
            "parameters": [
              "continueRow",
              "keepSelections"
            ]
          },
          {
            "name": "parseATSRResponse_",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "applyATSRSelectionsWithDefiningAndMemory",
            "parameters": [
              "row",
              "spark",
              "reveal",
              "caseID",
              "define"
            ]
          },
          {
            "name": "pickMasterSheet_"
          },
          {
            "name": "autoBoldSummary_",
            "parameters": [
              "summary",
              "key",
              "take"
            ]
          },
          {
            "name": "openImageSyncDefaults"
          },
          {
            "name": "saveImageSyncDefaults",
            "parameters": [
              "json"
            ]
          },
          {
            "name": "refreshImageSyncHeaderCache"
          },
          {
            "name": "openMemoryTracker"
          },
          {
            "name": "clearMotifMemory"
          },
          {
            "name": "markMotifsReusable",
            "parameters": [
              "unchecked"
            ]
          },
          {
            "name": "refreshHeaders"
          },
          {
            "name": "retrainPromptStructure"
          },
          {
            "name": "ensureHeadersCached"
          },
          {
            "name": "openSettingsPanel"
          },
          {
            "name": "pullApiFromSettingsSheet"
          },
          {
            "name": "getCategoryView",
            "parameters": [
              "category"
            ]
          },
          {
            "name": "getPathwayView",
            "parameters": [
              "pathway"
            ]
          },
          {
            "name": "getAllCategoriesView"
          },
          {
            "name": "getAllPathwaysView"
          },
          {
            "name": "getCaseAssignmentView",
            "parameters": [
              "row"
            ]
          },
          {
            "name": "saveATSRData",
            "parameters": [
              "row",
              "data"
            ]
          },
          {
            "name": "appendLogSafe",
            "parameters": [
              "message"
            ]
          },
          {
            "name": "detectWaveformForState_",
            "parameters": [
              "caseTitle",
              "initialRhythm",
              "dispositionPlan",
              "stateName"
            ]
          },
          {
            "name": "getHeaders_",
            "parameters": [
              "sheet"
            ]
          },
          {
            "name": "buildCase_",
            "parameters": [
              "headers",
              "row"
            ]
          },
          {
            "name": "suggestWaveformMapping"
          },
          {
            "name": "autoMapAllWaveforms"
          },
          {
            "name": "analyzeCurrentMappings"
          },
          {
            "name": "clearAllWaveforms"
          },
          {
            "name": "onEdit",
            "parameters": [
              "e"
            ]
          },
          {
            "name": "testBatchProcessRow3"
          },
          {
            "name": "testLiveLogging"
          },
          {
            "name": "testBatchModeFlag"
          },
          {
            "name": "generateMysteriousSparkTitles",
            "parameters": [
              "row",
              "mysteryLevel",
              "currentTitles"
            ]
          },
          {
            "name": "getStaticRecommendedFields_"
          },
          {
            "name": "getDefaultFieldNames_"
          },
          {
            "name": "loadFieldSelection"
          },
          {
            "name": "getAvailableFields"
          },
          {
            "name": "getFieldSelectorRoughDraft"
          },
          {
            "name": "getAIRecommendations",
            "parameters": [
              "currentlySelected",
              "availableFields"
            ]
          },
          {
            "name": "getRecommendedFields",
            "parameters": [
              "availableFields",
              "selectedFields"
            ]
          },
          {
            "name": "saveFieldSelectionAndStartCache",
            "parameters": [
              "selectedFields"
            ]
          },
          {
            "name": "preCacheRichData"
          },
          {
            "name": "testSimpleFieldSelector"
          },
          {
            "name": "preCacheRichDataAfterSelection"
          },
          {
            "name": "performCacheWithProgress"
          },
          {
            "name": "testHello"
          },
          {
            "name": "testCacheSimple"
          },
          {
            "name": "getCacheStatus"
          },
          {
            "name": "showAIDiscoveryWithStreamingLogs_",
            "parameters": [
              "creativityMode"
            ]
          },
          {
            "name": "startAIDiscovery",
            "parameters": [
              "creativityMode"
            ]
          },
          {
            "name": "getAIDiscoveryStatus"
          },
          {
            "name": "analyzeCatalog_"
          },
          {
            "name": "extractVital_",
            "parameters": [
              "vitalsStr",
              "field"
            ]
          },
          {
            "name": "discoverPathwaysSync_",
            "parameters": [
              "creativityMode"
            ]
          },
          {
            "name": "showAIPathwayResults",
            "parameters": [
              "pathways",
              "creativityMode"
            ]
          },
          {
            "name": "testCacheDiagnostic"
          },
          {
            "name": "tryParseVitals_",
            "parameters": [
              "vitalsJson"
            ]
          },
          {
            "name": "truncateField_",
            "parameters": [
              "value",
              "maxLength"
            ]
          },
          {
            "name": "getColumnIndexByHeader_",
            "parameters": [
              "fullFieldName",
              "fallbackIndex"
            ]
          },
          {
            "name": "resolveColumnIndices_",
            "parameters": [
              "fieldMap"
            ]
          },
          {
            "name": "runPathwayChainBuilder"
          },
          {
            "name": "getOrCreateHolisticAnalysis_",
            "parameters": [
              "forceRefresh"
            ]
          },
          {
            "name": "buildAIDiscoveryTabHTML_"
          },
          {
            "name": "performHolisticAnalysis_"
          },
          {
            "name": "extractPrimarySystem_",
            "parameters": [
              "category"
            ]
          },
          {
            "name": "identifyPathwayOpportunities_",
            "parameters": [
              "cases",
              "systemDist"
            ]
          },
          {
            "name": "generateHolisticInsights_",
            "parameters": [
              "cases",
              "systemDist",
              "pathwayDist",
              "unassignedCount"
            ]
          },
          {
            "name": "buildCategoriesTabHTML_",
            "parameters": [
              "analysis"
            ]
          },
          {
            "name": "buildPathwaysTabHTML_",
            "parameters": [
              "analysis"
            ]
          },
          {
            "name": "buildBirdEyeViewUI_",
            "parameters": [
              "analysis"
            ]
          },
          {
            "name": "reAnalyzeLibrary"
          },
          {
            "name": "getAllLogicTypes_"
          },
          {
            "name": "getLogicTypeById_",
            "parameters": [
              "logicTypeId"
            ]
          },
          {
            "name": "sortByLogicType_",
            "parameters": [
              "cases",
              "logicTypeId"
            ]
          },
          {
            "name": "getAcuityScore_",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "getProtocolPriority_",
            "parameters": [
              "diagnosis"
            ]
          },
          {
            "name": "getAgeCategory_",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "getRarityScore_",
            "parameters": [
              "diagnosis"
            ]
          },
          {
            "name": "getComorbidityCount_",
            "parameters": [
              "diagnosis"
            ]
          },
          {
            "name": "getTimeUrgency_",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "getCognitiveTrapScore_",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "getResourceDependency_",
            "parameters": [
              "diagnosis"
            ]
          },
          {
            "name": "getEvolutionScore_",
            "parameters": [
              "text"
            ]
          },
          {
            "name": "generateLogicTypeWithAI",
            "parameters": [
              "pathwayId"
            ]
          },
          {
            "name": "interpretCustomLogicDescription",
            "parameters": [
              "description",
              "pathwayId"
            ]
          },
          {
            "name": "applyDynamicLogicType",
            "parameters": [
              "pathwayId",
              "logicType"
            ]
          },
          {
            "name": "saveCustomLogicType",
            "parameters": [
              "logicType"
            ]
          },
          {
            "name": "buildChainBuilderUI",
            "parameters": [
              "pathwayId",
              "logicTypeId"
            ]
          },
          {
            "name": "buildInitialChain_",
            "parameters": [
              "pathway",
              "allCases",
              "logicTypeId"
            ]
          },
          {
            "name": "generatePositionRationale_",
            "parameters": [
              "position",
              "caseData",
              "allCases",
              "pathway"
            ]
          },
          {
            "name": "buildChainBuilderHTML_",
            "parameters": [
              "pathway",
              "chain",
              "logicType"
            ]
          },
          {
            "name": "discoverNovelPathwaysWithAI_",
            "parameters": [
              "creativityMode"
            ]
          },
          {
            "name": "showAIDiscoveredPathways",
            "parameters": [
              "creativityMode"
            ]
          },
          {
            "name": "showAIPathwaysStandard"
          },
          {
            "name": "showAIPathwaysRadical"
          },
          {
            "name": "showAIPathwaysStandardWithLogs"
          },
          {
            "name": "showAIPathwaysRadicalWithLogs"
          },
          {
            "name": "analyzeCatalogWithMultiLayerCache_"
          },
          {
            "name": "getCacheLayerDefinitions_"
          },
          {
            "name": "enrichCacheLayer_",
            "parameters": [
              "layerKey"
            ]
          },
          {
            "name": "enrichAllCacheLayers"
          },
          {
            "name": "readCacheLayer_",
            "parameters": [
              "sheetName"
            ]
          },
          {
            "name": "mergeAllCacheLayers_"
          },
          {
            "name": "performLightweightAnalysis_"
          },
          {
            "name": "checkSavedFields"
          },
          {
            "name": "getAccronymMapping"
          },
          {
            "name": "populateCategoriesFromAccronym",
            "parameters": [
              "pathwayId",
              "accronym"
            ]
          },
          {
            "name": "generateNewCaseIDs",
            "parameters": [
              "accronym",
              "pathwayNumber",
              "caseCount"
            ]
          },
          {
            "name": "updatePathwayRefinement",
            "parameters": [
              "pathwayId",
              "refinementData"
            ]
          },
          {
            "name": "finalizePathway",
            "parameters": [
              "pathwayId",
              "userName"
            ]
          },
          {
            "name": "verifyPathwaysSchema"
          },
          {
            "name": "buildCategorizationPrompt",
            "parameters": [
              "cases",
              "validSymptoms",
              "validSystems"
            ]
          },
          {
            "name": "saveCategorizationResults",
            "parameters": [
              "results"
            ]
          },
          {
            "name": "testApplyLogs"
          },
          {
            "name": "validateCategorization",
            "parameters": [
              "categorizationData",
              "masterSheet"
            ]
          },
          {
            "name": "findRowByCaseID",
            "parameters": [
              "sheet",
              "caseID"
            ]
          },
          {
            "name": "determineStatus",
            "parameters": [
              "caseData",
              "aiSuggestion"
            ]
          },
          {
            "name": "applyStatusFormatting",
            "parameters": [
              "sheet",
              "rowCount"
            ]
          },
          {
            "name": "getOpenAIAPIKey"
          },
          {
            "name": "testAICategorization"
          },
          {
            "name": "applyCategorization",
            "parameters": [
              "applyMode"
            ]
          },
          {
            "name": "getValidSystemCategories"
          },
          {
            "name": "createBackup",
            "parameters": [
              "masterSheet"
            ]
          },
          {
            "name": "applyCategorizationUpdates",
            "parameters": [
              "categorizationData",
              "masterSheet"
            ]
          },
          {
            "name": "findRowByLegacyCaseID",
            "parameters": [
              "sheet",
              "legacyCaseID"
            ]
          },
          {
            "name": "getCategorizationStats"
          },
          {
            "name": "getCategorizationResults",
            "parameters": [
              "filter",
              "page",
              "pageSize"
            ]
          },
          {
            "name": "rollbackCategorization"
          },
          {
            "name": "openAICategorization"
          },
          {
            "name": "openEnhancedVisualPanel"
          },
          {
            "name": "openCategoriesPathwaysPanel"
          },
          {
            "name": "clearAICategorizationResults"
          },
          {
            "name": "runAICategorization"
          },
          {
            "name": "retryFailedCategorization"
          },
          {
            "name": "categorizeBatchWithAI",
            "parameters": [
              "cases"
            ]
          },
          {
            "name": "addAILog",
            "parameters": [
              "message"
            ]
          }
        ]
      }
    },
    {
      "name": "appsscript",
      "type": "JSON",
      "source": "{\n  \"timeZone\": \"America/Los_Angeles\",\n  \"dependencies\": {},\n  \"exceptionLogging\": \"STACKDRIVER\",\n  \"runtimeVersion\": \"V8\"\n}",
      "lastModifyUser": {
        "domain": "ersimulator.com",
        "email": "support@ersimulator.com",
        "name": "Aaron Tjomsland",
        "photoUrl": "https://lh3.googleusercontent.com/a-/ALV-UjWqjAHY15ugT_65GCYyIOdya8IsaYpRoXhg8zPNCFOZli7OIZef57v0vfPVHgdIc17nrKQX8RvFMotOWdiAJBi2Z8EvBsAdh5GHMLT6VwUDxulPbACn039MZEDMjGvEQ6Ps2GbhAuuwKxgy_KN_q1Rq9upQd2UNjYnz_Uspr2GepdVdVNsljJ-DDAv-42pz7IOGDYkiIg-J7reiSUsTtGi6L1Gc_plMbGLqao0qberaqBqQ2uV20xfvaHILx12hTMouOqHUdF_kv3I9T7Tz95zpYo1S4_vLbnngaUlYehv_FW2UnkUXww7-cWmsr2DLJdfjSUT_R0Vwb7WnzCdrEc7I6QY3OePHi_nk2TKc2e722qLboOGKpBc-8NvjS2mi20-NvCF-QwQvZrAJWpnx9nvkNCV3ovYvGCwvCnWaGHfV_GILlkHFY63s2LzwAF7kuIISeoxuuKxjfpLesHXRNhKHQlYv3Ecpwl9VyNoL6VxA17hJE83iwlgPSrbAnfVBYBS3DDmkWNqeTj5yooNm41Gix9m1iSuWhqS1xbU9NVlxEnjfX_9XUYD1yYvm-mpJqTWDQSuJo4ffmLVtbrarNe5mxR-xUBwD7kbbiDxlZ5BfcGUV-2DD3RSzNDbgxZbU-8I93D28EpIPbXvoWrKgqvz8JxqWScrhMN9kyuU_SgxH-rVrD6jn_EeTiQYXwGxbCNzcW7S2wxI8Y_uv1EHwio6lAIetzZbAmTTUyxwBF1mlQP-lPUHpvKRAs-wUz7pw5DI8uSCu-8GZCz3xa0fqevlMghcm-YUOzMW4c8vLf3wGNQoLpyvIVHmByXymbGJ1-trNCuQTYtzs3PHmME3i8s-Ogll54Nprg0QGNiGaFKOmnmc1zoniPZa_QNABkOOQivGdwuhPO4b2q685m0uwxv1sJ7pC8vB8SQXWqIW9maHvOVauNsAldadssZpGGCwGfjwPkJvjGY8RF1JqRAKI6ImFB9OwPHJ47Mfy5JHpBvXZcL75LpxdHTXlyjMMosuw_E23Og_NMvk0kKoY4J1ydWt3Jkpdf1I-PmcdoApGnAGaNnL7WyEbcYM=h128"
      },
      "createTime": "2025-11-07T02:11:27.618Z",
      "updateTime": "2025-11-11T04:42:39.376Z",
      "functionSet": {}
    },
    {
      "name": "Phase2_AI_Scoring_Pathways",
      "type": "SERVER_JS",
      "source": "/**\n * PHASE 2: AI PERSUASION & RANKING SYSTEM\n *\n * Three-factor scoring system for pathway suggestions:\n * 1. Educational Value (50%)\n * 2. Novelty (25%)\n * 3. Market Validation (25%)\n *\n * Plus sequence rationale explaining WHY each case is positioned where it is.\n */\n\n// ============================================================================\n// AI SCORING PROMPTS\n// ============================================================================\n\nvar EDUCATIONAL_VALUE_PROMPT = `\nYou are an expert in emergency medicine education and curriculum design.\n\nEvaluate this pathway's EDUCATIONAL VALUE on a scale of 1-10.\n\nPATHWAY TO EVALUATE:\nName: {PATHWAY_NAME}\nDescription: {PATHWAY_DESCRIPTION}\nCases: {CASE_COUNT} cases\nTarget Learner: {TARGET_LEARNER}\nLearning Outcomes: {LEARNING_OUTCOMES}\nCase Sequence: {CASE_SEQUENCE}\n\nEVALUATION CRITERIA:\n\n1. LEARNING OUTCOMES CLARITY (3 points)\n   - Are outcomes specific and measurable?\n   - Can success be objectively assessed?\n   - Do outcomes align with target learner level?\n\n2. PEDAGOGICAL PROGRESSION (3 points)\n   - Does case sequence build logically?\n   - Is difficulty progression appropriate?\n   - Does each case prepare for the next?\n\n3. SKILL GAP FILLING (2 points)\n   - Does this address an unmet educational need?\n   - Is this a critical competency for EM residents?\n   - Would learners struggle without this pathway?\n\n4. RETENTION & APPLICATION (2 points)\n   - Will learners remember this after 6 months?\n   - Can they apply this in real clinical practice?\n   - Does sequence maximize retention?\n\nRETURN JSON:\n{\n  \"educational_value_score\": 8,\n  \"clarity_score\": 3,\n  \"progression_score\": 2,\n  \"gap_filling_score\": 2,\n  \"retention_score\": 1,\n  \"reasoning\": \"Clear outcomes focused on anchoring bias recognition. Progression from subtle to obvious traps is pedagogically sound. Fills critical gap in cognitive debiasing training. However, retention may be challenged without repeated exposure.\",\n  \"strengths\": [\"Specific measurable outcomes\", \"Logical progression\", \"Addresses bias blind spot\"],\n  \"weaknesses\": [\"May need spaced repetition to stick\"]\n}\n`;\n\nvar NOVELTY_PROMPT = `\nYou are a medical education innovation consultant who has reviewed thousands of EM curricula.\n\nEvaluate this pathway's NOVELTY on a scale of 1-10.\n\nPATHWAY TO EVALUATE:\nName: {PATHWAY_NAME}\nDescription: {PATHWAY_DESCRIPTION}\nCases: {CASE_COUNT} cases\nLogic Type: {LOGIC_TYPE}\n\nEVALUATION CRITERIA:\n\n1. UNEXPECTEDNESS (4 points)\n   - How surprising is this grouping?\n   - Would expert educators say \"I never thought of that\"?\n   - Does it challenge conventional curriculum design?\n\n2. DIFFERENTIATION (3 points)\n   - Is this different from standard organ system groupings?\n   - Does it offer a fresh perspective?\n   - Would this stand out in a curriculum catalog?\n\n3. CREATIVE CONNECTIONS (3 points)\n   - Does it reveal non-obvious patterns?\n   - Are cases connected in unexpected ways?\n   - Does it cross traditional boundaries?\n\nREFERENCE POINTS FOR SCORING:\n- 1-3: Standard grouping (e.g., \"All Cardiac Cases\")\n- 4-6: Moderately creative (e.g., \"Cardiac Cases by Difficulty\")\n- 7-8: Highly creative (e.g., \"When Chest Pain Isn't Cardiac\")\n- 9-10: Revolutionary (e.g., \"Cases Where Doing Nothing Was Right\")\n\nRETURN JSON:\n{\n  \"novelty_score\": 9,\n  \"unexpectedness_score\": 4,\n  \"differentiation_score\": 3,\n  \"creative_connections_score\": 2,\n  \"reasoning\": \"This is a highly unexpected grouping. Most curricula organize by diagnosis, not by cognitive bias exposure. The connection of cases through 'diagnostic traps that fool experts' is creative and non-obvious. Expert educators would find this fresh and innovative.\",\n  \"comparison_to_traditional\": \"Traditional: Organize by organ system. This pathway: Organize by cognitive error pattern.\",\n  \"innovation_level\": \"High - Addresses 'how we think' not 'what we know'\"\n}\n`;\n\nvar MARKET_VALIDATION_PROMPT = `\nYou are an expert in emergency medicine education market trends and proven curriculum structures.\n\nEvaluate this pathway's MARKET VALIDATION on a scale of 1-10.\n\nPATHWAY TO EVALUATE:\nName: {PATHWAY_NAME}\nDescription: {PATHWAY_DESCRIPTION}\nTarget Learner: {TARGET_LEARNER}\nProgression Style: {PROGRESSION_STYLE}\n\nPROVEN SUCCESSFUL PATTERNS (Reference):\n1. OnlineMedEd: Organ system ‚Üí Clinical presentation ‚Üí Board prep\n2. Rosh Review: Subject-based, difficulty-tiered, exam-focused\n3. EM:RAP: C3 (foundational) ‚Üí Main (mixed) ‚Üí Crunch Time (advanced)\n4. Best-selling EM courses: ACLS, ATLS, Ultrasound, Procedures\n\nEVALUATION CRITERIA:\n\n1. STRUCTURAL ALIGNMENT (4 points)\n   - Does pathway structure match proven winners?\n   - Is progression similar to successful courses?\n   - Does it follow recognized learning frameworks?\n\n2. NAMING/MARKETING APPEAL (2 points)\n   - Does name clearly communicate value?\n   - Would this sell well in a course catalog?\n   - Is naming style similar to best-sellers?\n\n3. TARGET AUDIENCE DEMAND (2 points)\n   - Is target learner segment in high demand?\n   - Do residents/attendings seek this content?\n   - Is there proven market need?\n\n4. ADOPTION LIKELIHOOD (2 points)\n   - Would program directors use this?\n   - Does it fit existing curricula?\n   - Is it easy to integrate?\n\nRETURN JSON:\n{\n  \"market_validation_score\": 7,\n  \"structural_alignment_score\": 2,\n  \"naming_appeal_score\": 2,\n  \"audience_demand_score\": 2,\n  \"adoption_likelihood_score\": 1,\n  \"reasoning\": \"While cognitive bias training isn't a traditional EM curriculum staple, there's growing market demand (Harvard, Stanford offer similar courses). Structure doesn't perfectly match OnlineMedEd/Rosh, but aligns with emerging 'thinking skills' trend. Naming is compelling. Target audience (PGY2-3) is large segment. Adoption may be challenged by non-traditional focus.\",\n  \"similar_successful_products\": [\"Harvard Critical Thinking in Medicine\", \"Stanford Diagnostic Excellence\"],\n  \"market_demand_level\": \"Growing - Cognitive bias awareness is emerging trend\",\n  \"pricing_comparable\": \"Premium pricing justified by novelty and depth\"\n}\n`;\n\nvar PERSUASION_NARRATIVE_PROMPT = `\nYou are a senior medical educator consultant pitching pathway ideas to a program director.\n\nWrite a compelling 2-3 sentence persuasion narrative for this pathway.\n\nPATHWAY TO EVALUATE:\nName: {PATHWAY_NAME}\nDescription: {PATHWAY_DESCRIPTION}\nCases: {CASE_COUNT} cases\nEducational Value: {EDU_SCORE}/10\nNovelty: {NOVELTY_SCORE}/10\nMarket Validation: {MARKET_SCORE}/10\n\nYOUR TASK:\nWrite a persuasive \"pitch\" that:\n1. Hooks attention (why this matters NOW)\n2. Explains unique value (what traditional pathways miss)\n3. Creates urgency (why build this pathway)\n\nTONE: Confident, evidence-based, inspiring\nLENGTH: 2-3 sentences (50-80 words)\nSTYLE: Active voice, specific benefits, compelling\n\nBAD EXAMPLE (too generic):\n\"This pathway covers important diagnostic skills. Residents will learn to recognize common conditions. It's a good addition to your curriculum.\"\n\nGOOD EXAMPLE (compelling):\n\"These aren't just diagnostic errors‚Äîthey're the cases that fool even 20-year attendings. Each case presents with textbook symptoms pointing to Diagnosis A, but the answer is actually Diagnosis B. This pathway trains your residents to recognize when 'too perfect' presentations should trigger diagnostic skepticism, not confirmation.\"\n\nRETURN JSON:\n{\n  \"persuasion_narrative\": \"Your compelling 2-3 sentence pitch here\",\n  \"hook\": \"Opening hook sentence\",\n  \"unique_value\": \"What traditional pathways miss\",\n  \"urgency\": \"Why build this now\"\n}\n`;\n\nvar SEQUENCE_RATIONALE_PROMPT = `\nYou are an expert medical educator explaining pathway design decisions.\n\nAnalyze this pathway's case sequence and explain WHY each case is positioned where it is.\n\nPATHWAY INFORMATION:\nName: {PATHWAY_NAME}\nDescription: {PATHWAY_DESCRIPTION}\nLogic Type: {LOGIC_TYPE}\nTarget Learner: {TARGET_LEARNER}\n\nCOMPLETE CASE SEQUENCE:\n{CASE_SEQUENCE_JSON}\n\nYOUR TASK:\nFor EACH case in the sequence, explain:\n\n1. **Position Rationale** - Why does this case belong at THIS position?\n2. **Prerequisites** - What foundation from previous cases does this build on?\n3. **Progression Logic** - How does this case advance the learner's skill?\n4. **Preparation** - What does this case prepare the learner for next?\n\nEDUCATIONAL PRINCIPLES TO CONSIDER:\n- Scaffolding: Simple ‚Üí Complex\n- Cognitive Load: Low ‚Üí High\n- Pattern Recognition: Typical ‚Üí Atypical\n- Uncertainty: High Certainty ‚Üí Diagnostic Ambiguity\n- Clinical Acuity: Stable ‚Üí Unstable\n\nFORMAT YOUR RESPONSE AS JSON:\n{\n  \"overall_sequence_philosophy\": \"Brief explanation of the overall sequencing strategy (2-3 sentences)\",\n  \"case_rationales\": [\n    {\n      \"position\": 1,\n      \"case_id\": \"CP101\",\n      \"case_title\": \"58M Chest Pain\",\n      \"position_rationale\": \"Why this case is FIRST - what makes it the ideal starting point?\",\n      \"prerequisites\": \"None - this is the foundation\",\n      \"progression_logic\": \"What skill/concept does this case introduce?\",\n      \"prepares_for\": \"What does this case set up for Case 2?\"\n    },\n    {\n      \"position\": 2,\n      \"case_id\": \"CP102\",\n      \"case_title\": \"45F Chest Pain\",\n      \"position_rationale\": \"Why this case comes SECOND - what makes it the logical next step?\",\n      \"prerequisites\": \"Builds on Case 1's foundation of...\",\n      \"progression_logic\": \"How does this case escalate complexity from Case 1?\",\n      \"prepares_for\": \"What pattern does this establish for Case 3?\"\n    }\n    // ... continue for all cases\n  ],\n  \"key_transitions\": [\n    {\n      \"from_case\": \"CP101\",\n      \"to_case\": \"CP102\",\n      \"transition_rationale\": \"Why moving from Case 1 ‚Üí Case 2 creates the ideal learning moment\"\n    }\n    // ... for critical transitions\n  ]\n}\n\nBE SPECIFIC: Avoid generic explanations like \"builds on previous knowledge.\" Instead say \"Builds on Case 1's pattern of typical chest pain by introducing atypical presentation of PE.\"\n\nEXAMPLE GOOD RATIONALE:\n\"Case 1 (CP101) establishes baseline recognition of TYPICAL chest pain presentation. Case 2 (CP102) introduces the first 'trap' - a case that LOOKS like typical MI but is actually PE. This teaches learners to question their initial impression BEFORE locking into a diagnosis.\"\n\nEXAMPLE BAD RATIONALE:\n\"Case 1 teaches chest pain. Case 2 continues chest pain learning.\"\n`;\n\n// ============================================================================\n// CORE SCORING FUNCTIONS\n// ============================================================================\n\n/**\n * Score a pathway across all 3 dimensions\n */\nfunction scorePathway(pathway) {\n  Logger.log('üéØ Scoring pathway: \"' + pathway.name + '\"');\n\n  try {\n    var apiKey = getOpenAIKey_();\n\n    // 1. Educational Value Score\n    Logger.log('üìä Calculating Educational Value...');\n    var eduPrompt = EDUCATIONAL_VALUE_PROMPT\n      .replace('{PATHWAY_NAME}', pathway.name)\n      .replace('{PATHWAY_DESCRIPTION}', pathway.description)\n      .replace('{CASE_COUNT}', pathway.caseIds.length)\n      .replace('{TARGET_LEARNER}', pathway.targetLearner || 'PGY1-3')\n      .replace('{LEARNING_OUTCOMES}', JSON.stringify(pathway.learningOutcomes || []))\n      .replace('{CASE_SEQUENCE}', JSON.stringify(pathway.caseSequence || []));\n\n    var eduResponse = callOpenAI_(eduPrompt, apiKey);\n    var eduScore = parseOpenAIJSON_(eduResponse);\n\n    Logger.log('   ‚úÖ Educational Value: ' + eduScore.educational_value_score + '/10');\n\n    // 2. Novelty Score\n    Logger.log('üí° Calculating Novelty...');\n    var noveltyPrompt = NOVELTY_PROMPT\n      .replace('{PATHWAY_NAME}', pathway.name)\n      .replace('{PATHWAY_DESCRIPTION}', pathway.description)\n      .replace('{CASE_COUNT}', pathway.caseIds.length)\n      .replace('{LOGIC_TYPE}', pathway.logicType || 'Unknown');\n\n    var noveltyResponse = callOpenAI_(noveltyPrompt, apiKey);\n    var noveltyScore = parseOpenAIJSON_(noveltyResponse);\n\n    Logger.log('   ‚úÖ Novelty: ' + noveltyScore.novelty_score + '/10');\n\n    // 3. Market Validation Score\n    Logger.log('üìà Calculating Market Validation...');\n    var marketPrompt = MARKET_VALIDATION_PROMPT\n      .replace('{PATHWAY_NAME}', pathway.name)\n      .replace('{PATHWAY_DESCRIPTION}', pathway.description)\n      .replace('{TARGET_LEARNER}', pathway.targetLearner || 'PGY1-3')\n      .replace('{PROGRESSION_STYLE}', pathway.progressionStyle || 'Sequential');\n\n    var marketResponse = callOpenAI_(marketPrompt, apiKey);\n    var marketScore = parseOpenAIJSON_(marketResponse);\n\n    Logger.log('   ‚úÖ Market Validation: ' + marketScore.market_validation_score + '/10');\n\n    // 4. Calculate Composite Score\n    var compositeScore = calculateCompositeScore(\n      eduScore.educational_value_score,\n      noveltyScore.novelty_score,\n      marketScore.market_validation_score\n    );\n\n    Logger.log('üèÜ Composite Score: ' + compositeScore.score + '/10 (' + compositeScore.tier + ')');\n\n    // 5. Generate Persuasion Narrative\n    Logger.log('‚úçÔ∏è  Generating AI Persuasion Narrative...');\n    var persuasionPrompt = PERSUASION_NARRATIVE_PROMPT\n      .replace('{PATHWAY_NAME}', pathway.name)\n      .replace('{PATHWAY_DESCRIPTION}', pathway.description)\n      .replace('{CASE_COUNT}', pathway.caseIds.length)\n      .replace('{EDU_SCORE}', eduScore.educational_value_score)\n      .replace('{NOVELTY_SCORE}', noveltyScore.novelty_score)\n      .replace('{MARKET_SCORE}', marketScore.market_validation_score);\n\n    var persuasionResponse = callOpenAI_(persuasionPrompt, apiKey);\n    var persuasion = parseOpenAIJSON_(persuasionResponse);\n\n    Logger.log('üí¨ Persuasion: \"' + persuasion.persuasion_narrative + '\"');\n\n    // Return complete scoring object\n    return {\n      pathway_id: pathway.id,\n      pathway_name: pathway.name,\n      educational_value: eduScore,\n      novelty: noveltyScore,\n      market_validation: marketScore,\n      composite_score: compositeScore.score,\n      tier: compositeScore.tier,\n      persuasion: persuasion,\n      scored_at: new Date().toISOString()\n    };\n\n  } catch (error) {\n    Logger.log('‚ùå Scoring error: ' + error.message);\n    throw error;\n  }\n}\n\n/**\n * Calculate composite score with weighted formula\n */\nfunction calculateCompositeScore(eduScore, noveltyScore, marketScore) {\n  var weights = {\n    educational: 0.50,  // 50%\n    novelty: 0.25,      // 25%\n    market: 0.25        // 25%\n  };\n\n  var composite =\n    (eduScore * weights.educational) +\n    (noveltyScore * weights.novelty) +\n    (marketScore * weights.market);\n\n  var tier = getTier_(composite);\n\n  return {\n    score: parseFloat(composite.toFixed(2)),\n    tier: tier,\n    breakdown: {\n      educational: eduScore,\n      novelty: noveltyScore,\n      market: marketScore\n    }\n  };\n}\n\n/**\n * Get tier classification (S/A/B/C/D)\n */\nfunction getTier_(score) {\n  if (score >= 9.0) return 'S-Tier (Must Build)';\n  if (score >= 8.0) return 'A-Tier (Highly Recommended)';\n  if (score >= 7.0) return 'B-Tier (Good)';\n  if (score >= 6.0) return 'C-Tier (Consider)';\n  return 'D-Tier (Low Priority)';\n}\n\n/**\n * Generate sequence rationale for a pathway\n */\nfunction generateSequenceRationale(pathway) {\n  Logger.log('üìç Generating sequence rationale for: \"' + pathway.name + '\"');\n\n  try {\n    var apiKey = getOpenAIKey_();\n\n    // Build case sequence JSON with details\n    var caseSequenceJson = pathway.caseSequence.map(function(caseId, index) {\n      return {\n        position: index + 1,\n        case_id: caseId,\n        case_title: pathway.caseTitles ? pathway.caseTitles[index] : 'Case Title',\n        case_diagnosis: pathway.caseDiagnoses ? pathway.caseDiagnoses[index] : 'Unknown'\n      };\n    });\n\n    var prompt = SEQUENCE_RATIONALE_PROMPT\n      .replace('{PATHWAY_NAME}', pathway.name)\n      .replace('{PATHWAY_DESCRIPTION}', pathway.description)\n      .replace('{LOGIC_TYPE}', pathway.logicType || 'Unknown')\n      .replace('{TARGET_LEARNER}', pathway.targetLearner || 'PGY1-3')\n      .replace('{CASE_SEQUENCE_JSON}', JSON.stringify(caseSequenceJson, null, 2));\n\n    Logger.log('ü§ñ Calling OpenAI to analyze sequence...');\n\n    var response = callOpenAI_(prompt, apiKey);\n    var rationale = parseOpenAIJSON_(response);\n\n    Logger.log('‚úÖ Sequence rationale generated!');\n    Logger.log('üìö Overall Philosophy: \"' + rationale.overall_sequence_philosophy + '\"');\n\n    return rationale;\n\n  } catch (error) {\n    Logger.log('‚ùå Sequence rationale error: ' + error.message);\n    throw error;\n  }\n}\n\n// ============================================================================\n// API HELPER FUNCTIONS\n// ============================================================================\n\n/**\n * Call OpenAI API (reuses existing pattern)\n */\nfunction callOpenAI_(prompt, apiKey) {\n  var url = 'https://api.openai.com/v1/chat/completions';\n\n  var payload = {\n    model: 'gpt-4o',\n    messages: [\n      {\n        role: 'system',\n        content: 'You are an expert medical education consultant. Return only valid JSON.'\n      },\n      {\n        role: 'user',\n        content: prompt\n      }\n    ],\n    temperature: 0.7,\n    max_tokens: 2000\n  };\n\n  var options = {\n    method: 'post',\n    contentType: 'application/json',\n    headers: {\n      'Authorization': 'Bearer ' + apiKey\n    },\n    payload: JSON.stringify(payload),\n    muteHttpExceptions: true\n  };\n\n  var response = UrlFetchApp.fetch(url, options);\n  var json = JSON.parse(response.getContentText());\n\n  if (json.error) {\n    throw new Error('OpenAI API Error: ' + json.error.message);\n  }\n\n  return json.choices[0].message.content;\n}\n\n/**\n * Parse JSON from OpenAI response\n */\nfunction parseOpenAIJSON_(response) {\n  // Remove markdown code blocks if present\n  var cleaned = response.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n\n  try {\n    return JSON.parse(cleaned);\n  } catch (error) {\n    Logger.log('‚ùå JSON parse error: ' + error.message);\n    Logger.log('Response: ' + response);\n    throw error;\n  }\n}\n\n/**\n * Get OpenAI API key (reuses existing pattern)\n */\nfunction getOpenAIKey_() {\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var settingsSheet = ss.getSheetByName('Settings');\n\n  if (!settingsSheet) {\n    throw new Error('Settings sheet not found');\n  }\n\n  var apiKey = settingsSheet.getRange('B2').getValue();\n\n  if (!apiKey || !apiKey.toString().startsWith('sk-')) {\n    throw new Error('Invalid OpenAI API key in Settings!B2');\n  }\n\n  return apiKey.toString().trim();\n}\n\n// ============================================================================\n// TESTING FUNCTIONS\n// ============================================================================\n\n/**\n * Test the scoring engine\n */\nfunction testScoringEngine() {\n  Logger.log('üß™ Testing Scoring Engine');\n  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n\n  var testPathway = {\n    id: 'PATH_TEST_001',\n    name: 'The Diagnostic Traps Collection',\n    description: 'Cases that fool even expert clinicians - chest pain that isn\\'t MI, SOB that isn\\'t cardiac, etc.',\n    logicType: 'Cognitive Bias Exposure',\n    caseIds: ['CP101', 'CP102', 'CP103', 'CP104', 'CP105', 'CP106', 'SOB201', 'SOB202'],\n    caseSequence: ['CP101', 'CP102', 'CP103', 'CP104', 'CP105', 'CP106', 'SOB201', 'SOB202'],\n    targetLearner: 'PGY2-3',\n    learningOutcomes: [\n      'Recognize anchoring bias in real-time',\n      'Apply systematic \"break the pattern\" thinking',\n      'Identify diagnostic red flags that contradict initial impression'\n    ],\n    progressionStyle: 'Sequential'\n  };\n\n  var scoringResult = scorePathway(testPathway);\n\n  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n  Logger.log('üìä COMPLETE SCORING RESULT:');\n  Logger.log(JSON.stringify(scoringResult, null, 2));\n  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n}\n\n/**\n * Test sequence rationale generator\n */\nfunction testSequenceRationale() {\n  Logger.log('üß™ Testing Sequence Rationale Generator');\n  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n\n  var testPathway = {\n    name: 'The Diagnostic Traps Collection',\n    description: 'Cases that fool even expert clinicians - presentations that look like Diagnosis A but are actually Diagnosis B',\n    logicType: 'Cognitive Bias Exposure',\n    targetLearner: 'PGY2-3',\n    caseSequence: ['CP101', 'CP102', 'CP103', 'CP104', 'CP105', 'CP106', 'SOB201', 'SOB202'],\n    caseTitles: [\n      '58M Chest Pain - Stable',\n      '45F Chest Pain - Mild SOB',\n      '62M Chest Pain - Classic Presentation',\n      '35F Chest Pain - Anxiety',\n      '51M Chest Pain - Chronic',\n      '67M Chest Pain - Severe',\n      '55M Shortness of Breath - Acute',\n      '72F Shortness of Breath - Chronic'\n    ],\n    caseDiagnoses: [\n      'Aortic Dissection (NOT MI)',\n      'Pulmonary Embolism (NOT MI)',\n      'Pneumonia with Pleurisy (NOT MI)',\n      'Panic Attack (NOT MI)',\n      'GERD (NOT MI)',\n      'STEMI (Finally, actually MI!)',\n      'Pulmonary Embolism (NOT CHF)',\n      'CHF (Actually cardiac!)'\n    ]\n  };\n\n  var rationale = generateSequenceRationale(testPathway);\n\n  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n  Logger.log('üìä COMPLETE SEQUENCE RATIONALE:');\n  Logger.log(JSON.stringify(rationale, null, 2));\n  Logger.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');\n}\n",
      "lastModifyUser": {
        "domain": "ersimulator.com",
        "email": "support@ersimulator.com",
        "name": "Aaron Tjomsland",
        "photoUrl": "https://lh3.googleusercontent.com/a-/ALV-UjWqjAHY15ugT_65GCYyIOdya8IsaYpRoXhg8zPNCFOZli7OIZef57v0vfPVHgdIc17nrKQX8RvFMotOWdiAJBi2Z8EvBsAdh5GHMLT6VwUDxulPbACn039MZEDMjGvEQ6Ps2GbhAuuwKxgy_KN_q1Rq9upQd2UNjYnz_Uspr2GepdVdVNsljJ-DDAv-42pz7IOGDYkiIg-J7reiSUsTtGi6L1Gc_plMbGLqao0qberaqBqQ2uV20xfvaHILx12hTMouOqHUdF_kv3I9T7Tz95zpYo1S4_vLbnngaUlYehv_FW2UnkUXww7-cWmsr2DLJdfjSUT_R0Vwb7WnzCdrEc7I6QY3OePHi_nk2TKc2e722qLboOGKpBc-8NvjS2mi20-NvCF-QwQvZrAJWpnx9nvkNCV3ovYvGCwvCnWaGHfV_GILlkHFY63s2LzwAF7kuIISeoxuuKxjfpLesHXRNhKHQlYv3Ecpwl9VyNoL6VxA17hJE83iwlgPSrbAnfVBYBS3DDmkWNqeTj5yooNm41Gix9m1iSuWhqS1xbU9NVlxEnjfX_9XUYD1yYvm-mpJqTWDQSuJo4ffmLVtbrarNe5mxR-xUBwD7kbbiDxlZ5BfcGUV-2DD3RSzNDbgxZbU-8I93D28EpIPbXvoWrKgqvz8JxqWScrhMN9kyuU_SgxH-rVrD6jn_EeTiQYXwGxbCNzcW7S2wxI8Y_uv1EHwio6lAIetzZbAmTTUyxwBF1mlQP-lPUHpvKRAs-wUz7pw5DI8uSCu-8GZCz3xa0fqevlMghcm-YUOzMW4c8vLf3wGNQoLpyvIVHmByXymbGJ1-trNCuQTYtzs3PHmME3i8s-Ogll54Nprg0QGNiGaFKOmnmc1zoniPZa_QNABkOOQivGdwuhPO4b2q685m0uwxv1sJ7pC8vB8SQXWqIW9maHvOVauNsAldadssZpGGCwGfjwPkJvjGY8RF1JqRAKI6ImFB9OwPHJ47Mfy5JHpBvXZcL75LpxdHTXlyjMMosuw_E23Og_NMvk0kKoY4J1ydWt3Jkpdf1I-PmcdoApGnAGaNnL7WyEbcYM=h128"
      },
      "createTime": "2025-11-09T02:12:10.671Z",
      "updateTime": "2025-11-11T04:42:39.376Z",
      "functionSet": {
        "values": [
          {
            "name": "scorePathway",
            "parameters": [
              "pathway"
            ]
          },
          {
            "name": "calculateCompositeScore",
            "parameters": [
              "eduScore",
              "noveltyScore",
              "marketScore"
            ]
          },
          {
            "name": "getTier_",
            "parameters": [
              "score"
            ]
          },
          {
            "name": "generateSequenceRationale",
            "parameters": [
              "pathway"
            ]
          },
          {
            "name": "callOpenAI_",
            "parameters": [
              "prompt",
              "apiKey"
            ]
          },
          {
            "name": "parseOpenAIJSON_",
            "parameters": [
              "response"
            ]
          },
          {
            "name": "getOpenAIKey_"
          },
          {
            "name": "testScoringEngine"
          },
          {
            "name": "testSequenceRationale"
          }
        ]
      }
    },
    {
      "name": "Phase2_Pathway_Discovery_UI",
      "type": "SERVER_JS",
      "source": "/**\n * PHASE 2: PATHWAY DISCOVERY UI\n *\n * User interface for:\n * - Logic type selection (sorted by usage frequency)\n * - Pathway discovery execution\n * - Results display with scoring and persuasion\n * - Manual sequence adjustment\n */\n\n// ============================================================================\n// LOGIC TYPE MANAGEMENT\n// ============================================================================\n\n/**\n * Get logic types for dropdown (sorted by usage frequency)\n */\nfunction getLogicTypesForDropdown() {\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var sheet = ss.getSheetByName('Logic_Type_Library');\n  \n  if (!sheet) {\n    Logger.log('Logic_Type_Library sheet not found');\n    return [];\n  }\n  \n  var data = sheet.getDataRange().getValues();\n  var headers = data[0];\n  \n  // Find column indices\n  var idIdx = headers.indexOf('Logic_Type_ID');\n  var nameIdx = headers.indexOf('Logic_Type_Name');\n  var statusIdx = headers.indexOf('Status');\n  var timesUsedIdx = headers.indexOf('Times_Used');\n  \n  if (idIdx === -1 || nameIdx === -1 || statusIdx === -1) {\n    Logger.log('Required columns not found');\n    return [];\n  }\n  \n  var logicTypes = [];\n  var seenNames = {}; // Track seen names to prevent duplicates\n  \n  // Skip header row (row 0)\n  for (var i = 1; i < data.length; i++) {\n    var status = data[i][statusIdx];\n    var name = data[i][nameIdx];\n    \n    // Only include active logic types that haven't been seen yet\n    if (status === 'active' && !seenNames[name]) {\n      seenNames[name] = true; // Mark this name as seen\n      \n      logicTypes.push({\n        id: data[i][idIdx],\n        name: name,\n        timesUsed: parseInt(data[i][timesUsedIdx]) || 0\n      });\n    }\n  }\n  \n  // Sort by Times_Used (descending), then alphabetically by name\n  logicTypes.sort(function(a, b) {\n    if (b.timesUsed !== a.timesUsed) {\n      return b.timesUsed - a.timesUsed;\n    }\n    return a.name.localeCompare(b.name);\n  });\n  \n  return logicTypes;\n}\n\n/**\n * Increment logic type usage count\n */\nfunction incrementLogicTypeUsage(logicTypeId) {\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var sheet = ss.getSheetByName('Logic_Type_Library');\n  var data = sheet.getDataRange().getValues();\n  var headers = data[0];\n\n  var idIdx = headers.indexOf('Logic_Type_ID');\n  var timesUsedIdx = headers.indexOf('Times_Used');\n\n  // Find row with matching Logic_Type_ID\n  for (var i = 1; i < data.length; i++) {\n    if (data[i][idIdx] === logicTypeId) {\n      var currentUsage = parseInt(data[i][timesUsedIdx]) || 0;\n      var newUsage = currentUsage + 1;\n\n      // Update Times_Used\n      sheet.getRange(i + 1, timesUsedIdx + 1).setValue(newUsage);\n\n      Logger.log('‚úÖ Incremented ' + logicTypeId + ' usage: ' + currentUsage + ' ‚Üí ' + newUsage);\n      return newUsage;\n    }\n  }\n\n  Logger.log('‚ö†Ô∏è Logic Type ' + logicTypeId + ' not found');\n  return 0;\n}\n\n/**\n * Get logic type details by ID\n */\nfunction getLogicTypeById(logicTypeId) {\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var sheet = ss.getSheetByName('Logic_Type_Library');\n\n  if (!sheet) {\n    throw new Error('Logic_Type_Library sheet not found');\n  }\n\n  var data = sheet.getDataRange().getValues();\n  var headers = data[0];\n\n  var idIdx = headers.indexOf('Logic_Type_ID');\n  var nameIdx = headers.indexOf('Logic_Type_Name');\n  var descIdx = headers.indexOf('Description');\n  var personaIdx = headers.indexOf('AI_Persona');\n  var promptIdx = headers.indexOf('Full_Prompt');\n  var intelIdx = headers.indexOf('Intelligence_Type');\n\n  // Find matching row\n  for (var i = 1; i < data.length; i++) {\n    if (data[i][idIdx] === logicTypeId) {\n      return {\n        id: data[i][idIdx],\n        name: data[i][nameIdx],\n        description: data[i][descIdx],\n        persona: data[i][personaIdx],\n        prompt: data[i][promptIdx],\n        intelligenceType: data[i][intelIdx]\n      };\n    }\n  }\n\n  throw new Error('Logic Type not found: ' + logicTypeId);\n}\n\n// ============================================================================\n// PATHWAY DISCOVERY EXECUTION\n// ============================================================================\n\n/**\n * Discover pathways using selected logic type\n */\nfunction discoverPathwaysWithLogicType(logicTypeId) {\n  Logger.log('üîç Starting pathway discovery with logic type: ' + logicTypeId);\n\n  try {\n    // 1. Get logic type details\n    var logicType = getLogicTypeById(logicTypeId);\n    Logger.log('üìö Logic Type: ' + logicType.name);\n\n    // 2. Increment usage count\n    incrementLogicTypeUsage(logicTypeId);\n\n    // 3. Load cached case data from Field_Cache_Incremental\n    var caseData = loadCachedCaseData_();\n    Logger.log('üìä Loaded ' + caseData.length + ' cases from cache');\n\n    // 4. Call OpenAI with logic type prompt\n    var discoveredPathways = discoverPathwaysWithAI_(logicType, caseData);\n    Logger.log('‚úÖ Discovered ' + discoveredPathways.length + ' pathways');\n\n    // 5. Score each pathway\n    var scoredPathways = [];\n    for (var i = 0; i < discoveredPathways.length; i++) {\n      var pathway = discoveredPathways[i];\n      Logger.log('üéØ Scoring pathway ' + (i + 1) + ': ' + pathway.name);\n\n      var scoringResult = scorePathway(pathway);\n      var sequenceRationale = generateSequenceRationale(pathway);\n\n      scoredPathways.push({\n        pathway: pathway,\n        scoring: scoringResult,\n        sequence_rationale: sequenceRationale\n      });\n    }\n\n    // 6. Sort by composite score (descending)\n    scoredPathways.sort(function(a, b) {\n      return b.scoring.composite_score - a.scoring.composite_score;\n    });\n\n    // 7. Save to Pathways_Master sheet\n    savePathwaysToMaster_(scoredPathways, logicType);\n\n    // 8. Return results for UI display\n    return {\n      success: true,\n      logicType: logicType.name,\n      pathwaysCount: scoredPathways.length,\n      pathways: scoredPathways\n    };\n\n  } catch (error) {\n    Logger.log('‚ùå Discovery error: ' + error.message);\n    return {\n      success: false,\n      error: error.message\n    };\n  }\n}\n\n/**\n * Load cached case data from Field_Cache_Incremental\n */\nfunction loadCachedCaseData_() {\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var cacheSheet = ss.getSheetByName('Field_Cache_Incremental');\n\n  if (!cacheSheet) {\n    throw new Error('Field_Cache_Incremental sheet not found. Run batch cache first.');\n  }\n\n  var data = cacheSheet.getDataRange().getValues();\n  var headers = data[0];\n\n  // Build case objects\n  var cases = [];\n  for (var i = 1; i < data.length; i++) {\n    var caseObj = {};\n    for (var j = 0; j < headers.length; j++) {\n      caseObj[headers[j]] = data[i][j];\n    }\n    cases.push(caseObj);\n  }\n\n  return cases;\n}\n\n/**\n * Call OpenAI to discover pathways using logic type\n */\nfunction discoverPathwaysWithAI_(logicType, caseData) {\n  var apiKey = getOpenAIKey_();\n\n  // Build discovery prompt\n  var prompt = buildDiscoveryPrompt_(logicType, caseData);\n\n  // Call OpenAI\n  var response = callOpenAI_(prompt, apiKey);\n  var result = parseOpenAIJSON_(response);\n\n  return result.pathways || [];\n}\n\n/**\n * Build discovery prompt from logic type and case data\n */\nfunction buildDiscoveryPrompt_(logicType, caseData) {\n  // Create case catalog summary\n  var caseCatalog = caseData.map(function(c, idx) {\n    return (idx + 1) + '. ' + c.Simulation_ID + ' - ' + c.Chief_Complaint;\n  }).join('\\n');\n\n  var prompt = `\nYou are ${logicType.persona}.\n\n${logicType.description}\n\nTASK: Analyze this catalog of ${caseData.length} emergency medicine simulation cases and discover HIGH-VALUE learning pathways using your unique perspective.\n\nCASE CATALOG:\n${caseCatalog}\n\nDISCOVERY RULES:\n1. Suggest 3-5 pathways (quality over quantity)\n2. Each pathway should have 4-8 cases (digestible for learners)\n3. Groupings should be NON-OBVIOUS (not just organ systems)\n4. Focus on EMERGENT PATTERNS humans might miss\n5. Explain WHY each grouping creates learning value\n\nRETURN JSON:\n{\n  \"pathways\": [\n    {\n      \"id\": \"PATH_001\",\n      \"name\": \"Compelling pathway name (5-8 words)\",\n      \"description\": \"What makes this pathway valuable (2-3 sentences)\",\n      \"caseIds\": [\"GI01234\", \"CP05678\", ...],\n      \"caseTitles\": [\"Brief case title\", ...],\n      \"caseDiagnoses\": [\"Final diagnosis\", ...],\n      \"caseSequence\": [\"GI01234\", \"CP05678\", ...],\n      \"targetLearner\": \"PGY1-3\",\n      \"learningOutcomes\": [\"Specific measurable outcome 1\", \"Outcome 2\", ...],\n      \"progressionStyle\": \"Sequential\",\n      \"logicType\": \"${logicType.name}\"\n    }\n  ]\n}\n`;\n\n  return prompt;\n}\n\n/**\n * Save pathways to Pathways_Master sheet\n */\nfunction savePathwaysToMaster_(scoredPathways, logicType) {\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var masterSheet = ss.getSheetByName('Pathways_Master');\n\n  if (!masterSheet) {\n    throw new Error('Pathways_Master sheet not found');\n  }\n\n  // Activate sheet to prevent auto-switching bug\n  masterSheet.activate();\n\n  var today = new Date().toISOString().split('T')[0];\n\n  // Build rows\n  var rows = [];\n  for (var i = 0; i < scoredPathways.length; i++) {\n    var sp = scoredPathways[i];\n    var p = sp.pathway;\n    var s = sp.scoring;\n\n    rows.push([\n      p.id,                                          // Pathway_ID\n      p.name,                                        // Pathway_Name\n      p.description,                                 // Description\n      p.logicType,                                   // Logic_Type\n      JSON.stringify(p.caseIds),                     // Case_IDs\n      JSON.stringify(p.caseSequence),                // Case_Sequence\n      p.caseIds.length,                              // Case_Count\n      p.targetLearner,                               // Target_Learner\n      JSON.stringify(p.learningOutcomes),            // Learning_Outcomes\n      s.composite_score,                             // Composite_Score\n      s.tier,                                        // Tier\n      s.educational_value.educational_value_score,   // Educational_Score\n      s.novelty.novelty_score,                       // Novelty_Score\n      s.market_validation.market_validation_score,   // Market_Score\n      s.persuasion.persuasion_narrative,             // Persuasion_Narrative\n      JSON.stringify(sp.sequence_rationale),         // Sequence_Rationale\n      today,                                         // Date_Discovered\n      'pending'                                      // Status\n    ]);\n  }\n\n  // Append rows\n  if (rows.length > 0) {\n    masterSheet.getRange(masterSheet.getLastRow() + 1, 1, rows.length, 18).setValues(rows);\n    Logger.log('‚úÖ Saved ' + rows.length + ' pathways to Pathways_Master');\n  }\n}\n\n// ============================================================================\n// UI SIDEBAR\n// ============================================================================\n\n/**\n * Show pathway discovery sidebar\n */\nfunction showPathwayDiscoverySidebar() {\n  var html = buildPathwayDiscoveryHTML_();\n  var ui = HtmlService.createHtmlOutput(html)\n    .setTitle('üîç Discover Pathways')\n    .setWidth(400);\n\n  SpreadsheetApp.getUi().showSidebar(ui);\n}\n\n/**\n * Build pathway discovery sidebar HTML\n */\nfunction buildPathwayDiscoveryHTML_() {\n  var logicTypes = getLogicTypesForDropdown();\n\n  var html = `\n<!DOCTYPE html>\n<html>\n<head>\n  <base target=\"_top\">\n  <style>\n    body {\n      font-family: 'Google Sans', Arial, sans-serif;\n      padding: 16px;\n      background: #f8f9fa;\n    }\n    .form-group {\n      margin-bottom: 20px;\n    }\n    label {\n      display: block;\n      font-weight: 600;\n      margin-bottom: 8px;\n      color: #202124;\n    }\n    select, button {\n      width: 100%;\n      padding: 10px;\n      font-size: 14px;\n      border: 1px solid #dadce0;\n      border-radius: 4px;\n    }\n    select:focus {\n      outline: none;\n      border-color: #1a73e8;\n    }\n    button {\n      background: #1a73e8;\n      color: white;\n      font-weight: 600;\n      cursor: pointer;\n      border: none;\n      margin-top: 10px;\n    }\n    button:hover {\n      background: #1557b0;\n    }\n    button:disabled {\n      background: #dadce0;\n      cursor: not-allowed;\n    }\n    .help-text {\n      font-size: 12px;\n      color: #5f6368;\n      margin-top: 4px;\n    }\n    .results {\n      margin-top: 20px;\n      padding: 16px;\n      background: white;\n      border-radius: 8px;\n      border: 1px solid #dadce0;\n      display: none;\n    }\n    .pathway-card {\n      margin-bottom: 16px;\n      padding: 12px;\n      background: #f8f9fa;\n      border-radius: 4px;\n      border-left: 4px solid #1a73e8;\n    }\n    .tier-badge {\n      display: inline-block;\n      padding: 4px 8px;\n      border-radius: 4px;\n      font-size: 12px;\n      font-weight: 600;\n      margin-left: 8px;\n    }\n    .tier-s { background: #ffd700; color: #000; }\n    .tier-a { background: #c0c0c0; color: #000; }\n    .tier-b { background: #cd7f32; color: #fff; }\n    .tier-c { background: #e8eaed; color: #000; }\n    .tier-d { background: #f1f3f4; color: #5f6368; }\n  </style>\n</head>\n<body>\n  <h2>üîç Discover Pathways</h2>\n  <p>Select a logic type to discover high-value learning pathways using AI.</p>\n\n  <div class=\"form-group\">\n    <label for=\"logic-type-selector\">üß† Logic Type (Discovery Lens)</label>\n    <select id=\"logic-type-selector\" onchange=\"handleLogicTypeChange()\">\n      <option value=\"\">-- Select Logic Type --</option>`;\n\n  for (var i = 0; i < logicTypes.length; i++) {\n    var lt = logicTypes[i];\n    var usageLabel = lt.timesUsed > 0 ? ' (' + lt.timesUsed + ' uses)' : '';\n    html += '<option value=\"' + lt.id + '\">' + lt.name + usageLabel + '</option>';\n  }\n\n  html += `\n      <option value=\"\" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>\n      <option value=\"CREATE_NEW\">üé® Create New Logic Type...</option>\n    </select>\n    <div class=\"help-text\">Most frequently used logic types appear first</div>\n  </div>\n\n  <button id=\"discover-btn\" onclick=\"discoverPathways()\" disabled>\n    ü§ñ Discover Pathways\n  </button>\n\n  <div id=\"results\" class=\"results\">\n    <h3>Discovery Results</h3>\n    <div id=\"results-content\"></div>\n  </div>\n\n  <script>\n    function handleLogicTypeChange() {\n      const value = document.getElementById('logic-type-selector').value;\n\n      if (value === 'CREATE_NEW') {\n        alert('Create New Logic Type feature coming soon!');\n        document.getElementById('logic-type-selector').value = '';\n        document.getElementById('discover-btn').disabled = true;\n      } else if (value) {\n        document.getElementById('discover-btn').disabled = false;\n      } else {\n        document.getElementById('discover-btn').disabled = true;\n      }\n    }\n\n    function discoverPathways() {\n      const logicTypeId = document.getElementById('logic-type-selector').value;\n\n      if (!logicTypeId || logicTypeId === 'CREATE_NEW') {\n        alert('Please select a logic type first');\n        return;\n      }\n\n      // Show loading\n      const btn = document.getElementById('discover-btn');\n      btn.disabled = true;\n      btn.textContent = 'üîÑ Discovering...';\n\n      // Call server-side discovery function\n      google.script.run\n        .withSuccessHandler(handleDiscoveryResults)\n        .withFailureHandler(handleDiscoveryError)\n        .discoverPathwaysWithLogicType(logicTypeId);\n    }\n\n    function handleDiscoveryResults(result) {\n      const btn = document.getElementById('discover-btn');\n      btn.disabled = false;\n      btn.textContent = 'ü§ñ Discover Pathways';\n\n      if (!result.success) {\n        alert('Error: ' + result.error);\n        return;\n      }\n\n      // Show results\n      const resultsDiv = document.getElementById('results');\n      const contentDiv = document.getElementById('results-content');\n\n      let html = '<p><strong>' + result.pathwaysCount + ' pathways discovered using \"' + result.logicType + '\"</strong></p>';\n\n      result.pathways.forEach(function(sp, idx) {\n        const p = sp.pathway;\n        const s = sp.scoring;\n        const tierClass = 'tier-' + s.tier.charAt(0).toLowerCase();\n\n        html += '<div class=\"pathway-card\">';\n        html += '<strong>' + (idx + 1) + '. ' + p.name + '</strong>';\n        html += '<span class=\"tier-badge ' + tierClass + '\">' + s.tier + '</span>';\n        html += '<p style=\"margin: 8px 0; font-size: 13px;\">' + p.description + '</p>';\n        html += '<p style=\"margin: 8px 0; font-size: 12px; color: #5f6368;\"><em>\"' + s.persuasion.persuasion_narrative + '\"</em></p>';\n        html += '<p style=\"margin: 8px 0; font-size: 12px;\">üìä Score: ' + s.composite_score + '/10 | üìö Cases: ' + p.caseIds.length + '</p>';\n        html += '</div>';\n      });\n\n      contentDiv.innerHTML = html;\n      resultsDiv.style.display = 'block';\n\n      // Success toast\n      alert('‚úÖ Discovery complete! ' + result.pathwaysCount + ' pathways saved to Pathways_Master sheet.');\n    }\n\n    function handleDiscoveryError(error) {\n      const btn = document.getElementById('discover-btn');\n      btn.disabled = false;\n      btn.textContent = 'ü§ñ Discover Pathways';\n\n      alert('Error during discovery: ' + error.message);\n    }\n  </script>\n</body>\n</html>\n  `;\n\n  return html;\n}\n\n// ============================================================================\n// MENU INTEGRATION\n// ============================================================================\n\n/**\n * Add pathway discovery menu item (call from onOpen)\n */\nfunction addPathwayDiscoveryMenu() {\n  var ui = SpreadsheetApp.getUi();\n  ui.createMenu('üîç Pathway Discovery')\n    .addItem('Discover Pathways', 'showPathwayDiscoverySidebar')\n    .addSeparator()\n    .addItem('View All Pathways', 'viewAllPathways')\n    .addItem('Manage Logic Types', 'manageLogicTypes')\n    .addToUi();\n}\n\n/**\n * View all discovered pathways\n */\nfunction viewAllPathways() {\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var masterSheet = ss.getSheetByName('Pathways_Master');\n\n  if (!masterSheet) {\n    SpreadsheetApp.getUi().alert('Pathways_Master sheet not found');\n    return;\n  }\n\n  masterSheet.activate();\n  SpreadsheetApp.getUi().alert('Showing all discovered pathways in Pathways_Master sheet');\n}\n\n/**\n * Manage logic types\n */\nfunction manageLogicTypes() {\n  var ss = SpreadsheetApp.getActiveSpreadsheet();\n  var librarySheet = ss.getSheetByName('Logic_Type_Library');\n\n  if (!librarySheet) {\n    SpreadsheetApp.getUi().alert('Logic_Type_Library sheet not found');\n    return;\n  }\n\n  librarySheet.activate();\n  SpreadsheetApp.getUi().alert('Showing Logic Type Library. You can add custom logic types here.');\n}\n",
      "lastModifyUser": {
        "domain": "ersimulator.com",
        "email": "support@ersimulator.com",
        "name": "Aaron Tjomsland",
        "photoUrl": "https://lh3.googleusercontent.com/a-/ALV-UjWqjAHY15ugT_65GCYyIOdya8IsaYpRoXhg8zPNCFOZli7OIZef57v0vfPVHgdIc17nrKQX8RvFMotOWdiAJBi2Z8EvBsAdh5GHMLT6VwUDxulPbACn039MZEDMjGvEQ6Ps2GbhAuuwKxgy_KN_q1Rq9upQd2UNjYnz_Uspr2GepdVdVNsljJ-DDAv-42pz7IOGDYkiIg-J7reiSUsTtGi6L1Gc_plMbGLqao0qberaqBqQ2uV20xfvaHILx12hTMouOqHUdF_kv3I9T7Tz95zpYo1S4_vLbnngaUlYehv_FW2UnkUXww7-cWmsr2DLJdfjSUT_R0Vwb7WnzCdrEc7I6QY3OePHi_nk2TKc2e722qLboOGKpBc-8NvjS2mi20-NvCF-QwQvZrAJWpnx9nvkNCV3ovYvGCwvCnWaGHfV_GILlkHFY63s2LzwAF7kuIISeoxuuKxjfpLesHXRNhKHQlYv3Ecpwl9VyNoL6VxA17hJE83iwlgPSrbAnfVBYBS3DDmkWNqeTj5yooNm41Gix9m1iSuWhqS1xbU9NVlxEnjfX_9XUYD1yYvm-mpJqTWDQSuJo4ffmLVtbrarNe5mxR-xUBwD7kbbiDxlZ5BfcGUV-2DD3RSzNDbgxZbU-8I93D28EpIPbXvoWrKgqvz8JxqWScrhMN9kyuU_SgxH-rVrD6jn_EeTiQYXwGxbCNzcW7S2wxI8Y_uv1EHwio6lAIetzZbAmTTUyxwBF1mlQP-lPUHpvKRAs-wUz7pw5DI8uSCu-8GZCz3xa0fqevlMghcm-YUOzMW4c8vLf3wGNQoLpyvIVHmByXymbGJ1-trNCuQTYtzs3PHmME3i8s-Ogll54Nprg0QGNiGaFKOmnmc1zoniPZa_QNABkOOQivGdwuhPO4b2q685m0uwxv1sJ7pC8vB8SQXWqIW9maHvOVauNsAldadssZpGGCwGfjwPkJvjGY8RF1JqRAKI6ImFB9OwPHJ47Mfy5JHpBvXZcL75LpxdHTXlyjMMosuw_E23Og_NMvk0kKoY4J1ydWt3Jkpdf1I-PmcdoApGnAGaNnL7WyEbcYM=h128"
      },
      "createTime": "2025-11-09T02:31:23.244Z",
      "updateTime": "2025-11-11T04:42:39.376Z",
      "functionSet": {
        "values": [
          {
            "name": "getLogicTypesForDropdown"
          },
          {
            "name": "incrementLogicTypeUsage",
            "parameters": [
              "logicTypeId"
            ]
          },
          {
            "name": "getLogicTypeById",
            "parameters": [
              "logicTypeId"
            ]
          },
          {
            "name": "discoverPathwaysWithLogicType",
            "parameters": [
              "logicTypeId"
            ]
          },
          {
            "name": "loadCachedCaseData_"
          },
          {
            "name": "discoverPathwaysWithAI_",
            "parameters": [
              "logicType",
              "caseData"
            ]
          },
          {
            "name": "buildDiscoveryPrompt_",
            "parameters": [
              "logicType",
              "caseData"
            ]
          },
          {
            "name": "savePathwaysToMaster_",
            "parameters": [
              "scoredPathways",
              "logicType"
            ]
          },
          {
            "name": "showPathwayDiscoverySidebar"
          },
          {
            "name": "buildPathwayDiscoveryHTML_"
          },
          {
            "name": "addPathwayDiscoveryMenu"
          },
          {
            "name": "viewAllPathways"
          },
          {
            "name": "manageLogicTypes"
          }
        ]
      }
    },
    {
      "name": "Phase2_Enhanced_Categories_Pathways_Panel",
      "type": "SERVER_JS",
      "source": "/**\n * PHASE 2: ENHANCED CATEGORIES & PATHWAYS PANEL (WITH AI CATEGORIZATION)\n *\n * Updated to include AI Auto-Categorization review interface\n */\n\n/**\n * Open Categories & Pathways Panel (with AI Discovery tab + AI Categorization)\n */\nfunction openCategoriesPathwaysPanel() {\n  const ui = getSafeUi_();\n  if (!ui) return;\n\n  const html = buildCategoriesPathwaysMainMenu_();\n  ui.showSidebar(HtmlService.createHtmlOutput(html).setTitle('üìÇ Categories & Pathways').setWidth(400));\n}\n\n/**\n * Build main menu with tabbed interface (including AI categorization)\n */\nfunction buildCategoriesPathwaysMainMenu_() {\n  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Master Scenario Convert');\n\n  if (!sheet) {\n    return '<p style=\"padding:20px;\">Error: Master Scenario Convert sheet not found</p>';\n  }\n\n  const data = sheet.getDataRange().getValues();\n\n  if (!data || data.length < 2) {\n    return '<p style=\"padding:20px;\">Error: Sheet has insufficient data (need at least 2 rows)</p>';\n  }\n\n  const headers = data[1]; // Row 2\n\n  if (!headers) {\n    return '<p style=\"padding:20px;\">Error: Header row (row 2) not found</p>';\n  }\n\n  // Get column indices\n  const categoryIdx = headers.indexOf('Case_Organization_Category_Symptom');\n  const pathwayIdx = headers.indexOf('Case_Organization:Pathway_Name');\n\n  // Count categories and pathways\n  const categoryCounts = {};\n  const pathwayCounts = {};\n\n  for (let i = 2; i < data.length; i++) {\n    const category = data[i][categoryIdx] || 'Uncategorized';\n    const pathway = data[i][pathwayIdx] || 'Unassigned';\n\n    categoryCounts[category] = (categoryCounts[category] || 0) + 1;\n    pathwayCounts[pathway] = (pathwayCounts[pathway] || 0) + 1;\n  }\n\n  const totalCases = data.length - 2;\n\n  // Build category list\n  const categoryList = Object.entries(categoryCounts)\n    .sort((a, b) => b[1] - a[1])\n    .map(([cat, count]) => `\n      <div class=\"list-item\" onclick=\"viewCategory('${cat.replace(/'/g, \"\\\\'\")}')\">\n        <span class=\"item-label\">${cat}</span>\n        <span class=\"item-count\">${count}</span>\n      </div>\n    `).join('');\n\n  // Build pathway list (top 10)\n  const pathwayList = Object.entries(pathwayCounts)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 10)\n    .map(([path, count]) => `\n      <div class=\"list-item\" onclick=\"viewPathway('${path.replace(/'/g, \"\\\\'\")}')\">\n        <span class=\"item-label\">${path}</span>\n        <span class=\"item-count\">${count}</span>\n      </div>\n    `).join('');\n\n  // Get logic types for AI Discovery tab\n  const logicTypes = getLogicTypesForDropdown();\n  const logicTypeOptions = logicTypes.map(lt => {\n    const usageLabel = lt.timesUsed > 0 ? ` (${lt.timesUsed} uses)` : '';\n    return `<option value=\"${lt.id}\">${lt.name}${usageLabel}</option>`;\n  }).join('');\n\n  // Get categorization stats (if results exist)\n  const categorizationStats = getCategorizationStats();\n\n  return `\n<!DOCTYPE html>\n<html>\n<head>\n  <base target=\"_top\">\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n\n    body {\n      font-family: Arial, sans-serif;\n      background: #f5f7fa;\n      color: #2c3e50;\n      font-size: 13px;\n    }\n\n    /* Tab Navigation */\n    .tabs {\n      display: flex;\n      background: #fff;\n      border-bottom: 2px solid #dfe3e8;\n    }\n\n    .tab {\n      flex: 1;\n      padding: 12px 8px;\n      text-align: center;\n      cursor: pointer;\n      border-bottom: 3px solid transparent;\n      transition: all 0.2s;\n      font-size: 12px;\n      font-weight: 600;\n      color: #7f8c9d;\n    }\n\n    .tab:hover {\n      background: #f8f9fa;\n      color: #2c3e50;\n    }\n\n    .tab.active {\n      color: #3b7ddd;\n      border-bottom-color: #3b7ddd;\n      background: #f8f9fa;\n    }\n\n    .tab-content {\n      display: none;\n    }\n\n    .tab-content.active {\n      display: block;\n    }\n\n    .header {\n      background: #fff;\n      padding: 16px;\n      border-bottom: 1px solid #dfe3e8;\n    }\n\n    .header h1 {\n      font-size: 16px;\n      font-weight: 600;\n      color: #2c3e50;\n      margin-bottom: 4px;\n    }\n\n    .header .subtitle {\n      font-size: 12px;\n      color: #7f8c9d;\n    }\n\n    .stats {\n      background: #fff;\n      padding: 12px 16px;\n      border-bottom: 1px solid #dfe3e8;\n      display: flex;\n      justify-content: space-around;\n    }\n\n    .stat {\n      text-align: center;\n    }\n\n    .stat .num {\n      font-size: 20px;\n      font-weight: 700;\n      color: #3b7ddd;\n      display: block;\n    }\n\n    .stat .label {\n      font-size: 11px;\n      color: #7f8c9d;\n      text-transform: uppercase;\n    }\n\n    .section {\n      background: #fff;\n      margin: 12px;\n      padding: 14px;\n      border-radius: 6px;\n      border: 1px solid #dfe3e8;\n    }\n\n    .section-title {\n      font-size: 13px;\n      font-weight: 600;\n      color: #2c3e50;\n      margin-bottom: 10px;\n      padding-bottom: 8px;\n      border-bottom: 1px solid #f0f2f5;\n    }\n\n    .btn {\n      display: block;\n      width: 100%;\n      background: #fff;\n      border: 1px solid #d1d7de;\n      color: #2c3e50;\n      padding: 10px 12px;\n      margin-bottom: 8px;\n      border-radius: 4px;\n      cursor: pointer;\n      text-align: left;\n      font-size: 13px;\n      transition: all 0.2s;\n    }\n\n    .btn:hover {\n      background: #f5f7fa;\n      border-color: #3b7ddd;\n    }\n\n    .btn-primary {\n      background: #3b7ddd;\n      color: #fff;\n      border-color: #3b7ddd;\n      font-weight: 600;\n    }\n\n    .btn-primary:hover {\n      background: #2d6bc6;\n    }\n\n    .btn-success {\n      background: #28a745;\n      color: #fff;\n      border-color: #28a745;\n      font-weight: 600;\n    }\n\n    .btn-success:hover {\n      background: #218838;\n    }\n\n    .btn:disabled {\n      background: #d1d7de;\n      cursor: not-allowed;\n      opacity: 0.6;\n    }\n\n    .list-item {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding: 8px 10px;\n      margin-bottom: 4px;\n      background: #f8f9fa;\n      border-radius: 4px;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n\n    .list-item:hover {\n      background: #e9ecef;\n    }\n\n    .item-label {\n      font-size: 13px;\n      color: #2c3e50;\n    }\n\n    .item-count {\n      font-size: 12px;\n      color: #7f8c9d;\n      background: #fff;\n      padding: 2px 8px;\n      border-radius: 10px;\n    }\n\n    .scrollable {\n      max-height: 200px;\n      overflow-y: auto;\n    }\n\n    .scrollable::-webkit-scrollbar {\n      width: 6px;\n    }\n\n    .scrollable::-webkit-scrollbar-track {\n      background: #f0f2f5;\n    }\n\n    .scrollable::-webkit-scrollbar-thumb {\n      background: #d1d7de;\n      border-radius: 3px;\n    }\n\n    .info {\n      background: #e8f4fd;\n      border: 1px solid #bee5eb;\n      padding: 10px 12px;\n      border-radius: 4px;\n      font-size: 12px;\n      color: #31708f;\n      margin-top: 12px;\n    }\n\n    .warning {\n      background: #fff3cd;\n      border: 1px solid #ffc107;\n      padding: 10px 12px;\n      border-radius: 4px;\n      font-size: 12px;\n      color: #856404;\n      margin-top: 12px;\n    }\n\n    /* AI Discovery Tab Specific Styles */\n    select {\n      width: 100%;\n      padding: 10px;\n      font-size: 13px;\n      border: 1px solid #d1d7de;\n      border-radius: 4px;\n      margin-bottom: 12px;\n      background: #fff;\n    }\n\n    select:focus {\n      outline: none;\n      border-color: #3b7ddd;\n    }\n\n    .help-text {\n      font-size: 11px;\n      color: #7f8c9d;\n      margin: -8px 0 12px 0;\n    }\n\n    .pathway-card {\n      margin-bottom: 12px;\n      padding: 12px;\n      background: #f8f9fa;\n      border-radius: 4px;\n      border-left: 4px solid #3b7ddd;\n    }\n\n    .pathway-card strong {\n      font-size: 13px;\n      color: #2c3e50;\n    }\n\n    .tier-badge {\n      display: inline-block;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 11px;\n      font-weight: 600;\n      margin-left: 8px;\n    }\n\n    .tier-s { background: #ffd700; color: #000; }\n    .tier-a { background: #c0c0c0; color: #000; }\n    .tier-b { background: #cd7f32; color: #fff; }\n    .tier-c { background: #e8eaed; color: #000; }\n    .tier-d { background: #f1f3f4; color: #5f6368; }\n\n    .pathway-desc {\n      margin: 8px 0;\n      font-size: 12px;\n      color: #5f6368;\n    }\n\n    .pathway-persuasion {\n      margin: 8px 0;\n      font-size: 12px;\n      color: #5f6368;\n      font-style: italic;\n      padding: 8px;\n      background: #fff;\n      border-radius: 4px;\n    }\n\n    .pathway-meta {\n      margin: 8px 0;\n      font-size: 11px;\n      color: #7f8c9d;\n    }\n\n    #results-container {\n      display: none;\n      margin-top: 12px;\n    }\n\n    #results-container.visible {\n      display: block;\n    }\n\n    /* AI Categorization Review Styles */\n    #ai-review-container {\n      display: none;\n    }\n\n    #ai-review-container.visible {\n      display: block;\n    }\n\n    .review-table {\n      width: 100%;\n      border-collapse: collapse;\n      font-size: 12px;\n      margin-top: 12px;\n    }\n\n    .review-table th {\n      background: #2a3040;\n      color: #e7eaf0;\n      padding: 8px;\n      text-align: left;\n      font-size: 11px;\n      text-transform: uppercase;\n    }\n\n    .review-table td {\n      padding: 8px;\n      border-bottom: 1px solid #dfe3e8;\n    }\n\n    .review-table tr:hover {\n      background: #f8f9fa;\n    }\n\n    .status-badge {\n      display: inline-block;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 11px;\n      font-weight: 600;\n    }\n\n    .status-new { background: #e8f5e9; color: #2e7d32; }\n    .status-matches { background: #f1f8ff; color: #0366d6; }\n    .status-conflict { background: #fff3e0; color: #e65100; }\n    .status-error { background: #ffebee; color: #c62828; }\n\n    .category-current {\n      color: #ff9800;\n      font-weight: 600;\n    }\n\n    .category-suggested {\n      color: #4caf50;\n      font-weight: 600;\n    }\n\n    .mini-select {\n      width: 100%;\n      padding: 4px;\n      font-size: 11px;\n      border: 1px solid #d1d7de;\n      border-radius: 3px;\n    }\n\n    .btn-mini {\n      padding: 4px 8px;\n      font-size: 11px;\n      margin: 2px;\n    }\n\n    .filter-bar {\n      display: flex;\n      gap: 8px;\n      margin-bottom: 12px;\n      align-items: center;\n    }\n\n    .filter-bar select {\n      flex: 1;\n      margin: 0;\n    }\n\n    .stats-mini {\n      display: flex;\n      gap: 12px;\n      padding: 10px;\n      background: #f8f9fa;\n      border-radius: 4px;\n      margin-bottom: 12px;\n    }\n\n    .stats-mini .stat-mini {\n      flex: 1;\n      text-align: center;\n    }\n\n    .stats-mini .stat-mini .num {\n      display: block;\n      font-size: 18px;\n      font-weight: 700;\n      color: #2c3e50;\n    }\n\n    .stats-mini .stat-mini .label {\n      display: block;\n      font-size: 10px;\n      color: #7f8c9d;\n      text-transform: uppercase;\n    }\n  </style>\n</head>\n<body>\n  <!-- Tab Navigation -->\n  <div class=\"tabs\">\n    <div class=\"tab active\" onclick=\"switchTab('categories')\">üìä Categories</div>\n    <div class=\"tab\" onclick=\"switchTab('discovery')\">üîç AI Discovery</div>\n  </div>\n\n  <!-- Tab 1: Categories (Enhanced with AI Categorization) -->\n  <div id=\"categories-tab\" class=\"tab-content active\">\n    <div class=\"header\">\n      <h1>üìÇ Categories & Pathways</h1>\n      <div class=\"subtitle\">AI-powered categorization + manual organization</div>\n    </div>\n\n    <div class=\"stats\">\n      <div class=\"stat\">\n        <span class=\"num\">${totalCases}</span>\n        <span class=\"label\">Cases</span>\n      </div>\n      <div class=\"stat\">\n        <span class=\"num\">${Object.keys(categoryCounts).length}</span>\n        <span class=\"label\">Categories</span>\n      </div>\n      <div class=\"stat\">\n        <span class=\"num\">${Object.keys(pathwayCounts).length}</span>\n        <span class=\"label\">Pathways</span>\n      </div>\n    </div>\n\n    <!-- AI Categorization Section -->\n    <div class=\"section\">\n      <div class=\"section-title\">ü§ñ AI Auto-Categorization</div>\n      <button id=\"run-ai-btn\" class=\"btn btn-success\" onclick=\"runAICategorization()\">\n        üöÄ Run AI Categorization (All 207 Cases)\n      </button>\n      <button class=\"btn btn-danger\" onclick=\"clearAIResults()\">\n        üóëÔ∏è Clear Results\n      </button>\n      <button class=\"btn\" onclick=\"editCategoryMappings()\">\n        ‚öôÔ∏è Edit Category Mappings (Symptoms & Systems)\n      </button>\n      <div class=\"help-text\">\n        AI will analyze all cases and suggest Symptom + System categories.\n        Review and adjust before applying to Master Scenario Convert.\n      </div>\n    </div>\n\n    <!-- AI Review Container (shows after AI run) -->\n    <div id=\"ai-review-container\">\n      <div class=\"section\">\n        <div class=\"section-title\">üìã Review AI Suggestions</div>\n\n        <!-- Stats -->\n        <div class=\"stats-mini\">\n          <div class=\"stat-mini\">\n            <span class=\"num\" id=\"stat-new\">${categorizationStats.new}</span>\n            <span class=\"label\">New</span>\n          </div>\n          <div class=\"stat-mini\">\n            <span class=\"num\" id=\"stat-matches\">${categorizationStats.matches}</span>\n            <span class=\"label\">Matches</span>\n          </div>\n          <div class=\"stat-mini\">\n            <span class=\"num\" id=\"stat-conflicts\">${categorizationStats.conflicts}</span>\n            <span class=\"label\">Conflicts</span>\n          </div>\n          <div class=\"stat-mini\">\n            <span class=\"num\" id=\"stat-errors\">${categorizationStats.errors}</span>\n            <span class=\"label\">Errors</span>\n          </div>\n        </div>\n\n        <!-- Filter Bar -->\n        <div class=\"filter-bar\">\n          <select id=\"filter-status\" onchange=\"filterResults()\">\n            <option value=\"all\">All Cases</option>\n            <option value=\"new\">New (Uncategorized)</option>\n            <option value=\"matches\">Matches (AI Agrees)</option>\n            <option value=\"conflicts\">Conflicts (AI Disagrees)</option>\n            <option value=\"errors\">Errors</option>\n          </select>\n          <button class=\"btn btn-mini\" onclick=\"refreshReviewData()\">üîÑ Refresh</button>\n        </div>\n\n        <!-- Results Table (loaded via AJAX) -->\n        <div id=\"review-results\" class=\"scrollable\" style=\"max-height: 400px;\">\n          <p class=\"help-text\">Click \"Refresh\" to load AI categorization results</p>\n        </div>\n\n        <!-- Action Buttons -->\n        <button id=\"apply-btn\" class=\"btn btn-primary\" onclick=\"applyCategorizations()\" style=\"margin-top: 12px;\">\n          ‚úÖ Apply Selected Categories to Master\n        </button>\n        <button class=\"btn\" onclick=\"exportCategorizationResults()\">\n          üíæ Export Results to CSV\n        </button>\n      </div>\n    </div>\n\n    <!-- Manual Actions Section -->\n    <div class=\"section\">\n      <div class=\"section-title\">Manual Actions</div>\n      <button class=\"btn\" onclick=\"viewAllCategories()\">üìä View All Categories</button>\n      <button class=\"btn\" onclick=\"viewAllPathways()\">üß© View All Pathways</button>\n      <button class=\"btn\" onclick=\"assignCase()\">üîó Assign Case to Category/Pathway</button>\n    </div>\n\n    <!-- Category List -->\n    <div class=\"section\">\n      <div class=\"section-title\">Medical System Categories</div>\n      <div class=\"scrollable\">\n        ${categoryList || '<div class=\"info\">No categories found</div>'}\n      </div>\n    </div>\n\n    <!-- Pathway List -->\n    <div class=\"section\">\n      <div class=\"section-title\">Learning Pathways (Top 10)</div>\n      <div class=\"scrollable\">\n        ${pathwayList || '<div class=\"info\">No pathways found</div>'}\n      </div>\n    </div>\n  </div>\n\n  <!-- Tab 2: AI Discovery (Existing) -->\n  <div id=\"discovery-tab\" class=\"tab-content\">\n    <div class=\"header\">\n      <h1>üîç AI Pathway Discovery</h1>\n      <div class=\"subtitle\">Discover high-value learning pathways using AI</div>\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Discovery Lens (Logic Type)</div>\n      <select id=\"logic-type-selector\" onchange=\"handleLogicTypeChange()\">\n        <option value=\"\">-- Select Logic Type --</option>\n        ${logicTypeOptions}\n        <option value=\"\" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>\n        <option value=\"CREATE_NEW\">üé® Create New Logic Type...</option>\n      </select>\n      <div class=\"help-text\">Most frequently used logic types appear first</div>\n\n      <button id=\"discover-btn\" class=\"btn btn-primary\" onclick=\"discoverPathways()\" disabled>\n        ü§ñ Discover Pathways\n      </button>\n    </div>\n\n    <div id=\"results-container\">\n      <div class=\"section\">\n        <div class=\"section-title\">Discovery Results</div>\n        <div id=\"results-content\"></div>\n      </div>\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Manage Logic Types</div>\n      <button class=\"btn\" onclick=\"viewLogicTypeLibrary()\">üìö View Logic Type Library</button>\n      <button class=\"btn\" onclick=\"viewPathwaysMaster()\">üìä View All Discovered Pathways</button>\n    </div>\n  </div>\n\n  <script>\n    // Global state\n    let currentFilter = 'all';\n    let categorizationData = [];\n\n    // ========================================================================\n    // TAB SWITCHING\n    // ========================================================================\n\n    function switchTab(tabName) {\n      // Update tab buttons\n      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));\n      event.target.classList.add('active');\n\n      // Update tab content\n      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));\n      document.getElementById(tabName + '-tab').classList.add('active');\n    }\n\n    // ========================================================================\n    // CATEGORIES TAB - MANUAL ACTIONS (EXISTING)\n    // ========================================================================\n\n    function viewCategory(category) {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .getCategoryView(category);\n    }\n\n    function viewPathway(pathway) {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .getPathwayView(pathway);\n    }\n\n    function viewAllCategories() {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .getAllCategoriesView();\n    }\n\n    function viewAllPathways() {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .getAllPathwaysView();\n    }\n\n    function assignCase() {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .getCaseAssignmentView();\n    }\n\n    // ========================================================================\n    // AI CATEGORIZATION FUNCTIONS (NEW)\n    // ========================================================================\n\n    /**\n     * Run AI Categorization on all 207 cases\n     */\n    function runAICategorization() {\n      const btn = document.getElementById('run-ai-btn');\n\n      if (!confirm('Run AI categorization on all 207 cases?\\\\n\\\\nThis will take 2-3 minutes and cost ~$0.20.\\\\n\\\\nResults will be saved to AI_Categorization_Results sheet for review.')) {\n        return;\n      }\n\n      btn.disabled = true;\n      btn.textContent = 'üîÑ Running AI Categorization...';\n      btn.style.background = '#ffc107';\n\n      google.script.run\n        .withSuccessHandler(handleAICategorizationComplete)\n        .withFailureHandler(handleAICategorizationError)\n        .runAICategorization();\n    }\n\n    function handleAICategorizationComplete(result) {\n      const btn = document.getElementById('run-ai-btn');\n      btn.disabled = false;\n      btn.textContent = '‚úÖ AI Categorization Complete';\n      btn.style.background = '#28a745';\n\n      alert('‚úÖ AI Categorization Complete!\\\\n\\\\n' +\n            'Total cases processed: ' + result.totalCases + '\\\\n' +\n            'Results saved to: ' + result.resultsSheetName + '\\\\n\\\\n' +\n            'Click \"Refresh\" below to review results.');\n\n      // Show review container\n      document.getElementById('ai-review-container').classList.add('visible');\n\n      // Auto-refresh review data\n      setTimeout(refreshReviewData, 500);\n    }\n\n    function handleAICategorizationError(error) {\n      const btn = document.getElementById('run-ai-btn');\n      btn.disabled = false;\n      btn.textContent = 'üöÄ Run AI Categorization (All 207 Cases)';\n      btn.style.background = '#28a745';\n\n      alert('‚ùå Error during AI categorization:\\\\n\\\\n' + error.message);\n    }\n\n    /**\n     * Clear AI Categorization Results sheet\n     */\n    function clearAIResults() {\n      if (!confirm('Clear all AI categorization results?\\\\n\\\\nThis will delete the AI_Categorization_Results sheet.\\\\n\\\\nThis action cannot be undone.')) {\n        return;\n      }\n\n      google.script.run\n        .withSuccessHandler(handleClearSuccess)\n        .withFailureHandler(handleClearError)\n        .clearAICategorizationResults();\n    }\n\n    function handleClearSuccess() {\n      alert('‚úÖ Results cleared successfully!\\\\n\\\\nThe AI_Categorization_Results sheet has been cleared.');\n\n      // Hide review container\n      document.getElementById('ai-review-container').classList.remove('visible');\n\n      // Clear review results display\n      document.getElementById('review-results').innerHTML = '<p class=\"info\">No results found. Run AI Categorization first.</p>';\n    }\n\n    function handleClearError(error) {\n      alert('‚ùå Error clearing results:\\\\n\\\\n' + error.message);\n    }\n\n    /**\n     * Refresh review data from AI_Categorization_Results sheet\n     */\n    function refreshReviewData() {\n      document.getElementById('review-results').innerHTML = '<p class=\"help-text\">‚è≥ Loading results...</p>';\n\n      google.script.run\n        .withSuccessHandler(handleReviewDataLoaded)\n        .withFailureHandler(handleReviewDataError)\n        .getCategorizationResults(currentFilter, 1, 50);\n    }\n\n    function handleReviewDataLoaded(data) {\n      categorizationData = data.results;\n\n      if (categorizationData.length === 0) {\n        document.getElementById('review-results').innerHTML = '<p class=\"info\">No results found. Run AI Categorization first.</p>';\n        return;\n      }\n\n      // Update stats\n      google.script.run\n        .withSuccessHandler(updateStats)\n        .getCategorizationStats();\n\n      // Build table HTML\n      let html = '<table class=\"review-table\">';\n      html += '<thead><tr>';\n      html += '<th>Case ID</th>';\n      html += '<th>Status</th>';\n      html += '<th>Current</th>';\n      html += '<th>AI Suggested</th>';\n      html += '<th>Final Decision</th>';\n      html += '</tr></thead>';\n      html += '<tbody>';\n\n      categorizationData.forEach(function(result) {\n        const statusClass = 'status-' + result.status;\n\n        html += '<tr>';\n        html += '<td>' + result.caseID + '</td>';\n        html += '<td><span class=\"status-badge ' + statusClass + '\">' + result.status + '</span></td>';\n        html += '<td class=\"category-current\">' + result.currentSymptom + ' / ' + result.currentSystem + '</td>';\n        html += '<td class=\"category-suggested\">' + result.suggestedSymptom + ' / ' + result.suggestedSystem + '</td>';\n        html += '<td>';\n        html += '  <select class=\"mini-select\" data-case-id=\"' + result.legacyCaseID + '\" data-field=\"symptom\">';\n        html += '    <option value=\"' + result.suggestedSymptom + '\" selected>' + result.suggestedSymptom + '</option>';\n        if (result.currentSymptom) {\n          html += '  <option value=\"' + result.currentSymptom + '\">Keep: ' + result.currentSymptom + '</option>';\n        }\n        html += '  </select>';\n        html += '  <select class=\"mini-select\" data-case-id=\"' + result.legacyCaseID + '\" data-field=\"system\">';\n        html += '    <option value=\"' + result.suggestedSystem + '\" selected>' + result.suggestedSystem + '</option>';\n        if (result.currentSystem) {\n          html += '  <option value=\"' + result.currentSystem + '\">Keep: ' + result.currentSystem + '</option>';\n        }\n        html += '  </select>';\n        html += '</td>';\n        html += '</tr>';\n      });\n\n      html += '</tbody></table>';\n\n      document.getElementById('review-results').innerHTML = html;\n    }\n\n    function handleReviewDataError(error) {\n      document.getElementById('review-results').innerHTML = '<p class=\"warning\">‚ùå Error loading results: ' + error.message + '</p>';\n    }\n\n    function updateStats(stats) {\n      document.getElementById('stat-new').textContent = stats.new;\n      document.getElementById('stat-matches').textContent = stats.matches;\n      document.getElementById('stat-conflicts').textContent = stats.conflicts;\n      document.getElementById('stat-errors').textContent = stats.errors;\n    }\n\n    /**\n     * Filter results by status\n     */\n    function filterResults() {\n      currentFilter = document.getElementById('filter-status').value;\n      refreshReviewData();\n    }\n\n    /**\n     * Apply categorizations to Master Scenario Convert\n     */\n    function applyCategorizations() {\n      if (!confirm('Apply all final categorizations to Master Scenario Convert?\\\\n\\\\nThis will update 4 columns for each case:\\\\n- Category_Symptom (Column X)\\\\n- Category_System (Column Y)\\\\n- Category_Symptom_Name (Column 16)\\\\n- Category_System_Name (Column 17)\\\\n\\\\nA backup will be created before updating.')) {\n        return;\n      }\n\n      const btn = document.getElementById('apply-btn');\n      btn.disabled = true;\n      btn.textContent = '‚è≥ Applying categorizations...';\n\n      google.script.run\n        .withSuccessHandler(handleApplyComplete)\n        .withFailureHandler(handleApplyError)\n        .applyCategorization('all');\n    }\n\n    function handleApplyComplete(result) {\n      const btn = document.getElementById('apply-btn');\n      btn.disabled = false;\n      btn.textContent = '‚úÖ Apply Selected Categories to Master';\n\n      if (result.success) {\n        alert('‚úÖ Categorization applied successfully!\\\\n\\\\n' +\n              'Cases updated: ' + result.updated + '\\\\n' +\n              'Errors: ' + result.errors + '\\\\n' +\n              'Backup: ' + result.backup);\n      } else {\n        alert('‚ùå Application cancelled or failed:\\\\n\\\\n' + result.message);\n      }\n    }\n\n    function handleApplyError(error) {\n      const btn = document.getElementById('apply-btn');\n      btn.disabled = false;\n      btn.textContent = '‚úÖ Apply Selected Categories to Master';\n\n      alert('‚ùå Error applying categorizations:\\\\n\\\\n' + error.message);\n    }\n\n    /**\n     * Export categorization results to CSV\n     */\n    function exportCategorizationResults() {\n      alert('Export to CSV feature coming soon!');\n    }\n\n    /**\n     * Open Category Mappings Editor\n     */\n    function editCategoryMappings() {\n      google.script.run\n        .withSuccessHandler(html => {\n          const div = document.createElement('div');\n          div.innerHTML = html;\n          document.body.appendChild(div);\n        })\n        .openCategoryMappingsEditor();\n    }\n\n    // ========================================================================\n    // AI DISCOVERY TAB FUNCTIONS (EXISTING)\n    // ========================================================================\n\n    function handleLogicTypeChange() {\n      const value = document.getElementById('logic-type-selector').value;\n\n      if (value === 'CREATE_NEW') {\n        alert('Create New Logic Type feature coming soon!');\n        document.getElementById('logic-type-selector').value = '';\n        document.getElementById('discover-btn').disabled = true;\n      } else if (value) {\n        document.getElementById('discover-btn').disabled = false;\n      } else {\n        document.getElementById('discover-btn').disabled = true;\n      }\n    }\n\n    function discoverPathways() {\n      const logicTypeId = document.getElementById('logic-type-selector').value;\n\n      if (!logicTypeId || logicTypeId === 'CREATE_NEW') {\n        alert('Please select a logic type first');\n        return;\n      }\n\n      // Show loading\n      const btn = document.getElementById('discover-btn');\n      btn.disabled = true;\n      btn.textContent = 'üîÑ Discovering...';\n\n      // Hide previous results\n      document.getElementById('results-container').classList.remove('visible');\n\n      // Call server-side discovery function\n      google.script.run\n        .withSuccessHandler(handleDiscoveryResults)\n        .withFailureHandler(handleDiscoveryError)\n        .discoverPathwaysWithLogicType(logicTypeId);\n    }\n\n    function handleDiscoveryResults(result) {\n      const btn = document.getElementById('discover-btn');\n      btn.disabled = false;\n      btn.textContent = 'ü§ñ Discover Pathways';\n\n      if (!result.success) {\n        alert('Error: ' + result.error);\n        return;\n      }\n\n      // Build results HTML\n      let html = '<p style=\"margin-bottom: 12px;\"><strong>' + result.pathwaysCount + ' pathways discovered using \"' + result.logicType + '\"</strong></p>';\n\n      result.pathways.forEach(function(sp, idx) {\n        const p = sp.pathway;\n        const s = sp.scoring;\n        const tierClass = 'tier-' + s.tier.charAt(0).toLowerCase();\n\n        html += '<div class=\"pathway-card\">';\n        html += '<strong>' + (idx + 1) + '. ' + p.name + '</strong>';\n        html += '<span class=\"tier-badge ' + tierClass + '\">' + s.tier + '</span>';\n        html += '<div class=\"pathway-desc\">' + p.description + '</div>';\n        html += '<div class=\"pathway-persuasion\">\"' + s.persuasion.persuasion_narrative + '\"</div>';\n        html += '<div class=\"pathway-meta\">üìä Score: ' + s.composite_score + '/10 | üìö ' + p.caseIds.length + ' cases | üéØ ' + p.targetLearner + '</div>';\n        html += '</div>';\n      });\n\n      document.getElementById('results-content').innerHTML = html;\n      document.getElementById('results-container').classList.add('visible');\n\n      // Success message\n      alert('‚úÖ Discovery complete! ' + result.pathwaysCount + ' pathways saved to Pathways_Master sheet.');\n    }\n\n    function handleDiscoveryError(error) {\n      const btn = document.getElementById('discover-btn');\n      btn.disabled = false;\n      btn.textContent = 'ü§ñ Discover Pathways';\n\n      alert('Error during discovery: ' + error.message);\n    }\n\n    function viewLogicTypeLibrary() {\n      google.script.run\n        .withSuccessHandler(function() {\n          alert('Logic Type Library is now active');\n        })\n        .manageLogicTypes();\n    }\n\n    function viewPathwaysMaster() {\n      google.script.run\n        .withSuccessHandler(function() {\n          alert('Pathways_Master sheet is now active');\n        })\n        .viewAllPathways();\n    }\n\n    // ========================================================================\n    // AUTO-SHOW AI REVIEW IF RESULTS EXIST\n    // ========================================================================\n\n    // Check if AI results exist on load\n    if (${categorizationStats.total} > 0) {\n      document.getElementById('ai-review-container').classList.add('visible');\n    }\n  </script>\n</body>\n</html>\n  `;\n}\n\n\n/**\n * Open Category Mappings Editor (NEW)\n * Allows user to edit symptom/system definitions\n */\nfunction openCategoryMappingsEditor() {\n  const ui = getSafeUi_();\n  if (!ui) return;\n\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const mappingSheet = ss.getSheetByName('accronym_symptom_system_mapping');\n\n  if (!mappingSheet) {\n    ui.alert('Error', 'Mapping sheet not found: accronym_symptom_system_mapping', ui.ButtonSet.OK);\n    return;\n  }\n\n  // Get current mappings\n  const data = mappingSheet.getDataRange().getValues();\n  const headers = data[0];\n\n  let mappingRows = '';\n  for (let i = 1; i < data.length; i++) {\n    const row = data[i];\n    mappingRows += `\n      <tr>\n        <td><input type=\"text\" value=\"${row[0]}\" data-col=\"0\" data-row=\"${i}\" /></td>\n        <td><input type=\"text\" value=\"${row[1]}\" data-col=\"1\" data-row=\"${i}\" /></td>\n        <td><input type=\"text\" value=\"${row[2]}\" data-col=\"2\" data-row=\"${i}\" /></td>\n        <td><input type=\"text\" value=\"${row[3]}\" data-col=\"3\" data-row=\"${i}\" /></td>\n        <td><button onclick=\"deleteRow(${i})\">üóëÔ∏è</button></td>\n      </tr>\n    `;\n  }\n\n  const html = HtmlService.createHtmlOutput(`\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <style>\n        body { font-family: Arial, sans-serif; padding: 20px; }\n        h2 { color: #2c3e50; }\n        table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n        th, td { padding: 10px; border: 1px solid #dfe3e8; text-align: left; }\n        th { background: #2a3040; color: #e7eaf0; }\n        input { width: 100%; padding: 6px; border: 1px solid #d1d7de; border-radius: 3px; }\n        button { padding: 8px 16px; background: #3b7ddd; color: #fff; border: none; border-radius: 4px; cursor: pointer; }\n        button:hover { background: #2d6bc6; }\n        .btn-danger { background: #dc3545; }\n        .btn-danger:hover { background: #c82333; }\n        .btn-success { background: #28a745; }\n        .btn-success:hover { background: #218838; }\n      </style>\n    </head>\n    <body>\n      <h2>‚öôÔ∏è Edit Category Mappings</h2>\n      <p>Manage symptom accronyms and system categories used for AI categorization.</p>\n\n      <table id=\"mappings-table\">\n        <thead>\n          <tr>\n            <th>Accronym</th>\n            <th>Symptom (Pre-Category)</th>\n            <th>System (Post-Category)</th>\n            <th>Alt System</th>\n            <th>Actions</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${mappingRows}\n        </tbody>\n      </table>\n\n      <button onclick=\"addNewRow()\" style=\"margin-top: 16px;\">‚ûï Add New Mapping</button>\n      <button onclick=\"saveMappings()\" class=\"btn-success\" style=\"margin-top: 16px;\">üíæ Save All Changes</button>\n\n      <script>\n        function addNewRow() {\n          const tbody = document.querySelector('#mappings-table tbody');\n          const rowCount = tbody.querySelectorAll('tr').length + 1;\n\n          const newRow = document.createElement('tr');\n          newRow.innerHTML = \\`\n            <td><input type=\"text\" value=\"\" data-col=\"0\" data-row=\"\\${rowCount}\" /></td>\n            <td><input type=\"text\" value=\"\" data-col=\"1\" data-row=\"\\${rowCount}\" /></td>\n            <td><input type=\"text\" value=\"\" data-col=\"2\" data-row=\"\\${rowCount}\" /></td>\n            <td><input type=\"text\" value=\"\" data-col=\"3\" data-row=\"\\${rowCount}\" /></td>\n            <td><button onclick=\"deleteRow(\\${rowCount})\">üóëÔ∏è</button></td>\n          \\`;\n          tbody.appendChild(newRow);\n        }\n\n        function deleteRow(rowNum) {\n          if (confirm('Delete this mapping?')) {\n            const row = document.querySelector(\\`input[data-row=\"\\${rowNum}\"]\\`).closest('tr');\n            row.remove();\n          }\n        }\n\n        function saveMappings() {\n          const rows = [];\n          const tbody = document.querySelector('#mappings-table tbody');\n\n          tbody.querySelectorAll('tr').forEach(tr => {\n            const inputs = tr.querySelectorAll('input');\n            rows.push([\n              inputs[0].value,\n              inputs[1].value,\n              inputs[2].value,\n              inputs[3].value\n            ]);\n          });\n\n          google.script.run\n            .withSuccessHandler(() => {\n              alert('‚úÖ Mappings saved successfully!');\n              google.script.host.close();\n            })\n            .withFailureHandler(err => alert('‚ùå Error: ' + err.message))\n            .saveCategoryMappings(rows);\n        }\n      </script>\n    </body>\n    </html>\n  `).setWidth(800).setHeight(600);\n\n  ui.showModalDialog(html, '‚öôÔ∏è Category Mappings Editor');\n}\n\n/**\n * Save category mappings back to sheet\n */\nfunction saveCategoryMappings(rows) {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const mappingSheet = ss.getSheetByName('accronym_symptom_system_mapping');\n\n  if (!mappingSheet) {\n    throw new Error('Mapping sheet not found');\n  }\n\n  // Clear existing data (except headers)\n  const lastRow = mappingSheet.getLastRow();\n  if (lastRow > 1) {\n    mappingSheet.getRange(2, 1, lastRow - 1, 4).clear();\n  }\n\n  // Write new data\n  if (rows.length > 0) {\n    mappingSheet.getRange(2, 1, rows.length, 4).setValues(rows);\n  }\n\n  Logger.log('‚úÖ Saved ' + rows.length + ' category mappings');\n}\n",
      "lastModifyUser": {
        "domain": "ersimulator.com",
        "email": "support@ersimulator.com",
        "name": "Aaron Tjomsland",
        "photoUrl": "https://lh3.googleusercontent.com/a-/ALV-UjWqjAHY15ugT_65GCYyIOdya8IsaYpRoXhg8zPNCFOZli7OIZef57v0vfPVHgdIc17nrKQX8RvFMotOWdiAJBi2Z8EvBsAdh5GHMLT6VwUDxulPbACn039MZEDMjGvEQ6Ps2GbhAuuwKxgy_KN_q1Rq9upQd2UNjYnz_Uspr2GepdVdVNsljJ-DDAv-42pz7IOGDYkiIg-J7reiSUsTtGi6L1Gc_plMbGLqao0qberaqBqQ2uV20xfvaHILx12hTMouOqHUdF_kv3I9T7Tz95zpYo1S4_vLbnngaUlYehv_FW2UnkUXww7-cWmsr2DLJdfjSUT_R0Vwb7WnzCdrEc7I6QY3OePHi_nk2TKc2e722qLboOGKpBc-8NvjS2mi20-NvCF-QwQvZrAJWpnx9nvkNCV3ovYvGCwvCnWaGHfV_GILlkHFY63s2LzwAF7kuIISeoxuuKxjfpLesHXRNhKHQlYv3Ecpwl9VyNoL6VxA17hJE83iwlgPSrbAnfVBYBS3DDmkWNqeTj5yooNm41Gix9m1iSuWhqS1xbU9NVlxEnjfX_9XUYD1yYvm-mpJqTWDQSuJo4ffmLVtbrarNe5mxR-xUBwD7kbbiDxlZ5BfcGUV-2DD3RSzNDbgxZbU-8I93D28EpIPbXvoWrKgqvz8JxqWScrhMN9kyuU_SgxH-rVrD6jn_EeTiQYXwGxbCNzcW7S2wxI8Y_uv1EHwio6lAIetzZbAmTTUyxwBF1mlQP-lPUHpvKRAs-wUz7pw5DI8uSCu-8GZCz3xa0fqevlMghcm-YUOzMW4c8vLf3wGNQoLpyvIVHmByXymbGJ1-trNCuQTYtzs3PHmME3i8s-Ogll54Nprg0QGNiGaFKOmnmc1zoniPZa_QNABkOOQivGdwuhPO4b2q685m0uwxv1sJ7pC8vB8SQXWqIW9maHvOVauNsAldadssZpGGCwGfjwPkJvjGY8RF1JqRAKI6ImFB9OwPHJ47Mfy5JHpBvXZcL75LpxdHTXlyjMMosuw_E23Og_NMvk0kKoY4J1ydWt3Jkpdf1I-PmcdoApGnAGaNnL7WyEbcYM=h128"
      },
      "createTime": "2025-11-09T02:35:04.554Z",
      "updateTime": "2025-11-11T04:42:39.376Z",
      "functionSet": {
        "values": [
          {
            "name": "openCategoriesPathwaysPanel"
          },
          {
            "name": "buildCategoriesPathwaysMainMenu_"
          },
          {
            "name": "openCategoryMappingsEditor"
          },
          {
            "name": "saveCategoryMappings",
            "parameters": [
              "rows"
            ]
          }
        ]
      }
    },
    {
      "name": "Phase2_Modal_Integration",
      "type": "SERVER_JS",
      "source": "/**\n * PHASE 2: MODAL INTEGRATION\n *\n * Adds AI Discovery tab to existing Pathway Chain Builder modal\n * This file contains the AI Discovery tab HTML builder\n */\n\n/**\n * Build AI Discovery tab HTML for Pathway Chain Builder modal\n */\n",
      "lastModifyUser": {
        "domain": "ersimulator.com",
        "email": "support@ersimulator.com",
        "name": "Aaron Tjomsland",
        "photoUrl": "https://lh3.googleusercontent.com/a-/ALV-UjWqjAHY15ugT_65GCYyIOdya8IsaYpRoXhg8zPNCFOZli7OIZef57v0vfPVHgdIc17nrKQX8RvFMotOWdiAJBi2Z8EvBsAdh5GHMLT6VwUDxulPbACn039MZEDMjGvEQ6Ps2GbhAuuwKxgy_KN_q1Rq9upQd2UNjYnz_Uspr2GepdVdVNsljJ-DDAv-42pz7IOGDYkiIg-J7reiSUsTtGi6L1Gc_plMbGLqao0qberaqBqQ2uV20xfvaHILx12hTMouOqHUdF_kv3I9T7Tz95zpYo1S4_vLbnngaUlYehv_FW2UnkUXww7-cWmsr2DLJdfjSUT_R0Vwb7WnzCdrEc7I6QY3OePHi_nk2TKc2e722qLboOGKpBc-8NvjS2mi20-NvCF-QwQvZrAJWpnx9nvkNCV3ovYvGCwvCnWaGHfV_GILlkHFY63s2LzwAF7kuIISeoxuuKxjfpLesHXRNhKHQlYv3Ecpwl9VyNoL6VxA17hJE83iwlgPSrbAnfVBYBS3DDmkWNqeTj5yooNm41Gix9m1iSuWhqS1xbU9NVlxEnjfX_9XUYD1yYvm-mpJqTWDQSuJo4ffmLVtbrarNe5mxR-xUBwD7kbbiDxlZ5BfcGUV-2DD3RSzNDbgxZbU-8I93D28EpIPbXvoWrKgqvz8JxqWScrhMN9kyuU_SgxH-rVrD6jn_EeTiQYXwGxbCNzcW7S2wxI8Y_uv1EHwio6lAIetzZbAmTTUyxwBF1mlQP-lPUHpvKRAs-wUz7pw5DI8uSCu-8GZCz3xa0fqevlMghcm-YUOzMW4c8vLf3wGNQoLpyvIVHmByXymbGJ1-trNCuQTYtzs3PHmME3i8s-Ogll54Nprg0QGNiGaFKOmnmc1zoniPZa_QNABkOOQivGdwuhPO4b2q685m0uwxv1sJ7pC8vB8SQXWqIW9maHvOVauNsAldadssZpGGCwGfjwPkJvjGY8RF1JqRAKI6ImFB9OwPHJ47Mfy5JHpBvXZcL75LpxdHTXlyjMMosuw_E23Og_NMvk0kKoY4J1ydWt3Jkpdf1I-PmcdoApGnAGaNnL7WyEbcYM=h128"
      },
      "createTime": "2025-11-09T02:57:55.741Z",
      "updateTime": "2025-11-11T04:42:39.376Z",
      "functionSet": {}
    },
    {
      "name": "Enhanced_Visual_Panel_With_Toggle",
      "type": "SERVER_JS",
      "source": "/**\n * ENHANCED VISUAL PANEL WITH SYMPTOM/SYSTEM TOGGLE\n *\n * Adds toggle between:\n * - Symptom-based organization (CP, SOB, ABD, etc.)\n * - System-based organization (Cardiovascular, Pulmonary, etc.)\n */\n\n/**\n * Get category counts for both Symptom and System views\n */\nfunction getCategoryCounts() {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const masterSheet = ss.getSheetByName('Master Scenario Convert');\n\n  if (!masterSheet) {\n    return { symptoms: {}, systems: {}, total: 0 };\n  }\n\n  const data = masterSheet.getDataRange().getValues();\n  const headers = data[1]; // Row 2 (Tier 2 headers)\n\n  // Find the category columns\n  const symptomIdx = headers.indexOf('Case_Organization_Category_Symptom');\n  const systemIdx = headers.indexOf('Case_Organization_Category_System');\n\n  if (symptomIdx === -1 || systemIdx === -1) {\n    Logger.log('‚ö†Ô∏è Category columns not found');\n    return { symptoms: {}, systems: {}, total: 0 };\n  }\n\n  const symptomCounts = {};\n  const systemCounts = {};\n\n  // Start from row 3 (skip 2 header rows)\n  for (let i = 2; i < data.length; i++) {\n    const symptom = data[i][symptomIdx] || 'Uncategorized';\n    const system = data[i][systemIdx] || 'Uncategorized';\n\n    symptomCounts[symptom] = (symptomCounts[symptom] || 0) + 1;\n    systemCounts[system] = (systemCounts[system] || 0) + 1;\n  }\n\n  return {\n    symptoms: symptomCounts,\n    systems: systemCounts,\n    total: data.length - 2\n  };\n}\n\n/**\n * Build enhanced Categories tab with Symptom/System toggle\n */\nfunction buildEnhancedCategoriesTab() {\n  const counts = getCategoryCounts();\n\n  // Build Symptom cards (sorted by count)\n  const symptomCards = Object.entries(counts.symptoms)\n    .sort((a, b) => b[1] - a[1])\n    .map(([symptom, count]) => {\n      const icon = symptom === 'Uncategorized' ? '‚ùì' : getSymptomIcon(symptom);\n\n      return `\n        <div class=\"category-card\" onclick=\"viewSymptomCategory('${symptom.replace(/'/g, \"\\\\'\")}')\">\n          <div class=\"category-icon\">${icon}</div>\n          <div class=\"category-name\">${symptom}</div>\n          <div class=\"category-count\">${count} cases</div>\n        </div>\n      `;\n    }).join('');\n\n  // Build System cards (sorted by count)\n  const systemCards = Object.entries(counts.systems)\n    .sort((a, b) => b[1] - a[1])\n    .map(([system, count]) => {\n      const icon = system === 'Uncategorized' ? '‚ùì' : getSystemIcon(system);\n\n      return `\n        <div class=\"category-card\" onclick=\"viewSystemCategory('${system.replace(/'/g, \"\\\\'\")}')\">\n          <div class=\"category-icon\">${icon}</div>\n          <div class=\"category-name\">${system}</div>\n          <div class=\"category-count\">${count} cases</div>\n        </div>\n      `;\n    }).join('');\n\n  return `\n    <style>\n      .toggle-container {\n        display: flex;\n        gap: 8px;\n        margin: 16px;\n        background: #2a3040;\n        padding: 4px;\n        border-radius: 8px;\n      }\n\n      .toggle-btn {\n        flex: 1;\n        padding: 10px 16px;\n        background: transparent;\n        border: none;\n        color: #8b92a0;\n        font-size: 13px;\n        font-weight: 600;\n        border-radius: 6px;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n\n      .toggle-btn.active {\n        background: #667eea;\n        color: #fff;\n      }\n\n      .toggle-btn:hover:not(.active) {\n        background: rgba(255,255,255,0.05);\n      }\n\n      .view-container {\n        display: none;\n      }\n\n      .view-container.active {\n        display: block;\n      }\n\n      .category-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));\n        gap: 12px;\n        padding: 16px;\n      }\n\n      .category-card {\n        background: linear-gradient(135deg, #2a3040 0%, #1f2633 100%);\n        border: 1px solid #3a4050;\n        border-radius: 8px;\n        padding: 16px;\n        text-align: center;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n\n      .category-card:hover {\n        transform: translateY(-2px);\n        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);\n        border-color: #667eea;\n      }\n\n      .category-icon {\n        font-size: 32px;\n        margin-bottom: 8px;\n      }\n\n      .category-name {\n        font-size: 13px;\n        font-weight: 600;\n        color: #e7eaf0;\n        margin-bottom: 4px;\n      }\n\n      .category-count {\n        font-size: 11px;\n        color: #8b92a0;\n      }\n\n      .section {\n        margin: 0;\n      }\n\n      .section-title {\n        padding: 16px;\n        font-size: 14px;\n        font-weight: 600;\n        color: #e7eaf0;\n        border-bottom: 1px solid #3a4050;\n      }\n\n      .ai-tools-banner {\n        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n        margin: 16px;\n        padding: 16px;\n        border-radius: 8px;\n        box-shadow: 0 4px 6px rgba(0,0,0,0.3);\n      }\n\n      .ai-tools-header {\n        display: flex;\n        align-items: center;\n        gap: 12px;\n        margin-bottom: 12px;\n      }\n\n      .ai-tools-icon {\n        font-size: 32px;\n      }\n\n      .ai-tools-title {\n        font-size: 15px;\n        font-weight: 700;\n        color: #fff;\n        margin-bottom: 4px;\n      }\n\n      .ai-tools-desc {\n        font-size: 12px;\n        color: rgba(255,255,255,0.9);\n      }\n\n      .ai-tools-btn {\n        width: 100%;\n        background: rgba(255,255,255,0.2);\n        border: 2px solid rgba(255,255,255,0.3);\n        color: #fff;\n        padding: 12px;\n        border-radius: 6px;\n        font-size: 14px;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.2s;\n      }\n\n      .ai-tools-btn:hover {\n        background: rgba(255,255,255,0.3);\n        transform: translateY(-1px);\n      }\n    </style>\n\n    <!-- AI Tools Banner -->\n    <div class=\"ai-tools-banner\">\n      <div class=\"ai-tools-header\">\n        <span class=\"ai-tools-icon\">ü§ñ</span>\n        <div style=\"flex: 1;\">\n          <div class=\"ai-tools-title\">AI-Powered Categorization Tools</div>\n          <div class=\"ai-tools-desc\">Auto-categorize all ${counts.total} cases with GPT-4 + Review interface</div>\n        </div>\n      </div>\n      <button class=\"ai-tools-btn\" onclick=\"openAITools()\">\n        ‚ú® Open AI Categorization Tools\n      </button>\n    </div>\n\n    <!-- Toggle between Symptom/System views -->\n    <div class=\"toggle-container\">\n      <button class=\"toggle-btn active\" id=\"symptom-toggle\" onclick=\"switchView('symptom')\">\n        üíä Symptom Categories\n      </button>\n      <button class=\"toggle-btn\" id=\"system-toggle\" onclick=\"switchView('system')\">\n        üè• System Categories\n      </button>\n    </div>\n\n    <!-- Symptom View -->\n    <div class=\"view-container active\" id=\"symptom-view\">\n      <div class=\"section\">\n        <div class=\"section-title\">üìÅ Symptom-Based Organization</div>\n        <div class=\"category-grid\">${symptomCards || '<p style=\"text-align:center; padding:20px; color:#8b92a0;\">No symptom categories found. Run AI Categorization first.</p>'}</div>\n      </div>\n    </div>\n\n    <!-- System View -->\n    <div class=\"view-container\" id=\"system-view\">\n      <div class=\"section\">\n        <div class=\"section-title\">üìÅ System-Based Organization</div>\n        <div class=\"category-grid\">${systemCards || '<p style=\"text-align:center; padding:20px; color:#8b92a0;\">No system categories found. Run AI Categorization first.</p>'}</div>\n      </div>\n    </div>\n\n    <script>\n      function switchView(view) {\n        // Update toggle buttons\n        document.getElementById('symptom-toggle').classList.remove('active');\n        document.getElementById('system-toggle').classList.remove('active');\n\n        if (view === 'symptom') {\n          document.getElementById('symptom-toggle').classList.add('active');\n        } else {\n          document.getElementById('system-toggle').classList.add('active');\n        }\n\n        // Update view containers\n        document.getElementById('symptom-view').classList.remove('active');\n        document.getElementById('system-view').classList.remove('active');\n\n        if (view === 'symptom') {\n          document.getElementById('symptom-view').classList.add('active');\n        } else {\n          document.getElementById('system-view').classList.add('active');\n        }\n      }\n\n      function viewSymptomCategory(symptom) {\n        alert('Viewing ' + symptom + ' cases\\\\n\\\\nThis will open a detailed view of all cases with this symptom.\\\\n\\\\n(Feature coming soon!)');\n      }\n\n      function viewSystemCategory(system) {\n        alert('Viewing ' + system + ' cases\\\\n\\\\nThis will open a detailed view of all cases in this system.\\\\n\\\\n(Feature coming soon!)');\n      }\n\n      function openAITools() {\n        console.log('üîß Opening AI Categorization Tools...');\n        google.script.run\n          .withSuccessHandler(() => {\n            console.log('‚úÖ Panel opened successfully');\n            // Current sidebar will be replaced\n          })\n          .withFailureHandler((error) => {\n            console.error('‚ùå Failed to open panel:', error);\n            alert('Error opening AI Tools: ' + error.message);\n          })\n          .openCategoriesPathwaysPanel();\n      }\n    </script>\n  `;\n}\n\n/**\n * Get icon for symptom category\n */\nfunction getSymptomIcon(symptom) {\n  const icons = {\n    'CP': 'üíî',\n    'SOB': 'ü´Å',\n    'ABD': 'ü§∞',\n    'AMS': 'üß†',\n    'SYNCOPE': 'üòµ',\n    'TRAUMA': 'ü©π',\n    'OB': 'üë∂',\n    'NEURO': 'üß†',\n    'PSYCH': 'üßò',\n    'FEVER': 'üå°Ô∏è',\n    'WEAKNESS': 'üí™',\n    'DIZZY': 'üòµ‚Äçüí´',\n    'HEADACHE': 'ü§ï',\n    'Uncategorized': '‚ùì'\n  };\n\n  return icons[symptom] || 'üìã';\n}\n\n/**\n * Get icon for system category\n */\nfunction getSystemIcon(system) {\n  const icons = {\n    'Cardiovascular': '‚ù§Ô∏è',\n    'Pulmonary': 'ü´Å',\n    'Gastrointestinal': 'üçΩÔ∏è',\n    'Neurologic': 'üß†',\n    'Endocrine/Metabolic': '‚ö°',\n    'Renal/Genitourinary': 'üíß',\n    'Hematologic/Oncologic': 'ü©∏',\n    'Infectious Disease': 'ü¶†',\n    'Toxicology': '‚ò†Ô∏è',\n    'Trauma': 'üöë',\n    'Obstetrics/Gynecology': 'üë∂',\n    'Pediatrics': 'üë∂',\n    'HEENT': 'üëÅÔ∏è',\n    'Musculoskeletal': 'ü¶¥',\n    'Critical Care': 'üè•',\n    'Dermatologic': 'üß¥',\n    'Psychiatric': 'üßò',\n    'Environmental': 'üå°Ô∏è',\n    'Uncategorized': '‚ùì'\n  };\n\n  return icons[system] || 'üè•';\n}\n",
      "lastModifyUser": {
        "domain": "ersimulator.com",
        "email": "support@ersimulator.com",
        "name": "Aaron Tjomsland",
        "photoUrl": "https://lh3.googleusercontent.com/a-/ALV-UjWqjAHY15ugT_65GCYyIOdya8IsaYpRoXhg8zPNCFOZli7OIZef57v0vfPVHgdIc17nrKQX8RvFMotOWdiAJBi2Z8EvBsAdh5GHMLT6VwUDxulPbACn039MZEDMjGvEQ6Ps2GbhAuuwKxgy_KN_q1Rq9upQd2UNjYnz_Uspr2GepdVdVNsljJ-DDAv-42pz7IOGDYkiIg-J7reiSUsTtGi6L1Gc_plMbGLqao0qberaqBqQ2uV20xfvaHILx12hTMouOqHUdF_kv3I9T7Tz95zpYo1S4_vLbnngaUlYehv_FW2UnkUXww7-cWmsr2DLJdfjSUT_R0Vwb7WnzCdrEc7I6QY3OePHi_nk2TKc2e722qLboOGKpBc-8NvjS2mi20-NvCF-QwQvZrAJWpnx9nvkNCV3ovYvGCwvCnWaGHfV_GILlkHFY63s2LzwAF7kuIISeoxuuKxjfpLesHXRNhKHQlYv3Ecpwl9VyNoL6VxA17hJE83iwlgPSrbAnfVBYBS3DDmkWNqeTj5yooNm41Gix9m1iSuWhqS1xbU9NVlxEnjfX_9XUYD1yYvm-mpJqTWDQSuJo4ffmLVtbrarNe5mxR-xUBwD7kbbiDxlZ5BfcGUV-2DD3RSzNDbgxZbU-8I93D28EpIPbXvoWrKgqvz8JxqWScrhMN9kyuU_SgxH-rVrD6jn_EeTiQYXwGxbCNzcW7S2wxI8Y_uv1EHwio6lAIetzZbAmTTUyxwBF1mlQP-lPUHpvKRAs-wUz7pw5DI8uSCu-8GZCz3xa0fqevlMghcm-YUOzMW4c8vLf3wGNQoLpyvIVHmByXymbGJ1-trNCuQTYtzs3PHmME3i8s-Ogll54Nprg0QGNiGaFKOmnmc1zoniPZa_QNABkOOQivGdwuhPO4b2q685m0uwxv1sJ7pC8vB8SQXWqIW9maHvOVauNsAldadssZpGGCwGfjwPkJvjGY8RF1JqRAKI6ImFB9OwPHJ47Mfy5JHpBvXZcL75LpxdHTXlyjMMosuw_E23Og_NMvk0kKoY4J1ydWt3Jkpdf1I-PmcdoApGnAGaNnL7WyEbcYM=h128"
      },
      "createTime": "2025-11-10T20:54:50.848Z",
      "updateTime": "2025-11-11T04:42:39.376Z",
      "functionSet": {
        "values": [
          {
            "name": "getCategoryCounts"
          },
          {
            "name": "buildEnhancedCategoriesTab"
          },
          {
            "name": "getSymptomIcon",
            "parameters": [
              "symptom"
            ]
          },
          {
            "name": "getSystemIcon",
            "parameters": [
              "system"
            ]
          }
        ]
      }
    },
    {
      "name": "Phase2_Enhanced_Categories_With_AI",
      "type": "SERVER_JS",
      "source": "/**\n * PHASE 2: ENHANCED CATEGORIES & PATHWAYS PANEL (WITH AI CATEGORIZATION)\n *\n * Updated to include AI Auto-Categorization review interface\n */\n\n/**\n * Open Categories & Pathways Panel (with AI Discovery tab + AI Categorization)\n */\nfunction openCategoriesPathwaysPanel() {\n  const ui = getSafeUi_();\n  if (!ui) return;\n\n  const html = buildCategoriesPathwaysMainMenu_();\n  ui.showSidebar(HtmlService.createHtmlOutput(html).setTitle('üìÇ Categories & Pathways').setWidth(400));\n}\n\n/**\n * Build main menu with tabbed interface (including AI categorization)\n */\nfunction buildCategoriesPathwaysMainMenu_() {\n  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Master Scenario Convert');\n\n  if (!sheet) {\n    return '<p style=\"padding:20px;\">Error: Master Scenario Convert sheet not found</p>';\n  }\n\n  const data = sheet.getDataRange().getValues();\n\n  if (!data || data.length < 2) {\n    return '<p style=\"padding:20px;\">Error: Sheet has insufficient data (need at least 2 rows)</p>';\n  }\n\n  const headers = data[1]; // Row 2\n\n  if (!headers) {\n    return '<p style=\"padding:20px;\">Error: Header row (row 2) not found</p>';\n  }\n\n  // Get column indices\n  const categoryIdx = headers.indexOf('Case_Organization_Category_Symptom');\n  const pathwayIdx = headers.indexOf('Case_Organization:Pathway_Name');\n\n  // Count categories and pathways\n  const categoryCounts = {};\n  const pathwayCounts = {};\n\n  for (let i = 2; i < data.length; i++) {\n    const category = data[i][categoryIdx] || 'Uncategorized';\n    const pathway = data[i][pathwayIdx] || 'Unassigned';\n\n    categoryCounts[category] = (categoryCounts[category] || 0) + 1;\n    pathwayCounts[pathway] = (pathwayCounts[pathway] || 0) + 1;\n  }\n\n  const totalCases = data.length - 2;\n\n  // Build category list\n  const categoryList = Object.entries(categoryCounts)\n    .sort((a, b) => b[1] - a[1])\n    .map(([cat, count]) => `\n      <div class=\"list-item\" onclick=\"viewCategory('${cat.replace(/'/g, \"\\\\'\")}')\">\n        <span class=\"item-label\">${cat}</span>\n        <span class=\"item-count\">${count}</span>\n      </div>\n    `).join('');\n\n  // Build pathway list (top 10)\n  const pathwayList = Object.entries(pathwayCounts)\n    .sort((a, b) => b[1] - a[1])\n    .slice(0, 10)\n    .map(([path, count]) => `\n      <div class=\"list-item\" onclick=\"viewPathway('${path.replace(/'/g, \"\\\\'\")}')\">\n        <span class=\"item-label\">${path}</span>\n        <span class=\"item-count\">${count}</span>\n      </div>\n    `).join('');\n\n  // Get logic types for AI Discovery tab\n  const logicTypes = getLogicTypesForDropdown();\n  const logicTypeOptions = logicTypes.map(lt => {\n    const usageLabel = lt.timesUsed > 0 ? ` (${lt.timesUsed} uses)` : '';\n    return `<option value=\"${lt.id}\">${lt.name}${usageLabel}</option>`;\n  }).join('');\n\n  // Get categorization stats (if results exist)\n  const categorizationStats = getCategorizationStats();\n\n  return `\n<!DOCTYPE html>\n<html>\n<head>\n  <base target=\"_top\">\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n\n    body {\n      font-family: Arial, sans-serif;\n      background: #f5f7fa;\n      color: #2c3e50;\n      font-size: 13px;\n    }\n\n    /* Tab Navigation */\n    .tabs {\n      display: flex;\n      background: #fff;\n      border-bottom: 2px solid #dfe3e8;\n    }\n\n    .tab {\n      flex: 1;\n      padding: 12px 8px;\n      text-align: center;\n      cursor: pointer;\n      border-bottom: 3px solid transparent;\n      transition: all 0.2s;\n      font-size: 12px;\n      font-weight: 600;\n      color: #7f8c9d;\n    }\n\n    .tab:hover {\n      background: #f8f9fa;\n      color: #2c3e50;\n    }\n\n    .tab.active {\n      color: #3b7ddd;\n      border-bottom-color: #3b7ddd;\n      background: #f8f9fa;\n    }\n\n    .tab-content {\n      display: none;\n    }\n\n    .tab-content.active {\n      display: block;\n    }\n\n    .header {\n      background: #fff;\n      padding: 16px;\n      border-bottom: 1px solid #dfe3e8;\n    }\n\n    .header h1 {\n      font-size: 16px;\n      font-weight: 600;\n      color: #2c3e50;\n      margin-bottom: 4px;\n    }\n\n    .header .subtitle {\n      font-size: 12px;\n      color: #7f8c9d;\n    }\n\n    .stats {\n      background: #fff;\n      padding: 12px 16px;\n      border-bottom: 1px solid #dfe3e8;\n      display: flex;\n      justify-content: space-around;\n    }\n\n    .stat {\n      text-align: center;\n    }\n\n    .stat .num {\n      font-size: 20px;\n      font-weight: 700;\n      color: #3b7ddd;\n      display: block;\n    }\n\n    .stat .label {\n      font-size: 11px;\n      color: #7f8c9d;\n      text-transform: uppercase;\n    }\n\n    .section {\n      background: #fff;\n      margin: 12px;\n      padding: 14px;\n      border-radius: 6px;\n      border: 1px solid #dfe3e8;\n    }\n\n    .section-title {\n      font-size: 13px;\n      font-weight: 600;\n      color: #2c3e50;\n      margin-bottom: 10px;\n      padding-bottom: 8px;\n      border-bottom: 1px solid #f0f2f5;\n    }\n\n    .btn {\n      display: block;\n      width: 100%;\n      background: #fff;\n      border: 1px solid #d1d7de;\n      color: #2c3e50;\n      padding: 10px 12px;\n      margin-bottom: 8px;\n      border-radius: 4px;\n      cursor: pointer;\n      text-align: left;\n      font-size: 13px;\n      transition: all 0.2s;\n    }\n\n    .btn:hover {\n      background: #f5f7fa;\n      border-color: #3b7ddd;\n    }\n\n    .btn-primary {\n      background: #3b7ddd;\n      color: #fff;\n      border-color: #3b7ddd;\n      font-weight: 600;\n    }\n\n    .btn-primary:hover {\n      background: #2d6bc6;\n    }\n\n    .btn-success {\n      background: #28a745;\n      color: #fff;\n      border-color: #28a745;\n      font-weight: 600;\n    }\n\n    .btn-success:hover {\n      background: #218838;\n    }\n\n    .btn:disabled {\n      background: #d1d7de;\n      cursor: not-allowed;\n      opacity: 0.6;\n    }\n\n    .list-item {\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      padding: 8px 10px;\n      margin-bottom: 4px;\n      background: #f8f9fa;\n      border-radius: 4px;\n      cursor: pointer;\n      transition: all 0.2s;\n    }\n\n    .list-item:hover {\n      background: #e9ecef;\n    }\n\n    .item-label {\n      font-size: 13px;\n      color: #2c3e50;\n    }\n\n    .item-count {\n      font-size: 12px;\n      color: #7f8c9d;\n      background: #fff;\n      padding: 2px 8px;\n      border-radius: 10px;\n    }\n\n    .scrollable {\n      max-height: 200px;\n      overflow-y: auto;\n    }\n\n    .scrollable::-webkit-scrollbar {\n      width: 6px;\n    }\n\n    .scrollable::-webkit-scrollbar-track {\n      background: #f0f2f5;\n    }\n\n    .scrollable::-webkit-scrollbar-thumb {\n      background: #d1d7de;\n      border-radius: 3px;\n    }\n\n    .info {\n      background: #e8f4fd;\n      border: 1px solid #bee5eb;\n      padding: 10px 12px;\n      border-radius: 4px;\n      font-size: 12px;\n      color: #31708f;\n      margin-top: 12px;\n    }\n\n    .warning {\n      background: #fff3cd;\n      border: 1px solid #ffc107;\n      padding: 10px 12px;\n      border-radius: 4px;\n      font-size: 12px;\n      color: #856404;\n      margin-top: 12px;\n    }\n\n    /* AI Discovery Tab Specific Styles */\n    select {\n      width: 100%;\n      padding: 10px;\n      font-size: 13px;\n      border: 1px solid #d1d7de;\n      border-radius: 4px;\n      margin-bottom: 12px;\n      background: #fff;\n    }\n\n    select:focus {\n      outline: none;\n      border-color: #3b7ddd;\n    }\n\n    .help-text {\n      font-size: 11px;\n      color: #7f8c9d;\n      margin: -8px 0 12px 0;\n    }\n\n    .pathway-card {\n      margin-bottom: 12px;\n      padding: 12px;\n      background: #f8f9fa;\n      border-radius: 4px;\n      border-left: 4px solid #3b7ddd;\n    }\n\n    .pathway-card strong {\n      font-size: 13px;\n      color: #2c3e50;\n    }\n\n    .tier-badge {\n      display: inline-block;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 11px;\n      font-weight: 600;\n      margin-left: 8px;\n    }\n\n    .tier-s { background: #ffd700; color: #000; }\n    .tier-a { background: #c0c0c0; color: #000; }\n    .tier-b { background: #cd7f32; color: #fff; }\n    .tier-c { background: #e8eaed; color: #000; }\n    .tier-d { background: #f1f3f4; color: #5f6368; }\n\n    .pathway-desc {\n      margin: 8px 0;\n      font-size: 12px;\n      color: #5f6368;\n    }\n\n    .pathway-persuasion {\n      margin: 8px 0;\n      font-size: 12px;\n      color: #5f6368;\n      font-style: italic;\n      padding: 8px;\n      background: #fff;\n      border-radius: 4px;\n    }\n\n    .pathway-meta {\n      margin: 8px 0;\n      font-size: 11px;\n      color: #7f8c9d;\n    }\n\n    #results-container {\n      display: none;\n      margin-top: 12px;\n    }\n\n    #results-container.visible {\n      display: block;\n    }\n\n    /* AI Categorization Review Styles */\n    #ai-review-container {\n      display: none;\n    }\n\n    #ai-review-container.visible {\n      display: block;\n    }\n\n    .review-table {\n      width: 100%;\n      border-collapse: collapse;\n      font-size: 12px;\n      margin-top: 12px;\n    }\n\n    .review-table th {\n      background: #2a3040;\n      color: #e7eaf0;\n      padding: 8px;\n      text-align: left;\n      font-size: 11px;\n      text-transform: uppercase;\n    }\n\n    .review-table td {\n      padding: 8px;\n      border-bottom: 1px solid #dfe3e8;\n    }\n\n    .review-table tr:hover {\n      background: #f8f9fa;\n    }\n\n    .status-badge {\n      display: inline-block;\n      padding: 3px 8px;\n      border-radius: 4px;\n      font-size: 11px;\n      font-weight: 600;\n    }\n\n    .status-new { background: #e8f5e9; color: #2e7d32; }\n    .status-matches { background: #f1f8ff; color: #0366d6; }\n    .status-conflict { background: #fff3e0; color: #e65100; }\n    .status-error { background: #ffebee; color: #c62828; }\n\n    .category-current {\n      color: #ff9800;\n      font-weight: 600;\n    }\n\n    .category-suggested {\n      color: #4caf50;\n      font-weight: 600;\n    }\n\n    .mini-select {\n      width: 100%;\n      padding: 4px;\n      font-size: 11px;\n      border: 1px solid #d1d7de;\n      border-radius: 3px;\n    }\n\n    .btn-mini {\n      padding: 4px 8px;\n      font-size: 11px;\n      margin: 2px;\n    }\n\n    .filter-bar {\n      display: flex;\n      gap: 8px;\n      margin-bottom: 12px;\n      align-items: center;\n    }\n\n    .filter-bar select {\n      flex: 1;\n      margin: 0;\n    }\n\n    .stats-mini {\n      display: flex;\n      gap: 12px;\n      padding: 10px;\n      background: #f8f9fa;\n      border-radius: 4px;\n      margin-bottom: 12px;\n    }\n\n    .stats-mini .stat-mini {\n      flex: 1;\n      text-align: center;\n    }\n\n    .stats-mini .stat-mini .num {\n      display: block;\n      font-size: 18px;\n      font-weight: 700;\n      color: #2c3e50;\n    }\n\n    .stats-mini .stat-mini .label {\n      display: block;\n      font-size: 10px;\n      color: #7f8c9d;\n      text-transform: uppercase;\n    }\n  \n    .log-btn {\n      background: #1a1a1a;\n      color: #0f0;\n      border: 1px solid #0f0;\n      padding: 2px 8px;\n      margin-left: 4px;\n      border-radius: 4px;\n      cursor: pointer;\n      font-size: 11px;\n      transition: all 0.2s ease;\n    }\n    .log-btn:hover {\n      background: #0f0;\n      color: #000;\n    }\n    .log-btn.copy {\n      color: #58a6ff;\n      border-color: #58a6ff;\n    }\n    .log-btn.copy:hover {\n      background: #58a6ff;\n      color: #000;\n    }\n    .log-btn.danger {\n      color: #f55;\n      border-color: #f55;\n    }\n    .log-btn.danger:hover {\n      background: #f55;\n      color: #000;\n    }\n    .log-output {\n      background: #000;\n      color: #0f0;\n      font-family: 'Courier New', monospace;\n      font-size: 11px;\n      padding: 8px;\n      border-radius: 4px;\n      max-height: 300px;\n      overflow-y: auto;\n      white-space: pre-wrap;\n      word-wrap: break-word;\n      border: 1px solid #0f0;\n      line-height: 1.4;\n    }\n  </style>\n</head>\n<body>\n  <!-- Tab Navigation -->\n  <div class=\"tabs\">\n    <div class=\"tab active\" onclick=\"switchTab('categories')\">üìä Categories</div>\n    <div class=\"tab\" onclick=\"switchTab('discovery')\">üîç AI Discovery</div>\n  </div>\n\n  <!-- Tab 1: Categories (Enhanced with AI Categorization) -->\n  <div id=\"categories-tab\" class=\"tab-content active\">\n    <div class=\"header\">\n      <h1>üìÇ Categories & Pathways</h1>\n      <div class=\"subtitle\">AI-powered categorization + manual organization</div>\n    </div>\n\n    <div class=\"stats\">\n      <div class=\"stat\">\n        <span class=\"num\">${totalCases}</span>\n        <span class=\"label\">Cases</span>\n      </div>\n      <div class=\"stat\">\n        <span class=\"num\">${Object.keys(categoryCounts).length}</span>\n        <span class=\"label\">Categories</span>\n      </div>\n      <div class=\"stat\">\n        <span class=\"num\">${Object.keys(pathwayCounts).length}</span>\n        <span class=\"label\">Pathways</span>\n      </div>\n    </div>\n\n    <!-- AI Categorization Section -->\n    <div class=\"section\">\n      <div class=\"section-title\">ü§ñ AI Auto-Categorization</div>\n      <button id=\"run-ai-btn\" class=\"btn btn-success\" onclick=\"runAICategorization()\">\n        üöÄ Run AI Categorization (All 207 Cases)\n      </button>\n      <button id=\"retry-failed-btn\" class=\"btn btn-warning\" onclick=\"retryFailedCases()\" style=\"background: #ff9800;\">\n        üîÑ Retry Failed Cases\n      </button>\n      <button class=\"btn btn-danger\" onclick=\"clearAIResults()\">\n        üóëÔ∏è Clear Results\n      </button>\n      <button class=\"btn\" onclick=\"editCategoryMappings()\">\n        ‚öôÔ∏è Edit Category Mappings (Symptoms & Systems)\n      </button>\n      \n    <!-- ü™µ Live AI Processing Logs Panel -->\n    <div id=\"ai-logs-panel\" class=\"section\" style=\" margin-top: 12px;\">\n      <div class=\"section-title\" style=\"display: flex; justify-content: space-between; align-items: center;\">\n        <span>ü™µ Live Retry Logs</span>\n        <div>\n          <button id=\"copyAILogsBtn\" class=\"log-btn copy\" onclick=\"copyAILogs()\">Copy Logs</button>\n          <button id=\"refreshAILogsBtn\" class=\"log-btn\" onclick=\"refreshAILogs()\">Refresh</button>\n          <button id=\"clearAILogsBtn\" class=\"log-btn danger\" onclick=\"clearAILogs()\">Clear</button>\n        </div>\n      </div>\n      <pre id=\"aiLogOutput\" class=\"log-output\">No logs yet. Click \"Run AI Categorization\" or \"Retry Failed Cases\" to start.</pre>\n    </div>\n      <div class=\"help-text\">\n        AI will analyze all cases and suggest Symptom + System categories.\n        Review and adjust before applying to Master Scenario Convert.\n      </div>\n    </div>\n\n    <!-- AI Review Container (shows after AI run) -->\n    <div id=\"ai-review-container\">\n      <div class=\"section\">\n        <div class=\"section-title\">üìã Review AI Suggestions</div>\n\n        <!-- Stats -->\n        <div class=\"stats-mini\">\n          <div class=\"stat-mini\">\n            <span class=\"num\" id=\"stat-new\">${categorizationStats.new}</span>\n            <span class=\"label\">New</span>\n          </div>\n          <div class=\"stat-mini\">\n            <span class=\"num\" id=\"stat-matches\">${categorizationStats.matches}</span>\n            <span class=\"label\">Matches</span>\n          </div>\n          <div class=\"stat-mini\">\n            <span class=\"num\" id=\"stat-conflicts\">${categorizationStats.conflicts}</span>\n            <span class=\"label\">Conflicts</span>\n          </div>\n          <div class=\"stat-mini\">\n            <span class=\"num\" id=\"stat-errors\">${categorizationStats.errors}</span>\n            <span class=\"label\">Errors</span>\n          </div>\n        </div>\n\n        <!-- Filter Bar -->\n        <div class=\"filter-bar\">\n          <select id=\"filter-status\" onchange=\"filterResults()\">\n            <option value=\"all\">All Cases</option>\n            <option value=\"new\">New (Uncategorized)</option>\n            <option value=\"matches\">Matches (AI Agrees)</option>\n            <option value=\"conflicts\">Conflicts (AI Disagrees)</option>\n            <option value=\"errors\">Errors</option>\n          </select>\n          <button class=\"btn btn-mini\" onclick=\"refreshReviewData()\">üîÑ Refresh</button>\n        </div>\n\n        <!-- Results Table (loaded via AJAX) -->\n        <div id=\"review-results\" class=\"scrollable\" style=\"max-height: 400px;\">\n          <p class=\"help-text\">Click \"Refresh\" to load AI categorization results</p>\n        </div>\n\n        <!-- Action Buttons -->\n        <button id=\"apply-btn\" class=\"btn btn-primary\" onclick=\"applyCategorizations()\" style=\"margin-top: 12px;\">\n          ‚úÖ Apply Selected Categories to Master\n        </button>\n        <button class=\"btn\" onclick=\"exportCategorizationResults()\">\n          üíæ Export Results to CSV\n        </button>\n      </div>\n    </div>\n\n    <!-- Manual Actions Section -->\n    <div class=\"section\">\n      <div class=\"section-title\">Manual Actions</div>\n      <button class=\"btn\" onclick=\"viewAllCategories()\">üìä View All Categories</button>\n      <button class=\"btn\" onclick=\"viewAllPathways()\">üß© View All Pathways</button>\n      <button class=\"btn\" onclick=\"assignCase()\">üîó Assign Case to Category/Pathway</button>\n    </div>\n\n    <!-- Category List -->\n    <div class=\"section\">\n      <div class=\"section-title\">Medical System Categories</div>\n      <div class=\"scrollable\">\n        ${categoryList || '<div class=\"info\">No categories found</div>'}\n      </div>\n    </div>\n\n    <!-- Pathway List -->\n    <div class=\"section\">\n      <div class=\"section-title\">Learning Pathways (Top 10)</div>\n      <div class=\"scrollable\">\n        ${pathwayList || '<div class=\"info\">No pathways found</div>'}\n      </div>\n    </div>\n  </div>\n\n  <!-- Tab 2: AI Discovery (Existing) -->\n  <div id=\"discovery-tab\" class=\"tab-content\">\n    <div class=\"header\">\n      <h1>üîç AI Pathway Discovery</h1>\n      <div class=\"subtitle\">Discover high-value learning pathways using AI</div>\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Discovery Lens (Logic Type)</div>\n      <select id=\"logic-type-selector\" onchange=\"handleLogicTypeChange()\">\n        <option value=\"\">-- Select Logic Type --</option>\n        ${logicTypeOptions}\n        <option value=\"\" disabled>‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ</option>\n        <option value=\"CREATE_NEW\">üé® Create New Logic Type...</option>\n      </select>\n      <div class=\"help-text\">Most frequently used logic types appear first</div>\n\n      <button id=\"discover-btn\" class=\"btn btn-primary\" onclick=\"discoverPathways()\" disabled>\n        ü§ñ Discover Pathways\n      </button>\n    </div>\n\n    <div id=\"results-container\">\n      <div class=\"section\">\n        <div class=\"section-title\">Discovery Results</div>\n        <div id=\"results-content\"></div>\n      </div>\n    </div>\n\n    <div class=\"section\">\n      <div class=\"section-title\">Manage Logic Types</div>\n      <button class=\"btn\" onclick=\"viewLogicTypeLibrary()\">üìö View Logic Type Library</button>\n      <button class=\"btn\" onclick=\"viewPathwaysMaster()\">üìä View All Discovered Pathways</button>\n    </div>\n  </div>\n\n  <script>\n    // Global state\n    let currentFilter = 'all';\n    let categorizationData = [];\n\n    // ========================================================================\n    // TAB SWITCHING\n    // ========================================================================\n\n    function switchTab(tabName) {\n      // Update tab buttons\n      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));\n      event.target.classList.add('active');\n\n      // Update tab content\n      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));\n      document.getElementById(tabName + '-tab').classList.add('active');\n    }\n\n    // ========================================================================\n    // CATEGORIES TAB - MANUAL ACTIONS (EXISTING)\n    // ========================================================================\n\n    function viewCategory(category) {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .getCategoryView(category);\n    }\n\n    function viewPathway(pathway) {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .getPathwayView(pathway);\n    }\n\n    function viewAllCategories() {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .getAllCategoriesView();\n    }\n\n    function viewAllPathways() {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .getAllPathwaysView();\n    }\n\n    function assignCase() {\n      google.script.run\n        .withSuccessHandler(html => document.body.innerHTML = html)\n        .getCaseAssignmentView();\n    }\n\n    // ========================================================================\n    // AI CATEGORIZATION FUNCTIONS (NEW)\n    // ========================================================================\n\n    /**\n     * Run AI Categorization on all 207 cases\n     */\n    function runAICategorization() {\n      const btn = document.getElementById('run-ai-btn');\n\n      if (!confirm('Run AI categorization on all 207 cases?\\\\n\\\\nThis will take 2-3 minutes and cost ~$0.20.\\\\n\\\\nResults will be saved to AI_Categorization_Results sheet for review.')) {\n        return;\n      }\n\n      btn.disabled = true;\n      btn.textContent = 'üîÑ Running AI Categorization...';\n      btn.style.background = '#ffc107';\n\n      google.script.run\n        .withSuccessHandler(handleAICategorizationComplete)\n        .withFailureHandler(handleAICategorizationError)\n        .runAICategorization();\n    }\n\n    function handleAICategorizationComplete(result) {\n      const btn = document.getElementById('run-ai-btn');\n      btn.disabled = false;\n      btn.textContent = '‚úÖ AI Categorization Complete';\n      btn.style.background = '#28a745';\n\n      alert('‚úÖ AI Categorization Complete!\\\\n\\\\n' +\n            'Total cases processed: ' + result.totalCases + '\\\\n' +\n            'Results saved to: ' + result.resultsSheetName + '\\\\n\\\\n' +\n            'Click \"Refresh\" below to review results.');\n\n      // Show review container\n      document.getElementById('ai-review-container').classList.add('visible');\n\n      // Auto-refresh review data\n      setTimeout(refreshReviewData, 500);\n    }\n\n    function handleAICategorizationError(error) {\n      const btn = document.getElementById('run-ai-btn');\n      btn.disabled = false;\n      btn.textContent = 'üöÄ Run AI Categorization (All 207 Cases)';\n      btn.style.background = '#28a745';\n\n      alert('‚ùå Error during AI categorization:\\\\n\\\\n' + error.message);\n    }\n\n    /**\n     * Clear AI Categorization Results sheet\n     */\n    function clearAIResults() {\n      if (!confirm('Clear all AI categorization results?\\\\n\\\\nThis will delete the AI_Categorization_Results sheet.\\\\n\\\\nThis action cannot be undone.')) {\n        return;\n      }\n\n      google.script.run\n        .withSuccessHandler(handleClearSuccess)\n        .withFailureHandler(handleClearError)\n        .clearAICategorizationResults();\n    }\n\n    function handleClearSuccess() {\n      alert('‚úÖ Results cleared successfully!\\\\n\\\\nThe AI_Categorization_Results sheet has been cleared.');\n\n      // Hide review container\n      document.getElementById('ai-review-container').classList.remove('visible');\n\n      // Clear review results display\n      document.getElementById('review-results').innerHTML = '<p class=\"info\">No results found. Run AI Categorization first.</p>';\n    }\n\n    function handleClearError(error) {\n      alert('‚ùå Error clearing results:\\\\n\\\\n' + error.message);\n    }\n\n    /**\n     * Retry AI categorization for ONLY failed cases\n     */\n    function retryFailedCases() {\n      const btn = document.getElementById('retry-failed-btn');\n\n      if (!confirm('Retry AI categorization for FAILED cases only?\\\\n\\\\nThis will re-process only the cases that had empty results due to JSON parsing errors.\\\\n\\\\nEstimated time: ~30 seconds for 25 cases.')) {\n        return;\n      }\n\n      btn.disabled = true;\n      btn.textContent = 'üîÑ Retrying Failed Cases...';\n\n      // Show log panel and start polling\n      startAILogPolling();\n      btn.style.background = '#ffc107';\n\n      google.script.run\n        .withSuccessHandler(handleRetryComplete)\n        .withFailureHandler(handleRetryError)\n        .retryFailedCategorization();\n    }\n\n    function handleRetryComplete(result) {\n      const btn = document.getElementById('retry-failed-btn');\n      btn.disabled = false;\n      btn.textContent = 'üîÑ Retry Failed Cases';\n\n      // Stop polling and do final refresh\n      stopAILogPolling();\n      setTimeout(refreshAILogs, 500);  // Final refresh after 500ms\n      btn.style.background = '#ff9800';\n\n      if (result.totalRetried === 0) {\n        alert('‚úÖ No failed cases found!\\\\n\\\\nAll cases have been successfully categorized.');\n      } else {\n        alert('‚úÖ Retry Complete!\\\\n\\\\n' +\n              'Cases retried: ' + result.totalRetried + '\\\\n' +\n              'Successfully fixed: ' + result.successCount + '\\\\n' +\n              'Still failed: ' + result.stillFailedCount + '\\\\n\\\\n' +\n              'Click \"Refresh\" to see updated results.');\n      }\n\n      // Refresh review data to show updated results\n      refreshReviewData();\n    }\n\n    function handleRetryError(error) {\n      const btn = document.getElementById('retry-failed-btn');\n      btn.disabled = false;\n      btn.textContent = 'üîÑ Retry Failed Cases';\n      btn.style.background = '#ff9800';\n\n      alert('‚ùå Error during retry:\\\\n\\\\n' + error.message);\n    }\n\n    /**\n     * Refresh review data from AI_Categorization_Results sheet\n     */\n    function refreshReviewData() {\n      document.getElementById('review-results').innerHTML = '<p class=\"help-text\">‚è≥ Loading results...</p>';\n\n      google.script.run\n        .withSuccessHandler(handleReviewDataLoaded)\n        .withFailureHandler(handleReviewDataError)\n        .getCategorizationResults(currentFilter, 1, 50);\n    }\n\n    function handleReviewDataLoaded(data) {\n      categorizationData = data.results;\n\n      if (categorizationData.length === 0) {\n        document.getElementById('review-results').innerHTML = '<p class=\"info\">No results found. Run AI Categorization first.</p>';\n        return;\n      }\n\n      // Update stats\n      google.script.run\n        .withSuccessHandler(updateStats)\n        .getCategorizationStats();\n\n      // Build table HTML\n      let html = '<table class=\"review-table\">';\n      html += '<thead><tr>';\n      html += '<th>Case ID</th>';\n      html += '<th>Status</th>';\n      html += '<th>Current</th>';\n      html += '<th>AI Suggested</th>';\n      html += '<th>Final Decision</th>';\n      html += '</tr></thead>';\n      html += '<tbody>';\n\n      categorizationData.forEach(function(result) {\n        const statusClass = 'status-' + result.status;\n\n        html += '<tr>';\n        html += '<td>' + result.caseID + '</td>';\n        html += '<td><span class=\"status-badge ' + statusClass + '\">' + result.status + '</span></td>';\n        html += '<td class=\"category-current\">' + result.currentSymptom + ' / ' + result.currentSystem + '</td>';\n        html += '<td class=\"category-suggested\">' + result.suggestedSymptom + ' / ' + result.suggestedSystem + '</td>';\n        html += '<td>';\n        html += '  <select class=\"mini-select\" data-case-id=\"' + result.legacyCaseID + '\" data-field=\"symptom\">';\n        html += '    <option value=\"' + result.suggestedSymptom + '\" selected>' + result.suggestedSymptom + '</option>';\n        if (result.currentSymptom) {\n          html += '  <option value=\"' + result.currentSymptom + '\">Keep: ' + result.currentSymptom + '</option>';\n        }\n        html += '  </select>';\n        html += '  <select class=\"mini-select\" data-case-id=\"' + result.legacyCaseID + '\" data-field=\"system\">';\n        html += '    <option value=\"' + result.suggestedSystem + '\" selected>' + result.suggestedSystem + '</option>';\n        if (result.currentSystem) {\n          html += '  <option value=\"' + result.currentSystem + '\">Keep: ' + result.currentSystem + '</option>';\n        }\n        html += '  </select>';\n        html += '</td>';\n        html += '</tr>';\n      });\n\n      html += '</tbody></table>';\n\n      document.getElementById('review-results').innerHTML = html;\n    }\n\n    function handleReviewDataError(error) {\n      document.getElementById('review-results').innerHTML = '<p class=\"warning\">‚ùå Error loading results: ' + error.message + '</p>';\n    }\n\n    function updateStats(stats) {\n      document.getElementById('stat-new').textContent = stats.new;\n      document.getElementById('stat-matches').textContent = stats.matches;\n      document.getElementById('stat-conflicts').textContent = stats.conflicts;\n      document.getElementById('stat-errors').textContent = stats.errors;\n    }\n\n    /**\n     * Filter results by status\n     */\n    function filterResults() {\n      currentFilter = document.getElementById('filter-status').value;\n      refreshReviewData();\n    }\n\n    /**\n     * Apply categorizations to Master Scenario Convert\n     */\n    function applyCategorizations() {\n      if (!confirm('Apply all final categorizations to Master Scenario Convert?\\\\n\\\\nThis will update 4 columns for each case:\\\\n- Case_Organization_Category_Symptom_Name (Column P / 16)\\\\n- Case_Organization_Category_System_Name (Column Q / 17)\\\\n- Case_Organization_Category_Symptom (Column R / 18)\\\\n- Case_Organization_Category_System (Column S / 19)\\\\n\\\\nA backup will be created before updating.')) {\n        return;\n      }\n\n      const btn = document.getElementById('apply-btn');\n      btn.disabled = true;\n      btn.textContent = '‚è≥ Applying categorizations...';\n\n      google.script.run\n        .withSuccessHandler(handleApplyComplete)\n        .withFailureHandler(handleApplyError)\n        .applyCategorization('all');\n    }\n\n    function handleApplyComplete(result) {\n      const btn = document.getElementById('apply-btn');\n      btn.disabled = false;\n      btn.textContent = '‚úÖ Apply Selected Categories to Master';\n\n      if (result.success) {\n        alert('‚úÖ Categorization applied successfully!\\\\n\\\\n' +\n              'Cases updated: ' + result.updated + '\\\\n' +\n              'Errors: ' + result.errors + '\\\\n' +\n              'Backup: ' + result.backup);\n      } else {\n        alert('‚ùå Application cancelled or failed:\\\\n\\\\n' + result.message);\n      }\n    }\n\n    function handleApplyError(error) {\n      const btn = document.getElementById('apply-btn');\n      btn.disabled = false;\n      btn.textContent = '‚úÖ Apply Selected Categories to Master';\n\n      alert('‚ùå Error applying categorizations:\\\\n\\\\n' + error.message);\n    }\n\n    /**\n     * Export categorization results to CSV\n     */\n    function exportCategorizationResults() {\n      alert('Export to CSV feature coming soon!');\n    }\n\n    /**\n     * Open Category Mappings Editor\n     */\n    function editCategoryMappings() {\n      google.script.run\n        .withSuccessHandler(html => {\n          const div = document.createElement('div');\n          div.innerHTML = html;\n          document.body.appendChild(div);\n        })\n        .openCategoryMappingsEditor();\n    }\n\n    // ========================================================================\n    // AI DISCOVERY TAB FUNCTIONS (EXISTING)\n    // ========================================================================\n\n    function handleLogicTypeChange() {\n      const value = document.getElementById('logic-type-selector').value;\n\n      if (value === 'CREATE_NEW') {\n        alert('Create New Logic Type feature coming soon!');\n        document.getElementById('logic-type-selector').value = '';\n        document.getElementById('discover-btn').disabled = true;\n      } else if (value) {\n        document.getElementById('discover-btn').disabled = false;\n      } else {\n        document.getElementById('discover-btn').disabled = true;\n      }\n    }\n\n    function discoverPathways() {\n      const logicTypeId = document.getElementById('logic-type-selector').value;\n\n      if (!logicTypeId || logicTypeId === 'CREATE_NEW') {\n        alert('Please select a logic type first');\n        return;\n      }\n\n      // Show loading\n      const btn = document.getElementById('discover-btn');\n      btn.disabled = true;\n      btn.textContent = 'üîÑ Discovering...';\n\n      // Hide previous results\n      document.getElementById('results-container').classList.remove('visible');\n\n      // Call server-side discovery function\n      google.script.run\n        .withSuccessHandler(handleDiscoveryResults)\n        .withFailureHandler(handleDiscoveryError)\n        .discoverPathwaysWithLogicType(logicTypeId);\n    }\n\n    function handleDiscoveryResults(result) {\n      const btn = document.getElementById('discover-btn');\n      btn.disabled = false;\n      btn.textContent = 'ü§ñ Discover Pathways';\n\n      if (!result.success) {\n        alert('Error: ' + result.error);\n        return;\n      }\n\n      // Build results HTML\n      let html = '<p style=\"margin-bottom: 12px;\"><strong>' + result.pathwaysCount + ' pathways discovered using \"' + result.logicType + '\"</strong></p>';\n\n      result.pathways.forEach(function(sp, idx) {\n        const p = sp.pathway;\n        const s = sp.scoring;\n        const tierClass = 'tier-' + s.tier.charAt(0).toLowerCase();\n\n        html += '<div class=\"pathway-card\">';\n        html += '<strong>' + (idx + 1) + '. ' + p.name + '</strong>';\n        html += '<span class=\"tier-badge ' + tierClass + '\">' + s.tier + '</span>';\n        html += '<div class=\"pathway-desc\">' + p.description + '</div>';\n        html += '<div class=\"pathway-persuasion\">\"' + s.persuasion.persuasion_narrative + '\"</div>';\n        html += '<div class=\"pathway-meta\">üìä Score: ' + s.composite_score + '/10 | üìö ' + p.caseIds.length + ' cases | üéØ ' + p.targetLearner + '</div>';\n        html += '</div>';\n      });\n\n      document.getElementById('results-content').innerHTML = html;\n      document.getElementById('results-container').classList.add('visible');\n\n      // Success message\n      alert('‚úÖ Discovery complete! ' + result.pathwaysCount + ' pathways saved to Pathways_Master sheet.');\n    }\n\n    function handleDiscoveryError(error) {\n      const btn = document.getElementById('discover-btn');\n      btn.disabled = false;\n      btn.textContent = 'ü§ñ Discover Pathways';\n\n      alert('Error during discovery: ' + error.message);\n    }\n\n    function viewLogicTypeLibrary() {\n      google.script.run\n        .withSuccessHandler(function() {\n          alert('Logic Type Library is now active');\n        })\n        .manageLogicTypes();\n    }\n\n    function viewPathwaysMaster() {\n      google.script.run\n        .withSuccessHandler(function() {\n          alert('Pathways_Master sheet is now active');\n        })\n        .viewAllPathways();\n    }\n\n    // ========================================================================\n    // AUTO-SHOW AI REVIEW IF RESULTS EXIST\n    // ========================================================================\n\n    // Check if AI results exist on load\n    if (${categorizationStats.total} > 0) {\n      document.getElementById('ai-review-container').classList.add('visible');\n    }\n  \n    /**\n     * AI Processing Log Functions (for both main run and retry)\n     */\n    let lastAILogs = '';\n\n    function refreshAILogs() {\n      google.script.run\n        .withSuccessHandler((logs) => {\n          const output = document.getElementById('aiLogOutput');\n          if (logs && logs.trim()) {\n            output.textContent = logs;\n            output.scrollTop = output.scrollHeight;\n            lastAILogs = logs;\n          } else {\n            output.textContent = 'No logs yet. Click \"Retry Failed Cases\" to start.';\n          }\n        })\n        .getSidebarLogs();\n    }\n\n    function clearAILogs() {\n      google.script.run\n        .withSuccessHandler((msg) => {\n          document.getElementById('aiLogOutput').textContent = msg;\n          lastAILogs = '';\n        })\n        .clearSidebarLogs();\n    }\n\n    function copyAILogs() {\n      const logText = document.getElementById('aiLogOutput').textContent;\n      if (!logText || logText.includes('No logs yet')) {\n        alert('No logs to copy!');\n        return;\n      }\n\n      navigator.clipboard.writeText(logText).then(() => {\n        const btn = document.getElementById('copyAILogsBtn');\n        const originalText = btn.textContent;\n        btn.textContent = '‚úì Copied!';\n        btn.style.color = '#0f0';\n        btn.style.borderColor = '#0f0';\n        setTimeout(() => {\n          btn.textContent = originalText;\n          btn.style.color = '#58a6ff';\n          btn.style.borderColor = '#58a6ff';\n        }, 2000);\n      }).catch(err => {\n        alert('Failed to copy logs: ' + err);\n      });\n    }\n\n    // Auto-refresh logs every 2 seconds when AI is processing\n    let aiLogInterval = null;\n\n    function startAILogPolling() {\n      document.getElementById('ai-logs-panel').style.display = 'block';\n      if (!aiLogInterval) {\n        aiLogInterval = setInterval(refreshAILogs, 2000);\n      }\n    }\n\n    function stopAILogPolling() {\n      if (aiLogInterval) {\n        clearInterval(aiLogInterval);\n        aiLogInterval = null;\n      }\n    }\n\n  </script>\n</body>\n</html>\n  `;\n}\n\n\n/**\n * Open Category Mappings Editor (NEW)\n * Allows user to edit symptom/system definitions\n */\nfunction openCategoryMappingsEditor() {\n  const ui = getSafeUi_();\n  if (!ui) return;\n\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const mappingSheet = ss.getSheetByName('accronym_symptom_system_mapping');\n\n  if (!mappingSheet) {\n    ui.alert('Error', 'Mapping sheet not found: accronym_symptom_system_mapping', ui.ButtonSet.OK);\n    return;\n  }\n\n  // Get current mappings\n  const data = mappingSheet.getDataRange().getValues();\n  const headers = data[0];\n\n  let mappingRows = '';\n  for (let i = 1; i < data.length; i++) {\n    const row = data[i];\n    mappingRows += `\n      <tr>\n        <td><input type=\"text\" value=\"${row[0]}\" data-col=\"0\" data-row=\"${i}\" /></td>\n        <td><input type=\"text\" value=\"${row[1]}\" data-col=\"1\" data-row=\"${i}\" /></td>\n        <td><input type=\"text\" value=\"${row[2]}\" data-col=\"2\" data-row=\"${i}\" /></td>\n        <td><input type=\"text\" value=\"${row[3]}\" data-col=\"3\" data-row=\"${i}\" /></td>\n        <td><button onclick=\"deleteRow(${i})\">üóëÔ∏è</button></td>\n      </tr>\n    `;\n  }\n\n  const html = HtmlService.createHtmlOutput(`\n    <!DOCTYPE html>\n    <html>\n    <head>\n      <style>\n        body { font-family: Arial, sans-serif; padding: 20px; }\n        h2 { color: #2c3e50; }\n        table { width: 100%; border-collapse: collapse; margin-top: 20px; }\n        th, td { padding: 10px; border: 1px solid #dfe3e8; text-align: left; }\n        th { background: #2a3040; color: #e7eaf0; }\n        input { width: 100%; padding: 6px; border: 1px solid #d1d7de; border-radius: 3px; }\n        button { padding: 8px 16px; background: #3b7ddd; color: #fff; border: none; border-radius: 4px; cursor: pointer; }\n        button:hover { background: #2d6bc6; }\n        .btn-danger { background: #dc3545; }\n        .btn-danger:hover { background: #c82333; }\n        .btn-success { background: #28a745; }\n        .btn-success:hover { background: #218838; }\n      </style>\n    </head>\n    <body>\n      <h2>‚öôÔ∏è Edit Category Mappings</h2>\n      <p>Manage symptom accronyms and system categories used for AI categorization.</p>\n\n      <table id=\"mappings-table\">\n        <thead>\n          <tr>\n            <th>Accronym</th>\n            <th>Symptom (Pre-Category)</th>\n            <th>System (Post-Category)</th>\n            <th>Alt System</th>\n            <th>Actions</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${mappingRows}\n        </tbody>\n      </table>\n\n      <button onclick=\"addNewRow()\" style=\"margin-top: 16px;\">‚ûï Add New Mapping</button>\n      <button onclick=\"saveMappings()\" class=\"btn-success\" style=\"margin-top: 16px;\">üíæ Save All Changes</button>\n\n      <script>\n        function addNewRow() {\n          const tbody = document.querySelector('#mappings-table tbody');\n          const rowCount = tbody.querySelectorAll('tr').length + 1;\n\n          const newRow = document.createElement('tr');\n          newRow.innerHTML = \\`\n            <td><input type=\"text\" value=\"\" data-col=\"0\" data-row=\"\\${rowCount}\" /></td>\n            <td><input type=\"text\" value=\"\" data-col=\"1\" data-row=\"\\${rowCount}\" /></td>\n            <td><input type=\"text\" value=\"\" data-col=\"2\" data-row=\"\\${rowCount}\" /></td>\n            <td><input type=\"text\" value=\"\" data-col=\"3\" data-row=\"\\${rowCount}\" /></td>\n            <td><button onclick=\"deleteRow(\\${rowCount})\">üóëÔ∏è</button></td>\n          \\`;\n          tbody.appendChild(newRow);\n        }\n\n        function deleteRow(rowNum) {\n          if (confirm('Delete this mapping?')) {\n            const row = document.querySelector(\\`input[data-row=\"\\${rowNum}\"]\\`).closest('tr');\n            row.remove();\n          }\n        }\n\n        function saveMappings() {\n          const rows = [];\n          const tbody = document.querySelector('#mappings-table tbody');\n\n          tbody.querySelectorAll('tr').forEach(tr => {\n            const inputs = tr.querySelectorAll('input');\n            rows.push([\n              inputs[0].value,\n              inputs[1].value,\n              inputs[2].value,\n              inputs[3].value\n            ]);\n          });\n\n          google.script.run\n            .withSuccessHandler(() => {\n              alert('‚úÖ Mappings saved successfully!');\n              google.script.host.close();\n            })\n            .withFailureHandler(err => alert('‚ùå Error: ' + err.message))\n            .saveCategoryMappings(rows);\n        }\n      </script>\n    </body>\n    </html>\n  `).setWidth(800).setHeight(600);\n\n  ui.showModalDialog(html, '‚öôÔ∏è Category Mappings Editor');\n}\n\n/**\n * Save category mappings back to sheet\n */\nfunction saveCategoryMappings(rows) {\n  const ss = SpreadsheetApp.getActiveSpreadsheet();\n  const mappingSheet = ss.getSheetByName('accronym_symptom_system_mapping');\n\n  if (!mappingSheet) {\n    throw new Error('Mapping sheet not found');\n  }\n\n  // Clear existing data (except headers)\n  const lastRow = mappingSheet.getLastRow();\n  if (lastRow > 1) {\n    mappingSheet.getRange(2, 1, lastRow - 1, 4).clear();\n  }\n\n  // Write new data\n  if (rows.length > 0) {\n    mappingSheet.getRange(2, 1, rows.length, 4).setValues(rows);\n  }\n\n  Logger.log('‚úÖ Saved ' + rows.length + ' category mappings');\n}\n",
      "lastModifyUser": {
        "domain": "ersimulator.com",
        "email": "support@ersimulator.com",
        "name": "Aaron Tjomsland",
        "photoUrl": "https://lh3.googleusercontent.com/a-/ALV-UjWqjAHY15ugT_65GCYyIOdya8IsaYpRoXhg8zPNCFOZli7OIZef57v0vfPVHgdIc17nrKQX8RvFMotOWdiAJBi2Z8EvBsAdh5GHMLT6VwUDxulPbACn039MZEDMjGvEQ6Ps2GbhAuuwKxgy_KN_q1Rq9upQd2UNjYnz_Uspr2GepdVdVNsljJ-DDAv-42pz7IOGDYkiIg-J7reiSUsTtGi6L1Gc_plMbGLqao0qberaqBqQ2uV20xfvaHILx12hTMouOqHUdF_kv3I9T7Tz95zpYo1S4_vLbnngaUlYehv_FW2UnkUXww7-cWmsr2DLJdfjSUT_R0Vwb7WnzCdrEc7I6QY3OePHi_nk2TKc2e722qLboOGKpBc-8NvjS2mi20-NvCF-QwQvZrAJWpnx9nvkNCV3ovYvGCwvCnWaGHfV_GILlkHFY63s2LzwAF7kuIISeoxuuKxjfpLesHXRNhKHQlYv3Ecpwl9VyNoL6VxA17hJE83iwlgPSrbAnfVBYBS3DDmkWNqeTj5yooNm41Gix9m1iSuWhqS1xbU9NVlxEnjfX_9XUYD1yYvm-mpJqTWDQSuJo4ffmLVtbrarNe5mxR-xUBwD7kbbiDxlZ5BfcGUV-2DD3RSzNDbgxZbU-8I93D28EpIPbXvoWrKgqvz8JxqWScrhMN9kyuU_SgxH-rVrD6jn_EeTiQYXwGxbCNzcW7S2wxI8Y_uv1EHwio6lAIetzZbAmTTUyxwBF1mlQP-lPUHpvKRAs-wUz7pw5DI8uSCu-8GZCz3xa0fqevlMghcm-YUOzMW4c8vLf3wGNQoLpyvIVHmByXymbGJ1-trNCuQTYtzs3PHmME3i8s-Ogll54Nprg0QGNiGaFKOmnmc1zoniPZa_QNABkOOQivGdwuhPO4b2q685m0uwxv1sJ7pC8vB8SQXWqIW9maHvOVauNsAldadssZpGGCwGfjwPkJvjGY8RF1JqRAKI6ImFB9OwPHJ47Mfy5JHpBvXZcL75LpxdHTXlyjMMosuw_E23Og_NMvk0kKoY4J1ydWt3Jkpdf1I-PmcdoApGnAGaNnL7WyEbcYM=h128"
      },
      "createTime": "2025-11-10T22:52:49.962Z",
      "updateTime": "2025-11-11T04:42:39.376Z",
      "functionSet": {
        "values": [
          {
            "name": "openCategoriesPathwaysPanel"
          },
          {
            "name": "buildCategoriesPathwaysMainMenu_"
          },
          {
            "name": "openCategoryMappingsEditor"
          },
          {
            "name": "saveCategoryMappings",
            "parameters": [
              "rows"
            ]
          }
        ]
      }
    }
  ]
}