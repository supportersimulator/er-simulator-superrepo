# Case Field Access Patterns & Examples

## How Case Objects Are Built in Code

### Pattern 1: buildCaseObject (Apps Script)
Found in: `GoogleSheetsAppsScript.js` and `GoogleSheetsAppsScript_Enhanced.js`

```javascript
function buildCaseObject(headers, row) {
  const obj = {};
  headers.forEach((header, idx) => {
    obj[header] = row[idx];
  });
  return obj;
}
```

This creates an object where keys are merged headers (Tier1:Tier2 format) and values are cell values.

### Pattern 2: Two-Tier Headers
Row 1 (Tier 1): Categories
```
Case_Organization | Patient_Demographics_and_Clinical_Data | Monitor_Vital_Signs | ...
```

Row 2 (Tier 2): Field names
```
Case_ID | Case_Organization | ... | Age | Gender | ... | Initial_Vitals | ...
```

Merged format: `Case_Organization:Case_ID`

### Pattern 3: Data Access in Node.js Scripts
```javascript
const caseData = buildCaseObject(headers, rowData);
const caseId = caseData['Case_Organization:Case_ID'];
const age = caseData['Patient_Demographics_and_Clinical_Data:Age'];
const vitals = JSON.parse(caseData['Monitor_Vital_Signs:Initial_Vitals']);
```

## JSON Fields (Stored as Stringified Objects)

### Vitals Object (Monitor_Vital_Signs:Initial_Vitals, State1_Vitals, etc.)
```json
{
  "hr": 98,
  "bp": {
    "sys": 128,
    "dia": 82
  },
  "rr": 19,
  "temp": 36.8,
  "spo2": 95,
  "etco2": 34,
  "waveform": "sinus_ecg",
  "lastupdated": "2025-11-03T05:01:35.888Z"
}
```

Note: All numeric values must be numbers, BP is an object, waveform uses universal naming standard with _ecg suffix, lastupdaâ€‹ted is ISO-8601 timestamp.

### Pre-Sim Overview (Case_Organization:Pre_Sim_Overview)
Generated by `caseOverviewGenerator.cjs`, structure:
```json
{
  "sbarHandoff": "2-3 sentence SBAR-style clinical handoff...",
  "theStakes": "1 sentence creating urgency...",
  "mysteryHook": "1 sentence hinting at complexity WITHOUT revealing answer...",
  "whatYouWillLearn": [
    "Vague skill 1...",
    "Vague skill 2...",
    "Vague skill 3..."
  ],
  "estimatedTime": "5-10 minutes"
}
```

Philosophy: Escape room mystery style - never reveal diagnosis, only observable symptoms.

### Post-Sim Overview (Case_Organization:Post_Sim_Overview)
```json
{
  "victoryHeadline": "ðŸŽ‰ Case Mastered: [Compelling headline]",
  "patientStoryAnchor": "One vivid sentence describing the patient character...",
  "celebrationOpening": "2-3 sentences celebrating accomplishment...",
  "theCriticalPearl": {
    "title": "The Golden Takeaway",
    "content": "The #1 clinical pearl they MUST remember forever...",
    "memoryAid": "A simple mnemonic, acronym, or vivid mental image..."
  },
  "whatYouMastered": [
    "Specific skill 1...",
    "Specific skill 2...",
    "Specific skill 3..."
  ],
  "avoidTheseTraps": [
    "Common mistake #1 and why it's dangerous...",
    "Common mistake #2 and why it's dangerous..."
  ],
  "realWorldImpact": {
    "patientSafety": "How this knowledge will save lives...",
    "careerProtection": "How this knowledge protects from litigation...",
    "clinicalConfidence": "How this knowledge builds expertise..."
  },
  "nextSteps": {
    "inThisPathway": "What case to do next...",
    "toReinforce": "How to practice/reinforce this skill..."
  },
  "rememberForever": "The ONE sentence to tattoo on their brain...",
  "confidence": 0.95
}
```

### Decision Nodes JSON (AI_Trigger_Keywords, Decision_Nodes_JSON)
Branching logic for AI-driven scenarios:
```json
{
  "triggers": ["key1", "key2"],
  "responses": {
    "tier1": "Basic response",
    "tier2": "Intermediate response",
    "tier3": "Advanced response"
  }
}
```

### AI Response Tiers
Response complexity levels based on user experience.

## Field Categories Quick Lookup

### Identification Fields
- Case_Organization:Case_ID
- Case_Organization:Spark_Title
- Case_Organization:Reveal_Title
- Case_Organization:Medical_Category

### Patient Info Fields
- Patient_Demographics_and_Clinical_Data:Patient_Name
- Patient_Demographics_and_Clinical_Data:Age
- Patient_Demographics_and_Clinical_Data:Gender
- Patient_Demographics_and_Clinical_Data:Presenting_Complaint
- Patient_Demographics_and_Clinical_Data:Initial_Rhythm

### Vital Sign Fields
- Monitor_Vital_Signs:Initial_Vitals (JSON string)
- Monitor_Vital_Signs:State1_Vitals (JSON string)
- Monitor_Vital_Signs:State2_Vitals (JSON string)
- Monitor_Vital_Signs:State3_Vitals (JSON string)
- Monitor_Vital_Signs:State4_Vitals (JSON string)
- Monitor_Vital_Signs:State5_Vitals (JSON string)

### Learning Fields
- Case_Organization:Pre_Sim_Overview (JSON string)
- Case_Organization:Post_Sim_Overview (JSON string)
- Educational_Goal
- Why_It_Matters
- CME_Learning_Objective

### Environment Fields
- Situation_and_Environment_Details:Environment_Type
- Situation_and_Environment_Details:Time_of_Day
- Situation_and_Environment_Details:Ambient_Sounds
- Situation_and_Environment_Details:Disposition_Plan

### State Configuration
- image sync:Default_Patient_States (comma-separated: "Baseline,Worsening,Arrest,Recovery")
- State1_Name, State2_Name, State3_Name, State4_Name, State5_Name
- State1_Expected_Actions, State2_Expected_Actions, etc.

### Media/Resources
- Media_Title N (for N = 1 to 19)
- Media_URL N
- Media_Interpretation N
- Media_Type N
- Availability_Status media title N

### Quality/Admin
- Conversion_Status
- Last_AI_Test_Date
- Simulation_Quality_Score
- Developer_Notes
- AI_Reflection_and_Suggestions

## Common Case Field Groupings by Use Case

### For Case Display/Selection UI
```javascript
{
  caseId: caseData['Case_Organization:Case_ID'],
  sparkTitle: caseData['Case_Organization:Spark_Title'],
  revealTitle: caseData['Case_Organization:Reveal_Title'],
  category: caseData['Case_Organization:Medical_Category'],
  difficulty: caseData['Case_Organization:Difficulty_Level'],
  pathway: caseData['Case_Organization:Pathway_or_Course_Name'],
  preSimOverview: JSON.parse(caseData['Case_Organization:Pre_Sim_Overview'] || '{}')
}
```

### For Simulation Runtime
```javascript
{
  patientName: caseData['Patient_Demographics_and_Clinical_Data:Patient_Name'],
  age: caseData['Patient_Demographics_and_Clinical_Data:Age'],
  presentingComplaint: caseData['Patient_Demographics_and_Clinical_Data:Presenting_Complaint'],
  states: caseData['image sync:Default_Patient_States'].split(','),
  initialVitals: JSON.parse(caseData['Monitor_Vital_Signs:Initial_Vitals']),
  state1Vitals: JSON.parse(caseData['Monitor_Vital_Signs:State1_Vitals']),
  state2Vitals: JSON.parse(caseData['Monitor_Vital_Signs:State2_Vitals']),
  // ...state 3, 4, 5
  rnScript: caseData['RN_Script'],
  patientScript: caseData['Patient_Script']
}
```

### For Learning Path Organization
```javascript
{
  pathwayName: caseData['Case_Organization:Pathway_or_Course_Name'],
  seriesName: caseData['Case_Organization:Case_Series_Name'],
  seriesOrder: caseData['Case_Organization:Case_Series_Order'],
  difficulty: caseData['Case_Organization:Difficulty_Level'],
  educationalGoal: caseData['Educational_Goal'],
  whyItMatters: caseData['Why_It_Matters'],
  learningObjectives: caseData['CME_Learning_Objective']
}
```

## Field Validation Rules (from Apps Script)

### Required Fields for Simulation
1. Case_ID (must exist)
2. Initial_Vitals (must be valid JSON with hr, spo2, waveform)
3. State1_Vitals through State5_Vitals (JSON with vitals)
4. Default_Patient_States (comma-separated)

### Validated Fields
- Vitals JSON must contain: hr, spo2, bp (object), rr, temp, waveform
- Waveform must match one of the canonical types (_ecg suffix)
- BP must be an object with sys and dia properties
- All timestamps must be ISO-8601 format

### Optional Fields
- etco2 (may be omitted from vitals)
- Pre/Post overviews (may show as "N/A" if not generated)
- Quiz fields (for CME cases)

## Common Processing Patterns

### Reading Vitals
```javascript
const vitalsObj = JSON.parse(caseData['Monitor_Vital_Signs:Initial_Vitals']);
const { hr, spo2, bp: { sys, dia }, temp, rr, waveform } = vitalsObj;
```

### Updating Vitals (in waveform mapping)
```javascript
const vitalsObj = JSON.parse(caseData['Monitor_Vital_Signs:Initial_Vitals']);
vitalsObj.waveform = 'vtach_ecg';
caseData['Monitor_Vital_Signs:Initial_Vitals'] = JSON.stringify(vitalsObj);
```

### Getting Multiple States
```javascript
const states = [];
for (let i = 1; i <= 5; i++) {
  const fieldName = `Monitor_Vital_Signs:State${i}_Vitals`;
  if (caseData[fieldName]) {
    states.push(JSON.parse(caseData[fieldName]));
  }
}
```

### Parsing State Names
```javascript
const stateNames = (caseData['image sync:Default_Patient_States'] || 'Baseline,Worsening,Arrest,Recovery').split(',');
// stateNames = ['Baseline', 'Worsening', 'Arrest', 'Recovery']
```

## Field Name Conventions

### Naming Patterns
1. **Category_Subcategory_Field** (Row 2 headers with underscores)
2. **Category:Subcategory_Field** (Merged headers with colon + underscore)
3. **Category_Field** (Simple fields without subcategory)

### Special Naming Cases
- Fields with spaces use underscores (e.g., "Past_Medical_History")
- JSON fields end with no suffix but contain JSON strings
- Numbered fields use suffix (e.g., "Media_Title 1", "Media_Title 2")
- State fields use ordinal (e.g., "State1_Vitals", "State2_Vitals")

## Key Insights

1. **Two-Tier Headers**: Every field is categorized by a Tier 1 category and Tier 2 field name
2. **Merged Format**: Apps Script merges these as "Tier1:Tier2" for easier object creation
3. **JSON Storage**: Complex data (vitals, overviews) stored as stringified JSON in single cells
4. **Immutable Waveforms**: Waveform names use universal standard with _ecg suffix, never transformed
5. **State Architecture**: Up to 5 patient states per case, each with separate vitals object
6. **400+ Columns**: Massive denormalized structure for easy Google Sheets access
7. **Comma-Separated Values**: State names and some metadata use CSV format within cells

## File Sources for Field Definitions
- Full column list: `/backups/pre-aws-migration/data/full-backup-2025-11-03T05-24-08.json` (lines 11-500+)
- Case overview generator: `/scripts/lib/caseOverviewGenerator.cjs`
- Apps Script helpers: `/scripts/GoogleSheetsAppsScript.js` and `_Enhanced.js`
- Data quality baseline: `/testing/golden-standards/data-quality-baseline.json`

